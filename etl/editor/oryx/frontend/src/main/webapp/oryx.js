ORYX.Utils={getParamFromUrl:function(b){b=b.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a="[\\?&]"+b+"=([^&#]*)";var d=new RegExp(a);var c=d.exec(window.location.href);if(c==null){return null}else{return c[1]}},adjustGradient:function(c,a){if(ORYX.CONFIG.DISABLE_GRADIENT&&c){var b=a.getAttributeNS(null,"stop-color")||"#ffffff";$A(c.getElementsByTagName("stop")).each(function(d){if(d==a){return}d.setAttributeNS(null,"stop-color",b)})}}};if(/Chrome/.test(navigator.userAgent)){var div=document.createElement("div");try{div.insertAdjacentHTML("BeforeEnd","<p foo:bar='hello'>world</p>")}catch(err){}if(div.children.length===0){var proxy_insertAdjacentHTML=HTMLElement.prototype.insertAdjacentHTML;function __clean_attr(c){var a;for(var b=0;b<c.attributes.length;b++){a=c.attributes[b].nodeName;if(c.attributes[b].nodeName.indexOf("__colon__")>=0){c.setAttribute(a.replace(/__colon__/g,":"),c.getAttribute(a));c.removeAttribute(a)}}}HTMLElement.prototype.insertAdjacentHTML=function(b,d){var e=d.replace(/([\S]+):([\S]+)=/g,"$1__colon__$2=");proxy_insertAdjacentHTML.call(this,b,e);var a=this.getElementsByTagName("*");for(var c=0;c<a.length;c++){__clean_attr(a[c])}}}}XMLNS={ATOM:"http://www.w3.org/2005/Atom",XHTML:"http://www.w3.org/1999/xhtml",ERDF:"http://purl.org/NET/erdf/profile",RDFS:"http://www.w3.org/2000/01/rdf-schema#",RDF:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",RAZIEL:"http://b3mn.org/Raziel",SCHEMA:""};var Kickstart={started:false,callbacks:[],alreadyLoaded:[],PATH:"",load:function(){Kickstart.kick()},kick:function(){if(!Kickstart.started){Kickstart.started=true;Kickstart.callbacks.each(function(a){window.setTimeout(a,1)})}},register:function(callback){with(Kickstart){if(started){window.setTimeout(callback,1)}else{Kickstart.callbacks.push(callback)}}},require:function(a){if(Kickstart.alreadyLoaded.member(a)){return false}return Kickstart.include(a)},include:function(a){var b=document.getElementsByTagNameNS(XMLNS.XHTML,"head")[0];var c=document.createElementNS(XMLNS.XHTML,"script");c.setAttributeNS(XMLNS.XHTML,"type","text/javascript");c.src=Kickstart.PATH+a;b.appendChild(c);Kickstart.alreadyLoaded.push(a);return true}};Event.observe(window,"load",Kickstart.load);var ERDF={LITERAL:1,RESOURCE:2,DELIMITERS:[".","-"],HASH:"#",HYPHEN:"-",schemas:[],callback:undefined,log:undefined,init:function(a){ERDF.callback=a;ERDF.registerSchema("schema",XMLNS.SCHEMA);ERDF.registerSchema("rdfs",XMLNS.RDFS)},run:function(){return ERDF._checkProfile()&&ERDF.parse()},parse:function(){ERDF.__startTime=new Date();var b=document.getElementsByTagNameNS(XMLNS.XHTML,"body");var c={type:ERDF.RESOURCE,value:""};var a=ERDF._parseDocumentMetadata()&&ERDF._parseFromTag(b[0],c);ERDF.__stopTime=new Date();var d=(ERDF.__stopTime-ERDF.__startTime)/1000;return a},_parseDocumentMetadata:function(){var b=document.getElementsByTagNameNS(XMLNS.XHTML,"head");var a=b[0].getElementsByTagNameNS(XMLNS.XHTML,"link");var c=b[0].getElementsByTagNameNS(XMLNS.XHTML,"meta");$A(a).each(function(e){var d=e.getAttribute("rel");var g=e.getAttribute("rev");var f=e.getAttribute("href");ERDF._parseTriplesFrom(ERDF.RESOURCE,"",d,ERDF.RESOURCE,f);ERDF._parseTriplesFrom(ERDF.RESOURCE,f,g,ERDF.RESOURCE,"")});$A(c).each(function(f){var e=f.getAttribute("name");var d=f.getAttribute("content");ERDF._parseTriplesFrom(ERDF.RESOURCE,"",e,ERDF.LITERAL,d)});return true},_parseFromTag:function(c,k,d){if(c.namespaceURI!=XMLNS.XHTML){return}if(!d){d=0}var a=c.getAttribute("id");if(c.nodeName.endsWith(":a")||c.nodeName=="a"){var h=c.getAttribute("rel");var e=c.getAttribute("rev");var n=c.getAttribute("href");var m=c.getAttribute("title");var g=c.textContent;ERDF._parseTriplesFrom(k.type,k.value,h,ERDF.RESOURCE,n,function(p){var o=m?m:g;ERDF._parseTriplesFrom(p.object.type,p.object.value,"rdfs.label",ERDF.LITERAL,o)});ERDF._parseTriplesFrom(k.type,k.value,e,ERDF.RESOURCE,"");ERDF._parseTypeTriplesFrom(k.type,k.value,h)}else{if(c.nodeName.endsWith(":img")||c.nodeName=="img"){var h=c.getAttribute("class");var n=c.getAttribute("src");var f=c.getAttribute("alt");ERDF._parseTriplesFrom(k.type,k.value,h,ERDF.RESOURCE,n,function(p){var o=f;ERDF._parseTriplesFrom(p.object.type,p.object.value,"rdfs.label",ERDF.LITERAL,o)})}}var h=c.getAttribute("class");var m=c.getAttribute("title");var g=c.textContent;var l=m?m:g;ERDF._parseTriplesFrom(k.type,k.value,h,ERDF.LITERAL,l);if(a){k={type:ERDF.RESOURCE,value:ERDF.HASH+a}}ERDF._parseTypeTriplesFrom(k.type,k.value,h);var b=c.childNodes;if(b){$A(b).each(function(o){if(o.nodeType==o.ELEMENT_NODE){ERDF._parseFromTag(o,k,d+1)}})}},_parseTriplesFrom:function(c,e,d,a,b,f){if(!d){return}d.toLowerCase().split(" ").each(function(h){var g=ERDF.schemas.find(function(l){return false||ERDF.DELIMITERS.find(function(m){return h.startsWith(l.prefix+m)})});if(g&&b){h=h.substring(g.prefix.length+1,h.length);var k=ERDF.registerTriple(new ERDF.Resource(e),{prefix:g.prefix,name:h},(a==ERDF.RESOURCE)?new ERDF.Resource(b):new ERDF.Literal(b));if(f){f(k)}}})},_parseTypeTriplesFrom:function(a,c,b,d){if(!b){return}b.toLowerCase().split(" ").each(function(f){var e=ERDF.schemas.find(function(h){return false||ERDF.DELIMITERS.find(function(k){return f.startsWith(ERDF.HYPHEN+h.prefix+k)})});if(e&&c){f=f.substring(e.prefix.length+2,f.length);var g=ERDF.registerTriple((a==ERDF.RESOURCE)?new ERDF.Resource(c):new ERDF.Literal(c),{prefix:"rdf",name:"type"},new ERDF.Resource(e.namespace+f));if(d){d(g)}}})},_checkProfile:function(){var b=document.getElementsByTagNameNS(XMLNS.XHTML,"head");var a=b[0].getAttribute("profile");var c=false;if(a&&a.split(" ").member(XMLNS.ERDF)){return true}else{return false}},__stripHashes:function(a){return(a&&a.substring(0,1)=="#")?a.substring(1,a.length):a},registerSchema:function(b,a){ERDF.schemas.push({prefix:b,namespace:a})},registerTriple:function(c,a,b){if(a.prefix.toLowerCase()=="schema"){this.registerSchema(a.name,b.value)}var d=new ERDF.Triple(c,a,b);ERDF.callback(d);return d},__enhanceObject:function(){this.isResource=function(){return this.type==ERDF.RESOURCE};this.isLocal=function(){return this.isResource()&&this.value.startsWith("#")};this.isCurrentDocument=function(){return this.isResource()&&(this.value=="")};this.getId=function(){return this.isLocal()?ERDF.__stripHashes(this.value):false};this.isLiteral=function(){return this.type==ERDF.LIITERAL}},serialize:function(a){if(!a){return""}else{if(a.constructor==String){return a}else{if(a.constructor==Boolean){return a?"true":"false"}else{return a.toString()}}}}};ERDF.Triple=function(c,a,b){this.subject=c;this.predicate=a;this.object=b;this.toString=function(){return"[ERDF.Triple] "+this.subject.toString()+" "+this.predicate.prefix+":"+this.predicate.name+" "+this.object.toString()}};ERDF.Resource=function(a){this.type=ERDF.RESOURCE;this.value=a;ERDF.__enhanceObject.apply(this);this.toString=function(){return"&lt;"+this.value+"&gt;"}};ERDF.Literal=function(a){this.type=ERDF.LITERAL;this.value=ERDF.serialize(a);ERDF.__enhanceObject.apply(this);this.toString=function(){return'"'+this.value+'"'}};var USE_ASYNCHRONOUS_REQUESTS=true;var DISCARD_UNUSED_TRIPLES=true;var PREFER_SPANS_OVER_DIVS=true;var PREFER_TITLE_OVER_TEXTNODE=false;var RESOURCE_ID_PREFIX="resource";var SHOW_DEBUG_ALERTS_WHEN_SAVING=false;var SHOW_EXTENDED_DEBUG_INFORMATION=false;var USE_ARESS_WORKAROUNDS=true;var RESOURCE_CREATED=1;var RESOURCE_REMOVED=2;var RESOURCE_SAVED=4;var RESOURCE_RELOADED=8;var RESOURCE_SYNCHRONIZED=16;var TRIPLE_REMOVE=1;var TRIPLE_ADD=2;var TRIPLE_RELOAD=4;var TRIPLE_SAVE=8;var PROCESSDATA_REF="processdata";var DataManager={init:function(){ERDF.init(DataManager._registerTriple);DataManager.__synclocal()},_triples:[],_registerTriple:function(a){DataManager._triples.push(a)},__synclocal:function(){DataManager._triples=[];ERDF.run()},__synchronizeShape:function(a){var c=ResourceManager.getResource(a.resourceId);var b=a.serialize();b.each(function(d){var f=(d.type=="resource");var e=new ERDF.Triple(new ERDF.Resource(a.resourceId),{prefix:d.prefix,name:d.name},f?new ERDF.Resource(d.value):new ERDF.Literal(d.value));DataManager.setObject(e)});return c},__storeShape:function(a){var b=DataManager.__synchronizeShape(a);b.save()},__forceExistance:function(a){if(!$(a.resourceId)){if(!$$("."+PROCESSDATA_REF)[0]){DataManager.graft(XMLNS.XHTML,document.getElementsByTagNameNS(XMLNS.XHTML,"body").item(0),["div",{"class":PROCESSDATA_REF,style:"display:none;"}])}DataManager.graft(XMLNS.XHTML,$$("."+PROCESSDATA_REF)[0],["div",{id:a.resourceId,"class":(a instanceof ORYX.Core.Canvas)?"-oryx-canvas":undefined}])}else{var c=$(a.resourceId);var b=$A(c.childNodes);b.each(function(d){c.removeChild(d)})}},__persistShape:function(b){var d=b.serialize();var a=[];var c=new ERDF.Resource(b.resourceId);DataManager.removeTriples(DataManager.query(c,undefined,undefined));d.each(function(f){var e=(f.type=="resource")?new ERDF.Resource(f.value):new ERDF.Literal(f.value);DataManager.addTriple(new ERDF.Triple(c,{prefix:f.prefix,name:f.name},e))})},__persistDOM:function(d){var c=d.getCanvas();var b=c.getChildShapes(true);var a="";b.each(function(e){DataManager.__forceExistance(e)});DataManager.__renderCanvas(d);a+=DataManager.serialize($(ERDF.__stripHashes(d.getCanvas().resourceId)),true);b.each(function(e){DataManager.__persistShape(e);a+=DataManager.serialize($(ERDF.__stripHashes(e.resourceId)),true)});return a},__renderCanvas:function(e){var b=e.getCanvas();var d=e.getStencilSets();var a=b.getChildShapes(true);DataManager.__forceExistance(b);DataManager.__persistShape(b);var c=new ERDF.Resource(b.resourceId);DataManager.removeTriples(DataManager.query(c,undefined,undefined));DataManager.addTriple(new ERDF.Triple(c,{prefix:"oryx",name:"mode"},new ERDF.Literal("writable")));DataManager.addTriple(new ERDF.Triple(c,{prefix:"oryx",name:"mode"},new ERDF.Literal("fullscreen")));d.values().each(function(f){DataManager.addTriple(new ERDF.Triple(c,{prefix:"oryx",name:"stencilset"},new ERDF.Resource(f.source().replace(/&/g,"%26"))));DataManager.addTriple(new ERDF.Triple(c,{prefix:"oryx",name:"ssnamespace"},new ERDF.Resource(f.namespace())));f.extensions().keys().each(function(g){DataManager.addTriple(new ERDF.Triple(c,{prefix:"oryx",name:"ssextension"},new ERDF.Literal(g)))})});a.each(function(f){DataManager.addTriple(new ERDF.Triple(c,{prefix:"oryx",name:"render"},new ERDF.Resource("#"+f.resourceId)))})},__counter:0,__provideId:function(){while($(RESOURCE_ID_PREFIX+DataManager.__counter)){DataManager.__counter++}return RESOURCE_ID_PREFIX+DataManager.__counter},serializeDOM:function(a){return DataManager.__persistDOM(a)},syncGlobal:function(a){return DataManager.__syncglobal(a)},__syncglobal:function(c){var b=c.getCanvas();var a=b.getChildShapes(true);a.select(function(d){return !($(d.resourceId))}).each(function(d){if(USE_ARESS_WORKAROUNDS){var e=d.properties["raziel-type"];var g='<div xmlns="http://www.w3.org/1999/xhtml"><span class="raziel-type">'+e+"</span></div>";var f=ResourceManager.__createResource(g);d.resourceId=f.id()}else{var f=ResourceManager.__createResource();d.resourceId=f.id()}});a.each(function(d){DataManager.__storeShape(d)})},serialize:function(f,b){if(f.nodeType==f.ELEMENT_NODE){var e=$A(f.childNodes);var c=$A(f.attributes);var d=new String(f.getAttribute("class"));var g=d.split(" ").member("transient");if(g){return""}var a="<"+f.nodeName;if(!b){a+=' xmlns="'+(f.namespaceURI?f.namespaceURI:XMLNS.XHTML)+'" xmlns:oryx="http://oryx-editor.org"'}c.each(function(h){a+=" "+h.nodeName+'="'+h.nodeValue+'"'});if(e.length==0){a+="/>"}else{a+=">";e.each(function(h){a+=DataManager.serialize(h,true)});a+="</"+f.nodeName+">"}return a}else{if(f.nodeType==f.TEXT_NODE){return f.nodeValue}}},addTriple:function(c){if(!c.subject.type==ERDF.LITERAL){throw"Cannot add the triple "+c.toString()+" because the subject is not a resource."}var a=ERDF.__stripHashes(c.subject.value);var b=$(a);if(!b){throw"Cannot add the triple "+c.toString()+' because the subject "'+a+'" is not in the document.'}if(c.object.type==ERDF.LITERAL){DataManager.graft(XMLNS.XHTML,b,["span",{"class":(c.predicate.prefix+"-"+c.predicate.name)},c.object.value.escapeHTML()])}else{DataManager.graft(XMLNS.XHTML,b,["a",{rel:(c.predicate.prefix+"-"+c.predicate.name),href:c.object.value}])}return true},removeTriples:function(b){var a=b.select(function(c){return DataManager.__removeTriple(c)});return a},removeTriple:function(b){var a=DataManager.__removeTriple(b);return a},__removeTriple:function(d){if(!d.subject.type==ERDF.LITERAL){throw"Cannot remove the triple "+d.toString()+" because the subject is not a resource."}var b=ERDF.__stripHashes(d.subject.value);var c=$(b);if(!c){throw"Cannot remove the triple "+d.toString()+" because the subject is not in the document."}if(d.object.type==ERDF.LITERAL){var a=DataManager.__removeTripleRecursively(d,c);return a}},__removeTripleRecursively:function(e,d){if(d.nodeType!=d.ELEMENT_NODE){return false}var b=new String(d.getAttribute("class"));var a=$A(d.childNodes);if(b.include(e.predicate.prefix+"-"+e.predicate.name)){var c=d.textContent;if((e.object.type==ERDF.LITERAL)&&(e.object.value==c)){d.parentNode.removeChild(d)}return true}else{a.each(function(f){DataManager.__removeTripleRecursively(e,f)});return false}},graft:function(g,f,d,l){l=(l||(f&&f.ownerDocument)||document);var h;if(d===undefined){echo("Can't graft an undefined value")}else{if(d.constructor==String){h=l.createTextNode(d)}else{for(var c=0;c<d.length;c++){if(c===0&&d[c].constructor==String){var a=d[c].match(/^([a-z][a-z0-9]*)\.([^\s\.]+)$/i);if(a){h=l.createElementNS(g,a[1]);h.setAttributeNS(null,"class",a[2]);continue}a=d[c].match(/^([a-z][a-z0-9]*)$/i);if(a){h=l.createElementNS(g,a[1]);continue}h=l.createElementNS(g,"span");h.setAttribute(null,"class","namelessFromLOL")}if(d[c]===undefined){echo("Can't graft an undefined value in a list!")}else{if(d[c].constructor==String||d[c].constructor==Array){this.graft(g,h,d[c],l)}else{if(d[c].constructor==Number){this.graft(g,h,d[c].toString(),l)}else{if(d[c].constructor==Object){for(var b in d[c]){h.setAttributeNS(null,b,d[c][b])}}else{if(d[c].constructor==Boolean){this.graft(g,h,d[c]?"true":"false",l)}else{throw"Object "+d[c]+" is inscrutable as an graft arglet."}}}}}}}}if(f){f.appendChild(h)}return Element.extend(h)},setObject:function(a){var b=DataManager.query(a.subject,a.predicate,undefined);DataManager.removeTriples(b);DataManager.addTriple(a);return true},query:function(c,a,b){return DataManager._triples.select(function(e){var d=((c)?(e.subject.type==c.type)&&(e.subject.value==c.value):true);if(a){d=d&&((a.prefix)?(e.predicate.prefix==a.prefix):true);d=d&&((a.name)?(e.predicate.name==a.name):true)}d=d&&((b)?(e.object.type==b.type)&&(e.object.value==b.value):true);return d})}};Kickstart.register(DataManager.init);function assert(b,a){if(!b){throw a}}function DMCommand(a,b){this.action=a;this.triple=b;this.toString=function(){return"Command("+a+", "+b+")"}}function DMCommandHandler(a){this.__setNext=function(c){var b=this.__next;this.__next=a;return b?b:true};this.__setNext(a);this.__invokeNext=function(b){return this.__next?this.__next.handle(b):false};this.handle=function(b){return this.process(b)?true:this.__invokeNext(b)};this.process=function(b){return false}}function MetaTagHandler(next){DMCommandHandler.apply(this,[next]);this.process=function(command){with(command.triple){if(!((subject instanceof ERDF.Resource)&&(subject.isCurrentDocument())&&(object instanceof ERDF.Literal))){return false}}}}var chain=new MetaTagHandler();var command=new DMCommand(TRIPLE_ADD,new ERDF.Triple(new ERDF.Resource(""),"rdf:tool",new ERDF.Literal("")));ResourceManager={__corrupt:false,__latelyCreatedResource:undefined,__listeners:$H(),__token:1,addListener:function(d,b){if(!(d instanceof Function)){throw"Resource event listener is not a function!"}if(!(b)){throw"Invalid mask for resource event listener registration."}var a={listener:d,mask:b};var c=ResourceManager.__token++;ResourceManager.__listeners[c]=a;return c},removeListener:function(a){return ResourceManager.__listners.remove(a)},__Event:function(a,b){this.action=a;this.resourceId=b},__dispatchEvent:function(a){ResourceManager.__listeners.values().each(function(b){if(a.action&b.mask){return b.listener(a)}})},getResource:function(c){c=ERDF.__stripHashes(c);var b=DataManager.query(new ERDF.Resource("#"+c),{prefix:"raziel",name:"entry"},undefined);if((b.length==1)&&(b[0].object.isResource())){var a=b[0].object.value;return new ResourceManager.__Resource(c,a)}throw ("Resource with id "+c+" not recognized as such. "+((b.length>1)?" There is more than one raziel:entry URL.":" There is no raziel:entry URL."));return false},__createResource:function(e){var d=DataManager.query(new ERDF.Resource(""),{prefix:"raziel",name:"collection"},undefined);if((d.length==1)&&(d[0].object.isResource())){var b=d[0].object.value;var c=undefined;var a=e?e:'<div xmlns="http://www.w3.org/1999/xhtml"></div>';ResourceManager.__request("POST",b,a,function(){var f=(this.responseXML);var h=f.childNodes[0];var g=h.getAttribute("id");if(!$$("."+PROCESSDATA_REF)[0]){DataManager.graft(XMLNS.XHTML,document.getElementsByTagNameNS(XMLNS.XHTML,"body").item(0),["div",{"class":PROCESSDATA_REF,style:"display:none;"}])}$$("."+PROCESSDATA_REF)[0].appendChild(h.cloneNode(true));DataManager.__synclocal();c=new ResourceManager.getResource(g);ResourceManager.__resourceActionSucceeded(this,RESOURCE_CREATED,undefined)},function(){ResourceManager.__resourceActionFailed(this,RESOURCE_CREATED,undefined)},false);return c}throw"Could not create resource! raziel:collection URL is missing!";return false},__Resource:function(b,a){this.__id=b;this.__url=a;this.id=function(){return this.__id};this.url=function(){return this.__url};this.reload=function(){var d=this.__url;var c=this.__id;ResourceManager.__request("GET",d,null,function(){ResourceManager.__resourceActionSucceeded(this,RESOURCE_RELOADED,c)},function(){ResourceManager.__resourceActionFailed(this,RESURCE_RELOADED,c)},USE_ASYNCHRONOUS_REQUESTS)};this.save=function(e){var d=this.__url;var c=this.__id;data=DataManager.serialize($(c));ResourceManager.__request("PUT",d,data,function(){ResourceManager.__resourceActionSucceeded(this,e?RESOURCE_SAVED|RESOURCE_SYNCHRONIZED:RESOURCE_SAVED,c)},function(){ResourceManager.__resourceActionFailed(this,e?RESOURCE_SAVED|RESOURCE_SYNCHRONIZED:RESOURCE.SAVED,c)},USE_ASYNCHRONOUS_REQUESTS)};this.remove=function(){var d=this.__url;var c=this.__id;ResourceManager.__request("DELETE",d,null,function(){ResourceManager.__resourceActionSucceeded(this,RESOURCE_REMOVED,c)},function(){ResourceManager.__resourceActionFailed(this,RESOURCE_REMOVED,c)},USE_ASYNCHRONOUS_REQUESTS)}},request:function(c,a){var b={method:"get",asynchronous:true,parameters:{}};Object.extend(b,a||{});var d=Hash.toQueryString(b.parameters);if(d){c+=(c.include("?")?"&":"?")+d}return ResourceManager.__request(b.method,c,b.data,(b.onSuccess instanceof Function?function(){b.onSuccess(this)}:undefined),(b.onFailure instanceof Function?function(){b.onFailure(this)}:undefined),b.asynchronous&&USE_ASYNCHRONOUS_REQUESTS,b.headers)},__request:function(a,b,f,n,m,d,c){var g=Try.these(function(){return new XMLHttpRequest()},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")});if(!g){if(!this.__corrupt){throw"This browser does not provide any AJAX functionality. You will not be able to use the software provided with the page you are viewing. Please consider installing appropriate extensions."}this.__corrupt=true;return false}if(n instanceof Function){g.onload=n}if(m instanceof Function){g.onerror=m}var k=$H(c);k.keys().each(function(e){g.setRequestHeader(e,k[e])});try{if(SHOW_DEBUG_ALERTS_WHEN_SAVING){alert(a+" "+b+"\n"+SHOW_EXTENDED_DEBUG_INFORMATION?f:"")}g.open(a,b,!d?false:true);g.send(f)}catch(l){return false}return true},__resourceActionSucceeded:function(g,c,f){var a=g.status;var b=g.responseText;if(SHOW_DEBUG_ALERTS_WHEN_SAVING){alert(a+" "+url+"\n"+SHOW_EXTENDED_DEBUG_INFORMATION?data:"")}if(a>=300){throw"The server responded with an error: "+a+"\n"+(SHOW_EXTENDED_DEBUG_INFORMATION?+data:"If you need additional information here, including the data sent by the server, consider setting SHOW_EXTENDED_DEBUG_INFORMATION to true.")}switch(c){case RESOURCE_REMOVED:var b=(g.responseXML);var e=b.childNodes[0];var f=e.getAttribute("id");var d=document.getElementById(f);d.parentNode.removeChild(d);break;case RESOURCE_CREATED:break;case RESOURCE_SAVED|RESOURCE_SYNCHRONIZED:DataManager.__synclocal();case RESOURCE_SAVED:break;case RESOURCE_RELOADED:var b=(g.responseXML);var e=b.childNodes[0];var f=e.getAttribute("id");var d=document.getElementById(f);d.parentNode.removeChild(d);if(!$$(PROCESSDATA_REF)[0]){DataManager.graft(XMLNS.XHTML,document.getElementsByTagNameNS(XMLNS.XHTML,"body").item(0),["div",{"class":PROCESSDATA_REF,style:"display:none;"}])}$$(PROCESSDATA_REF)[0].appendChild(e.cloneNode(true));DataManager.__synclocal();break;default:DataManager.__synclocal()}ResourceManager.__dispatchEvent(new ResourceManager.__Event(c,f))},__resourceActionFailed:function(c,a,b){throw"Fatal: Resource action failed. There is something horribly wrong with either the server, the transport protocol or your online status. Sure you're online?"}};var Clazz=function(){};Clazz.prototype.construct=function(){};Clazz.extend=function(e){var a=function(){if(arguments[0]!==Clazz){this.construct.apply(this,arguments)}};var d=new this(Clazz);var b=this.prototype;for(var f in e){var c=e[f];if(c instanceof Function){c.$=b}d[f]=c}a.prototype=d;a.extend=this.extend;return a};if(!ORYX){var ORYX={}}if(!ORYX.CONFIG){ORYX.CONFIG={}}ORYX.CONFIG.ROOT_PATH="/oryx/";ORYX.CONFIG.WEB_URL="http://oryx-project.org";ORYX.CONFIG.VERSION_URL=ORYX.CONFIG.ROOT_PATH+"VERSION";ORYX.CONFIG.LICENSE_URL=ORYX.CONFIG.ROOT_PATH+"LICENSE";ORYX.CONFIG.SERVER_HANDLER_ROOT="";ORYX.CONFIG.STENCILSET_HANDLER=ORYX.CONFIG.SERVER_HANDLER_ROOT+"";ORYX.CONFIG.MODE_READONLY="readonly";ORYX.CONFIG.MODE_FULLSCREEN="fullscreen";ORYX.CONFIG.SHOW_GRIDLINE=true;ORYX.CONFIG.DISABLE_GRADIENT=true;ORYX.CONFIG.PLUGINS_ENABLED=true;ORYX.CONFIG.PLUGINS_CONFIG=ORYX.CONFIG.ROOT_PATH+"plugins.xml";ORYX.CONFIG.PROFILE_PATH=ORYX.CONFIG.ROOT_PATH+"profiles/";ORYX.CONFIG.PLUGINS_FOLDER="Plugins/";ORYX.CONFIG.PDF_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"pdf";ORYX.CONFIG.PNML_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"pnml";ORYX.CONFIG.SIMPLE_PNML_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"simplepnmlexporter";ORYX.CONFIG.DESYNCHRONIZABILITY_URL=ORYX.CONFIG.ROOT_PATH+"desynchronizability";ORYX.CONFIG.IBPMN2BPMN_URL=ORYX.CONFIG.ROOT_PATH+"ibpmn2bpmn";ORYX.CONFIG.BPMN2YAWL_URL=ORYX.CONFIG.ROOT_PATH+"bpmn2yawl";ORYX.CONFIG.QUERYEVAL_URL=ORYX.CONFIG.ROOT_PATH+"query";ORYX.CONFIG.QUERYVARIANTEVAL_URL=ORYX.CONFIG.ROOT_PATH+"queryvarianteval";ORYX.CONFIG.SYNTAXCHECKER_URL=ORYX.CONFIG.ROOT_PATH+"syntaxchecker";ORYX.CONFIG.VALIDATOR_URL=ORYX.CONFIG.ROOT_PATH+"validator";ORYX.CONFIG.AUTO_LAYOUTER_URL=ORYX.CONFIG.ROOT_PATH+"layouter";ORYX.CONFIG.SS_EXTENSIONS_FOLDER=ORYX.CONFIG.ROOT_PATH+"stencilsets/extensions/";ORYX.CONFIG.SS_EXTENSIONS_CONFIG=ORYX.CONFIG.ROOT_PATH+"stencilsets/extensions/extensions.json";ORYX.CONFIG.ORYX_NEW_URL="/new";ORYX.CONFIG.STEP_THROUGH=ORYX.CONFIG.ROOT_PATH+"stepthrough";ORYX.CONFIG.STEP_THROUGH_CHECKER=ORYX.CONFIG.ROOT_PATH+"stepthroughchecker";ORYX.CONFIG.XFORMS_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"xformsexport";ORYX.CONFIG.XFORMS_EXPORT_ORBEON_URL=ORYX.CONFIG.ROOT_PATH+"xformsexport-orbeon";ORYX.CONFIG.XFORMS_IMPORT_URL=ORYX.CONFIG.ROOT_PATH+"xformsimport";ORYX.CONFIG.BPEL_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"bpelexporter";ORYX.CONFIG.BPEL4CHOR_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"bpel4chorexporter";ORYX.CONFIG.BPEL4CHOR2BPEL_EXPORT_URL=ORYX.CONFIG.ROOT_PATH+"bpel4chor2bpelexporter";ORYX.CONFIG.TREEGRAPH_SUPPORT=ORYX.CONFIG.ROOT_PATH+"treegraphsupport";ORYX.CONFIG.XPDL4CHOR2BPEL4CHOR_TRANSFORMATION_URL=ORYX.CONFIG.ROOT_PATH+"xpdl4chor2bpel4chor";ORYX.CONFIG.RESOURCE_LIST=ORYX.CONFIG.ROOT_PATH+"resourceList";ORYX.CONFIG.BPMN_LAYOUTER=ORYX.CONFIG.ROOT_PATH+"bpmnlayouter";ORYX.CONFIG.EPC_LAYOUTER=ORYX.CONFIG.ROOT_PATH+"epclayouter";ORYX.CONFIG.BPMN2MIGRATION=ORYX.CONFIG.ROOT_PATH+"bpmn2migration";ORYX.CONFIG.BPMN20_SCHEMA_VALIDATION_ON=true;ORYX.CONFIG.BPMN20_COMPLIANCE_TEMPLATE_SAT_SOLVER=ORYX.CONFIG.ROOT_PATH+"satSolver";ORYX.CONFIG.JPDLIMPORTURL=ORYX.CONFIG.ROOT_PATH+"jpdlimporter";ORYX.CONFIG.JPDLEXPORTURL=ORYX.CONFIG.ROOT_PATH+"jpdlexporter";ORYX.CONFIG.CPNTOOLSEXPORTER=ORYX.CONFIG.ROOT_PATH+"cpntoolsexporter";ORYX.CONFIG.CPNTOOLSIMPORTER=ORYX.CONFIG.ROOT_PATH+"cpntoolsimporter";ORYX.CONFIG.BPMN2XPDLPATH=ORYX.CONFIG.ROOT_PATH+"bpmn2xpdl";ORYX.CONFIG.VISIOIMPORT=ORYX.CONFIG.ROOT_PATH+"visioimport";ORYX.CONFIG.NAMESPACE_ORYX="http://www.b3mn.org/oryx";ORYX.CONFIG.NAMESPACE_SVG="http://www.w3.org/2000/svg";ORYX.CONFIG.CANVAS_WIDTH=1029;ORYX.CONFIG.CANVAS_HEIGHT=490;ORYX.CONFIG.CANVAS_RESIZE_INTERVAL=300;ORYX.CONFIG.SELECTED_AREA_PADDING=4;ORYX.CONFIG.CANVAS_BACKGROUND_COLOR="none";ORYX.CONFIG.GRID_DISTANCE=30;ORYX.CONFIG.GRID_ENABLED=true;ORYX.CONFIG.ZOOM_OFFSET=0.1;ORYX.CONFIG.DEFAULT_SHAPE_MARGIN=60;ORYX.CONFIG.SCALERS_SIZE=7;ORYX.CONFIG.MINIMUM_SIZE=20;ORYX.CONFIG.MAXIMUM_SIZE=10000;ORYX.CONFIG.OFFSET_MAGNET=15;ORYX.CONFIG.OFFSET_EDGE_LABEL_TOP=14;ORYX.CONFIG.OFFSET_EDGE_LABEL_BOTTOM=12;ORYX.CONFIG.OFFSET_EDGE_BOUNDS=5;ORYX.CONFIG.COPY_MOVE_OFFSET=30;ORYX.CONFIG.SHOW_GRIDLINE=true;ORYX.CONFIG.BORDER_OFFSET=14;ORYX.CONFIG.MAX_NUM_SHAPES_NO_GROUP=13;ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER=30;ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET=45;ORYX.CONFIG.SHAPEMENU_RIGHT="Oryx_Right";ORYX.CONFIG.SHAPEMENU_BOTTOM="Oryx_Bottom";ORYX.CONFIG.SHAPEMENU_LEFT="Oryx_Left";ORYX.CONFIG.SHAPEMENU_TOP="Oryx_Top";ORYX.CONFIG.MORPHITEM_DISABLED="Oryx_MorphItem_disabled";ORYX.CONFIG.TYPE_STRING="string";ORYX.CONFIG.TYPE_BOOLEAN="boolean";ORYX.CONFIG.TYPE_INTEGER="integer";ORYX.CONFIG.TYPE_FLOAT="float";ORYX.CONFIG.TYPE_COLOR="color";ORYX.CONFIG.TYPE_DATE="date";ORYX.CONFIG.TYPE_CHOICE="choice";ORYX.CONFIG.TYPE_URL="url";ORYX.CONFIG.TYPE_DIAGRAM_LINK="diagramlink";ORYX.CONFIG.TYPE_COMPLEX="complex";ORYX.CONFIG.TYPE_TEXT="text";ORYX.CONFIG.LABEL_LINE_DISTANCE=2;ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT=12;ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER=true;ORYX.CONFIG.EDITOR_ALIGN_BOTTOM=1;ORYX.CONFIG.EDITOR_ALIGN_MIDDLE=2;ORYX.CONFIG.EDITOR_ALIGN_TOP=4;ORYX.CONFIG.EDITOR_ALIGN_LEFT=8;ORYX.CONFIG.EDITOR_ALIGN_CENTER=16;ORYX.CONFIG.EDITOR_ALIGN_RIGHT=32;ORYX.CONFIG.EDITOR_ALIGN_SIZE=48;ORYX.CONFIG.EVENT_MOUSEDOWN="mousedown";ORYX.CONFIG.EVENT_MOUSEUP="mouseup";ORYX.CONFIG.EVENT_MOUSEOVER="mouseover";ORYX.CONFIG.EVENT_MOUSEOUT="mouseout";ORYX.CONFIG.EVENT_MOUSEMOVE="mousemove";ORYX.CONFIG.EVENT_DBLCLICK="dblclick";ORYX.CONFIG.EVENT_KEYDOWN="keydown";ORYX.CONFIG.EVENT_KEYUP="keyup";ORYX.CONFIG.EVENT_LOADED="editorloaded";ORYX.CONFIG.EVENT_EXECUTE_COMMANDS="executeCommands";ORYX.CONFIG.EVENT_STENCIL_SET_LOADED="stencilSetLoaded";ORYX.CONFIG.EVENT_SELECTION_CHANGED="selectionchanged";ORYX.CONFIG.EVENT_SHAPEADDED="shapeadded";ORYX.CONFIG.EVENT_PROPERTY_CHANGED="propertyChanged";ORYX.CONFIG.EVENT_DRAGDROP_START="dragdrop.start";ORYX.CONFIG.EVENT_SHAPE_MENU_CLOSE="shape.menu.close";ORYX.CONFIG.EVENT_DRAGDROP_END="dragdrop.end";ORYX.CONFIG.EVENT_RESIZE_START="resize.start";ORYX.CONFIG.EVENT_RESIZE_END="resize.end";ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED="dragDocker.docked";ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW="highlight.showHighlight";ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE="highlight.hideHighlight";ORYX.CONFIG.EVENT_LOADING_ENABLE="loading.enable";ORYX.CONFIG.EVENT_LOADING_DISABLE="loading.disable";ORYX.CONFIG.EVENT_LOADING_STATUS="loading.status";ORYX.CONFIG.EVENT_OVERLAY_SHOW="overlay.show";ORYX.CONFIG.EVENT_OVERLAY_HIDE="overlay.hide";ORYX.CONFIG.EVENT_ARRANGEMENT_TOP="arrangement.setToTop";ORYX.CONFIG.EVENT_ARRANGEMENT_BACK="arrangement.setToBack";ORYX.CONFIG.EVENT_ARRANGEMENT_FORWARD="arrangement.setForward";ORYX.CONFIG.EVENT_ARRANGEMENT_BACKWARD="arrangement.setBackward";ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED="propertyWindow.propertyChanged";ORYX.CONFIG.EVENT_LAYOUT_ROWS="layout.rows";ORYX.CONFIG.EVENT_LAYOUT_BPEL="layout.BPEL";ORYX.CONFIG.EVENT_LAYOUT_BPEL_VERTICAL="layout.BPEL.vertical";ORYX.CONFIG.EVENT_LAYOUT_BPEL_HORIZONTAL="layout.BPEL.horizontal";ORYX.CONFIG.EVENT_LAYOUT_BPEL_SINGLECHILD="layout.BPEL.singlechild";ORYX.CONFIG.EVENT_LAYOUT_BPEL_AUTORESIZE="layout.BPEL.autoresize";ORYX.CONFIG.EVENT_AUTOLAYOUT_LAYOUT="autolayout.layout";ORYX.CONFIG.EVENT_UNDO_EXECUTE="undo.execute";ORYX.CONFIG.EVENT_UNDO_ROLLBACK="undo.rollback";ORYX.CONFIG.EVENT_BUTTON_UPDATE="toolbar.button.update";ORYX.CONFIG.EVENT_LAYOUT="layout.dolayout";ORYX.CONFIG.EVENT_COLOR_CHANGE="color.change";ORYX.CONFIG.EVENT_DOCKERDRAG="dragTheDocker";ORYX.CONFIG.EVENT_SHOW_PROPERTYWINDOW="propertywindow.show";ORYX.CONFIG.EVENT_SHAPE_MORPHED="shapemorphed";ORYX.CONFIG.EVENT_WINDOW_FOCUS="window.focus";ORYX.CONFIG.EVENT_TBPM_BACKGROUND_UPDATE="tbpm.background";ORYX.CONFIG.EVENT_MODEL_SAVED="model.saved";ORYX.CONFIG.EVENT_REGISTER_LABEL_TEMPLATE="register.label.template";ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE=5;ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR="#4444FF";ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR2="#9999FF";ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_CORNER="corner";ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE="rectangle";ORYX.CONFIG.SELECTION_VALID_COLOR="#00FF00";ORYX.CONFIG.SELECTION_INVALID_COLOR="#FF0000";ORYX.CONFIG.DOCKER_DOCKED_COLOR="#00FF00";ORYX.CONFIG.DOCKER_UNDOCKED_COLOR="#FF0000";ORYX.CONFIG.DOCKER_SNAP_OFFSET=10;ORYX.CONFIG.EDIT_OFFSET_PASTE=10;ORYX.CONFIG.KEY_CODE_X=88;ORYX.CONFIG.KEY_CODE_C=67;ORYX.CONFIG.KEY_CODE_V=86;ORYX.CONFIG.KEY_CODE_DELETE=46;ORYX.CONFIG.KEY_CODE_META=224;ORYX.CONFIG.KEY_CODE_BACKSPACE=8;ORYX.CONFIG.KEY_CODE_LEFT=37;ORYX.CONFIG.KEY_CODE_RIGHT=39;ORYX.CONFIG.KEY_CODE_UP=38;ORYX.CONFIG.KEY_CODE_DOWN=40;ORYX.CONFIG.KEY_Code_enter=12;ORYX.CONFIG.KEY_Code_left=37;ORYX.CONFIG.KEY_Code_right=39;ORYX.CONFIG.KEY_Code_top=38;ORYX.CONFIG.KEY_Code_bottom=40;ORYX.CONFIG.META_KEY_META_CTRL="metactrl";ORYX.CONFIG.META_KEY_ALT="alt";ORYX.CONFIG.META_KEY_SHIFT="shift";ORYX.CONFIG.KEY_ACTION_DOWN="down";ORYX.CONFIG.KEY_ACTION_UP="up";function printf(){var a=arguments[0];for(var b=1;b<arguments.length;b++){a=a.replace("%"+(b-1),arguments[b])}return a}var ORYX_LOGLEVEL_TRACE=5;var ORYX_LOGLEVEL_DEBUG=4;var ORYX_LOGLEVEL_INFO=3;var ORYX_LOGLEVEL_WARN=2;var ORYX_LOGLEVEL_ERROR=1;var ORYX_LOGLEVEL_FATAL=0;var ORYX_LOGLEVEL=4;var ORYX_CONFIGURATION_DELAY=100;var ORYX_CONFIGURATION_WAIT_ATTEMPTS=10;if(!ORYX){var ORYX={}}ORYX=Object.extend(ORYX,{PATH:ORYX.CONFIG.ROOT_PATH,URLS:[],alreadyLoaded:[],configrationRetries:0,Version:"0.1.1",availablePlugins:[],Log:{__appenders:[{append:function(b,a){if(window.console){switch(b){case"TRACE":a.unshift("[TRACE|"+(new Date()).getTime()+"]");case"DEBUG":window.console.debug.apply(window.console,a);break;case"INFO":window.console.info.apply(window.console,a);break;case"WARN":window.console.warn.apply(window.console,a);break;case"FATAL":a.unshift("[FATAL]");case"ERROR":window.console.error.apply(window.console,a);break;default:a.unshift("["+b.toUpperCase()+"]");window.console.log.apply(window.console,a)}}}}],trace:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_TRACE){ORYX.Log.__log("TRACE",arguments)}},debug:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_DEBUG){ORYX.Log.__log("DEBUG",arguments)}},info:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_INFO){ORYX.Log.__log("INFO",arguments)}},warn:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_WARN){ORYX.Log.__log("WARN",arguments)}},error:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_ERROR){ORYX.Log.__log("ERROR",arguments)}},fatal:function(){if(ORYX_LOGLEVEL>=ORYX_LOGLEVEL_FATAL){ORYX.Log.__log("FATAL",arguments)}},__log:function(b,a){ORYX.Log.__appenders.each(function(c){c.append(b,$A(a))})},addAppender:function(a){ORYX.Log.__appenders.push(a)}},load:function(){var a=new Ext.Window({renderTo:Ext.getBody(),id:"oryx-loading-panel",bodyStyle:"padding: 8px;background:white",title:ORYX.I18N.Oryx.title,width:"auto",height:"auto",modal:true,resizable:false,closable:false,html:'<span style="font-size:11px;">'+ORYX.I18N.Oryx.pleaseWait+"</span>"});a.show();ORYX.Log.debug("Oryx begins loading procedure.");if((typeof Prototype=="undefined")||(typeof Element=="undefined")||(typeof Element.Methods=="undefined")||parseFloat(Prototype.Version.split(".")[0]+"."+Prototype.Version.split(".")[1])<1.5){throw ("Application requires the Prototype JavaScript framework >= 1.5.3")}ORYX.Log.debug("Prototype > 1.5 found.");ORYX._load()},_load:function(){ORYX.loadPlugins()},loadPlugins:function(){if(ORYX.CONFIG.PLUGINS_ENABLED){ORYX._loadPlugins()}else{ORYX.Log.warn("Ignoring plugins, loading Core only.")}init()},_loadPlugins:function(){var a=ORYX.CONFIG.PLUGINS_CONFIG;ORYX.Log.debug("Loading plugin configuration from '%0'.",a);new Ajax.Request(a,{asynchronous:false,method:"get",onSuccess:function(c){ORYX.Log.info("Plugin configuration file loaded.");var f=c.responseXML;var b=[];var d=$A(f.getElementsByTagName("properties"));d.each(function(h){var g=$A(h.childNodes);g.each(function(m){var l=new Hash();var k=$A(m.attributes);k.each(function(n){l[n.nodeName]=n.nodeValue});if(k.length>0){b.push(l)}})});var e=f.getElementsByTagName("plugin");$A(e).each(function(k){var p=new Hash();$A(k.attributes).each(function(r){p[r.nodeName]=r.nodeValue});if(!p.name){ORYX.Log.error("A plugin is not providing a name. Ingnoring this plugin.");return}if(!p.source){ORYX.Log.error("Plugin with name '%0' doesn't provide a source attribute.",p.name);return}var n=k.getElementsByTagName("property");var o=[];$A(n).each(function(t){var s=new Hash();var r=$A(t.attributes);r.each(function(u){s[u.nodeName]=u.nodeValue});if(r.length>0){o.push(s)}});o=o.concat(b);p.properties=o;var l=k.getElementsByTagName("requires");var q;$A(l).each(function(s){var r=$A(s.attributes).find(function(t){return t.name=="namespace"});if(r&&r.nodeValue){if(!q){q={namespaces:[]}}q.namespaces.push(r.nodeValue)}});if(q){p.requires=q}var m=k.getElementsByTagName("notUsesIn");var h;$A(m).each(function(s){var r=$A(s.attributes).find(function(t){return t.name=="namespace"});if(r&&r.nodeValue){if(!h){h={namespaces:[]}}h.namespaces.push(r.nodeValue)}});if(h){p.notUsesIn=h}var g=ORYX.PATH+ORYX.CONFIG.PLUGINS_FOLDER+p.source;ORYX.Log.debug("Requireing '%0'",g);ORYX.Log.info("Plugin '%0' successfully loaded.",p.name);ORYX.availablePlugins.push(p)})},onFailure:this._loadPluginsOnFails})},_loadPluginsOnFails:function(a){ORYX.Log.error("Plugin configuration file not available.")}});ORYX.Log.debug("Registering Oryx with Kickstart");Kickstart.register(ORYX.load);if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.SVG){ORYX.Core.SVG={}}ORYX.Core.SVG.EditPathHandler=Clazz.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.x=0;this.y=0;this.oldX=0;this.oldY=0;this.deltaWidth=1;this.deltaHeight=1;this.d=""},init:function(a,f,d,b,c,e){this.x=a;this.y=f;this.oldX=d;this.oldY=b;this.deltaWidth=c;this.deltaHeight=e;this.d=""},editPointsAbs:function(c){if(c instanceof Array){var d=[];var a,e;for(var b=0;b<c.length;b++){a=(parseFloat(c[b])-this.oldX)*this.deltaWidth+this.x;b++;e=(parseFloat(c[b])-this.oldY)*this.deltaHeight+this.y;d.push(a);d.push(e)}return d}else{}},editPointsRel:function(c){if(c instanceof Array){var d=[];var a,e;for(var b=0;b<c.length;b++){a=parseFloat(c[b])*this.deltaWidth;b++;e=parseFloat(c[b])*this.deltaHeight;d.push(a);d.push(e)}return d}else{}},arcAbs:function(e,c,k,b,f,h,g){var d=this.editPointsAbs([h,g]);var a=this.editPointsRel([e,c]);this.d=this.d.concat(" A"+a[0]+" "+a[1]+" "+k+" "+b+" "+f+" "+d[0]+" "+d[1]+" ")},arcRel:function(f,d,b,e,c,a,h){var g=this.editPointsRel([f,d,a,h]);this.d=this.d.concat(" a"+g[0]+" "+g[1]+" "+b+" "+e+" "+c+" "+g[2]+" "+g[3]+" ")},curvetoCubicAbs:function(c,e,b,d,a,g){var f=this.editPointsAbs([c,e,b,d,a,g]);this.d=this.d.concat(" C"+f[0]+" "+f[1]+" "+f[2]+" "+f[3]+" "+f[4]+" "+f[5]+" ")},curvetoCubicRel:function(c,e,b,d,a,g){var f=this.editPointsRel([c,e,b,d,a,g]);this.d=this.d.concat(" c"+f[0]+" "+f[1]+" "+f[2]+" "+f[3]+" "+f[4]+" "+f[5]+" ")},linetoHorizontalAbs:function(a){var b=this.editPointsAbs([a,0]);this.d=this.d.concat(" H"+b[0]+" ")},linetoHorizontalRel:function(a){var b=this.editPointsRel([a,0]);this.d=this.d.concat(" h"+b[0]+" ")},linetoAbs:function(a,c){var b=this.editPointsAbs([a,c]);this.d=this.d.concat(" L"+b[0]+" "+b[1]+" ")},linetoRel:function(a,c){var b=this.editPointsRel([a,c]);this.d=this.d.concat(" l"+b[0]+" "+b[1]+" ")},movetoAbs:function(a,c){var b=this.editPointsAbs([a,c]);this.d=this.d.concat(" M"+b[0]+" "+b[1]+" ")},movetoRel:function(a,c){var b;if(this.d===""){b=this.editPointsAbs([a,c])}else{b=this.editPointsRel([a,c])}this.d=this.d.concat(" m"+b[0]+" "+b[1]+" ")},curvetoQuadraticAbs:function(b,c,a,e){var d=this.editPointsAbs([b,c,a,e]);this.d=this.d.concat(" Q"+d[0]+" "+d[1]+" "+d[2]+" "+d[3]+" ")},curvetoQuadraticRel:function(b,c,a,e){var d=this.editPointsRel([b,c,a,e]);this.d=this.d.concat(" q"+d[0]+" "+d[1]+" "+d[2]+" "+d[3]+" ")},curvetoCubicSmoothAbs:function(b,c,a,e){var d=this.editPointsAbs([b,c,a,e]);this.d=this.d.concat(" S"+d[0]+" "+d[1]+" "+d[2]+" "+d[3]+" ")},curvetoCubicSmoothRel:function(b,c,a,e){var d=this.editPointsRel([b,c,a,e]);this.d=this.d.concat(" s"+d[0]+" "+d[1]+" "+d[2]+" "+d[3]+" ")},curvetoQuadraticSmoothAbs:function(a,c){var b=this.editPointsAbs([a,c]);this.d=this.d.concat(" T"+b[0]+" "+b[1]+" ")},curvetoQuadraticSmoothRel:function(a,c){var b=this.editPointsRel([a,c]);this.d=this.d.concat(" t"+b[0]+" "+b[1]+" ")},linetoVerticalAbs:function(b){var a=this.editPointsAbs([0,b]);this.d=this.d.concat(" V"+a[1]+" ")},linetoVerticalRel:function(b){var a=this.editPointsRel([0,b]);this.d=this.d.concat(" v"+a[1]+" ")},closePath:function(){this.d=this.d.concat(" z")}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.SVG){ORYX.Core.SVG={}}ORYX.Core.SVG.MinMaxPathHandler=Clazz.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.minX=undefined;this.minY=undefined;this.maxX=undefined;this.maxY=undefined;this._lastAbsX=undefined;this._lastAbsY=undefined},calculateMinMax:function(c){if(c instanceof Array){var a,d;for(var b=0;b<c.length;b++){a=parseFloat(c[b]);b++;d=parseFloat(c[b]);this.minX=(this.minX!==undefined)?Math.min(this.minX,a):a;this.maxX=(this.maxX!==undefined)?Math.max(this.maxX,a):a;this.minY=(this.minY!==undefined)?Math.min(this.minY,d):d;this.maxY=(this.maxY!==undefined)?Math.max(this.maxY,d):d;this._lastAbsX=a;this._lastAbsY=d}}else{}},arcAbs:function(f,d,b,e,c,a,g){this.calculateMinMax([a,g])},arcRel:function(f,d,b,e,c,a,g){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY+g])},curvetoCubicAbs:function(c,e,b,d,a,f){this.calculateMinMax([c,e,b,d,a,f])},curvetoCubicRel:function(c,e,b,d,a,f){this.calculateMinMax([this._lastAbsX+c,this._lastAbsY+e,this._lastAbsX+b,this._lastAbsY+d,this._lastAbsX+a,this._lastAbsY+f])},linetoHorizontalAbs:function(a){this.calculateMinMax([a,this._lastAbsY])},linetoHorizontalRel:function(a){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY])},linetoAbs:function(a,b){this.calculateMinMax([a,b])},linetoRel:function(a,b){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY+b])},movetoAbs:function(a,b){this.calculateMinMax([a,b])},movetoRel:function(a,b){if(this._lastAbsX&&this._lastAbsY){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY+b])}else{this.calculateMinMax([a,b])}},curvetoQuadraticAbs:function(b,c,a,d){this.calculateMinMax([b,c,a,d])},curvetoQuadraticRel:function(b,c,a,d){this.calculateMinMax([this._lastAbsX+b,this._lastAbsY+c,this._lastAbsX+a,this._lastAbsY+d])},curvetoCubicSmoothAbs:function(b,c,a,d){this.calculateMinMax([b,c,a,d])},curvetoCubicSmoothRel:function(b,c,a,d){this.calculateMinMax([this._lastAbsX+b,this._lastAbsY+c,this._lastAbsX+a,this._lastAbsY+d])},curvetoQuadraticSmoothAbs:function(a,b){this.calculateMinMax([a,b])},curvetoQuadraticSmoothRel:function(a,b){this.calculateMinMax([this._lastAbsX+a,this._lastAbsY+b])},linetoVerticalAbs:function(a){this.calculateMinMax([this._lastAbsX,a])},linetoVerticalRel:function(a){this.calculateMinMax([this._lastAbsX,this._lastAbsY+a])},closePath:function(){return}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.SVG){ORYX.Core.SVG={}}ORYX.Core.SVG.PointsPathHandler=Clazz.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.points=[];this._lastAbsX=undefined;this._lastAbsY=undefined},addPoints:function(c){if(c instanceof Array){var a,d;for(var b=0;b<c.length;b++){a=parseFloat(c[b]);b++;d=parseFloat(c[b]);this.points.push(a);this.points.push(d);this._lastAbsX=a;this._lastAbsY=d}}else{}},arcAbs:function(f,d,b,e,c,a,g){this.addPoints([a,g])},arcRel:function(f,d,b,e,c,a,g){this.addPoints([this._lastAbsX+a,this._lastAbsY+g])},curvetoCubicAbs:function(c,e,b,d,a,f){this.addPoints([a,f])},curvetoCubicRel:function(c,e,b,d,a,f){this.addPoints([this._lastAbsX+a,this._lastAbsY+f])},linetoHorizontalAbs:function(a){this.addPoints([a,this._lastAbsY])},linetoHorizontalRel:function(a){this.addPoints([this._lastAbsX+a,this._lastAbsY])},linetoAbs:function(a,b){this.addPoints([a,b])},linetoRel:function(a,b){this.addPoints([this._lastAbsX+a,this._lastAbsY+b])},movetoAbs:function(a,b){this.addPoints([a,b])},movetoRel:function(a,b){if(this._lastAbsX&&this._lastAbsY){this.addPoints([this._lastAbsX+a,this._lastAbsY+b])}else{this.addPoints([a,b])}},curvetoQuadraticAbs:function(b,c,a,d){this.addPoints([a,d])},curvetoQuadraticRel:function(b,c,a,d){this.addPoints([this._lastAbsX+a,this._lastAbsY+d])},curvetoCubicSmoothAbs:function(b,c,a,d){this.addPoints([a,d])},curvetoCubicSmoothRel:function(b,c,a,d){this.addPoints([this._lastAbsX+a,this._lastAbsY+d])},curvetoQuadraticSmoothAbs:function(a,b){this.addPoints([a,b])},curvetoQuadraticSmoothRel:function(a,b){this.addPoints([this._lastAbsX+a,this._lastAbsY+b])},linetoVerticalAbs:function(a){this.addPoints([this._lastAbsX,a])},linetoVerticalRel:function(a){this.addPoints([this._lastAbsX,this._lastAbsY+a])},closePath:function(){return}});NAMESPACE_ORYX="http://www.b3mn.org/oryx";NAMESPACE_SVG="http://www.w3.org/2000/svg/";if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.SVG){ORYX.Core.SVG={}}ORYX.Core.SVG.SVGMarker=Clazz.extend({construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.id=undefined;this.element=a;this.refX=undefined;this.refY=undefined;this.markerWidth=undefined;this.markerHeight=undefined;this.oldRefX=undefined;this.oldRefY=undefined;this.oldMarkerWidth=undefined;this.oldMarkerHeight=undefined;this.optional=false;this.enabled=true;this.minimumLength=undefined;this.resize=false;this.svgShapes=[];this._init()},_init:function(){if(!(this.element=="[object SVGMarkerElement]")){throw"SVGMarker: Argument is not an instance of SVGMarkerElement."}this.id=this.element.getAttributeNS(null,"id");var a=this.element.getAttributeNS(null,"refX");if(a){this.refX=parseFloat(a)}else{this.refX=0}var h=this.element.getAttributeNS(null,"refY");if(h){this.refY=parseFloat(h)}else{this.refY=0}var f=this.element.getAttributeNS(null,"markerWidth");if(f){this.markerWidth=parseFloat(f)}else{this.markerWidth=3}var c=this.element.getAttributeNS(null,"markerHeight");if(c){this.markerHeight=parseFloat(c)}else{this.markerHeight=3}this.oldRefX=this.refX;this.oldRefY=this.refY;this.oldMarkerWidth=this.markerWidth;this.oldMarkerHeight=this.markerHeight;var g=this.element.getAttributeNS(NAMESPACE_ORYX,"optional");if(g){g=g.strip();this.optional=(g.toLowerCase()==="yes")}else{this.optional=false}var e=this.element.getAttributeNS(NAMESPACE_ORYX,"enabled");if(e){e=e.strip();this.enabled=!(e.toLowerCase()==="no")}else{this.enabled=true}var d=this.element.getAttributeNS(NAMESPACE_ORYX,"minimumLength");if(d){this.minimumLength=parseFloat(d)}var b=this.element.getAttributeNS(NAMESPACE_ORYX,"resize");if(b){b=b.strip();this.resize=(b.toLowerCase()==="yes")}else{this.resize=false}},_getSVGShapes:function(c){if(c.hasChildNodes){var a=[];var b=this;$A(c.childNodes).each(function(d){try{var g=new ORYX.Core.SVG.SVGShape(d);a.push(g)}catch(f){a=a.concat(b._getSVGShapes(d))}});return a}},update:function(){this.oldRefX=this.refX;this.oldRefY=this.refY;this.oldMarkerWidth=this.markerWidth;this.oldMarkerHeight=this.markerHeight},toString:function(){return(this.element)?"SVGMarker "+this.element.id:"SVGMarker "+this.element}});NAMESPACE_ORYX="http://www.b3mn.org/oryx";NAMESPACE_SVG="http://www.w3.org/2000/svg/";if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.SVG){ORYX.Core.SVG={}}ORYX.Core.SVG.SVGShape=Clazz.extend({construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.type;this.element=a;this.x=undefined;this.y=undefined;this.width=undefined;this.height=undefined;this.oldX=undefined;this.oldY=undefined;this.oldWidth=undefined;this.oldHeight=undefined;this.radiusX=undefined;this.radiusY=undefined;this.isHorizontallyResizable=false;this.isVerticallyResizable=false;this.anchorLeft=false;this.anchorRight=false;this.anchorTop=false;this.anchorBottom=false;this.allowDockers=true;this.resizeMarkerMid=false;this.editPathParser;this.editPathHandler;this.init()},init:function(){if(ORYX.Editor.checkClassType(this.element,SVGRectElement)||ORYX.Editor.checkClassType(this.element,SVGImageElement)){this.type="Rect";var H=this.element.getAttributeNS(null,"x");if(H){this.oldX=parseFloat(H)}else{throw"Missing attribute in element "+this.element}var p=this.element.getAttributeNS(null,"y");if(p){this.oldY=parseFloat(p)}else{throw"Missing attribute in element "+this.element}var r=this.element.getAttributeNS(null,"width");if(r){this.oldWidth=parseFloat(r)}else{throw"Missing attribute in element "+this.element}var t=this.element.getAttributeNS(null,"height");if(t){this.oldHeight=parseFloat(t)}else{throw"Missing attribute in element "+this.element}}else{if(ORYX.Editor.checkClassType(this.element,SVGCircleElement)){this.type="Circle";var h=undefined;var e=undefined;var a=this.element.getAttributeNS(null,"cx");if(a){h=parseFloat(a)}else{throw"Missing attribute in element "+this.element}var v=this.element.getAttributeNS(null,"cy");if(v){e=parseFloat(v)}else{throw"Missing attribute in element "+this.element}var k=this.element.getAttributeNS(null,"r");if(k){this.radiusX=parseFloat(k)}else{throw"Missing attribute in element "+this.element}this.oldX=h-this.radiusX;this.oldY=e-this.radiusX;this.oldWidth=2*this.radiusX;this.oldHeight=2*this.radiusX}else{if(ORYX.Editor.checkClassType(this.element,SVGEllipseElement)){this.type="Ellipse";var h=undefined;var e=undefined;var a=this.element.getAttributeNS(null,"cx");if(a){h=parseFloat(a)}else{throw"Missing attribute in element "+this.element}var v=this.element.getAttributeNS(null,"cy");if(v){e=parseFloat(v)}else{throw"Missing attribute in element "+this.element}var I=this.element.getAttributeNS(null,"rx");if(I){this.radiusX=parseFloat(I)}else{throw"Missing attribute in element "+this.element}var q=this.element.getAttributeNS(null,"ry");if(q){this.radiusY=parseFloat(q)}else{throw"Missing attribute in element "+this.element}this.oldX=h-this.radiusX;this.oldY=e-this.radiusY;this.oldWidth=2*this.radiusX;this.oldHeight=2*this.radiusY}else{if(ORYX.Editor.checkClassType(this.element,SVGLineElement)){this.type="Line";var B=undefined;var g=undefined;var z=undefined;var d=undefined;var G=this.element.getAttributeNS(null,"x1");if(G){B=parseFloat(G)}else{throw"Missing attribute in element "+this.element}var b=this.element.getAttributeNS(null,"y1");if(b){g=parseFloat(b)}else{throw"Missing attribute in element "+this.element}var m=this.element.getAttributeNS(null,"x2");if(m){z=parseFloat(m)}else{throw"Missing attribute in element "+this.element}var u=this.element.getAttributeNS(null,"y2");if(u){d=parseFloat(u)}else{throw"Missing attribute in element "+this.element}this.oldX=Math.min(B,z);this.oldY=Math.min(g,d);this.oldWidth=Math.abs(B-z);this.oldHeight=Math.abs(g-d)}else{if(ORYX.Editor.checkClassType(this.element,SVGPolylineElement)||ORYX.Editor.checkClassType(this.element,SVGPolygonElement)){this.type="Polyline";var y=this.element.getAttributeNS(null,"points");if(y){y=y.replace(/,/g," ");var n=y.split(" ");n=n.without("");if(n&&n.length&&n.length>1){var F=parseFloat(n[0]);var E=parseFloat(n[1]);var D=parseFloat(n[0]);var C=parseFloat(n[1]);for(var x=0;x<n.length;x++){F=Math.min(F,parseFloat(n[x]));D=Math.max(D,parseFloat(n[x]));x++;E=Math.min(E,parseFloat(n[x]));C=Math.max(C,parseFloat(n[x]))}this.oldX=F;this.oldY=E;this.oldWidth=D-F;this.oldHeight=C-E}else{throw"Missing attribute in element "+this.element}}else{throw"Missing attribute in element "+this.element}}else{if(ORYX.Editor.checkClassType(this.element,SVGPathElement)){this.type="Path";this.editPathParser=new PathParser();this.editPathHandler=new ORYX.Core.SVG.EditPathHandler();this.editPathParser.setHandler(this.editPathHandler);var f=new PathParser();var c=new ORYX.Core.SVG.MinMaxPathHandler();f.setHandler(c);f.parsePath(this.element);this.oldX=c.minX;this.oldY=c.minY;this.oldWidth=c.maxX-c.minX;this.oldHeight=c.maxY-c.minY;delete f;delete c}else{throw"Element is not a shape."}}}}}}var s=this.element.getAttributeNS(NAMESPACE_ORYX,"resize");if(s){s=s.toLowerCase();if(s.match(/horizontal/)){this.isHorizontallyResizable=true}else{this.isHorizontallyResizable=false}if(s.match(/vertical/)){this.isVerticallyResizable=true}else{this.isVerticallyResizable=false}}else{this.isHorizontallyResizable=false;this.isVerticallyResizable=false}var w=this.element.getAttributeNS(NAMESPACE_ORYX,"anchors");if(w){w=w.replace("/,/g"," ");var o=w.split(" ").without("");for(var x=0;x<o.length;x++){switch(o[x].toLowerCase()){case"left":this.anchorLeft=true;break;case"right":this.anchorRight=true;break;case"top":this.anchorTop=true;break;case"bottom":this.anchorBottom=true;break}}}if(ORYX.Editor.checkClassType(this.element,SVGPathElement)){var l=this.element.getAttributeNS(NAMESPACE_ORYX,"allowDockers");if(l){if(l.toLowerCase()==="no"){this.allowDockers=false}else{this.allowDockers=true}}var A=this.element.getAttributeNS(NAMESPACE_ORYX,"resizeMarker-mid");if(A){if(A.toLowerCase()==="yes"){this.resizeMarkerMid=true}else{this.resizeMarkerMid=false}}}this.x=this.oldX;this.y=this.oldY;this.width=this.oldWidth;this.height=this.oldHeight},update:function(){if(this.x!==this.oldX||this.y!==this.oldY||this.width!==this.oldWidth||this.height!==this.oldHeight){switch(this.type){case"Rect":if(this.x!==this.oldX){this.element.setAttributeNS(null,"x",this.x)}if(this.y!==this.oldY){this.element.setAttributeNS(null,"y",this.y)}if(this.width!==this.oldWidth){this.element.setAttributeNS(null,"width",this.width)}if(this.height!==this.oldHeight){this.element.setAttributeNS(null,"height",this.height)}break;case"Circle":this.radiusX=((this.width<this.height)?this.width:this.height)/2;this.element.setAttributeNS(null,"cx",this.x+this.width/2);this.element.setAttributeNS(null,"cy",this.y+this.height/2);this.element.setAttributeNS(null,"r",this.radiusX);break;case"Ellipse":this.radiusX=this.width/2;this.radiusY=this.height/2;this.element.setAttributeNS(null,"cx",this.x+this.radiusX);this.element.setAttributeNS(null,"cy",this.y+this.radiusY);this.element.setAttributeNS(null,"rx",this.radiusX);this.element.setAttributeNS(null,"ry",this.radiusY);break;case"Line":if(this.x!==this.oldX){this.element.setAttributeNS(null,"x1",this.x)}if(this.y!==this.oldY){this.element.setAttributeNS(null,"y1",this.y)}if(this.x!==this.oldX||this.width!==this.oldWidth){this.element.setAttributeNS(null,"x2",this.x+this.width)}if(this.y!==this.oldY||this.height!==this.oldHeight){this.element.setAttributeNS(null,"y2",this.y+this.height)}break;case"Polyline":var d=this.element.getAttributeNS(null,"points");if(d){d=d.replace(/,/g," ").split(" ").without("");if(d&&d.length&&d.length>1){var g=(this.oldWidth===0)?0:this.width/this.oldWidth;var e=(this.oldHeight===0)?0:this.height/this.oldHeight;var b="";for(var c=0;c<d.length;c++){var a=(parseFloat(d[c])-this.oldX)*g+this.x;c++;var f=(parseFloat(d[c])-this.oldY)*e+this.y;b+=a+" "+f+" "}this.element.setAttributeNS(null,"points",b)}else{}}else{}break;case"Path":var g=(this.oldWidth===0)?0:this.width/this.oldWidth;var e=(this.oldHeight===0)?0:this.height/this.oldHeight;this.editPathHandler.init(this.x,this.y,this.oldX,this.oldY,g,e);this.editPathParser.parsePath(this.element);this.element.setAttributeNS(null,"d",this.editPathHandler.d);break}this.oldX=this.x;this.oldY=this.y;this.oldWidth=this.width;this.oldHeight=this.height}},isPointIncluded:function(e,c){if(!e||!c||!this.isVisible()){return false}switch(this.type){case"Rect":return(e>=this.x&&e<=this.x+this.width&&c>=this.y&&c<=this.y+this.height);break;case"Circle":return ORYX.Core.Math.isPointInEllipse(e,c,this.x+this.width/2,this.y+this.height/2,this.radiusX,this.radiusX);break;case"Ellipse":return ORYX.Core.Math.isPointInEllipse(e,c,this.x+this.radiusX,this.y+this.radiusY,this.radiusX,this.radiusY);break;case"Line":return ORYX.Core.Math.isPointInLine(e,c,this.x,this.y,this.x+this.width,this.y+this.height);break;case"Polyline":var b=this.element.getAttributeNS(null,"points");if(b){b=b.replace(/,/g," ").split(" ").without("");b=b.collect(function(f){return parseFloat(f)});return ORYX.Core.Math.isPointInPolygone(e,c,b)}else{return false}break;case"Path":var d=new PathParser();var a=new ORYX.Core.SVG.PointsPathHandler();d.setHandler(a);d.parsePath(this.element);return ORYX.Core.Math.isPointInPolygone(e,c,a.points);break;default:return false}},isVisible:function(c){if(!c){c=this.element}var b=false;try{b=!!c.ownerSVGElement}catch(g){}if(b){if(ORYX.Editor.checkClassType(c,SVGGElement)){if(c.className&&c.className.baseVal=="me"){return true}}var f=c.getAttributeNS(null,"fill");var d=c.getAttributeNS(null,"stroke");if(f&&f=="none"&&d&&d=="none"){return false}var a=c.getAttributeNS(null,"display");if(!a){return this.isVisible(c.parentNode)}else{if(a=="none"){return false}else{return true}}}return true},toString:function(){return(this.element)?"SVGShape "+this.element.id:"SVGShape "+this.element}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.SVG){ORYX.Core.SVG={}}ORYX.Core.SVG.Label=Clazz.extend({_characterSets:["%W","@","m","wDGMOQÖ#+=<>~^","ABCHKNRSUVXZÜÄ&","bdghnopquxöüETY1234567890ß_§${}*´`µ€","aeksvyzäFLP?°²³","c-",'rtJ"/()[]:;!|\\',"fjI., ","'","il"],_characterSetValues:[15,14,13,11,10,9,8,7,6,5,4,3],construct:function(m){arguments.callee.$.construct.apply(this,arguments);if(!m.textElement){throw"Label: No parameter textElement."}else{if(!ORYX.Editor.checkClassType(m.textElement,SVGTextElement)){throw"Label: Parameter textElement is not an SVGTextElement."}}this.invisibleRenderPoint=-5000;this.node=m.textElement;this.node.setAttributeNS(null,"stroke-width","0pt");this.node.setAttributeNS(null,"letter-spacing","-0.01px");this.shapeId=m.shapeId;this.id;this.fitToElemId;this.edgePosition;this.x;this.y;this.oldX;this.oldY;this.isVisible=true;this._text;this._verticalAlign;this._horizontalAlign;this._rotate;this._rotationPoint;this.anchorLeft;this.anchorRight;this.anchorTop;this.anchorBottom;this._isChanged=true;var k=this.node.getAttributeNS(null,"id");if(k){this.id=k}this.fitToElemId=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"fittoelem");if(this.fitToElemId){this.fitToElemId=this.shapeId+this.fitToElemId}var f=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"align");if(f){f=f.replace(/,/g," ");f=f.split(" ");f=f.without("");f.each((function(e){switch(e){case"top":case"middle":case"bottom":if(!this._verticalAlign){this._verticalAlign=e}break;case"left":case"center":case"right":if(!this._horizontalAlign){this._horizontalAlign=e}break}}).bind(this))}this.edgePosition=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"edgePosition");if(this.edgePosition){this.edgePosition=this.edgePosition.toLowerCase()}this.offsetTop=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"offsetTop")||ORYX.CONFIG.OFFSET_EDGE_LABEL_TOP;if(this.offsetTop){this.offsetTop=parseInt(this.offsetTop)}this.offsetBottom=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"offsetBottom")||ORYX.CONFIG.OFFSET_EDGE_LABEL_BOTTOM;if(this.offsetBottom){this.offsetBottom=parseInt(this.offsetBottom)}var l=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"rotate");if(l){try{this._rotate=parseFloat(l)}catch(g){this._rotate=0}}else{this._rotate=0}var b=this.node.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"anchors");if(b){b=b.replace("/,/g"," ");var a=b.split(" ").without("");for(var d=0;d<a.length;d++){switch(a[d].toLowerCase()){case"left":this.anchorLeft=true;break;case"right":this.anchorRight=true;break;case"top":this.anchorTop=true;break;case"bottom":this.anchorBottom=true;break}}}if(!this._verticalAlign){this._verticalAlign="bottom"}if(!this._horizontalAlign){this._horizontalAlign="left"}var c=this.node.getAttributeNS(null,"x");if(c){this.x=parseFloat(c);this.oldX=this.x}else{}var h=this.node.getAttributeNS(null,"y");if(h){this.y=parseFloat(h);this.oldY=this.y}else{}this.text(this.node.textContent)},changed:function(){this._isChanged=true},update:function(){if(this._isChanged||this.x!==this.oldX||this.y!==this.oldY){if(this.isVisible){this._isChanged=false;this.node.setAttributeNS(null,"x",this.x);this.node.setAttributeNS(null,"y",this.y);switch(this._horizontalAlign){case"left":this.node.setAttributeNS(null,"text-anchor","start");break;case"center":this.node.setAttributeNS(null,"text-anchor","middle");break;case"right":this.node.setAttributeNS(null,"text-anchor","end");break}this.oldX=this.x;this.oldY=this.y;if(this._rotate!==undefined){if(this._rotationPoint){this.node.setAttributeNS(null,"transform","rotate("+this._rotate+" "+this._rotationPoint.x+" "+this._rotationPoint.y+")")}else{this.node.setAttributeNS(null,"transform","rotate("+this._rotate+" "+this.x+" "+this.y+")")}}var a=this._text.split("\n");while(a.last()==""){a.pop()}this.node.textContent="";if(this.node.ownerDocument){a.each((function(c,b){var d=this.node.ownerDocument.createElementNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan");d.textContent=c;d.setAttributeNS(null,"x",this.invisibleRenderPoint);d.setAttributeNS(null,"y",this.invisibleRenderPoint);if(d.textContent===""){d.textContent=" "}this.node.appendChild(d)}).bind(this));if(this.isVisible){this.node.setAttributeNS(null,"visibility","hidden")}if(this.fitToElemId){window.setTimeout(this._checkFittingToReferencedElem.bind(this),0)}else{window.setTimeout(this._positionText.bind(this),0)}}}else{this.node.textContent=""}}},_checkFittingToReferencedElem:function(){try{var b=$A(this.node.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan"));var d=[];var l=this.node.ownerDocument.getElementById(this.fitToElemId);if(l){var k=l.getBBox();var s=this.getFontSize();for(var f=0;f<b.length;f++){var p=b[f];var t=this._getRenderedTextLength(p,undefined,undefined,s);var h=(this._rotate!=0&&this._rotate%180!=0&&this._rotate%90==0?k.height:k.width);if(t>h){var q=0;var n=0;var o=this.getTrimmedTextLength(p.textContent);for(var g=0;g<o;g++){var r=this._getRenderedTextLength(p,q,g-q,s);if(r>h-3){var c=this.node.ownerDocument.createElementNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan");if(n<=q){n=(g==0)?g:g-1;c.textContent=p.textContent.slice(q,n)}else{c.textContent=p.textContent.slice(q,++n)}c.setAttributeNS(null,"x",this.invisibleRenderPoint);c.setAttributeNS(null,"y",this.invisibleRenderPoint);d.push(c);q=n}else{var a=p.textContent.charAt(g);if(a==" "||a=="-"||a=="."||a==","||a==";"||a==":"){n=g}}}p.textContent=p.textContent.slice(q)}d.push(p)}while(this.node.hasChildNodes()){this.node.removeChild(this.node.childNodes[0])}while(d.length>0){this.node.appendChild(d.shift())}}}catch(m){}window.setTimeout(this._positionText.bind(this),0)},_positionText:function(){try{var a=this.node.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan");var c=this.getFontSize(this.node);var b=[];$A(a).each((function(g,f){if(g.textContent.trim()===""){b.push(g)}else{var e=0;switch(this._verticalAlign){case"bottom":e=-(a.length-f-1)*(c);break;case"middle":e=-(a.length/2-f-1)*(c);e-=ORYX.CONFIG.LABEL_LINE_DISTANCE/2;break;case"top":e=f*(c);e+=c;break}g.setAttributeNS(null,"dy",e);g.setAttributeNS(null,"x",this.x);g.setAttributeNS(null,"y",this.y)}}).bind(this));b.each(function(e){this.node.removeChild(e)}.bind(this))}catch(d){this._isChanged=true}if(this.isVisible){this.node.setAttributeNS(null,"visibility","inherit")}},_getRenderedTextLength:function(c,d,b,a){if(/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent)&&new Number(RegExp.$1)>=3){if(d===undefined){return c.getComputedTextLength()}else{return c.getSubStringLength(d,b)}}else{if(d===undefined){return this._estimateTextWidth(c.textContent,a)}else{return this._estimateTextWidth(c.textContent.substr(d,b).trim(),a)}}},_estimateTextWidth:function(d,c){var b=0;for(var a=0;a<d.length;a++){b+=this._estimateCharacterWidth(d.charAt(a))}return b*(c/14)},_estimateCharacterWidth:function(b){for(var a=0;a<this._characterSets.length;a++){if(this._characterSets[a].indexOf(b)>=0){return this._characterSetValues[a]}}return 9},getReferencedElementWidth:function(){var a=this.node.ownerDocument.getElementById(this.fitToElemId);if(a){var b=a.getBBox();if(b){return b.width}else{return undefined}}else{return undefined}},text:function(){switch(arguments.length){case 0:return this._text;break;case 1:var a=this._text;if(arguments[0]){this._text=arguments[0].toString()}else{this._text=""}if(a!==this._text){this._isChanged=true}break;default:break}},verticalAlign:function(){switch(arguments.length){case 0:return this._verticalAlign;case 1:if(["top","middle","bottom"].member(arguments[0])){var a=this._verticalAlign;this._verticalAlign=arguments[0];if(this._verticalAlign!==a){this._isChanged=true}}break;default:break}},horizontalAlign:function(){switch(arguments.length){case 0:return this._horizontalAlign;case 1:if(["left","center","right"].member(arguments[0])){var a=this._horizontalAlign;this._horizontalAlign=arguments[0];if(this._horizontalAlign!==a){this._isChanged=true}}break;default:break}},rotate:function(){switch(arguments.length){case 0:return this._rotate;case 1:if(this._rotate!=arguments[0]){this._rotate=arguments[0];this._rotationPoint=undefined;this._isChanged=true}case 2:if(this._rotate!=arguments[0]||!this._rotationPoint||this._rotationPoint.x!=arguments[1].x||this._rotationPoint.y!=arguments[1].y){this._rotate=arguments[0];this._rotationPoint=arguments[1];this._isChanged=true}}},hide:function(){if(this.isVisible){this.isVisible=false;this._isChanged=true}},show:function(){if(!this.isVisible){this.isVisible=true;this._isChanged=true}},getInheritedFontSize:function(b){if(!b||!b.getAttributeNS){return}var a=b.getAttributeNS(null,"font-size");if(a){return parseFloat(a)}else{if(!ORYX.Editor.checkClassType(b,SVGSVGElement)){return this.getInheritedFontSize(b.parentNode)}}},getFontSize:function(b){var a=this.node.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan");var c=this.getInheritedFontSize(this.node);if(!c){if(a[0]&&/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent)&&new Number(RegExp.$1)>=3){c=a[0].getExtentOfChar(0).height}else{c=ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT}if(c<=0){c=ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT}}if(c){this.node.setAttribute("oryx:fontSize",c)}return c},getTrimmedTextLength:function(b){b=b.strip().gsub("  "," ");var a;do{a=b.length;b=b.gsub("  "," ")}while(a>b.length);return b.length},getOffsetBottom:function(){return this.offsetBottom},getOffsetTop:function(){return this.offsetTop},toString:function(){return"Label "+this.id}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.Math){ORYX.Core.Math={}}ORYX.Core.Math.midPoint=function(b,a){return{x:(b.x+a.x)/2,y:(b.y+a.y)/2}};ORYX.Core.Math.isPointInLine=function(h,f,g,e,b,a,d){d=d?Math.abs(d):1;if(Math.abs(g-b)<=d&&Math.abs(h-g)<=d&&f-Math.max(e,a)<=d&&Math.min(e,a)-f<=d){return true}if(Math.abs(e-a)<=d&&Math.abs(f-e)<=d&&h-Math.max(g,b)<=d&&Math.min(g,b)-h<=d){return true}if(h>Math.max(g,b)||h<Math.min(g,b)){return false}if(f>Math.max(e,a)||f<Math.min(e,a)){return false}var c=(e-a)/(g-b);return Math.abs(f-((c*h)+e-c*g))<d};ORYX.Core.Math.isPointInEllipse=function(h,f,b,g,e,d){if(b===undefined||g===undefined||e===undefined||d===undefined){throw"ORYX.Core.Math.isPointInEllipse needs a ellipse with these properties: x, y, radiusX, radiusY"}var c=(h-b)/e;var a=(f-g)/d;return c*c+a*a<1};ORYX.Core.Math.isPointInPolygone=function(a,n,e){if(arguments.length<3){throw"ORYX.Core.Math.isPointInPolygone needs two arguments"}var g=e.length-1;if(e[0]!==e[g-1]||e[1]!==e[g]){e.push(e[0]);e.push(e[1])}var h=0;var c,m,b,l,k;for(var f=0;f<e.length-3;){c=e[f];m=e[++f];b=e[++f];l=e[f+1];k=(n-m)*(b-c)-(a-c)*(l-m);if((m>=n)!=(l>=n)){h+=l-m>=0?k>=0:k<=0}if(!k&&Math.min(c,b)<=a&&a<=Math.max(c,b)&&Math.min(m,l)<=n&&n<=Math.max(m,l)){return true}}return(h%2)?true:false};ORYX.Core.Math.distancePointLinie=function(e,d,a,b){var c=ORYX.Core.Math.getPointOfIntersectionPointLine(e,d,a,b);if(!c){return null}return ORYX.Core.Math.getDistancePointToPoint(a,c)};ORYX.Core.Math.getDistancePointToPoint=function(b,a){return Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2))};ORYX.Core.Math.getPointOfIntersectionPointLine=function(f,c,a,e){var d=Math.pow(c.x-f.x,2)+Math.pow(c.y-f.y,2);if(d==0){return undefined}var b=((a.x-f.x)*(c.x-f.x)+(a.y-f.y)*(c.y-f.y))/d;if(e){if(!(0<=b&&b<=1)){return undefined}}pointOfIntersection=new Object();pointOfIntersection.x=f.x+b*(c.x-f.x);pointOfIntersection.y=f.y+b*(c.y-f.y);return pointOfIntersection};if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={}}ORYX.Core.StencilSet.Stencil={construct:function(d,e,a,l,k,h){arguments.callee.$.construct.apply(this,arguments);if(!d){throw"Stencilset seems corrupt."}if(!e){throw"Stencil does not provide namespace."}if(!a){throw"Stencil does not provide SVG source."}if(!l){throw"Fatal internal error loading stencilset."}this._source=a;this._jsonStencil=d;this._stencilSet=l;this._namespace=e;this._propertyPackages=k;if(h&&!this._jsonStencil.position){this._jsonStencil.position=h}this._view;this._properties=new Hash();if(!this._jsonStencil.type||!(this._jsonStencil.type==="edge"||this._jsonStencil.type==="node")){throw"ORYX.Core.StencilSet.Stencil(construct): Type is not defined."}if(!this._jsonStencil.id||this._jsonStencil.id===""){throw"ORYX.Core.StencilSet.Stencil(construct): Id is not defined."}if(!this._jsonStencil.title||this._jsonStencil.title===""){throw"ORYX.Core.StencilSet.Stencil(construct): Title is not defined."}if(!this._jsonStencil.description){this._jsonStencil.description=""}if(!this._jsonStencil.groups){this._jsonStencil.groups=[]}if(!this._jsonStencil.roles){this._jsonStencil.roles=[]}this._jsonStencil.roles.push(this._jsonStencil.id);this._jsonStencil.roles.each((function(n,m){this._jsonStencil.roles[m]=e+n}).bind(this));this._jsonStencil.roles=this._jsonStencil.roles.uniq();this._jsonStencil.id=e+this._jsonStencil.id;this.postProcessProperties();if(!this._jsonStencil.serialize){this._jsonStencil.serialize={}}if(!this._jsonStencil.deserialize){this._jsonStencil.deserialize={}}if(!this._jsonStencil.layout){this._jsonStencil.layout=[]}var c=a+"view/"+d.view;if(this._jsonStencil.view.trim().match(/</)){var b=new DOMParser();var f=b.parseFromString(this._jsonStencil.view,"text/xml");if(ORYX.Editor.checkClassType(f.documentElement,SVGSVGElement)){this._view=f.documentElement;var g=this._view.getElementsByTagNameNS("http://www.w3.org/2000/svg","image");$A(g).each((function(n){var m=n.getAttributeNodeNS("http://www.w3.org/1999/xlink","href");if(m&&m.value.indexOf("://")==-1){m.textContent=this._source+"view/"+m.value}}).bind(this))}else{throw"ORYX.Core.StencilSet.Stencil(_loadSVGOnSuccess): The response is not a SVG document."}}else{new Ajax.Request(c,{asynchronous:false,method:"get",onSuccess:this._loadSVGOnSuccess.bind(this),onFailure:this._loadSVGOnFailure.bind(this)})}},postProcessProperties:function(){if(this._jsonStencil.icon&&this._jsonStencil.icon.indexOf("://")===-1){this._jsonStencil.icon=this._source+"icons/"+this._jsonStencil.icon}else{this._jsonStencil.icon=""}if(this._jsonStencil.propertyPackages&&this._jsonStencil.propertyPackages instanceof Array){this._jsonStencil.propertyPackages.each((function(b){var a=this._propertyPackages[b];if(a){a.each((function(d){var c=new ORYX.Core.StencilSet.Property(d,this._namespace,this);this._properties[c.prefix()+"-"+c.id()]=c}).bind(this))}}).bind(this))}if(this._jsonStencil.properties&&this._jsonStencil.properties instanceof Array){this._jsonStencil.properties.each((function(b){var a=new ORYX.Core.StencilSet.Property(b,this._namespace,this);this._properties[a.prefix()+"-"+a.id()]=a}).bind(this))}},equals:function(a){return(this.id()===a.id())},stencilSet:function(){return this._stencilSet},type:function(){return this._jsonStencil.type},namespace:function(){return this._namespace},id:function(){return this._jsonStencil.id},idWithoutNs:function(){return this.id().replace(this.namespace(),"")},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonStencil,"title")},description:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonStencil,"description")},groups:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonStencil,"groups")},position:function(){return(isNaN(this._jsonStencil.position)?0:this._jsonStencil.position)},view:function(){return this._view.cloneNode(true)||this._view},icon:function(){return this._jsonStencil.icon},fixedAspectRatio:function(){return this._jsonStencil.fixedAspectRatio===true},hasMultipleRepositoryEntries:function(){return(this.getRepositoryEntries().length>0)},getRepositoryEntries:function(){return(this._jsonStencil.repositoryEntries)?$A(this._jsonStencil.repositoryEntries):$A([])},properties:function(){return this._properties.values()},property:function(a){return this._properties[a]},roles:function(){return this._jsonStencil.roles},defaultAlign:function(){if(!this._jsonStencil.defaultAlign){return"east"}return this._jsonStencil.defaultAlign},serialize:function(a,b){return this._jsonStencil.serialize},deserialize:function(a,b){return this._jsonStencil.deserialize},layout:function(a){return this._jsonStencil.layout},addProperty:function(c,b){if(c&&b){var a=new ORYX.Core.StencilSet.Property(c,b,this);this._properties[a.prefix()+"-"+a.id()]=a}},removeProperty:function(b){if(b){var a=this._properties.values().find(function(c){return(b==c.id())});if(a){delete this._properties[a.prefix()+"-"+a.id()]}}},_loadSVGOnSuccess:function(a){var b=null;b=a.responseXML;if(ORYX.Editor.checkClassType(b.documentElement,SVGSVGElement)){this._view=b.documentElement;var c=this._view.getElementsByTagNameNS("http://www.w3.org/2000/svg","image");$A(c).each((function(e){var d=e.getAttributeNodeNS("http://www.w3.org/1999/xlink","href");if(d&&d.value.indexOf("://")==-1){d.textContent=this._source+"view/"+d.value}}).bind(this))}else{throw"ORYX.Core.StencilSet.Stencil(_loadSVGOnSuccess): The response is not a SVG document."}},_loadSVGOnFailure:function(a){throw"ORYX.Core.StencilSet.Stencil(_loadSVGOnFailure): Loading SVG document failed."},toString:function(){return"Stencil "+this.title()+" ("+this.id()+")"}};ORYX.Core.StencilSet.Stencil=Clazz.extend(ORYX.Core.StencilSet.Stencil);function _evenMoreEvilHack(c,e){if(window.ActiveXObject){var b=new ActiveXObject("MSXML.DomDocument");b.loadXML(c);return b}else{if(window.XMLHttpRequest){var a=new XMLHttpRequest;a.open("GET","data:"+(e||"application/xml")+";charset=utf-8,"+encodeURIComponent(c),false);if(a.overrideMimeType){a.overrideMimeType(e)}a.send(null);return a.responseXML}}}function _evilSafariHack(d){var b=d;var a="data:text/xml;charset=utf-8,"+encodeURIComponent(b);var e=null;var c=new XMLHttpRequest();c.open("GET",a);c.onload=function(){e=c.responseXML};c.send(null);return e}if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={}}ORYX.Core.StencilSet.Property=Clazz.extend({construct:function(c,a,b){arguments.callee.$.construct.apply(this,arguments);this._jsonProp=c||ORYX.Log.error("Parameter jsonProp is not defined.");this._namespace=a||ORYX.Log.error("Parameter namespace is not defined.");this._stencil=b||ORYX.Log.error("Parameter stencil is not defined.");this._items=new Hash();this._complexItems=new Hash();c.id=c.id||ORYX.Log.error("ORYX.Core.StencilSet.Property(construct): Id is not defined.");c.id=c.id.toLowerCase();if(!c.type){ORYX.Log.info("Type is not defined for stencil '%0', id '%1'. Falling back to 'String'.",b,c.id);c.type="string"}else{c.type=c.type.toLowerCase()}c.prefix=c.prefix||"oryx";c.title=c.title||"";c.value=c.value||"";c.description=c.description||"";c.readonly=c.readonly||false;if(c.optional!=false){c.optional=true}if(this._jsonProp.refToView){if(!(this._jsonProp.refToView instanceof Array)){this._jsonProp.refToView=[this._jsonProp.refToView]}}else{this._jsonProp.refToView=[]}if(c.min===undefined||c.min===null){c.min=Number.MIN_VALUE}if(c.max===undefined||c.max===null){c.max=Number.MAX_VALUE}if(!c.fillOpacity){c.fillOpacity=false}if(!c.strokeOpacity){c.strokeOpacity=false}if(c.length===undefined||c.length===null){c.length=Number.MAX_VALUE}if(!c.wrapLines){c.wrapLines=false}if(!c.dateFormat){c.dataFormat="m/d/y"}if(!c.fill){c.fill=false}if(!c.stroke){c.stroke=false}if(!c.inverseBoolean){c.inverseBoolean=false}if(!c.directlyEditable&&c.directlyEditable!=false){c.directlyEditable=true}if(c.visible!==false){c.visible=true}if(!c.popular){c.popular=false}if(c.type===ORYX.CONFIG.TYPE_CHOICE){if(c.restUrl&&c.restMethod&&c.restParams){var d=this;c.restParams.userId=ORYX.CONFIG.USER_ID;new Ajax.Request(c.restUrl,{method:c.restMethod,parameters:c.restParams,onSuccess:function(e){var g=JSON.parse(e.responseText);if(g instanceof Array){for(var f=0;f<g.length;f++){d._items[(g[f]).value]=new ORYX.Core.StencilSet.PropertyItem(g[f],a,d)}}},onFailure:function(f){var e="FATAL: REST query to "+c.restUrl+" failed.";if(console){console.log(e);console.log(f)}alert(e)}})}if(c.items&&c.items instanceof Array){c.items.each((function(e){this._items[e.value]=new ORYX.Core.StencilSet.PropertyItem(e,a,this)}).bind(this))}else{if(!c.restUrl||!c.restMethod||!c.restParams){throw"ORYX.Core.StencilSet.Property(construct): No property items defined."}}}else{if(c.type===ORYX.CONFIG.TYPE_COMPLEX){if(c.complexItems&&c.complexItems instanceof Array){c.complexItems.each((function(e){this._complexItems[e.id]=new ORYX.Core.StencilSet.ComplexPropertyItem(e,a,this)}).bind(this))}else{throw"ORYX.Core.StencilSet.Property(construct): No complex property items defined."}}}},equals:function(a){return(this._namespace===a.namespace()&&this.id()===a.id())?true:false},namespace:function(){return this._namespace},stencil:function(){return this._stencil},id:function(){return this._jsonProp.id},prefix:function(){return this._jsonProp.prefix},type:function(){return this._jsonProp.type},inverseBoolean:function(){return this._jsonProp.inverseBoolean},popular:function(){return this._jsonProp.popular},setPopular:function(){this._jsonProp.popular=true},directlyEditable:function(){return this._jsonProp.directlyEditable},visible:function(){return this._jsonProp.visible},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonProp,"title")},value:function(){return this._jsonProp.value},readonly:function(){return this._jsonProp.readonly},optional:function(){return this._jsonProp.optional},description:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonProp,"description")},refToView:function(){return this._jsonProp.refToView},min:function(){return this._jsonProp.min},max:function(){return this._jsonProp.max},fillOpacity:function(){return this._jsonProp.fillOpacity},strokeOpacity:function(){return this._jsonProp.strokeOpacity},length:function(){return this._jsonProp.length?this._jsonProp.length:Number.MAX_VALUE},wrapLines:function(){return this._jsonProp.wrapLines},dateFormat:function(){return this._jsonProp.dateFormat},fill:function(){return this._jsonProp.fill},stroke:function(){return this._jsonProp.stroke},items:function(){return this._items.values()},item:function(a){return this._items[a]},toString:function(){return"Property "+this.title()+" ("+this.id()+")"},complexItems:function(){return this._complexItems.values()},complexItem:function(a){return this._complexItems[a]},complexAttributeToView:function(){return this._jsonProp.complexAttributeToView||""}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={}}ORYX.Core.StencilSet.PropertyItem=Clazz.extend({construct:function(a,b,c){arguments.callee.$.construct.apply(this,arguments);if(!a){throw"ORYX.Core.StencilSet.PropertyItem(construct): Parameter jsonItem is not defined."}if(!b){throw"ORYX.Core.StencilSet.PropertyItem(construct): Parameter namespace is not defined."}if(!c){throw"ORYX.Core.StencilSet.PropertyItem(construct): Parameter property is not defined."}this._jsonItem=a;this._namespace=b;this._property=c;if(!a.value){throw"ORYX.Core.StencilSet.PropertyItem(construct): Value is not defined."}if(this._jsonItem.refToView){if(!(this._jsonItem.refToView instanceof Array)){this._jsonItem.refToView=[this._jsonItem.refToView]}}else{this._jsonItem.refToView=[]}},equals:function(a){return(this.property().equals(a.property())&&this.value()===a.value())},namespace:function(){return this._namespace},property:function(){return this._property},value:function(){return this._jsonItem.value},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonItem,"title")},refToView:function(){return this._jsonItem.refToView},icon:function(){return(this._jsonItem.icon)?this.property().stencil()._source+"icons/"+this._jsonItem.icon:""},toString:function(){return"PropertyItem "+this.property()+" ("+this.value()+")"}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={}}ORYX.Core.StencilSet.ComplexPropertyItem=Clazz.extend({construct:function(a,b,c){arguments.callee.$.construct.apply(this,arguments);if(!a){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Parameter jsonItem is not defined."}if(!b){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Parameter namespace is not defined."}if(!c){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Parameter property is not defined."}this._jsonItem=a;this._namespace=b;this._property=c;this._items=new Hash();if(!a.name){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Name is not defined."}if(!a.type){throw"ORYX.Core.StencilSet.ComplexPropertyItem(construct): Type is not defined."}else{a.type=a.type.toLowerCase()}if(a.type===ORYX.CONFIG.TYPE_CHOICE){if(a.items&&a.items instanceof Array){a.items.each((function(d){this._items[d.value]=new ORYX.Core.StencilSet.PropertyItem(d,b,this)}).bind(this))}else{throw"ORYX.Core.StencilSet.Property(construct): No property items defined."}}},equals:function(a){return(this.property().equals(a.property())&&this.name()===a.name())},namespace:function(){return this._namespace},property:function(){return this._property},name:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonItem,"name")},id:function(){return this._jsonItem.id},type:function(){return this._jsonItem.type},optional:function(){return this._jsonItem.optional},width:function(){return this._jsonItem.width},value:function(){return this._jsonItem.value},items:function(){return this._items.values()},disable:function(){return this._jsonItem.disable}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={}}ORYX.Core.StencilSet.Rules={construct:function(){arguments.callee.$.construct.apply(this,arguments);this._stencilSets=[];this._stencils=[];this._cachedConnectSET=new Hash();this._cachedConnectSE=new Hash();this._cachedConnectTE=new Hash();this._cachedCardSE=new Hash();this._cachedCardTE=new Hash();this._cachedContainPC=new Hash();this._cachedMorphRS=new Hash();this._connectionRules=new Hash();this._cardinalityRules=new Hash();this._containmentRules=new Hash();this._morphingRules=new Hash();this._layoutRules=new Hash()},initializeRules:function(l){var k=this._stencilSets.find(function(o){return(o.namespace()==l.namespace())});if(k){var f=this._stencilSets.clone();f=f.without(k);f.push(l);this._stencilSets=[];this._stencils=[];this._cachedConnectSET=new Hash();this._cachedConnectSE=new Hash();this._cachedConnectTE=new Hash();this._cachedCardSE=new Hash();this._cachedCardTE=new Hash();this._cachedContainPC=new Hash();this._cachedMorphRS=new Hash();this._connectionRules=new Hash();this._cardinalityRules=new Hash();this._containmentRules=new Hash();this._morphingRules=new Hash();this._layoutRules=new Hash();f.each(function(o){this.initializeRules(o)}.bind(this));return}else{this._stencilSets.push(l);var m=new Hash(l.jsonRules());var e=l.namespace();var b=l.stencils();l.extensions().values().each(function(o){if(o.rules){if(o.rules.connectionRules){m.connectionRules=m.connectionRules.concat(o.rules.connectionRules)}if(o.rules.cardinalityRules){m.cardinalityRules=m.cardinalityRules.concat(o.rules.cardinalityRules)}if(o.rules.containmentRules){m.containmentRules=m.containmentRules.concat(o.rules.containmentRules)}if(o.rules.morphingRules){m.morphingRules=m.morphingRules.concat(o.rules.morphingRules)}}if(o.stencils){b=b.concat(o.stencils)}});this._stencils=this._stencils.concat(l.stencils());var g=this._connectionRules;if(m.connectionRules){m.connectionRules.each((function(o){if(this._isRoleOfOtherNamespace(o.role)){if(!g[o.role]){g[o.role]=new Hash()}}else{if(!g[e+o.role]){g[e+o.role]=new Hash()}}o.connects.each((function(p){var s=[];if(p.to){if(!(p.to instanceof Array)){p.to=[p.to]}p.to.each((function(t){if(this._isRoleOfOtherNamespace(t)){s.push(t)}else{s.push(e+t)}}).bind(this))}var r,q;if(this._isRoleOfOtherNamespace(o.role)){r=o.role}else{r=e+o.role}if(this._isRoleOfOtherNamespace(p.from)){q=p.from}else{q=e+p.from}if(!g[r][q]){g[r][q]=s}else{g[r][q]=g[r][q].concat(s)}}).bind(this))}).bind(this))}var c=this._cardinalityRules;if(m.cardinalityRules){m.cardinalityRules.each((function(q){var o;if(this._isRoleOfOtherNamespace(q.role)){o=q.role}else{o=e+q.role}if(!c[o]){c[o]={};for(i in q){c[o][i]=q[i]}}var r=new Hash();if(q.outgoingEdges){q.outgoingEdges.each((function(s){if(this._isRoleOfOtherNamespace(s.role)){r[s.role]=s}else{r[e+s.role]=s}}).bind(this))}c[o].outgoingEdges=r;var p=new Hash();if(q.incomingEdges){q.incomingEdges.each((function(s){if(this._isRoleOfOtherNamespace(s.role)){p[s.role]=s}else{p[e+s.role]=s}}).bind(this))}c[o].incomingEdges=p}).bind(this))}var a=this._containmentRules;if(m.containmentRules){m.containmentRules.each((function(p){var o;if(this._isRoleOfOtherNamespace(p.role)){o=p.role}else{o=e+p.role}if(!a[o]){a[o]=[]}p.contains.each((function(q){if(this._isRoleOfOtherNamespace(q)){a[o].push(q)}else{a[o].push(e+q)}}).bind(this))}).bind(this))}var d=this._morphingRules;if(m.morphingRules){m.morphingRules.each((function(p){var o;if(this._isRoleOfOtherNamespace(p.role)){o=p.role}else{o=e+p.role}if(!d[o]){d[o]=[]}if(!p.preserveBounds){p.preserveBounds=false}p.baseMorphs.each((function(q){d[o].push(this._getStencilById(e+q))}).bind(this))}).bind(this))}var h=this._layoutRules;if(m.layoutRules){var n=function(p){return{edgeRole:p.edgeRole||undefined,t:p.t||1,r:p.r||1,b:p.b||1,l:p.l||1}};m.layoutRules.each(function(p){var o;if(this._isRoleOfOtherNamespace(p.role)){o=p.role}else{o=e+p.role}if(!h[o]){h[o]={}}if(p["in"]){h[o]["in"]=n(p["in"])}if(p.ins){h[o]["ins"]=(p.ins||[]).map(function(q){return n(q)})}if(p.out){h[o]["out"]=n(p.out)}if(p.outs){h[o]["outs"]=(p.outs||[]).map(function(q){return n(q)})}}.bind(this))}}},_getStencilById:function(a){return this._stencils.find(function(b){return b.id()==a})},_cacheConnect:function(a){result=this._canConnect(a);if(a.sourceStencil&&a.targetStencil){var c=this._cachedConnectSET[a.sourceStencil.id()];if(!c){c=new Hash();this._cachedConnectSET[a.sourceStencil.id()]=c}var b=c[a.edgeStencil.id()];if(!b){b=new Hash();c[a.edgeStencil.id()]=b}b[a.targetStencil.id()]=result}else{if(a.sourceStencil){var c=this._cachedConnectSE[a.sourceStencil.id()];if(!c){c=new Hash();this._cachedConnectSE[a.sourceStencil.id()]=c}c[a.edgeStencil.id()]=result}else{var d=this._cachedConnectTE[a.targetStencil.id()];if(!d){d=new Hash();this._cachedConnectTE[a.targetStencil.id()]=d}d[a.edgeStencil.id()]=result}}return result},_cacheCard:function(b){if(b.sourceStencil){var c=this._cachedCardSE[b.sourceStencil.id()];if(!c){c=new Hash();this._cachedCardSE[b.sourceStencil.id()]=c}var a=this._getMaximumNumberOfOutgoingEdge(b);if(a==undefined){a=-1}c[b.edgeStencil.id()]=a}if(b.targetStencil){var d=this._cachedCardTE[b.targetStencil.id()];if(!d){d=new Hash();this._cachedCardTE[b.targetStencil.id()]=d}var a=this._getMaximumNumberOfIncomingEdge(b);if(a==undefined){a=-1}d[b.edgeStencil.id()]=a}},_cacheContain:function(b){var a=[this._canContain(b),this._getMaximumOccurrence(b.containingStencil,b.containedStencil)];if(a[1]==undefined){a[1]=-1}var c=this._cachedContainPC[b.containingStencil.id()];if(!c){c=new Hash();this._cachedContainPC[b.containingStencil.id()]=c}c[b.containedStencil.id()]=a;return a},_cacheMorph:function(b){var a=this._cachedMorphRS[b];if(!a){a=[];if(this._morphingRules.keys().include(b)){a=this._stencils.select(function(c){return c.roles().include(b)})}this._cachedMorphRS[b]=a}return a},outgoingEdgeStencils:function(a){if(!a.sourceShape&&!a.sourceStencil){return[]}if(a.sourceShape){a.sourceStencil=a.sourceShape.getStencil()}var b=[];this._stencils.each((function(d){if(d.type()==="edge"){var c=Object.clone(a);c.edgeStencil=d;if(this.canConnect(c)){b.push(d)}}}).bind(this));return b},incomingEdgeStencils:function(a){if(!a.targetShape&&!a.targetStencil){return[]}if(a.targetShape){a.targetStencil=a.targetShape.getStencil()}var b=[];this._stencils.each((function(d){if(d.type()==="edge"){var c=Object.clone(a);c.edgeStencil=d;if(this.canConnect(c)){b.push(d)}}}).bind(this));return b},sourceStencils:function(b){if(!b||!b.edgeShape&&!b.edgeStencil){return[]}if(b.targetShape){b.targetStencil=b.targetShape.getStencil()}if(b.edgeShape){b.edgeStencil=b.edgeShape.getStencil()}var a=[];this._stencils.each((function(d){var c=Object.clone(b);c.sourceStencil=d;if(this.canConnect(c)){a.push(d)}}).bind(this));return a},targetStencils:function(a){if(!a||!a.edgeShape&&!a.edgeStencil){return[]}if(a.sourceShape){a.sourceStencil=a.sourceShape.getStencil()}if(a.edgeShape){a.edgeStencil=a.edgeShape.getStencil()}var b=[];this._stencils.each((function(d){var c=Object.clone(a);c.targetStencil=d;if(this.canConnect(c)){b.push(d)}}).bind(this));return b},canConnect:function(c){if(!c||(!c.sourceShape&&!c.sourceStencil&&!c.targetShape&&!c.targetStencil)||!c.edgeShape&&!c.edgeStencil){return false}if(c.sourceShape){c.sourceStencil=c.sourceShape.getStencil()}if(c.targetShape){c.targetStencil=c.targetShape.getStencil()}if(c.edgeShape){c.edgeStencil=c.edgeShape.getStencil()}var b;if(c.sourceStencil&&c.targetStencil){var e=this._cachedConnectSET[c.sourceStencil.id()];if(!e){b=this._cacheConnect(c)}else{var d=e[c.edgeStencil.id()];if(!d){b=this._cacheConnect(c)}else{var f=d[c.targetStencil.id()];if(f==undefined){b=this._cacheConnect(c)}else{b=f}}}}else{if(c.sourceStencil){var e=this._cachedConnectSE[c.sourceStencil.id()];if(!e){b=this._cacheConnect(c)}else{var d=e[c.edgeStencil.id()];if(d==undefined){b=this._cacheConnect(c)}else{b=d}}}else{var f=this._cachedConnectTE[c.targetStencil.id()];if(!f){b=this._cacheConnect(c)}else{var d=f[c.edgeStencil.id()];if(d==undefined){b=this._cacheConnect(c)}else{b=d}}}}if(b){if(c.sourceShape){var e=this._cachedCardSE[c.sourceStencil.id()];if(!e){this._cacheCard(c);e=this._cachedCardSE[c.sourceStencil.id()]}var a=e[c.edgeStencil.id()];if(a==undefined){this._cacheCard(c)}a=e[c.edgeStencil.id()];if(a!=-1){b=c.sourceShape.getOutgoingShapes().all(function(g){if((g.getStencil().id()===c.edgeStencil.id())&&((c.edgeShape)?g!==c.edgeShape:true)){a--;return(a>0)?true:false}else{return true}})}}if(c.targetShape){var f=this._cachedCardTE[c.targetStencil.id()];if(!f){this._cacheCard(c);f=this._cachedCardTE[c.targetStencil.id()]}var a=f[c.edgeStencil.id()];if(a==undefined){this._cacheCard(c)}a=f[c.edgeStencil.id()];if(a!=-1){b=c.targetShape.getIncomingShapes().all(function(g){if((g.getStencil().id()===c.edgeStencil.id())&&((c.edgeShape)?g!==c.edgeShape:true)){a--;return(a>0)?true:false}else{return true}})}}}return b},_canConnect:function(b){if(!b||(!b.sourceShape&&!b.sourceStencil&&!b.targetShape&&!b.targetStencil)||!b.edgeShape&&!b.edgeStencil){return false}if(b.sourceShape){b.sourceStencil=b.sourceShape.getStencil()}if(b.targetShape){b.targetStencil=b.targetShape.getStencil()}if(b.edgeShape){b.edgeStencil=b.edgeShape.getStencil()}var c;var a=this._getConnectionRulesOfEdgeStencil(b.edgeStencil);if(a.keys().length===0){c=false}else{if(b.sourceStencil){c=b.sourceStencil.roles().any(function(e){var d=a[e];if(!d){return false}if(b.targetStencil){return(d.any(function(f){return b.targetStencil.roles().member(f)}))}else{return true}})}else{c=a.values().any(function(d){return b.targetStencil.roles().any(function(e){return d.member(e)})})}}return c},canContain:function(c){if(!c||!c.containingStencil&&!c.containingShape||!c.containedStencil&&!c.containedShape){return false}if(c.containedShape){c.containedStencil=c.containedShape.getStencil()}if(c.containingShape){c.containingStencil=c.containingShape.getStencil()}if(c.containedStencil.type()=="edge"){return false}var b;var d=this._cachedContainPC[c.containingStencil.id()];if(!d){b=this._cacheContain(c)}else{b=d[c.containedStencil.id()];if(!b){b=this._cacheContain(c)}}if(!b[0]){return false}else{if(b[1]==-1){return true}else{if(c.containingShape){var a=b[1];return c.containingShape.getChildShapes(false).all(function(e){if(e.getStencil().id()===c.containedStencil.id()){a--;return(a>0)?true:false}else{return true}})}else{return true}}}},_canContain:function(b){if(!b||!b.containingStencil&&!b.containingShape||!b.containedStencil&&!b.containedShape){return false}if(b.containedShape){b.containedStencil=b.containedShape.getStencil()}if(b.containingShape){b.containingStencil=b.containingShape.getStencil()}var a;a=b.containingStencil.roles().any((function(d){var c=this._containmentRules[d];if(c){return c.any(function(e){return b.containedStencil.roles().member(e)})}else{return false}}).bind(this));return a},morphStencils:function(b){if(!b.stencil&&!b.shape){return[]}if(b.shape){b.stencil=b.shape.getStencil()}var a=[];b.stencil.roles().each(function(c){this._cacheMorph(c).each(function(d){a.push(d)})}.bind(this));return a.uniq()},baseMorphs:function(){var a=[];this._morphingRules.each(function(b){b.value.each(function(c){a.push(c)})});return a},containsMorphingRules:function(){return this._stencilSets.any(function(a){return !!a.jsonRules().morphingRules})},connectMorph:function(e){if(!e||(!e.sourceShape&&!e.sourceStencil&&!e.targetShape&&!e.targetStencil)){return false}if(e.sourceShape){e.sourceStencil=e.sourceShape.getStencil()}if(e.targetShape){e.targetStencil=e.targetShape.getStencil()}var a=this.incomingEdgeStencils(e);var d=this.outgoingEdgeStencils(e);var c=a.select(function(f){return d.member(f)});var b=this.baseMorphs().select(function(f){return c.member(f)});if(b.size()>0){return b[0]}else{if(c.size()>0){return c[0]}}return null},showInShapeMenu:function(a){return this._stencilSets.any(function(b){return b.jsonRules().morphingRules.any(function(c){return a.roles().include(b.namespace()+c.role)&&c.showInShapeMenu!==false})})},preserveBounds:function(a){return this._stencilSets.any(function(b){return b.jsonRules().morphingRules.any(function(c){return a.roles().include(b.namespace()+c.role)&&c.preserveBounds})})},getLayoutingRules:function(b,d){if(!b||!(b instanceof ORYX.Core.Shape)){return}var c={"in":{},out:{}};var a=function(f,e){if(f&&f[e]){["t","r","b","l"].each(function(g){c[e][g]=Math.max(f[e][g],c[e][g]||0)})}if(f&&f[e+"s"] instanceof Array){["t","r","b","l"].each(function(k){var g=f[e+"s"].find(function(l){return !l.edgeRole});var h;if(d instanceof ORYX.Core.Edge){h=f[e+"s"].find(function(l){return this._hasRole(d,l.edgeRole)}.bind(this))}c[e][k]=Math.max(h?h[k]:g[k],c[e][k]||0)}.bind(this))}}.bind(this);b.getStencil().roles().each(function(e){if(this._layoutRules[e]){a(this._layoutRules[e],"in");a(this._layoutRules[e],"out")}}.bind(this));["in","out"].each(function(e){["t","r","b","l"].each(function(f){c[e][f]=c[e][f]!==undefined?c[e][f]:1})});return c},_hasRole:function(b,c){if(!(b instanceof ORYX.Core.Shape)||!c){return}var a=b.getStencil().roles().any(function(d){return d==c});return a||b.getStencil().id()==(b.getStencil().namespace()+c)},_stencilsWithRole:function(a){return this._stencils.findAll(function(b){return(b.roles().member(a))?true:false})},_edgesWithRole:function(a){return this._stencils.findAll(function(b){return(b.roles().member(a)&&b.type()==="edge")?true:false})},_nodesWithRole:function(a){return this._stencils.findAll(function(b){return(b.roles().member(a)&&b.type()==="node")?true:false})},_getMaximumOccurrence:function(b,c){var a;c.roles().each((function(e){var d=this._cardinalityRules[e];if(d&&d.maximumOccurrence){if(a){a=Math.min(a,d.maximumOccurrence)}else{a=d.maximumOccurrence}}}).bind(this));return a},_getMaximumNumberOfOutgoingEdge:function(b){if(!b||!b.sourceStencil||!b.edgeStencil){return false}var a;b.sourceStencil.roles().each((function(d){var c=this._cardinalityRules[d];if(c&&c.outgoingEdges){b.edgeStencil.roles().each(function(e){var f=c.outgoingEdges[e];if(f&&f.maximum){if(a){a=Math.min(a,f.maximum)}else{a=f.maximum}}})}}).bind(this));return a},_getMaximumNumberOfIncomingEdge:function(b){if(!b||!b.targetStencil||!b.edgeStencil){return false}var a;b.targetStencil.roles().each((function(d){var c=this._cardinalityRules[d];if(c&&c.incomingEdges){b.edgeStencil.roles().each(function(e){var f=c.incomingEdges[e];if(f&&f.maximum){if(a){a=Math.min(a,f.maximum)}else{a=f.maximum}}})}}).bind(this));return a},_getConnectionRulesOfEdgeStencil:function(b){var a=new Hash();b.roles().each((function(c){if(this._connectionRules[c]){this._connectionRules[c].each(function(d){if(a[d.key]){a[d.key]=a[d.key].concat(d.value)}else{a[d.key]=d.value}})}}).bind(this));return a},_isRoleOfOtherNamespace:function(a){return(a.indexOf("#")>0)},toString:function(){return"Rules"}};ORYX.Core.StencilSet.Rules=Clazz.extend(ORYX.Core.StencilSet.Rules);if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={}}ORYX.Core.StencilSet.StencilSet=Clazz.extend({construct:function(a){arguments.callee.$.construct.apply(this,arguments);if(!a){throw"ORYX.Core.StencilSet.StencilSet(construct): Parameter 'source' is not defined."}if(a.endsWith("/")){a=a.substr(0,a.length-1)}this._extensions=new Hash();this._source=a;this._baseUrl=a.substring(0,a.lastIndexOf("/")+1);this._jsonObject={};this._stencils=new Hash();this._availableStencils=new Hash();if(ORYX.CONFIG.BACKEND_SWITCH){new Ajax.Request(a,{asynchronous:false,method:"get",onSuccess:this._getJSONURL.bind(this),onFailure:this._cancelInit.bind(this)})}else{new Ajax.Request(a,{asynchronous:false,method:"get",onSuccess:this._init.bind(this),onFailure:this._cancelInit.bind(this)})}if(this.errornous){throw"Loading stencil set "+a+" failed."}},findRootStencilName:function(){var a=this._stencils.values().find(function(b){return b._jsonStencil.mayBeRoot});if(!a){ORYX.Log.warn("Did not find any stencil that may be root. Taking a guess.");a=this._stencils.values()[0]}return a.id()},equals:function(a){return(this.namespace()===a.namespace())},stencils:function(k,l,h){if(k&&l){var a=this._availableStencils.values();var e=[k];var d=[];var m=[];while(e.size()>0){var b=e.pop();d.push(b);var c=a.findAll(function(o){var n={containingStencil:b,containedStencil:o};return l.canContain(n)});for(var g=0;g<c.size();g++){if(!d.member(c[g])){e.push(c[g])}}m=m.concat(c).uniq()}m=m.sortBy(function(n){return a.indexOf(n)});if(h){m=m.sortBy(function(n){return n.groups().first()})}var f=a.findAll(function(n){return n.type()=="edge"});m=m.concat(f);return m}else{if(h){return this._availableStencils.values().sortBy(function(n){return n.groups().first()})}else{return this._availableStencils.values()}}},nodes:function(){return this._availableStencils.values().findAll(function(a){return(a.type()==="node")})},edges:function(){return this._availableStencils.values().findAll(function(a){return(a.type()==="edge")})},stencil:function(a){return this._stencils[a]},title:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonObject,"title")},description:function(){return ORYX.Core.StencilSet.getTranslation(this._jsonObject,"description")},namespace:function(){return this._jsonObject?this._jsonObject.namespace:null},jsonRules:function(){return this._jsonObject?this._jsonObject.rules:null},source:function(){return this._source},extensions:function(){return this._extensions},addExtension:function(a){new Ajax.Request(a,{method:"GET",asynchronous:false,onSuccess:(function(b){this.addExtensionDirectly(b.responseText)}).bind(this),onFailure:(function(b){ORYX.Log.debug("Loading stencil set extension file failed. The request returned an error."+b)}).bind(this),onException:(function(b){ORYX.Log.debug("Loading stencil set extension file failed. The request returned an error."+b)}).bind(this)})},addExtensionDirectly:function(str){try{eval("var jsonExtension = "+str);if(!(jsonExtension["extends"].endsWith("#"))){jsonExtension["extends"]+="#"}if(jsonExtension["extends"]==this.namespace()){this._extensions[jsonExtension.namespace]=jsonExtension;var defaultPosition=this._stencils.keys().size();if(jsonExtension.stencils){$A(jsonExtension.stencils).each(function(stencil){defaultPosition++;var oStencil=new ORYX.Core.StencilSet.Stencil(stencil,this.namespace(),this._baseUrl,this,undefined,defaultPosition);this._stencils[oStencil.id()]=oStencil;this._availableStencils[oStencil.id()]=oStencil}.bind(this))}if(jsonExtension.properties){var stencils=this._stencils.values();stencils.each(function(stencil){var roles=stencil.roles();jsonExtension.properties.each(function(prop){prop.roles.any(function(role){role=jsonExtension["extends"]+role;if(roles.member(role)){prop.properties.each(function(property){stencil.addProperty(property,jsonExtension.namespace)});return true}else{return false}})})}.bind(this))}if(jsonExtension.removeproperties){jsonExtension.removeproperties.each(function(remprop){var stencil=this.stencil(jsonExtension["extends"]+remprop.stencil);if(stencil){remprop.properties.each(function(propId){stencil.removeProperty(propId)})}}.bind(this))}if(jsonExtension.removestencils){$A(jsonExtension.removestencils).each(function(remstencil){delete this._availableStencils[jsonExtension["extends"]+remstencil]}.bind(this))}}}catch(e){ORYX.Log.debug("StencilSet.addExtension: Something went wrong when initialising the stencil set extension. "+e)}},removeExtension:function(a){var b=this._extensions[a];if(b){if(b.stencils){$A(b.stencils).each(function(e){var d=new ORYX.Core.StencilSet.Stencil(e,this.namespace(),this._baseUrl,this);delete this._stencils[d.id()];delete this._availableStencils[d.id()]}.bind(this))}if(b.properties){var c=this._stencils.values();c.each(function(e){var d=e.roles();b.properties.each(function(f){f.roles.any(function(g){g=b["extends"]+g;if(d.member(g)){f.properties.each(function(h){e.removeProperty(h.id)});return true}else{return false}})})}.bind(this))}if(b.removeproperties){b.removeproperties.each(function(f){var e=this.stencil(b["extends"]+f.stencil);if(e){var d=$A(this._jsonObject.stencils).find(function(g){return g.id==e.id()});f.properties.each(function(h){var g=$A(d.properties).find(function(k){return k.id==h});e.addProperty(g,this.namespace())}.bind(this))}}.bind(this))}if(b.removestencils){$A(b.removestencils).each(function(d){var e=b["extends"]+d;this._availableStencils[e]=this._stencils[e]}.bind(this))}}delete this._extensions[a]},__handleStencilset:function(response){try{eval("this._jsonObject ="+response.responseText)}catch(e){throw"Stenciset corrupt: "+e}if(!this._jsonObject){throw"Error evaluating stencilset. It may be corrupt."}with(this._jsonObject){if(!namespace||namespace===""){throw"Namespace definition missing in stencilset."}if(!(stencils instanceof Array)){throw"Stencilset corrupt."}if(!namespace.endsWith("#")){namespace=namespace+"#"}if(!title){title=""}if(!description){description=""}}},_getJSONURL:function(a){this._baseUrl=a.responseText.substring(0,a.responseText.lastIndexOf("/")+1);this._source=a.responseText;new Ajax.Request(a.responseText,{asynchronous:false,method:"get",onSuccess:this._init.bind(this),onFailure:this._cancelInit.bind(this)})},_init:function(c){this.__handleStencilset(c);var b=new Hash();if(this._jsonObject.propertyPackages){$A(this._jsonObject.propertyPackages).each((function(d){b[d.name]=d.properties}).bind(this))}var a=0;$A(this._jsonObject.stencils).each((function(e){a++;var d=new ORYX.Core.StencilSet.Stencil(e,this.namespace(),this._baseUrl,this,b,a);this._stencils[d.id()]=d;this._availableStencils[d.id()]=d}).bind(this))},_cancelInit:function(a){this.errornous=true},toString:function(){return"StencilSet "+this.title()+" ("+this.namespace()+")"}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.StencilSet){ORYX.Core.StencilSet={}}ORYX.Core.StencilSet._stencilSetsByNamespace=new Hash();ORYX.Core.StencilSet._stencilSetsByUrl=new Hash();ORYX.Core.StencilSet._StencilSetNSByEditorInstance=new Hash();ORYX.Core.StencilSet._rulesByEditorInstance=new Hash();ORYX.Core.StencilSet.stencilSets=function(b){var c=ORYX.Core.StencilSet._StencilSetNSByEditorInstance[b];var a=new Hash();if(c){c.each(function(e){var d=ORYX.Core.StencilSet.stencilSet(e);a[d.namespace()]=d})}return a};ORYX.Core.StencilSet.stencilSet=function(a){ORYX.Log.trace("Getting stencil set %0",a);var b=a.split("#",1);if(b.length===1){ORYX.Log.trace("Getting stencil set %0",b[0]);return ORYX.Core.StencilSet._stencilSetsByNamespace[b[0]+"#"]}else{return undefined}};ORYX.Core.StencilSet.stencil=function(b){ORYX.Log.trace("Getting stencil for %0",b);var a=ORYX.Core.StencilSet.stencilSet(b);if(a){return a.stencil(b)}else{ORYX.Log.trace("Cannot fild stencil for %0",b);return undefined}};ORYX.Core.StencilSet.rules=function(a){if(!ORYX.Core.StencilSet._rulesByEditorInstance[a]){ORYX.Core.StencilSet._rulesByEditorInstance[a]=new ORYX.Core.StencilSet.Rules()}return ORYX.Core.StencilSet._rulesByEditorInstance[a]};ORYX.Core.StencilSet.loadStencilSet=function(a,c){var d=ORYX.Core.StencilSet._stencilSetsByUrl[a];if(!d){d=new ORYX.Core.StencilSet.StencilSet(a);ORYX.Core.StencilSet._stencilSetsByNamespace[d.namespace()]=d;ORYX.Core.StencilSet._stencilSetsByUrl[a]=d}var b=d.namespace();if(ORYX.Core.StencilSet._StencilSetNSByEditorInstance[c]){ORYX.Core.StencilSet._StencilSetNSByEditorInstance[c].push(b)}else{ORYX.Core.StencilSet._StencilSetNSByEditorInstance[c]=[b]}if(ORYX.Core.StencilSet._rulesByEditorInstance[c]){ORYX.Core.StencilSet._rulesByEditorInstance[c].initializeRules(d)}else{var e=new ORYX.Core.StencilSet.Rules();e.initializeRules(d);ORYX.Core.StencilSet._rulesByEditorInstance[c]=e}};ORYX.Core.StencilSet.getTranslation=function(c,b){var d=ORYX.I18N.Language.toLowerCase();var a=c[b+"_"+d];if(a){return a}a=c[b+"_"+d.substr(0,2)];if(a){return a}return c[b]};if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.Bounds={construct:function(){this._changedCallbacks=[];this.a={};this.b={};this.set.apply(this,arguments);this.suspendChange=false;this.changedWhileSuspend=false},_changed:function(a){if(!this.suspendChange){this._changedCallbacks.each(function(b){b(this,a)}.bind(this));this.changedWhileSuspend=false}else{this.changedWhileSuspend=true}},registerCallback:function(a){if(!this._changedCallbacks.member(a)){this._changedCallbacks.push(a)}},unregisterCallback:function(a){this._changedCallbacks=this._changedCallbacks.without(a)},set:function(){var e=false;switch(arguments.length){case 1:if(this.a.x!==arguments[0].a.x){e=true;this.a.x=arguments[0].a.x}if(this.a.y!==arguments[0].a.y){e=true;this.a.y=arguments[0].a.y}if(this.b.x!==arguments[0].b.x){e=true;this.b.x=arguments[0].b.x}if(this.b.y!==arguments[0].b.y){e=true;this.b.y=arguments[0].b.y}break;case 2:var b=Math.min(arguments[0].x,arguments[1].x);var a=Math.min(arguments[0].y,arguments[1].y);var d=Math.max(arguments[0].x,arguments[1].x);var c=Math.max(arguments[0].y,arguments[1].y);if(this.a.x!==b){e=true;this.a.x=b}if(this.a.y!==a){e=true;this.a.y=a}if(this.b.x!==d){e=true;this.b.x=d}if(this.b.y!==c){e=true;this.b.y=c}break;case 4:var b=Math.min(arguments[0],arguments[2]);var a=Math.min(arguments[1],arguments[3]);var d=Math.max(arguments[0],arguments[2]);var c=Math.max(arguments[1],arguments[3]);if(this.a.x!==b){e=true;this.a.x=b}if(this.a.y!==a){e=true;this.a.y=a}if(this.b.x!==d){e=true;this.b.x=d}if(this.b.y!==c){e=true;this.b.y=c}break}if(e){this._changed(true)}},moveTo:function(){var a=this.upperLeft();switch(arguments.length){case 1:this.moveBy({x:arguments[0].x-a.x,y:arguments[0].y-a.y});break;case 2:this.moveBy({x:arguments[0]-a.x,y:arguments[1]-a.y});break;default:}},moveBy:function(){var c=false;switch(arguments.length){case 1:var b=arguments[0];if(b.x!==0||b.y!==0){c=true;this.a.x+=b.x;this.b.x+=b.x;this.a.y+=b.y;this.b.y+=b.y}break;case 2:var a=arguments[0];var d=arguments[1];if(a!==0||d!==0){c=true;this.a.x+=a;this.b.x+=a;this.a.y+=d;this.b.y+=d}break;default:}if(c){this._changed()}},include:function(c){if((this.a.x===undefined)&&(this.a.y===undefined)&&(this.b.x===undefined)&&(this.b.y===undefined)){return c}var a=Math.min(this.a.x,c.a.x);var f=Math.min(this.a.y,c.a.y);var e=Math.max(this.b.x,c.b.x);var d=Math.max(this.b.y,c.b.y);this.set(a,f,e,d)},extend:function(a){if(a.x!==0||a.y!==0){this.b.x+=a.x;this.b.y+=a.y;this._changed(true)}},widen:function(a){if(a!==0){this.suspendChange=true;this.moveBy({x:-a,y:-a});this.extend({x:2*a,y:2*a});this.suspendChange=false;if(this.changedWhileSuspend){this._changed(true)}}},upperLeft:function(){return{x:this.a.x,y:this.a.y}},lowerRight:function(){return{x:this.b.x,y:this.b.y}},width:function(){return this.b.x-this.a.x},height:function(){return this.b.y-this.a.y},center:function(){return{x:(this.a.x+this.b.x)/2,y:(this.a.y+this.b.y)/2}},midPoint:function(){return{x:(this.b.x-this.a.x)/2,y:(this.b.y-this.a.y)/2}},centerMoveTo:function(){var a=this.center();switch(arguments.length){case 1:this.moveBy(arguments[0].x-a.x,arguments[0].y-a.y);break;case 2:this.moveBy(arguments[0]-a.x,arguments[1]-a.y);break}},isIncluded:function(a,e){var f,d,e;switch(arguments.length){case 1:f=arguments[0].x;d=arguments[0].y;e=0;break;case 2:if(arguments[0].x&&arguments[0].y){f=arguments[0].x;d=arguments[0].y;e=Math.abs(arguments[1])}else{f=arguments[0];d=arguments[1];e=0}break;case 3:f=arguments[0];d=arguments[1];e=Math.abs(arguments[2]);break;default:throw"isIncluded needs one, two or three arguments"}var c=this.upperLeft();var b=this.lowerRight();if(f>=c.x-e&&f<=b.x+e&&d>=c.y-e&&d<=b.y+e){return true}else{return false}},clone:function(){return new ORYX.Core.Bounds(this)},toString:function(){return"( "+this.a.x+" | "+this.a.y+" )/( "+this.b.x+" | "+this.b.y+" )"},serializeForERDF:function(){return this.a.x+","+this.a.y+","+this.b.x+","+this.b.y}};ORYX.Core.Bounds=Clazz.extend(ORYX.Core.Bounds);if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.UIObject={construct:function(a){this.isChanged=true;this.isResized=true;this.isVisible=true;this.isSelectable=false;this.isResizable=false;this.isMovable=false;this.id=ORYX.Editor.provideId();this.parent=undefined;this.node=undefined;this.children=[];this.bounds=new ORYX.Core.Bounds();this._changedCallback=this._changed.bind(this);this.bounds.registerCallback(this._changedCallback);if(a&&a.eventHandlerCallback){this.eventHandlerCallback=a.eventHandlerCallback}},_changed:function(b,a){this.isChanged=true;if(this.bounds==b){this.isResized=a||this.isResized}},update:function(){if(this.isChanged){this.refresh();this.isChanged=false;this.children.each(function(a){a.update()})}},refresh:function(){},getChildren:function(){return this.children.clone()},getParents:function(){var a=[];var b=this.parent;while(b){a.push(b);b=b.parent}return a},isParent:function(a){var b=this;while(b){if(b===a){return true}b=b.parent}return false},getId:function(){return this.id},getChildById:function(b,a){return this.children.find(function(c){if(c.getId()===b){return c}else{if(a){var d=c.getChildById(b,a);if(d){return d}}}})},add:function(a){if(!(this.children.member(a))){if(a.parent){a.remove(a)}this.children.push(a);a.parent=this;a.node=this.node.appendChild(a.node);a.bounds.registerCallback(this._changedCallback);if(this.eventHandlerCallback){this.eventHandlerCallback({type:ORYX.CONFIG.EVENT_SHAPEADDED,shape:a})}}else{ORYX.Log.info("add: ORYX.Core.UIObject is already a child of this object.")}},remove:function(a){if(this.children.member(a)){this.children=this._uiObjects.without(a);a.parent=undefined;a.node=this.node.removeChild(a.node);a.bounds.unregisterCallback(this._changedCallback)}else{ORYX.Log.info("remove: ORYX.Core.UIObject is not a child of this object.")}},absoluteBounds:function(){if(this.parent){var a=this.absoluteXY();return new ORYX.Core.Bounds(a.x,a.y,a.x+this.bounds.width(),a.y+this.bounds.height())}else{return this.bounds.clone()}},absoluteXY:function(){if(this.parent){var a=this.parent.absoluteXY();return{x:a.x+this.bounds.upperLeft().x,y:a.y+this.bounds.upperLeft().y}}else{return{x:this.bounds.upperLeft().x,y:this.bounds.upperLeft().y}}},absoluteCenterXY:function(){if(this.parent){var a=this.parent.absoluteXY();return{x:a.x+this.bounds.center().x,y:a.y+this.bounds.center().y}}else{return{x:this.bounds.center().x,y:this.bounds.center().y}}},hide:function(){this.node.setAttributeNS(null,"display","none");this.isVisible=false;this.children.each(function(a){a.hide()})},show:function(){this.node.setAttributeNS(null,"display","inherit");this.isVisible=true;this.children.each(function(a){a.show()})},addEventHandlers:function(a){a.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,this._delegateEvent.bind(this),false);a.addEventListener("click",this._delegateEvent.bind(this),false);a.addEventListener(ORYX.CONFIG.EVENT_DBLCLICK,this._delegateEvent.bind(this),false)},_delegateEvent:function(a){if(this.eventHandlerCallback){this.eventHandlerCallback(a,this)}},toString:function(){return"UIObject "+this.id}};ORYX.Core.UIObject=Clazz.extend(ORYX.Core.UIObject);if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.AbstractShape=ORYX.Core.UIObject.extend({construct:function(a,b){arguments.callee.$.construct.apply(this,arguments);this.resourceId=ORYX.Editor.provideId();this._stencil=b;if(this._stencil._jsonStencil.superId){stencilId=this._stencil.id();superStencilId=stencilId.substring(0,stencilId.indexOf("#")+1)+b._jsonStencil.superId;stencilSet=this._stencil.stencilSet();this._stencil=stencilSet.stencil(superStencilId)}this.properties=new Hash();this.propertiesChanged=new Hash();this.hiddenProperties=new Hash();this._stencil.properties().each((function(d){var c=d.prefix()+"-"+d.id();this.properties[c]=d.value();this.propertiesChanged[c]=true}).bind(this));if(b._jsonStencil.superId){b.properties().each((function(f){var d=f.prefix()+"-"+f.id();var e=f.value();var c=this.properties[d];this.properties[d]=e;this.propertiesChanged[d]=true;this._delegateEvent({type:ORYX.CONFIG.EVENT_PROPERTY_CHANGED,name:d,value:e,oldValue:c})}).bind(this))}},layout:function(){},getStencil:function(){return this._stencil},getChildShapeByResourceId:function(a){a=ERDF.__stripHashes(a);return this.getChildShapes(true).find(function(b){return b.resourceId==a})},getChildShapes:function(b,c){var a=[];this.children.each(function(d){if(d instanceof ORYX.Core.Shape&&d.isVisible){if(c){c(d)}a.push(d);if(b){a=a.concat(d.getChildShapes(b,c))}}});return a},hasChildShape:function(a){return this.getChildShapes().any(function(b){return(b===a)||b.hasChildShape(a)})},getChildNodes:function(b,c){var a=[];this.children.each(function(d){if(d instanceof ORYX.Core.Node&&d.isVisible){if(c){c(d)}a.push(d)}if(d instanceof ORYX.Core.Shape){if(b){a=a.concat(d.getChildNodes(b,c))}}});return a},getChildEdges:function(b,c){var a=[];this.children.each(function(d){if(d instanceof ORYX.Core.Edge&&d.isVisible){if(c){c(d)}a.push(d)}if(d instanceof ORYX.Core.Shape){if(b){a=a.concat(d.getChildEdges(b,c))}}});return a},getAbstractShapesAtPosition:function(){var b,e;switch(arguments.length){case 1:b=arguments[0].x;e=arguments[0].y;break;case 2:b=arguments[0];e=arguments[1];break;default:throw"getAbstractShapesAtPosition needs 1 or 2 arguments!"}if(this.isPointIncluded(b,e)){var a=[];a.push(this);var d=this.getChildNodes();var c=this.getChildEdges();[d,c].each(function(f){var g=new Hash();f.each(function(h){if(!h.isVisible){return}var l=h.getAbstractShapesAtPosition(b,e);if(l.length>0){var k=$A(h.node.parentNode.childNodes);var m=k.indexOf(h.node);g[m]=l}});g.keys().sort().each(function(h){a=a.concat(g[h])})});return a}else{return[]}},setProperty:function(b,d,c){var a=this.properties[b];if(a!==d||c===true){this.properties[b]=d;this.propertiesChanged[b]=true;this._changed();if(!this._isInSetProperty){this._isInSetProperty=true;this._delegateEvent({type:ORYX.CONFIG.EVENT_PROPERTY_CHANGED,elements:[this],name:b,value:d,oldValue:a});delete this._isInSetProperty}}},setHiddenProperty:function(b,c){if(c===undefined){delete this.hiddenProperties[b];return}var a=this.hiddenProperties[b];if(a!==c){this.hiddenProperties[b]=c}},isPointIncluded:function(d,c,b){var a=b?b:this.absoluteBounds();return a.isIncluded(d,c)},serialize:function(){var a=[];a.push({name:"type",prefix:"oryx",value:this.getStencil().id(),type:"literal"});this.hiddenProperties.each(function(b){a.push({name:b.key.replace("oryx-",""),prefix:"oryx",value:b.value,type:"literal"})}.bind(this));this.getStencil().properties().each((function(d){var c=d.prefix();var b=d.id();a.push({name:b,prefix:c,value:this.properties[c+"-"+b],type:"literal"})}).bind(this));return a},deserialize:function(b){var a=0;b=b.sort(function(d,c){return Number(this.properties.keys().member(d.prefix+"-"+d.name))>Number(this.properties.keys().member(c.prefix+"-"+c.name))?-1:0}.bind(this));b.each((function(g){var c=g.name;var f=g.prefix;var e=g.value;if(Ext.type(e)==="object"){e=Ext.encode(e)}switch(f+"-"+c){case"raziel-parent":if(!this.parent){break}var d=this.getCanvas().getChildShapeByResourceId(e);if(d){d.add(this)}break;default:if(this.properties.keys().member(f+"-"+c)){this.setProperty(f+"-"+c,e)}else{if(!(c==="bounds"||c==="parent"||c==="target"||c==="dockers"||c==="docker"||c==="outgoing"||c==="incoming")){this.setHiddenProperty(f+"-"+c,e)}}}}).bind(this))},toString:function(){return"ORYX.Core.AbstractShape "+this.id},toJSON:function(){var a={resourceId:this.resourceId,properties:Ext.apply({},this.properties,this.hiddenProperties).inject({},function(d,f){var c=f[0];var e=f[1];if(this.getStencil().property(c)&&this.getStencil().property(c).type()===ORYX.CONFIG.TYPE_COMPLEX&&Ext.type(e)==="string"){try{e=Ext.decode(e)}catch(b){}}c=c.replace(/^[\w_]+-/,"");d[c]=e;return d}.bind(this)),stencil:{id:this.getStencil().idWithoutNs()},childShapes:this.getChildShapes().map(function(b){return b.toJSON()})};if(this.getOutgoingShapes){a.outgoing=this.getOutgoingShapes().map(function(b){return{resourceId:b.resourceId}})}if(this.bounds){a.bounds={lowerRight:this.bounds.lowerRight(),upperLeft:this.bounds.upperLeft()}}if(this.dockers){a.dockers=this.dockers.map(function(b){var c=b.getDockedShape()&&b.referencePoint?b.referencePoint:b.bounds.center();c.getDocker=function(){return b};return c})}Ext.apply(a,ORYX.Core.AbstractShape.JSONHelper);a.getShape=function(){return this}.bind(this);return a}});ORYX.Core.AbstractShape.JSONHelper={eachChild:function(c,b,d){if(!this.childShapes){return}var a=[];this.childShapes.each(function(e){var f=c(e,this);if(f){a.push(f)}if(b){e.eachChild(c,b,d)}}.bind(this));if(d){this.childShapes=a}},getChildShapes:function(a){var b=this.childShapes;if(a){this.eachChild(function(c){b=b.concat(c.getChildShapes(a))},true)}return b},serialize:function(){return Ext.encode(this)}};if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.Canvas=ORYX.Core.AbstractShape.extend({zoomLevel:1,construct:function(a){arguments.callee.$.construct.apply(this,arguments);if(!(a&&a.width&&a.height)){ORYX.Log.fatal("Canvas is missing mandatory parameters options.width and options.height.");return}this.resourceId=a.id;this.nodes=[];this.edges=[];this.rootNode=ORYX.Editor.graft("http://www.w3.org/2000/svg",a.parentNode,["svg",{id:this.id,width:a.width,height:a.height},["defs",{}]]);this.rootNode.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");this.rootNode.setAttribute("xmlns:svg","http://www.w3.org/2000/svg");this._htmlContainer=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",a.parentNode,["div",{id:"oryx_canvas_htmlContainer",style:"position:absolute; top:5px"}]);this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.rootNode,["g",{},["g",{"class":"stencils"},["g",{"class":"me"}],["g",{"class":"children"}],["g",{"class":"edge"}]],["g",{"class":"svgcontainer"}]]);this.node.setAttributeNS(null,"stroke","black");this.node.setAttributeNS(null,"font-family","Verdana, sans-serif");this.node.setAttributeNS(null,"font-size-adjust","none");this.node.setAttributeNS(null,"font-style","normal");this.node.setAttributeNS(null,"font-variant","normal");this.node.setAttributeNS(null,"font-weight","normal");this.node.setAttributeNS(null,"line-heigth","normal");this.node.setAttributeNS(null,"font-size",ORYX.CONFIG.LABEL_DEFAULT_LINE_HEIGHT);this.bounds.set(0,0,a.width,a.height);this.addEventHandlers(this.rootNode.parentNode);this.rootNode.oncontextmenu=function(){return false}},focus:function(){},update:function(){this.nodes.each(function(b){this._traverseForUpdate(b)}.bind(this));var a=this.getStencil().layout();if(a){a.each(function(b){b.shape=this;b.forceExecution=true;b.target=this.rootNode;this._delegateEvent(b)}.bind(this))}this.nodes.invoke("_update");this.edges.invoke("_update",true)},_traverseForUpdate:function(a){var b=a.isChanged;a.getChildNodes(false,function(c){if(this._traverseForUpdate(c)){b=true}}.bind(this));if(b){a.layout();return true}else{return false}},layout:function(){},getChildNodes:function(b,c){if(!b&&!c){return this.nodes.clone()}else{var a=[];this.nodes.each(function(d){if(c){c(d)}a.push(d);if(b&&d instanceof ORYX.Core.Shape){a=a.concat(d.getChildNodes(b,c))}});return a}},add:function(a){if(a instanceof ORYX.Core.UIObject){if(!(this.children.member(a))){if(a.parent){a.parent.remove(a)}this.children.push(a);a.parent=this;if(a instanceof ORYX.Core.Shape){if(a instanceof ORYX.Core.Edge){a.addMarkers(this.rootNode.getElementsByTagNameNS(NAMESPACE_SVG,"defs")[0]);a.node=this.node.childNodes[0].childNodes[2].appendChild(a.node);this.edges.push(a)}else{a.node=this.node.childNodes[0].childNodes[1].appendChild(a.node);this.nodes.push(a)}}else{a.node=this.node.appendChild(a.node)}a.bounds.registerCallback(this._changedCallback);if(this.eventHandlerCallback){this.eventHandlerCallback({type:ORYX.CONFIG.EVENT_SHAPEADDED,shape:a})}}else{ORYX.Log.warn("add: ORYX.Core.UIObject is already a child of this object.")}}else{ORYX.Log.fatal("add: Parameter is not of type ORYX.Core.UIObject.")}},remove:function(a){if(this.children.member(a)){this.children=this.children.without(a);a.parent=undefined;if(a instanceof ORYX.Core.Shape){if(a instanceof ORYX.Core.Edge){a.removeMarkers();a.node=this.node.childNodes[0].childNodes[2].removeChild(a.node);this.edges=this.edges.without(a)}else{a.node=this.node.childNodes[0].childNodes[1].removeChild(a.node);this.nodes=this.nodes.without(a)}}else{a.node=this.node.removeChild(a.node)}a.bounds.unregisterCallback(this._changedCallback)}else{ORYX.Log.warn("remove: ORYX.Core.UIObject is not a child of this object.")}},addShapeObjects:function(d,c){if(!d){return}var b=function(f,k){try{var l=ORYX.Core.StencilSet.stencil(this.getStencil().namespace()+f.stencil.id);var h=(l.type()=="node")?ORYX.Core.Node:ORYX.Core.Edge;var g=new h({eventHandlerCallback:c},l);g.resourceId=f.resourceId;f.parent="#"+((f.parent&&f.parent.resourceId)||k.resourceId);this.add(g);return{json:f,object:g}}catch(m){ORYX.Log.warn("LoadingContent: Stencil could not create.")}}.bind(this);var e=function(f){var g=[];f.childShapes.each(function(k){var h=b(k,f);if(!(typeof h==="undefined")){g.push(h)}g=g.concat(e(k))});return g}.bind(this);var a=e({childShapes:d,resourceId:this.resourceId});a.each(function(f){var g=[];for(field in f.json.properties){g.push({prefix:"oryx",name:field,value:f.json.properties[field]})}f.json.outgoing.each(function(k){g.push({prefix:"raziel",name:"outgoing",value:"#"+k.resourceId})});if(f.object instanceof ORYX.Core.Edge){var h=f.json.target||f.json.outgoing[0];if(h){g.push({prefix:"raziel",name:"target",value:"#"+h.resourceId})}}if(f.json.bounds){g.push({prefix:"oryx",name:"bounds",value:f.json.bounds.upperLeft.x+","+f.json.bounds.upperLeft.y+","+f.json.bounds.lowerRight.x+","+f.json.bounds.lowerRight.y})}if(f.json.dockers){g.push({prefix:"oryx",name:"dockers",value:f.json.dockers.inject("",function(l,k){return l+k.x+" "+k.y+" "})+" #"})}g.push({prefix:"raziel",name:"parent",value:f.json.parent});f.__properties=g}.bind(this));a.each(function(f){if(f.object instanceof ORYX.Core.Node){f.object.deserialize(f.__properties)}});a.each(function(f){if(f.object instanceof ORYX.Core.Edge){f.object.deserialize(f.__properties)}});return a.pluck("object")},updateSize:function(){var b=0;var a=0;var c=100;this.getChildShapes(true,function(e){var d=e.bounds;b=Math.max(b,d.lowerRight().x+c);a=Math.max(a,d.lowerRight().y+c)});if(this.bounds.width()<b||this.bounds.height()<a){this.setSize({width:Math.max(this.bounds.width(),b),height:Math.max(this.bounds.height(),a)})}},getRootNode:function(){return this.rootNode},getSvgContainer:function(){return this.node.childNodes[1]},getHTMLContainer:function(){return this._htmlContainer},getShapesWithSharedParent:function(a){if(!a||a.length<1){return[]}if(a.length==1){return a}return a.findAll(function(c){var b=c.parent;while(b){if(a.member(b)){return false}b=b.parent}return true})},setSize:function(b,a){if(!b||!b.width||!b.height){return}if(this.rootNode.parentNode){this.rootNode.parentNode.style.width=b.width+"px";this.rootNode.parentNode.style.height=b.height+"px"}this.rootNode.setAttributeNS(null,"width",b.width);this.rootNode.setAttributeNS(null,"height",b.height);if(!a){this.bounds.set({a:{x:0,y:0},b:{x:b.width/this.zoomLevel,y:b.height/this.zoomLevel}})}},getSVGRepresentation:function(p){var k=this.getRootNode().cloneNode(true);this._removeInvisibleElements(k);var d,o,b,n;try{var m=this.getRootNode().childNodes[1].getBBox();d=m.x;o=m.y;b=m.x+m.width;n=m.y+m.height}catch(l){this.getChildShapes(true).each(function(r){var t=r.absoluteBounds();var s=t.upperLeft();var e=t.lowerRight();if(d==undefined){d=s.x;o=s.y;b=e.x;n=e.y}else{d=Math.min(d,s.x);o=Math.min(o,s.y);b=Math.max(b,e.x);n=Math.max(n,e.y)}})}var f=50;var c,q,h,g;if(d==undefined){c=0;q=0;h=0;g=0}else{c=b-d;q=n-o;h=-d+f/2;g=-o+f/2}k.setAttributeNS(null,"width",c+f);k.setAttributeNS(null,"height",q+f);k.childNodes[1].firstChild.setAttributeNS(null,"transform","translate("+h+", "+g+")");k.childNodes[1].removeAttributeNS(null,"transform");try{var a=k.childNodes[1].childNodes[1];a.parentNode.removeChild(a)}catch(l){}if(p){$A(k.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"tspan")).each(function(e){e.textContent=e.textContent.escapeHTML()});$A(k.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"text")).each(function(e){if(e.childNodes.length==0){e.textContent=e.textContent.escapeHTML()}})}$A(k.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"image")).each(function(r){var e=r.getAttributeNS("http://www.w3.org/1999/xlink","href");if(!e.match("^(http|https)://")){e=window.location.protocol+"//"+window.location.host+e;r.setAttributeNS("http://www.w3.org/1999/xlink","href",e)}});$A(k.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"a")).each(function(e){e.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",(e.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").escapeHTML())});return k},_removeInvisibleElements:function(b){var a=0;while(a<b.childNodes.length){var c=b.childNodes[a];if(c.getAttributeNS&&c.getAttributeNS(null,"visibility")==="hidden"){b.removeChild(c)}else{this._removeInvisibleElements(c);a++}}},_delegateEvent:function(a){if(this.eventHandlerCallback&&(a.target==this.rootNode||a.target==this.rootNode.parentNode)){this.eventHandlerCallback(a,this)}},toString:function(){return"Canvas "+this.id},toJSON:function(){var a=arguments.callee.$.toJSON.apply(this,arguments);a.stencilset={url:this.getStencil().stencilSet().source(),namespace:this.getStencil().stencilSet().namespace()};return a}});var idCounter=0;var ID_PREFIX="resource";function init(){Ext.BLANK_IMAGE_URL=ORYX.PATH+"lib/ext-2.0.2/resources/images/default/s.gif";ORYX.Log.debug("Querying editor instances");ORYX.Editor.setMissingClasses();if(window.onOryxResourcesLoaded){window.onOryxResourcesLoaded()}else{if(window.location.pathname.include(ORYX.CONFIG.ORYX_NEW_URL)){new ORYX.Editor({id:"oryx-canvas123",fullscreen:true,stencilset:{url:ORYX.PATH+ORYX.Utils.getParamFromUrl("stencilset")}})}else{var a=window.location.href.replace(/#.*/g,"");if(a.endsWith("/self")){a=a.replace("/self","/json")}else{a+="&data"}ORYX.Editor.createByUrl(a,{id:a})}}}if(!ORYX){var ORYX={}}ORYX.Editor={DOMEventListeners:new Hash(),selection:[],zoomLevel:1,construct:function(d){this._eventsQueue=[];this.loadedPlugins=[];this.pluginsData=[];this.transModelMetaData=d;var c=d;if(d.model){c=d.model}this.id=c.resourceId;if(!this.id){this.id=c.id;if(!this.id){this.id=ORYX.Editor.provideId()}}this.fullscreen=c.fullscreen||true;this._initEventListener();if(ORYX.CONFIG.BACKEND_SWITCH){var b=(c.stencilset.namespace||c.stencilset.url).replace("#","%23");ORYX.Core.StencilSet.loadStencilSet(ORYX.CONFIG.STENCILSET_HANDLER+b,this.id)}else{var b=c.stencilset.url;ORYX.Core.StencilSet.loadStencilSet(b,this.id)}this._loadStencilSetExtensionConfig();if(!!ORYX.CONFIG.SSEXTS){ORYX.CONFIG.SSEXTS.each(function(g){this.loadSSExtension(g.namespace)}.bind(this))}this._createTransformationCanvas(c.stencil?c.stencil.id:null,c.properties);this._generateGUI();var f=false;var e=false;var a=function(){if(!f||!e){return}this._finishedLoading()}.bind(this);ORYX.Editor.makeExtModalWindowKeysave(this._getPluginFacade());window.setTimeout(function(){this.loadPlugins();f=true;a()}.bind(this),100);window.setTimeout(function(){this.loadSerialized(c);this.getCanvas().update();e=true;a()}.bind(this),200)},_finishedLoading:function(){if(Ext.getCmp("oryx-loading-panel")){Ext.getCmp("oryx-loading-panel").hide()}this.layout.doLayout();new Ext.dd.DropTarget(this.getCanvas().rootNode.parentNode);if(ORYX.CONFIG.PANEL_RIGHT_COLLAPSED===true){this.layout_regions.east.collapse()}if(ORYX.CONFIG.PANEL_LEFT_COLLAPSED===true){this.layout_regions.west.collapse()}this.handleEvents({type:ORYX.CONFIG.EVENT_LOADED})},_initEventListener:function(){document.documentElement.addEventListener(ORYX.CONFIG.EVENT_KEYDOWN,this.catchKeyDownEvents.bind(this),true);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_KEYUP,this.catchKeyUpEvents.bind(this),true);this._keydownEnabled=true;this._keyupEnabled=true;this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEDOWN]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEUP]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEOVER]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEOUT]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_SELECTION_CHANGED]=[];this.DOMEventListeners[ORYX.CONFIG.EVENT_MOUSEMOVE]=[]},_generateGUI:function(){var c=400;var f=this.getCanvas().rootNode.parentNode;var b=this;var g=new Ext.Panel({autoHeight:true,cls:"x-panel-editor-center",el:f,autoScroll:true,split:true});var e=new Ext.Panel({width:ORYX.CONFIG.CANVAS_WIDTH,autoHeight:true,layout:"fit",cls:"x-panel-editor-east",border:false,split:true});var a=new Ext.Panel({region:"center",layout:"column",items:[g,e],autoScroll:true});this.layout_regions={north:new Ext.Panel({region:"north",cls:"x-panel-editor-north",autoEl:"div",border:false}),east:new Ext.Panel({region:"east",layout:"fit",cls:"x-panel-editor-east",autoEl:"div",border:false,cmargins:{left:0,right:0},collapsible:true,width:ORYX.CONFIG.PANEL_RIGHT_WIDTH||200,split:true,title:"East"}),south:new Ext.Panel({region:"south",cls:"x-panel-editor-south",autoEl:"div",border:false}),west:new Ext.Panel({region:"west",layout:"anchor",autoEl:"div",cls:"x-panel-editor-west",collapsible:true,width:ORYX.CONFIG.PANEL_LEFT_WIDTH||200,autoScroll:true,cmargins:{left:0,right:0},split:true,title:"West"}),centernorth:g,centersouth:e,center:a};for(region in this.layout_regions){if(region!="center"){}}var d={layout:"border",items:[this.layout_regions.north,this.layout_regions.east,this.layout_regions.south,this.layout_regions.west,this.layout_regions.center]};if(this.fullscreen){this.layout=new Ext.Viewport(d)}else{d.renderTo=this.id;d.height=c;this.layout=new Ext.Panel(d)}this._generateHeader();f.parentNode.setAttributeNS(null,"align","center");f.setAttributeNS(null,"align","left");this.getCanvas().setSize({width:ORYX.CONFIG.CANVAS_WIDTH,height:ORYX.CONFIG.CANVAS_HEIGHT})},_generateHeader:function(){},addToRegion:function(f,b,h){var g=f.toLowerCase();if(f.toLowerCase&&this.layout_regions[g]){var c=this.layout_regions[f.toLowerCase()];c.add(b);ORYX.Log.debug("original dimensions of region %0: %1 x %2",c.region,c.width,c.height);if(!c.width&&b.initialConfig&&b.initialConfig.width){ORYX.Log.debug("resizing width of region %0: %1",c.region,b.initialConfig.width);c.setWidth(b.initialConfig.width)}if(b.initialConfig&&b.initialConfig.height){ORYX.Log.debug("resizing height of region %0: %1",c.region,b.initialConfig.height);var e=c.height||0;c.height=b.initialConfig.height+e;c.setHeight(b.initialConfig.height+e)}if(typeof h=="string"){switch(f.toLowerCase()){case"east":if(c.title!="East"){h=c.title+" and "+h;c.setTitle(h)}c.setTitle(h);break;case"west":if(c.title!="West"){h=c.title+" and "+h;c.setTitle(h)}c.setTitle(h);break;default:c.setTitle(h)}}if(f.toLowerCase()=="east"&&c.items.length>=2){var d=new Ext.layout.Accordion(c.layoutConfig);c.setLayout(d);var a=c.items.clone()}c.ownerCt.doLayout();c.show();if(Ext.isMac){ORYX.Editor.resizeFix()}return c}return null},getAvailablePlugins:function(){var a=ORYX.availablePlugins.clone();a.each(function(b){if(this.loadedPlugins.find(function(c){return c.type==this.name}.bind(b))){b.engaged=true}else{b.engaged=false}}.bind(this));return a},loadScript:function(b,c){var a=document.createElement("script");a.type="text/javascript";if(a.readyState){a.onreadystatechange=function(){if(a.readyState=="loaded"||a.readyState=="complete"){a.onreadystatechange=null;c()}}}else{a.onload=function(){c()}}a.src=b;document.getElementsByTagName("head")[0].appendChild(a)},activatePluginByName:function(name,callback,loadTry){var match=this.getAvailablePlugins().find(function(value){return value.name==name});if(match&&(!match.engaged||(match.engaged==="false"))){var loadedStencilSetsNamespaces=this.getStencilSets().keys();var facade=this._getPluginFacade();var newPlugin;var me=this;ORYX.Log.debug("Initializing plugin '%0'",match.name);if(!match.requires||!match.requires.namespaces||match.requires.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0})){if(!match.notUsesIn||!match.notUsesIn.namespaces||!match.notUsesIn.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0})){try{var className=eval(match.name);var newPlugin=new className(facade,match);newPlugin.type=match.name;if(newPlugin.registryChanged){newPlugin.registryChanged(me.pluginsData)}if(newPlugin.onSelectionChanged){me.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,newPlugin.onSelectionChanged.bind(newPlugin))}this.loadedPlugins.push(newPlugin);this.loadedPlugins.each(function(loaded){if(loaded.registryChanged){loaded.registryChanged(this.pluginsData)}}.bind(me));callback(true)}catch(e){ORYX.Log.warn("Plugin %0 is not available",match.name);if(!!loadTry){callback(false,"INITFAILED");return}this.loadScript("plugins/scripts/"+match.source,this.activatePluginByName.bind(this,match.name,callback,true))}}else{callback(false,"NOTUSEINSTENCILSET");ORYX.Log.info("Plugin need a stencilset which is not loaded'",match.name)}}else{callback(false,"REQUIRESTENCILSET");ORYX.Log.info("Plugin need a stencilset which is not loaded'",match.name)}}else{callback(false,match?"NOTFOUND":"YETACTIVATED")}},loadPlugins:function(){var me=this;var newPlugins=[];var loadedStencilSetsNamespaces=this.getStencilSets().keys();var facade=this._getPluginFacade();if(ORYX.MashupAPI&&ORYX.MashupAPI.loadablePlugins&&ORYX.MashupAPI.loadablePlugins instanceof Array){ORYX.availablePlugins=$A(ORYX.availablePlugins).findAll(function(value){return ORYX.MashupAPI.loadablePlugins.include(value.name)});ORYX.MashupAPI.loadablePlugins.each(function(className){if(!(ORYX.availablePlugins.find(function(val){return val.name==className}))){ORYX.availablePlugins.push({name:className})}})}ORYX.availablePlugins.each(function(value){ORYX.Log.debug("Initializing plugin '%0'",value.name);if((!value.requires||!value.requires.namespaces||value.requires.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0}))&&(!value.notUsesIn||!value.notUsesIn.namespaces||!value.notUsesIn.namespaces.any(function(req){return loadedStencilSetsNamespaces.indexOf(req)>=0}))&&(!value.engaged||value.engaged=="true")){try{var className=eval(value.name);if(className){var plugin=new className(facade,value);plugin.type=value.name;newPlugins.push(plugin);plugin.engaged=true}}catch(e){ORYX.Log.warn("Plugin %0 is not available",value.name)}}else{ORYX.Log.info("Plugin need a stencilset which is not loaded'",value.name)}});newPlugins.each(function(value){if(value.registryChanged){value.registryChanged(me.pluginsData)}if(value.onSelectionChanged){me.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,value.onSelectionChanged.bind(value))}});this.loadedPlugins=newPlugins;if(Ext.isMac){ORYX.Editor.resizeFix()}this.registerPluginsOnKeyEvents();this.setSelection()},_loadStencilSetExtensionConfig:function(){new Ajax.Request(ORYX.CONFIG.SS_EXTENSIONS_CONFIG,{method:"GET",asynchronous:false,onSuccess:(function(b){var a=Ext.decode(b.responseText);this.ss_extensions_def=a}).bind(this),onFailure:(function(a){ORYX.Log.error("Editor._loadStencilSetExtensionConfig: Loading stencil set extension configuration file failed."+a)}).bind(this)})},_createTransformationCanvas:function(c,d){if(c){if(c.search(/^http/)===-1){c=this.getStencilSets().values()[0].namespace()+c}}else{c=this.getStencilSets().values()[0].findRootStencilName()}var a=ORYX.Core.StencilSet.stencil(c);if(!a){ORYX.Log.fatal("Initialisation failed, because the stencil with the type %0 is not part of one of the loaded stencil sets.",c)}var e=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",null,["div"]);e.addClassName("ORYX_Editor");this._transformationCanvas=new ORYX.Core.Canvas({width:ORYX.CONFIG.CANVAS_WIDTH,height:ORYX.CONFIG.CANVAS_HEIGHT,eventHandlerCallback:this.handleEvents.bind(this),id:this.id,parentNode:e},a);if(d){var b=[];for(field in d){b.push({prefix:"oryx",name:field,value:d[field]})}this._transformationCanvas.deserialize(b)}},_getPluginFacade:function(){if(!(this._pluginFacade)){this._pluginFacade={activatePluginByName:this.activatePluginByName.bind(this),getAvailablePlugins:this.getAvailablePlugins.bind(this),offer:this.offer.bind(this),getStencilSets:this.getStencilSets.bind(this),getRules:this.getRules.bind(this),loadStencilSet:this.loadStencilSet.bind(this),createShape:this.createShape.bind(this),deleteShape:this.deleteShape.bind(this),getSelection:this.getSelection.bind(this),setSelection:this.setSelection.bind(this),updateSelection:this.updateSelection.bind(this),getCanvas:this.getCanvas.bind(this),importJSON:this.importJSON.bind(this),importERDF:this.importERDF.bind(this),getERDF:this.getERDF.bind(this),getJSON:this.getJSON.bind(this),getSerializedJSON:this.getSerializedJSON.bind(this),executeCommands:this.executeCommands.bind(this),registerOnEvent:this.registerOnEvent.bind(this),unregisterOnEvent:this.unregisterOnEvent.bind(this),raiseEvent:this.handleEvents.bind(this),enableEvent:this.enableEvent.bind(this),disableEvent:this.disableEvent.bind(this),eventCoordinates:this.eventCoordinates.bind(this),addToRegion:this.addToRegion.bind(this),getModelMetaData:this.getModelMetaData.bind(this)}}return this._pluginFacade},executeCommands:function(a){if(a instanceof Array&&a.length>0&&a.all(function(b){return b instanceof ORYX.Core.Command})){this.handleEvents({type:ORYX.CONFIG.EVENT_EXECUTE_COMMANDS,commands:a});a.each(function(b){b.execute()})}},getJSON:function(){var a=this.getCanvas().toJSON();a.ssextensions=this.getStencilSets().values()[0].extensions().keys();return a},getSerializedJSON:function(){return Ext.encode(this.getJSON())},getERDF:function(){var a=DataManager.serializeDOM(this._getPluginFacade());a='<?xml version="1.0" encoding="utf-8"?><html xmlns="http://www.w3.org/1999/xhtml" xmlns:b3mn="http://b3mn.org/2007/b3mn" xmlns:ext="http://b3mn.org/2007/ext" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:atom="http://b3mn.org/2007/atom+xhtml"><head profile="http://purl.org/NET/erdf/profile"><link rel="schema.dc" href="http://purl.org/dc/elements/1.1/" /><link rel="schema.dcTerms" href="http://purl.org/dc/terms/ " /><link rel="schema.b3mn" href="http://b3mn.org" /><link rel="schema.oryx" href="http://oryx-editor.org/" /><link rel="schema.raziel" href="http://raziel.org/" /><base href="'+location.href.split("?")[0]+'" /></head><body>'+a+"</body></html>";return a},importJSON:function(d,c){try{d=this.renewResourceIds(d)}catch(b){throw b}if(!d.stencilset){Ext.Msg.alert(ORYX.I18N.JSONImport.title,ORYX.I18N.JSONImport.invalidJSON);return null}if(d.stencilset.namespace&&d.stencilset.namespace!==this.getCanvas().getStencil().stencilSet().namespace()){Ext.Msg.alert(ORYX.I18N.JSONImport.title,String.format(ORYX.I18N.JSONImport.wrongSS,d.stencilset.namespace,this.getCanvas().getStencil().stencilSet().namespace()));return null}else{var a=ORYX.Core.Command.extend({construct:function(g,k,f,h){this.jsonObject=g;this.noSelection=f;this.facade=h;this.shapes;this.connections=[];this.parents=new Hash();this.selection=this.facade.getSelection();this.loadSerialized=k},execute:function(){if(!this.shapes){this.shapes=this.loadSerialized(this.jsonObject);this.shapes.each(function(g){if(g.getDockers){var f=g.getDockers();if(f){if(f.length>0){this.connections.push([f.first(),f.first().getDockedShape(),f.first().referencePoint])}if(f.length>1){this.connections.push([f.last(),f.last().getDockedShape(),f.last().referencePoint])}}}this.parents[g.id]=g.parent}.bind(this))}else{this.shapes.each(function(f){this.parents[f.id].add(f)}.bind(this));this.connections.each(function(f){f[0].setDockedShape(f[1]);f[0].setReferencePoint(f[2])})}this.facade.getCanvas().update();if(!this.noSelection){this.facade.setSelection(this.shapes)}else{this.facade.updateSelection()}},rollback:function(){var f=this.facade.getSelection();this.shapes.each(function(g){f=f.without(g);this.facade.deleteShape(g)}.bind(this));this.facade.getCanvas().update();this.facade.setSelection(f)}});var e=new a(d,this.loadSerialized.bind(this),c,this._getPluginFacade());this.executeCommands([e]);return e.shapes.clone()}},renewResourceIds:function(b){if(Ext.type(b)==="string"){try{var d=b;b=Ext.decode(b)}catch(a){throw new SyntaxError(a.message)}}else{var d=Ext.encode(b)}var e=function(f){if(!f){return[]}return f.map(function(g){return e(g.childShapes).concat(g.resourceId)}).flatten()};var c=e(b.childShapes);c.each(function(f){var g=ORYX.Editor.provideId();d=d.gsub('"'+f+'"','"'+g+'"')});return Ext.decode(d)},importERDF:function(a){var b=this.parseToSerializeObjects(a);if(b){return this.importJSON(b,true)}},parseToSerializeObjects:function(c){if(c.normalize){c.normalize()}try{var d="";var a=ORYX.PATH+"lib/extract-rdf.xsl";new Ajax.Request(a,{asynchronous:false,method:"get",onSuccess:function(e){d=e.responseText}.bind(this),onFailure:(function(e){ORYX.Log.error("XSL load failed"+e)}).bind(this)});var m=new DOMParser();var g=c;var f=m.parseFromString(d,"text/xml");var h=new XSLTProcessor();var n=document.implementation.createDocument("","",null);h.importStylesheet(f);var o=h.transformToFragment(g,document);var b=(new XMLSerializer()).serializeToString(o)}catch(k){Ext.Msg.alert("Oryx",error);var b=""}b=!b.startsWith("<?xml")?'<?xml version="1.0" encoding="UTF-8"?>'+b:b;var l=new Ajax.Request(ORYX.CONFIG.ROOT_PATH+"rdf2json",{method:"POST",asynchronous:false,onSuccess:function(e){Ext.decode(e.responseText)},parameters:{rdf:b}});return Ext.decode(l.transport.responseText)},loadSerialized:function(c){var b=this.getCanvas();this.loadSSExtensions(c.ssextensions);var a=this.getCanvas().addShapeObjects(c.childShapes,this.handleEvents.bind(this));if(c.properties){for(key in c.properties){var d=c.properties[key];if(!(typeof d==="string")){d=Ext.encode(d)}this.getCanvas().setProperty("oryx-"+key,d)}}this.getCanvas().updateSize();return a},loadSSExtensions:function(a){if(!a){return}a.each(function(b){this.loadSSExtension(b)}.bind(this))},loadSSExtension:function(b){if(this.ss_extensions_def){var c=this.ss_extensions_def.extensions.find(function(d){return(d.namespace==b)});if(!c){return}var a=this.getStencilSets()[c["extends"]];if(!a){return}a.addExtension(ORYX.CONFIG.SS_EXTENSIONS_FOLDER+c.definition);this.getRules().initializeRules(a);this._getPluginFacade().raiseEvent({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED})}},disableEvent:function(a){if(a==ORYX.CONFIG.EVENT_KEYDOWN){this._keydownEnabled=false}if(a==ORYX.CONFIG.EVENT_KEYUP){this._keyupEnabled=false}if(this.DOMEventListeners.keys().member(a)){var b=this.DOMEventListeners.remove(a);this.DOMEventListeners["disable_"+a]=b}},enableEvent:function(a){if(a==ORYX.CONFIG.EVENT_KEYDOWN){this._keydownEnabled=true}if(a==ORYX.CONFIG.EVENT_KEYUP){this._keyupEnabled=true}if(this.DOMEventListeners.keys().member("disable_"+a)){var b=this.DOMEventListeners.remove("disable_"+a);this.DOMEventListeners[a]=b}},registerOnEvent:function(a,b){if(!(this.DOMEventListeners.keys().member(a))){this.DOMEventListeners[a]=[]}this.DOMEventListeners[a].push(b)},unregisterOnEvent:function(a,b){if(this.DOMEventListeners.keys().member(a)){this.DOMEventListeners[a]=this.DOMEventListeners[a].without(b)}else{}},getSelection:function(){return this.selection},getStencilSets:function(){return ORYX.Core.StencilSet.stencilSets(this.id)},getRules:function(){return ORYX.Core.StencilSet.rules(this.id)},loadStencilSet:function(a){try{ORYX.Core.StencilSet.loadStencilSet(a,this.id);this.handleEvents({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED})}catch(b){ORYX.Log.warn("Requesting stencil set file failed. ("+b+")")}},offer:function(a){if(!this.pluginsData.member(a)){this.pluginsData.push(a)}},registerPluginsOnKeyEvents:function(){this.pluginsData.each(function(a){if(a.keyCodes){a.keyCodes.each(function(c){var b="key.event";b+="."+c.keyAction;if(c.metaKeys){if(c.metaKeys.indexOf(ORYX.CONFIG.META_KEY_META_CTRL)>-1){b+="."+ORYX.CONFIG.META_KEY_META_CTRL}if(c.metaKeys.indexOf(ORYX.CONFIG.META_KEY_ALT)>-1){b+="."+ORYX.CONFIG.META_KEY_ALT}if(c.metaKeys.indexOf(ORYX.CONFIG.META_KEY_SHIFT)>-1){b+="."+ORYX.CONFIG.META_KEY_SHIFT}}if(c.keyCode){b+="."+c.keyCode}ORYX.Log.debug("Register Plugin on Key Event: %0",b);this.registerOnEvent(b,a.functionality)}.bind(this))}}.bind(this))},setSelection:function(c,a,b){if(!c){c=[]}c=c.compact().findAll(function(d){return d instanceof ORYX.Core.Shape});if(c.first() instanceof ORYX.Core.Canvas){c=[]}if(!b&&c.length===this.selection.length&&this.selection.all(function(d){return c.include(d)})){return}this.selection=c;this._subSelection=a;this.handleEvents({type:ORYX.CONFIG.EVENT_SELECTION_CHANGED,elements:c,subSelection:a})},updateSelection:function(){this.setSelection(this.selection,this._subSelection,true)},getCanvas:function(){return this._transformationCanvas},createShape:function(f){if(f&&f.serialize&&f.serialize instanceof Array){var k=f.serialize.find(function(b){return(b.prefix+"-"+b.name)=="oryx-type"});var p=ORYX.Core.StencilSet.stencil(k.value);if(p.type()=="node"){var h=new ORYX.Core.Node({eventHandlerCallback:this.handleEvents.bind(this)},p)}else{var h=new ORYX.Core.Edge({eventHandlerCallback:this.handleEvents.bind(this)},p)}this.getCanvas().add(h);h.deserialize(f.serialize);return h}if(!f||!f.type||!f.namespace){throw"To create a new shape you have to give an argument with type and namespace"}var e=this.getCanvas();var h;var a=f.type;var m=ORYX.Core.StencilSet.stencilSet(f.namespace);if(m.stencil(a).type()=="node"){h=new ORYX.Core.Node({eventHandlerCallback:this.handleEvents.bind(this)},m.stencil(a))}else{h=new ORYX.Core.Edge({eventHandlerCallback:this.handleEvents.bind(this)},m.stencil(a))}if(f.template){h._jsonStencil.properties=f.template._jsonStencil.properties;h.postProcessProperties()}if(f.parent&&h instanceof ORYX.Core.Node){f.parent.add(h)}else{e.add(h)}var n=f.position?f.position:{x:100,y:200};var c;if(f.connectingType&&f.connectedShape&&!(h instanceof ORYX.Core.Edge)){c=new ORYX.Core.Edge({eventHandlerCallback:this.handleEvents.bind(this)},m.stencil(f.connectingType));c.dockers.first().setDockedShape(f.connectedShape);var o=f.connectedShape.getDefaultMagnet();var q=o?o.bounds.center():f.connectedShape.bounds.midPoint();c.dockers.first().setReferencePoint(q);c.dockers.last().setDockedShape(h);c.dockers.last().setReferencePoint(h.getDefaultMagnet().bounds.center());e.add(c)}if(h instanceof ORYX.Core.Edge&&f.connectedShape){h.dockers.first().setDockedShape(f.connectedShape);if(f.connectedShape instanceof ORYX.Core.Node){h.dockers.first().setReferencePoint(f.connectedShape.getDefaultMagnet().bounds.center());h.dockers.last().bounds.centerMoveTo(n)}else{h.dockers.first().setReferencePoint(f.connectedShape.bounds.midPoint())}}else{var l=h.bounds;if(h instanceof ORYX.Core.Node&&h.dockers.length==1){l=h.dockers.first().bounds}l.centerMoveTo(n);var d=l.upperLeft();l.moveBy(-Math.min(d.x,0),-Math.min(d.y,0));var g=l.lowerRight();l.moveBy(-Math.max(g.x-e.bounds.width(),0),-Math.max(g.y-e.bounds.height(),0))}if(h instanceof ORYX.Core.Edge){h._update(false)}if(!(h instanceof ORYX.Core.Edge)){this.setSelection([h])}if(c&&c.alignDockers){c.alignDockers()}if(h.alignDockers){h.alignDockers()}return h},deleteShape:function(a){if(!a||!a.parent){return}a.parent.remove(a);a.getOutgoingShapes().each(function(c){var b=c.getDockers().first();if(b&&b.getDockedShape()==a){b.setDockedShape(undefined)}});a.getIncomingShapes().each(function(b){var c=b.getDockers().last();if(c&&c.getDockedShape()==a){c.setDockedShape(undefined)}});a.getDockers().each(function(b){b.setDockedShape(undefined)})},getModelMetaData:function(){return this.transModelMetaData},_executeEventImmediately:function(a){if(this.DOMEventListeners.keys().member(a.event.type)){this.DOMEventListeners[a.event.type].each((function(b){b(a.event,a.arg)}).bind(this))}},_executeEvents:function(){this._queueRunning=true;while(this._eventsQueue.length>0){var a=this._eventsQueue.shift();this._executeEventImmediately(a)}this._queueRunning=false},handleEvents:function(b,a){ORYX.Log.trace("Dispatching event type %0 on %1",b.type,a);switch(b.type){case ORYX.CONFIG.EVENT_MOUSEDOWN:this._handleMouseDown(b,a);break;case ORYX.CONFIG.EVENT_MOUSEMOVE:this._handleMouseMove(b,a);break;case ORYX.CONFIG.EVENT_MOUSEUP:this._handleMouseUp(b,a);break;case ORYX.CONFIG.EVENT_MOUSEOVER:this._handleMouseHover(b,a);break;case ORYX.CONFIG.EVENT_MOUSEOUT:this._handleMouseOut(b,a);break}if(b.forceExecution){this._executeEventImmediately({event:b,arg:a})}else{this._eventsQueue.push({event:b,arg:a})}if(!this._queueRunning){this._executeEvents()}return false},catchKeyUpEvents:function(b){if(!this._keyupEnabled){return}if(!b){b=window.event}if(["INPUT","TEXTAREA"].include(b.target.tagName.toUpperCase())){return}var a=this.createKeyCombEvent(b,ORYX.CONFIG.KEY_ACTION_UP);ORYX.Log.debug("Key Event to handle: %0",a);this.handleEvents({type:a,event:b})},catchKeyDownEvents:function(b){if(!this._keydownEnabled){return}if(!b){b=window.event}if(["INPUT","TEXTAREA"].include(b.target.tagName.toUpperCase())){return}var a=this.createKeyCombEvent(b,ORYX.CONFIG.KEY_ACTION_DOWN);ORYX.Log.debug("Key Event to handle: %0",a);this.handleEvents({type:a,event:b})},createKeyCombEvent:function(c,b){var d=c.which||c.keyCode;var a="key.event";if(b){a+="."+b}if(c.ctrlKey||c.metaKey){a+="."+ORYX.CONFIG.META_KEY_META_CTRL}if(c.altKey){a+="."+ORYX.CONFIG.META_KEY_ALT}if(c.shiftKey){a+="."+ORYX.CONFIG.META_KEY_SHIFT}return a+"."+d},_handleMouseDown:function(a,l){var b=this.getCanvas();b.focus();var d=a.currentTarget;var c=l;var g=(c!==null)&&(c!==undefined)&&(c.isSelectable);var m=(c!==null)&&(c!==undefined)&&(c.isMovable);var k=a.shiftKey||a.ctrlKey;var h=this.selection.length===0;var e=this.selection.member(c);if(g&&h){this.setSelection([c]);ORYX.Log.trace("Rule #1 applied for mouse down on %0",d.id)}else{if(g&&!h&&!k&&!e){this.setSelection([c]);ORYX.Log.trace("Rule #3 applied for mouse down on %0",d.id)}else{if(g&&k&&!e){var f=this.selection.clone();f.push(c);this.setSelection(f);ORYX.Log.trace("Rule #4 applied for mouse down on %0",d.id)}else{if(g&&e&&k){var f=this.selection.clone();this.setSelection(f.without(c));ORYX.Log.trace("Rule #6 applied for mouse down on %0",c.id)}else{if(!g&&!m){this.setSelection([]);ORYX.Log.trace("Rule #2 applied for mouse down on %0",d.id);return}else{if(!g&&m&&!(c instanceof ORYX.Core.Controls.Docker)){ORYX.Log.trace("Rule #7 applied for mouse down on %0",d.id)}else{if(g&&e&&!k){this._subSelection=this._subSelection!=c?c:undefined;this.setSelection(this.selection,this._subSelection);ORYX.Log.trace("Rule #8 applied for mouse down on %0",d.id)}}}}}}}return},_handleMouseMove:function(b,a){return},_handleMouseUp:function(d,c){var a=this.getCanvas();var e=c;var b=this.eventCoordinates(d)},_handleMouseHover:function(b,a){return},_handleMouseOut:function(b,a){return},eventCoordinates:function(c){var b=this.getCanvas();var d=b.node.ownerSVGElement.createSVGPoint();d.x=c.clientX;d.y=c.clientY;var a=b.node.getScreenCTM();return d.matrixTransform(a.inverse())}};ORYX.Editor=Clazz.extend(ORYX.Editor);ORYX.Editor.createByUrl=function(b,a){if(!a){a={}}new Ajax.Request(b,{method:"GET",onSuccess:function(d){var c=Ext.decode(d.responseText);c=Ext.applyIf(c,a);new ORYX.Editor(c);if("function"==typeof(a.onSuccess)){a.onSuccess(d)}}.bind(this),onFailure:function(c){if("function"==typeof(a.onFailure)){a.onFailure(c)}}.bind(this)})};ORYX.Editor.graft=function(g,f,d,l){l=(l||(f&&f.ownerDocument)||document);var h;if(d===undefined){throw"Can't graft an undefined value"}else{if(d.constructor==String){h=l.createTextNode(d)}else{for(var c=0;c<d.length;c++){if(c===0&&d[c].constructor==String){var a;a=d[c].match(/^([a-z][a-z0-9]*)\.([^\s\.]+)$/i);if(a){h=l.createElementNS(g,a[1]);h.setAttributeNS(null,"class",a[2]);continue}a=d[c].match(/^([a-z][a-z0-9]*)$/i);if(a){h=l.createElementNS(g,a[1]);continue}h=l.createElementNS(g,"span");h.setAttribute(null,"class","namelessFromLOL")}if(d[c]===undefined){throw"Can't graft an undefined value in a list!"}else{if(d[c].constructor==String||d[c].constructor==Array){this.graft(g,h,d[c],l)}else{if(d[c].constructor==Number){this.graft(g,h,d[c].toString(),l)}else{if(d[c].constructor==Object){for(var b in d[c]){h.setAttributeNS(null,b,d[c][b])}}else{}}}}}}}if(f){f.appendChild(h)}else{}return h};ORYX.Editor.provideId=function(){var b=[],c="0123456789ABCDEF";for(var a=0;a<36;a++){b[a]=Math.floor(Math.random()*16)}b[14]=4;b[19]=(b[19]&3)|8;for(var a=0;a<36;a++){b[a]=c[b[a]]}b[8]=b[13]=b[18]=b[23]="-";return"oryx_"+b.join("")};ORYX.Editor.resizeFix=function(){if(!ORYX.Editor._resizeFixTimeout){ORYX.Editor._resizeFixTimeout=window.setTimeout(function(){window.resizeBy(1,1);window.resizeBy(-1,-1);ORYX.Editor._resizefixTimeout=null},100)}};ORYX.Editor.Cookie={callbacks:[],onChange:function(b,a){this.callbacks.push(b);this.start(a)},start:function(a){if(this.pe){return}var b=document.cookie;this.pe=new PeriodicalExecuter(function(){if(b!=document.cookie){b=document.cookie;this.callbacks.each(function(c){c(this.getParams())}.bind(this))}}.bind(this),(a||10000)/1000)},stop:function(){if(this.pe){this.pe.stop();this.pe=null}},getParams:function(){var a={};var b=document.cookie;b.split("; ").each(function(c){a[c.split("=")[0]]=c.split("=")[1]});return a},toString:function(){return document.cookie}};ORYX.Editor.SVGClassElementsAreAvailable=true;ORYX.Editor.setMissingClasses=function(){try{SVGElement}catch(a){ORYX.Editor.SVGClassElementsAreAvailable=false;SVGSVGElement=document.createElementNS("http://www.w3.org/2000/svg","svg").toString();SVGGElement=document.createElementNS("http://www.w3.org/2000/svg","g").toString();SVGPathElement=document.createElementNS("http://www.w3.org/2000/svg","path").toString();SVGTextElement=document.createElementNS("http://www.w3.org/2000/svg","text").toString();SVGRectElement=document.createElementNS("http://www.w3.org/2000/svg","rect").toString();SVGImageElement=document.createElementNS("http://www.w3.org/2000/svg","image").toString();SVGCircleElement=document.createElementNS("http://www.w3.org/2000/svg","circle").toString();SVGEllipseElement=document.createElementNS("http://www.w3.org/2000/svg","ellipse").toString();SVGLineElement=document.createElementNS("http://www.w3.org/2000/svg","line").toString();SVGPolylineElement=document.createElementNS("http://www.w3.org/2000/svg","polyline").toString();SVGPolygonElement=document.createElementNS("http://www.w3.org/2000/svg","polygon").toString()}};ORYX.Editor.checkClassType=function(b,a){if(ORYX.Editor.SVGClassElementsAreAvailable){return b instanceof a}else{return b==a}};ORYX.Editor.makeExtModalWindowKeysave=function(a){Ext.override(Ext.Window,{beforeShow:function(){delete this.el.lastXY;delete this.el.lastLT;if(this.x===undefined||this.y===undefined){var b=this.el.getAlignToXY(this.container,"c-c");var c=this.el.translatePoints(b[0],b[1]);this.x=this.x===undefined?c.left:this.x;this.y=this.y===undefined?c.top:this.y}this.el.setLeftTop(this.x,this.y);if(this.expandOnShow){this.expand(false)}if(this.modal){a.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);Ext.getBody().addClass("x-body-masked");this.mask.setSize(Ext.lib.Dom.getViewWidth(true),Ext.lib.Dom.getViewHeight(true));this.mask.show()}},afterHide:function(){this.proxy.hide();if(this.monitorResize||this.modal||this.constrain||this.constrainHeader){Ext.EventManager.removeResizeListener(this.onWindowResize,this)}if(this.modal){this.mask.hide();a.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);Ext.getBody().removeClass("x-body-masked")}if(this.keyMap){this.keyMap.disable()}this.fireEvent("hide",this)},beforeDestroy:function(){if(this.modal){a.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN)}Ext.destroy(this.resizer,this.dd,this.proxy,this.mask);Ext.Window.superclass.beforeDestroy.call(this)}})};if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.UIEnableDrag=function(e,d,c){this.uiObj=d;var f=d.bounds.upperLeft();var b=d.node.getScreenCTM();this.faktorXY={x:b.a,y:b.d};this.scrollNode=d.node.ownerSVGElement.parentNode.parentNode;this.offSetPosition={x:Event.pointerX(e)-(f.x*this.faktorXY.x),y:Event.pointerY(e)-(f.y*this.faktorXY.y)};this.offsetScroll={x:this.scrollNode.scrollLeft,y:this.scrollNode.scrollTop};this.dragCallback=ORYX.Core.UIDragCallback.bind(this);this.disableCallback=ORYX.Core.UIDisableDrag.bind(this);this.movedCallback=c?c.movedCallback:undefined;this.upCallback=c?c.upCallback:undefined;document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.disableCallback,true);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.dragCallback,false)};ORYX.Core.UIDragCallback=function(b){var a={x:Event.pointerX(b)-this.offSetPosition.x,y:Event.pointerY(b)-this.offSetPosition.y};a.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;a.y-=this.offsetScroll.y-this.scrollNode.scrollTop;a.x/=this.faktorXY.x;a.y/=this.faktorXY.y;this.uiObj.bounds.moveTo(a);if(this.movedCallback){this.movedCallback(b)}Event.stop(b)};ORYX.Core.UIDisableDrag=function(a){document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.dragCallback,false);document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.disableCallback,true);if(this.upCallback){this.upCallback(a)}this.upCallback=undefined;this.movedCallback=undefined;Event.stop(a)};if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.Shape={construct:function(a,b){arguments.callee.$.construct.apply(this,arguments);this.dockers=[];this.magnets=[];this._defaultMagnet;this.incoming=[];this.outgoing=[];this.nodes=[];this._dockerChangedCallback=this._dockerChanged.bind(this);this._labels=new Hash();this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g",{id:this.id},["g",{"class":"stencils"},["g",{"class":"me"}],["g",{"class":"children",style:"overflow:hidden"}],["g",{"class":"edge"}]],["g",{"class":"controls"},["g",{"class":"dockers"}],["g",{"class":"magnets"}]]])},update:function(){},_update:function(){},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);if(this.node.ownerDocument){var a=this;this.propertiesChanged.each((function(b){if(b.value){var e=this.properties[b.key];var d=this.getStencil().property(b.key);this.propertiesChanged[b.key]=false;if(d.type()==ORYX.CONFIG.TYPE_CHOICE){d.refToView().each((function(g){if(g!==""){var f=this._labels[this.id+g];if(f){if("undefined"==typeof(d.item(e))||!d.item(e)){f.text(d.value())}else{f.text(d.item(e).value())}}}}).bind(this));var c=new Hash();d.items().each((function(f){f.refToView().each((function(g){if(g==""){this.propertiesChanged[b.key]=true;return}var h=this.node.ownerDocument.getElementById(this.id+g);if(!h){this.propertiesChanged[b.key]=true;return}if(!c[h.id]||e==f.value()){h.setAttributeNS(null,"display",((e==f.value())?"inherit":"none"));c[h.id]=h}if(ORYX.Editor.checkClassType(h,SVGImageElement)){h.setAttributeNS("http://www.w3.org/1999/xlink","href",h.getAttributeNS("http://www.w3.org/1999/xlink","href"))}}).bind(this))}).bind(this))}else{d.refToView().each((function(k){if(k===""){this.propertiesChanged[b.key]=true;return}var m=this.id+k;var h=this.node.ownerDocument.getElementById(m);if(!h||!(h.ownerSVGElement)){if(d.type()===ORYX.CONFIG.TYPE_URL||d.type()===ORYX.CONFIG.TYPE_DIAGRAM_LINK){var o=this.node.ownerDocument.getElementsByTagNameNS("http://www.w3.org/2000/svg","a");h=$A(o).find(function(p){return p.getAttributeNS(null,"id")===m});if(!h){this.propertiesChanged[b.key]=true;return}}else{this.propertiesChanged[b.key]=true;return}}if(d.complexAttributeToView()){var g=this._labels[m];if(g){try{propJson=e.evalJSON();var l=propJson[d.complexAttributeToView()];g.text(l?l:e)}catch(n){g.text(e)}}}else{switch(d.type()){case ORYX.CONFIG.TYPE_BOOLEAN:if(typeof e=="string"){e=e==="true"}h.setAttributeNS(null,"display",(!(e===d.inverseBoolean()))?"inherit":"none");break;case ORYX.CONFIG.TYPE_COLOR:if(d.fill()){if(h.tagName.toLowerCase()==="stop"){h.setAttributeNS(null,"stop-color",e);if(h.parentNode.tagName.toLowerCase()==="radialgradient"){ORYX.Utils.adjustGradient(h.parentNode,h)}}else{h.setAttributeNS(null,"fill",e)}}if(d.stroke()){h.setAttributeNS(null,"stroke",e)}break;case ORYX.CONFIG.TYPE_STRING:var g=this._labels[m];if(g){g.text(e)}break;case ORYX.CONFIG.TYPE_INTEGER:var g=this._labels[m];if(g){g.text(e)}break;case ORYX.CONFIG.TYPE_FLOAT:if(d.fillOpacity()){h.setAttributeNS(null,"fill-opacity",e)}if(d.strokeOpacity()){h.setAttributeNS(null,"stroke-opacity",e)}if(!d.fillOpacity()&&!d.strokeOpacity()){var g=this._labels[m];if(g){g.text(e)}}break;case ORYX.CONFIG.TYPE_URL:case ORYX.CONFIG.TYPE_DIAGRAM_LINK:var f=h.getAttributeNodeNS("http://www.w3.org/1999/xlink","xlink:href");if(f){f.textContent=e}else{h.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",e)}break}}}).bind(this))}}}).bind(this));this._labels.values().each(function(b){b.update()})}},layout:function(){var a=this.getStencil().layout();if(this instanceof ORYX.Core.Node&&a){a.each(function(b){b.shape=this;b.forceExecution=true;this._delegateEvent(b)}.bind(this))}},getLabels:function(){return this._labels.values()},getDockers:function(){return this.dockers},getMagnets:function(){return this.magnets},getDefaultMagnet:function(){if(this._defaultMagnet){return this._defaultMagnet}else{if(this.magnets.length>0){return this.magnets[0]}else{return undefined}}},getParentShape:function(){return this.parent},getIncomingShapes:function(a){if(a){this.incoming.each(a)}return this.incoming},getIncomingNodes:function(a){return this.incoming.select(function(b){var c=(b instanceof ORYX.Core.Node);if(c&&a){a(b)}return c})},getOutgoingShapes:function(a){if(a){this.outgoing.each(a)}return this.outgoing},getOutgoingNodes:function(a){return this.outgoing.select(function(b){var c=(b instanceof ORYX.Core.Node);if(c&&a){a(b)}return c})},getAllDockedShapes:function(b){var a=this.incoming.concat(this.outgoing);if(b){a.each(b)}return a},getCanvas:function(){if(this.parent instanceof ORYX.Core.Canvas){return this.parent}else{if(this.parent instanceof ORYX.Core.Shape){return this.parent.getCanvas()}else{return undefined}}},getChildNodes:function(b,c){if(!b&&!c){return this.nodes.clone()}else{var a=[];this.nodes.each(function(d){if(!d.isVisible){return}if(c){c(d)}a.push(d);if(b&&d instanceof ORYX.Core.Shape){a=a.concat(d.getChildNodes(b,c))}});return a}},add:function(b,c){if(b instanceof ORYX.Core.UIObject&&!(b instanceof ORYX.Core.Edge)){if(!(this.children.member(b))){if(b.parent){b.parent.remove(b)}if(c!=undefined){this.children.splice(c,0,b)}else{this.children.push(b)}b.parent=this;var d;if(b instanceof ORYX.Core.Node){d=this.node.childNodes[0].childNodes[1];this.nodes.push(b)}else{if(b instanceof ORYX.Core.Controls.Control){var a=this.node.childNodes[1];if(b instanceof ORYX.Core.Controls.Docker){d=a.childNodes[0];if(this.dockers.length>=2){this.dockers.splice(c!==undefined?Math.min(c,this.dockers.length-1):this.dockers.length-1,0,b)}else{this.dockers.push(b)}}else{if(b instanceof ORYX.Core.Controls.Magnet){d=a.childNodes[1];this.magnets.push(b)}else{d=a}}}else{d=this.node}}if(c!=undefined&&c<d.childNodes.length){b.node=d.insertBefore(b.node,d.childNodes[c])}else{b.node=d.appendChild(b.node)}this._changed();if(this.eventHandlerCallback){this.eventHandlerCallback({type:ORYX.CONFIG.EVENT_SHAPEADDED,shape:b})}}else{ORYX.Log.warn("add: ORYX.Core.UIObject is already a child of this object.")}}else{ORYX.Log.warn("add: Parameter is not of type ORYX.Core.UIObject.")}},remove:function(a){if(this.children.member(a)){this.children=this.children.without(a);a.parent=undefined;if(a instanceof ORYX.Core.Shape){if(a instanceof ORYX.Core.Edge){a.removeMarkers();a.node=this.node.childNodes[0].childNodes[2].removeChild(a.node)}else{a.node=this.node.childNodes[0].childNodes[1].removeChild(a.node);this.nodes=this.nodes.without(a)}}else{if(a instanceof ORYX.Core.Controls.Control){if(a instanceof ORYX.Core.Controls.Docker){a.node=this.node.childNodes[1].childNodes[0].removeChild(a.node);this.dockers=this.dockers.without(a)}else{if(a instanceof ORYX.Core.Controls.Magnet){a.node=this.node.childNodes[1].childNodes[1].removeChild(a.node);this.magnets=this.magnets.without(a)}else{a.node=this.node.childNodes[1].removeChild(a.node)}}}}this._changed()}else{ORYX.Log.warn("remove: ORYX.Core.UIObject is not a child of this object.")}},getIntersectionPoint:function(){var p,o,h,g;switch(arguments.length){case 2:p=arguments[0].x;o=arguments[0].y;h=arguments[1].x;g=arguments[1].y;break;case 4:p=arguments[0];o=arguments[1];h=arguments[2];g=arguments[3];break;default:throw"getIntersectionPoints needs two or four arguments"}var d,b,e,c;var a=this.absoluteBounds();if(this.isPointIncluded(p,o,a)){d=p;b=o}else{e=p;c=o}if(this.isPointIncluded(h,g,a)){d=h;b=g}else{e=h;c=g}if(!d||!b||!e||!c){return undefined}var n=0;var m=0;var r,q;var l=1;var k=0;while(true){var n=Math.min(d,e)+((Math.max(d,e)-Math.min(d,e))/2);var m=Math.min(b,c)+((Math.max(b,c)-Math.min(b,c))/2);if(this.isPointIncluded(n,m,a)){d=n;b=m}else{e=n;c=m}var f=Math.sqrt(Math.pow(d-e,2)+Math.pow(b-c,2));r=d+((e-d)/f),q=b+((c-b)/f);if(!this.isPointIncluded(r,q,a)){break}}return{x:r,y:q}},isPointIncluded:function(){return false},isPointOverOffset:function(){return this.isPointIncluded.apply(this,arguments)},_dockerChanged:function(){},createDocker:function(b,a){var c=new ORYX.Core.Controls.Docker({eventHandlerCallback:this.eventHandlerCallback});c.bounds.registerCallback(this._dockerChangedCallback);if(a){c.bounds.centerMoveTo(a)}this.add(c,b);return c},serialize:function(){var a=arguments.callee.$.serialize.apply(this);a.push({name:"bounds",prefix:"oryx",value:this.bounds.serializeForERDF(),type:"literal"});this.getOutgoingShapes().each((function(b){a.push({name:"outgoing",prefix:"raziel",value:"#"+ERDF.__stripHashes(b.resourceId),type:"resource"})}).bind(this));a.push({name:"parent",prefix:"raziel",value:"#"+ERDF.__stripHashes(this.parent.resourceId),type:"resource"});return a},deserialize:function(c){arguments.callee.$.deserialize.apply(this,arguments);var d=c.find(function(b){return(b.prefix+"-"+b.name)=="oryx-bounds"});if(d){var a=d.value.replace(/,/g," ").split(" ").without("");if(this instanceof ORYX.Core.Edge){this.dockers.first().bounds.centerMoveTo(parseFloat(a[0]),parseFloat(a[1]));this.dockers.last().bounds.centerMoveTo(parseFloat(a[2]),parseFloat(a[3]))}else{this.bounds.set(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]))}}},_init:function(a){this._adjustIds(a,0)},_adjustIds:function(c,e){if(c instanceof Element){var a=c.getAttributeNS(null,"id");if(a&&a!==""){c.setAttributeNS(null,"id",this.id+a)}else{c.setAttributeNS(null,"id",this.id+"_"+this.id+"_"+e);e++}var d=c.getAttributeNS(null,"fill");if(d&&d.include("url(#")){d=d.replace(/url\(#/g,"url(#"+this.id);c.setAttributeNS(null,"fill",d)}if(c.hasChildNodes()){for(var b=0;b<c.childNodes.length;b++){e=this._adjustIds(c.childNodes[b],e)}}}return e},toString:function(){return"ORYX.Core.Shape "+this.getId()}};ORYX.Core.Shape=ORYX.Core.AbstractShape.extend(ORYX.Core.Shape);if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.Controls){ORYX.Core.Controls={}}ORYX.Core.Controls.Control=ORYX.Core.UIObject.extend({toString:function(){return"Control "+this.id}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.Controls){ORYX.Core.Controls={}}ORYX.Core.Controls.Docker=ORYX.Core.Controls.Control.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.isMovable=true;this.bounds.set(0,0,16,16);this.referencePoint=undefined;this._dockedShapeBounds=undefined;this._dockedShape=undefined;this._oldRefPoint1=undefined;this._oldRefPoint2=undefined;this.anchorLeft;this.anchorRight;this.anchorTop;this.anchorBottom;this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g"]);this._dockerNode=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["g",{"pointer-events":"all"},["circle",{cx:"8",cy:"8",r:"8",stroke:"none",fill:"none"}],["circle",{cx:"8",cy:"8",r:"3",stroke:"black",fill:"red","stroke-width":"1"}]]);this._referencePointNode=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["g",{"pointer-events":"none"},["circle",{cx:this.bounds.upperLeft().x,cy:this.bounds.upperLeft().y,r:3,fill:"red","fill-opacity":0.4}]]);this.hide();this.addEventHandlers(this.node);this._updateCallback=this._changed.bind(this)},update:function(){if(this._dockedShape){if(this._dockedShapeBounds&&this._dockedShape instanceof ORYX.Core.Node){var g=this._dockedShapeBounds.width();var d=this._dockedShapeBounds.height();if(!g){g=1}if(!d){d=1}var o=this._dockedShape.bounds.width()/g;var m=this._dockedShape.bounds.height()/d;if(o!==1||m!==1){this.referencePoint.x*=o;this.referencePoint.y*=m}this._dockedShapeBounds=this._dockedShape.bounds.clone()}var b=this.parent.dockers.indexOf(this);var f=this;var e=this.parent.dockers.length>1?(b===0?this.parent.dockers[b+1]:this.parent.dockers[b-1]):undefined;var n=f.getDockedShape()?f.getAbsoluteReferencePoint():f.bounds.center();var k=e&&e.getDockedShape()?e.getAbsoluteReferencePoint():e?e.bounds.center():undefined;if(!k){var a=this._dockedShape.absoluteCenterXY();var l=this._dockedShape.bounds.width()*this._dockedShape.bounds.height();k={x:n.x+(a.x-n.x)*-l,y:n.y+(a.y-n.y)*-l}}var c=undefined;c=this._dockedShape.getIntersectionPoint(n,k);if(!c){c=this.getAbsoluteReferencePoint()}if(this.parent&&this.parent.parent){var h=this.parent.parent.absoluteXY();c.x-=h.x;c.y-=h.y}this.bounds.centerMoveTo(c);this._oldRefPoint1=n;this._oldRefPoint2=k}arguments.callee.$.update.apply(this,arguments)},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var a=this.bounds.upperLeft();this._dockerNode.setAttributeNS(null,"transform","translate("+a.x+", "+a.y+")");a=Object.clone(this.referencePoint);if(a&&this._dockedShape){var b;if(this.parent instanceof ORYX.Core.Edge){b=this._dockedShape.absoluteXY()}else{b=this._dockedShape.bounds.upperLeft()}a.x+=b.x;a.y+=b.y}else{a=this.bounds.center()}this._referencePointNode.setAttributeNS(null,"transform","translate("+a.x+", "+a.y+")")},setReferencePoint:function(a){if(this.referencePoint!==a&&(!this.referencePoint||!a||this.referencePoint.x!==a.x||this.referencePoint.y!==a.y)){this.referencePoint=a;this._changed()}},getAbsoluteReferencePoint:function(){if(!this.referencePoint||!this._dockedShape){return undefined}else{var a=this._dockedShape.absoluteXY();return{x:this.referencePoint.x+a.x,y:this.referencePoint.y+a.y}}},setDockedShape:function(b){if(this._dockedShape){this._dockedShape.bounds.unregisterCallback(this._updateCallback);if(this===this.parent.dockers.first()){this.parent.incoming=this.parent.incoming.without(this._dockedShape);this._dockedShape.outgoing=this._dockedShape.outgoing.without(this.parent)}else{if(this===this.parent.dockers.last()){this.parent.outgoing=this.parent.outgoing.without(this._dockedShape);this._dockedShape.incoming=this._dockedShape.incoming.without(this.parent)}}}this._dockedShape=b;this._dockedShapeBounds=undefined;var a=undefined;if(this._dockedShape){if(this===this.parent.dockers.first()){this.parent.incoming.push(b);b.outgoing.push(this.parent)}else{if(this===this.parent.dockers.last()){this.parent.outgoing.push(b);b.incoming.push(this.parent)}}var c=this.bounds;var d=b.absoluteXY();a={x:c.center().x-d.x,y:c.center().y-d.y};this._dockedShapeBounds=this._dockedShape.bounds.clone();this._dockedShape.bounds.registerCallback(this._updateCallback);this.setDockerColor(ORYX.CONFIG.DOCKER_DOCKED_COLOR)}else{this.setDockerColor(ORYX.CONFIG.DOCKER_UNDOCKED_COLOR)}this.setReferencePoint(a);this._changed()},getDockedShape:function(){return this._dockedShape},isDocked:function(){return !!this._dockedShape},setDockerColor:function(a){this._dockerNode.lastChild.setAttributeNS(null,"fill",a)},hide:function(){this.node.setAttributeNS(null,"visibility","hidden");this.children.each(function(a){a.hide()})},show:function(){this.node.setAttributeNS(null,"visibility","visible");this.children.each(function(a){a.show()})},toString:function(){return"Docker "+this.id}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}if(!ORYX.Core.Controls){ORYX.Core.Controls={}}ORYX.Core.Controls.Magnet=ORYX.Core.Controls.Control.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.anchorLeft;this.anchorRight;this.anchorTop;this.anchorBottom;this.bounds.set(0,0,16,16);this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g",{"pointer-events":"all"},["circle",{cx:"8",cy:"8",r:"4",stroke:"none",fill:"red","fill-opacity":"0.3"}],]);this.hide()},update:function(){arguments.callee.$.update.apply(this,arguments)},_update:function(){arguments.callee.$.update.apply(this,arguments)},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var a=this.bounds.upperLeft();this.node.setAttributeNS(null,"transform","translate("+a.x+", "+a.y+")")},show:function(){arguments.callee.$.show.apply(this,arguments)},toString:function(){return"Magnet "+this.id}});if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.Node={construct:function(a,b){arguments.callee.$.construct.apply(this,arguments);this.isSelectable=true;this.isMovable=true;this._dockerUpdated=false;this._oldBounds=new ORYX.Core.Bounds();this._svgShapes=[];this.minimumSize=undefined;this.maximumSize=undefined;this.isHorizontallyResizable=false;this.isVerticallyResizable=false;this.dataId=undefined;this._init(this._stencil.view())},_update:function(){this.dockers.invoke("update");if(this.isChanged){var c=this.bounds;var d=this._oldBounds;if(this.isResized){var o=c.width()/d.width();var n=c.height()/d.height();this._svgShapes.each(function(w){if(w.isHorizontallyResizable){w.width=w.oldWidth*o}if(w.isVerticallyResizable){w.height=w.oldHeight*n}var v;var s=w.anchorLeft;var u=w.anchorRight;if(u){v=d.width()-(w.oldX+w.oldWidth);if(s){w.width=c.width()-w.x-v}else{w.x=c.width()-(v+w.width)}}else{if(!s){w.x=o*w.oldX;if(!w.isHorizontallyResizable){w.x=w.x+w.width*o/2-w.width/2}}}var p=w.anchorTop;var t=w.anchorBottom;if(t){v=d.height()-(w.oldY+w.oldHeight);if(p){w.height=c.height()-w.y-v}else{if(!w._isYLocked){w.y=c.height()-(v+w.height)}}}else{if(!p){w.y=n*w.oldY;if(!w.isVerticallyResizable){w.y=w.y+w.height*n/2-w.height/2}}}});var g={x:0,y:0};if(!this.isHorizontallyResizable&&c.width()!==d.width()){g.x=d.width()-c.width()}if(!this.isVerticallyResizable&&c.height()!==d.height()){g.y=d.height()-c.height()}if(g.x!==0||g.y!==0){c.extend(g)}g={x:0,y:0};var e,k;if(this.minimumSize){ORYX.Log.debug("Shape (%0)'s min size: (%1x%2)",this,this.minimumSize.width,this.minimumSize.height);e=this.minimumSize.width-c.width();if(e>0){g.x+=e}k=this.minimumSize.height-c.height();if(k>0){g.y+=k}}if(this.maximumSize){ORYX.Log.debug("Shape (%0)'s max size: (%1x%2)",this,this.maximumSize.width,this.maximumSize.height);e=c.width()-this.maximumSize.width;if(e>0){g.x-=e}k=c.height()-this.maximumSize.height;if(k>0){g.y-=k}}if(g.x!==0||g.y!==0){c.extend(g)}var o=c.width()/d.width();var n=c.height()/d.height();var m,l,q,f,b,a,r;this.magnets.each(function(p){m=p.anchorLeft;l=p.anchorRight;q=p.anchorTop;f=p.anchorBottom;b=p.bounds.center();if(m){a=b.x}else{if(l){a=c.width()-(d.width()-b.x)}else{a=b.x*o}}if(q){r=b.y}else{if(f){r=c.height()-(d.height()-b.y)}else{r=b.y*n}}if(b.x!==a||b.y!==r){p.bounds.centerMoveTo(a,r)}});this.getLabels().each(function(p){m=p.anchorLeft;l=p.anchorRight;q=p.anchorTop;f=p.anchorBottom;if(m){}else{if(l){p.x=c.width()-(d.width()-p.oldX)}else{p.x*=o}}if(q){}else{if(f){p.y=c.height()-(d.height()-p.oldY)}else{p.y*=n}}});var h=this.dockers[0];if(h){h.bounds.unregisterCallback(this._dockerChangedCallback);if(!this._dockerUpdated){h.bounds.centerMoveTo(this.bounds.center());this._dockerUpdated=false}h.update();h.bounds.registerCallback(this._dockerChangedCallback)}this.isResized=false}this.refresh();this.isChanged=false;this._oldBounds=this.bounds.clone()}this.children.each(function(p){if(!(p instanceof ORYX.Core.Controls.Docker)){p._update()}});if(this.dockers.length>0&&!this.dockers.first().getDockedShape()){this.dockers.each(function(p){p.bounds.centerMoveTo(this.bounds.center())}.bind(this))}},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var a=this.bounds.upperLeft().x;var b=this.bounds.upperLeft().y;this.node.firstChild.setAttributeNS(null,"transform","translate("+a+", "+b+")");this.node.childNodes[1].childNodes[1].setAttributeNS(null,"transform","translate("+a+", "+b+")");this._svgShapes.each(function(c){c.update()})},_dockerChanged:function(){var a=this.dockers[0];this.bounds.centerMoveTo(a.bounds.center());this._dockerUpdated=true},_initSVGShapes:function(c){var a=[];try{var f=new ORYX.Core.SVG.SVGShape(c);a.push(f)}catch(d){}if(c.hasChildNodes()){for(var b=0;b<c.childNodes.length;b++){a=a.concat(this._initSVGShapes(c.childNodes[b]))}}return a},isPointIncluded:function(a,k,c){var h=c&&c instanceof ORYX.Core.Bounds?c:this.absoluteBounds();if(!h.isIncluded(a,k)){return false}else{}var e=h.upperLeft();var g=a-e.x;var f=k-e.y;var d=0;do{var b=this._svgShapes[d++].isPointIncluded(g,f)}while(!b&&d<this._svgShapes.length);return b},isPointOverOffset:function(d,c){var b=arguments.callee.$.isPointOverOffset.apply(this,arguments);if(b){var a=this.absoluteBounds();a.widen(-ORYX.CONFIG.BORDER_OFFSET);if(!a.isIncluded(d,c)){return true}}return false},serialize:function(){var a=arguments.callee.$.serialize.apply(this);this.dockers.each((function(e){if(e.getDockedShape()){var d=e.referencePoint;d=d?d:e.bounds.center();a.push({name:"docker",prefix:"oryx",value:$H(d).values().join(","),type:"literal"})}}).bind(this));try{var b=this.getStencil().serialize();if(b.type){b.shape=this;b.data=a;b.result=undefined;b.forceExecution=true;this._delegateEvent(b);if(b.result){a=b.result}}}catch(c){}return a},deserialize:function(f){arguments.callee.$.deserialize.apply(this,[f]);try{var a=this.getStencil().deserialize();if(a.type){a.shape=this;a.data=f;a.result=undefined;a.forceExecution=true;this._delegateEvent(a);if(a.result){f=a.result}}}catch(g){}var b=f.findAll(function(e){return(e.prefix+"-"+e.name)=="raziel-outgoing"});b.each((function(h){if(!this.parent){return}var e=this.getCanvas().getChildShapeByResourceId(h.value);if(e){if(e instanceof ORYX.Core.Edge){e.dockers.first().setDockedShape(this);e.dockers.first().setReferencePoint(e.dockers.first().bounds.center())}else{if(e.dockers.length>0){e.dockers.first().setDockedShape(this)}}}}).bind(this));if(this.dockers.length===1){var d;d=f.find(function(e){return(e.prefix+"-"+e.name==="oryx-dockers")});if(d){var c=d.value.replace(/,/g," ").split(" ").without("").without("#");if(c.length===2&&this.dockers[0].getDockedShape()){this.dockers[0].setReferencePoint({x:parseFloat(c[0]),y:parseFloat(c[1])})}else{this.dockers[0].bounds.centerMoveTo(parseFloat(c[0]),parseFloat(c[1]))}}}},_init:function(n){arguments.callee.$._init.apply(this,arguments);var o=n.getElementsByTagName("g")[0];var r=n.ownerDocument.createAttributeNS(null,"title");r.nodeValue=this.getStencil().title();o.setAttributeNode(r);var u=n.ownerDocument.createAttributeNS(null,"id");u.nodeValue=this.id;o.setAttributeNode(u);var b=this.node.childNodes[0].childNodes[0];o=b.appendChild(o);this.addEventHandlers(o);var t=o.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"minimumSize");if(t){t=t.replace("/,/g"," ");var k=t.split(" ");k=k.without("");if(k.length>1){this.minimumSize={width:parseFloat(k[0]),height:parseFloat(k[1])}}else{this.minimumSize={width:1,height:1}}}var g=o.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"maximumSize");if(g){g=g.replace("/,/g"," ");var l=g.split(" ");l=l.without("");if(l.length>1){this.maximumSize={width:parseFloat(l[0]),height:parseFloat(l[1])}}}if(this.minimumSize&&this.maximumSize&&(this.minimumSize.width>this.maximumSize.width||this.minimumSize.height>this.maximumSize.height)){throw this+": Minimum Size must be greater than maxiumSize."}this._svgShapes=this._initSVGShapes(o);var a={x:undefined,y:undefined};var d={x:undefined,y:undefined};var y=this;this._svgShapes.each(function(z){a.x=(a.x!==undefined)?Math.min(a.x,z.x):z.x;a.y=(a.y!==undefined)?Math.min(a.y,z.y):z.y;d.x=(d.x!==undefined)?Math.max(d.x,z.x+z.width):z.x+z.width;d.y=(d.y!==undefined)?Math.max(d.y,z.y+z.height):z.y+z.height;if(z.isHorizontallyResizable){y.isHorizontallyResizable=true;y.isResizable=true}if(z.isVerticallyResizable){y.isVerticallyResizable=true;y.isResizable=true}if(z.anchorTop&&z.anchorBottom){y.isVerticallyResizable=true;y.isResizable=true}if(z.anchorLeft&&z.anchorRight){y.isHorizontallyResizable=true;y.isResizable=true}});this._svgShapes.each(function(z){z.x-=a.x;z.y-=a.y;z.update()});var x=a.x;var w=a.y;d.x-=x;d.y-=w;a.x=0;a.y=0;if(d.x===0){d.x=1}if(d.y===0){d.y=1}this._oldBounds.set(a,d);this.bounds.set(a,d);var f=n.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_ORYX,"magnets");if(f&&f.length>0){f=$A(f[0].getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_ORYX,"magnet"));var y=this;f.each(function(A){var E=new ORYX.Core.Controls.Magnet({eventHandlerCallback:y.eventHandlerCallback});var z=parseFloat(A.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cx"));var F=parseFloat(A.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cy"));E.bounds.centerMoveTo({x:z-x,y:F-w});var D=A.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"anchors");if(D){D=D.replace("/,/g"," ");D=D.split(" ").without("");for(var B=0;B<D.length;B++){switch(D[B].toLowerCase()){case"left":E.anchorLeft=true;break;case"right":E.anchorRight=true;break;case"top":E.anchorTop=true;break;case"bottom":E.anchorBottom=true;break}}}y.add(E);if(!this._defaultMagnet){var C=A.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"default");if(C&&C.toLowerCase()==="yes"){y._defaultMagnet=E}}})}else{var h=new ORYX.Core.Controls.Magnet();h.bounds.centerMoveTo(this.bounds.width()/2,this.bounds.height()/2);this.add(h)}var s=n.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_ORYX,"docker");if(s&&s.length>0){s=s[0];var q=this.createDocker();var e=parseFloat(s.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cx"));var c=parseFloat(s.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"cy"));q.bounds.centerMoveTo({x:e-x,y:c-w});var p=s.getAttributeNS(ORYX.CONFIG.NAMESPACE_ORYX,"anchors");if(p){p=p.replace("/,/g"," ");p=p.split(" ").without("");for(var v=0;v<p.length;v++){switch(p[v].toLowerCase()){case"left":q.anchorLeft=true;break;case"right":q.anchorRight=true;break;case"top":q.anchorTop=true;break;case"bottom":q.anchorBottom=true;break}}}}var m=o.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"text");$A(m).each((function(A){var z=new ORYX.Core.SVG.Label({textElement:A,shapeId:this.id});z.x-=x;z.y-=w;this._labels[z.id]=z}).bind(this))},createDocker:function(){var a=new ORYX.Core.Controls.Docker({eventHandlerCallback:this.eventHandlerCallback});a.bounds.registerCallback(this._dockerChangedCallback);this.dockers.push(a);a.parent=this;a.bounds.registerCallback(this._changedCallback);return a},toString:function(){return this._stencil.title()+" "+this.id}};ORYX.Core.Node=ORYX.Core.Shape.extend(ORYX.Core.Node);NAMESPACE_SVG="http://www.w3.org/2000/svg";NAMESPACE_ORYX="http://www.b3mn.org/oryx";if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.Edge={construct:function(a,c){arguments.callee.$.construct.apply(this,arguments);this.isMovable=true;this.isSelectable=true;this._dockerUpdated=false;this._markers=new Hash();this._paths=[];this._interactionPaths=[];this._dockersByPath=new Hash();this._markersByPath=new Hash();this.attachedNodePositionData=new Hash();var b=this.node.childNodes[0].childNodes[0];b=ORYX.Editor.graft("http://www.w3.org/2000/svg",b,["g",{"pointer-events":"painted"}]);this.addEventHandlers(b);this._oldBounds=this.bounds.clone();this._init(this._stencil.view());if(c instanceof Array){this.deserialize(c)}},_update:function(c){if(this._dockerUpdated||this.isChanged||c){this.dockers.invoke("update");if(this.bounds.width()===0||this.bounds.height()===0){this.bounds.moveBy({x:this.bounds.width()===0?-1:0,y:this.bounds.height()===0?-1:0});this.bounds.extend({x:this.bounds.width()===0?2:0,y:this.bounds.height()===0?2:0})}var d=this.bounds.upperLeft();var m=this._oldBounds.upperLeft();var e=this._oldBounds.width()===0?this.bounds.width():this._oldBounds.width();var n=this._oldBounds.height()===0?this.bounds.height():this._oldBounds.height();var l=d.x-m.x;var h=d.y-m.y;var o=this.bounds.width()/e;var f=this.bounds.height()/n;this.dockers.each((function(b){b.bounds.unregisterCallback(this._dockerChangedCallback);if(!this._dockerUpdated){b.bounds.moveBy(l,h);if(o!==1||f!==1){var p=b.bounds.upperLeft().x-d.x;var a=b.bounds.upperLeft().y-d.y;b.bounds.moveTo(d.x+p*o,d.y+a*f)}}b.update();b.bounds.registerCallback(this._dockerChangedCallback)}).bind(this));if(this._dockerUpdated){var k=this.dockers.first().bounds.center();var g=this.dockers.first().bounds.center();this.dockers.each((function(b){var a=b.bounds.center();k.x=Math.min(k.x,a.x);k.y=Math.min(k.y,a.y);g.x=Math.max(g.x,a.x);g.y=Math.max(g.y,a.y)}).bind(this));this.bounds.set(Object.clone(k),Object.clone(g))}this.getLabels().each(function(p){switch(p.edgePosition){case"freeMoved":p.x=p.x;p.y=p.y;break;case"starttop":var t=this._getAngle(this.dockers[0],this.dockers[1]);var u=this.dockers.first().bounds.center();if(t<=90||t>270){p.horizontalAlign("left");p.verticalAlign("bottom");p.x=u.x+p.getOffsetTop();p.y=u.y-p.getOffsetTop();p.rotate(360-t,u)}else{p.horizontalAlign("right");p.verticalAlign("bottom");p.x=u.x-p.getOffsetTop();p.y=u.y-p.getOffsetTop();p.rotate(180-t,u)}break;case"startbottom":var t=this._getAngle(this.dockers[0],this.dockers[1]);var u=this.dockers.first().bounds.center();if(t<=90||t>270){p.horizontalAlign("left");p.verticalAlign("top");p.x=u.x+p.getOffsetBottom();p.y=u.y+p.getOffsetBottom();p.rotate(360-t,u)}else{p.horizontalAlign("right");p.verticalAlign("top");p.x=u.x-p.getOffsetBottom();p.y=u.y+p.getOffsetBottom();p.rotate(180-t,u)}break;case"midtop":var a=this.dockers.length;if(a%2==0){var t=this._getAngle(this.dockers[a/2-1],this.dockers[a/2]);var r=this.dockers[a/2-1].bounds.center();var q=this.dockers[a/2].bounds.center();var u={x:(r.x+q.x)/2,y:(r.y+q.y)/2};p.horizontalAlign("center");p.verticalAlign("bottom");p.x=u.x;p.y=u.y-p.getOffsetTop();if(t<=90||t>270){p.rotate(360-t,u)}else{p.rotate(180-t,u)}}else{var b=parseInt(a/2);var t=this._getAngle(this.dockers[b],this.dockers[b+1]);var u=this.dockers[b].bounds.center();if(t<=90||t>270){p.horizontalAlign("left");p.verticalAlign("bottom");p.x=u.x+p.getOffsetTop();p.y=u.y-p.getOffsetTop();p.rotate(360-t,u)}else{p.horizontalAlign("right");p.verticalAlign("bottom");p.x=u.x-p.getOffsetTop();p.y=u.y-p.getOffsetTop();p.rotate(180-t,u)}}break;case"midbottom":var a=this.dockers.length;if(a%2==0){var t=this._getAngle(this.dockers[a/2-1],this.dockers[a/2]);var r=this.dockers[a/2-1].bounds.center();var q=this.dockers[a/2].bounds.center();var u={x:(r.x+q.x)/2,y:(r.y+q.y)/2};p.horizontalAlign("center");p.verticalAlign("top");p.x=u.x;p.y=u.y+p.getOffsetTop();if(t<=90||t>270){p.rotate(360-t,u)}else{p.rotate(180-t,u)}}else{var b=parseInt(a/2);var t=this._getAngle(this.dockers[b],this.dockers[b+1]);var u=this.dockers[b].bounds.center();if(t<=90||t>270){p.horizontalAlign("left");p.verticalAlign("top");p.x=u.x+p.getOffsetBottom();p.y=u.y+p.getOffsetBottom();p.rotate(360-t,u)}else{p.horizontalAlign("right");p.verticalAlign("top");p.x=u.x-p.getOffsetBottom();p.y=u.y+p.getOffsetBottom();p.rotate(180-t,u)}}break;case"endtop":var s=this.dockers.length;var t=this._getAngle(this.dockers[s-2],this.dockers[s-1]);var u=this.dockers.last().bounds.center();if(t<=90||t>270){p.horizontalAlign("right");p.verticalAlign("bottom");p.x=u.x-p.getOffsetTop();p.y=u.y-p.getOffsetTop();p.rotate(360-t,u)}else{p.horizontalAlign("left");p.verticalAlign("bottom");p.x=u.x+p.getOffsetTop();p.y=u.y-p.getOffsetTop();p.rotate(180-t,u)}break;case"endbottom":var s=this.dockers.length;var t=this._getAngle(this.dockers[s-2],this.dockers[s-1]);var u=this.dockers.last().bounds.center();if(t<=90||t>270){p.horizontalAlign("right");p.verticalAlign("top");p.x=u.x-p.getOffsetBottom();p.y=u.y+p.getOffsetBottom();p.rotate(360-t,u)}else{p.horizontalAlign("left");p.verticalAlign("top");p.x=u.x+p.getOffsetBottom();p.y=u.y+p.getOffsetBottom();p.rotate(180-t,u)}break}}.bind(this));this.children.each(function(a){if(a instanceof ORYX.Core.Node){this.calculatePositionOfAttachedChildNode.call(this,a)}}.bind(this));this.refreshAttachedNodes();this.refresh();this.isChanged=false;this._dockerUpdated=false;this._oldBounds=this.bounds.clone()}},movePointToUpperLeftOfNode:function(a,b){a.x-=b.width()/2;a.y-=b.height()/2},refreshAttachedNodes:function(){this.attachedNodePositionData.values().each(function(a){var d=a.segment.docker1.bounds.center();var b=a.segment.docker2.bounds.center();this.relativizePoint(d);this.relativizePoint(b);var c=new Object();c.x=d.x+a.relativDistanceFromDocker1*(b.x-d.x);c.y=d.y+a.relativDistanceFromDocker1*(b.y-d.y);this.movePointToUpperLeftOfNode(c,a.node.bounds);a.node.bounds.moveTo(c);a.node._update()}.bind(this))},calculatePositionOfAttachedChildNode:function(b){var a=new Object();a.x=0;a.y=0;if(!this.attachedNodePositionData[b.getId()]){this.attachedNodePositionData[b.getId()]=new Object();this.attachedNodePositionData[b.getId()].relativDistanceFromDocker1=0;this.attachedNodePositionData[b.getId()].node=b;this.attachedNodePositionData[b.getId()].segment=new Object();this.findEdgeSegmentForNode(b)}else{if(b.isChanged){this.findEdgeSegmentForNode(b)}}},findEdgeSegmentForNode:function(c){var b=this.dockers.length;var a=undefined;for(i=1;i<b;i++){var g=this.dockers[i-1].bounds.center();var e=this.dockers[i].bounds.center();this.relativizePoint(g);this.relativizePoint(e);var d=c.bounds.center();var f=ORYX.Core.Math.distancePointLinie(g,e,d,true);if((f||f==0)&&((!a&&a!=0)||f<a)){a=f;this.attachedNodePositionData[c.getId()].segment.docker1=this.dockers[i-1];this.attachedNodePositionData[c.getId()].segment.docker2=this.dockers[i]}if(!f&&!a&&a!=0){(ORYX.Core.Math.getDistancePointToPoint(d,g)<ORYX.Core.Math.getDistancePointToPoint(d,e))?this.attachedNodePositionData[c.getId()].relativDistanceFromDocker1=0:this.attachedNodePositionData[c.getId()].relativDistanceFromDocker1=1;this.attachedNodePositionData[c.getId()].segment.docker1=this.dockers[i-1];this.attachedNodePositionData[c.getId()].segment.docker2=this.dockers[i]}}if(a||a==0){this.attachedNodePositionData[c.getId()].relativDistanceFromDocker1=this.getLineParameterForPosition(this.attachedNodePositionData[c.getId()].segment.docker1,this.attachedNodePositionData[c.getId()].segment.docker2,c)}},getLineParameterForPosition:function(b,g,d){var f=b.bounds.center();var e=g.bounds.center();this.relativizePoint(f);this.relativizePoint(e);var c=ORYX.Core.Math.getPointOfIntersectionPointLine(f,e,d.bounds.center(),true);if(!c){return 0}var a=ORYX.Core.Math.getDistancePointToPoint(c,f)/ORYX.Core.Math.getDistancePointToPoint(f,e);return a},relativizePoint:function(a){a.x-=this.bounds.upperLeft().x;a.y-=this.bounds.upperLeft().y},refresh:function(){arguments.callee.$.refresh.apply(this,arguments);var b;this._paths.each((function(h,f){var e=this._dockersByPath[h.id];var l=undefined;var k=undefined;if(b){k="M"+b.x+" "+b.y}else{l=e[0].bounds.center();b=l;k="M"+l.x+" "+l.y}for(var g=1;g<e.length;g++){l=e[g].bounds.center();k=k+"L"+l.x+" "+l.y+" ";b=l}h.setAttributeNS(null,"d",k);this._interactionPaths[f].setAttributeNS(null,"d",k)}).bind(this));if(this.getChildNodes().length>0){var a=this.bounds.upperLeft().x;var c=this.bounds.upperLeft().y;this.node.firstChild.childNodes[1].setAttributeNS(null,"transform","translate("+a+", "+c+")")}},getIntersectionPoint:function(){var a=Math.floor(this.dockers.length/2);return ORYX.Core.Math.midPoint(this.dockers[a-1].bounds.center(),this.dockers[a].bounds.center())},isPointIncluded:function(g,f){var a=this.absoluteBounds().isIncluded(g,f,ORYX.CONFIG.OFFSET_EDGE_BOUNDS);var e=undefined;if(a&&this.dockers.length>0){var c=0;var d,b;do{d=this.dockers[c].bounds.center();b=this.dockers[++c].bounds.center();e=ORYX.Core.Math.isPointInLine(g,f,d.x,d.y,b.x,b.y,ORYX.CONFIG.OFFSET_EDGE_BOUNDS)}while(!e&&c<this.dockers.length-1)}return e},isPointOverOffset:function(){return false},_getAngle:function(a,e){var d=a.absoluteCenterXY();var b=e.absoluteCenterXY();if(d.x==b.x&&d.y==b.y){return 0}var c=Math.asin(Math.sqrt(Math.pow(d.y-b.y,2))/(Math.sqrt(Math.pow(b.x-d.x,2)+Math.pow(d.y-b.y,2))))*180/Math.PI;if(b.x>=d.x&&b.y<=d.y){return c}else{if(b.x<d.x&&b.y<=d.y){return 180-c}else{if(b.x<d.x&&b.y>d.y){return 180+c}else{return 360-c}}}},alignDockers:function(){this._update(true);var e=this.dockers.first().bounds.center();var d=this.dockers.last().bounds.center();var c=d.x-e.x;var a=d.y-e.y;var b=this.dockers.length-1;this.dockers.each((function(h,g){var f=g/b;h.bounds.unregisterCallback(this._dockerChangedCallback);h.bounds.moveTo(e.x+f*c,e.y+f*a);h.bounds.registerCallback(this._dockerChangedCallback)}).bind(this));this._dockerChanged()},add:function(a){arguments.callee.$.add.apply(this,arguments);if(a instanceof ORYX.Core.Controls.Docker&&this.dockers.include(a)){var b=this._dockersByPath.values()[0];if(b){b.splice(this.dockers.indexOf(a),0,a)}this.handleChildShapesAfterAddDocker(a)}},handleChildShapesAfterAddDocker:function(f){if(!f instanceof ORYX.Core.Controls.Docker){return undefined}var d=this.dockers.indexOf(f);if(!(0<d&&d<this.dockers.length-1)){return undefined}var e=this.dockers[d-1];var b=this.dockers[d+1];var c=this.getAttachedNodePositionDataForSegment(e,b);var a=ORYX.Core.Math.getDistancePointToPoint(e.bounds.center(),f.bounds.center());var h=ORYX.Core.Math.getDistancePointToPoint(b.bounds.center(),f.bounds.center());if(!(a+h)){return}var g=a/(a+h);c.each(function(m){if(m.value.relativDistanceFromDocker1<g){m.value.segment.docker2=f;m.value.relativDistanceFromDocker1=m.value.relativDistanceFromDocker1/g}else{m.value.segment.docker1=f;var l=1-g;var k=m.value.relativDistanceFromDocker1-g;m.value.relativDistanceFromDocker1=k/l}});this.refreshAttachedNodes()},getAttachedNodePositionDataForSegment:function(c,a){if(!((c instanceof ORYX.Core.Controls.Docker)&&(a instanceof ORYX.Core.Controls.Docker))){return[]}var b=this.attachedNodePositionData.findAll(function(d){return d.value.segment.docker1===c&&d.value.segment.docker2===a});if(!b){return[]}return b},remove:function(a){arguments.callee.$.remove.apply(this,arguments);if(this.attachedNodePositionData[a.getId()]){delete this.attachedNodePositionData[a.getId()]}if(a instanceof ORYX.Core.Controls.Docker){this.handleChildShapesAfterRemoveDocker(a)}},handleChildShapesAfterRemoveDocker:function(a){if(!(a instanceof ORYX.Core.Controls.Docker)){return}this.attachedNodePositionData.each(function(c){if(c.value.segment.docker1===a){var b=this.dockers.indexOf(c.value.segment.docker2);if(b==-1){return}c.value.segment.docker1=this.dockers[b-1]}else{if(c.value.segment.docker2===a){var b=this.dockers.indexOf(c.value.segment.docker1);if(b==-1){return}c.value.segment.docker2=this.dockers[b+1]}}}.bind(this));this.refreshAttachedNodes()},addDocker:function(b,d){var c;var a;this._dockersByPath.any((function(e){return e.value.any((function(k,f){if(!c){c=k;return false}else{var h=c.bounds.center();var g=k.bounds.center();if(ORYX.Core.Math.isPointInLine(b.x,b.y,h.x,h.y,g.x,g.y,10)){var m=this._paths.find(function(o){return o.id===e.key});if(m){var n=m.getAttributeNS(NAMESPACE_ORYX,"allowDockers");if(n&&n.toLowerCase()==="no"){return true}}var l=(d)?d:this.createDocker(this.dockers.indexOf(c)+1,b);l.bounds.centerMoveTo(b);if(d){this.add(l,this.dockers.indexOf(c)+1)}a=l;return true}else{c=k;return false}}}).bind(this))}).bind(this));return a},removeDocker:function(a){if(this.dockers.length>2&&!(this.dockers.first()===a)){this._dockersByPath.any((function(b){if(b.value.member(a)){if(a===b.value.last()){return true}else{this.remove(a);this._dockersByPath[b.key]=b.value.without(a);this.isChanged=true;this._dockerChanged();return true}}return false}).bind(this))}},removeUnusedDockers:function(){var a=$H({});this.dockers.each(function(e,b){if(b==0||b==this.dockers.length-1){return}var d=this.dockers[b-1];if(a.values().indexOf(d)!=-1&&this.dockers[b-2]){d=this.dockers[b-2]}var c=this.dockers[b+1];var f=d.getDockedShape()&&d.referencePoint?d.getAbsoluteReferencePoint():d.bounds.center();var h=c.getDockedShape()&&c.referencePoint?c.getAbsoluteReferencePoint():c.bounds.center();var g=e.bounds.center();if(ORYX.Core.Math.isPointInLine(g.x,g.y,f.x,f.y,h.x,h.y,1)){a[b]=e}}.bind(this));a.each(function(b){this.removeDocker(b.value)}.bind(this));if(a.values().length>0){this._update(true)}return a},_init:function(e){arguments.callee.$._init.apply(this,arguments);var d,b,q,o;var h=e.getElementsByTagNameNS(NAMESPACE_SVG,"defs");if(h.length>0){h=h[0];var c=$A(h.getElementsByTagNameNS(NAMESPACE_SVG,"marker"));var k;var n=this;c.each(function(r){try{k=new ORYX.Core.SVG.SVGMarker(r.cloneNode(true));n._markers[k.id]=k;var s=$A(k.element.getElementsByTagNameNS(NAMESPACE_SVG,"text"));var g;s.each(function(u){g=new ORYX.Core.SVG.Label({textElement:u,shapeId:this.id});n._labels[g.id]=g})}catch(t){}})}var a=e.getElementsByTagNameNS(NAMESPACE_SVG,"g");if(a.length<=0){throw"Edge: No g element found."}var l=a[0];l.setAttributeNS(null,"id",null);var f=true;$A(l.childNodes).each((function(E,w){if(ORYX.Editor.checkClassType(E,SVGPathElement)){E=E.cloneNode(false);var v=this.id+"_"+w;E.setAttributeNS(null,"id",v);this._paths.push(E);var A=[];var F=E.getAttributeNS(null,"marker-start");if(F&&F!==""){F=F.strip();F=F.replace(/^url\(#/,"");var u=this.id.concat(F.replace(/\)$/,""));E.setAttributeNS(null,"marker-start","url(#"+u+")");A.push(this._markers[u])}F=E.getAttributeNS(null,"marker-mid");if(F&&F!==""){F=F.strip();F=F.replace(/^url\(#/,"");var r=this.id.concat(F.replace(/\)$/,""));E.setAttributeNS(null,"marker-mid","url(#"+r+")");A.push(this._markers[r])}F=E.getAttributeNS(null,"marker-end");if(F&&F!==""){F=F.strip();F=F.replace(/^url\(#/,"");var z=this.id.concat(F.replace(/\)$/,""));E.setAttributeNS(null,"marker-end","url(#"+z+")");A.push(this._markers[z])}this._markersByPath[v]=A;var g=new PathParser();var D=new ORYX.Core.SVG.PointsPathHandler();g.setHandler(D);g.parsePath(E);if(D.points.length<4){throw"Edge: Path has to have two or more points specified."}this._dockersByPath[v]=[];for(var t=0;t<D.points.length;t+=2){var C=D.points[t];var B=D.points[t+1];if(f||t>0){var s=new ORYX.Core.Controls.Docker({eventHandlerCallback:this.eventHandlerCallback});s.bounds.centerMoveTo(C,B);s.bounds.registerCallback(this._dockerChangedCallback);this.add(s,this.dockers.length);if(d){d=Math.min(C,d);b=Math.min(B,b)}else{d=C;b=B}if(q){q=Math.max(C,q);o=Math.max(B,o)}else{q=C;o=B}}}f=false}}).bind(this));this.bounds.set(d,b,q,o);if(this.bounds.width()===0||this.bounds.height()===0){this.bounds.extend({x:this.bounds.width()===0?2:0,y:this.bounds.height()===0?2:0});this.bounds.moveBy({x:this.bounds.width()===0?-1:0,y:this.bounds.height()===0?-1:0})}this._oldBounds=this.bounds.clone();this._paths.reverse();var p=[];this._paths.each((function(g){p.push(this.node.childNodes[0].childNodes[0].childNodes[0].appendChild(g))}).bind(this));this._paths=p;this._paths.each((function(r){var g=r.cloneNode(false);g.setAttributeNS(null,"id",undefined);g.setAttributeNS(null,"stroke-width",10);g.setAttributeNS(null,"visibility","hidden");g.setAttributeNS(null,"stroke-dasharray",null);g.setAttributeNS(null,"stroke","black");g.setAttributeNS(null,"fill","none");this._interactionPaths.push(this.node.childNodes[0].childNodes[0].childNodes[0].appendChild(g))}).bind(this));this._paths.reverse();this._interactionPaths.reverse();var m=e.getElementsByTagNameNS(ORYX.CONFIG.NAMESPACE_SVG,"text");$A(m).each((function(r){var g=new ORYX.Core.SVG.Label({textElement:r,shapeId:this.id});this.node.childNodes[0].childNodes[0].appendChild(g.node);this._labels[g.id]=g}).bind(this));this.node.childNodes[0].childNodes[0].setAttributeNS(null,"title",this.getStencil().title());this.propertiesChanged.each(function(g){g.value=true})},addMarkers:function(a){this._markers.each(function(b){if(!a.ownerDocument.getElementById(b.value.id)){b.value.element=a.appendChild(b.value.element)}})},removeMarkers:function(){var b=this.node.ownerSVGElement;if(b){var a=b.getElementsByTagNameNS(NAMESPACE_SVG,"defs");if(a.length>0){a=a[0];this._markers.each(function(c){var d=a.ownerDocument.getElementById(c.value.id);if(d){c.value.element=a.removeChild(c.value.element)}})}}},_dockerChanged:function(){this._dockerUpdated=true},serialize:function(){var a=arguments.callee.$.serialize.apply(this);var d="";this._dockersByPath.each((function(e){e.value.each(function(k){var h=k.getDockedShape()&&k.referencePoint?k.referencePoint:k.bounds.center();d=d.concat(h.x+" "+h.y+" ")});d+=" # "}).bind(this));a.push({name:"dockers",prefix:"oryx",value:d,type:"literal"});var b=this.dockers.last();var g=b.getDockedShape();if(g){a.push({name:"target",prefix:"raziel",value:"#"+ERDF.__stripHashes(g.resourceId),type:"resource"})}try{var c=this.getStencil().serialize();if(c.type){c.shape=this;c.data=a;c.result=undefined;c.forceExecution=true;this._delegateEvent(c);if(c.result){a=c.result}}}catch(f){}return a},deserialize:function(f){try{var c=this.getStencil().deserialize();if(c.type){c.shape=this;c.data=f;c.result=undefined;c.forceExecution=true;this._delegateEvent(c);if(c.result){f=c.result}}}catch(h){}var g=f.find(function(e){return(e.prefix+"-"+e.name)=="raziel-target"});var a;if(g){a=this.getCanvas().getChildShapeByResourceId(g.value)}var d=f.findAll(function(e){return(e.prefix+"-"+e.name)=="raziel-outgoing"});d.each((function(l){if(!this.parent){return}var e=this.getCanvas().getChildShapeByResourceId(l.value);if(e){if(e==a){this.dockers.last().setDockedShape(e);this.dockers.last().setReferencePoint({x:e.bounds.width()/2,y:e.bounds.height()/2})}else{if(e instanceof ORYX.Core.Edge){e.dockers.first().setDockedShape(this)}}}}).bind(this));arguments.callee.$.deserialize.apply(this,[f]);var b=f.find(function(e){return(e.prefix==="oryx"&&e.name==="dockers")});if(b){var k=b.value.split("#").without("").without(" ");k.each((function(l,o){var r=l.replace(/,/g," ").split(" ").without("");if(r.length%2===0){var s=this._paths[o];if(s){if(o===0){while(this._dockersByPath[s.id].length>2){this.removeDocker(this._dockersByPath[s.id][1])}}else{while(this._dockersByPath[s.id].length>1){this.removeDocker(this._dockersByPath[s.id][0])}}var e=this._dockersByPath[s.id];if(o===0){var q=parseFloat(r.shift());var p=parseFloat(r.shift());if(e.first().getDockedShape()){e.first().setReferencePoint({x:q,y:p})}else{e.first().bounds.centerMoveTo(q,p)}}p=parseFloat(r.pop());q=parseFloat(r.pop());if(e.last().getDockedShape()){e.last().setReferencePoint({x:q,y:p})}else{e.last().bounds.centerMoveTo(q,p)}for(var m=0;m<r.length;m++){q=parseFloat(r[m]);p=parseFloat(r[++m]);var n=this.createDocker();n.bounds.centerMoveTo(q,p)}}}}).bind(this))}else{this.alignDockers()}this._changed()},toString:function(){return this.getStencil().title()+" "+this.id},getTarget:function(){return this.dockers.last()?this.dockers.last().getDockedShape():null},getSource:function(){return this.dockers.first()?this.dockers.first().getDockedShape():null},isDocked:function(){var a=false;this.dockers.each(function(b){if(b.isDocked()){a=true;throw $break}});return a},toJSON:function(){var a=arguments.callee.$.toJSON.apply(this,arguments);if(this.getTarget()){a.target={resourceId:this.getTarget().resourceId}}return a}};ORYX.Core.Edge=ORYX.Core.Shape.extend(ORYX.Core.Edge);if(!ORYX){var ORYX={}}if(!ORYX.Core){ORYX.Core={}}ORYX.Core.Command=Clazz.extend({construct:function(){},execute:function(){throw"Command.execute() has to be implemented!"},rollback:function(){throw"Command.rollback() has to be implemented!"}});if(!ORYX){var ORYX={}}if(!ORYX.Plugins){ORYX.Plugins={}}ORYX.Plugins.AbstractPlugin=Clazz.extend({facade:null,construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.onLoaded.bind(this))},onLoaded:function(){},onSelectionChanged:function(){},showOverlay:function(a,b,d,c){if(!(a instanceof Array)){a=[a]}a=a.map(function(e){var f=e;if(typeof e=="string"){f=this.facade.getCanvas().getChildShapeByResourceId(e);f=f||this.facade.getCanvas().getChildById(e,true)}return f}.bind(this)).compact();if(!this.overlayID){this.overlayID=this.type+ORYX.Editor.provideId()}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:this.overlayID,shapes:a,attributes:b,node:d,nodePosition:c||"NW"})},hideOverlay:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:this.overlayID})},doTransform:function(d,a){if(!a||!d){return""}var c=new DOMParser();var k=c.parseFromString(d,"text/xml");source=a;new Ajax.Request(source,{asynchronous:false,method:"get",onSuccess:function(m){xsl=m.responseText}.bind(this),onFailure:(function(m){ORYX.Log.error("XSL load failed"+m)}).bind(this)});var f=new XSLTProcessor();var h=new DOMParser();var e=h.parseFromString(xsl,"text/xml");f.importStylesheet(e);try{var l=f.transformToFragment(k,document);var b=(new XMLSerializer()).serializeToString(l);b=!b.startsWith("<?xml")?'<?xml version="1.0" encoding="UTF-8"?>'+b:b;return b}catch(g){return -1}},openXMLWindow:function(a){var b=window.open("data:application/xml,"+encodeURIComponent(a),"_blank","resizable=yes,width=600,height=600,toolbar=0,scrollbars=yes")},openDownloadWindow:function(b,c){var d=window.open("");if(d!=null){d.document.open();d.document.write("<html><body>");var a=d.document.createElement("form");d.document.body.appendChild(a);var e=function(f,g){var h=document.createElement("input");h.name=f;h.type="hidden";h.value=g;return h};a.appendChild(e("download",c));a.appendChild(e("file",b));a.method="POST";d.document.write("</body></html>");d.document.close();a.action=ORYX.PATH+"/download";a.submit()}},getSerializedDOM:function(){var a=DataManager.serializeDOM(this.facade);a='<?xml version="1.0" encoding="utf-8"?><html xmlns="http://www.w3.org/1999/xhtml" xmlns:b3mn="http://b3mn.org/2007/b3mn" xmlns:ext="http://b3mn.org/2007/ext" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:atom="http://b3mn.org/2007/atom+xhtml"><head profile="http://purl.org/NET/erdf/profile"><link rel="schema.dc" href="http://purl.org/dc/elements/1.1/" /><link rel="schema.dcTerms" href="http://purl.org/dc/terms/ " /><link rel="schema.b3mn" href="http://b3mn.org" /><link rel="schema.oryx" href="http://oryx-editor.org/" /><link rel="schema.raziel" href="http://raziel.org/" /><base href="'+location.href.split("?")[0]+'" /></head><body>'+a+"</body></html>";return a},enableReadOnlyMode:function(){this.facade.disableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN);this._stopSelectionChange=function(){if(this.facade.getSelection().length>0){this.facade.setSelection([])}};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this._stopSelectionChange.bind(this))},disableReadOnlyMode:function(){this.facade.enableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN);if(this._stopSelectionChange){this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this._stopSelectionChange.bind(this));this._stopSelectionChange=undefined}},getRDFFromDOM:function(){try{var c="";source=ORYX.PATH+"lib/extract-rdf.xsl";new Ajax.Request(source,{asynchronous:false,method:"get",onSuccess:function(e){c=e.responseText}.bind(this),onFailure:(function(e){ORYX.Log.error("XSL load failed"+e)}).bind(this)});var k=new DOMParser();var h=k.parseFromString(this.getSerializedDOM(),"text/xml");var f=k.parseFromString(c,"text/xml");var b=new XSLTProcessor();b.importStylesheet(f);var a=b.transformToFragment(h,document);var d=new XMLSerializer();return d.serializeToString(a)}catch(g){Ext.Msg.alert("Oryx",error);return""}},isStencilSetExtensionLoaded:function(a){return this.facade.getStencilSets().values().any(function(b){return b.extensions().keys().any(function(c){return c==a}.bind(this))}.bind(this))},doLayout:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LAYOUT,shapes:a})},layoutEdges:function(c,f,e){var g=f.findAll(function(m){return m.dockers.length>2}.bind(this));if(g.length>0){var b=c.absoluteXY();var a={x:b.x-e.x,y:b.y-e.y};b.x+=c.bounds.width()/2;b.y+=c.bounds.height()/2;oldCenter=Object.clone(b);oldCenter.x-=e?e.x:0;oldCenter.y-=e?e.y:0;var l={x:b.x-(c.bounds.width()/2),y:b.y-(c.bounds.height()/2)};var h={x:b.x+(c.bounds.width()/2),y:b.y+(c.bounds.height()/2)};var k=function(o,m){var p=o.center().x-m.center().x;var n=o.center().y-m.center().y;if(Math.abs(p)<3){o.moveBy({x:(e.xs?(((e.xs*(o.center().x-a.x))+e.x+a.x)-o.center().x):e.x)-p,y:0})}else{if(Math.abs(n)<3){o.moveBy({x:0,y:(e.ys?(((e.ys*(o.center().y-a.y))+e.y+a.y)-o.center().y):e.y)-n})}}};var d=function(m){var n=m.dockers.first().getDockedShape();var o=m.dockers.last().getDockedShape();if(n){n=n.absoluteBounds();n.widen(5)}if(o){o=o.absoluteBounds();o.widen(20)}return m.dockers.any(function(q,p){var r=q.bounds.center();return p!=0&&p!=m.dockers.length-1&&((n&&n.isIncluded(r))||(o&&o.isIncluded(r)))})};g.each(function(o){if(o.dockers.first().getDockedShape()===c){var n=o.dockers[1];if(k(n.bounds,o.dockers.first().bounds)){n.update()}}else{if(o.dockers.last().getDockedShape()===c){var m=o.dockers[o.dockers.length-2];if(k(m.bounds,o.dockers.last().bounds)){m.update()}}}o._update(true);o.removeUnusedDockers();if(d(o)){this.doLayout(o);return}}.bind(this))}f.each(function(m){if(m.dockers.length==2){var o=m.dockers.first().bounds.center();var n=m.dockers.last().bounds.center();if(Math.abs(o.x-n.x)<2||Math.abs(o.y-n.y)<2){m.dockers.first().update();m.dockers.last().update();this.doLayout(m)}}}.bind(this))}});if(!ORYX){var ORYX={}}if(!ORYX.Plugins){ORYX.Plugins={}}ORYX.Plugins.AbstractLayouter=ORYX.Plugins.AbstractPlugin.extend({layouted:[],construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LAYOUT,this._initLayout.bind(this))},isIncludedInLayout:function(a){if(!(this.layouted instanceof Array)){this.layouted=[this.layouted].compact()}if(this.layouted.length<=0){return true}return this.layouted.any(function(b){if(typeof b=="string"){return a.getStencil().id().include(b)}else{return a instanceof b}})},_initLayout:function(c){var b=[c.shapes].flatten().compact();var a=b.findAll(function(d){return this.isIncludedInLayout(d)}.bind(this));if(a.length>0){this.layout(a)}},layout:function(a){throw new Error("Layouter has to implement the layout function.")}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Toolbar=Clazz.extend({facade:undefined,plugs:[],construct:function(b,a){this.facade=b;this.groupIndex=new Hash();a.properties.each((function(c){if(c.group&&c.index!=undefined){this.groupIndex[c.group]=c.index}}).bind(this));Ext.QuickTips.init();this.buttons=[];this.facade.registerOnEvent(ORYX.CONFIG.EVENT_BUTTON_UPDATE,this.onButtonUpdate.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,this.onSelectionChanged.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_WINDOW_FOCUS,this.onSelectionChanged.bind(this));Event.observe(window,"focus",function(c){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_WINDOW_FOCUS},null)}.bind(this))},onButtonUpdate:function(b){var a=this.buttons.find(function(c){return c.id===b.id});if(b.pressed!==undefined){a.buttonInstance.toggle(b.pressed)}},registryChanged:function(c){var b=c.sortBy((function(g){return((this.groupIndex[g.group]!=undefined?this.groupIndex[g.group]:"")+g.group+""+g.index).toLowerCase()}).bind(this));var a=$A(b).findAll(function(g){return !this.plugs.include(g)}.bind(this));if(a.length<1){return}this.buttons=[];ORYX.Log.trace("Creating a toolbar.");if(!this.toolbar){this.toolbar=new Ext.ux.SlicedToolbar({height:24});var e=this.facade.addToRegion("north",this.toolbar,"Toolbar")}var f=this.plugs.last()?this.plugs.last().group:a[0].group;var d={};a.each((function(k){if(!k.name){return}this.plugs.push(k);if(f!=k.group){this.toolbar.add("-");f=k.group;d={}}var h=k.functionality;k.functionality=function(){if("undefined"!=typeof(pageTracker)&&"function"==typeof(pageTracker._trackEvent)){pageTracker._trackEvent("ToolbarButton",k.name)}return h.apply(this,arguments)};if(k.dropDownGroupIcon){var m=d[k.dropDownGroupIcon];if(m===undefined){m=d[k.dropDownGroupIcon]=new Ext.Toolbar.SplitButton({cls:"x-btn-icon",icon:k.dropDownGroupIcon,menu:new Ext.menu.Menu({items:[]}),listeners:{click:function(n,o){if(!n.menu.isVisible()&&!n.ignoreNextClick){n.showMenu()}else{n.hideMenu()}}}});this.toolbar.add(m)}var l={icon:k.icon,text:k.name,itemId:k.id,handler:k.toggle?undefined:k.functionality,checkHandler:k.toggle?k.functionality:undefined,listeners:{render:function(n){if(k.description){new Ext.ToolTip({target:n.getEl(),title:k.description})}}}};if(k.toggle){var g=new Ext.menu.CheckItem(l)}else{var g=new Ext.menu.Item(l)}m.menu.add(g)}else{var g=new Ext.Toolbar.Button({icon:k.icon,cls:"x-btn-icon",itemId:k.id,tooltip:k.description,tooltipType:"title",handler:k.toggle?null:k.functionality,enableToggle:k.toggle,toggleHandler:k.toggle?k.functionality:null});this.toolbar.add(g);g.getEl().onclick=function(){this.blur()}}k.buttonInstance=g;this.buttons.push(k)}).bind(this));this.enableButtons([]);this.toolbar.calcSlices();window.addEventListener("resize",function(g){this.toolbar.calcSlices()}.bind(this),false);window.addEventListener("onresize",function(g){this.toolbar.calcSlices()}.bind(this),false)},onSelectionChanged:function(a){if(!a.elements){this.enableButtons([])}else{this.enableButtons(a.elements)}},enableButtons:function(a){this.buttons.each((function(b){b.buttonInstance.enable();if(b.minShape&&b.minShape>a.length){b.buttonInstance.disable()}if(b.maxShape&&b.maxShape<a.length){b.buttonInstance.disable()}if(b.isEnabled&&!b.isEnabled()){b.buttonInstance.disable()}}).bind(this))}});Ext.ns("Ext.ux");Ext.ux.SlicedToolbar=Ext.extend(Ext.Toolbar,{currentSlice:0,iconStandardWidth:22,seperatorStandardWidth:2,toolbarStandardPadding:2,initComponent:function(){Ext.apply(this,{});Ext.ux.SlicedToolbar.superclass.initComponent.apply(this,arguments)},onRender:function(){Ext.ux.SlicedToolbar.superclass.onRender.apply(this,arguments)},onResize:function(){Ext.ux.SlicedToolbar.superclass.onResize.apply(this,arguments)},calcSlices:function(){var d=0;this.sliceMap={};var c=0;var a=this.getEl().getWidth();this.items.getRange().each(function(g,e){if(g.helperItem){g.destroy();return}var h=g.getEl().getWidth();if(c+h+5*this.iconStandardWidth>a){var f=this.items.indexOf(g);this.insertSlicingButton("next",d,f);if(d!==0){this.insertSlicingButton("prev",d,f)}this.insertSlicingSeperator(d,f);d+=1;c=0}this.sliceMap[g.id]=d;c+=h}.bind(this));if(d>0){this.insertSlicingSeperator(d,this.items.getCount()+1);this.insertSlicingButton("prev",d,this.items.getCount()+1);var b=new Ext.Toolbar.Spacer();this.insertSlicedHelperButton(b,d,this.items.getCount()+1);Ext.get(b.id).setWidth(this.iconStandardWidth)}this.maxSlice=d;this.setCurrentSlice(this.currentSlice)},insertSlicedButton:function(b,c,a){this.insertButton(a,b);this.sliceMap[b.id]=c},insertSlicedHelperButton:function(b,c,a){b.helperItem=true;this.insertSlicedButton(b,c,a)},insertSlicingSeperator:function(b,a){this.insertSlicedHelperButton(new Ext.Toolbar.Fill(),b,a)},insertSlicingButton:function(e,f,b){var d=function(){this.setCurrentSlice(this.currentSlice+1)}.bind(this);var a=function(){this.setCurrentSlice(this.currentSlice-1)}.bind(this);var c=new Ext.Toolbar.Button({cls:"x-btn-icon",icon:ORYX.CONFIG.ROOT_PATH+"images/toolbar_"+e+".png",handler:(e==="next")?d:a});this.insertSlicedHelperButton(c,f,b)},setCurrentSlice:function(a){if(a>this.maxSlice||a<0){return}this.currentSlice=a;this.items.getRange().each(function(b){b.setVisible(a===this.sliceMap[b.id])}.bind(this))}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ShapeMenuPlugin={construct:function(c){this.facade=c;this.alignGroups=new Hash();var a=this.facade.getCanvas().getHTMLContainer();this.shapeMenu=new ORYX.Plugins.ShapeMenu(a);this.currentShapes=[];this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDROP_START,this.hideShapeMenu.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDROP_END,this.showShapeMenu.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_RESIZE_START,(function(){this.hideShapeMenu();this.hideMorphMenu()}).bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_RESIZE_END,this.showShapeMenu.bind(this));var b=new Ext.dd.DragZone(a.parentNode,{shadow:!Ext.isMac});b.afterDragDrop=this.afterDragging.bind(this,b);b.beforeDragOver=this.beforeDragOver.bind(this,b);this.createdButtons={};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,(function(){this.registryChanged()}).bind(this));this.timer=null;this.resetElements=true},hideShapeMenu:function(a){window.clearTimeout(this.timer);this.timer=null;this.shapeMenu.hide()},showShapeMenu:function(a){if(!a||this.resetElements){window.clearTimeout(this.timer);this.timer=window.setTimeout(function(){this.shapeMenu.closeAllButtons();this.showMorphButton(this.currentShapes);this.showStencilButtons(this.currentShapes);this.shapeMenu.show(this.currentShapes);this.resetElements=false}.bind(this),300)}else{window.clearTimeout(this.timer);this.timer=null;this.shapeMenu.show(this.currentShapes)}},registryChanged:function(a){if(a){a=a.each(function(d){d.group=d.group?d.group:"unknown"});this.pluginsData=a.sortBy(function(d){return(d.group+""+d.index)})}this.shapeMenu.removeAllButtons();this.shapeMenu.setNumberOfButtonsPerLevel(ORYX.CONFIG.SHAPEMENU_RIGHT,2);this.createdButtons={};this.createMorphMenu();if(!this.pluginsData){this.pluginsData=[]}this.baseMorphStencils=this.facade.getRules().baseMorphs();var b=this.facade.getRules().containsMorphingRules();var c=this.facade.getStencilSets();c.values().each((function(f){var e=f.nodes();e.each((function(k){var h={type:k.id(),namespace:k.namespace(),connectingType:true};var g=new ORYX.Plugins.ShapeMenuButton({callback:this.newShape.bind(this,h),icon:k.icon(),align:ORYX.CONFIG.SHAPEMENU_RIGHT,group:0,msg:k.title()+" - "+ORYX.I18N.ShapeMenuPlugin.clickDrag});this.shapeMenu.addButton(g);this.createdButtons[k.namespace()+k.type()+k.id()]=g;Ext.dd.Registry.register(g.node.lastChild,h)}).bind(this));var d=f.edges();d.each((function(k){var h={type:k.id(),namespace:k.namespace()};var g=new ORYX.Plugins.ShapeMenuButton({callback:this.newShape.bind(this,h),icon:k.icon(),align:ORYX.CONFIG.SHAPEMENU_RIGHT,group:1,msg:(b?ORYX.I18N.Edge:k.title())+" - "+ORYX.I18N.ShapeMenuPlugin.drag});this.shapeMenu.addButton(g);this.createdButtons[k.namespace()+k.type()+k.id()]=g;Ext.dd.Registry.register(g.node.lastChild,h)}).bind(this))}).bind(this))},createMorphMenu:function(){this.morphMenu=new Ext.menu.Menu({id:"Oryx_morph_menu",items:[]});this.morphMenu.on("mouseover",function(){this.morphMenuHovered=true},this);this.morphMenu.on("mouseout",function(){this.morphMenuHovered=false},this);var a=new ORYX.Plugins.ShapeMenuButton({hovercallback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?this.showMorphMenu.bind(this):undefined),resetcallback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?this.hideMorphMenu.bind(this):undefined),callback:(ORYX.CONFIG.ENABLE_MORPHMENU_BY_HOVER?undefined:this.toggleMorphMenu.bind(this)),icon:ORYX.PATH+"images/wrench_orange.png",align:ORYX.CONFIG.SHAPEMENU_BOTTOM,group:0,msg:ORYX.I18N.ShapeMenuPlugin.morphMsg});this.shapeMenu.setNumberOfButtonsPerLevel(ORYX.CONFIG.SHAPEMENU_BOTTOM,1);this.shapeMenu.addButton(a);this.morphMenu.getEl().appendTo(a.node);this.morphButton=a},showMorphMenu:function(){this.morphMenu.show(this.morphButton.node);this._morphMenuShown=true},hideMorphMenu:function(){this.morphMenu.hide();this._morphMenuShown=false},toggleMorphMenu:function(){if(this._morphMenuShown){this.hideMorphMenu()}else{this.showMorphMenu()}},onSelectionChanged:function(a){var b=a.elements;this.hideShapeMenu();this.hideMorphMenu();if(this.currentShapes.inspect()!==b.inspect()){this.currentShapes=b;this.resetElements=true;this.showShapeMenu()}else{this.showShapeMenu(true)}},showMorphButton:function(b){if(b.length!=1){return}var a=this.facade.getRules().morphStencils({stencil:b[0].getStencil()});a=a.select(function(c){if(b[0].getStencil().type()==="node"){return this.facade.getRules().canContain({containingShape:b[0].parent,containedStencil:c})}else{return this.facade.getRules().canConnect({sourceShape:b[0].dockers.first().getDockedShape(),edgeStencil:c,targetShape:b[0].dockers.last().getDockedShape()})}}.bind(this));if(a.size()<=1){return}this.morphMenu.removeAll();a=a.sortBy(function(c){return c.position()});a.each((function(d){var c=new Ext.menu.Item({text:d.title(),icon:d.icon(),disabled:d.id()==b[0].getStencil().id(),disabledClass:ORYX.CONFIG.MORPHITEM_DISABLED,handler:(function(){this.morphShape(b[0],d)}).bind(this)});this.morphMenu.add(c)}).bind(this));this.morphButton.prepareToShow()},showStencilButtons:function(g){if(g.length!=1){return}var f=this.facade.getStencilSets()[g[0].getStencil().namespace()];var c=this.facade.getRules().outgoingEdgeStencils({canvas:this.facade.getCanvas(),sourceShape:g[0]});var a=new Array();var d=new Array();var e=this.facade.getRules().containsMorphingRules();c.each((function(k){if(e){if(this.baseMorphStencils.include(k)){var l=true}else{var h=this.facade.getRules().morphStencils({stencil:k});var l=!h.any((function(m){if(this.baseMorphStencils.include(m)&&c.include(m)){return true}return d.include(m)}).bind(this))}}if(l||!e){if(this.createdButtons[k.namespace()+k.type()+k.id()]){this.createdButtons[k.namespace()+k.type()+k.id()].prepareToShow()}d.push(k)}a=a.concat(this.facade.getRules().targetStencils({canvas:this.facade.getCanvas(),sourceShape:g[0],edgeStencil:k}))}).bind(this));a.uniq();var b=new Array();a.each((function(l){if(e){if(l.type()==="edge"){return}if(!this.facade.getRules().showInShapeMenu(l)){return}if(!this.baseMorphStencils.include(l)){var h=this.facade.getRules().morphStencils({stencil:l});if(h.size()==0){return}var k=h.any((function(m){if(this.baseMorphStencils.include(m)&&a.include(m)){return true}return b.include(m)}).bind(this));if(k){return}}}if(this.createdButtons[l.namespace()+l.type()+l.id()]){this.createdButtons[l.namespace()+l.type()+l.id()].prepareToShow()}b.push(l)}).bind(this))},beforeDragOver:function(n,m,b){if(this.shapeMenu.isVisible){this.hideShapeMenu()}var l=this.facade.eventCoordinates(b.browserEvent);var s=this.facade.getCanvas().getAbstractShapesAtPosition(l);if(s.length<=0){return false}var d=s.last();if(this._lastOverElement==d){return false}else{var h=Ext.dd.Registry.getHandle(m.DDM.currentTarget);if(h.backupOptions){for(key in h.backupOptions){h[key]=h.backupOptions[key]}delete h.backupOptions}var o=this.facade.getStencilSets()[h.namespace];var q=o.stencil(h.type);var r=s.last();if(q.type()==="node"){var c=this.facade.getRules().canContain({containingShape:r,containedStencil:q});if(!c){var p=this.facade.getRules().morphStencils({stencil:q});for(var g=0;g<p.size();g++){c=this.facade.getRules().canContain({containingShape:r,containedStencil:p[g]});if(c){h.backupOptions=Object.clone(h);h.type=p[g].id();h.namespace=p[g].namespace();break}}}this._currentReference=c?r:undefined}else{var k=r,e=r;var f=false;while(!f&&k&&!(k instanceof ORYX.Core.Canvas)){r=k;f=this.facade.getRules().canConnect({sourceShape:this.currentShapes.first(),edgeStencil:q,targetShape:k});k=k.parent}if(!f){r=e;var p=this.facade.getRules().morphStencils({stencil:q});for(var g=0;g<p.size();g++){var k=r;var f=false;while(!f&&k&&!(k instanceof ORYX.Core.Canvas)){r=k;f=this.facade.getRules().canConnect({sourceShape:this.currentShapes.first(),edgeStencil:p[g],targetShape:k});k=k.parent}if(f){h.backupOptions=Object.clone(h);h.type=p[g].id();h.namespace=p[g].namespace();break}else{r=e}}}this._currentReference=f?r:undefined}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"shapeMenu",elements:[r],color:this._currentReference?ORYX.CONFIG.SELECTION_VALID_COLOR:ORYX.CONFIG.SELECTION_INVALID_COLOR});var a=n.getProxy();a.setStatus(this._currentReference?a.dropAllowed:a.dropNotAllowed);a.sync()}this._lastOverElement=d;return false},afterDragging:function(k,f,b){if(!(this.currentShapes instanceof Array)||this.currentShapes.length<=0){return}var e=this.currentShapes;this._lastOverElement=undefined;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeMenu"});var h=k.getProxy();if(h.dropStatus==h.dropNotAllowed){return this.facade.updateSelection()}if(!this._currentReference){return}var d=Ext.dd.Registry.getHandle(f.DDM.currentTarget);d.parent=this._currentReference;var r=b.getXY();var l={x:r[0],y:r[1]};var n=this.facade.getCanvas().node.getScreenCTM();l.x-=n.e;l.y-=n.f;l.x/=n.a;l.y/=n.d;l.x-=document.documentElement.scrollLeft;l.y-=document.documentElement.scrollTop;var q=this._currentReference.absoluteXY();l.x-=q.x;l.y-=q.y;if(!b.ctrlKey){var m=this.currentShapes[0].bounds.center();if(20>Math.abs(m.x-l.x)){l.x=m.x}if(20>Math.abs(m.y-l.y)){l.y=m.y}}d.position=l;d.connectedShape=this.currentShapes[0];if(d.connectingType){var p=this.facade.getStencilSets()[d.namespace];var o=p.stencil(d.type);var g={sourceShape:this.currentShapes[0],targetStencil:o};d.connectingType=this.facade.getRules().connectMorph(g).id()}if(ORYX.CONFIG.SHAPEMENU_DISABLE_CONNECTED_EDGE===true){delete d.connectingType}var c=new ORYX.Plugins.ShapeMenuPlugin.CreateCommand(Object.clone(d),this._currentReference,l,this);this.facade.executeCommands([c]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_SHAPE_MENU_CLOSE,source:e,destination:this.currentShapes});if(d.backupOptions){for(key in d.backupOptions){d[key]=d.backupOptions[key]}delete d.backupOptions}this._currentReference=undefined},newShape:function(e,f){var a=this.facade.getStencilSets()[e.namespace];var d=a.stencil(e.type);if(this.facade.getRules().canContain({containingShape:this.currentShapes.first().parent,containedStencil:d})){e.connectedShape=this.currentShapes[0];e.parent=this.currentShapes.first().parent;e.containedStencil=d;var b={sourceShape:this.currentShapes[0],targetStencil:d};var c=this.facade.getRules().connectMorph(b);if(!c){return}e.connectingType=c.id();if(ORYX.CONFIG.SHAPEMENU_DISABLE_CONNECTED_EDGE===true){delete e.connectingType}var g=new ORYX.Plugins.ShapeMenuPlugin.CreateCommand(e,undefined,undefined,this);this.facade.executeCommands([g])}},morphShape:function(a,b){var d=ORYX.Core.Command.extend({construct:function(e,g,f){this.shape=e;this.stencil=g;this.facade=f},execute:function(){var o=this.shape;var s=this.stencil;var n=o.resourceId;var h=o.serialize();s.properties().each((function(t){if(t.readonly()){h=h.reject(function(u){return u.name==t.id()})}}).bind(this));if(this.newShape){newShape=this.newShape;this.facade.getCanvas().add(newShape)}else{newShape=this.facade.createShape({type:s.id(),namespace:s.namespace(),resourceId:n})}var m=h.find(function(t){return(t.prefix==="oryx"&&t.name==="bounds")});var p=null;if(!this.facade.getRules().preserveBounds(o.getStencil())){var e=m.value.split(",");if(parseInt(e[0],10)>parseInt(e[2],10)){var k=e[0];e[0]=e[2];e[2]=k;k=e[1];e[1]=e[3];e[3]=k}e[2]=parseInt(e[0],10)+newShape.bounds.width();e[3]=parseInt(e[1],10)+newShape.bounds.height();m.value=e.join(",")}else{var r=o.bounds.height();var f=o.bounds.width();if(newShape.minimumSize){if(o.bounds.height()<newShape.minimumSize.height){r=newShape.minimumSize.height}if(o.bounds.width()<newShape.minimumSize.width){f=newShape.minimumSize.width}}if(newShape.maximumSize){if(o.bounds.height()>newShape.maximumSize.height){r=newShape.maximumSize.height}if(o.bounds.width()>newShape.maximumSize.width){f=newShape.maximumSize.width}}p={a:{x:o.bounds.a.x,y:o.bounds.a.y},b:{x:o.bounds.a.x+f,y:o.bounds.a.y+r}}}var q=o.bounds.center();if(p!==null){newShape.bounds.set(p)}this.setRelatedDockers(o,newShape);var l=o.node.parentNode;var g=o.node.nextSibling;this.facade.deleteShape(o);newShape.deserialize(h);if(o.getStencil().property("oryx-bgcolor")&&o.properties["oryx-bgcolor"]&&o.getStencil().property("oryx-bgcolor").value().toUpperCase()==o.properties["oryx-bgcolor"].toUpperCase()){if(newShape.getStencil().property("oryx-bgcolor")){newShape.setProperty("oryx-bgcolor",newShape.getStencil().property("oryx-bgcolor").value())}}if(p!==null){newShape.bounds.set(p)}if(newShape.getStencil().type()==="edge"||(newShape.dockers.length==0||!newShape.dockers[0].getDockedShape())){newShape.bounds.centerMoveTo(q)}if(newShape.getStencil().type()==="node"&&(newShape.dockers.length==0||!newShape.dockers[0].getDockedShape())){this.setRelatedDockers(newShape,newShape)}if(g){l.insertBefore(newShape.node,g)}else{l.appendChild(newShape.node)}this.facade.setSelection([newShape]);this.facade.getCanvas().update();this.facade.updateSelection();this.newShape=newShape;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_SHAPE_MORPHED,shape:newShape})},rollback:function(){if(!this.shape||!this.newShape||!this.newShape.parent){return}this.newShape.parent.add(this.shape);this.setRelatedDockers(this.newShape,this.shape);this.facade.deleteShape(this.newShape);this.facade.setSelection([this.shape]);this.facade.getCanvas().update();this.facade.updateSelection()},setRelatedDockers:function(e,f){if(e.getStencil().type()==="node"){(e.incoming||[]).concat(e.outgoing||[]).each(function(g){g.dockers.each(function(l){if(l.getDockedShape()==e){var k=Object.clone(l.referencePoint);var m={x:k.x*f.bounds.width()/e.bounds.width(),y:k.y*f.bounds.height()/e.bounds.height()};l.setDockedShape(f);l.setReferencePoint(m);if(g instanceof ORYX.Core.Edge){l.bounds.centerMoveTo(m)}else{var h=e.absoluteXY();l.bounds.centerMoveTo({x:m.x+h.x,y:m.y+h.y})}}})});if(e.dockers.length>0&&e.dockers.first().getDockedShape()){f.dockers.first().setDockedShape(e.dockers.first().getDockedShape());f.dockers.first().setReferencePoint(Object.clone(e.dockers.first().referencePoint))}}else{f.dockers.first().setDockedShape(e.dockers.first().getDockedShape());f.dockers.first().setReferencePoint(e.dockers.first().referencePoint);f.dockers.last().setDockedShape(e.dockers.last().getDockedShape());f.dockers.last().setReferencePoint(e.dockers.last().referencePoint)}}});var c=new d(a,b,this.facade);this.facade.executeCommands([c])}};ORYX.Plugins.ShapeMenuPlugin=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.ShapeMenuPlugin);ORYX.Plugins.ShapeMenu={construct:function(a){this.bounds=undefined;this.shapes=undefined;this.buttons=[];this.isVisible=false;this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",$(a),["div",{id:ORYX.Editor.provideId(),"class":"Oryx_ShapeMenu"}]);this.alignContainers=new Hash();this.numberOfButtonsPerLevel=new Hash()},addButton:function(b){this.buttons.push(b);if(!this.alignContainers[b.align]){this.alignContainers[b.align]=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.node,["div",{"class":b.align}]);this.node.appendChild(this.alignContainers[b.align]);var a=false;this.alignContainers[b.align].addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,this.hoverAlignContainer.bind(this,b.align),a);this.alignContainers[b.align].addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,this.resetAlignContainer.bind(this,b.align),a);this.alignContainers[b.align].addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.hoverAlignContainer.bind(this,b.align),a)}this.alignContainers[b.align].appendChild(b.node)},deleteButton:function(a){this.buttons=this.buttons.without(a);this.node.removeChild(a.node)},removeAllButtons:function(){var a=this;this.buttons.each(function(b){if(b.node&&b.node.parentNode){b.node.parentNode.removeChild(b.node)}});this.buttons=[]},closeAllButtons:function(){this.buttons.each(function(a){a.prepareToHide()});this.isVisible=false},show:function(e){if(e.length<=0){return}this.shapes=e;var f=undefined;var h=undefined;this.shapes.each(function(r){var q=r.node.getScreenCTM();var s=r.absoluteXY();q.e=q.a*s.x;q.f=q.d*s.y;h=new ORYX.Core.Bounds(q.e,q.f,q.e+q.a*r.bounds.width(),q.f+q.d*r.bounds.height());if(!f){f=h}else{f.include(h)}});this.bounds=f;var c=this.bounds;var m=this.bounds.upperLeft();var g=0,d=0;var k=0,l=0;var b=0,n;var o=0;rightButtonGroup=0;var p=22;this.getWillShowButtons().sortBy(function(a){return a.group});this.getWillShowButtons().each(function(q){var r=this.getNumberOfButtonsPerLevel(q.align);if(q.align==ORYX.CONFIG.SHAPEMENU_LEFT){if(q.group!=d){g=0;d=q.group}var a=Math.floor(g/r);var s=g%r;q.setLevel(a);q.setPosition(m.x-5-(a+1)*p,m.y+r*q.group*p+q.group*0.3*p+s*p);g++}else{if(q.align==ORYX.CONFIG.SHAPEMENU_TOP){if(q.group!=l){k=0;l=q.group}var a=k%r;var s=Math.floor(k/r);q.setLevel(s);q.setPosition(m.x+r*q.group*p+q.group*0.3*p+a*p,m.y-5-(s+1)*p);k++}else{if(q.align==ORYX.CONFIG.SHAPEMENU_BOTTOM){if(q.group!=n){b=0;n=q.group}var a=b%r;var s=Math.floor(b/r);q.setLevel(s);q.setPosition(m.x+r*q.group*p+q.group*0.3*p+a*p,m.y+c.height()+5+s*p);b++}else{if(q.group!=rightButtonGroup){o=0;rightButtonGroup=q.group}var a=Math.floor(o/r);var s=o%r;q.setLevel(a);q.setPosition(m.x+c.width()+5+a*p,m.y+r*q.group*p+q.group*0.3*p+s*p-5);o++}}}q.show()}.bind(this));this.isVisible=true},hide:function(){this.buttons.each(function(a){a.hide()});this.isVisible=false},hoverAlignContainer:function(b,a){this.buttons.each(function(c){if(c.align==b){c.showOpaque()}})},resetAlignContainer:function(b,a){this.buttons.each(function(c){if(c.align==b){c.showTransparent()}})},isHover:function(){return this.buttons.any(function(a){return a.isHover()})},getWillShowButtons:function(){return this.buttons.findAll(function(a){return a.willShow})},getButtons:function(b,a){return this.getWillShowButtons().findAll(function(c){return c.align==b&&(a===undefined||c.group==a)})},setNumberOfButtonsPerLevel:function(b,a){this.numberOfButtonsPerLevel[b]=a},getNumberOfButtonsPerLevel:function(a){if(this.numberOfButtonsPerLevel[a]){return Math.min(this.getButtons(a,0).length,this.numberOfButtonsPerLevel[a])}else{return 1}}};ORYX.Plugins.ShapeMenu=Clazz.extend(ORYX.Plugins.ShapeMenu);ORYX.Plugins.ShapeMenuButton={construct:function(b){if(b){this.option=b;if(!this.option.arguments){this.option.arguments=[]}}else{}this.parentId=this.option.id?this.option.id:null;var e=this.option.caption?"Oryx_button_with_caption":"Oryx_button";this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",$(this.parentId),["div",{"class":e}]);var c={src:this.option.icon};if(this.option.msg){c.title=this.option.msg}if(this.option.icon){ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.node,["img",c])}if(this.option.caption){var d=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.node,["span"]);ORYX.Editor.graft("http://www.w3.org/1999/xhtml",d,this.option.caption)}var a=false;this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,this.hover.bind(this),a);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,this.reset.bind(this),a);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this.activate.bind(this),a);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.hover.bind(this),a);this.node.addEventListener("click",this.trigger.bind(this),a);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.move.bind(this),a);this.align=this.option.align?this.option.align:ORYX.CONFIG.SHAPEMENU_RIGHT;this.group=this.option.group?this.option.group:0;this.hide();this.dragStart=false;this.isVisible=false;this.willShow=false;this.resetTimer},hide:function(){this.node.style.display="none";this.isVisible=false},show:function(){this.node.style.display="";this.node.style.opacity=this.opacity;this.isVisible=true},showOpaque:function(){this.node.style.opacity=1},showTransparent:function(){this.node.style.opacity=this.opacity},prepareToShow:function(){this.willShow=true},prepareToHide:function(){this.willShow=false;this.hide()},setPosition:function(a,b){this.node.style.left=a+"px";this.node.style.top=b+"px"},setLevel:function(a){if(a==0){this.opacity=0.5}else{if(a==1){this.opacity=0.2}else{this.opacity=0}}},setChildWidth:function(a){this.childNode.style.width=a+"px"},reset:function(a){window.clearTimeout(this.resetTimer);this.resetTimer=window.setTimeout(this.doReset.bind(this),100);if(this.option.resetcallback){this.option.arguments.push(a);var b=this.option.resetcallback.apply(this,this.option.arguments);this.option.arguments.remove(a)}},doReset:function(){if(this.node.hasClassName("Oryx_down")){this.node.removeClassName("Oryx_down")}if(this.node.hasClassName("Oryx_hover")){this.node.removeClassName("Oryx_hover")}},activate:function(a){this.node.addClassName("Oryx_down");this.dragStart=true},isHover:function(){return this.node.hasClassName("Oryx_hover")?true:false},hover:function(a){window.clearTimeout(this.resetTimer);this.resetTimer=null;this.node.addClassName("Oryx_hover");this.dragStart=false;if(this.option.hovercallback){this.option.arguments.push(a);var b=this.option.hovercallback.apply(this,this.option.arguments);this.option.arguments.remove(a)}},move:function(a){if(this.dragStart&&this.option.dragcallback){this.option.arguments.push(a);var b=this.option.dragcallback.apply(this,this.option.arguments);this.option.arguments.remove(a)}},trigger:function(a){if(this.option.callback){this.option.arguments.push(a);var b=this.option.callback.apply(this,this.option.arguments);this.option.arguments.remove(a)}this.dragStart=false},toString:function(){return"HTML-Button "+this.id}};ORYX.Plugins.ShapeMenuButton=Clazz.extend(ORYX.Plugins.ShapeMenuButton);ORYX.Plugins.ShapeMenuPlugin.CreateCommand=ORYX.Core.Command.extend({construct:function(c,b,a,d){this.option=c;this.currentReference=b;this.position=a;this.plugin=d;this.shape;this.edge;this.targetRefPos;this.sourceRefPos;this.connectedShape=c.connectedShape;this.connectingType=c.connectingType;this.namespace=c.namespace;this.type=c.type;this.containedStencil=c.containedStencil;this.parent=c.parent;this.currentReference=b;this.shapeOptions=c.shapeOptions},execute:function(){var d=false;if(this.shape){if(this.shape instanceof ORYX.Core.Node){this.parent.add(this.shape);if(this.edge){this.plugin.facade.getCanvas().add(this.edge);this.edge.dockers.first().setDockedShape(this.connectedShape);this.edge.dockers.first().setReferencePoint(this.sourceRefPos);this.edge.dockers.last().setDockedShape(this.shape);this.edge.dockers.last().setReferencePoint(this.targetRefPos)}this.plugin.facade.setSelection([this.shape])}else{if(this.shape instanceof ORYX.Core.Edge){this.plugin.facade.getCanvas().add(this.shape);this.shape.dockers.first().setDockedShape(this.connectedShape);this.shape.dockers.first().setReferencePoint(this.sourceRefPos)}}d=true}else{this.shape=this.plugin.facade.createShape(this.option);this.edge=(!(this.shape instanceof ORYX.Core.Edge))?this.shape.getIncomingShapes().first():undefined}if(this.currentReference&&this.position){if(this.shape instanceof ORYX.Core.Edge){if(!(this.currentReference instanceof ORYX.Core.Canvas)){this.shape.dockers.last().setDockedShape(this.currentReference);var g=this.currentReference.absoluteXY();var e={x:this.position.x-g.x,y:this.position.y-g.y};this.shape.dockers.last().setReferencePoint(this.currentReference.bounds.midPoint())}else{this.shape.dockers.last().bounds.centerMoveTo(this.position)}this.sourceRefPos=this.shape.dockers.first().referencePoint;this.targetRefPos=this.shape.dockers.last().referencePoint}else{if(this.edge){this.sourceRefPos=this.edge.dockers.first().referencePoint;this.targetRefPos=this.edge.dockers.last().referencePoint}}}else{var c=this.containedStencil;var a=this.connectedShape;var f=a.bounds;var b=this.shape.bounds;var h=f.center();if(c.defaultAlign()==="north"){h.y-=(f.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(b.height()/2)}else{if(c.defaultAlign()==="northeast"){h.x+=(f.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(b.width()/2);h.y-=(f.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(b.height()/2)}else{if(c.defaultAlign()==="southeast"){h.x+=(f.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(b.width()/2);h.y+=(f.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(b.height()/2)}else{if(c.defaultAlign()==="south"){h.y+=(f.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(b.height()/2)}else{if(c.defaultAlign()==="southwest"){h.x-=(f.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(b.width()/2);h.y+=(f.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(b.height()/2)}else{if(c.defaultAlign()==="west"){h.x-=(f.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(b.width()/2)}else{if(c.defaultAlign()==="northwest"){h.x-=(f.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(b.width()/2);h.y-=(f.height()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET_CORNER+(b.height()/2)}else{h.x+=(f.width()/2)+ORYX.CONFIG.SHAPEMENU_CREATE_OFFSET+(b.width()/2)}}}}}}}this.shape.bounds.centerMoveTo(h);if(this.shape instanceof ORYX.Core.Node){(this.shape.dockers||[]).each(function(k){k.bounds.centerMoveTo(h)})}this.position=h;if(this.edge){this.sourceRefPos=this.edge.dockers.first().referencePoint;this.targetRefPos=this.edge.dockers.last().referencePoint}}this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection();if(!d){if(this.edge){this.plugin.doLayout(this.edge)}else{if(this.shape instanceof ORYX.Core.Edge){this.plugin.doLayout(this.shape)}}}},rollback:function(){this.plugin.facade.deleteShape(this.shape);if(this.edge){this.plugin.facade.deleteShape(this.edge)}this.plugin.facade.setSelection(this.plugin.facade.getSelection().without(this.shape,this.edge))}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.SelectStencilSetPerspective={facade:undefined,extensions:undefined,perspectives:undefined,construct:function(facade){this.facade=facade;var panel=new Ext.Panel({cls:"selectssperspective",border:false,autoScroll:true});var region=this.facade.addToRegion("west",panel);var url=ORYX.CONFIG.SS_EXTENSIONS_CONFIG;new Ajax.Request(url,{method:"GET",asynchronous:false,onSuccess:(function(transport){try{eval("var jsonObject = "+transport.responseText);this.extensions={};jsonObject.extensions.each(function(ext){this.extensions[ext.namespace]=ext}.bind(this));this.perspectives={};jsonObject.perspectives.each(function(per){this.perspectives[per.namespace]=per}.bind(this));this.facade.getStencilSets().values().each((function(sset){var validPerspectives=jsonObject.perspectives.findAll(function(perspective){if(perspective.stencilset==sset.namespace()){return true}else{return false}});if(validPerspectives.size()>0){this.createPerspectivesCombobox(panel,sset,validPerspectives)}}).bind(this))}catch(e){ORYX.Log.debug(ORYX.I18N.SSExtensionLoader.failed1);Ext.Msg.alert("Oryx",ORYX.I18N.SSExtensionLoader.failed1)}}).bind(this),onFailure:(function(transport){Ext.Msg.alert("Oryx",ORYX.I18N.SSExtensionLoader.failed2)}).bind(this)})},createPerspectivesCombobox:function(c,a,f){var e=new Array();f.each(function(g){e.push([g.namespace,g.title,g.description])});var d=new Ext.data.SimpleStore({fields:["namespace","title","tooltip"],data:e});var b=new Ext.form.ComboBox({store:d,displayField:"title",forceSelection:true,typeAhead:true,mode:"local",width:168,triggerAction:"all",emptyText:"Select a perspective...",selectOnFocus:true,tpl:'<tpl for="."><div ext:qtip="{tooltip}" class="x-combo-list-item">{title}</div></tpl>'});b.on("select",this.onSelect,this);c.add(b);c.doLayout()},onSelect:function(c,b){var f=b.json[0];var e=this.facade.getStencilSets();var d=new Object();e.values().each(function(h){h.extensions().values().each(function(k){if(this.extensions[k.namespace]){d[k.namespace]=k}}.bind(this))}.bind(this));var a=new Array();if(this.perspectives[f].addExtensions){this.perspectives[f].addExtensions.each(function(h){if(!h.ifIsLoaded){a.push(this.extensions[h]);return}if(d[h.ifIsLoaded]&&this.extensions[h.add]){a.push(this.extensions[h.add])}else{if(h["default"]&&this.extensions[h["default"]]){a.push(this.extensions[h["default"]])}}}.bind(this))}if(this.perspectives[f].removeAllExtensions){this._loadExtensions(a,undefined,true);return}var g=new Array();if(this.perspectives[f].removeExtensions){this.perspectives[f].removeExtensions.each(function(h){g.push(this.extensions[h])}.bind(this))}this._loadExtensions(a,g,false)},_loadExtensions:function(a,d,c){var e=this.facade.getStencilSets();var f=false;e.values().each(function(g){var h=g.extensions().values().select(function(k){return a[k.namespace]==undefined});if(c){h.each(function(k){g.removeExtension(k.namespace);f=true})}else{h.each(function(l){var k=d.find(function(m){return l.namespace===m.namespace});if(k){g.removeExtension(l.namespace);f=true}})}});a.each(function(h){var g=e[h["extends"]];if(g){g.addExtension(ORYX.CONFIG.SS_EXTENSIONS_FOLDER+h.definition);f=true}}.bind(this));if(f){e.values().each(function(g){this.facade.getRules().initializeRules(g)}.bind(this));this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED});var b=this.facade.getSelection();this.facade.setSelection();this.facade.setSelection(b)}}};ORYX.Plugins.SelectStencilSetPerspective=Clazz.extend(ORYX.Plugins.SelectStencilSetPerspective);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ShapeRepository={facade:undefined,construct:function(c){this.facade=c;this._currentParent;this._canContain=undefined;this._canAttach=undefined;this.shapeList=new Ext.tree.TreeNode({});var a=new Ext.tree.TreePanel({cls:"shaperepository",loader:new Ext.tree.TreeLoader(),root:this.shapeList,autoScroll:true,rootVisible:false,lines:false,anchors:"0, -30"});var d=this.facade.addToRegion("west",a,ORYX.I18N.ShapeRepository.title);var b=new Ext.dd.DragZone(this.shapeList.getUI().getEl(),{shadow:!Ext.isMac});b.afterDragDrop=this.drop.bind(this,b);b.beforeDragOver=this.beforeDragOver.bind(this,b);b.beforeDragEnter=function(){this._lastOverElement=false;return true}.bind(this);this.setStencilSets();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,this.setStencilSets.bind(this))},setStencilSets:function(){var a=this.shapeList;var b=this.shapeList.firstChild;while(b){this.shapeList.removeChild(b);b=this.shapeList.firstChild}if(!ORYX.CONFIG.IS_TEMPLATE){this.facade.getStencilSets().values().each((function(e){var c;var g=e.title();var d=e.extensions();if(d&&d.size()>0){g+=" / "+ORYX.Core.StencilSet.getTranslation(d.values()[0],"title")}this.shapeList.appendChild(c=new Ext.tree.TreeNode({text:g,allowDrag:false,allowDrop:false,iconCls:"headerShapeRepImg",cls:"headerShapeRep",singleClickExpand:true}));c.render();c.expand();var f=e.stencils(this.facade.getCanvas().getStencil(),this.facade.getRules());var h=new Hash();f=f.sortBy(function(k){return k.position()});f.each((function(l){if(f.length<=ORYX.CONFIG.MAX_NUM_SHAPES_NO_GROUP){this.createStencilTreeNode(c,l);return}var k=l.groups();k.each((function(m){if(!h[m]){h[m]=new Ext.tree.TreeNode({text:m,allowDrag:false,allowDrop:false,iconCls:"headerShapeRepImg",cls:"headerShapeRepChild",singleClickExpand:true});c.appendChild(h[m]);h[m].render()}this.createStencilTreeNode(h[m],l)}).bind(this));if(k.length==0){this.createStencilTreeNode(c,l)}}).bind(this))}).bind(this))}new Ajax.Request("/backend/poem/jobdefinition",{method:"GET",parameters:{userId:ORYX.CONFIG.USER_ID,call:"getAllJobDefinitions"},onSuccess:function(c){var f;a.appendChild(f=new Ext.tree.TreeNode({text:"Advanced",allowDrag:false,allowDrop:false,iconCls:"headerShapeRepImg",cls:"headerShapeRep",singleClickExpand:true}));f.render();f.expand();var e=JSON.parse(c.responseText),g;for(var d=0;d<e.length;d++){g=new Ext.tree.TreeNode({text:e[d].title,allowDrag:true,allowDrop:false,iconCls:"ShapeRepEntreeImg",cls:"ShapeRepEntree",listeners:{dblclick:function(h,k){window.location="/oryx/editor;bpmn2.0?template=true&userId="+ORYX.CONFIG.USER_ID+"#"+this.url}}});g.url=e[d].value;f.appendChild(g);g.render()}},onFailure:function(d){var c="FATAL: REST query to /backend/poem/jobdefinition failed.";if(console){console.log(c);console.log(d)}alert(c)}});if(this.shapeList.firstChild.firstChild){this.shapeList.firstChild.firstChild.expand(false,true)}},createStencilTreeNode:function(a,b){var d=new Ext.tree.TreeNode({text:b.title(),icon:b.icon(),allowDrag:false,allowDrop:false,iconCls:"ShapeRepEntreeImg",cls:"ShapeRepEntree"});a.appendChild(d);d.render();var c=d.getUI();c.elNode.setAttributeNS(null,"title",b.description());Ext.dd.Registry.register(c.elNode,{node:c.node,handles:[c.elNode,c.textNode].concat($A(c.elNode.childNodes)),isHandle:false,type:b.id(),namespace:b.namespace()})},drop:function(k,g,b){this._lastOverElement=undefined;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.added"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.attached"});var h=k.getProxy();if(h.dropStatus==h.dropNotAllowed){return}if(!this._currentParent){return}var f=Ext.dd.Registry.getHandle(g.DDM.currentTarget);var o=b.getXY();var l={x:o[0],y:o[1]};var m=this.facade.getCanvas().node.getScreenCTM();l.x-=m.e;l.y-=m.f;l.x/=m.a;l.y/=m.d;l.x-=document.documentElement.scrollLeft;l.y-=document.documentElement.scrollTop;var n=this._currentParent.absoluteXY();l.x-=n.x;l.y-=n.y;f.position=l;if(this._canAttach&&this._currentParent instanceof ORYX.Core.Node){f.parent=undefined}else{f.parent=this._currentParent}var d=ORYX.Core.Command.extend({construct:function(r,p,s,a,q){this.option=r;this.currentParent=p;this.canAttach=s;this.position=a;this.facade=q;this.selection=this.facade.getSelection();this.shape;this.parent},execute:function(){if(!this.shape){this.shape=this.facade.createShape(f);this.parent=this.shape.parent}else{this.parent.add(this.shape)}if(this.canAttach&&this.currentParent instanceof ORYX.Core.Node&&this.shape.dockers.length>0){var a=this.shape.dockers[0];if(this.currentParent.parent instanceof ORYX.Core.Node){this.currentParent.parent.add(a.parent)}a.bounds.centerMoveTo(this.position);a.setDockedShape(this.currentParent)}this.facade.setSelection([this.shape]);this.facade.getCanvas().update();this.facade.updateSelection()},rollback:function(){this.facade.deleteShape(this.shape);this.facade.setSelection(this.selection.without(this.shape));this.facade.getCanvas().update();this.facade.updateSelection()}});var e=this.facade.eventCoordinates(b.browserEvent);var c=new d(f,this._currentParent,this._canAttach,e,this.facade);this.facade.executeCommands([c]);this._currentParent=undefined},beforeDragOver:function(h,f,b){var e=this.facade.eventCoordinates(b.browserEvent);var m=this.facade.getCanvas().getAbstractShapesAtPosition(e);if(m.length<=0){var a=h.getProxy();a.setStatus(a.dropNotAllowed);a.sync();return false}var c=m.last();if(m.lenght==1&&m[0] instanceof ORYX.Core.Canvas){return false}else{var d=Ext.dd.Registry.getHandle(f.DDM.currentTarget);var k=this.facade.getStencilSets()[d.namespace];var l=k.stencil(d.type);if(l.type()==="node"){var g=m.reverse().find(function(n){return(n instanceof ORYX.Core.Canvas||n instanceof ORYX.Core.Node||n instanceof ORYX.Core.Edge)});if(g!==this._lastOverElement){this._canAttach=undefined;this._canContain=undefined}if(g){if(!(g instanceof ORYX.Core.Canvas)&&g.isPointOverOffset(e.x,e.y)&&this._canAttach==undefined){this._canAttach=this.facade.getRules().canConnect({sourceShape:g,edgeStencil:l,targetStencil:l});if(this._canAttach){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"shapeRepo.attached",elements:[g],style:ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE,color:ORYX.CONFIG.SELECTION_VALID_COLOR});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.added"});this._canContain=undefined}}if(!(g instanceof ORYX.Core.Canvas)&&!g.isPointOverOffset(e.x,e.y)){this._canAttach=this._canAttach==false?this._canAttach:undefined}if(this._canContain==undefined&&!this._canAttach){this._canContain=this.facade.getRules().canContain({containingShape:g,containedStencil:l});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"shapeRepo.added",elements:[g],color:this._canContain?ORYX.CONFIG.SELECTION_VALID_COLOR:ORYX.CONFIG.SELECTION_INVALID_COLOR});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.attached"})}this._currentParent=this._canContain||this._canAttach?g:undefined;this._lastOverElement=g;var a=h.getProxy();a.setStatus(this._currentParent?a.dropAllowed:a.dropNotAllowed);a.sync()}}else{this._currentParent=this.facade.getCanvas();var a=h.getProxy();a.setStatus(a.dropAllowed);a.sync()}}return false}};ORYX.Plugins.ShapeRepository=Clazz.extend(ORYX.Plugins.ShapeRepository);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.FragmentRepository=Clazz.extend({facade:undefined,construct:function(c){this.facade=c;this._currentParent;this._canContain=undefined;this._canAttach=undefined;this.shapeList=new Ext.tree.TreeNode({});var a=new Ext.tree.TreePanel({cls:"shaperepository",loader:new Ext.tree.TreeLoader(),root:this.shapeList,autoScroll:true,rootVisible:false,lines:false,autoHeight:true,anchors:"0, -30"});var d=this.facade.addToRegion("east",a,ORYX.I18N.ShapeRepository.title);var b=new Ext.dd.DragZone(this.shapeList.getUI().getEl(),{shadow:!Ext.isMac});b.afterDragDrop=this.drop.bind(this,b);b.beforeDragEnter=function(){this._lastOverElement=false;return true}.bind(this);this.setStencilSets();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,this.setStencilSets.bind(this))},setStencilSets:function(){var c=this.shapeList.firstChild;while(c){this.shapeList.removeChild(c);c=this.shapeList.firstChild}var a;var b="Fragment Repository";this.shapeList.appendChild(a=new Ext.tree.TreeNode({text:b,allowDrag:false,allowDrop:false,iconCls:"headerShapeRepImg",cls:"headerShapeRep",singleClickExpand:true}));a.render();a.expand();this.createStencilTreeNode(a,"description");if(this.shapeList.firstChild.firstChild){this.shapeList.firstChild.firstChild.expand(false,true)}},createStencilTreeNode:function(a,b){var d=new Ext.tree.TreeNode({text:"Task",icon:ORYX.PATH+"/stencilsets/bpmn2.0/icons/activity/task.png",allowDrag:false,allowDrop:false,iconCls:"ShapeRepEntreeImg",cls:"ShapeRepEntree"});a.appendChild(d);d.render();var c=d.getUI();c.elNode.setAttributeNS(null,"title",b);Ext.dd.Registry.register(c.elNode,{node:c.node,handles:[c.elNode,c.textNode].concat($A(c.elNode.childNodes)),isHandle:false,type:"http://b3mn.org/stencilset/bpmn2.0#Task",namespace:"http://b3mn.org/stencilset/bpmn2.0#"})},drop:function(b,g,f){this._lastOverElement=undefined;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.added"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.attached"});var c=b.getProxy();if(c.dropStatus==c.dropNotAllowed){return}var h={resourceId:"oryx-canvas123",properties:{id:"",name:"",documentation:"",auditing:"",monitoring:"",version:"",author:"",language:"English",namespaces:"",targetnamespace:"http://www.omg.org/bpmn20",expressionlanguage:"http://www.w3.org/1999/XPath",typelanguage:"http://www.w3.org/2001/XMLSchema",creationdate:"",modificationdate:""},stencil:{id:"BPMNDiagram"},childShapes:[{resourceId:"oryx_C2AE5B00-4718-4FD3-A60B-8B0C300223F2",properties:{id:"",name:"",documentation:"",auditing:"",monitoring:"",categories:"",startquantity:1,completionquantity:1,status:"None",performers:"",properties:"",inputsets:"",inputs:"",outputsets:"",outputs:"",iorules:"",testtime:"After",mi_condition:"",mi_flowcondition:"All",isforcompensation:"",assignments:"",pool:"",lanes:"",looptype:"None",loopcondition:"",loopcounter:1,loopmaximum:1,callacitivity:"",activitytype:"Task",tasktype:"Send",inmessage:"",outmessage:"",implementation:"webService",resources:"",complexmi_condition:"",messageref:"",operationref:"",taskref:"",instantiate:"",script:"",script_language:"",bgcolor:"#ffffcc"},stencil:{id:"Task"},childShapes:[],outgoing:[],bounds:{lowerRight:{x:251,y:180},upperLeft:{x:151,y:100}},dockers:[]}],bounds:{lowerRight:{x:1485,y:1050},upperLeft:{x:0,y:0}},stencilset:{url:ORYX.PATH+"/stencilsets/bpmn2.0/bpmn2.0.json",namespace:"http://b3mn.org/stencilset/bpmn2.0#"},ssextensions:["http://oryx-editor.org/stencilsets/extensions/bpmnComplianceTemplate#"]};var e=h.childShapes[0].bounds.upperLeft.x;var d=f.getXY();var a=this.facade.getCanvas().node.getScreenCTM();d[0]-=a.e;d[1]-=a.f;d[0]/=a.a;d[1]/=a.d;d[0]-=document.documentElement.scrollLeft;d[1]-=document.documentElement.scrollTop;h.childShapes[0].bounds.upperLeft.x=d[0];h.childShapes[0].bounds.upperLeft.y=d[1];h.childShapes[0].bounds.lowerRight.x=d[0]+100;h.childShapes[0].bounds.lowerRight.y=d[1]+80;this.facade.importJSON(h,true)},beforeDragOver:function(h,f,b){var e=this.facade.eventCoordinates(b.browserEvent);var m=this.facade.getCanvas().getAbstractShapesAtPosition(e);if(m.length<=0){var a=h.getProxy();a.setStatus(a.dropNotAllowed);a.sync();return false}var c=m.last();if(m.lenght==1&&m[0] instanceof ORYX.Core.Canvas){return false}else{var d=Ext.dd.Registry.getHandle(f.DDM.currentTarget);var k=this.facade.getStencilSets()[d.namespace];var l=k.stencil(d.type);if(l.type()==="node"){var g=m.reverse().find(function(n){return(n instanceof ORYX.Core.Canvas||n instanceof ORYX.Core.Node||n instanceof ORYX.Core.Edge)});if(g!==this._lastOverElement){this._canAttach=undefined;this._canContain=undefined}if(g){if(!(g instanceof ORYX.Core.Canvas)&&g.isPointOverOffset(e.x,e.y)&&this._canAttach==undefined){this._canAttach=this.facade.getRules().canConnect({sourceShape:g,edgeStencil:l,targetStencil:l});if(this._canAttach){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"shapeRepo.attached",elements:[g],style:ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE,color:ORYX.CONFIG.SELECTION_VALID_COLOR});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.added"});this._canContain=undefined}}if(!(g instanceof ORYX.Core.Canvas)&&!g.isPointOverOffset(e.x,e.y)){this._canAttach=this._canAttach==false?this._canAttach:undefined}if(this._canContain==undefined&&!this._canAttach){this._canContain=this.facade.getRules().canContain({containingShape:g,containedStencil:l});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"shapeRepo.added",elements:[g],color:this._canContain?ORYX.CONFIG.SELECTION_VALID_COLOR:ORYX.CONFIG.SELECTION_INVALID_COLOR});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"shapeRepo.attached"})}this._currentParent=this._canContain||this._canAttach?g:undefined;this._lastOverElement=g;var a=h.getProxy();a.setStatus(this._currentParent?a.dropAllowed:a.dropNotAllowed);a.sync()}}else{this._currentParent=this.facade.getCanvas();var a=h.getProxy();a.setStatus(a.dropAllowed);a.sync()}}return false}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.PropertyWindow={facade:undefined,construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHOW_PROPERTYWINDOW,this.init.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.selectDiagram.bind(this));this.init()},init:function(){this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",null,["div"]);this.currentDateFormat;this.popularProperties=[];this.properties=[];this.shapeSelection=new Hash();this.shapeSelection.shapes=new Array();this.shapeSelection.commonProperties=new Array();this.shapeSelection.commonPropertiesValues=new Hash();this.updaterFlag=false;this.columnModel=new Ext.grid.ColumnModel([{header:ORYX.I18N.PropertyWindow.name,dataIndex:"name",width:90,sortable:true,renderer:this.tooltipRenderer.bind(this)},{header:ORYX.I18N.PropertyWindow.value,dataIndex:"value",id:"propertywindow_column_value",width:110,editor:new Ext.form.TextField({allowBlank:false}),renderer:this.renderer.bind(this)},{header:"Pop",dataIndex:"popular",hidden:true,sortable:true}]);this.dataSource=new Ext.data.GroupingStore({proxy:new Ext.data.MemoryProxy(this.properties),reader:new Ext.data.ArrayReader({},[{name:"popular"},{name:"name"},{name:"value"},{name:"icons"},{name:"gridProperties"}]),sortInfo:{field:"popular",direction:"ASC"},sortData:function(c,d){d=d||"ASC";var a=this.fields.get(c).sortType;var b=function(f,e){var l=a(f.data[c]),k=a(e.data[c]);var h=f.data.popular,g=e.data.popular;return h&&!g?-1:(!h&&g?1:(l>k?1:(l<k?-1:0)))};this.data.sort(d,b);if(this.snapshot&&this.snapshot!=this.data){this.snapshot.sort(d,b)}},groupField:"popular"});this.dataSource.load();this.grid=new Ext.grid.EditorGridPanel({clicksToEdit:1,stripeRows:true,autoExpandColumn:"propertywindow_column_value",width:"auto",colModel:this.columnModel,enableHdMenu:false,view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:"{[values.rs.first().data.popular ? ORYX.I18N.PropertyWindow.oftenUsed : ORYX.I18N.PropertyWindow.moreProps]}"}),store:this.dataSource});region=this.facade.addToRegion("centerSouth",new Ext.Panel({autoHeight:true,layout:"fit",border:false,title:"Properties",items:[this.grid]}),ORYX.I18N.PropertyWindow.title);this.grid.on("beforeedit",this.beforeEdit,this,true);this.grid.on("afteredit",this.afterEdit,this,true);this.grid.view.on("refresh",this.hideMoreAttrs,this,true);this.grid.enableColumnMove=false},selectDiagram:function(){this.shapeSelection.shapes=[this.facade.getCanvas()];this.setPropertyWindowTitle();this.identifyCommonProperties();this.createProperties()},specialKeyDown:function(b,a){if(b instanceof Ext.form.TextArea&&a.button==ORYX.CONFIG.KEY_Code_enter){return false}},tooltipRenderer:function(b,c,a){c.cellAttr='title="'+a.data.gridProperties.tooltip+'"';return b},renderer:function(b,c,a){this.tooltipRenderer(b,c,a);if(b instanceof Date){b=b.dateFormat(ORYX.I18N.PropertyWindow.dateFormat)}else{if(String(b).search("<a href='")<0){b=String(b).gsub("<","&lt;");b=String(b).gsub(">","&gt;");b=String(b).gsub("%","&#37;");b=String(b).gsub("&","&amp;");if(a.data.gridProperties.type==ORYX.CONFIG.TYPE_COLOR){b="<div class='prop-background-color' style='background-color:"+b+"' />"}a.data.icons.each(function(d){if(d.name==b){if(d.icon){b="<img src='"+d.icon+"' /> "+b}}})}}return b},beforeEdit:function(c){var d=this.dataSource.getAt(c.row).data.gridProperties.editor;var a=this.dataSource.getAt(c.row).data.gridProperties.renderer;if(d){this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);c.grid.getColumnModel().setEditor(1,d);d.field.row=c.row;d.render(this.grid);d.setSize(c.grid.getColumnModel().getColumnWidth(1),d.height)}else{return false}var b=this.dataSource.getAt(c.row).data.gridProperties.propId;this.oldValues=new Hash();this.shapeSelection.shapes.each(function(e){this.oldValues[e.getId()]=e.properties[b]}.bind(this))},afterEdit:function(e){e.grid.getStore().commitChanges();var c=e.record.data.gridProperties.propId;var h=this.shapeSelection.shapes;var b=this.oldValues;var f=e.value;var d=this.facade;var a=ORYX.Core.Command.extend({construct:function(){this.key=c;this.selectedElements=h;this.oldValues=b;this.newValue=f;this.facade=d},execute:function(){this.selectedElements.each(function(k){if(!k.getStencil().property(this.key).readonly()){k.setProperty(this.key,this.newValue)}}.bind(this));this.facade.setSelection(this.selectedElements);this.facade.getCanvas().update();this.facade.updateSelection()},rollback:function(){this.selectedElements.each(function(k){k.setProperty(this.key,this.oldValues[k.getId()])}.bind(this));this.facade.setSelection(this.selectedElements);this.facade.getCanvas().update();this.facade.updateSelection()}});var g=new a();this.facade.executeCommands([g]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,elements:h,key:c,value:e.value})},editDirectly:function(a,b){this.shapeSelection.shapes.each(function(d){if(!d.getStencil().property(a).readonly()){d.setProperty(a,b)}}.bind(this));var c=this.shapeSelection.shapes;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,elements:c,key:a,value:b});this.facade.getCanvas().update()},updateAfterInvalid:function(a){this.shapeSelection.shapes.each(function(b){if(!b.getStencil().property(a).readonly()){b.setProperty(a,this.oldValues[b.getId()]);b.update()}}.bind(this));this.facade.getCanvas().update()},dialogClosed:function(a){var b=this.field?this.field.row:this.row;this.scope.afterEdit({grid:this.scope.grid,record:this.scope.grid.getStore().getAt(b),value:a});this.scope.grid.startEditing(b,this.col)},setPropertyWindowTitle:function(){if(this.shapeSelection.shapes.length==1){region.setTitle(ORYX.I18N.PropertyWindow.title+" ("+this.shapeSelection.shapes.first().getStencil().title()+")")}else{region.setTitle(ORYX.I18N.PropertyWindow.title+" ("+this.shapeSelection.shapes.length+" "+ORYX.I18N.PropertyWindow.selected+")")}},setCommonPropertiesValues:function(){this.shapeSelection.commonPropertiesValues=new Hash();this.shapeSelection.commonProperties.each(function(d){var c=d.prefix()+"-"+d.id();var b=false;var a=this.shapeSelection.shapes.first();this.shapeSelection.shapes.each(function(e){if(a.properties[c]!=e.properties[c]){b=true}}.bind(this));if(!b){this.shapeSelection.commonPropertiesValues[c]=a.properties[c]}}.bind(this))},getStencilSetOfSelection:function(){var a=new Hash();this.shapeSelection.shapes.each(function(b){a[b.getStencil().id()]=b.getStencil()});return a},identifyCommonProperties:function(){this.shapeSelection.commonProperties.clear();var d=this.getStencilSetOfSelection();var c=d.values().first();var b=d.values().without(c);if(b.length==0){this.shapeSelection.commonProperties=c.properties()}else{var a=new Hash();c.properties().each(function(e){a[e.namespace()+"-"+e.id()+"-"+e.type()]=e});b.each(function(e){var f=new Hash();e.properties().each(function(g){if(a[g.namespace()+"-"+g.id()+"-"+g.type()]){f[g.namespace()+"-"+g.id()+"-"+g.type()]=g}});a=f});this.shapeSelection.commonProperties=a.values()}},onSelectionChanged:function(a){this.grid.stopEditing();this.shapeSelection.shapes=a.elements;if(a.elements.length==0){this.shapeSelection.shapes=[this.facade.getCanvas()]}if(a.subSelection){this.shapeSelection.shapes=[a.subSelection]}this.setPropertyWindowTitle();this.identifyCommonProperties();this.setCommonPropertiesValues();this.createProperties()},createProperties:function(){this.properties=[];this.popularProperties=[];if(this.shapeSelection.commonProperties){this.shapeSelection.commonProperties.each((function(p,g){var u=p.prefix()+"-"+p.id();var v=p.title();var s=[];var l=this.shapeSelection.commonPropertiesValues[u];var a=undefined;var b=null;var k=false;if(!p.readonly()){switch(p.type()){case ORYX.CONFIG.TYPE_STRING:if(p.wrapLines()){var e=new Ext.form.TextArea({alignment:"tl-tl",allowBlank:p.optional(),msgTarget:"title",maxLength:p.length()});e.on("keyup",function(x,w){this.editDirectly(u,x.getValue())}.bind(this));a=new Ext.Editor(e)}else{var h=new Ext.form.TextField({allowBlank:p.optional(),msgTarget:"title",maxLength:p.length()});h.on("keyup",function(w,x){this.editDirectly(u,w.getValue())}.bind(this));h.on("blur",function(w){if(!w.isValid(false)){this.updateAfterInvalid(u)}}.bind(this));h.on("specialkey",function(w,x){if(!w.isValid(false)){this.updateAfterInvalid(u)}}.bind(this));a=new Ext.Editor(h)}break;case ORYX.CONFIG.TYPE_BOOLEAN:var t=new Ext.form.Checkbox();t.on("check",function(x,w){this.editDirectly(u,w)}.bind(this));a=new Ext.Editor(t);break;case ORYX.CONFIG.TYPE_INTEGER:var c=new Ext.form.NumberField({allowBlank:p.optional(),allowDecimals:false,msgTarget:"title",minValue:p.min(),maxValue:p.max()});c.on("keyup",function(w,x){this.editDirectly(u,w.getValue())}.bind(this));a=new Ext.Editor(c);break;case ORYX.CONFIG.TYPE_FLOAT:var c=new Ext.form.NumberField({allowBlank:p.optional(),allowDecimals:true,msgTarget:"title",minValue:p.min(),maxValue:p.max()});c.on("keyup",function(w,x){this.editDirectly(u,w.getValue())}.bind(this));a=new Ext.Editor(c);break;case ORYX.CONFIG.TYPE_COLOR:var r=new Ext.ux.ColorField({allowBlank:p.optional(),msgTarget:"title",facade:this.facade});a=new Ext.Editor(r);break;case ORYX.CONFIG.TYPE_CHOICE:var o=p.items();if(console){console.log(p)}var d=[];o.each(function(w){if(w.value()==l){l=w.title()}if(w.refToView()[0]){k=true}d.push([w.icon(),w.title(),w.value()]);s.push({name:w.title(),icon:w.icon()})});var f=new Ext.data.SimpleStore({fields:[{name:"icon"},{name:"title"},{name:"value"}],data:d});var q=new Ext.form.ComboBox({tpl:'<tpl for="."><div class="x-combo-list-item">{[(values.icon) ? "<img src=\'" + values.icon + "\' />" : ""]} {title}</div></tpl>',store:f,displayField:"title",valueField:"value",typeAhead:true,mode:"local",triggerAction:"all",selectOnFocus:true});q.on("select",function(y,w,x){this.editDirectly(u,y.getValue())}.bind(this));a=new Ext.Editor(q);break;case ORYX.CONFIG.TYPE_DATE:var n=ORYX.I18N.PropertyWindow.dateFormat;if(!(l instanceof Date)){l=Date.parseDate(l,n)}a=new Ext.Editor(new Ext.form.DateField({allowBlank:p.optional(),format:n,msgTarget:"title"}));break;case ORYX.CONFIG.TYPE_TEXT:var m=new Ext.form.ComplexTextField({allowBlank:p.optional(),dataSource:this.dataSource,grid:this.grid,row:g,facade:this.facade});m.on("dialogClosed",this.dialogClosed,{scope:this,row:g,col:1,field:m});a=new Ext.Editor(m);break;case ORYX.CONFIG.TYPE_COMPLEX:var m=new Ext.form.ComplexListField({allowBlank:p.optional()},p.complexItems(),u,this.facade);m.on("dialogClosed",this.dialogClosed,{scope:this,row:g,col:1,field:m});a=new Ext.Editor(m);break;case"CPNString":var h=new Ext.form.TextField({allowBlank:p.optional(),msgTarget:"title",maxLength:p.length(),enableKeyEvents:true});h.on("keyup",function(w,x){this.editDirectly(u,w.getValue());console.log(w.getValue());alert("huhu")}.bind(this));a=new Ext.Editor(h);break;default:var h=new Ext.form.TextField({allowBlank:p.optional(),msgTarget:"title",maxLength:p.length(),enableKeyEvents:true});h.on("keyup",function(w,x){this.editDirectly(u,w.getValue())}.bind(this));a=new Ext.Editor(h)}a.on("beforehide",this.facade.enableEvent.bind(this,ORYX.CONFIG.EVENT_KEYDOWN));a.on("specialkey",this.specialKeyDown.bind(this))}else{if(p.type()===ORYX.CONFIG.TYPE_URL||p.type()===ORYX.CONFIG.TYPE_DIAGRAM_LINK){l=String(l).search("http")!==0?("http://"+l):l;l="<a href='"+l+"' target='_blank'>"+l.split("://")[1]+"</a>"}}if(p.visible()){if(p.refToView()[0]||k||p.popular()){p.setPopular()}if(p.popular()){this.popularProperties.push([p.popular(),v,l,s,{editor:a,propId:u,type:p.type(),tooltip:p.description(),renderer:b}])}else{this.properties.push([p.popular(),v,l,s,{editor:a,propId:u,type:p.type(),tooltip:p.description(),renderer:b}])}}}).bind(this))}this.setProperties()},hideMoreAttrs:function(a){if(this.properties.length<=0){return}this.grid.view.toggleGroup(this.grid.view.getGroupId(this.properties[0][0]),false);this.grid.view.un("refresh",this.hideMoreAttrs,this)},setProperties:function(){var a=this.popularProperties.concat(this.properties);this.dataSource.loadData(a)}};ORYX.Plugins.PropertyWindow=Clazz.extend(ORYX.Plugins.PropertyWindow);Ext.form.ComplexListField=function(b,a,c,d){Ext.form.ComplexListField.superclass.constructor.call(this,b);this.items=a;this.key=c;this.facade=d};Ext.extend(Ext.form.ComplexListField,Ext.form.TriggerField,{triggerClass:"x-form-complex-trigger",readOnly:true,emptyText:ORYX.I18N.PropertyWindow.clickIcon,buildValue:function(){var f=this.grid.getStore();f.commitChanges();if(f.getCount()==0){return""}var d="[";for(var c=0;c<f.getCount();c++){var e=f.getAt(c);d+="{";for(var a=0;a<this.items.length;a++){var b=this.items[a].id();d+=b+":"+(""+e.get(b)).toJSON();if(a<(this.items.length-1)){d+=", "}}d+="}";if(c<(f.getCount()-1)){d+=", "}}d+="]";d="{'totalCount':"+f.getCount().toJSON()+", 'items':"+d+"}";return Object.toJSON(d.evalJSON())},getFieldKey:function(){return this.key},getValue:function(){if(this.grid){return this.buildValue()}else{if(this.data==undefined){return""}else{return this.data}}},setValue:function(a){if(a.length>0){if(this.data==undefined){this.data=a}}},keydownHandler:function(a){return false},dialogListeners:{show:function(){this.onFocus();this.facade.registerOnEvent(ORYX.CONFIG.EVENT_KEYDOWN,this.keydownHandler.bind(this));this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN);return},hide:function(){var a=this.dialogListeners;this.dialog.un("show",a.show,this);this.dialog.un("hide",a.hide,this);this.dialog.destroy(true);this.grid.destroy(true);delete this.grid;delete this.dialog;this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_KEYDOWN,this.keydownHandler.bind(this));this.facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN);this.fireEvent("dialogClosed",this.data);Ext.form.ComplexListField.superclass.setValue.call(this,this.data)}},buildInitial:function(f,a){var b=new Hash();for(var c=0;c<a.length;c++){var e=a[c].id();b[e]=a[c].value()}var d=Ext.data.Record.create(f);return new d(b)},buildColumnModel:function(m){var h=[];for(var c=0;c<this.items.length;c++){var a=this.items[c].id();var d=this.items[c].name();var b=this.items[c].width();var g=this.items[c].type();var e;if(g==ORYX.CONFIG.TYPE_STRING){e=new Ext.form.TextField({allowBlank:this.items[c].optional(),width:b})}else{if(g==ORYX.CONFIG.TYPE_CHOICE){var f=this.items[c].items();var l=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",m,["select",{style:"display:none"}]);var k=new Ext.Template('<option value="{value}">{value}</option>');f.each(function(n){k.append(l,{value:n.value()})});e=new Ext.form.ComboBox({typeAhead:true,triggerAction:"all",transform:l,lazyRender:true,msgTarget:"title",width:b})}else{if(g==ORYX.CONFIG.TYPE_BOOLEAN){e=new Ext.form.Checkbox({width:b})}}}h.push({id:a,header:d,dataIndex:a,resizable:true,editor:e,width:b})}return new Ext.grid.ColumnModel(h)},afterEdit:function(a){a.grid.getStore().commitChanges()},beforeEdit:function(h){var a=this.grid.getView().getScrollState();var b=h.column;var p=h.row;var e=this.grid.getColumnModel().config[b].id;for(var g=0;g<this.items.length;g++){var o=this.items[g];var m=o.disable();if(m!=undefined){var n=this.grid.getStore().getAt(p).get(o.id());for(var d=0;d<m.length;d++){var f=m[d];if(f.value==n){for(var c=0;c<f.items.length;c++){var l=f.items[c];if(l==e){this.grid.getColumnModel().getCellEditor(b,p).disable();return}}}}}}this.grid.getColumnModel().getCellEditor(b,p).enable()},onTriggerClick:function(){if(this.disabled){return}var dialogWidth=0;var recordType=[];for(var i=0;i<this.items.length;i++){var id=this.items[i].id();var width=this.items[i].width();var type=this.items[i].type();if(type==ORYX.CONFIG.TYPE_CHOICE){type=ORYX.CONFIG.TYPE_STRING}dialogWidth+=width;recordType[i]={name:id,type:type}}if(dialogWidth>800){dialogWidth=800}dialogWidth+=22;var data=this.data;if(data==""){data="{}"}var ds=new Ext.data.Store({proxy:new Ext.data.MemoryProxy(eval("("+data+")")),reader:new Ext.data.JsonReader({root:"items",totalProperty:"totalCount"},recordType)});ds.load();var cm=this.buildColumnModel();this.grid=new Ext.grid.EditorGridPanel({store:ds,cm:cm,stripeRows:true,clicksToEdit:1,autoHeight:true,selModel:new Ext.grid.CellSelectionModel()});var toolbar=new Ext.Toolbar([{text:ORYX.I18N.PropertyWindow.add,handler:function(){var ds=this.grid.getStore();var index=ds.getCount();this.grid.stopEditing();var p=this.buildInitial(recordType,this.items);ds.insert(index,p);ds.commitChanges();this.grid.startEditing(index,0)}.bind(this)},{text:ORYX.I18N.PropertyWindow.rem,handler:function(){var ds=this.grid.getStore();var selection=this.grid.getSelectionModel().getSelectedCell();if(selection==undefined){return}this.grid.getSelectionModel().clearSelections();this.grid.stopEditing();var record=ds.getAt(selection[0]);ds.remove(record);ds.commitChanges()}.bind(this)}]);this.dialog=new Ext.Window({autoScroll:true,autoCreate:true,title:ORYX.I18N.PropertyWindow.complex,height:200,width:dialogWidth,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){this.dialog.hide}.bind(this)}],items:[toolbar,this.grid],bodyStyle:"background-color:#FFFFFF",buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){this.grid.stopEditing();this.data=this.buildValue();this.dialog.hide()}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.dialog.hide()}.bind(this)}]});this.dialog.on(Ext.apply({},this.dialogListeners,{scope:this}));this.dialog.show();this.grid.on("beforeedit",this.beforeEdit,this,true);this.grid.on("afteredit",this.afterEdit,this,true);this.grid.render()}});Ext.form.ComplexTextField=Ext.extend(Ext.form.TriggerField,{defaultAutoCreate:{tag:"textarea",rows:1,style:"height:16px;overflow:hidden;"},onTriggerClick:function(){if(this.disabled){return}var b=new Ext.form.TextArea({anchor:"100% 100%",value:this.value,listeners:{focus:function(){this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN)}.bind(this)}});var a=new Ext.Window({layout:"anchor",autoCreate:true,title:ORYX.I18N.PropertyWindow.text,height:200,width:200,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,keys:[{key:27,fn:function(){a.hide()}.bind(this)}],items:[b],listeners:{hide:function(){this.fireEvent("dialogClosed",this.value);a.destroy()}.bind(this)},buttons:[{text:ORYX.I18N.PropertyWindow.ok,handler:function(){var c=b.getValue();this.setValue(c);this.dataSource.getAt(this.row).set("value",c);this.dataSource.commitChanges();a.hide()}.bind(this)},{text:ORYX.I18N.PropertyWindow.cancel,handler:function(){this.setValue(this.value);a.hide()}.bind(this)}]});a.show();b.render();this.grid.stopEditing();b.focus(false,100)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Loading={construct:function(a){this.facade=a;this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.facade.getCanvas().getHTMLContainer().parentNode,["div",{"class":"LoadingIndicator"},""]);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_ENABLE,this.enableLoading.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_DISABLE,this.disableLoading.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADING_STATUS,this.showStatus.bind(this));this.disableLoading()},enableLoading:function(a){if(a.text){this.node.innerHTML=a.text+"..."}else{this.node.innerHTML=ORYX.I18N.Loading.waiting}this.node.removeClassName("StatusIndicator");this.node.addClassName("LoadingIndicator");this.node.style.display="block";var b=this.facade.getCanvas().rootNode.parentNode.parentNode.parentNode.parentNode;this.node.style.top=b.offsetTop+"px";this.node.style.left=b.offsetLeft+"px"},disableLoading:function(){this.node.style.display="none"},showStatus:function(a){if(a.text){this.node.innerHTML=a.text;this.node.addClassName("StatusIndicator");this.node.removeClassName("LoadingIndicator");this.node.style.display="block";var c=this.facade.getCanvas().rootNode.parentNode.parentNode.parentNode.parentNode;this.node.style.top=c.offsetTop+"px";this.node.style.left=c.offsetLeft+"px";var b=a.timeout?a.timeout:2000;window.setTimeout((function(){this.disableLoading()}).bind(this),b)}}};ORYX.Plugins.Loading=Clazz.extend(ORYX.Plugins.Loading);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.CanvasResize=Clazz.extend({construct:function(a){this.facade=a;new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"N",this.resize.bind(this));new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"W",this.resize.bind(this));new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"E",this.resize.bind(this));new ORYX.Plugins.CanvasResizeButton(this.facade.getCanvas(),"S",this.resize.bind(this))},resize:function(a,c){resizeCanvas=function(l,m,o){var f=o.getCanvas();var n=f.bounds;var h=o.getCanvas().getHTMLContainer().parentNode.parentNode;if(l=="E"||l=="W"){f.setSize({width:(n.width()+m)*f.zoomLevel,height:(n.height())*f.zoomLevel})}else{if(l=="S"||l=="N"){f.setSize({width:(n.width())*f.zoomLevel,height:(n.height()+m)*f.zoomLevel})}}if(l=="N"||l=="W"){var g=l=="N"?{x:0,y:m}:{x:m,y:0};f.getChildNodes(false,function(q){q.bounds.moveBy(g)});var k=f.getChildEdges().findAll(function(q){return q.getAllDockedShapes().length>0});var p=k.collect(function(q){return q.dockers.findAll(function(r){return !r.getDockedShape()})}).flatten();p.each(function(q){q.bounds.moveBy(g)})}else{if(l=="S"){h.scrollTop+=m}else{if(l=="E"){h.scrollLeft+=m}}}f.update();o.updateSelection()};var b=ORYX.Core.Command.extend({construct:function(f,h,g){this.position=f;this.extentionSize=h;this.facade=g},execute:function(){resizeCanvas(this.position,this.extentionSize,this.facade)},rollback:function(){resizeCanvas(this.position,-this.extentionSize,this.facade)},update:function(){}});var d=ORYX.CONFIG.CANVAS_RESIZE_INTERVAL;if(c){d=-d}var e=new b(a,d,this.facade);this.facade.executeCommands([e])}});ORYX.Plugins.CanvasResizeButton=Clazz.extend({construct:function(c,h,n){this.canvas=c;var k=c.getHTMLContainer().parentNode.parentNode.parentNode;window.myParent=k;var d=k.firstChild;var b=d.firstChild.firstChild;var a=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",k,["div",{"class":"canvas_resize_indicator canvas_resize_indicator_grow "+h,title:ORYX.I18N.RESIZE.tipGrow+ORYX.I18N.RESIZE[h]}]);var e=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",k,["div",{"class":"canvas_resize_indicator canvas_resize_indicator_shrink "+h,title:ORYX.I18N.RESIZE.tipShrink+ORYX.I18N.RESIZE[h]}]);var f=60;var m=function(p){if(p.target!=k&&p.target!=d&&p.target!=d.firstChild&&p.target!=b&&p.target!=d){return false}var s=p.layerX;var r=p.layerY;if((s-d.scrollLeft)<0||Ext.isSafari){s+=d.scrollLeft}if((r-d.scrollTop)<0||Ext.isSafari){r+=d.scrollTop}if(h=="N"){return r<f+d.firstChild.offsetTop}else{if(h=="W"){return s<f+d.firstChild.offsetLeft}else{if(h=="E"){var o=(d.offsetWidth-(d.firstChild.offsetLeft+d.firstChild.offsetWidth));if(o<0){o=0}return s>d.scrollWidth-o-f}else{if(h=="S"){var q=(d.offsetHeight-(d.firstChild.offsetTop+d.firstChild.offsetHeight));if(q<0){q=0}return r>d.scrollHeight-q-f}}}}return false};var l=(function(){a.show();var p,v,o,u;try{var t=this.canvas.getRootNode().childNodes[1].getBBox();p=t.x;v=t.y;o=t.x+t.width;u=t.y+t.height}catch(s){this.canvas.getChildShapes(true).each(function(y){var A=y.absoluteBounds();var z=A.upperLeft();var w=A.lowerRight();if(p==undefined){p=z.x;v=z.y;o=w.x;u=w.y}else{p=Math.min(p,z.x);v=Math.min(v,z.y);o=Math.max(o,w.x);u=Math.max(u,w.y)}})}var x=c.bounds.width();var r=c.bounds.height();var q=c.getChildNodes().size()==0;if(h=="N"&&(v>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL||(q&&r>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL))){e.show()}else{if(h=="E"&&(x-o)>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL){e.show()}else{if(h=="S"&&(r-u)>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL){e.show()}else{if(h=="W"&&(p>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL||(q&&x>ORYX.CONFIG.CANVAS_RESIZE_INTERVAL))){e.show()}else{e.hide()}}}}}).bind(this);var g=function(){a.hide();e.hide()};d.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,function(o){if(m(o)){l()}else{g()}},false);a.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,function(o){l()},true);e.addEventListener(ORYX.CONFIG.EVENT_MOUSEOVER,function(o){l()},true);k.addEventListener(ORYX.CONFIG.EVENT_MOUSEOUT,function(o){g()},true);g();a.addEventListener("click",function(){n(h);l()},true);e.addEventListener("click",function(){n(h,true);l()},true)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.RenameShapes=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DBLCLICK,this.actOnDBLClick.bind(this));this.facade.offer({keyCodes:[{keyCode:113,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.renamePerF2.bind(this)});document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this.hide.bind(this),true);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_REGISTER_LABEL_TEMPLATE,this.registerTemplate.bind(this));this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_REGISTER_LABEL_TEMPLATE,empty:true})},registerTemplate:function(a){this.label_templates=this.label_templates||[];this.label_templates.push({edit:"function"==typeof(a.edit_template)?a.edit_template:function(b){return b},render:"function"==typeof(a.render_template)?a.render_template:function(b){return b}})},renamePerF2:function renamePerF2(){var a=this.facade.getSelection();this.actOnDBLClick(undefined,a.first())},getEditableProperties:function getEditableProperties(a){var b=a.getStencil().properties().findAll(function(c){return(c.refToView()&&c.refToView().length>0&&c.directlyEditable())});return b.findAll(function(c){return !c.readonly()&&c.type()==ORYX.CONFIG.TYPE_STRING})},getPropertyForLabel:function getPropertyForLabel(c,a,b){return c.find(function(d){return d.refToView().any(function(e){return b.id==a.id+e})})},actOnDBLClick:function actOnDBLClick(h,d){if(!(d instanceof ORYX.Core.Shape)){return}this.destroy();var e=this.getEditableProperties(d);var f=e.collect(function(m){return m.refToView()}).flatten().compact();var b=d.getLabels().findAll(function(m){return f.any(function(n){return m.id.endsWith(n)})});if(b.length==0){return}var c=b.length==1?b[0]:null;if(!c){c=b.find(function(m){return m.node==h.target||m.node==h.target.parentNode});if(!c){var k=this.facade.eventCoordinates(h);var l=this.facade.getCanvas().rootNode.lastChild.getScreenCTM();k.x*=l.a;k.y*=l.d;if(!d instanceof ORYX.Core.Node){var g=b.collect(function(o){var n=this.getCenterPosition(o.node);var m=Math.sqrt(Math.pow(n.x-k.x,2)+Math.pow(n.y-k.y,2));return{diff:m,label:o}}.bind(this));g.sort(function(n,m){return n.diff>m.diff});c=g[0].label}else{var g=b.collect(function(o){var n=this.getDifferenceCenterForNode(o.node);var m=Math.sqrt(Math.pow(n.x-k.x,2)+Math.pow(n.y-k.y,2));return{diff:m,label:o}}.bind(this));g.sort(function(n,m){return n.diff>m.diff});c=g[0].label}}}var a=this.getPropertyForLabel(e,d,c);this.showTextField(d,a,c)},showTextField:function showTextField(h,c,k){var g=this.facade.getCanvas().getHTMLContainer().id;var e;if(!(h instanceof ORYX.Core.Node)){var a=k.node.getBoundingClientRect();e=Math.max(150,a.width)}else{e=h.bounds.width()}if(!h instanceof ORYX.Core.Node){var b=this.getCenterPosition(k.node);b.x-=(e/2)}else{var b=h.absoluteBounds().center();b.x-=(e/2)}var d=c.prefix()+"-"+c.id();var f={renderTo:g,value:(function(n,m,l){this.label_templates.forEach(function(o){try{n=o.edit(n,m,l)}catch(p){ORYX.Log.error("Unable to render label template",p,o.edit)}});return n}.bind(this))(h.properties[d],d,h),x:(b.x<10)?10:b.x,y:b.y,width:Math.max(100,e),style:"position:absolute",allowBlank:c.optional(),maxLength:c.length(),emptyText:c.title(),cls:"x_form_text_set_absolute",listeners:{specialkey:this._specialKeyPressed.bind(this)}};if(c.wrapLines()){f.y-=30;f.grow=true;this.shownTextField=new Ext.form.TextArea(f)}else{f.y-=16;this.shownTextField=new Ext.form.TextField(f)}this.shownTextField.focus();this.shownTextField.on("blur",this.destroy.bind(this));this.shownTextField.on("change",function(p,q){var o=h;var m=o.properties[d];var r=(function(v,u,t){this.label_templates.forEach(function(w){try{v=w.render(v,u,t)}catch(x){ORYX.Log.error("Unable to render label template",x,w.render)}});return v}.bind(this))(q,d,h);var n=this.facade;if(m!=r){var l=ORYX.Core.Command.extend({construct:function(){this.el=o;this.propId=d;this.oldValue=m;this.newValue=r;this.facade=n},execute:function(){this.el.setProperty(this.propId,this.newValue);this.facade.setSelection([this.el]);this.facade.getCanvas().update();this.facade.updateSelection()},rollback:function(){this.el.setProperty(this.propId,this.oldValue);this.facade.setSelection([this.el]);this.facade.getCanvas().update();this.facade.updateSelection()}});var s=new l();this.facade.executeCommands([s])}}.bind(this));this.facade.disableEvent(ORYX.CONFIG.EVENT_KEYDOWN)},_specialKeyPressed:function _specialKeyPressed(c,b){var a=b.getKey();if(a==13&&(b.shiftKey||!c.initialConfig.grow)){c.fireEvent("change",null,c.getValue());c.fireEvent("blur")}else{if(a==b.ESC){c.fireEvent("blur")}}},getCenterPosition:function(f){var a={x:0,y:0};var c=f.getTransformToElement(this.facade.getCanvas().rootNode.lastChild);var h=this.facade.getCanvas().rootNode.lastChild.getScreenCTM();var b=f.getTransformToElement(f.parentNode);var d=undefined;a.x=c.e-b.e;a.y=c.f-b.f;try{d=f.getBBox()}catch(g){}if(d===null||typeof d==="undefined"||d.width==0||d.height==0){d={x:Number(f.getAttribute("x")),y:Number(f.getAttribute("y")),width:0,height:0}}a.x+=d.x;a.y+=d.y;a.x+=d.width/2;a.y+=d.height/2;a.x*=h.a;a.y*=h.d;return a},getDifferenceCenterForNode:function getDifferenceCenterForNode(b){var a=this.getCenterPosition(b);a.x=0;a.y=a.y+10;return a},hide:function(a){if(this.shownTextField&&(!a||!this.shownTextField.el||a.target!==this.shownTextField.el.dom)){this.shownTextField.onBlur()}},destroy:function(a){if(this.shownTextField){this.shownTextField.destroy();delete this.shownTextField;this.facade.enableEvent(ORYX.CONFIG.EVENT_KEYDOWN)}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ERDFSupport=Clazz.extend({facade:undefined,ERDFServletURL:"/erdfsupport",construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.ERDFSupport.exp,functionality:this.exportERDF.bind(this),group:"Export",dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/erdf_export_icon.png",description:ORYX.I18N.ERDFSupport.expDesc,index:0,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.ERDFSupport.imp,functionality:this.importERDF.bind(this),group:"Export",dropDownGroupIcon:ORYX.PATH+"images/import.png",icon:ORYX.PATH+"images/erdf_import_icon.png",description:ORYX.I18N.ERDFSupport.impDesc,index:1,minShape:0,maxShape:0})},importERDF:function(){this._showImportDialog()},exportERDF:function(){Ext.Msg.show({title:ORYX.I18N.ERDFSupport.deprTitle,msg:ORYX.I18N.ERDFSupport.deprText,buttons:Ext.Msg.YESNO,fn:function(b){if(b==="yes"){var a=this.facade.getERDF();this.openDownloadWindow(window.document.title+".xml",a)}}.bind(this),icon:Ext.MessageBox.WARNING})},sendRequest:function(b,d,e,a){var c=false;new Ajax.Request(b,{method:"POST",asynchronous:false,parameters:d,onSuccess:function(f){c=true;if(e){e(f.result)}}.bind(this),onFailure:function(f){if(a){a()}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.ERDFSupport.impFailed);ORYX.log.warn("Import ERDF failed: "+f.responseText)}}.bind(this)});return c},loadERDF:function(b,e,a){var c=b;c=c.startsWith("<?xml")?c:'<?xml version="1.0" encoding="utf-8"?>'+c+"";var f=new DOMParser();var d=f.parseFromString(c,"text/xml");if(d.firstChild.tagName=="parsererror"){Ext.MessageBox.show({title:ORYX.I18N.ERDFSupport.error,msg:ORYX.I18N.ERDFSupport.impFailed2+d.firstChild.textContent.escapeHTML(),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});if(a){a()}}else{if(!this.hasStencilSet(d)){if(a){a()}}else{this.facade.importERDF(d);if(e){e()}}}},hasStencilSet:function(e){var a=function(f,g){return $A(f.getElementsByTagName("div")).findAll(function(h){return $A(h.attributes).any(function(k){return k.nodeName=="class"&&k.nodeValue==g})})};var b=a(e,"-oryx-canvas")[0];if(!b){this.throwWarning(ORYX.I18N.ERDFSupport.noCanvas);return false}var c=$A(b.getElementsByTagName("a")).find(function(f){return f.getAttribute("rel")=="oryx-stencilset"});if(!c){this.throwWarning(ORYX.I18N.ERDFSupport.noSS);return false}var d=c.getAttribute("href").split("/");d=d[d.length-2]+"/"+d[d.length-1];return true},throwWarning:function(a){Ext.MessageBox.show({title:ORYX.I18N.Oryx.title,msg:a,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})},openXMLWindow:function(a){var b=window.open("data:application/xml,"+encodeURIComponent(a),"_blank","resizable=yes,width=600,height=600,toolbar=0,scrollbars=yes")},openDownloadWindow:function(b,c){var d=window.open("");if(d!=null){d.document.open();d.document.write("<html><body>");var a=d.document.createElement("form");d.document.body.appendChild(a);a.appendChild(this.createHiddenElement("download",c));a.appendChild(this.createHiddenElement("file",b));a.method="POST";d.document.write("</body></html>");d.document.close();a.action=ORYX.PATH+"/download";a.submit()}},createHiddenElement:function(a,b){var c=document.createElement("input");c.name=a;c.type="hidden";c.value=b;return c},_showImportDialog:function(a){var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.ERDFSupport.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.ERDFSupport.file,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var b=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.ERDFSupport.impERDF,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[c],buttons:[{text:ORYX.I18N.ERDFSupport.impBtn,handler:function(){var d=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.ERDFSupport.impProgress});d.show();window.setTimeout(function(){var e=c.items.items[2].getValue();this.loadERDF(e,function(){d.hide();b.hide()}.bind(this),function(){d.hide()}.bind(this))}.bind(this),100)}.bind(this)},{text:ORYX.I18N.ERDFSupport.close,handler:function(){b.hide()}.bind(this)}]});b.on("hide",function(){b.destroy(true);delete b});b.show();c.items.items[1].getEl().dom.addEventListener("change",function(d){var e=d.target.files[0].getAsText("UTF-8");c.items.items[2].setValue(e)},true)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.JSONSupport=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:ORYX.I18N.JSONSupport.exp.name,functionality:this.exportJSON.bind(this),group:ORYX.I18N.JSONSupport.exp.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/page_white_javascript.png",description:ORYX.I18N.JSONSupport.exp.desc,index:0,minShape:0,maxShape:0});if(!(ORYX.CONFIG.IS_TEMPLATE)){this.facade.offer({name:ORYX.I18N.JSONSupport.imp.name,functionality:this.showImportDialog.bind(this),group:ORYX.I18N.JSONSupport.imp.group,dropDownGroupIcon:ORYX.PATH+"images/import.png",icon:ORYX.PATH+"images/page_white_javascript.png",description:ORYX.I18N.JSONSupport.imp.desc,index:1,minShape:0,maxShape:0})}},exportJSON:function(){var a=this.facade.getSerializedJSON();this.openDownloadWindow(window.document.title+".json",a)},showImportDialog:function(a){var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.JSONSupport.imp.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.JSONSupport.imp.file,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var b=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.JSONSupport.imp.name,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[c],buttons:[{text:ORYX.I18N.JSONSupport.imp.btnImp,handler:function(){var d=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.JSONSupport.imp.progress});d.show();window.setTimeout(function(){var f=c.items.items[2].getValue();try{this.facade.importJSON(f,true);b.close()}catch(e){Ext.Msg.alert(ORYX.I18N.JSONSupport.imp.syntaxError,e.message)}finally{d.hide()}}.bind(this),100)}.bind(this)},{text:ORYX.I18N.JSONSupport.imp.btnClose,handler:function(){b.close()}.bind(this)}]});b.show();c.items.items[1].getEl().dom.addEventListener("change",function(d){var e=d.target.files[0].getAsText("UTF-8");c.items.items[2].setValue(e)},true)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.RDFExport=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:ORYX.I18N.RDFExport.rdfExport,functionality:this.exportRDF.bind(this),group:ORYX.I18N.RDFExport.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/page_white_code.png",description:ORYX.I18N.RDFExport.rdfExportDescription,index:0,minShape:0,maxShape:0})},exportRDF:function(){this.openDownloadWindow(window.document.title+".rdf",this.getRDFFromDOM())}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Undo=Clazz.extend({facade:undefined,undoStack:[],redoStack:[],construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.Undo.undo,description:ORYX.I18N.Undo.undoDesc,icon:ORYX.PATH+"images/arrow_undo.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:90,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.doUndo.bind(this),group:ORYX.I18N.Undo.group,isEnabled:function(){return this.undoStack.length>0}.bind(this),index:0});this.facade.offer({name:ORYX.I18N.Undo.redo,description:ORYX.I18N.Undo.redoDesc,icon:ORYX.PATH+"images/arrow_redo.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:89,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.doRedo.bind(this),group:ORYX.I18N.Undo.group,isEnabled:function(){return this.redoStack.length>0}.bind(this),index:1});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_EXECUTE_COMMANDS,this.handleExecuteCommands.bind(this))},handleExecuteCommands:function(a){if(!a.commands){return}this.undoStack.push(a.commands);this.redoStack=[]},doUndo:function(){var a=this.undoStack.pop();if(a){this.redoStack.push(a);a.each(function(b){b.rollback()})}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_UNDO_ROLLBACK,commands:a})},doRedo:function(){var a=this.redoStack.pop();if(a){this.undoStack.push(a);a.each(function(b){b.execute()})}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_UNDO_EXECUTE,commands:a})}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.EPCSupport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.EPCSupport.exp,functionality:this.exportEPC.bind(this),group:ORYX.I18N.EPCSupport.group,icon:ORYX.PATH+"images/epml_export_icon.png",description:ORYX.I18N.EPCSupport.expDesc,index:1,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.EPCSupport.imp,functionality:this.importEPC.bind(this),group:ORYX.I18N.EPCSupport.group,icon:ORYX.PATH+"images/epml_import_icon.png",description:ORYX.I18N.EPCSupport.impDesc,index:2,minShape:0,maxShape:0})},importEPC:function(){this.openUploadDialog()},exportEPC:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.EPCSupport.progressExp});var b=new XMLSerializer();var g="Oryx-EPC";var d=DataManager.serializeDOM(this.facade);d='<?xml version="1.0" encoding="utf-8"?><html xmlns="http://www.w3.org/1999/xhtml" xmlns:b3mn="http://b3mn.org/2007/b3mn" xmlns:ext="http://b3mn.org/2007/ext" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:atom="http://b3mn.org/2007/atom+xhtml"><head profile="http://purl.org/NET/erdf/profile"><link rel="schema.dc" href="http://purl.org/dc/elements/1.1/" /><link rel="schema.dcTerms" href="http://purl.org/dc/terms/ " /><link rel="schema.b3mn" href="http://b3mn.org" /><link rel="schema.oryx" href="http://oryx-editor.org/" /><link rel="schema.raziel" href="http://raziel.org/" /><base href="'+location.href.split("?")[0]+'" /></head><body>'+d+'<div id="generatedProcessInfos"><span class="oryx-id">'+g+'</span><span class="oryx-name">'+g+"</span></div></body></html>";var h=ORYX.PATH+"/lib/extract-rdf.xsl";var f;rdfResult=this.transformString(d,h,true);if(rdfResult instanceof String){f=rdfResult;rdfResult=null}else{f=b.serializeToString(rdfResult);if(!f.startsWith("<?xml")){f='<?xml version="1.0" encoding="UTF-8"?>'+f}}var c=ORYX.PATH+"/xslt/RDF2EPML.xslt";var e=this.transformDOM(rdfResult,c,true);var a;if(e instanceof String){a=e;e=null}else{a=b.serializeToString(e);if(!a.startsWith("<?xml")){a='<?xml version="1.0" encoding="UTF-8"?>'+a}}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});this.openDownloadWindow(g+".epml",a)},transformString:function(d,b,c){var e=new DOMParser();var a=e.parseFromString(d,"text/xml");return this.transformDOM(a,b,c)},transformDOM:function(k,a,d){if(k==null){return new String("Parse Error: \nThe given dom content is null.")}var b="";source=a;new Ajax.Request(source,{asynchronous:false,method:"get",onSuccess:function(m){b=m.responseText}.bind(this),onFailure:(function(m){ORYX.Log.error("XSL load failed"+m)}).bind(this)});var l;var g;var e=new XSLTProcessor();var h=new DOMParser();var c=h.parseFromString(b,"text/xml");e.importStylesheet(c);try{l=e.transformToFragment(k,document)}catch(f){return new String("Parse Error: "+f.name+"\n"+f.message)}if(d){return l}g=(new XMLSerializer()).serializeToString(l);return g},openUploadDialog:function(){var b=new Ext.form.FormPanel({frame:true,bodyStyle:"padding:5px;",defaultType:"textfield",labelAlign:"left",buttonAlign:"right",fileUpload:true,enctype:"multipart/form-data",items:[{text:ORYX.I18N.EPCSupport.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",xtype:"label"},{fieldLabel:ORYX.I18N.EPCSupport.file,inputType:"file",labelStyle:"width:50px;",itemCls:"ext_specific_window_overflow"}]});var a=new Ext.Window({autoCreate:true,title:ORYX.I18N.EPCSupport.impPanel,height:"auto",width:"auto",modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,resizable:false,items:[b],buttons:[{text:ORYX.I18N.EPCSupport.impBtn,handler:function(){var c=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.EPCSupport.progressImp});c.show();b.form.submit({url:ORYX.PATH+"/epc-upload",success:function(e,d){a.hide();var g=d.result;g=g.startsWith("<?xml")?g:'<?xml version="1.0" encoding="utf-8"?><div>'+g+"</div>";this.loadContent(g);c.hide()}.bind(this),failure:function(e,d){a.hide();c.hide();Ext.MessageBox.show({title:ORYX.I18N.EPCSupport.error,msg:d.response.responseText.substring(d.response.responseText.indexOf("content:'")+9,d.response.responseText.indexOf("'}")),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}})}.bind(this)},{text:ORYX.I18N.EPCSupport.close,handler:function(){a.hide()}.bind(this)}]});a.on("hide",function(){a.destroy(true);delete a});a.show()},createHiddenElement:function(a,b){var c=document.createElement("input");c.name=a;c.type="hidden";c.value=b;return c},getFileName:function(b){var a=b.length;if(a>5){if(b.substr(a-5,5)=="(AML)"){return b.substr(0,a-6)}}return b},openDownloadWindow:function(b,c){var d=window.open("");if(d!=null){d.document.open();d.document.write("<html><body>");var a=d.document.createElement("form");d.document.body.appendChild(a);var b=this.getFileName(b);a.appendChild(this.createHiddenElement("download",c));a.appendChild(this.createHiddenElement("file",b));a.method="POST";d.document.write("</body></html>");d.document.close();a.action=ORYX.PATH+"/download";a.submit()}},loadContent:function(a){var c=new DOMParser();var b=c.parseFromString(a,"text/xml");this.facade.importERDF(b)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.JPDLSupport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,stencilSetExtensionNamespace:"http://oryx-editor.org/stencilsets/extensions/jbpm#",stencilSetExtensionDefinition:"jbpm/jbpm.json",stencilSetNamespace:"http://b3mn.org/stencilset/bpmn1.1#",stencilSetUrlSuffix:"/bpmn1.1/bpmn1.1.json",construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.jPDLSupport.exp,functionality:this.exportJPDL.bind(this),group:ORYX.I18N.jPDLSupport.group,icon:ORYX.PATH+"images/jpdl_export_icon.png",description:ORYX.I18N.jPDLSupport.expDesc,dropDownGroupIcon:ORYX.PATH+"images/export2.png",index:1,minShape:0,maxShape:0,maxShape:0,isEnabled:this._isJpdlStencilSetExtensionLoaded.bind(this)});this.facade.offer({name:ORYX.I18N.jPDLSupport.imp,functionality:this.importJPDL.bind(this),group:ORYX.I18N.jPDLSupport.group,dropDownGroupIcon:ORYX.PATH+"images/import.png",icon:ORYX.PATH+"images/jpdl_import_icon.png",description:ORYX.I18N.jPDLSupport.impDesc,index:2,minShape:0,maxShape:0})},_isJpdlStencilSetExtensionLoaded:function(){return this.isStencilSetExtensionLoaded(this.stencilSetExtensionNamespace)},importJPDL:function(){this._showImportDialog()},exportJPDL:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE});window.setTimeout((function(){this._doExport();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}).bind(this),10);return true},_sendRequest:function(b,f,d,e,a){var c=false;new Ajax.Request(b,{method:f,asynchronous:false,parameters:d,onSuccess:function(g){c=true;if(e){e(g.responseText)}}.bind(this),onFailure:function(g){if(a){a()}else{this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.jPDLSupport.impFailedReq);ORYX.log.warn("Import jPDL failed: "+g.responseText)}}.bind(this)});return c},_loadJSON:function(a){if(a){var b=a.evalJSON();if(b&&this._hasStencilset(b)){if(this._isJpdlStencilSetExtensionLoaded()){this.facade.importJSON(a)}else{Ext.MessageBox.confirm(ORYX.I18N.jPDLSupport.loadSseQuestionTitle,ORYX.I18N.jPDLSupport.loadSseQuestionBody,function(c){if(c=="yes"){if(this.loadStencilSetExtension(this.stencilSetNamespace,this.stencilSetExtensionDefinition)){this.facade.importJSON(a)}else{this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.jPDLSupport.impFailedJson)}}else{this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.jPDLSupport.impFailedJsonAbort)}},this)}}else{this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.jPDLSupport.impFailedJson)}}else{this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.jPDLSupport.impFailedJson)}},loadStencilSetExtension:function(c,b){var a=this.facade.getStencilSets()[c];if(a){a.addExtension(ORYX.CONFIG.SS_EXTENSIONS_FOLDER+b);this.facade.getRules().initializeRules(a);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED});return true}return false},_hasStencilset:function(a){return a.properties.ssextension==this.stencilSetExtensionNamespace&&a.stencilset.url.endsWith(this.stencilSetUrlSuffix)},_doExport:function(){var a=this.facade.getSerializedJSON();this._sendRequest(ORYX.CONFIG.JPDLEXPORTURL,"POST",{data:a},function(b){var d=new DOMParser();var c=d.parseFromString(b,"text/xml");if(c.firstChild.localName=="error"){this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.jPDLSupport.expFailedXml+c.firstChild.firstChild.data)}else{this.openXMLWindow(b)}}.bind(this),function(){this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.jPDLSupport.expFailedReq)}.bind(this))},_showImportDialog:function(a){var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.jPDLSupport.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.jPDLSupport.file,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var b=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.jPDLSupport.impJPDL,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[c],buttons:[{text:ORYX.I18N.jPDLSupport.impBtn,handler:function(){var d=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.jPDLSupport.impProgress});d.show();window.setTimeout(function(){var e=c.items.items[2].getValue();this._sendRequest(ORYX.CONFIG.JPDLIMPORTURL,"POST",{data:e},function(f){this._loadJSON(f);d.hide();b.hide()}.bind(this),function(){d.hide();b.hide()}.bind(this))}.bind(this),100)}.bind(this)},{text:ORYX.I18N.jPDLSupport.close,handler:function(){b.hide()}.bind(this)}]});b.on("hide",function(){b.destroy(true);delete b});b.show();c.items.items[1].getEl().dom.addEventListener("change",function(d){var e=d.target.files[0].getAsText("UTF-8");c.items.items[2].setValue(e)},true)},_showErrorMessageBox:function(b,a){Ext.MessageBox.show({title:b,msg:a,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPMN2XForms=ORYX.Plugins.AbstractPlugin.extend({stencilSetExtensionSuffix:"/bpmn-xforms-user-interfaces#",construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:"Aggregate User Interface",functionality:this.aggregateUI.bind(this),group:"User Interface Generation",dropDownGroupIcon:ORYX.PATH+"images/bpmn2xforms.png",icon:ORYX.PATH+"images/page_world.png",description:"Aggregates an XForm out of BPMN (requires 'BPMN Extension for XForms User Interfaces')",index:1,minShape:0,maxShape:0});this.facade.offer({name:"Save Aggregated User Interface",functionality:this.saveAggregatedUI.bind(this),group:"User Interface Generation",dropDownGroupIcon:ORYX.PATH+"images/bpmn2xforms.png",icon:ORYX.PATH+"images/page_save.png",description:"Aggregates an XForm out of BPMN and stores it on the server (requires 'BPMN Extension for XForms User Interfaces')",index:3,minShape:0,maxShape:0});this.facade.offer({name:"Browse Saved User Interfaces",functionality:this.browseAggregatedUIs.bind(this),group:"User Interface Generation",dropDownGroupIcon:ORYX.PATH+"images/bpmn2xforms.png",icon:ORYX.PATH+"images/folder_page.png",description:"Opens a list of Aggregated User Interfaces that are stored on the server.",index:4,minShape:0,maxShape:0})},aggregateUI:function(){this.invokeBPMN2XFormsServlet(ORYX.CONFIG.ROOT_PATH+"bpmn2xforms",this.openXMLWindow.bind(this))},aggregateUIAndRenderInOrbeon:function(){this.invokeBPMN2XFormsServlet(ORYX.CONFIG.ROOT_PATH+"bpmn2xforms-orbeon",this.openOrbeonWindow.bind(this))},saveAggregatedUI:function(){this.invokeBPMN2XFormsServlet(ORYX.CONFIG.ROOT_PATH+"bpmn2xforms?save=true",window.open.bind(window))},browseAggregatedUIs:function(){window.open(ORYX.PATH+"/generated-uis/","_blank","resizable=yes,width=640,height=480,toolbar=0,scrollbars=yes")},openOrbeonWindow:function(a){var b=window.open("data:application/xml,"+encodeURIComponent(a),"_blank","resizable=yes,width=600,height=600,toolbar=0,scrollbars=yes")},invokeBPMN2XFormsServlet:function(b,d){var a=new Ext.LoadMask(Ext.getBody(),{msg:"Aggregating User Interface..."});a.show();var c=this.getRDFFromDOM();this._sendRequest(b,"POST",{data:c},function(e){d(e);a.hide()}.bind(this),function(){a.hide();this._showErrorMessageBox("Oryx","User Interface Aggregation failed.");ORYX.log.warn("User Interface Aggregation failed: "+transport.responseText)}.bind(this))},_sendRequest:function(b,f,d,e,a){var c=false;new Ajax.Request(b,{method:f,asynchronous:false,parameters:d,onSuccess:function(g){c=true;if(e){e(g.responseText)}}.bind(this),onFailure:function(g){if(a){a()}else{Ext.Msg.alert("Oryx","User Interface Aggregation failed.");ORYX.log.warn("User Interface Aggregation failed: "+g.responseText)}}.bind(this)});return c},_showErrorMessageBox:function(b,a){Ext.MessageBox.show({title:b,msg:a,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})},transform:function(){var b=ORYX.PATH+"xslt/BPMN2XHTML.xslt";var a=this.doTransform(this.getRDFFromDOM(),b);var c=window.open("data:application/xhtml+xml,"+a,"_blank","resizable=yes,width=640,height=480,toolbar=0,scrollbars=yes")},isStencilSetExtensionLoaded:function(){return this.facade.getStencilSets().values().any(function(a){return a.extensions().keys().any(function(b){return b.endsWith(this.stencilSetExtensionSuffix)}.bind(this))}.bind(this))}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPMN2BPEL=ORYX.Plugins.AbstractPlugin.extend({bpmn2BpelHandlerUrl:ORYX.PATH+"/bpmn2bpel",stencilSetExtensionSuffix:"/bpmnservicecompositionsubset-goldeneye#",construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.Bpmn2Bpel.show,functionality:this.showBpel.bind(this),group:ORYX.I18N.Bpmn2Bpel.group,dropDownGroupIcon:ORYX.PATH+"images/bpmn2bpel_icon.png",description:ORYX.I18N.Bpmn2Bpel.showDesc,index:0,minShape:0,maxShape:0,isEnabled:this.isStencilSetExtensionLoaded.bind(this)});this.facade.offer({name:ORYX.I18N.Bpmn2Bpel.download,functionality:this.downloadBpel.bind(this),group:ORYX.I18N.Bpmn2Bpel.group,dropDownGroupIcon:ORYX.PATH+"images/bpmn2bpel_icon.png",description:ORYX.I18N.Bpmn2Bpel.downloadDesc,index:0,minShape:0,maxShape:0,isEnabled:this.isStencilSetExtensionLoaded.bind(this)});this.facade.offer({name:ORYX.I18N.Bpmn2Bpel.deploy,functionality:this.deployBpel.bind(this),group:ORYX.I18N.Bpmn2Bpel.group,dropDownGroupIcon:ORYX.PATH+"images/bpmn2bpel_icon.png",description:ORYX.I18N.Bpmn2Bpel.deployDesc,index:0,minShape:0,maxShape:0,isEnabled:this.isStencilSetExtensionLoaded.bind(this)})},isStencilSetExtensionLoaded:function(){return this.facade.getStencilSets().values().any(function(a){return a.extensions().keys().any(function(b){return b.endsWith(this.stencilSetExtensionSuffix)}.bind(this))}.bind(this))},showBpel:function(){var a=JSON.stringify({action:"transform"});this.generateBpel(function(b){this.openXMLWindow(b.process)}.bind(this),a)},downloadBpel:function(){var a=JSON.stringify({action:"transform"});this.generateBpel(function(b){this.openDownloadWindow("Oryx-BPEL",b.process)}.bind(this),a)},deployBpel:function(){this._showInputBox(function(b){var a={apacheOdeUrl:b,action:"deploy"};a=JSON.stringify(a);this.generateBpel(this._showProcessUrl.bind(this),a)}.bind(this))},generateBpel:function(bpelHandleFunction,options){var loadMask=new Ext.LoadMask(Ext.getBody(),{msg:"Transforming BPMN to BPEL"});loadMask.show();var erdfString=this.getRDFFromDOM();this._sendRequest(this.bpmn2BpelHandlerUrl,"POST",{data:erdfString,options:options},function(arg){eval("var process = "+arg);bpelHandleFunction(process);loadMask.hide()}.bind(this),function(){loadMask.hide();this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.Bpmn2Bpel.transfFailed);ORYX.log.warn("Transformation to BPEL failed: "+transport.responseText)}.bind(this))},_sendRequest:function(b,f,d,e,a){var c=false;new Ajax.Request(b,{method:f,asynchronous:false,parameters:d,onSuccess:function(g){c=true;if(e){e(g.responseText)}}.bind(this),onFailure:function(g){if(a){a()}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Bpmn2Bpel.transfFailed);ORYX.log.warn("Transformation to BPEL failed: "+g.responseText)}}.bind(this)});return c},_showErrorMessageBox:function(b,a){Ext.MessageBox.show({title:b,msg:a,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})},_showProcessUrl:function(a){Ext.MessageBox.show({title:"BPEL-Process-URL",msg:a.serviceName,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO})},_showInputBox:function(a){var d=new Ext.form.TextField({value:"http://localhost:8080/ode",fieldLabel:"URL",width:200});var b=new Ext.FormPanel({items:[{xtype:"label",text:ORYX.I18N.Bpmn2Bpel.ApacheOdeUrlInputPanelText,style:"margin:10px;display:block"},d],frame:true,buttons:[{text:ORYX.I18N.Bpmn2Bpel.ApacheOdeUrlInputLabelDeploy,handler:function(){var e=d.getValue();Ext.getCmp("oryx_ode_url_input_panel_window").close();a(e)}.bind(this)},{text:ORYX.I18N.Bpmn2Bpel.ApacheOdeUrlInputLabelCancel,handler:function(){Ext.getCmp("oryx_ode_url_input_panel_window").close()}.bind(this)}]});var c=new Ext.Window({id:"oryx_ode_url_input_panel_window",width:350,title:ORYX.I18N.Bpmn2Bpel.ApacheOdeUrlInputTitle,floating:true,shim:true,modal:true,resizable:false,autoHeight:true,items:[b]});c.show()}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ProcessLink=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.propertyChanged.bind(this))},propertyChanged:function(a,b){if(a.name!=="oryx-refuri"||!b instanceof ORYX.Core.Node){return}if(a.value&&a.value.length>0&&a.value!="undefined"){this.show(b,a.value)}else{this.hide(b)}},show:function(a,b){var c=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["a",{target:"_blank"},["path",{"stroke-width":1,stroke:"#00DD00",fill:"#00AA00",d:"M3,3 l0,-2.5 l7.5,0 l0,-2.5 l7.5,4.5 l-7.5,3.5 l0,-2.5 l-8,0","line-captions":"round"}]]);var c=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["a",{target:"_blank"},["path",{style:"fill:#92BFFC;stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72",d:"M0 1.44 L0 15.05 L11.91 15.05 L11.91 5.98 L7.37 1.44 L0 1.44 Z"}],["path",{style:"stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72;fill:none;",transform:"translate(7.5, -8.5)",d:"M0 10.51 L0 15.05 L4.54 15.05"}],["path",{style:"fill:#f28226;stroke:#000000;stroke-linecap:round;stroke-linejoin:round;stroke-width:0.72",transform:"translate(-3, -1)",d:"M0 8.81 L0 13.06 L5.95 13.06 L5.95 15.05 A50.2313 50.2313 -175.57 0 0 10.77 11.08 A49.9128 49.9128 -1.28 0 0 5.95 6.54 L5.95 8.81 L0 8.81 Z"}],]);c.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",b);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"arissupport.urlref_"+a.id,shapes:[a],node:c,nodePosition:"SE"})},hide:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"arissupport.urlref_"+a.id})}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.AdHocCC=Clazz.extend({facade:undefined,UNSAVED_RESOURCE:"unsaved",construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.AdHocCC.compl,functionality:this.editCC.bind(this),group:ORYX.I18N.AdHocCC.group,icon:ORYX.PATH+"images/adhoc.gif",description:ORYX.I18N.AdHocCC.complDesc,index:0,minShape:1,maxShape:1})},editCC:function(){var f=this.facade.getSelection();if(f.length!=1){this.openErroDialog(ORYX.I18N.AdHocCC.notOne);return}var h=f[0];if(h._stencil.id()!="http://b3mn.org/stencilset/bpmnexec#Subprocess"||!h.properties["oryx-isadhoc"]){this.openErroDialog(ORYX.I18N.AdHocCC.nodAdHocCC);return}var G=h.properties["oryx-adhoccompletioncondition"];var L=["resourceID","resourceName"];var q=[];var K=["state"];var k=[["ready"],["skipped"],["completed"]];var t=["resourceID_FieldName","dataNameAndFieldName"];var p=[];var w=new DOMParser();var s=h.getChildNodes();for(var J=0;J<s.length;J++){var g=s[J];if(g._stencil.id()=="http://b3mn.org/stencilset/bpmnexec#Task"){var C=g.properties["oryx-name"];var v=g.resourceId;if(typeof v=="undefined"){DataManager.__persistDOM(this.facade);v=g.resourceId;if(typeof v=="undefined"){v=this.UNSAVED_RESOURCE;C=C+" (unsaved)"}}q.push([v,C])}else{if(g._stencil.id()=="http://b3mn.org/stencilset/bpmnexec#DataObject"){var C=g.properties["oryx-name"];var v=g.resourceId;if(typeof v=="undefined"){DataManager.__persistDOM(this.facade);v=g.resourceId;if(typeof v=="undefined"){v=this.UNSAVED_RESOURCE;C=C+" (unsaved)"}}var z=g.properties["oryx-datamodel"];var o=w.parseFromString(z,"text/xml");var H=o.childNodes[0];if(H!=null){var e=H.childNodes;for(var I=0;I<e.length;I++){var y=e[I].attributes.name.nodeValue;if(y!=null){p.push([[v,y],C+"/"+y])}}}}}}var n=new Ext.data.SimpleStore({fields:L,data:q});var d=new Ext.data.SimpleStore({fields:K,data:k});var m=new Ext.data.SimpleStore({fields:t,data:p});var N=new Ext.form.ComboBox({store:n,valueField:L[0],displayField:L[1],emptyText:ORYX.I18N.AdHocCC.selectTask,typeAhead:true,mode:"local",triggerAction:"all",selectOnFocus:true,editable:false,width:180});var D=new Ext.form.ComboBox({store:d,displayField:K[0],emptyText:ORYX.I18N.AdHocCC.selectState,typeAhead:true,mode:"local",triggerAction:"all",selectOnFocus:true,editable:false,width:180});var A=new Ext.Button({text:ORYX.I18N.AdHocCC.addExp,handler:function(){var O=N.getValue();var P=D.getValue();if(O!=this.UNSAVED_RESOURCE&&O!=""&&P!=""){this.addStringToTextArea(a,"stateExpression('"+O+"', '"+P+"')");N.setValue("");D.setValue("")}}.bind(this)});var M=new Ext.form.ComboBox({store:m,valueField:t[0],displayField:t[1],emptyText:ORYX.I18N.AdHocCC.selectDataField,typeAhead:true,mode:"local",triggerAction:"all",selectOnFocus:true,editable:false,width:180});var x=new Ext.form.TextField({width:180,emptyText:ORYX.I18N.AdHocCC.enterEqual,});var u=new Ext.Button({text:ORYX.I18N.AdHocCC.addExp,handler:function(){var P=M.getValue();var O=x.getValue();if(P!=null&&P[0]!=this.UNSAVED_RESOURCE&&O!=""){this.addStringToTextArea(a,"dataExpression('"+P[0]+"', '"+P[1]+"', '"+O+"')");M.setValue("");x.setValue("")}}.bind(this)});var c=new Ext.Button({text:ORYX.I18N.AdHocCC.and,minWidth:50,handler:function(){this.addStringToTextArea(a,"&")}.bind(this)});var b=new Ext.Button({text:ORYX.I18N.AdHocCC.or,minWidth:50,handler:function(){this.addStringToTextArea(a,"|")}.bind(this)});var B=new Ext.Button({text:"(",minWidth:50,handler:function(){this.addStringToTextArea(a,"(")}.bind(this)});var l=new Ext.Button({text:")",minWidth:50,handler:function(){this.addStringToTextArea(a,")")}.bind(this)});var E=new Ext.Button({text:ORYX.I18N.AdHocCC.not,minWidth:50,handler:function(){this.addStringToTextArea(a,"!")}.bind(this)});var a=new Ext.form.TextArea({width:418,height:100,value:G});var r=new Ext.Button({text:ORYX.I18N.AdHocCC.clearCC,handler:function(){a.setValue("")}});var F=new Ext.Window({width:450,height:485,resizable:false,minimizable:false,modal:true,autoScroll:true,title:ORYX.I18N.AdHocCC.editCC,layout:"table",defaults:{bodyStyle:"padding:3px;background-color:transparent;border-width:0px"},layoutConfig:{columns:7},items:[{items:[new Ext.form.Label({text:ORYX.I18N.AdHocCC.addExecState,style:"font-size:12px;"})],colspan:7},{},{items:[N],colspan:6},{},{items:[D],colspan:4},{items:[A]},{},{colspan:7},{items:[new Ext.form.Label({text:ORYX.I18N.AdHocCC.addDataExp,style:"font-size:12px;"})],colspan:7},{},{items:[M],colspan:6},{},{items:[x],colspan:4},{items:[u]},{},{colspan:7},{items:[new Ext.form.Label({text:ORYX.I18N.AdHocCC.addLogOp,style:"font-size:12px;"})],colspan:7},{},{items:[c]},{items:[b]},{items:[B]},{items:[l]},{items:[E]},{},{colspan:7},{items:[new Ext.form.Label({text:ORYX.I18N.AdHocCC.curCond,style:"font-size:12px;"})],colspan:7},{},{items:[a],colspan:5},{},{colspan:5},{items:[r]},{}],buttons:[{text:"Apply",handler:function(){F.hide();h.properties["oryx-adhoccompletioncondition"]=a.getValue();this.facade.setSelection([]);this.facade.setSelection(f)}.bind(this)},{text:"Cancel",handler:function(){F.hide()}}],keys:[{key:27,fn:function(){F.hide()}}]});F.show()},addStringToTextArea:function(e,a){var c=e.getEl().dom.selectionStart;var d=e.getEl().dom.selectionEnd;var b=e.getValue();e.setValue(b.substring(0,c)+a+b.substring(d));e.getEl().dom.selectionStart=c+a.length;e.getEl().dom.selectionEnd=e.getEl().dom.selectionStart},openErroDialog:function(a){Ext.MessageBox.show({title:"Error",msg:a,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.CPNToolsSupport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,stencilSetNamespace:"http://b3mn.org/stencilset/coloredpetrinet#",construct:function(a){this.facade=a;this.facade.offer({name:"Export to CPN Tools",functionality:this.exportCPN.bind(this),group:ORYX.I18N.cpntoolsSupport.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/cpn/cpn_export.png",description:ORYX.I18N.cpntoolsSupport.exportDescription,index:0,minShape:0,maxShape:0,maxShape:0});this.facade.offer({name:"Import from CPN Tools",functionality:this.importCPN.bind(this),group:ORYX.I18N.cpntoolsSupport.group,dropDownGroupIcon:ORYX.PATH+"images/import.png",icon:ORYX.PATH+"images/cpn/cpn_import.png",description:ORYX.I18N.cpntoolsSupport.importDescription,index:1,minShape:0,maxShape:0});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_RESIZE_END,this.resetTokenPosition.bind(this))},importCPN:function(){this._showImportDialog()},exportCPN:function(){var a=this.facade.getSerializedJSON();this._doExportToCPNTools(a)},resetTokenPosition:function(){var a=this.facade.getSelection().findAll(function(b){return(b.getStencil().id()==="http://b3mn.org/stencilset/coloredpetrinet#Place")});if(a.length>0){a.each(function(g){var e=g.absoluteBounds();var f=e.center();var b=f.y-e.upperLeft().y;var d=f.x-e.upperLeft().x;var k=Math.min(b,d);var l=k/2;var o=g.getChildNodes(false).findAll(function(c){return(c.getStencil().id()==="http://b3mn.org/stencilset/coloredpetrinet#Token")});if(o.length>0){var h=0;var n=0;var m=0;o.each(function(r){var t=r.absoluteBounds();var q=t.center();var p=f.x-q.x;var c=f.y-q.y;var s=p*p+c*c;if(k*k<=s){m=Math.round(Math.sin((Math.PI/6)*h)*l);n=Math.round(Math.cos((Math.PI/6)*h)*l);r.bounds.centerMoveTo(g.bounds.width()/2+n,g.bounds.height()/2+m);r.update();h=h+1}})}})}this.facade.getCanvas().update()},_sendRequest:function(b,f,d,e,a){var c=false;new Ajax.Request(b,{method:f,asynchronous:false,parameters:d,onSuccess:function(g){c=true;if(e){e(g.responseText)}}.bind(this),onFailure:function(g){if(a){a()}else{this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.cpntoolsSupport.serverConnectionFailed);ORYX.log.warn("Communication failed: "+g.responseText)}}.bind(this)});return c},_doExportToCPNTools:function(a){this._sendRequest(ORYX.CONFIG.CPNTOOLSEXPORTER,"POST",{data:a},function(b){if(b.startsWith("error:")){this._showErrorMessageBox(ORYX.I18N.Oryx.title,b)}else{this.openDownloadWindow(window.document.title+".cpn",b)}}.bind(this),function(){this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.cpntoolsSupport.serverConnectionFailed)}.bind(this))},_showImportDialog:function(a){var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.cpntoolsSupport.importTask,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.cpntoolsSupport.File,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var b=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.cpntoolsSupport.cpn,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[c],buttons:[{text:ORYX.I18N.cpntoolsSupport.importLable,handler:function(){var d=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.jPDLSupport.impProgress});d.show();window.setTimeout(function(){var e=c.items.items[2].getValue();this._getAllPages(e,d)}.bind(this),100);b.hide()}.bind(this)},{text:ORYX.I18N.cpntoolsSupport.close,handler:function(){b.hide()}.bind(this)}]});b.on("hide",function(){b.destroy(true);delete b});b.show();c.items.items[1].getEl().dom.addEventListener("change",function(d){var e=d.target.files[0].getAsText("UTF-8");c.items.items[2].setValue(e)},true)},_getAllPages:function(c,e){var h=new DOMParser();var g=h.parseFromString(c,"text/xml");var b=g.getElementsByTagName("page");if(b.length==0){e.hide();this._showErrorMessageBox(ORYX.I18N.cpntoolsSupport.title,ORYX.I18N.cpntoolsSupport.wrongCPNFile);return}if(b.length==1){pageAttr=b[0].children[0];a=pageAttr.attributes[0].nodeValue;this._sendRequest(ORYX.CONFIG.CPNTOOLSIMPORTER,"POST",{pagesToImport:a,data:c},function(k){if(k.startsWith("error:")){this._showErrorMessageBox(ORYX.I18N.Oryx.title,k);e.hide()}else{this.facade.importJSON(k);e.hide()}}.bind(this),function(){e.hide();this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.cpntoolsSupport.serverConnectionFailed)}.bind(this));return}var d,a,f=[];for(d=0;d<b.length;d++){pageAttr=b[d].children[0];a=pageAttr.attributes[0].nodeValue;f.push([a])}e.hide();this.showPageDialog(f,c)},_showErrorMessageBox:function(b,a){Ext.MessageBox.show({title:b,msg:a,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})},showPageDialog:function(f,c){var a=new Ext.data.ArrayReader({},[{name:"name"}]);var g=new Ext.grid.CheckboxSelectionModel({singleSelect:true});var d=new Ext.grid.GridPanel({store:new Ext.data.Store({reader:a,data:f}),cm:new Ext.grid.ColumnModel([{id:"name",width:200,sortable:true,dataIndex:"name"},g]),sm:g,frame:true,hideHeaders:true,iconCls:"icon-grid",listeners:{render:function(){var h=[];this.grid.getStore().each(function(k){if(k.data.engaged){h.push(k)}}.bind(this));this.suspendEvents();this.selectRecords(h);this.resumeEvents()}.bind(g)}});var b=new Ext.Panel({items:[{xtype:"label",text:"CPNTools Page",style:"margin:10px;display:block"},d],frame:true});var e=new Ext.Window({id:"oryx_new_page_selection",autoWidth:true,title:ORYX.I18N.cpntoolsSupport.title,floating:true,shim:true,modal:true,resizable:true,autoHeight:true,items:[b],buttons:[{text:ORYX.I18N.cpntoolsSupport.importLable,handler:function(){var h="";g.getSelections().each(function(m){h=m.data.name}.bind(this));var l=h.length;if(h.length==0){alert(ORYX.I18N.cpntoolsSupport.noPageSelection);return}var k=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.cpntoolsSupport.importProgress});k.show();e.hide();pageName=h;this._sendRequest(ORYX.CONFIG.CPNTOOLSIMPORTER,"POST",{pagesToImport:pageName,data:c},function(m){if(m.startsWith("error:")){this._showErrorMessageBox(ORYX.I18N.Oryx.title,m);k.hide()}else{this.facade.importJSON(m);k.hide()}}.bind(this),function(){k.hide();this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.cpntoolsSupport.serverConnectionFailed)}.bind(this))}.bind(this)},{text:ORYX.I18N.cpntoolsSupport.close,handler:function(){e.hide()}.bind(this)}]});e.show()}});Array.prototype.insertFrom=function(e,d){d=Math.max(0,d);e=Math.min(Math.max(0,e),this.length-1);var b=this[e];var a=this.without(b);var c=a.slice(0,d);c.push(b);if(a.length>d){c=c.concat(a.slice(d))}return c};if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Arrangement=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.Arrangement.btf,functionality:this.setZLevel.bind(this,this.setToTop),group:ORYX.I18N.Arrangement.groupZ,icon:ORYX.PATH+"images/shape_move_front.png",description:ORYX.I18N.Arrangement.btfDesc,index:1,minShape:1});this.facade.offer({name:ORYX.I18N.Arrangement.btb,functionality:this.setZLevel.bind(this,this.setToBack),group:ORYX.I18N.Arrangement.groupZ,icon:ORYX.PATH+"images/shape_move_back.png",description:ORYX.I18N.Arrangement.btbDesc,index:2,minShape:1});this.facade.offer({name:ORYX.I18N.Arrangement.bf,functionality:this.setZLevel.bind(this,this.setForward),group:ORYX.I18N.Arrangement.groupZ,icon:ORYX.PATH+"images/shape_move_forwards.png",description:ORYX.I18N.Arrangement.bfDesc,index:3,minShape:1});this.facade.offer({name:ORYX.I18N.Arrangement.bb,functionality:this.setZLevel.bind(this,this.setBackward),group:ORYX.I18N.Arrangement.groupZ,icon:ORYX.PATH+"images/shape_move_backwards.png",description:ORYX.I18N.Arrangement.bbDesc,index:4,minShape:1});this.facade.offer({name:ORYX.I18N.Arrangement.ab,functionality:this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_BOTTOM]),group:ORYX.I18N.Arrangement.groupA,icon:ORYX.PATH+"images/shape_align_bottom.png",description:ORYX.I18N.Arrangement.abDesc,index:1,minShape:2});this.facade.offer({name:ORYX.I18N.Arrangement.am,functionality:this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_MIDDLE]),group:ORYX.I18N.Arrangement.groupA,icon:ORYX.PATH+"images/shape_align_middle.png",description:ORYX.I18N.Arrangement.amDesc,index:2,minShape:2});this.facade.offer({name:ORYX.I18N.Arrangement.at,functionality:this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_TOP]),group:ORYX.I18N.Arrangement.groupA,icon:ORYX.PATH+"images/shape_align_top.png",description:ORYX.I18N.Arrangement.atDesc,index:3,minShape:2});this.facade.offer({name:ORYX.I18N.Arrangement.al,functionality:this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_LEFT]),group:ORYX.I18N.Arrangement.groupA,icon:ORYX.PATH+"images/shape_align_left.png",description:ORYX.I18N.Arrangement.alDesc,index:4,minShape:2});this.facade.offer({name:ORYX.I18N.Arrangement.ac,functionality:this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_CENTER]),group:ORYX.I18N.Arrangement.groupA,icon:ORYX.PATH+"images/shape_align_center.png",description:ORYX.I18N.Arrangement.acDesc,index:5,minShape:2});this.facade.offer({name:ORYX.I18N.Arrangement.ar,functionality:this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_RIGHT]),group:ORYX.I18N.Arrangement.groupA,icon:ORYX.PATH+"images/shape_align_right.png",description:ORYX.I18N.Arrangement.arDesc,index:6,minShape:2});this.facade.offer({name:ORYX.I18N.Arrangement.as,functionality:this.alignShapes.bind(this,[ORYX.CONFIG.EDITOR_ALIGN_SIZE]),group:ORYX.I18N.Arrangement.groupA,icon:ORYX.PATH+"images/shape_align_size.png",description:ORYX.I18N.Arrangement.asDesc,index:7,minShape:2});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_TOP,this.setZLevel.bind(this,this.setToTop));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_BACK,this.setZLevel.bind(this,this.setToBack));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_FORWARD,this.setZLevel.bind(this,this.setForward));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_ARRANGEMENT_BACKWARD,this.setZLevel.bind(this,this.setBackward))},setZLevel:function(d,b){var a=ORYX.Core.Command.extend({construct:function(g,f,e){this.callback=g;this.elements=f;this.elAndIndex=f.map(function(h){return{el:h,previous:h.parent.children[h.parent.children.indexOf(h)-1]}});this.facade=e},execute:function(){this.callback(this.elements);this.facade.setSelection(this.elements)},rollback:function(){var g=this.elAndIndex.sortBy(function(n){var o=n.el;var m=$A(o.node.parentNode.childNodes);return m.indexOf(o.node)});for(var f=0;f<g.length;f++){var h=g[f].el;var k=h.parent;var l=k.children.indexOf(h);var e=k.children.indexOf(g[f].previous);e=e||0;k.children=k.children.insertFrom(l,e);h.node.parentNode.insertBefore(h.node,h.node.parentNode.childNodes[e+1])}this.facade.setSelection(this.elements)}});var c=new a(d,this.facade.getSelection(),this.facade);if(b.excludeCommand){c.execute()}else{this.facade.executeCommands([c])}},setToTop:function(b){var a=b.sortBy(function(e,c){var d=$A(e.node.parentNode.childNodes);return d.indexOf(e.node)});a.each(function(c){var d=c.parent;d.children=d.children.without(c);d.children.push(c);c.node.parentNode.appendChild(c.node)})},setToBack:function(b){var a=b.sortBy(function(e,c){var d=$A(e.node.parentNode.childNodes);return d.indexOf(e.node)});a=a.reverse();a.each(function(c){var d=c.parent;d.children=d.children.without(c);d.children.unshift(c);c.node.parentNode.insertBefore(c.node,c.node.parentNode.firstChild)})},setBackward:function(c){var b=c.sortBy(function(f,d){var e=$A(f.node.parentNode.childNodes);return e.indexOf(f.node)});b=b.reverse();var a=b.findAll(function(d){return !b.some(function(e){return e.node==d.node.previousSibling})});a.each(function(e){if(e.node.previousSibling===null){return}var f=e.parent;var d=f.children.indexOf(e);f.children=f.children.insertFrom(d,d-1);e.node.parentNode.insertBefore(e.node,e.node.previousSibling)})},setForward:function(c){var b=c.sortBy(function(f,d){var e=$A(f.node.parentNode.childNodes);return e.indexOf(f.node)});var a=b.findAll(function(d){return !b.some(function(e){return e.node==d.node.nextSibling})});a.each(function(f){var d=f.node.nextSibling;if(d===null){return}var e=f.parent.children.indexOf(f);var g=f.parent;g.children=g.children.insertFrom(e,e+1);f.node.parentNode.insertBefore(d,f.node)})},alignShapes:function(b){var f=this.facade.getSelection();f=this.facade.getCanvas().getShapesWithSharedParent(f);f=f.findAll(function(h){return(h instanceof ORYX.Core.Node)});f=f.findAll(function(h){var k=h.getIncomingShapes();return k.length==0||!f.include(k[0])});if(f.length<2){return}var e=f[0].absoluteBounds().clone();f.each(function(h){e.include(h.absoluteBounds().clone())});var d=0;var c=0;f.each(function(h){d=Math.max(h.bounds.width(),d);c=Math.max(h.bounds.height(),c)});var a=ORYX.Core.Command.extend({construct:function(o,n,m,l,h,k){this.elements=o;this.bounds=n;this.maxHeight=m;this.maxWidth=l;this.way=h;this.facade=k;this.orgPos=[]},setBounds:function(h,l){if(!l){l={width:ORYX.CONFIG.MAXIMUM_SIZE,height:ORYX.CONFIG.MAXIMUM_SIZE}}if(!h.bounds){throw"Bounds not definined."}var k={a:{x:h.bounds.upperLeft().x-(this.maxWidth-h.bounds.width())/2,y:h.bounds.upperLeft().y-(this.maxHeight-h.bounds.height())/2},b:{x:h.bounds.lowerRight().x+(this.maxWidth-h.bounds.width())/2,y:h.bounds.lowerRight().y+(this.maxHeight-h.bounds.height())/2}};if(this.maxWidth>l.width){k.a.x=h.bounds.upperLeft().x-(l.width-h.bounds.width())/2;k.b.x=h.bounds.lowerRight().x+(l.width-h.bounds.width())/2}if(this.maxHeight>l.height){k.a.y=h.bounds.upperLeft().y-(l.height-h.bounds.height())/2;k.b.y=h.bounds.lowerRight().y+(l.height-h.bounds.height())/2}h.bounds.set(k)},execute:function(){this.elements.each(function(h,k){this.orgPos[k]=h.bounds.upperLeft();var l=this.bounds.clone();if(h.parent&&!(h.parent instanceof ORYX.Core.Canvas)){var m=h.parent.absoluteBounds().upperLeft();l.moveBy(-m.x,-m.y)}switch(this.way){case ORYX.CONFIG.EDITOR_ALIGN_BOTTOM:h.bounds.moveTo({x:h.bounds.upperLeft().x,y:l.b.y-h.bounds.height()});break;case ORYX.CONFIG.EDITOR_ALIGN_MIDDLE:h.bounds.moveTo({x:h.bounds.upperLeft().x,y:(l.a.y+l.b.y-h.bounds.height())/2});break;case ORYX.CONFIG.EDITOR_ALIGN_TOP:h.bounds.moveTo({x:h.bounds.upperLeft().x,y:l.a.y});break;case ORYX.CONFIG.EDITOR_ALIGN_LEFT:h.bounds.moveTo({x:l.a.x,y:h.bounds.upperLeft().y});break;case ORYX.CONFIG.EDITOR_ALIGN_CENTER:h.bounds.moveTo({x:(l.a.x+l.b.x-h.bounds.width())/2,y:h.bounds.upperLeft().y});break;case ORYX.CONFIG.EDITOR_ALIGN_RIGHT:h.bounds.moveTo({x:l.b.x-h.bounds.width(),y:h.bounds.upperLeft().y});break;case ORYX.CONFIG.EDITOR_ALIGN_SIZE:if(h.isResizable){this.orgPos[k]={a:h.bounds.upperLeft(),b:h.bounds.lowerRight()};this.setBounds(h,h.maximumSize)}break}}.bind(this));this.facade.getCanvas().update();this.facade.updateSelection()},rollback:function(){this.elements.each(function(h,k){if(this.way==ORYX.CONFIG.EDITOR_ALIGN_SIZE){if(h.isResizable){h.bounds.set(this.orgPos[k])}}else{h.bounds.moveTo(this.orgPos[k])}}.bind(this));this.facade.getCanvas().update();this.facade.updateSelection()}});var g=new a(f,e,c,d,parseInt(b),this.facade);this.facade.executeCommands([g])}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Save=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,processURI:undefined,construct:function(a){this.facade=a;if(!(ORYX.CONFIG.IS_TEMPLATE)){this.facade.offer({name:ORYX.I18N.Save.save,functionality:this.save.bind(this,false),group:ORYX.I18N.Save.group,icon:ORYX.PATH+"images/disk.png",description:ORYX.I18N.Save.saveDesc,index:1,minShape:0,maxShape:0})}this.facade.offer({name:ORYX.I18N.Save.saveAs,functionality:this.save.bind(this,true),group:ORYX.I18N.Save.group,icon:ORYX.PATH+"images/disk_multi.png",description:ORYX.I18N.Save.saveAsDesc,index:2,minShape:0,maxShape:0});window.onbeforeunload=this.onUnLoad.bind(this);this.changeDifference=0;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_EXECUTE,function(){this.changeDifference++}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_EXECUTE_COMMANDS,function(){this.changeDifference++}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_ROLLBACK,function(){this.changeDifference--}.bind(this))},onUnLoad:function(){if(this.changeDifference!==0){return ORYX.I18N.Save.unsavedData}},saveSynchronously:function(e){this.changeDifference=0;var d="";if(this.processURI){d=this.processURI}else{if(!location.hash.slice(1)){d="/backend/poem/new"}else{d="/backend/poem/"+(location.hash.slice(1).replace(/^\/?/,"").replace(/\/?$/,""))+"/self"}}if(e){var c=this.facade.getStencilSets();var h=c[c.keys()[0]].source().split("stencilsets")[1];d="/backend/poem"+ORYX.CONFIG.ORYX_NEW_URL+"?stencilset=/stencilsets"+h}var g=this.facade.getCanvas().getSVGRepresentation(true);var f=DataManager.serialize(g);this.serializedDOM=Ext.encode(this.facade.getJSON());if(d.include(ORYX.CONFIG.ORYX_NEW_URL)){var c=this.facade.getStencilSets().values()[0];var a={title:ORYX.I18N.Save.newProcess,summary:"",type:c.title(),url:d,namespace:c.namespace()};var b=new Ext.XTemplate('<form class="oryx_repository_edit_model" action="#" id="edit_model" onsubmit="return false;">',"<fieldset>",'<p class="description">'+ORYX.I18N.Save.dialogDesciption+"</p>",'<input type="hidden" name="namespace" value="{namespace}" />','<p><label for="edit_model_title">'+ORYX.I18N.Save.dialogLabelTitle+'</label><input type="text" class="text" name="title" value="{title}" id="edit_model_title" onfocus="this.className = \'text activated\'" onblur="this.className = \'text\'"/></p>','<p><label for="edit_model_summary">'+ORYX.I18N.Save.dialogLabelDesc+'</label><textarea rows="5" name="summary" id="edit_model_summary" onfocus="this.className = \'activated\'" onblur="this.className = \'\'">{summary}</textarea></p>','<p><label for="edit_model_type">'+ORYX.I18N.Save.dialogLabelType+'</label><input type="text" name="type" class="text disabled" value="{type}" disabled="disabled" id="edit_model_type" /></p>',"</fieldset>","</form>");callback=function(m){var n=m.elements.title.value.strip();n=n.length==0?a.title:n;window.document.title=n+" - Oryx";var k=m.elements.summary.value.strip();k=k.length==0?a.summary:k;var l=m.elements.namespace.value.strip();l=l.length==0?a.namespace:l;win.destroy();this.sendSaveRequest(d,{data:this.serializedDOM,svg:f,title:n,summary:k,type:l},e)}.bind(this);win=new Ext.Window({id:"Propertie_Window",width:"auto",height:"auto",title:e?ORYX.I18N.Save.saveAsTitle:ORYX.I18N.Save.save,modal:true,bodyStyle:"background:#FFFFFF",html:b.apply(a),buttons:[{text:ORYX.I18N.Save.saveBtn,handler:function(){callback($("edit_model"))}},{text:ORYX.I18N.Save.close,handler:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});win.destroy()}.bind(this)}]});win.show()}else{this.sendSaveRequest(d,{data:this.serializedDOM,svg:f})}},sendSaveRequest:function(a,c,b){new Ajax.Request(a,{method:"POST",asynchronous:false,parameters:c,onSuccess:(function(g){var f=g.getResponseHeader("location");if(f){this.processURI=f}else{this.processURI=a}var e="/model"+this.processURI.split("model")[1].replace(/self\/?$/i,"");location.hash="#"+e;if(b){var d=new Ext.Window({title:ORYX.I18N.Save.savedAs,bodyStyle:"background:white;padding:10px",width:"auto",height:"auto",html:"<div style='font-weight:bold;margin-bottom:10px'>"+ORYX.I18N.Save.saveAsHint+"</div><span><a href='"+f+"' target='_blank'>"+f+"</a></span>",buttons:[{text:"Ok",handler:function(){d.destroy()}}]});d.show()}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_MODEL_SAVED});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.Save.saved})}).bind(this),onFailure:(function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.failed);ORYX.Log.warn("Saving failed: "+d.responseText)}).bind(this),on403:(function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.noRights);ORYX.Log.warn("Saving failed: "+d.responseText)}).bind(this)})},save:function(a,b){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Save.saving});window.setTimeout((function(){this.saveSynchronously(a)}).bind(this),10);return true}});ORYX.Plugins.File=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.File.print,functionality:this.print.bind(this),group:ORYX.I18N.File.group,icon:ORYX.PATH+"images/printer.png",description:ORYX.I18N.File.printDesc,index:3,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.File.pdf,functionality:this.exportPDF.bind(this),group:ORYX.I18N.File.group,icon:ORYX.PATH+"images/page_white_acrobat.png",description:ORYX.I18N.File.pdfDesc,index:4,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.File.svg,functionality:this.exportSVG.bind(this),group:ORYX.I18N.File.group,icon:ORYX.PATH+"images/page_white_code_red.png",description:ORYX.I18N.File.svgDesc,index:4,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.File.info,functionality:this.info.bind(this),group:ORYX.I18N.File.group,icon:ORYX.PATH+"images/information.png",description:ORYX.I18N.File.infoDesc,index:5,minShape:0,maxShape:0})},info:function(){var a='<iframe src="'+ORYX.CONFIG.LICENSE_URL+'" type="text/plain" style="border:none;display:block;width:575px;height:460px;"/>\n\n<pre style="display:inline;">Version: </pre><iframe src="'+ORYX.CONFIG.VERSION_URL+'" type="text/plain" style="border:none;overflow:hidden;display:inline;width:40px;height:20px;"/>';this.infoBox=Ext.Msg.show({title:ORYX.I18N.Oryx.title,msg:a,width:640,maxWidth:640,maxHeight:480,buttons:Ext.MessageBox.OK});return false},exportSVG:function(){var c=location.href;var b=this.facade.getCanvas().getSVGRepresentation(true);var a=DataManager.serialize(b);this.openDownloadWindow("oryx.svg",a)},exportPDF:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.File.genPDF});var c=location.href;var b=this.facade.getCanvas().getSVGRepresentation(true);var a=DataManager.serialize(b);new Ajax.Request(ORYX.CONFIG.PDF_EXPORT_URL,{method:"POST",parameters:{resource:c,data:a,format:"pdf"},onSuccess:(function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});window.open(d.responseText)}).bind(this),onFailure:(function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.File.genPDFFailed)}).bind(this)})},print:function(){Ext.Msg.show({title:ORYX.I18N.File.printTitle,msg:ORYX.I18N.File.printMsg,buttons:Ext.Msg.YESNO,icon:Ext.MessageBox.QUESTION,fn:function(c){if(c=="yes"){var e=$H({width:300,height:400,toolbar:"no",status:"no",menubar:"yes",dependent:"yes",resizable:"yes",scrollbars:"yes"});var f=window.open("","PrintWindow",e.invoke("join","=").join(","));var b=f.document.getElementsByTagName("head")[0];var d=document.createElement("style");d.innerHTML=" body {padding:0px; margin:0px} .svgcontainer { display:none; }";b.appendChild(d);f.document.getElementsByTagName("body")[0].appendChild(this.facade.getCanvas().getSVGRepresentation());var a=f.document.getElementsByTagName("body")[0].getElementsByTagName("svg")[0];a.setAttributeNS(null,"width",1100);a.setAttributeNS(null,"height",1400);a.lastChild.setAttributeNS(null,"transform","scale(0.47, 0.47) rotate(270, 1510, 1470)");var h=["marker-start","marker-mid","marker-end"];var g=$A(f.document.getElementsByTagName("path"));g.each(function(k){h.each(function(l){var m=k.getAttributeNS(null,l);if(!m){return}m="url(about:blank#"+m.slice(5);k.setAttributeNS(null,l,m)})});f.print();return true}}.bind(this)})}});window.onOryxResourcesLoaded=function(){if(location.hash.slice(1).length==0||location.hash.slice(1).indexOf("new")!=-1){var a=ORYX.Utils.getParamFromUrl("stencilset")||ORYX.CONFIG.SSET;new ORYX.Editor({id:"oryx-canvas123",stencilset:{url:ORYX.PATH+"/"+a}})}else{ORYX.Editor.createByUrl("/backend/poem"+location.hash.slice(1).replace(/\/*$/,"/").replace(/^\/*/,"/")+"json",{id:"oryx-canvas123",onFailure:function(b){if(403==b.status){Ext.Msg.show({title:"Authentication Failed",msg:'You may not have access rights for this model, maybe you forgot to <a href="'+ORYX.CONFIG.WEB_URL+'/backend/poem/repository">log in</a>?',icon:Ext.MessageBox.WARNING,closeable:false,closable:false})}else{if(404==b.status){Ext.Msg.show({title:"Not Found",msg:"The model you requested could not be found.",icon:Ext.MessageBox.WARNING,closeable:false,closable:false})}else{Ext.Msg.show({title:"Internal Error",msg:"We're sorry, the model cannot be loaded due to an internal error",icon:Ext.MessageBox.WARNING,closeable:false,closable:false})}}}})}};if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Save=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,processURI:undefined,construct:function(a){this.facade=a;if(!(ORYX.CONFIG.IS_TEMPLATE)){this.facade.offer({name:ORYX.I18N.Save.save,functionality:this.save.bind(this,false),group:ORYX.I18N.Save.group,icon:ORYX.PATH+"images/disk.png",description:ORYX.I18N.Save.saveDesc,index:1,minShape:0,maxShape:0})}this.facade.offer({name:ORYX.I18N.Save.saveAs,functionality:this.save.bind(this,true),group:ORYX.I18N.Save.group,icon:ORYX.PATH+"images/disk_multi.png",description:ORYX.I18N.Save.saveAsDesc,index:2,minShape:0,maxShape:0});window.onbeforeunload=this.onUnLoad.bind(this);this.changeDifference=0;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_EXECUTE,function(){this.changeDifference++}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_EXECUTE_COMMANDS,function(){this.changeDifference++}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_ROLLBACK,function(){this.changeDifference--}.bind(this))},onUnLoad:function(){if(this.changeDifference!==0){return ORYX.I18N.Save.unsavedData}},saveSynchronously:function(e){this.changeDifference=0;var d="";if(this.processURI){d=this.processURI}else{if(!location.hash.slice(1)){d="/backend/poem/new"}else{d="/backend/poem/"+(location.hash.slice(1).replace(/^\/?/,"").replace(/\/?$/,""))+"/self"}}if(e){var c=this.facade.getStencilSets();var h=c[c.keys()[0]].source().split("stencilsets")[1];d="/backend/poem"+ORYX.CONFIG.ORYX_NEW_URL+"?stencilset=/stencilsets"+h}var g=this.facade.getCanvas().getSVGRepresentation(true);var f=DataManager.serialize(g);this.serializedDOM=Ext.encode(this.facade.getJSON());if(d.include(ORYX.CONFIG.ORYX_NEW_URL)){var c=this.facade.getStencilSets().values()[0];var a={title:ORYX.I18N.Save.newProcess,summary:"",type:c.title(),url:d,namespace:c.namespace()};var b=new Ext.XTemplate('<form class="oryx_repository_edit_model" action="#" id="edit_model" onsubmit="return false;">',"<fieldset>",'<p class="description">'+ORYX.I18N.Save.dialogDesciption+"</p>",'<input type="hidden" name="namespace" value="{namespace}" />','<p><label for="edit_model_title">'+ORYX.I18N.Save.dialogLabelTitle+'</label><input type="text" class="text" name="title" value="{title}" id="edit_model_title" onfocus="this.className = \'text activated\'" onblur="this.className = \'text\'"/></p>','<p><label for="edit_model_summary">'+ORYX.I18N.Save.dialogLabelDesc+'</label><textarea rows="5" name="summary" id="edit_model_summary" onfocus="this.className = \'activated\'" onblur="this.className = \'\'">{summary}</textarea></p>','<p><label for="edit_model_type">'+ORYX.I18N.Save.dialogLabelType+'</label><input type="text" name="type" class="text disabled" value="{type}" disabled="disabled" id="edit_model_type" /></p>',"</fieldset>","</form>");callback=function(m){var n=m.elements.title.value.strip();n=n.length==0?a.title:n;window.document.title=n+" - Oryx";var k=m.elements.summary.value.strip();k=k.length==0?a.summary:k;var l=m.elements.namespace.value.strip();l=l.length==0?a.namespace:l;win.destroy();this.sendSaveRequest(d,{data:this.serializedDOM,svg:f,title:n,summary:k,type:l},e)}.bind(this);win=new Ext.Window({id:"Propertie_Window",width:"auto",height:"auto",title:e?ORYX.I18N.Save.saveAsTitle:ORYX.I18N.Save.save,modal:true,bodyStyle:"background:#FFFFFF",html:b.apply(a),buttons:[{text:ORYX.I18N.Save.saveBtn,handler:function(){callback($("edit_model"))}},{text:ORYX.I18N.Save.close,handler:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});win.destroy()}.bind(this)}]});win.show()}else{this.sendSaveRequest(d,{data:this.serializedDOM,svg:f})}},sendSaveRequest:function(a,c,b){new Ajax.Request(a,{method:"POST",asynchronous:false,parameters:c,onSuccess:(function(g){var f=g.getResponseHeader("location");if(f){this.processURI=f}else{this.processURI=a}var e="/model"+this.processURI.split("model")[1].replace(/self\/?$/i,"");location.hash="#"+e;if(b){var d=new Ext.Window({title:ORYX.I18N.Save.savedAs,bodyStyle:"background:white;padding:10px",width:"auto",height:"auto",html:"<div style='font-weight:bold;margin-bottom:10px'>"+ORYX.I18N.Save.saveAsHint+"</div><span><a href='"+f+"' target='_blank'>"+f+"</a></span>",buttons:[{text:"Ok",handler:function(){d.destroy()}}]});d.show()}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_MODEL_SAVED});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.Save.saved})}).bind(this),onFailure:(function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.failed);ORYX.Log.warn("Saving failed: "+d.responseText)}).bind(this),on403:(function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Save.noRights);ORYX.Log.warn("Saving failed: "+d.responseText)}).bind(this)})},save:function(a,b){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Save.saving});window.setTimeout((function(){this.saveSynchronously(a)}).bind(this),10);return true}});ORYX.Plugins.File=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.File.print,functionality:this.print.bind(this),group:ORYX.I18N.File.group,icon:ORYX.PATH+"images/printer.png",description:ORYX.I18N.File.printDesc,index:3,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.File.pdf,functionality:this.exportPDF.bind(this),group:ORYX.I18N.File.group,icon:ORYX.PATH+"images/page_white_acrobat.png",description:ORYX.I18N.File.pdfDesc,index:4,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.File.svg,functionality:this.exportSVG.bind(this),group:ORYX.I18N.File.group,icon:ORYX.PATH+"images/page_white_code_red.png",description:ORYX.I18N.File.svgDesc,index:4,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.File.info,functionality:this.info.bind(this),group:ORYX.I18N.File.group,icon:ORYX.PATH+"images/information.png",description:ORYX.I18N.File.infoDesc,index:5,minShape:0,maxShape:0})},info:function(){var a='<iframe src="'+ORYX.CONFIG.LICENSE_URL+'" type="text/plain" style="border:none;display:block;width:575px;height:460px;"/>\n\n<pre style="display:inline;">Version: </pre><iframe src="'+ORYX.CONFIG.VERSION_URL+'" type="text/plain" style="border:none;overflow:hidden;display:inline;width:40px;height:20px;"/>';this.infoBox=Ext.Msg.show({title:ORYX.I18N.Oryx.title,msg:a,width:640,maxWidth:640,maxHeight:480,buttons:Ext.MessageBox.OK});return false},exportSVG:function(){var c=location.href;var b=this.facade.getCanvas().getSVGRepresentation(true);var a=DataManager.serialize(b);this.openDownloadWindow("oryx.svg",a)},exportPDF:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.File.genPDF});var c=location.href;var b=this.facade.getCanvas().getSVGRepresentation(true);var a=DataManager.serialize(b);new Ajax.Request(ORYX.CONFIG.PDF_EXPORT_URL,{method:"POST",parameters:{resource:c,data:a,format:"pdf"},onSuccess:(function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});window.open(d.responseText)}).bind(this),onFailure:(function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.File.genPDFFailed)}).bind(this)})},print:function(){Ext.Msg.show({title:ORYX.I18N.File.printTitle,msg:ORYX.I18N.File.printMsg,buttons:Ext.Msg.YESNO,icon:Ext.MessageBox.QUESTION,fn:function(c){if(c=="yes"){var e=$H({width:300,height:400,toolbar:"no",status:"no",menubar:"yes",dependent:"yes",resizable:"yes",scrollbars:"yes"});var f=window.open("","PrintWindow",e.invoke("join","=").join(","));var b=f.document.getElementsByTagName("head")[0];var d=document.createElement("style");d.innerHTML=" body {padding:0px; margin:0px} .svgcontainer { display:none; }";b.appendChild(d);f.document.getElementsByTagName("body")[0].appendChild(this.facade.getCanvas().getSVGRepresentation());var a=f.document.getElementsByTagName("body")[0].getElementsByTagName("svg")[0];a.setAttributeNS(null,"width",1100);a.setAttributeNS(null,"height",1400);a.lastChild.setAttributeNS(null,"transform","scale(0.47, 0.47) rotate(270, 1510, 1470)");var h=["marker-start","marker-mid","marker-end"];var g=$A(f.document.getElementsByTagName("path"));g.each(function(k){h.each(function(l){var m=k.getAttributeNS(null,l);if(!m){return}m="url(about:blank#"+m.slice(5);k.setAttributeNS(null,l,m)})});f.print();return true}}.bind(this)})}});window.onOryxResourcesLoaded=function(){if(location.hash.slice(1).length==0||location.hash.slice(1).indexOf("new")!=-1){var a=ORYX.Utils.getParamFromUrl("stencilset")||ORYX.CONFIG.SSET;new ORYX.Editor({id:"oryx-canvas123",stencilset:{url:ORYX.PATH+"/"+a}})}else{ORYX.Editor.createByUrl("/backend/poem"+location.hash.slice(1).replace(/\/*$/,"/").replace(/^\/*/,"/")+"json",{id:"oryx-canvas123",onFailure:function(b){if(403==b.status){Ext.Msg.show({title:"Authentication Failed",msg:'You may not have access rights for this model, maybe you forgot to <a href="'+ORYX.CONFIG.WEB_URL+'/backend/poem/repository">log in</a>?',icon:Ext.MessageBox.WARNING,closeable:false,closable:false})}else{if(404==b.status){Ext.Msg.show({title:"Not Found",msg:"The model you requested could not be found.",icon:Ext.MessageBox.WARNING,closeable:false,closable:false})}else{Ext.Msg.show({title:"Internal Error",msg:"We're sorry, the model cannot be loaded due to an internal error",icon:Ext.MessageBox.WARNING,closeable:false,closable:false})}}}})}};if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.View={facade:undefined,construct:function(b,a){this.facade=b;this.zoomLevel=1;this.maxFitToScreenLevel=1.5;this.minZoomLevel=0.1;this.maxZoomLevel=2.5;this.diff=5;a.properties.each(function(c){if(c.zoomLevel){this.zoomLevel=Number(1)}if(c.maxFitToScreenLevel){this.maxFitToScreenLevel=Number(c.maxFitToScreenLevel)}if(c.minZoomLevel){this.minZoomLevel=Number(c.minZoomLevel)}if(c.maxZoomLevel){this.maxZoomLevel=Number(c.maxZoomLevel)}}.bind(this));this.facade.offer({name:ORYX.I18N.View.zoomIn,functionality:this.zoom.bind(this,[1+ORYX.CONFIG.ZOOM_OFFSET]),group:ORYX.I18N.View.group,icon:ORYX.PATH+"images/magnifier_zoom_in.png",description:ORYX.I18N.View.zoomInDesc,index:1,minShape:0,maxShape:0,isEnabled:function(){return this.zoomLevel<this.maxZoomLevel}.bind(this)});this.facade.offer({name:ORYX.I18N.View.zoomOut,functionality:this.zoom.bind(this,[1-ORYX.CONFIG.ZOOM_OFFSET]),group:ORYX.I18N.View.group,icon:ORYX.PATH+"images/magnifier_zoom_out.png",description:ORYX.I18N.View.zoomOutDesc,index:2,minShape:0,maxShape:0,isEnabled:function(){return this._checkSize()}.bind(this)});this.facade.offer({name:ORYX.I18N.View.zoomStandard,functionality:this.setAFixZoomLevel.bind(this,1),group:ORYX.I18N.View.group,icon:ORYX.PATH+"images/zoom_standard.png",cls:"icon-large",description:ORYX.I18N.View.zoomStandardDesc,index:3,minShape:0,maxShape:0,isEnabled:function(){return this.zoomLevel!=1}.bind(this)});this.facade.offer({name:ORYX.I18N.View.zoomFitToModel,functionality:this.zoomFitToModel.bind(this),group:ORYX.I18N.View.group,icon:ORYX.PATH+"images/image.png",description:ORYX.I18N.View.zoomFitToModelDesc,index:4,minShape:0,maxShape:0})},setAFixZoomLevel:function(a){this.zoomLevel=a;this._checkZoomLevelRange();this.zoom(1)},zoom:function(d){this.zoomLevel*=d;var h=this.facade.getCanvas().getHTMLContainer().parentNode.parentNode;var c=this.facade.getCanvas();var g=c.bounds.width()*this.zoomLevel;var a=c.bounds.height()*this.zoomLevel;var f=(c.node.parentNode.parentNode.parentNode.offsetHeight-a)/2;f=f>20?f-20:0;c.node.parentNode.parentNode.style.marginTop=f+"px";f+=5;c.getHTMLContainer().style.top=f+"px";var b=h.scrollTop-Math.round((c.getHTMLContainer().parentNode.getHeight()-a)/2)+this.diff;var e=h.scrollLeft-Math.round((c.getHTMLContainer().parentNode.getWidth()-g)/2)+this.diff;c.setSize({width:g,height:a},true);c.node.setAttributeNS(null,"transform","scale("+this.zoomLevel+")");this.facade.updateSelection();h.scrollTop=b;h.scrollLeft=e;c.zoomLevel=this.zoomLevel},zoomFitToModel:function(){var h=this.facade.getCanvas().getHTMLContainer().parentNode.parentNode;var b=h.getHeight()-30;var d=h.getWidth()-30;var c=this.facade.getCanvas().getChildShapes();if(!c||c.length<1){return false}var g=c[0].absoluteBounds().clone();c.each(function(k){g.include(k.absoluteBounds().clone())});var f=d/g.width();var a=b/g.height();var e=a<f?a:f;if(e>this.maxFitToScreenLevel){e=this.maxFitToScreenLevel}this.setAFixZoomLevel(e);h.scrollTop=Math.round(g.upperLeft().y*this.zoomLevel)-5;h.scrollLeft=Math.round(g.upperLeft().x*this.zoomLevel)-5},_checkSize:function(){var a=this.facade.getCanvas().getHTMLContainer().parentNode;var b=Math.min((a.parentNode.getWidth()/a.getWidth()),(a.parentNode.getHeight()/a.getHeight()));return 1.05>b},_checkZoomLevelRange:function(){if(this.zoomLevel<this.minZoomLevel){this.zoomLevel=this.minZoomLevel}if(this.zoomLevel>this.maxZoomLevel){this.zoomLevel=this.maxZoomLevel}}};ORYX.Plugins.View=Clazz.extend(ORYX.Plugins.View);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.DragDropResize=ORYX.Plugins.AbstractPlugin.extend({construct:function(b){this.facade=b;this.currentShapes=[];this.toMoveShapes=[];this.distPoints=[];this.isResizing=false;this.dragEnable=false;this.dragIntialized=false;this.edgesMovable=true;this.offSetPosition={x:0,y:0};this.faktorXY={x:1,y:1};this.containmentParentNode;this.isAddingAllowed=false;this.isAttachingAllowed=false;this.callbackMouseMove=this.handleMouseMove.bind(this);this.callbackMouseUp=this.handleMouseUp.bind(this);var a=this.facade.getCanvas().getSvgContainer();this.selectedRect=new ORYX.Plugins.SelectedRect(a);if(ORYX.CONFIG.SHOW_GRIDLINE){this.vLine=new ORYX.Plugins.GridLine(a,ORYX.Plugins.GridLine.DIR_VERTICAL);this.hLine=new ORYX.Plugins.GridLine(a,ORYX.Plugins.GridLine.DIR_HORIZONTAL)}a=this.facade.getCanvas().getHTMLContainer();this.scrollNode=this.facade.getCanvas().rootNode.parentNode.parentNode;this.resizerSE=new ORYX.Plugins.Resizer(a,"southeast",this.facade);this.resizerSE.registerOnResize(this.onResize.bind(this));this.resizerSE.registerOnResizeEnd(this.onResizeEnd.bind(this));this.resizerSE.registerOnResizeStart(this.onResizeStart.bind(this));this.resizerNW=new ORYX.Plugins.Resizer(a,"northwest",this.facade);this.resizerNW.registerOnResize(this.onResize.bind(this));this.resizerNW.registerOnResizeEnd(this.onResizeEnd.bind(this));this.resizerNW.registerOnResizeStart(this.onResizeStart.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this))},handleMouseDown:function(d,c){if(!this.dragBounds||!this.currentShapes.member(c)||!this.toMoveShapes.length){return}this.dragEnable=true;this.dragIntialized=true;this.edgesMovable=true;var b=this.facade.getCanvas().node.getScreenCTM();this.faktorXY.x=b.a;this.faktorXY.y=b.d;var e=this.dragBounds.upperLeft();this.offSetPosition={x:Event.pointerX(d)-(e.x*this.faktorXY.x),y:Event.pointerY(d)-(e.y*this.faktorXY.y)};this.offsetScroll={x:this.scrollNode.scrollLeft,y:this.scrollNode.scrollTop};document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.callbackMouseMove,false);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.callbackMouseUp,true);return},handleMouseUp:function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.contain"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.attached"});if(this.dragEnable){if(!this.dragIntialized){this.afterDrag();if(this.isAttachingAllowed&&this.toMoveShapes.length==1&&this.toMoveShapes[0] instanceof ORYX.Core.Node&&this.toMoveShapes[0].dockers.length>0){var b=this.facade.eventCoordinates(d);var e=this.toMoveShapes[0].dockers[0];var c=ORYX.Core.Command.extend({construct:function(k,f,h,g){this.docker=k;this.newPosition=f;this.newDockedShape=h;this.newParent=h.parent||g.getCanvas();this.oldPosition=k.parent.bounds.center();this.oldDockedShape=k.getDockedShape();this.oldParent=k.parent.parent||g.getCanvas();this.facade=g;if(this.oldDockedShape){this.oldPosition=k.parent.absoluteBounds().center()}},execute:function(){this.dock(this.newDockedShape,this.newParent,this.newPosition);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_ARRANGEMENT_TOP,excludeCommand:true})},rollback:function(){this.dock(this.oldDockedShape,this.oldParent,this.oldPosition)},dock:function(f,g,h){g.add(this.docker.parent);this.docker.setDockedShape(undefined);this.docker.bounds.centerMoveTo(h);this.docker.setDockedShape(f);this.facade.setSelection([this.docker.parent]);this.facade.getCanvas().update();this.facade.updateSelection()}});var a=[new c(e,b,this.containmentParentNode,this.facade)];this.facade.executeCommands(a)}else{if(this.isAddingAllowed){this.refreshSelectedShapes()}}this.facade.updateSelection();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_DRAGDROP_END})}if(this.vLine){this.vLine.hide()}if(this.hLine){this.hLine.hide()}}this.dragEnable=false;document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.callbackMouseUp,true);document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.callbackMouseMove,false);return},handleMouseMove:function(g){if(!this.dragEnable){return}if(this.dragIntialized){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_DRAGDROP_START});this.dragIntialized=false;this.resizerSE.hide();this.resizerNW.hide();this._onlyEdges=this.currentShapes.all(function(c){return(c instanceof ORYX.Core.Edge)});this.beforeDrag();this._currentUnderlyingNodes=[]}var a={x:Event.pointerX(g)-this.offSetPosition.x,y:Event.pointerY(g)-this.offSetPosition.y};a.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;a.y-=this.offsetScroll.y-this.scrollNode.scrollTop;var b=g.shiftKey||g.ctrlKey;if(ORYX.CONFIG.GRID_ENABLED&&!b){a=this.snapToGrid(a)}else{if(this.vLine){this.vLine.hide()}if(this.hLine){this.hLine.hide()}}a.x/=this.faktorXY.x;a.y/=this.faktorXY.y;a.x=Math.max(0,a.x);a.y=Math.max(0,a.y);var h=this.facade.getCanvas();a.x=Math.min(h.bounds.width()-this.dragBounds.width(),a.x);a.y=Math.min(h.bounds.height()-this.dragBounds.height(),a.y);this.dragBounds.moveTo(a);this.resizeRectangle(this.dragBounds);this.isAttachingAllowed=false;var d=$A(this.facade.getCanvas().getAbstractShapesAtPosition(this.facade.eventCoordinates(g)));var f=this.toMoveShapes.length==1&&this.toMoveShapes[0] instanceof ORYX.Core.Node&&this.toMoveShapes[0].dockers.length>0;f=f&&d.length!=1;if(!f&&d.length===this._currentUnderlyingNodes.length&&d.all(function(k,c){return this._currentUnderlyingNodes[c]===k}.bind(this))){return}else{if(this._onlyEdges){this.isAddingAllowed=true;this.containmentParentNode=this.facade.getCanvas()}else{var e={event:g,underlyingNodes:d,checkIfAttachable:f};this.checkRules(e)}}this._currentUnderlyingNodes=d.reverse();if(this.isAttachingAllowed){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"dragdropresize.attached",elements:[this.containmentParentNode],style:ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE,color:ORYX.CONFIG.SELECTION_VALID_COLOR})}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.attached"})}if(!this.isAttachingAllowed){if(this.isAddingAllowed){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"dragdropresize.contain",elements:[this.containmentParentNode],color:ORYX.CONFIG.SELECTION_VALID_COLOR})}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"dragdropresize.contain",elements:[this.containmentParentNode],color:ORYX.CONFIG.SELECTION_INVALID_COLOR})}}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"dragdropresize.contain"})}return},checkRules:function(d){var f=d.event;var c=d.underlyingNodes;var e=d.checkIfAttachable;var b=d.noEdges;this.containmentParentNode=c.reverse().find((function(g){return(g instanceof ORYX.Core.Canvas)||(((g instanceof ORYX.Core.Node)||((g instanceof ORYX.Core.Edge)&&!b))&&(!(this.currentShapes.member(g)||this.currentShapes.any(function(h){return(h.children.length>0&&h.getChildNodes(true).member(g))}))))}).bind(this));if(e&&this.containmentParentNode){this.isAttachingAllowed=this.facade.getRules().canConnect({sourceShape:this.containmentParentNode,edgeShape:this.toMoveShapes[0],targetShape:this.toMoveShapes[0]});if(this.isAttachingAllowed){var a=this.facade.eventCoordinates(f);this.isAttachingAllowed=this.containmentParentNode.isPointOverOffset(a.x,a.y)}}if(!this.isAttachingAllowed){this.isAddingAllowed=this.toMoveShapes.all((function(g){if(g instanceof ORYX.Core.Edge||g instanceof ORYX.Core.Controls.Docker||this.containmentParentNode===g.parent){return true}else{if(this.containmentParentNode!==g){if(!(this.containmentParentNode instanceof ORYX.Core.Edge)||!b){if(this.facade.getRules().canContain({containingShape:this.containmentParentNode,containedShape:g})){return true}}}}return false}).bind(this))}if(!this.isAttachingAllowed&&!this.isAddingAllowed&&(this.containmentParentNode instanceof ORYX.Core.Edge)){d.noEdges=true;d.underlyingNodes.reverse();this.checkRules(d)}},refreshSelectedShapes:function(){if(!this.dragBounds){return}var d=this.dragBounds.upperLeft();var b=this.oldDragBounds.upperLeft();var c={x:d.x-b.x,y:d.y-b.y};var a=[new ORYX.Core.Command.Move(this.toMoveShapes,c,this.containmentParentNode,this.currentShapes,this)];if(this._undockedEdgesCommand instanceof ORYX.Core.Command){a.unshift(this._undockedEdgesCommand)}this.facade.executeCommands(a);if(this.dragBounds){this.oldDragBounds=this.dragBounds.clone()}},onResize:function(a){if(!this.dragBounds){return}this.dragBounds=a;this.isResizing=true;this.resizeRectangle(this.dragBounds)},onResizeStart:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_RESIZE_START})},onResizeEnd:function(){if(!(this.currentShapes instanceof Array)||this.currentShapes.length<=0){return}if(this.isResizing){var a=ORYX.Core.Command.extend({construct:function(f,h,g){this.shape=f;this.oldBounds=f.bounds.clone();this.newBounds=h;this.plugin=g},execute:function(){this.shape.bounds.set(this.newBounds.a,this.newBounds.b);this.update(this.getOffset(this.oldBounds,this.newBounds))},rollback:function(){this.shape.bounds.set(this.oldBounds.a,this.oldBounds.b);this.update(this.getOffset(this.newBounds,this.oldBounds))},getOffset:function(g,f){return{x:f.a.x-g.a.x,y:f.a.y-g.a.y,xs:f.width()/g.width(),ys:f.height()/g.height()}},update:function(g){this.shape.getLabels().each(function(h){h.changed()});var f=[].concat(this.shape.getIncomingShapes()).concat(this.shape.getOutgoingShapes()).findAll(function(h){return h instanceof ORYX.Core.Edge}.bind(this));this.plugin.layoutEdges(this.shape,f,g);this.plugin.facade.setSelection([this.shape]);this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()}});var c=this.dragBounds.clone();var b=this.currentShapes[0];if(b.parent){var e=b.parent.absoluteXY();c.moveBy(-e.x,-e.y)}var d=new a(b,c,this);this.facade.executeCommands([d]);this.isResizing=false;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_RESIZE_END})}},beforeDrag:function(){var a=ORYX.Core.Command.extend({construct:function(b){this.dockers=b.collect(function(c){return c instanceof ORYX.Core.Controls.Docker?{docker:c,dockedShape:c.getDockedShape(),refPoint:c.referencePoint}:undefined}).compact()},execute:function(){this.dockers.each(function(b){b.docker.setDockedShape(undefined)})},rollback:function(){this.dockers.each(function(b){b.docker.setDockedShape(b.dockedShape);b.docker.setReferencePoint(b.refPoint)})}});this._undockedEdgesCommand=new a(this.toMoveShapes);this._undockedEdgesCommand.execute()},hideAllLabels:function(a){a.getLabels().each(function(b){b.hide()});a.getAllDockedShapes().each(function(b){var c=b.getLabels();if(c.length>0){c.each(function(d){d.hide()})}});a.getChildren().each((function(b){if(b instanceof ORYX.Core.Shape){this.hideAllLabels(b)}}).bind(this))},afterDrag:function(){},showAllLabels:function(a){for(var d=0;d<a.length;d++){var b=a[d];b.show()}var f=a.getAllDockedShapes();for(var d=0;d<f.length;d++){var c=f[d];var g=c.getLabels();if(g.length>0){g.each(function(h){h.show()})}}for(var d=0;d<a.children.length;d++){var e=a.children[d];if(e instanceof ORYX.Core.Shape){this.showAllLabels(e)}}},onSelectionChanged:function(b){var d=b.elements;this.dragEnable=false;this.dragIntialized=false;this.resizerSE.hide();this.resizerNW.hide();if(!d||d.length==0){this.selectedRect.hide();this.currentShapes=[];this.toMoveShapes=[];this.dragBounds=undefined;this.oldDragBounds=undefined}else{this.currentShapes=d;var e=this.facade.getCanvas().getShapesWithSharedParent(d);this.toMoveShapes=e;this.toMoveShapes=this.toMoveShapes.findAll(function(f){return f instanceof ORYX.Core.Node&&(f.dockers.length===0||!d.member(f.dockers.first().getDockedShape()))});d.each((function(f){if(!(f instanceof ORYX.Core.Edge)){return}var h=f.getDockers();var k=d.member(h.first().getDockedShape());var g=d.member(h.last().getDockedShape());if(!k&&!g){var l=!h.first().getDockedShape()&&!h.last().getDockedShape();if(l){this.toMoveShapes=this.toMoveShapes.concat(h)}}if(f.dockers.length>2&&k&&g){this.toMoveShapes=this.toMoveShapes.concat(h.findAll(function(n,m){return m>0&&m<h.length-1}))}}).bind(this));var c=undefined;this.toMoveShapes.each(function(g){var f=g;if(g instanceof ORYX.Core.Controls.Docker){f=g.parent}if(!c){c=f.absoluteBounds()}else{c.include(f.absoluteBounds())}}.bind(this));if(!c){d.each(function(f){if(!c){c=f.absoluteBounds()}else{c.include(f.absoluteBounds())}})}this.dragBounds=c;this.oldDragBounds=c.clone();this.resizeRectangle(c);this.selectedRect.show();if(d.length==1&&d[0].isResizable){var a=d[0].getStencil().fixedAspectRatio()?d[0].bounds.width()/d[0].bounds.height():undefined;this.resizerSE.setBounds(this.dragBounds,d[0].minimumSize,d[0].maximumSize,a);this.resizerSE.show();this.resizerNW.setBounds(this.dragBounds,d[0].minimumSize,d[0].maximumSize,a);this.resizerNW.show()}else{this.resizerSE.setBounds(undefined);this.resizerNW.setBounds(undefined)}if(ORYX.CONFIG.GRID_ENABLED){this.distPoints=[];if(this.distPointTimeout){window.clearTimeout(this.distPointTimeout)}this.distPointTimeout=window.setTimeout(function(){var f=this.facade.getCanvas().getChildShapes(true).findAll(function(h){var g=h.parent;while(g){if(d.member(g)){return false}g=g.parent}return true});f.each((function(l){if(!(l instanceof ORYX.Core.Edge)){var h=l.absoluteXY();var k=l.bounds.width();var g=l.bounds.height();this.distPoints.push({ul:{x:h.x,y:h.y},c:{x:h.x+(k/2),y:h.y+(g/2)},lr:{x:h.x+k,y:h.y+g}})}}).bind(this))}.bind(this),10)}}},snapToGrid:function(h){var a=this.dragBounds;var p={};var o=6;var m=10;var q=6;var b=this.vLine?this.vLine.getScale():1;var l={x:(h.x/b),y:(h.y/b)};var n={x:(h.x/b)+(a.width()/2),y:(h.y/b)+(a.height()/2)};var g={x:(h.x/b)+(a.width()),y:(h.y/b)+(a.height())};var f,d;var k,e;this.distPoints.each(function(s){var c,u,t,r;if(Math.abs(s.c.x-n.x)<m){c=s.c.x-n.x;t=s.c.x}if(Math.abs(s.c.y-n.y)<m){u=s.c.y-n.y;r=s.c.y}if(c!==undefined){f=f===undefined?c:(Math.abs(c)<Math.abs(f)?c:f);if(f===c){k=t}}if(u!==undefined){d=d===undefined?u:(Math.abs(u)<Math.abs(d)?u:d);if(d===u){e=r}}});if(f!==undefined){l.x+=f;l.x*=b;if(this.vLine&&k){this.vLine.update(k)}}else{l.x=(h.x-(h.x%(ORYX.CONFIG.GRID_DISTANCE/2)));if(this.vLine){this.vLine.hide()}}if(d!==undefined){l.y+=d;l.y*=b;if(this.hLine&&e){this.hLine.update(e)}}else{l.y=(h.y-(h.y%(ORYX.CONFIG.GRID_DISTANCE/2)));if(this.hLine){this.hLine.hide()}}return l},showGridLine:function(){},resizeRectangle:function(a){this.selectedRect.resize(a)}});ORYX.Plugins.SelectedRect=Clazz.extend({construct:function(a){this.parentId=a;this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",$(a),["g"]);this.dashedArea=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["rect",{x:0,y:0,"stroke-width":1,stroke:"#777777",fill:"none","stroke-dasharray":"2,2","pointer-events":"none"}]);this.hide()},hide:function(){this.node.setAttributeNS(null,"display","none")},show:function(){this.node.setAttributeNS(null,"display","")},resize:function(a){var c=a.upperLeft();var b=ORYX.CONFIG.SELECTED_AREA_PADDING;this.dashedArea.setAttributeNS(null,"width",a.width()+2*b);this.dashedArea.setAttributeNS(null,"height",a.height()+2*b);this.node.setAttributeNS(null,"transform","translate("+(c.x-b)+", "+(c.y-b)+")")}});ORYX.Plugins.GridLine=Clazz.extend({construct:function(b,a){if(ORYX.Plugins.GridLine.DIR_HORIZONTAL!==a&&ORYX.Plugins.GridLine.DIR_VERTICAL!==a){a=ORYX.Plugins.GridLine.DIR_HORIZONTAL}this.parent=$(b);this.direction=a;this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parent,["g"]);this.line=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["path",{"stroke-width":1,stroke:"silver",fill:"none","stroke-dasharray":"5,5","pointer-events":"none"}]);this.hide()},hide:function(){this.node.setAttributeNS(null,"display","none")},show:function(){this.node.setAttributeNS(null,"display","")},getScale:function(){try{return this.parent.parentNode.transform.baseVal.getItem(0).matrix.a}catch(a){return 1}},update:function(e){if(this.direction===ORYX.Plugins.GridLine.DIR_HORIZONTAL){var d=e instanceof Object?e.y:e;var c=this.parent.parentNode.parentNode.width.baseVal.value/this.getScale();this.line.setAttributeNS(null,"d","M 0 "+d+" L "+c+" "+d)}else{var a=e instanceof Object?e.x:e;var b=this.parent.parentNode.parentNode.height.baseVal.value/this.getScale();this.line.setAttributeNS(null,"d","M"+a+" 0 L "+a+" "+b)}this.show()}});ORYX.Plugins.GridLine.DIR_HORIZONTAL="hor";ORYX.Plugins.GridLine.DIR_VERTICAL="ver";ORYX.Plugins.Resizer=Clazz.extend({construct:function(c,a,b){this.parentId=c;this.orientation=a;this.facade=b;this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",$(this.parentId),["div",{"class":"resizer_"+this.orientation,style:"left:0px; top:0px;"}]);this.node.addEventListener(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this),true);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.handleMouseUp.bind(this),true);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.handleMouseMove.bind(this),false);this.dragEnable=false;this.offSetPosition={x:0,y:0};this.bounds=undefined;this.canvasNode=this.facade.getCanvas().node;this.minSize=undefined;this.maxSize=undefined;this.aspectRatio=undefined;this.resizeCallbacks=[];this.resizeStartCallbacks=[];this.resizeEndCallbacks=[];this.hide();this.scrollNode=this.node.parentNode.parentNode.parentNode},handleMouseDown:function(a){this.dragEnable=true;this.offsetScroll={x:this.scrollNode.scrollLeft,y:this.scrollNode.scrollTop};this.offSetPosition={x:Event.pointerX(a)-this.position.x,y:Event.pointerY(a)-this.position.y};this.resizeStartCallbacks.each((function(b){b(this.bounds)}).bind(this))},handleMouseUp:function(a){this.dragEnable=false;this.containmentParentNode=null;this.resizeEndCallbacks.each((function(b){b(this.bounds)}).bind(this))},handleMouseMove:function(c){if(!this.dragEnable){return}if(c.shiftKey||c.ctrlKey){this.aspectRatio=this.bounds.width()/this.bounds.height()}else{this.aspectRatio=undefined}var b={x:Event.pointerX(c)-this.offSetPosition.x,y:Event.pointerY(c)-this.offSetPosition.y};b.x-=this.offsetScroll.x-this.scrollNode.scrollLeft;b.y-=this.offsetScroll.y-this.scrollNode.scrollTop;b.x=Math.min(b.x,this.facade.getCanvas().bounds.width());b.y=Math.min(b.y,this.facade.getCanvas().bounds.height());var d={x:b.x-this.position.x,y:b.y-this.position.y};if(this.aspectRatio){newAspectRatio=(this.bounds.width()+d.x)/(this.bounds.height()+d.y);if(newAspectRatio>this.aspectRatio){d.x=this.aspectRatio*(this.bounds.height()+d.y)-this.bounds.width()}else{if(newAspectRatio<this.aspectRatio){d.y=(this.bounds.width()+d.x)/this.aspectRatio-this.bounds.height()}}}if(this.orientation==="northwest"){if(this.bounds.width()-d.x>this.maxSize.width){d.x=-(this.maxSize.width-this.bounds.width());if(this.aspectRatio){d.y=this.aspectRatio*d.x}}if(this.bounds.width()-d.x<this.minSize.width){d.x=-(this.minSize.width-this.bounds.width());if(this.aspectRatio){d.y=this.aspectRatio*d.x}}if(this.bounds.height()-d.y>this.maxSize.height){d.y=-(this.maxSize.height-this.bounds.height());if(this.aspectRatio){d.x=d.y/this.aspectRatio}}if(this.bounds.height()-d.y<this.minSize.height){d.y=-(this.minSize.height-this.bounds.height());if(this.aspectRatio){d.x=d.y/this.aspectRatio}}}else{if(this.bounds.width()+d.x>this.maxSize.width){d.x=this.maxSize.width-this.bounds.width();if(this.aspectRatio){d.y=this.aspectRatio*d.x}}if(this.bounds.width()+d.x<this.minSize.width){d.x=this.minSize.width-this.bounds.width();if(this.aspectRatio){d.y=this.aspectRatio*d.x}}if(this.bounds.height()+d.y>this.maxSize.height){d.y=this.maxSize.height-this.bounds.height();if(this.aspectRatio){d.x=d.y/this.aspectRatio}}if(this.bounds.height()+d.y<this.minSize.height){d.y=this.minSize.height-this.bounds.height();if(this.aspectRatio){d.x=d.y/this.aspectRatio}}}if(this.orientation==="northwest"){var a={x:this.bounds.lowerRight().x,y:this.bounds.lowerRight().y};this.bounds.extend({x:-d.x,y:-d.y});this.bounds.moveBy(d)}else{this.bounds.extend(d)}this.update();this.resizeCallbacks.each((function(e){e(this.bounds)}).bind(this));Event.stop(c)},registerOnResizeStart:function(a){if(!this.resizeStartCallbacks.member(a)){this.resizeStartCallbacks.push(a)}},unregisterOnResizeStart:function(a){if(this.resizeStartCallbacks.member(a)){this.resizeStartCallbacks=this.resizeStartCallbacks.without(a)}},registerOnResizeEnd:function(a){if(!this.resizeEndCallbacks.member(a)){this.resizeEndCallbacks.push(a)}},unregisterOnResizeEnd:function(a){if(this.resizeEndCallbacks.member(a)){this.resizeEndCallbacks=this.resizeEndCallbacks.without(a)}},registerOnResize:function(a){if(!this.resizeCallbacks.member(a)){this.resizeCallbacks.push(a)}},unregisterOnResize:function(a){if(this.resizeCallbacks.member(a)){this.resizeCallbacks=this.resizeCallbacks.without(a)}},hide:function(){this.node.style.display="none"},show:function(){if(this.bounds){this.node.style.display=""}},setBounds:function(d,b,a,c){this.bounds=d;if(!b){b={width:ORYX.CONFIG.MINIMUM_SIZE,height:ORYX.CONFIG.MINIMUM_SIZE}}if(!a){a={width:ORYX.CONFIG.MAXIMUM_SIZE,height:ORYX.CONFIG.MAXIMUM_SIZE}}this.minSize=b;this.maxSize=a;this.aspectRatio=c;this.update()},update:function(){if(!this.bounds){return}var c=this.bounds.upperLeft();if(this.bounds.width()<this.minSize.width){this.bounds.set(c.x,c.y,c.x+this.minSize.width,c.y+this.bounds.height())}if(this.bounds.height()<this.minSize.height){this.bounds.set(c.x,c.y,c.x+this.bounds.width(),c.y+this.minSize.height)}if(this.bounds.width()>this.maxSize.width){this.bounds.set(c.x,c.y,c.x+this.maxSize.width,c.y+this.bounds.height())}if(this.bounds.height()>this.maxSize.height){this.bounds.set(c.x,c.y,c.x+this.bounds.width(),c.y+this.maxSize.height)}var b=this.canvasNode.getScreenCTM();c.x*=b.a;c.y*=b.d;if(this.orientation==="northwest"){c.x-=13;c.y-=26}else{c.x+=(b.a*this.bounds.width())+3;c.y+=(b.d*this.bounds.height())+3}this.position=c;this.node.style.left=this.position.x+"px";this.node.style.top=this.position.y+"px"}});ORYX.Core.Command.Move=ORYX.Core.Command.extend({construct:function(b,e,c,a,d){this.moveShapes=b;this.selectedShapes=a;this.offset=e;this.plugin=d;this.newParents=b.collect(function(f){return c||f.parent});this.oldParents=b.collect(function(f){return f.parent});this.dockedNodes=b.findAll(function(f){return f instanceof ORYX.Core.Node&&f.dockers.length==1}).collect(function(f){return{docker:f.dockers[0],dockedShape:f.dockers[0].getDockedShape(),refPoint:f.dockers[0].referencePoint}})},execute:function(){this.dockAllShapes();this.move(this.offset);this.addShapeToParent(this.newParents);this.selectCurrentShapes();this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()},rollback:function(){var a={x:-this.offset.x,y:-this.offset.y};this.move(a);this.addShapeToParent(this.oldParents);this.dockAllShapes(true);this.selectCurrentShapes();this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()},move:function(d,a){for(var g=0;g<this.moveShapes.length;g++){var l=this.moveShapes[g];l.bounds.moveBy(d);if(l instanceof ORYX.Core.Node){(l.dockers||[]).each(function(k){k.bounds.moveBy(d)});var e=[].concat(l.getIncomingShapes()).concat(l.getOutgoingShapes()).findAll(function(k){return k instanceof ORYX.Core.Edge&&!this.moveShapes.any(function(m){return m==k||(m instanceof ORYX.Core.Controls.Docker&&m.parent==k)})}.bind(this)).findAll(function(k){return(k.dockers.first().getDockedShape()==l||!this.moveShapes.include(k.dockers.first().getDockedShape()))&&(k.dockers.last().getDockedShape()==l||!this.moveShapes.include(k.dockers.last().getDockedShape()))}.bind(this));this.plugin.layoutEdges(l,e,d);var h=[].concat(l.getIncomingShapes()).concat(l.getOutgoingShapes()).findAll(function(k){return k instanceof ORYX.Core.Edge&&k.dockers.first().isDocked()&&k.dockers.last().isDocked()&&!this.moveShapes.include(k)&&!this.moveShapes.any(function(m){return m==k||(m instanceof ORYX.Core.Controls.Docker&&m.parent==k)})}.bind(this)).findAll(function(k){return this.moveShapes.indexOf(k.dockers.first().getDockedShape())>g||this.moveShapes.indexOf(k.dockers.last().getDockedShape())>g}.bind(this));for(var f=0;f<h.length;f++){for(var b=1;b<h[f].dockers.length-1;b++){var c=h[f].dockers[b];if(!c.getDockedShape()&&!this.moveShapes.include(c)){c.bounds.moveBy(d)}}}}}},dockAllShapes:function(a){for(var b=0;b<this.dockedNodes.length;b++){var c=this.dockedNodes[b].docker;c.setDockedShape(a?this.dockedNodes[b].dockedShape:undefined);if(c.getDockedShape()){c.setReferencePoint(this.dockedNodes[b].refPoint)}}},addShapeToParent:function(e){for(var f=0;f<this.moveShapes.length;f++){var d=this.moveShapes[f];if(d instanceof ORYX.Core.Node&&d.parent!==e[f]){var g=e[f].absoluteXY();var h=d.absoluteXY();var c=h.x-g.x;var k=h.y-g.y;e[f].add(d);d.getOutgoingShapes((function(b){if(b instanceof ORYX.Core.Node&&!this.moveShapes.member(b)){e[f].add(b)}}).bind(this));if(d instanceof ORYX.Core.Node&&d.dockers.length==1){var a=d.bounds;c+=a.width()/2;k+=a.height()/2;d.dockers.first().bounds.centerMoveTo(c,k)}else{d.bounds.moveTo(c,k)}}}},selectCurrentShapes:function(){this.plugin.facade.setSelection(this.selectedShapes)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Grouping=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.Grouping.group,functionality:this.createGroup.bind(this),group:ORYX.I18N.Grouping.grouping,icon:ORYX.PATH+"images/shape_group.png",description:ORYX.I18N.Grouping.groupDesc,index:1,minShape:2,isEnabled:this.isEnabled.bind(this,false)});this.facade.offer({name:ORYX.I18N.Grouping.ungroup,functionality:this.deleteGroup.bind(this),group:ORYX.I18N.Grouping.grouping,icon:ORYX.PATH+"images/shape_ungroup.png",description:ORYX.I18N.Grouping.ungroupDesc,index:2,minShape:2,isEnabled:this.isEnabled.bind(this,true)});this.selectedElements=[];this.groups=[]},isEnabled:function(a){var b=this.selectedElements;return a===this.groups.any(function(c){return c.length===b.length&&c.all(function(d){return b.member(d)})})},onSelectionChanged:function(b){var a=b.elements;this.selectedElements=this.groups.findAll(function(c){return c.any(function(d){return a.member(d)})});this.selectedElements.push(a);this.selectedElements=this.selectedElements.flatten().uniq();if(this.selectedElements.length!==a.length){this.facade.setSelection(this.selectedElements)}},createGroup:function(){var c=this.facade.getSelection();var a=ORYX.Core.Command.extend({construct:function(g,d,f,e){this.selectedElements=g;this.groups=d;this.callback=f;this.facade=e},execute:function(){var d=this.groups.findAll(function(e){return !e.any(function(f){return c.member(f)})});d.push(c);this.callback(d.clone());this.facade.setSelection(this.selectedElements)},rollback:function(){this.callback(this.groups.clone());this.facade.setSelection(this.selectedElements)}});var b=new a(c,this.groups.clone(),this.setGroups.bind(this),this.facade);this.facade.executeCommands([b])},deleteGroup:function(){var c=this.facade.getSelection();var a=ORYX.Core.Command.extend({construct:function(g,d,f,e){this.selectedElements=g;this.groups=d;this.callback=f;this.facade=e},execute:function(){var d=this.groups.partition(function(e){return e.length!==c.length||!e.all(function(f){return c.member(f)})});this.callback(d[0]);this.facade.setSelection(this.selectedElements)},rollback:function(){this.callback(this.groups.clone());this.facade.setSelection(this.selectedElements)}});var b=new a(c,this.groups.clone(),this.setGroups.bind(this),this.facade);this.facade.executeCommands([b])},setGroups:function(a){this.groups=a}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ShapeHighlighting=Clazz.extend({construct:function(a){this.parentNode=a.getCanvas().getSvgContainer();this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parentNode,["g"]);this.highlightNodes={};a.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,this.setHighlight.bind(this));a.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,this.hideHighlight.bind(this))},setHighlight:function(a){if(a&&a.highlightId){var b=this.highlightNodes[a.highlightId];if(!b){b=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["path",{"stroke-width":2,fill:"none"}]);this.highlightNodes[a.highlightId]=b}if(a.elements&&a.elements.length>0){this.setAttributesByStyle(b,a);this.show(b)}else{this.hide(b)}}},hideHighlight:function(a){if(a&&a.highlightId&&this.highlightNodes[a.highlightId]){this.hide(this.highlightNodes[a.highlightId])}},hide:function(a){a.setAttributeNS(null,"display","none")},show:function(a){a.setAttributeNS(null,"display","")},setAttributesByStyle:function(b,a){if(a.style&&a.style==ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE){var d=a.elements[0].absoluteBounds();var c=a.strokewidth?a.strokewidth:ORYX.CONFIG.BORDER_OFFSET;b.setAttributeNS(null,"d",this.getPathRectangle(d.a,d.b,c));b.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);b.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:0.2);b.setAttributeNS(null,"stroke-width",c)}else{if(a.elements.length==1&&a.elements[0] instanceof ORYX.Core.Edge&&a.highlightId!="selection"){b.setAttributeNS(null,"d",this.getPathEdge(a.elements[0].dockers));b.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);b.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:0.2);b.setAttributeNS(null,"stroke-width",ORYX.CONFIG.OFFSET_EDGE_BOUNDS)}else{b.setAttributeNS(null,"d",this.getPathByElements(a.elements));b.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);b.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:1);b.setAttributeNS(null,"stroke-width",a.strokewidth?a.strokewidth:2)}}},getPathByElements:function(a){if(!a||a.length<=0){return undefined}var c=ORYX.CONFIG.SELECTED_AREA_PADDING;var b="";a.each((function(f){if(!f){return}var g=f.absoluteBounds();g.widen(c);var e=g.upperLeft();var d=g.lowerRight();b=b+this.getPath(e,d)}).bind(this));return b},getPath:function(d,c){return this.getPathCorners(d,c)},getPathCorners:function(d,c){var e=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var f="";f=f+"M"+d.x+" "+(d.y+e)+" l0 -"+e+" l"+e+" 0 ";f=f+"M"+d.x+" "+(c.y-e)+" l0 "+e+" l"+e+" 0 ";f=f+"M"+c.x+" "+(c.y-e)+" l0 "+e+" l-"+e+" 0 ";f=f+"M"+c.x+" "+(d.y+e)+" l0 -"+e+" l-"+e+" 0 ";return f},getPathRectangle:function(d,c,h){var e=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var f="";var g=h/2;f=f+"M"+(d.x+g)+" "+(d.y);f=f+" L"+(d.x+g)+" "+(c.y-g);f=f+" L"+(c.x-g)+" "+(c.y-g);f=f+" L"+(c.x-g)+" "+(d.y+g);f=f+" L"+(d.x+g)+" "+(d.y+g);return f},getPathEdge:function(a){var b=a.length;var c="M"+a[0].bounds.center().x+" "+a[0].bounds.center().y;for(i=1;i<b;i++){var d=a[i].bounds.center();c=c+" L"+d.x+" "+d.y}return c}});ORYX.Plugins.HighlightingSelectedShapes=Clazz.extend({construct:function(a){this.facade=a;this.opacityFull=0.9;this.opacityLow=0.4},onSelectionChanged:function(a){if(a.elements&&a.elements.length>1){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"selection",elements:a.elements.without(a.subSelection),color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:!a.subSelection?this.opacityFull:this.opacityLow});if(a.subSelection){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"subselection",elements:[a.subSelection],color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:this.opacityFull})}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"subselection"})}}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"selection"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"subselection"})}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.DragDocker=Clazz.extend({construct:function(a){this.facade=a;this.VALIDCOLOR=ORYX.CONFIG.SELECTION_VALID_COLOR;this.INVALIDCOLOR=ORYX.CONFIG.SELECTION_INVALID_COLOR;this.shapeSelection=undefined;this.docker=undefined;this.dockerParent=undefined;this.dockerSource=undefined;this.dockerTarget=undefined;this.lastUIObj=undefined;this.isStartDocker=undefined;this.isEndDocker=undefined;this.undockTreshold=10;this.initialDockerPosition=undefined;this.outerDockerNotMoved=undefined;this.isValid=false;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DOCKERDRAG,this.handleDockerDrag.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOVER,this.handleMouseOver.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOUT,this.handleMouseOut.bind(this))},handleMouseOut:function(b,a){if(!this.docker&&a instanceof ORYX.Core.Controls.Docker){a.hide()}else{if(!this.docker&&a instanceof ORYX.Core.Edge){a.dockers.each(function(c){c.hide()})}}},handleMouseOver:function(b,a){if(!this.docker&&a instanceof ORYX.Core.Controls.Docker){a.show()}else{if(!this.docker&&a instanceof ORYX.Core.Edge){a.dockers.each(function(c){c.show()})}}},handleDockerDrag:function(b,a){this.handleMouseDown(b.uiEvent,a)},handleMouseDown:function(d,c){if(c instanceof ORYX.Core.Controls.Docker&&c.isMovable){this.shapeSelection=this.facade.getSelection();this.facade.setSelection();this.docker=c;this.initialDockerPosition=this.docker.bounds.center();this.outerDockerNotMoved=false;this.dockerParent=c.parent;this._commandArg={docker:c,dockedShape:c.getDockedShape(),refPoint:c.referencePoint||c.bounds.center()};this.docker.show();if(c.parent instanceof ORYX.Core.Edge&&(c.parent.dockers.first()==c||c.parent.dockers.last()==c)){if(c.parent.dockers.first()==c&&c.parent.dockers.last().getDockedShape()){this.dockerTarget=c.parent.dockers.last().getDockedShape()}else{if(c.parent.dockers.last()==c&&c.parent.dockers.first().getDockedShape()){this.dockerSource=c.parent.dockers.first().getDockedShape()}}}else{this.dockerSource=undefined;this.dockerTarget=undefined}this.isStartDocker=this.docker.parent.dockers.first()===this.docker;this.isEndDocker=this.docker.parent.dockers.last()===this.docker;this.facade.getCanvas().add(this.docker.parent);this.docker.parent.getLabels().each(function(e){e.hide()});if((!this.isStartDocker&&!this.isEndDocker)||!this.docker.isDocked()){this.docker.setDockedShape(undefined);var b=this.facade.eventCoordinates(d);this.docker.bounds.centerMoveTo(b);this.dockerParent._update()}else{this.outerDockerNotMoved=true}var a={movedCallback:this.dockerMoved.bind(this),upCallback:this.dockerMovedFinished.bind(this)};ORYX.Core.UIEnableDrag(d,c,a)}},dockerMoved:function(u){this.outerDockerNotMoved=false;var l=undefined;if(this.docker.parent){if(this.isStartDocker||this.isEndDocker){var o=this.facade.eventCoordinates(u);if(this.docker.isDocked()){var b=ORYX.Core.Math.getDistancePointToPoint(o,this.initialDockerPosition);if(b<this.undockTreshold){this.outerDockerNotMoved=true;return}this.docker.setDockedShape(undefined);this.dockerParent._update()}var s=this.facade.getCanvas().getAbstractShapesAtPosition(o);var q=s.pop();if(this.docker.parent===q){q=s.pop()}if(this.lastUIObj==q){}else{if(q instanceof ORYX.Core.Shape){var t=this.docker.parent.getStencil().stencilSet();if(this.docker.parent instanceof ORYX.Core.Edge){var v=this.getHighestParentBeforeCanvas(q);if(v instanceof ORYX.Core.Edge&&this.docker.parent===v){this.isValid=false;this.dockerParent._update();return}this.isValid=false;var a=q,c=q;while(!this.isValid&&a&&!(a instanceof ORYX.Core.Canvas)){q=a;this.isValid=this.facade.getRules().canConnect({sourceShape:this.dockerSource?this.dockerSource:(this.isStartDocker?q:undefined),edgeShape:this.docker.parent,targetShape:this.dockerTarget?this.dockerTarget:(this.isEndDocker?q:undefined)});a=a.parent}if(!this.isValid){q=c}}else{this.isValid=this.facade.getRules().canConnect({sourceShape:q,edgeShape:this.docker.parent,targetShape:this.docker.parent})}if(this.lastUIObj){this.hideMagnets(this.lastUIObj)}if(this.isValid){this.showMagnets(q)}this.showHighlight(q,this.isValid?this.VALIDCOLOR:this.INVALIDCOLOR);this.lastUIObj=q}else{this.hideHighlight();this.lastUIObj?this.hideMagnets(this.lastUIObj):null;this.lastUIObj=undefined;this.isValid=false}}if(this.lastUIObj&&this.isValid&&!(u.shiftKey||u.ctrlKey)){l=this.lastUIObj.magnets.find(function(y){return y.absoluteBounds().isIncluded(o)});if(l){this.docker.bounds.centerMoveTo(l.absoluteCenterXY())}}}}if(!(u.shiftKey||u.ctrlKey)&&!l){var n=ORYX.CONFIG.DOCKER_SNAP_OFFSET;var h=n+1;var f=n+1;var x=this.docker.bounds.center();if(this.docker.parent){this.docker.parent.dockers.each((function(z){if(this.docker==z){return}var y=z.referencePoint?z.getAbsoluteReferencePoint():z.bounds.center();h=Math.abs(h)>Math.abs(y.x-x.x)?y.x-x.x:h;f=Math.abs(f)>Math.abs(y.y-x.y)?y.y-x.y:f}).bind(this));if(Math.abs(h)<n||Math.abs(f)<n){h=Math.abs(h)<n?h:0;f=Math.abs(f)<n?f:0;this.docker.bounds.centerMoveTo(x.x+h,x.y+f)}else{var d=this.docker.parent.dockers[Math.max(this.docker.parent.dockers.indexOf(this.docker)-1,0)];var r=this.docker.parent.dockers[Math.min(this.docker.parent.dockers.indexOf(this.docker)+1,this.docker.parent.dockers.length-1)];if(d&&r&&d!==this.docker&&r!==this.docker){var e=d.bounds.center();var g=r.bounds.center();var p=this.docker.bounds.center();if(ORYX.Core.Math.isPointInLine(p.x,p.y,e.x,e.y,g.x,g.y,10)){var w=(Number(g.y)-Number(e.y))/(Number(g.x)-Number(e.x));var m=((e.y-(e.x*w))-(p.y-(p.x*(-Math.pow(w,-1)))))/((-Math.pow(w,-1))-w);var k=(e.y-(e.x*w))+(w*m);if(isNaN(m)||isNaN(k)){return}this.docker.bounds.centerMoveTo(m,k)}}}}}this.dockerParent._update()},dockerMovedFinished:function(e){this.facade.setSelection(this.shapeSelection);this.hideHighlight();this.dockerParent.getLabels().each(function(g){g.show()});if(this.lastUIObj&&(this.isStartDocker||this.isEndDocker)){if(this.isValid){this.docker.setDockedShape(this.lastUIObj);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED,docker:this.docker,parent:this.docker.parent,target:this.lastUIObj})}this.hideMagnets(this.lastUIObj)}this.docker.hide();if(this.outerDockerNotMoved){var d=this.facade.eventCoordinates(e);var a=this.facade.getCanvas().getAbstractShapesAtPosition(d);var b=a.findAll(function(g){return g instanceof ORYX.Core.Node});a=b.length?b:a;this.facade.setSelection(a)}else{var c=ORYX.Core.Command.extend({construct:function(n,h,g,m,l,k){this.docker=n;this.index=n.parent.dockers.indexOf(n);this.newPosition=h;this.newDockedShape=m;this.oldPosition=g;this.oldDockedShape=l;this.facade=k;this.index=n.parent.dockers.indexOf(n);this.shape=n.parent},execute:function(){if(!this.docker.parent){this.docker=this.shape.dockers[this.index]}this.dock(this.newDockedShape,this.newPosition);this.removedDockers=this.shape.removeUnusedDockers();this.facade.updateSelection()},rollback:function(){this.dock(this.oldDockedShape,this.oldPosition);(this.removedDockers||$H({})).each(function(g){this.shape.add(g.value,Number(g.key));this.shape._update(true)}.bind(this));this.facade.updateSelection()},dock:function(g,h){this.docker.setDockedShape(undefined);if(g){this.docker.setDockedShape(g);this.docker.setReferencePoint(h)}else{this.docker.bounds.centerMoveTo(h)}this.facade.getCanvas().update()}});if(this.docker.parent){var f=new c(this.docker,this.docker.getDockedShape()?this.docker.referencePoint:this.docker.bounds.center(),this._commandArg.refPoint,this.docker.getDockedShape(),this._commandArg.dockedShape,this.facade);this.facade.executeCommands([f])}}this.docker=undefined;this.dockerParent=undefined;this.dockerSource=undefined;this.dockerTarget=undefined;this.lastUIObj=undefined},hideHighlight:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"validDockedShape"})},showHighlight:function(b,a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"validDockedShape",elements:[b],color:a})},showMagnets:function(a){a.magnets.each(function(b){b.show()})},hideMagnets:function(a){a.magnets.each(function(b){b.hide()})},getHighestParentBeforeCanvas:function(a){if(!(a instanceof ORYX.Core.Shape)){return undefined}var b=a.parent;while(b&&!(b.parent instanceof ORYX.Core.Canvas)){b=b.parent}return b}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.AddDocker=Clazz.extend({construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.AddDocker.add,functionality:this.enableAddDocker.bind(this),group:ORYX.I18N.AddDocker.group,icon:ORYX.PATH+"images/vector_add.png",description:ORYX.I18N.AddDocker.addDesc,index:1,toggle:true,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.AddDocker.del,functionality:this.enableDeleteDocker.bind(this),group:ORYX.I18N.AddDocker.group,icon:ORYX.PATH+"images/vector_delete.png",description:ORYX.I18N.AddDocker.delDesc,index:2,toggle:true,minShape:0,maxShape:0});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this))},enableAddDocker:function(a,b){this.addDockerButton=a;if(b&&this.deleteDockerButton){this.deleteDockerButton.toggle(false)}},enableDeleteDocker:function(a,b){this.deleteDockerButton=a;if(b&&this.addDockerButton){this.addDockerButton.toggle(false)}},enabledAdd:function(){return this.addDockerButton?this.addDockerButton.pressed:false},enabledDelete:function(){return this.deleteDockerButton?this.deleteDockerButton.pressed:false},handleMouseDown:function(b,a){if(this.enabledAdd()&&a instanceof ORYX.Core.Edge){this.newDockerCommand({edge:a,position:this.facade.eventCoordinates(b)})}else{if(this.enabledDelete()&&a instanceof ORYX.Core.Controls.Docker&&a.parent instanceof ORYX.Core.Edge){this.newDockerCommand({edge:a.parent,docker:a})}else{if(this.enabledAdd()){this.addDockerButton.toggle(false)}else{if(this.enabledDelete()){this.deleteDockerButton.toggle(false)}}}}},newDockerCommand:function(b){if(!b.edge){return}var a=ORYX.Core.Command.extend({construct:function(h,f,e,g,k,d){this.addEnabled=h;this.deleteEnabled=f;this.edge=e;this.docker=g;this.pos=k;this.facade=d},execute:function(){if(this.addEnabled){this.docker=this.edge.addDocker(this.pos,this.docker);this.index=this.edge.dockers.indexOf(this.docker)}else{if(this.deleteEnabled){this.index=this.edge.dockers.indexOf(this.docker);this.pos=this.docker.bounds.center();this.edge.removeDocker(this.docker)}}this.facade.getCanvas().update();this.facade.updateSelection()},rollback:function(){if(this.addEnabled){if(this.docker instanceof ORYX.Core.Controls.Docker){this.edge.removeDocker(this.docker)}}else{if(this.deleteEnabled){this.edge.add(this.docker,this.index)}}this.facade.getCanvas().update();this.facade.updateSelection()}});var c=new a(this.enabledAdd(),this.enabledDelete(),b.edge,b.docker,b.position,this.facade);this.facade.executeCommands([c])}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.SSExtensionLoader={construct:function(a){this.facade=a;if(!(ORYX.CONFIG.IS_TEMPLATE)){this.facade.offer({name:ORYX.I18N.SSExtensionLoader.add,functionality:this.addSSExtension.bind(this),group:ORYX.I18N.SSExtensionLoader.group,icon:ORYX.PATH+"images/add.png",description:ORYX.I18N.SSExtensionLoader.addDesc,index:1,minShape:0,maxShape:0})}},addSSExtension:function(facade){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.SSExtensionLoader.loading});var url=ORYX.CONFIG.SS_EXTENSIONS_CONFIG;new Ajax.Request(url,{method:"GET",asynchronous:false,onSuccess:(function(transport){try{eval("var jsonObject = "+transport.responseText);var stencilsets=this.facade.getStencilSets();var validExtensions=jsonObject.extensions.findAll(function(extension){var stencilset=stencilsets[extension["extends"]];if(stencilset){return true}else{return false}});var loadedExtensions=validExtensions.findAll(function(extension){return stencilsets.values().any(function(ss){if(ss.extensions()[extension.namespace]){return true}else{return false}})});if(validExtensions.size()==0){Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.SSExtensionLoader.noExt)}else{this._showPanel(validExtensions,loadedExtensions,this._loadExtensions.bind(this))}}catch(e){console.log(e);Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.SSExtensionLoader.failed1)}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}).bind(this),onFailure:(function(transport){Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.SSExtensionLoader.failed2);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}).bind(this)})},_loadExtensions:function(b){var c=this.facade.getStencilSets();var d=false;c.values().each(function(e){var f=e.extensions().values().select(function(g){return b[g.namespace]==undefined});f.each(function(g){e.removeExtension(g.namespace);d=true})});b.each(function(f){var e=c[f["extends"]];if(e){e.addExtension(ORYX.CONFIG.SS_EXTENSIONS_FOLDER+f.definition);d=true}}.bind(this));if(d){c.values().each(function(e){this.facade.getRules().initializeRules(e)}.bind(this));this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,lazyLoaded:true});var a=this.facade.getSelection();this.facade.setSelection();this.facade.setSelection(a)}},_showPanel:function(h,k,c){var e=[];h.each(function(l){e.push([l.title,l.definition,l["extends"]])});var d=new Ext.grid.CheckboxSelectionModel();var a=new Ext.grid.GridPanel({deferRowRender:false,id:"oryx_new_stencilset_extention_grid",store:new Ext.data.SimpleStore({fields:["title","definition","extends"]}),cm:new Ext.grid.ColumnModel([d,{header:ORYX.I18N.SSExtensionLoader.panelTitle,width:200,sortable:true,dataIndex:"title"}]),sm:d,frame:true,width:200,height:200,iconCls:"icon-grid",listeners:{render:function(){this.getStore().loadData(e);g.defer(1)}}});function g(){var l=new Array();a.store.each(function(m){if(k.any(function(n){return n.definition==m.get("definition")})){l.push(m)}});d.selectRecords(l)}var b=new Ext.Panel({items:[{xtype:"label",text:ORYX.I18N.SSExtensionLoader.panelText,style:"margin:10px;display:block"},a],frame:true,buttons:[{text:ORYX.I18N.SSExtensionLoader.labelImport,handler:function(){var m=Ext.getCmp("oryx_new_stencilset_extention_grid").getSelectionModel();var l=m.selections.items.collect(function(n){return n.data});Ext.getCmp("oryx_new_stencilset_extention_window").close();c(l)}.bind(this)},{text:ORYX.I18N.SSExtensionLoader.labelCancel,handler:function(){Ext.getCmp("oryx_new_stencilset_extention_window").close()}.bind(this)}]});var f=new Ext.Window({id:"oryx_new_stencilset_extention_window",width:227,title:ORYX.I18N.Oryx.title,floating:true,shim:true,modal:true,resizable:false,autoHeight:true,items:[b]});f.show()}};ORYX.Plugins.SSExtensionLoader=Clazz.extend(ORYX.Plugins.SSExtensionLoader);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.SelectionFrame=Clazz.extend({construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEUP,this.handleMouseUp.bind(this),true);this.position={x:0,y:0};this.size={width:0,height:0};this.offsetPosition={x:0,y:0};this.moveCallback=undefined;this.offsetScroll={x:0,y:0};this.node=ORYX.Editor.graft("http://www.w3.org/1999/xhtml",this.facade.getCanvas().getHTMLContainer(),["div",{"class":"Oryx_SelectionFrame"}]);this.hide()},handleMouseDown:function(d,c){if(c instanceof ORYX.Core.Canvas){var e=c.rootNode.parentNode.parentNode;var b=this.facade.getCanvas().node.getScreenCTM();this.offsetPosition={x:b.e,y:b.f};this.setPos({x:Event.pointerX(d)-this.offsetPosition.x,y:Event.pointerY(d)-this.offsetPosition.y});this.resize({width:0,height:0});this.moveCallback=this.handleMouseMove.bind(this);document.documentElement.addEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.moveCallback,false);this.offsetScroll={x:e.scrollLeft,y:e.scrollTop};this.show()}Event.stop(d)},handleMouseUp:function(f){if(this.moveCallback){this.hide();document.documentElement.removeEventListener(ORYX.CONFIG.EVENT_MOUSEMOVE,this.moveCallback,false);this.moveCallback=undefined;var e=this.facade.getCanvas().node.getScreenCTM();var d={x:this.size.width>0?this.position.x:this.position.x+this.size.width,y:this.size.height>0?this.position.y:this.position.y+this.size.height};var c={x:d.x+Math.abs(this.size.width),y:d.y+Math.abs(this.size.height)};d.x/=e.a;d.y/=e.d;c.x/=e.a;c.y/=e.d;var g=this.facade.getCanvas().getChildShapes(true).findAll(function(b){var a=b.absoluteBounds();var k=a.upperLeft();var h=a.lowerRight();if(k.x>d.x&&k.y>d.y&&h.x<c.x&&h.y<c.y){return true}return false});this.facade.setSelection(g)}},handleMouseMove:function(b){var a={width:Event.pointerX(b)-this.position.x-this.offsetPosition.x,height:Event.pointerY(b)-this.position.y-this.offsetPosition.y,};var c=this.facade.getCanvas().rootNode.parentNode.parentNode;a.width-=this.offsetScroll.x-c.scrollLeft;a.height-=this.offsetScroll.y-c.scrollTop;this.resize(a);Event.stop(b)},hide:function(){this.node.style.display="none"},show:function(){this.node.style.display=""},setPos:function(a){this.node.style.top=a.y+"px";this.node.style.left=a.x+"px";this.position=a},resize:function(a){this.setPos(this.position);this.size=Object.clone(a);if(a.width<0){this.node.style.left=(this.position.x+a.width)+"px";a.width=-a.width}if(a.height<0){this.node.style.top=(this.position.y+a.height)+"px";a.height=-a.height}this.node.style.width=a.width+"px";this.node.style.height=a.height+"px"}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ShapeHighlighting=Clazz.extend({construct:function(a){this.parentNode=a.getCanvas().getSvgContainer();this.node=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.parentNode,["g"]);this.highlightNodes={};a.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,this.setHighlight.bind(this));a.registerOnEvent(ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,this.hideHighlight.bind(this))},setHighlight:function(a){if(a&&a.highlightId){var b=this.highlightNodes[a.highlightId];if(!b){b=ORYX.Editor.graft("http://www.w3.org/2000/svg",this.node,["path",{"stroke-width":2,fill:"none"}]);this.highlightNodes[a.highlightId]=b}if(a.elements&&a.elements.length>0){this.setAttributesByStyle(b,a);this.show(b)}else{this.hide(b)}}},hideHighlight:function(a){if(a&&a.highlightId&&this.highlightNodes[a.highlightId]){this.hide(this.highlightNodes[a.highlightId])}},hide:function(a){a.setAttributeNS(null,"display","none")},show:function(a){a.setAttributeNS(null,"display","")},setAttributesByStyle:function(b,a){if(a.style&&a.style==ORYX.CONFIG.SELECTION_HIGHLIGHT_STYLE_RECTANGLE){var d=a.elements[0].absoluteBounds();var c=a.strokewidth?a.strokewidth:ORYX.CONFIG.BORDER_OFFSET;b.setAttributeNS(null,"d",this.getPathRectangle(d.a,d.b,c));b.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);b.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:0.2);b.setAttributeNS(null,"stroke-width",c)}else{if(a.elements.length==1&&a.elements[0] instanceof ORYX.Core.Edge&&a.highlightId!="selection"){b.setAttributeNS(null,"d",this.getPathEdge(a.elements[0].dockers));b.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);b.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:0.2);b.setAttributeNS(null,"stroke-width",ORYX.CONFIG.OFFSET_EDGE_BOUNDS)}else{b.setAttributeNS(null,"d",this.getPathByElements(a.elements));b.setAttributeNS(null,"stroke",a.color?a.color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR);b.setAttributeNS(null,"stroke-opacity",a.opacity?a.opacity:1);b.setAttributeNS(null,"stroke-width",a.strokewidth?a.strokewidth:2)}}},getPathByElements:function(a){if(!a||a.length<=0){return undefined}var c=ORYX.CONFIG.SELECTED_AREA_PADDING;var b="";a.each((function(f){if(!f){return}var g=f.absoluteBounds();g.widen(c);var e=g.upperLeft();var d=g.lowerRight();b=b+this.getPath(e,d)}).bind(this));return b},getPath:function(d,c){return this.getPathCorners(d,c)},getPathCorners:function(d,c){var e=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var f="";f=f+"M"+d.x+" "+(d.y+e)+" l0 -"+e+" l"+e+" 0 ";f=f+"M"+d.x+" "+(c.y-e)+" l0 "+e+" l"+e+" 0 ";f=f+"M"+c.x+" "+(c.y-e)+" l0 "+e+" l-"+e+" 0 ";f=f+"M"+c.x+" "+(d.y+e)+" l0 -"+e+" l-"+e+" 0 ";return f},getPathRectangle:function(d,c,h){var e=ORYX.CONFIG.SELECTION_HIGHLIGHT_SIZE;var f="";var g=h/2;f=f+"M"+(d.x+g)+" "+(d.y);f=f+" L"+(d.x+g)+" "+(c.y-g);f=f+" L"+(c.x-g)+" "+(c.y-g);f=f+" L"+(c.x-g)+" "+(d.y+g);f=f+" L"+(d.x+g)+" "+(d.y+g);return f},getPathEdge:function(a){var b=a.length;var c="M"+a[0].bounds.center().x+" "+a[0].bounds.center().y;for(i=1;i<b;i++){var d=a[i].bounds.center();c=c+" L"+d.x+" "+d.y}return c}});ORYX.Plugins.HighlightingSelectedShapes=Clazz.extend({construct:function(a){this.facade=a;this.opacityFull=0.9;this.opacityLow=0.4},onSelectionChanged:function(a){if(a.elements&&a.elements.length>1){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"selection",elements:a.elements.without(a.subSelection),color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:!a.subSelection?this.opacityFull:this.opacityLow});if(a.subSelection){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:"subselection",elements:[a.subSelection],color:ORYX.CONFIG.SELECTION_HIGHLIGHT_COLOR,opacity:this.opacityFull})}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"subselection"})}}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"selection"});this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:"subselection"})}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Overlay=Clazz.extend({facade:undefined,styleNode:undefined,construct:function(a){this.facade=a;this.changes=[];this.facade.registerOnEvent(ORYX.CONFIG.EVENT_OVERLAY_SHOW,this.show.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_OVERLAY_HIDE,this.hide.bind(this));this.styleNode=document.createElement("style");this.styleNode.setAttributeNS(null,"type","text/css");document.getElementsByTagName("head")[0].appendChild(this.styleNode)},show:function(a){if(!a||!a.shapes||!a.shapes instanceof Array||!a.id||!a.id instanceof String||a.id.length==0){return}if(a.attributes){a.shapes.each(function(d){if(!d instanceof ORYX.Core.Shape){return}this.setAttributes(d.node,a.attributes)}.bind(this))}var c=true;try{c=a.node&&a.node instanceof SVGElement}catch(b){}if(a.node&&c){a._temps=[];a.shapes.each(function(h,g){if(!h instanceof ORYX.Core.Shape){return}var f={};f.svg=a.dontCloneNode?a.node:a.node.cloneNode(true);h.node.firstChild.appendChild(f.svg);if(h instanceof ORYX.Core.Edge&&!a.nodePosition){a.nodePosition="START"}if(a.nodePosition){var e=h.bounds;var k=a.nodePosition.toUpperCase();if(h instanceof ORYX.Core.Node&&k=="START"){k="NW"}else{if(h instanceof ORYX.Core.Node&&k=="END"){k="SE"}else{if(h instanceof ORYX.Core.Edge&&k=="START"){e=h.getDockers().first().bounds}else{if(h instanceof ORYX.Core.Edge&&k=="END"){e=h.getDockers().last().bounds}}}}f.callback=function(){var l=0;var m=0;if(k=="NW"){}else{if(k=="N"){l=e.width()/2}else{if(k=="NE"){l=e.width()}else{if(k=="E"){l=e.width();m=e.height()/2}else{if(k=="SE"){l=e.width();m=e.height()}else{if(k=="S"){l=e.width()/2;m=e.height()}else{if(k=="SW"){m=e.height()}else{if(k=="W"){m=e.height()/2}else{if(k=="START"||k=="END"){l=e.width()/2;m=e.height()/2}else{return}}}}}}}}}if(h instanceof ORYX.Core.Edge){l+=e.upperLeft().x;m+=e.upperLeft().y}f.svg.setAttributeNS(null,"transform","translate("+l+", "+m+")")}.bind(this);f.element=h;f.callback();e.registerCallback(f.callback)}if(a.ghostPoint){var d={x:0,y:0};d=a.ghostPoint;f.callback=function(){var l=0;var m=0;l=d.x-7;m=d.y-7;f.svg.setAttributeNS(null,"transform","translate("+l+", "+m+")")}.bind(this);f.element=h;f.callback();e.registerCallback(f.callback)}if(a.labelPoint){var d={x:0,y:0};d=a.labelPoint;f.callback=function(){var l=0;var m=0;l=d.x;m=d.y;f.svg.setAttributeNS(null,"transform","translate("+l+", "+m+")")}.bind(this);f.element=h;f.callback();e.registerCallback(f.callback)}a._temps.push(f)}.bind(this))}if(!this.changes[a.id]){this.changes[a.id]=[]}this.changes[a.id].push(a)},hide:function(a){if(!a||!a.id||!a.id instanceof String||a.id.length==0||!this.changes[a.id]){return}this.changes[a.id].each(function(b){b.shapes.each(function(d,c){if(!d instanceof ORYX.Core.Shape){return}this.deleteAttributes(d.node)}.bind(this));if(b._temps){b._temps.each(function(c){if(c.svg&&c.svg.parentNode){c.svg.parentNode.removeChild(c.svg)}if(c.callback&&c.element){c.element.bounds.unregisterCallback(c.callback)}}.bind(this))}}.bind(this));this.changes[a.id]=null},setAttributes:function(c,d){var h=this.getAllChilds(c.firstChild.firstChild);var a=[];h.each(function(m){a.push($A(m.attributes).findAll(function(n){return n.nodeValue.startsWith("url(#")}))});a=a.flatten().compact();a=a.collect(function(m){return m.nodeValue}).uniq();a=a.collect(function(m){return m.slice(5,m.length-1)});a.unshift(c.id+" .me");var g=$H(d);var e=g.toJSON().gsub(",",";").gsub('"',"");var k=d.stroke?e.slice(0,e.length-1)+"; fill:"+d.stroke+";}":e;var f;if(d.fill){var b=Object.clone(d);b.fill="black";f=$H(b).toJSON().gsub(",",";").gsub('"',"")}csstags=a.collect(function(n,m){return"#"+n+" * "+(!m?e:k)+""+(f?" #"+n+" text * "+f:"")});var l=csstags.join(" ")+"\n";this.styleNode.appendChild(document.createTextNode(l))},deleteAttributes:function(b){var a=$A(this.styleNode.childNodes).findAll(function(c){return c.textContent.include("#"+b.id)});a.each(function(c){c.parentNode.removeChild(c)})},getAllChilds:function(a){var b=$A(a.childNodes);$A(a.childNodes).each(function(c){b.push(this.getAllChilds(c))}.bind(this));return b.flatten()}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Edit=Clazz.extend({construct:function(a){this.facade=a;this.clipboard=new ORYX.Plugins.Edit.ClipBoard(a);this.facade.offer({name:ORYX.I18N.Edit.cut,description:ORYX.I18N.Edit.cutDesc,icon:ORYX.PATH+"images/cut.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:88,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editCut),group:ORYX.I18N.Edit.group,index:1,minShape:1});this.facade.offer({name:ORYX.I18N.Edit.copy,description:ORYX.I18N.Edit.copyDesc,icon:ORYX.PATH+"images/page_copy.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:67,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editCopy,[true,false]),group:ORYX.I18N.Edit.group,index:2,minShape:1});this.facade.offer({name:ORYX.I18N.Edit.paste,description:ORYX.I18N.Edit.pasteDesc,icon:ORYX.PATH+"images/page_paste.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:86,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editPaste),isEnabled:this.clipboard.isOccupied.bind(this.clipboard),group:ORYX.I18N.Edit.group,index:3,minShape:0,maxShape:0});if(!(ORYX.CONFIG.IS_TEMPLATE)){this.facade.offer({name:ORYX.I18N.Edit.del,description:ORYX.I18N.Edit.delDesc,icon:ORYX.PATH+"images/cross.png",keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:8,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN},{keyCode:46,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.callEdit.bind(this,this.editDelete),group:ORYX.I18N.Edit.group,index:4,minShape:1})}},callEdit:function(b,a){window.setTimeout(function(){b.apply(this,(a instanceof Array?a:[]))}.bind(this),1)},handleMouseDown:function(a){if(this._controlPressed){this._controlPressed=false;this.editCopy();this.editPaste();a.forceExecution=true;this.facade.raiseEvent(a,this.clipboard.shapesAsJson())}},getAllShapesToConsider:function(b){var a=[];var c=[];b.each(function(e){isChildShapeOfAnother=b.any(function(g){return g.hasChildShape(e)});if(isChildShapeOfAnother){return}a.push(e);if(e instanceof ORYX.Core.Node){var f=e.getOutgoingNodes();f=f.findAll(function(g){return !b.include(g)});a=a.concat(f)}c=c.concat(e.getChildShapes(true))}.bind(this));var d=this.facade.getCanvas().getChildEdges().select(function(e){if(a.include(e)){return false}if(e.getAllDockedShapes().size()===0){return false}return e.getAllDockedShapes().all(function(f){return f instanceof ORYX.Core.Edge||c.include(f)})});a=a.concat(d);return a},editCut:function(){try{this.editCopy(false,true);this.editDelete(true)}catch(a){ORYX.Log.error(a)}return false},editCopy:function(c,a){var b=this.facade.getSelection();if(b.length==0){return}this.clipboard.refresh(b,this.getAllShapesToConsider(b),this.facade.getCanvas().getStencil().stencilSet().namespace(),a);if(c){this.facade.updateSelection()}},editPaste:function(){var b={childShapes:this.clipboard.shapesAsJson(),stencilset:{namespace:this.clipboard.SSnamespace}};Ext.apply(b,ORYX.Core.AbstractShape.JSONHelper);var a=b.getChildShapes(true).pluck("resourceId");var c={};b.eachChild(function(d,e){d.outgoing=d.outgoing.select(function(f){return a.include(f.resourceId)});d.outgoing.each(function(f){if(!c[f.resourceId]){c[f.resourceId]=[]}c[f.resourceId].push(d)});return d}.bind(this),true,true);b.eachChild(function(d,e){if(d.target&&!(a.include(d.target.resourceId))){d.target=undefined;d.targetRemoved=true}if(d.dockers&&d.dockers.length>=1&&d.dockers[0].getDocker&&((d.dockers[0].getDocker().getDockedShape()&&!a.include(d.dockers[0].getDocker().getDockedShape().resourceId))||!d.getShape().dockers[0].getDockedShape()&&!c[d.resourceId])){d.sourceRemoved=true}return d}.bind(this),true,true);b.eachChild(function(d,e){if(this.clipboard.useOffset){d.bounds={lowerRight:{x:d.bounds.lowerRight.x+ORYX.CONFIG.COPY_MOVE_OFFSET,y:d.bounds.lowerRight.y+ORYX.CONFIG.COPY_MOVE_OFFSET},upperLeft:{x:d.bounds.upperLeft.x+ORYX.CONFIG.COPY_MOVE_OFFSET,y:d.bounds.upperLeft.y+ORYX.CONFIG.COPY_MOVE_OFFSET}}}if(d.dockers){d.dockers=d.dockers.map(function(g,f){if((d.targetRemoved===true&&f==d.dockers.length-1&&g.getDocker)||(d.sourceRemoved===true&&f==0&&g.getDocker)){g=g.getDocker().bounds.center()}if((f==0&&g.getDocker instanceof Function&&d.sourceRemoved!==true&&(g.getDocker().getDockedShape()||((c[d.resourceId]||[]).length>0&&(!(d.getShape() instanceof ORYX.Core.Node)||c[d.resourceId][0].getShape() instanceof ORYX.Core.Node))))||(f==d.dockers.length-1&&g.getDocker instanceof Function&&d.targetRemoved!==true&&(g.getDocker().getDockedShape()||d.target))){return{x:g.x,y:g.y,getDocker:g.getDocker}}else{if(this.clipboard.useOffset){return{x:g.x+ORYX.CONFIG.COPY_MOVE_OFFSET,y:g.y+ORYX.CONFIG.COPY_MOVE_OFFSET,getDocker:g.getDocker}}else{return{x:g.x,y:g.y,getDocker:g.getDocker}}}}.bind(this))}else{if(d.getShape() instanceof ORYX.Core.Node&&d.dockers&&d.dockers.length>0&&(!d.dockers.first().getDocker||d.sourceRemoved===true||!(d.dockers.first().getDocker().getDockedShape()||c[d.resourceId]))){d.dockers=d.dockers.map(function(g,f){if((d.sourceRemoved===true&&f==0&&g.getDocker)){g=g.getDocker().bounds.center()}if(this.clipboard.useOffset){return{x:g.x+ORYX.CONFIG.COPY_MOVE_OFFSET,y:g.y+ORYX.CONFIG.COPY_MOVE_OFFSET,getDocker:g.getDocker}}else{return{x:g.x,y:g.y,getDocker:g.getDocker}}}.bind(this))}}return d}.bind(this),false,true);this.clipboard.useOffset=true;this.facade.importJSON(b)},editDelete:function(){var b=this.facade.getSelection();var a=this.getAllShapesToConsider(b);var c=new ORYX.Plugins.Edit.DeleteCommand(a,this.facade);this.facade.executeCommands([c])}});ORYX.Plugins.Edit.ClipBoard=Clazz.extend({construct:function(){this._shapesAsJson=[];this.selection=[];this.SSnamespace="";this.useOffset=true},isOccupied:function(){return this.shapesAsJson().length>0},refresh:function(d,b,c,a){this.selection=d;this.SSnamespace=c;this.outgoings={};this.parents={};this.targets={};this.useOffset=a!==true;this._shapesAsJson=b.map(function(e){var f=e.toJSON();f.parent={resourceId:e.getParentShape().resourceId};f.parentIndex=e.getParentShape().getChildShapes().indexOf(e);return f})},shapesAsJson:function(){return this._shapesAsJson}});ORYX.Plugins.Edit.DeleteCommand=ORYX.Core.Command.extend({construct:function(a,b){try{this.shapesAsJson=a;this.facade=b;ORYX.Log.info("this.shapesAsJson",this.shapesAsJson);this.dockers=this.shapesAsJson.map(function(f){var g=f.getIncomingShapes().map(function(h){return h.getDockers().last()});var e=f.getOutgoingShapes().map(function(h){return h.getDockers().first()});var d=f.getDockers().concat(g,e).compact().map(function(h){return{object:h,referencePoint:h.referencePoint,dockedShape:h.getDockedShape()}});return d}).flatten()}catch(c){ORYX.Log.error(c)}},execute:function(){this.shapesAsJson.each(function(a){this.facade.deleteShape(a)}.bind(this));this.facade.setSelection([]);this.facade.getCanvas().update();this.facade.updateSelection()},rollback:function(){this.shapesAsJson.each(function(a){var b=("undefined"!=typeof(a.parent)?this.facade.getCanvas().getChildShapeByResourceId(a.parent.resourceId):this.facade.getCanvas());b.add(a,a.parentIndex);b.add(a,a.parentIndex)}.bind(this));this.dockers.each(function(a){a.object.setDockedShape(a.dockedShape);a.object.setReferencePoint(a.referencePoint)}.bind(this));this.facade.setSelection(this.selectedShapes);this.facade.getCanvas().update();this.facade.updateSelection()}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.KeysMove=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.copyElements=[];this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:65,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.selectAll.bind(this)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_LEFT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_LEFT,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_LEFT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_LEFT,true)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_RIGHT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_RIGHT,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_RIGHT,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_RIGHT,true)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_UP,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_UP,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_UP,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_UP,true)});this.facade.offer({keyCodes:[{metaKeys:[ORYX.CONFIG.META_KEY_META_CTRL],keyCode:ORYX.CONFIG.KEY_CODE_DOWN,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_DOWN,false)});this.facade.offer({keyCodes:[{keyCode:ORYX.CONFIG.KEY_CODE_DOWN,keyAction:ORYX.CONFIG.KEY_ACTION_DOWN}],functionality:this.move.bind(this,ORYX.CONFIG.KEY_CODE_DOWN,true)})},selectAll:function(a){Event.stop(a.event);this.facade.setSelection(this.facade.getCanvas().getChildShapes(true))},move:function(n,k,l){Event.stop(l.event);var b=k?20:5;var m=this.facade.getSelection();var g=this.facade.getSelection();var c={x:0,y:0};switch(n){case ORYX.CONFIG.KEY_CODE_LEFT:c.x=-1*b;break;case ORYX.CONFIG.KEY_CODE_RIGHT:c.x=b;break;case ORYX.CONFIG.KEY_CODE_UP:c.y=-1*b;break;case ORYX.CONFIG.KEY_CODE_DOWN:c.y=b;break}m=m.findAll(function(e){if(e instanceof ORYX.Core.Node&&e.dockers.length==1&&m.include(e.dockers.first().getDockedShape())){return false}var o=e.parent;do{if(m.include(o)){return false}}while(o=o.parent);return true});var f=true;var h=m.all(function(e){if(e instanceof ORYX.Core.Edge){if(e.isDocked()){f=false}return true}return false});if(h&&!f){return}m=m.map(function(o){if(o instanceof ORYX.Core.Node){return o}else{if(o instanceof ORYX.Core.Edge){var e=o.dockers;if(m.include(o.dockers.first().getDockedShape())){e=e.without(o.dockers.first())}if(m.include(o.dockers.last().getDockedShape())){e=e.without(o.dockers.last())}return e}else{return null}}}).flatten().compact();if(m.size()>0){var a=[this.facade.getCanvas().bounds.lowerRight().x,this.facade.getCanvas().bounds.lowerRight().y,0,0];m.each(function(e){a[0]=Math.min(a[0],e.bounds.upperLeft().x);a[1]=Math.min(a[1],e.bounds.upperLeft().y);a[2]=Math.max(a[2],e.bounds.lowerRight().x);a[3]=Math.max(a[3],e.bounds.lowerRight().y)});if(a[0]+c.x<0){c.x=-a[0]}if(a[1]+c.y<0){c.y=-a[1]}if(a[2]+c.x>this.facade.getCanvas().bounds.lowerRight().x){c.x=this.facade.getCanvas().bounds.lowerRight().x-a[2]}if(a[3]+c.y>this.facade.getCanvas().bounds.lowerRight().y){c.y=this.facade.getCanvas().bounds.lowerRight().y-a[3]}if(c.x!=0||c.y!=0){var d=[new ORYX.Core.Command.Move(m,c,null,g,this)];this.facade.executeCommands(d)}}},getUndockedCommant:function(b){var a=ORYX.Core.Command.extend({construct:function(c){this.dockers=c.collect(function(d){return d instanceof ORYX.Core.Controls.Docker?{docker:d,dockedShape:d.getDockedShape(),refPoint:d.referencePoint}:undefined}).compact()},execute:function(){this.dockers.each(function(c){c.docker.setDockedShape(undefined)})},rollback:function(){this.dockers.each(function(c){c.docker.setDockedShape(c.dockedShape);c.docker.setReferencePoint(c.refPoint)})}});command=new a(b);command.execute();return command},});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ContainerLayouter={construct:function(a){this.facade=a;this.hashedContainers=new Hash()},handleLayoutContainerDockers:function(b){var a=b.shape;if(!this.hashedContainers[a.resourceId]){this.hashedContainers[a.resourceId]=a.bounds.clone();return}var c=a.bounds.upperLeft();c.x-=this.hashedContainers[a.resourceId].upperLeft().x;c.y-=this.hashedContainers[a.resourceId].upperLeft().y;this.hashedContainers[a.resourceId]=a.bounds.clone();this.moveChildDockers(a,c)},handleLayoutContainerMinBounds:function(c){var h=c.shape;var g=c.topOffset;var b=h._oldBounds;var n=c.options;var e=(n.ignoreChildsWithId?n.ignoreChildsWithId:new Array());var o=this.retrieveChildsIncludingBounds(h,e);if(!o){return}var m=this.getChildShapesWithout(h,e).find(function(p){return o.upperLeft().y==p.bounds.upperLeft().y});if(this.ensureContainersMinimumSize(h,o,m.absoluteBounds(),e,n)){return}var a=o.upperLeft();var l=o.lowerRight();var f=(a.y?a.y:1)/((b.height()-l.y)?(b.height()-l.y):1);var k=f*(h.bounds.height()-o.height())/(1+f);this.getChildShapesWithout(h,e).each(function(q){var p=q.bounds.upperLeft().y-a.y;q.bounds.moveTo({x:q.bounds.upperLeft().x,y:k+p})});var d=m.bounds.upperLeft().y-m._oldBounds.upperLeft().y;this.moveChildDockers(h,{x:0,y:d})},ensureContainersMinimumSize:function(b,n,v,m,d){var f=b.bounds;var a=f.upperLeft();var r=f.lowerRight();var l=n.upperLeft();var o=n.lowerRight();var g=b.absoluteBounds();if(!d){d=new Object()}if(!b.isResized){var s=0;var w=0;var q=false;var x=a.x;var t=a.y;var z=r.x;var y=r.y;if(l.x<0){x+=l.x;w-=l.x;q=true}if(l.y<0){t+=l.y;s-=l.y;q=true}var p=w+l.x+n.width()-f.width();if(p>0){z+=p;q=true}var h=s+l.y+n.height()-f.height();if(h>0){y+=h;q=true}f.set(x,t,z,y);if(q){this.hashedContainers[b.resourceId]=f.clone()}this.moveChildsBy(b,{x:w,y:s},m);return true}var x=a.x;var t=a.y;var z=r.x;var y=r.y;q=false;if(f.height()<n.height()){if(a.y!=b._oldBounds.upperLeft().y&&r.y==b._oldBounds.lowerRight().y){t=y-n.height()-1;if(d.fixedY){t-=n.upperLeft().y}q=true}else{if(a.y==b._oldBounds.upperLeft().y&&r.y!=b._oldBounds.lowerRight().y){y=t+n.height()+1;if(d.fixedY){y+=n.upperLeft().y}q=true}else{if(v){var c=g.upperLeft().y-v.upperLeft().y;var u=g.lowerRight().y-v.lowerRight().y;t-=c;y-=u;t--;y++;q=true}}}}if(f.width()<n.width()){if(a.x!=b._oldBounds.upperLeft().x&&r.x==b._oldBounds.lowerRight().x){x=z-n.width()-1;if(d.fixedX){x-=n.upperLeft().x}q=true}else{if(a.x==b._oldBounds.upperLeft().x&&r.x!=b._oldBounds.lowerRight().x){z=x+n.width()+1;if(d.fixedX){z+=n.upperLeft().x}q=true}else{if(v){var k=g.upperLeft().x-v.upperLeft().x;var e=g.lowerRight().x-v.lowerRight().x;x-=k;z-=e;x--;z++;q=true}}}}f.set(x,t,z,y);if(q){this.handleLayoutContainerDockers({shape:b})}},moveChildsBy:function(a,c,b){if(!a||!c){return}this.getChildShapesWithout(a,b).each(function(d){d.bounds.moveBy(c)})},getAbsoluteBoundsForChildShapes:function(a){},moveChildDockers:function(a,b){if(!b.x&&!b.y){return}a.getChildNodes(true).map(function(c){return[].concat(c.getIncomingShapes()).concat(c.getOutgoingShapes())}).flatten().uniq().map(function(c){return c.dockers.length>2?c.dockers.slice(1,c.dockers.length-1):[]}).flatten().each(function(c){c.bounds.moveBy(b)})},retrieveChildsIncludingBounds:function(b,c){var a=undefined;this.getChildShapesWithout(b,c).each(function(e,d){if(d==0){a=e.bounds.clone();return}a.include(e.bounds)});return a},getChildShapesWithout:function(a,b){var c=a.getChildShapes(false);return c.findAll(function(d){return !b.member(d.getStencil().id())})}};ORYX.Plugins.ContainerLayouter=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.ContainerLayouter);if(!ORYX.Plugins){ORYX.Plugins=new Object()}function gup(b){b=b.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a="[\\?&]"+b+"=([^&#]*)";var d=new RegExp(a);var c=d.exec(window.location.href);if(c==null){return""}else{return c[1]}}ORYX.Plugins.Pnmlexport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.Pnmlexport.name,functionality:this.exportIt.bind(this),group:ORYX.I18N.Pnmlexport.group,icon:ORYX.PATH+"images/bpmn2pn_deploy.png",description:ORYX.I18N.Pnmlexport.desc,index:2,minShape:0,maxShape:0})},exportIt:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE});window.setTimeout((function(){this.exportSynchronously();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}).bind(this),10);return true},exportSynchronously:function(){var d=location.href;try{var b=this.getRDFFromDOM();var c=gup("resource");new Ajax.Request(ORYX.CONFIG.PNML_EXPORT_URL,{method:"POST",asynchronous:false,parameters:{resource:d,data:b,title:c},onSuccess:function(g){var k=g.responseText;if(k.indexOf("RDF to BPMN failed with Exception:")==0){alert(k)}else{var f="http://"+location.host+ORYX.CONFIG.ROOT_PATH+k;var e="<h2>Process: "+self.document.title+'</h2><a target="_blank" href="'+f;var h=new Ext.Window({width:320,height:240,resizable:false,minimizable:false,modal:true,autoScroll:true,title:"Deployment successful",html:e,buttons:[{text:"OK",handler:function(){h.hide()}}]});h.show()}}})}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});alert(a)}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.SimplePnmlexport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.SimplePnmlexport.name,functionality:this.exportIt.bind(this),group:ORYX.I18N.SimplePnmlexport.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/page_white_gear.png",description:ORYX.I18N.SimplePnmlexport.desc,index:1,minShape:0,maxShape:0});this.facade.offer({name:"PNML For LOLA",functionality:this.exportIt.bind(this,true),group:ORYX.I18N.SimplePnmlexport.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/page_white_gear.png",description:ORYX.I18N.SimplePnmlexport.desc,index:1,minShape:0,maxShape:0})},exportIt:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE});window.setTimeout((function(){this.exportSynchronously(a);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}).bind(this),10);return true},exportSynchronously:function(e){var d=location.href;var b="none";if(e){b="lola"}try{var c=this.getRDFFromDOM();if(!c.startsWith("<?xml")){c='<?xml version="1.0" encoding="UTF-8"?>'+c}new Ajax.Request(ORYX.CONFIG.SIMPLE_PNML_EXPORT_URL,{method:"POST",asynchronous:false,parameters:{resource:d,data:c,tool:b},onSuccess:function(f){this.openDownloadWindow(window.document.title+".xml",f.responseText)}.bind(this)})}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a)}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.DesynchronizabilityOverlay=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.el=undefined;this.callback=undefined;this.facade.offer({name:ORYX.I18N.DesynchronizabilityOverlay.name,functionality:this.showOverlay.bind(this),group:ORYX.I18N.DesynchronizabilityOverlay.group,icon:ORYX.PATH+"images/bpmn2pn.png",description:ORYX.I18N.DesynchronizabilityOverlay.desc,index:3,minShape:0,maxShape:0})},showOverlay:function(){if(this.active){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"desynchronizability"});this.active=!this.active}else{try{var b=this.getRDFFromDOM();new Ajax.Request(ORYX.CONFIG.DESYNCHRONIZABILITY_URL,{method:"POST",asynchronous:false,parameters:{resource:location.href,data:b},onSuccess:function(c){var e=c.responseText.evalJSON();if(e.conflicttransitions){if(e.conflicttransitions.length>0){var d=e.conflicttransitions.collect(function(f){return this.facade.getCanvas().getChildShapeByResourceId(f)}.bind(this)).compact();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"desynchronizability",shapes:d,attributes:{fill:"red",stroke:"black"}});this.active=!this.active}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.DesynchronizabilityOverlay.sync)}}else{if(e.syntaxerrors){Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.DesynchronizabilityOverlay.error.replace(/1/,e.syntaxerrors.length))}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.DesynchronizabilityOverlay.invalid)}}}.bind(this)})}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a)}}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.EnforceabilityOverlay=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.el=undefined;this.callback=undefined;this.facade.offer({name:"Enforceability",functionality:this.showOverlay.bind(this),group:"Enforceability",icon:ORYX.PATH+"images/checker_validation.png",description:"enforce?",index:3,minShape:0,maxShape:0})},showOverlay:function(){if(this.active){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"enforceability"});this.active=!this.active}else{try{var b=this.getRDFFromDOM();new Ajax.Request(ORYX.CONFIG.ENFORCEABILITY_URL,{method:"POST",asynchronous:false,parameters:{resource:location.href,data:b},onSuccess:function(c){var e=c.responseText.evalJSON();if(e.conflicttransitions){if(e.conflicttransitions.length>0){var d=e.conflicttransitions.collect(function(f){return this.facade.getCanvas().getChildShapeByResourceId(f)}.bind(this)).compact();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"enforceability",shapes:d,attributes:{fill:"red",stroke:"black"}});this.active=!this.active}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.DesynchronizabilityOverlay.sync)}}else{if(e.syntaxerrors){Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.DesynchronizabilityOverlay.error.replace(/1/,e.syntaxerrors.length))}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.DesynchronizabilityOverlay.invalid)}}}.bind(this)})}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a)}}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.IBPMN2BPMN=Clazz.extend({facade:undefined,TransformServletURL:"./ibpmn2bpmn",construct:function(a){this.facade=a;this.facade.offer({name:"Transform from iBPMN to BPMN",functionality:this.transform.bind(this),icon:ORYX.PATH+"images/erdf_import_icon.png",description:"Transformation from iBPMN to BPMN",index:1,minShape:0,maxShape:0,group:ORYX.I18N.JSONSupport.imp.group,dropDownGroupIcon:ORYX.PATH+"images/import.png"})},transform:function(){this._showImportDialog()},sendRequest:function(b,d,e,a){var c=false;new Ajax.Request(b,{method:"POST",asynchronous:false,parameters:d,onSuccess:function(f){c=true;if(e){e(f.responseText)}}.bind(this),onFailure:function(f){if(a){a()}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.ERDFSupport.impFailed);ORYX.log.warn("Transform failed: "+f.responseText)}}.bind(this)});return c},transformToBPMN:function(d,p,h){var q=d;q=q.startsWith("<?xml")?q:'<?xml version="1.0" encoding="utf-8"?>'+q+"";var b=new DOMParser();var o=b.parseFromString(q,"text/xml");if(o.firstChild.tagName=="parsererror"){Ext.MessageBox.show({title:"Parse Error",msg:"The given RDF is not xml valid.",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});if(h){h()}}else{var m=function(s){s='<?xml version="1.0" encoding="utf-8"?><div>'+s+"</div>";var t=new DOMParser();var r=t.parseFromString(s,"text/xml");this.facade.importERDF(r)}.bind(this);var f="";source=ORYX.PATH+"lib/extract-rdf.xsl";new Ajax.Request(source,{asynchronous:false,method:"get",onSuccess:function(e){f=e.responseText}.bind(this),onFailure:(function(e){ORYX.Log.error("XSL load failed"+e)}).bind(this)});var b=new DOMParser();var c=b.parseFromString(q,"text/xml");var g=domParser.parseFromString(f,"text/xml");var l=new XSLTProcessor();l.importStylesheet(g);try{var k=l.transformToFragment(c,document);var a=(new XMLSerializer()).serializeToString(k);if(!a.startsWith("<?xml")){a='<?xml version="1.0" encoding="UTF-8"?>'+a}this.sendRequest(this.TransformServletURL,{data:a},m)}catch(n){}if(p){p()}}},_showImportDialog:function(a){var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.ERDFSupport.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.ERDFSupport.file,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var b=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.ERDFSupport.impERDF,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[c],buttons:[{text:ORYX.I18N.ERDFSupport.impBtn,handler:function(){var d=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.ERDFSupport.impProgress});d.show();window.setTimeout(function(){var e=c.items.items[2].getValue();this.transformToBPMN(e,function(){d.hide();b.hide()}.bind(this),function(){d.hide()}.bind(this))}.bind(this),100)}.bind(this)},{text:ORYX.I18N.ERDFSupport.close,handler:function(){b.hide()}.bind(this)}]});b.on("hide",function(){b.destroy(true);delete b});b.show();c.items.items[1].getEl().dom.addEventListener("change",function(d){var e=d.target.files[0].getAsBinary();c.items.items[2].setValue(e)},true)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.SyntaxChecker=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.SyntaxChecker.name,functionality:this.perform.bind(this),group:ORYX.I18N.SyntaxChecker.group,icon:ORYX.PATH+"images/checker_syntax.png",description:ORYX.I18N.SyntaxChecker.desc,index:0,toggle:true,minShape:0,maxShape:0});this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,this.checkForErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT,this.resetErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT,this.doShowErrors.bind(this))},perform:function(a,b){if(!b){this.resetErrors()}else{this.checkForErrors({onNoErrors:function(){this.setActivated(a,false);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.noErrors,timeout:10000})}.bind(this),onErrors:function(){this.enableDeactivationHandler(a)}.bind(this),onFailure:function(){this.setActivated(a,false);Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.SyntaxChecker.invalid)}.bind(this)})}},enableDeactivationHandler:function(a){var b=function(){this.setActivated(a,false);this.resetErrors();this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b)};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b.bind(this))},setActivated:function(b,a){b.toggle(a);if(a===undefined){this.active=!this.active}else{this.active=a}},checkForErrors:function(a){Ext.applyIf(a||{},{showErrors:true,onErrors:Ext.emptyFn,onNoErrors:Ext.emptyFn,onFailure:Ext.emptyFn});Ext.Msg.wait(ORYX.I18N.SyntaxChecker.checkingMessage);var b=this.facade.getStencilSets();var d=null;var c=false;if(b.keys().include("http://b3mn.org/stencilset/bpmn2.0#")||b.keys().include("http://b3mn.org/stencilset/bpmn2.0conversation#")){d=this.facade.getSerializedJSON();c=true}else{d=this.getRDFFromDOM()}new Ajax.Request(ORYX.CONFIG.SYNTAXCHECKER_URL,{method:"POST",asynchronous:false,parameters:{resource:location.href,data:d,context:a.context,isJson:c},onSuccess:function(e){var f=(e&&e.responseText?e.responseText:"{}").evalJSON();Ext.Msg.hide();if(f instanceof Object){f=$H(f);if(f.size()>0){if(a.showErrors){this.showErrors(f)}a.onErrors()}else{a.onNoErrors()}}else{a.onFailure()}}.bind(this),onFailure:function(){Ext.Msg.hide();a.onFailure()}})},doShowErrors:function(b,a){this.showErrors(b.errors)},showErrors:function(a){if(!(a instanceof Hash)){a=new Hash(a)}a.keys().each(function(c){var b=this.facade.getCanvas().getChildShapeByResourceId(c);if(b){this.raiseOverlay(b,this.parseCodeToMsg(a[c]))}}.bind(this));this.active=!this.active;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.notice,timeout:10000})},parseCodeToMsg:function(e){var f=e.replace(/: /g,"<br />").replace(/, /g,"<br />");var a=f.split("<br />");for(var b=0;b<a.length;b++){var d=a[b];var c=this.parseSingleCodeToMsg(d);if(d!=c){f=f.replace(d,c)}}return f},parseSingleCodeToMsg:function(a){return ORYX.I18N.SyntaxChecker[a]||a},resetErrors:function(){this.raisedEventIds.each(function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a})}.bind(this));this.raisedEventIds=[];this.active=false},raiseOverlay:function(a,b){var f="syntaxchecker."+this.raisedEventIds.length;var d=ORYX.Editor.provideId();var e=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{id:d,title:"","stroke-width":5,stroke:"red",d:"M20,-5 L5,-20 M5,-5 L20,-20","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:f,shapes:[a],node:e,nodePosition:a instanceof ORYX.Core.Edge?"START":"NW"});var c=new Ext.ToolTip({showDelay:50,html:b,target:d});this.raisedEventIds.push(f);return e}});ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT="checkForErrors";ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT="resetErrors";ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT="showErrors";ORYX.Plugins.PetrinetSyntaxChecker=ORYX.Plugins.SyntaxChecker.extend({getRDFFromDOM:function(){return this.facade.getERDF()}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.SyntaxChecker=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.SyntaxChecker.name,functionality:this.perform.bind(this),group:ORYX.I18N.SyntaxChecker.group,icon:ORYX.PATH+"images/checker_syntax.png",description:ORYX.I18N.SyntaxChecker.desc,index:0,toggle:true,minShape:0,maxShape:0});this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,this.checkForErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT,this.resetErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT,this.doShowErrors.bind(this))},perform:function(a,b){if(!b){this.resetErrors()}else{this.checkForErrors({onNoErrors:function(){this.setActivated(a,false);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.noErrors,timeout:10000})}.bind(this),onErrors:function(){this.enableDeactivationHandler(a)}.bind(this),onFailure:function(){this.setActivated(a,false);Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.SyntaxChecker.invalid)}.bind(this)})}},enableDeactivationHandler:function(a){var b=function(){this.setActivated(a,false);this.resetErrors();this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b)};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b.bind(this))},setActivated:function(b,a){b.toggle(a);if(a===undefined){this.active=!this.active}else{this.active=a}},checkForErrors:function(a){Ext.applyIf(a||{},{showErrors:true,onErrors:Ext.emptyFn,onNoErrors:Ext.emptyFn,onFailure:Ext.emptyFn});Ext.Msg.wait(ORYX.I18N.SyntaxChecker.checkingMessage);var b=this.facade.getStencilSets();var d=null;var c=false;if(b.keys().include("http://b3mn.org/stencilset/bpmn2.0#")||b.keys().include("http://b3mn.org/stencilset/bpmn2.0conversation#")){d=this.facade.getSerializedJSON();c=true}else{d=this.getRDFFromDOM()}new Ajax.Request(ORYX.CONFIG.SYNTAXCHECKER_URL,{method:"POST",asynchronous:false,parameters:{resource:location.href,data:d,context:a.context,isJson:c},onSuccess:function(e){var f=(e&&e.responseText?e.responseText:"{}").evalJSON();Ext.Msg.hide();if(f instanceof Object){f=$H(f);if(f.size()>0){if(a.showErrors){this.showErrors(f)}a.onErrors()}else{a.onNoErrors()}}else{a.onFailure()}}.bind(this),onFailure:function(){Ext.Msg.hide();a.onFailure()}})},doShowErrors:function(b,a){this.showErrors(b.errors)},showErrors:function(a){if(!(a instanceof Hash)){a=new Hash(a)}a.keys().each(function(c){var b=this.facade.getCanvas().getChildShapeByResourceId(c);if(b){this.raiseOverlay(b,this.parseCodeToMsg(a[c]))}}.bind(this));this.active=!this.active;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.notice,timeout:10000})},parseCodeToMsg:function(e){var f=e.replace(/: /g,"<br />").replace(/, /g,"<br />");var a=f.split("<br />");for(var b=0;b<a.length;b++){var d=a[b];var c=this.parseSingleCodeToMsg(d);if(d!=c){f=f.replace(d,c)}}return f},parseSingleCodeToMsg:function(a){return ORYX.I18N.SyntaxChecker[a]||a},resetErrors:function(){this.raisedEventIds.each(function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a})}.bind(this));this.raisedEventIds=[];this.active=false},raiseOverlay:function(a,b){var f="syntaxchecker."+this.raisedEventIds.length;var d=ORYX.Editor.provideId();var e=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{id:d,title:"","stroke-width":5,stroke:"red",d:"M20,-5 L5,-20 M5,-5 L20,-20","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:f,shapes:[a],node:e,nodePosition:a instanceof ORYX.Core.Edge?"START":"NW"});var c=new Ext.ToolTip({showDelay:50,html:b,target:d});this.raisedEventIds.push(f);return e}});ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT="checkForErrors";ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT="resetErrors";ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT="showErrors";ORYX.Plugins.PetrinetSyntaxChecker=ORYX.Plugins.SyntaxChecker.extend({getRDFFromDOM:function(){return this.facade.getERDF()}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Validator=ORYX.Plugins.AbstractPlugin.extend({construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.buttonId=ORYX.Editor.provideId();this.facade.offer({name:ORYX.I18N.Validator.name,id:this.buttonId,functionality:this.load.bind(this),group:"Verification",icon:ORYX.PATH+"images/checker_validation.png",description:ORYX.I18N.Validator.description,index:1,toggle:true,minShape:0,maxShape:0})},load:function(a,b){if(!b){this.hideOverlays();this.active=!this.active}else{this.validate(a)}},setActive:function(a){this.active=a;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_BUTTON_UPDATE,id:this.buttonId,pressed:a})},hideOverlays:function(){this.raisedEventIds.each(function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a})}.bind(this));this.raisedEventIds=[]},validate:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Validator.checking});new Ajax.Request(ORYX.CONFIG.VALIDATOR_URL,{method:"POST",asynchronous:false,parameters:{resource:location.href,data:this.getRDFFromDOM()},onSuccess:function(c){var b=Ext.decode(c.responseText);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});this.handleValidationResponse(b,a)}.bind(this),onFailure:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Validator.error,ORYX.I18N.Validator.errorDesc)}.bind(this)})},showOverlay:function(b,c,a){var g="syntaxchecker."+this.raisedEventIds.length;var e=ORYX.Editor.provideId();var f=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{id:e,title:"","stroke-width":5,stroke:"red",d:"M20,-5 L5,-20 M5,-5 L20,-20","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:g,shapes:[b],node:f,nodePosition:b instanceof ORYX.Core.Edge?"START":"NW"});this.raisedEventIds.push(g);var d=new Ext.ToolTip({showDelay:50,title:a,html:c,target:e});return f},enableDeactivationHandler:function(a){var b=function(){this.setActive(false);this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b)};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b.bind(this))}});ORYX.Plugins.BPMNValidator=Ext.extend(ORYX.Plugins.Validator,{handleValidationResponse:function(a,e){var f=a.conflictingNodes;var c=a.leadsToEnd;var b=a.unsafeNode;this.setActive(f.size()>0);if(f.size()>0){f.each(function(g){sh=this.facade.getCanvas().getChildShapeByResourceId(g.id);if(sh){this.showOverlay(sh,ORYX.I18N.Validator.bpmnDeadlock,ORYX.I18N.Validator.bpmnDeadlockTitle)}}.bind(this))}if(b){var d=this.facade.getCanvas().getChildShapeByResourceId(b);if(d){this.showOverlay(d,ORYX.I18N.Validator.bpmnUnsafe,ORYX.I18N.Validator.bpmnUnsafeTitle)}}if(c&&f.size()===0&&!b){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.Validator.noErrors,timeout:10000})}else{if(!c&&f.size()===0&&!b){Ext.Msg.alert(ORYX.I18N.Validator.bpmnLeadsToNoEndTitle,ORYX.I18N.Validator.bpmnLeadsToNoEnd)}else{this.enableDeactivationHandler(e);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.notice,timeout:10000})}}}});ORYX.Plugins.EPCValidator=Ext.extend(ORYX.Plugins.Validator,{getLabelOfShape:function(a){if(a.properties["oryx-title"]===""){return a.id}else{return a.properties["oryx-title"]}},findShapeById:function(a){return this.facade.getCanvas().getChildShapeByResourceId(a)},handleValidationResponse:function(l,d){var g=l.isSound;var c=l.badStartArcs;var b=l.badEndArcs;var h=l.goodInitialMarkings;var e=l.goodFinalMarkings;var k="";if(g){k+=ORYX.I18N.Validator.epcIsSound}else{k+=ORYX.I18N.Validator.epcNotSound}k+="<hr />";var a=function(m,n){var o="<ul>";m.each(function(p){o+="<li> - ";p.each(function(q){o+='"'+n(q)+'" '});o+="</li>"});o+="</ul>";return o};var f=function(o,m){var n="<ul>";o.each(function(p){n+="<li> - "+m(p)+"</li>"});n+="</ul>";return n};k+="<p>There are "+h.length+" initial markings which does not run into a deadlock.</p>";k+=a(h,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getIncomingShapes()[0])}.createDelegate(this));k+="<p>The initial markings do not include "+c.length+" start nodes.</p>";k+=f(c,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getIncomingShapes()[0])}.createDelegate(this));k+="<hr />";k+="<p>There are "+e.length+" final markings which can be reached from the initial markings.</p>";k+=a(e,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getOutgoingShapes()[0])}.createDelegate(this));k+="<p>The final markings do not include "+b.length+" end nodes.</p>";k+=f(b,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getOutgoingShapes()[0])}.createDelegate(this));k+="<hr />";k+="<p><i>Remark: Set titles of functions and events to get some nicer output (names instead of ids)</i></p>";Ext.Msg.alert("Validation Result",k);this.setActive(false)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Validator=ORYX.Plugins.AbstractPlugin.extend({construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.buttonId=ORYX.Editor.provideId();this.facade.offer({name:ORYX.I18N.Validator.name,id:this.buttonId,functionality:this.load.bind(this),group:"Verification",icon:ORYX.PATH+"images/checker_validation.png",description:ORYX.I18N.Validator.description,index:1,toggle:true,minShape:0,maxShape:0})},load:function(a,b){if(!b){this.hideOverlays();this.active=!this.active}else{this.validate(a)}},setActive:function(a){this.active=a;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_BUTTON_UPDATE,id:this.buttonId,pressed:a})},hideOverlays:function(){this.raisedEventIds.each(function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a})}.bind(this));this.raisedEventIds=[]},validate:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Validator.checking});new Ajax.Request(ORYX.CONFIG.VALIDATOR_URL,{method:"POST",asynchronous:false,parameters:{resource:location.href,data:this.getRDFFromDOM()},onSuccess:function(c){var b=Ext.decode(c.responseText);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});this.handleValidationResponse(b,a)}.bind(this),onFailure:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Validator.error,ORYX.I18N.Validator.errorDesc)}.bind(this)})},showOverlay:function(b,c,a){var g="syntaxchecker."+this.raisedEventIds.length;var e=ORYX.Editor.provideId();var f=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{id:e,title:"","stroke-width":5,stroke:"red",d:"M20,-5 L5,-20 M5,-5 L20,-20","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:g,shapes:[b],node:f,nodePosition:b instanceof ORYX.Core.Edge?"START":"NW"});this.raisedEventIds.push(g);var d=new Ext.ToolTip({showDelay:50,title:a,html:c,target:e});return f},enableDeactivationHandler:function(a){var b=function(){this.setActive(false);this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b)};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,b.bind(this))}});ORYX.Plugins.BPMNValidator=Ext.extend(ORYX.Plugins.Validator,{handleValidationResponse:function(a,e){var f=a.conflictingNodes;var c=a.leadsToEnd;var b=a.unsafeNode;this.setActive(f.size()>0);if(f.size()>0){f.each(function(g){sh=this.facade.getCanvas().getChildShapeByResourceId(g.id);if(sh){this.showOverlay(sh,ORYX.I18N.Validator.bpmnDeadlock,ORYX.I18N.Validator.bpmnDeadlockTitle)}}.bind(this))}if(b){var d=this.facade.getCanvas().getChildShapeByResourceId(b);if(d){this.showOverlay(d,ORYX.I18N.Validator.bpmnUnsafe,ORYX.I18N.Validator.bpmnUnsafeTitle)}}if(c&&f.size()===0&&!b){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.Validator.noErrors,timeout:10000})}else{if(!c&&f.size()===0&&!b){Ext.Msg.alert(ORYX.I18N.Validator.bpmnLeadsToNoEndTitle,ORYX.I18N.Validator.bpmnLeadsToNoEnd)}else{this.enableDeactivationHandler(e);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.SyntaxChecker.notice,timeout:10000})}}}});ORYX.Plugins.EPCValidator=Ext.extend(ORYX.Plugins.Validator,{getLabelOfShape:function(a){if(a.properties["oryx-title"]===""){return a.id}else{return a.properties["oryx-title"]}},findShapeById:function(a){return this.facade.getCanvas().getChildShapeByResourceId(a)},handleValidationResponse:function(l,d){var g=l.isSound;var c=l.badStartArcs;var b=l.badEndArcs;var h=l.goodInitialMarkings;var e=l.goodFinalMarkings;var k="";if(g){k+=ORYX.I18N.Validator.epcIsSound}else{k+=ORYX.I18N.Validator.epcNotSound}k+="<hr />";var a=function(m,n){var o="<ul>";m.each(function(p){o+="<li> - ";p.each(function(q){o+='"'+n(q)+'" '});o+="</li>"});o+="</ul>";return o};var f=function(o,m){var n="<ul>";o.each(function(p){n+="<li> - "+m(p)+"</li>"});n+="</ul>";return n};k+="<p>There are "+h.length+" initial markings which does not run into a deadlock.</p>";k+=a(h,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getIncomingShapes()[0])}.createDelegate(this));k+="<p>The initial markings do not include "+c.length+" start nodes.</p>";k+=f(c,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getIncomingShapes()[0])}.createDelegate(this));k+="<hr />";k+="<p>There are "+e.length+" final markings which can be reached from the initial markings.</p>";k+=a(e,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getOutgoingShapes()[0])}.createDelegate(this));k+="<p>The final markings do not include "+b.length+" end nodes.</p>";k+=f(b,function(m){return this.getLabelOfShape(this.findShapeById(m.id).getOutgoingShapes()[0])}.createDelegate(this));k+="<hr />";k+="<p><i>Remark: Set titles of functions and events to get some nicer output (names instead of ids)</i></p>";Ext.Msg.alert("Validation Result",k);this.setActive(false)}});Ext.namespace("ORYX.Plugins");ORYX.Plugins.AbstractStepThroughPlugin=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:ORYX.I18N.StepThroughPlugin.stepThrough,functionality:this.load.bind(this),group:ORYX.I18N.StepThroughPlugin.group,icon:ORYX.PATH+"images/control_play.png",description:ORYX.I18N.StepThroughPlugin.stepThroughDesc,index:1,toggle:true,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.StepThroughPlugin.undo,functionality:this.undo.bind(this),group:ORYX.I18N.StepThroughPlugin.group,icon:ORYX.PATH+"images/control_rewind.png",description:ORYX.I18N.StepThroughPlugin.undoDesc,index:2,minShape:0,maxShape:0})},showEnabled:function(a,b){if(!(a instanceof ORYX.Core.Shape)){return}else{if(this.isOrSplit(a)){this.showEnabledOrSplit(a);return}}this.showPlayOnShape(a)},showPlayOnShape:function(b){var a;if(b instanceof ORYX.Core.Edge){a={stroke:"green"}}else{a={fill:"green"}}var c=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{title:"Click the element to execute it!","stroke-width":2,stroke:"black",d:"M0,-5 L5,0 L0,5 Z","line-captions":"round"}]);this.showOverlayOnShape(b,a,c)},showOverlayOnShape:function(b,a,c){this.hideOverlayOnShape(b);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a,node:(c?c:null),nodePosition:b instanceof ORYX.Core.Edge?"END":"SE"})},hideOverlayOnShape:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+a.resourceId})},hideOverlays:function(a){var b=this.facade.getCanvas().getChildShapes(true);var c;for(i=0;i<b.size();i++){c=b[i];if(!(a&&this.isStartNode(c))){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+c.resourceId})}}},load:function(a,b){this.initializeLoadButton(a,b);this.togglePlugin(b)},togglePlugin:function(a){if(a){this.initialMarking=[];if(this.getDiagramType()==="epc"){this.prepareInitialMarking()}else{this.startAndCheckSyntax()}}else{this.executionTrace="";this.rdf=undefined;this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT});this.onDeactivate()}if(this.active()){this.callback=this.doMouseUp.bind(this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEUP,this.callback)}else{this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEUP,this.callback);this.callback=undefined}},onDeactivate:function(){this.hideOverlays()},initializeLoadButton:function(b,c){if(this.loadButton!==b){var a=function(d){if(d){this.facade.disableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN)}else{this.facade.enableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN)}}.createDelegate(this);b.on("toggle",function(d,e){a(e)});a(b,c)}this.loadButton=b},active:function(){return this.loadButton?this.loadButton.pressed:false},onSelectionChanged:function(){if(this.active()&&this.facade.getSelection().length>0){this.facade.setSelection([])}},getDiagramType:function(){switch(this.facade.getCanvas().getStencil().namespace()){case"http://b3mn.org/stencilset/epc#":return"epc";case"http://b3mn.org/stencilset/bpmn#":return"bpmn";default:return null}},showUsed:function(b,c){if(!(b instanceof ORYX.Core.Shape)){return}var a;if(b instanceof ORYX.Core.Edge){a={stroke:"mediumslateblue"}}else{a={fill:"mediumslateblue"}}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+b.resourceId});if(c!="-1"&&c!="1"){var d=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{style:"font-size: 16px; font-weight: bold;"},c]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a,node:d,nodePosition:b instanceof ORYX.Core.Edge?"END":"SE"})}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a})}}});ORYX.Plugins.PetriNetStepThroughPlugin=ORYX.Plugins.AbstractStepThroughPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments)},startAndCheckSyntax:function(){this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,onErrors:function(){Ext.Msg.alert("Syntax Check","Some syntax errors have been found, please correct them!")}.bind(this),onNoErrors:function(){if(this.initializeMarking()){this.firedTransitions=[];this.showEnabledTransition()}else{this.togglePlugin(false)}}.bind(this)})},initializeMarking:function(){var b=function(d,c){if(c==0){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","0")}else{if(c==1){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","1")}else{if(c==2){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","2")}else{if(c==3){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","3")}else{if(c==4){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","4")}else{var e=parseInt(c,10);if(e&&e>0){d.setProperty("oryx-numberoftokens_text",""+e);d.setProperty("oryx-numberoftokens_drawing","0")}else{d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","0")}}}}}}};this.getPlaces().each(function(c){if("undefined"==typeof(c._setProperty_monkey)){c._setProperty_monkey=c.setProperty;c.setProperty=function(e,d){if("oryx-numberoftokens"==e){b(c,d)}c._setProperty_monkey.apply(c,arguments)}}});var a=0;this.getPlaces().each(function(c){var d=parseInt(c.properties["oryx-numberoftokens"]);if(isNaN(d)){c.setProperty("oryx-numberoftokens",0)}else{if(d>0){a+=d}}});if(0==a){this.getPlaces().each(function(c){if(c.getIncomingShapes().length==0){c.setProperty("oryx-numberoftokens",1)}});Ext.Msg.show({title:"No Tokens Found",msg:"Current marking of the Petri net doesn't contain any token. Tokens are added to the initial places of the net.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO})}if(a>3){Ext.Msg.show({title:"Too Many Tokens On Place",msg:"Places with more than 3 tokens aren't supported yet. Please avoid this scenario.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING})}return true},doMouseUp:function(c,a){if(!(this.isTransition(a))){return}var b=this.getIncomingNodes(a).all(function(d){return parseInt(d.properties["oryx-numberoftokens"])>0});if(b){this.fireTransition(a)}this.showEnabledTransition()},onDeactivate:function(){this.hideOverlays();while(this.firedTransitions.length!==0){this.undoLastFiredTransition()}this.facade.getCanvas().update();this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT})},fireTransition:function(a){this.firedTransitions.push(a);this.getIncomingNodes(a).each(function(b){this.removeToken(b)}.bind(this));this.getOutgoingNodes(a).each(function(b){this.addToken(b)}.bind(this))},undoLastFiredTransition:function(){var a=this.firedTransitions.pop();if(!a){return}this.getIncomingNodes(a).each(function(b){this.addToken(b)}.bind(this));this.getOutgoingNodes(a).each(function(b){this.removeToken(b)}.bind(this))},removeToken:function(a){a.setProperty("oryx-numberoftokens",parseInt(a.properties["oryx-numberoftokens"])-1)},addToken:function(a){var b=parseInt(a.properties["oryx-numberoftokens"])+1;a.setProperty("oryx-numberoftokens",b);if(b>3){Ext.Msg.show({title:"Too Many Tokens On Place",msg:"Places with more than 3 tokens aren't supported yet. Please avoid this scenario.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING})}},showEnabledTransition:function(){this.hideOverlays();this.firedTransitions.each(function(a){this.showUsed(a,"1")}.bind(this));this.getEnabledTransitions().each(function(a){this.showPlayOnShape(a)}.bind(this));this.facade.getCanvas().update()},getTransitions:function(){return this.facade.getCanvas().getChildShapes().select(function(a){return this.isTransition(a)}.bind(this))},isTransition:function(a){return a instanceof ORYX.Core.Shape&&a.getStencil().id().search(/Transition/)>-1},getPlaces:function(){return this.facade.getCanvas().getChildShapes().select(function(a){return a.getStencil().id().search(/Place/)>-1})},getIncomingNodes:function(a){return a.getIncomingShapes().collect(function(b){return b.getIncomingShapes()}).flatten()},getOutgoingNodes:function(a){return a.getOutgoingShapes().collect(function(b){return b.getOutgoingShapes()}).flatten()},getEnabledTransitions:function(){return this.getTransitions().select(function(a){return this.getIncomingNodes(a).all(function(b){return parseInt(b.properties["oryx-numberoftokens"])>0})}.bind(this))},undo:function(){this.undoLastFiredTransition();this.showEnabledTransition()}});ORYX.Plugins.StepThroughPlugin=ORYX.Plugins.AbstractStepThroughPlugin.extend({construct:function(a){this.el=undefined;this.callback=undefined;this.executionTrace="";this.rdf=undefined;arguments.callee.$.construct.apply(this,arguments)},prepareInitialMarking:function(){this.startNodes=[];Ext.each(this.facade.getCanvas().getChildShapes(true),function(a){if(this.isStartNode(a)){this.startNodes.push(a);a.initialMarkingFired=false;this.showPlayOnShape(a);if(a.getOutgoingShapes().size()==1){this.showOverlayOnShape(a.getOutgoingShapes()[0],{stroke:"green"});a.getOutgoingShapes()[0].initialMarking=true}}}.createDelegate(this))},isStartNode:function(a){return(a.getStencil().id().search(/#Event$/)>-1)&&a.getIncomingShapes().length==0&&a.getOutgoingShapes().length==1},isStartArc:function(a){return this.isStartNode(a.getIncomingShapes()[0])},isStartArcOrNode:function(a){return this.isStartNode(a)||this.isStartArc(a)},generateRDF:function(){try{var b=this.getRDFFromDOM();b=!b.startsWith("<?xml")?'<?xml version="1.0" encoding="UTF-8"?>'+b:b}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a)}this.rdf=b},getRDF:function(){if(this.rdf==undefined){this.generateRDF()}return this.rdf},startAndCheckSyntax:function(){this.postExecutionTrace({checkSyntax:true,onlyChangedObjects:false,onSuccess:function(a){if(a.responseText.startsWith("{")){var b=Ext.decode(a.responseText).syntaxErrors;this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT,errors:b})}else{this.showObjectStates(a.responseText)}}.bind(this)})},fireObject:function(a){this.executionTrace+=a+";";if(this.isOrSplit(this.el)){this.executionTrace=this.executionTrace.substring(0,this.executionTrace.length-1);this.executionTrace+="#";var c=new Ext.util.MixedCollection();c.addAll(this.el.getOutgoingShapes());var b=[];c.filter("selectedForOrSplit","true").each(function(d){b.push(d.resourceId)}.createDelegate(this));c.each(function(d){d.selectedForOrSplit=false;this.hideOverlayOnShape(d)}.createDelegate(this));this.executionTrace+=b.join(",")+";"}this.postExecutionTrace({checkSyntax:false,onlyChangedObjects:true,onSuccess:function(d){if(d.responseText!=""){this.showObjectStates(d.responseText)}else{this.removeLastFiredObject()}}.bind(this)})},doMouseUp:function(d,a){if(a instanceof ORYX.Core.Shape){if(a instanceof ORYX.Core.Edge&&this.isOrSplit(a.getIncomingShapes()[0])){this.doMouseUpOnEdgeComingFromOrSplit(a)}else{if(a instanceof ORYX.Core.Edge&&this.getDiagramType()==="epc"&&this.isStartNode(a.getIncomingShapes()[0])){this.doMouseUpOnEdgeComingFromStartNode(a)}else{if(this.getDiagramType()==="epc"&&this.isStartNode(a)){a.initialMarkingFired=true;var c=a.getOutgoingShapes()[0];this.hideOverlayOnShape(c);if(c.initialMarking){this.showUsed(a,"1");this.initialMarking.push(a.resourceId)}else{this.hideOverlayOnShape(a)}var b=true;Ext.each(this.startNodes,function(e){if(!e.initialMarkingFired){b=false}});if(b){this.startAndCheckSyntax()}}else{this.el=a;this.fireObject(this.el.resourceId)}}}}},showObjectStates:function(d){var a=d.split(";");for(i=0;i<a.size();i++){var b=a[i].split(",");if(b.size()<3){continue}var c=this.facade.getCanvas().getChildShapeByResourceId(b[0]);if(b[2]=="t"){this.showEnabled(c,b[1])}else{if(b[1]!="0"){this.showUsed(c,b[1])}else{this.hideOverlayOnShape(c)}}}},doMouseUpOnEdgeComingFromOrSplit:function(b){var a=b.getIncomingShapes()[0];if(b.selectedForOrSplit){this.showOverlayOnShape(b,{stroke:"orange"});var c=new Ext.util.MixedCollection();c.addAll(a.getOutgoingShapes());if(c.filter("selectedForOrSplit","true").length<=1){this.hideOverlayOnShape(a)}}else{this.showOverlayOnShape(b,{stroke:"green"});this.showPlayOnShape(a)}b.selectedForOrSplit=!b.selectedForOrSplit},doMouseUpOnEdgeComingFromStartNode:function(a){a.initialMarking=!a.initialMarking;if(a.initialMarking){this.showOverlayOnShape(a,{stroke:"green"})}else{this.showOverlayOnShape(a,{stroke:"orange"})}},isOrSplit:function(a){return(a.getStencil().id().search(/#(OR_Gateway|OrConnector)$/)>-1)&&(a.getOutgoingShapes().length>1)},showEnabledOrSplit:function(a){Ext.each(a.getOutgoingShapes(),function(b){Ext.apply(b,{selectedForOrSplit:false});this.showOverlayOnShape(b,{stroke:"orange"})}.createDelegate(this))},removeLastFiredObject:function(){this.executionTrace=this.executionTrace.replace(/[^;]*;$/,"")},undo:function(){if(!this.active()){return}if(this.executionTrace!==""){this.removeLastFiredObject();this.postExecutionTrace({checkSyntax:false,onlyChangedObjects:false,onSuccess:function(a){this.hideOverlays(true);this.showObjectStates(a.responseText)}.bind(this)})}else{if(this.getDiagramType()==="epc"){this.hideOverlays();this.prepareInitialMarking()}}},postExecutionTrace:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.StepThroughPlugin.executing});new Ajax.Request(ORYX.CONFIG.STEP_THROUGH,{method:"POST",asynchronous:false,parameters:{rdf:this.getRDF(),checkSyntax:a.checkSyntax,fire:this.executionTrace,onlyChangedObjects:a.onlyChangedObjects,initialMarking:this.initialMarking.join(";")},onSuccess:function(b){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});a.onSuccess(b)}.createDelegate(this),onFailure:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}.createDelegate(this)})}});Ext.namespace("ORYX.Plugins");ORYX.Plugins.AbstractStepThroughPlugin=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:ORYX.I18N.StepThroughPlugin.stepThrough,functionality:this.load.bind(this),group:ORYX.I18N.StepThroughPlugin.group,icon:ORYX.PATH+"images/control_play.png",description:ORYX.I18N.StepThroughPlugin.stepThroughDesc,index:1,toggle:true,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.StepThroughPlugin.undo,functionality:this.undo.bind(this),group:ORYX.I18N.StepThroughPlugin.group,icon:ORYX.PATH+"images/control_rewind.png",description:ORYX.I18N.StepThroughPlugin.undoDesc,index:2,minShape:0,maxShape:0})},showEnabled:function(a,b){if(!(a instanceof ORYX.Core.Shape)){return}else{if(this.isOrSplit(a)){this.showEnabledOrSplit(a);return}}this.showPlayOnShape(a)},showPlayOnShape:function(b){var a;if(b instanceof ORYX.Core.Edge){a={stroke:"green"}}else{a={fill:"green"}}var c=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{title:"Click the element to execute it!","stroke-width":2,stroke:"black",d:"M0,-5 L5,0 L0,5 Z","line-captions":"round"}]);this.showOverlayOnShape(b,a,c)},showOverlayOnShape:function(b,a,c){this.hideOverlayOnShape(b);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a,node:(c?c:null),nodePosition:b instanceof ORYX.Core.Edge?"END":"SE"})},hideOverlayOnShape:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+a.resourceId})},hideOverlays:function(a){var b=this.facade.getCanvas().getChildShapes(true);var c;for(i=0;i<b.size();i++){c=b[i];if(!(a&&this.isStartNode(c))){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+c.resourceId})}}},load:function(a,b){this.initializeLoadButton(a,b);this.togglePlugin(b)},togglePlugin:function(a){if(a){this.initialMarking=[];if(this.getDiagramType()==="epc"){this.prepareInitialMarking()}else{this.startAndCheckSyntax()}}else{this.executionTrace="";this.rdf=undefined;this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT});this.onDeactivate()}if(this.active()){this.callback=this.doMouseUp.bind(this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEUP,this.callback)}else{this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEUP,this.callback);this.callback=undefined}},onDeactivate:function(){this.hideOverlays()},initializeLoadButton:function(b,c){if(this.loadButton!==b){var a=function(d){if(d){this.facade.disableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN)}else{this.facade.enableEvent(ORYX.CONFIG.EVENT_MOUSEDOWN)}}.createDelegate(this);b.on("toggle",function(d,e){a(e)});a(b,c)}this.loadButton=b},active:function(){return this.loadButton?this.loadButton.pressed:false},onSelectionChanged:function(){if(this.active()&&this.facade.getSelection().length>0){this.facade.setSelection([])}},getDiagramType:function(){switch(this.facade.getCanvas().getStencil().namespace()){case"http://b3mn.org/stencilset/epc#":return"epc";case"http://b3mn.org/stencilset/bpmn#":return"bpmn";default:return null}},showUsed:function(b,c){if(!(b instanceof ORYX.Core.Shape)){return}var a;if(b instanceof ORYX.Core.Edge){a={stroke:"mediumslateblue"}}else{a={fill:"mediumslateblue"}}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"st."+b.resourceId});if(c!="-1"&&c!="1"){var d=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{style:"font-size: 16px; font-weight: bold;"},c]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a,node:d,nodePosition:b instanceof ORYX.Core.Edge?"END":"SE"})}else{this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"st."+b.resourceId,shapes:[b],attributes:a})}}});ORYX.Plugins.PetriNetStepThroughPlugin=ORYX.Plugins.AbstractStepThroughPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments)},startAndCheckSyntax:function(){this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,onErrors:function(){Ext.Msg.alert("Syntax Check","Some syntax errors have been found, please correct them!")}.bind(this),onNoErrors:function(){if(this.initializeMarking()){this.firedTransitions=[];this.showEnabledTransition()}else{this.togglePlugin(false)}}.bind(this)})},initializeMarking:function(){var b=function(d,c){if(c==0){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","0")}else{if(c==1){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","1")}else{if(c==2){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","2")}else{if(c==3){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","3")}else{if(c==4){d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","4")}else{var e=parseInt(c,10);if(e&&e>0){d.setProperty("oryx-numberoftokens_text",""+e);d.setProperty("oryx-numberoftokens_drawing","0")}else{d.setProperty("oryx-numberoftokens_text","");d.setProperty("oryx-numberoftokens_drawing","0")}}}}}}};this.getPlaces().each(function(c){if("undefined"==typeof(c._setProperty_monkey)){c._setProperty_monkey=c.setProperty;c.setProperty=function(e,d){if("oryx-numberoftokens"==e){b(c,d)}c._setProperty_monkey.apply(c,arguments)}}});var a=0;this.getPlaces().each(function(c){var d=parseInt(c.properties["oryx-numberoftokens"]);if(isNaN(d)){c.setProperty("oryx-numberoftokens",0)}else{if(d>0){a+=d}}});if(0==a){this.getPlaces().each(function(c){if(c.getIncomingShapes().length==0){c.setProperty("oryx-numberoftokens",1)}});Ext.Msg.show({title:"No Tokens Found",msg:"Current marking of the Petri net doesn't contain any token. Tokens are added to the initial places of the net.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO})}if(a>3){Ext.Msg.show({title:"Too Many Tokens On Place",msg:"Places with more than 3 tokens aren't supported yet. Please avoid this scenario.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING})}return true},doMouseUp:function(c,a){if(!(this.isTransition(a))){return}var b=this.getIncomingNodes(a).all(function(d){return parseInt(d.properties["oryx-numberoftokens"])>0});if(b){this.fireTransition(a)}this.showEnabledTransition()},onDeactivate:function(){this.hideOverlays();while(this.firedTransitions.length!==0){this.undoLastFiredTransition()}this.facade.getCanvas().update();this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT})},fireTransition:function(a){this.firedTransitions.push(a);this.getIncomingNodes(a).each(function(b){this.removeToken(b)}.bind(this));this.getOutgoingNodes(a).each(function(b){this.addToken(b)}.bind(this))},undoLastFiredTransition:function(){var a=this.firedTransitions.pop();if(!a){return}this.getIncomingNodes(a).each(function(b){this.addToken(b)}.bind(this));this.getOutgoingNodes(a).each(function(b){this.removeToken(b)}.bind(this))},removeToken:function(a){a.setProperty("oryx-numberoftokens",parseInt(a.properties["oryx-numberoftokens"])-1)},addToken:function(a){var b=parseInt(a.properties["oryx-numberoftokens"])+1;a.setProperty("oryx-numberoftokens",b);if(b>3){Ext.Msg.show({title:"Too Many Tokens On Place",msg:"Places with more than 3 tokens aren't supported yet. Please avoid this scenario.",buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING})}},showEnabledTransition:function(){this.hideOverlays();this.firedTransitions.each(function(a){this.showUsed(a,"1")}.bind(this));this.getEnabledTransitions().each(function(a){this.showPlayOnShape(a)}.bind(this));this.facade.getCanvas().update()},getTransitions:function(){return this.facade.getCanvas().getChildShapes().select(function(a){return this.isTransition(a)}.bind(this))},isTransition:function(a){return a instanceof ORYX.Core.Shape&&a.getStencil().id().search(/Transition/)>-1},getPlaces:function(){return this.facade.getCanvas().getChildShapes().select(function(a){return a.getStencil().id().search(/Place/)>-1})},getIncomingNodes:function(a){return a.getIncomingShapes().collect(function(b){return b.getIncomingShapes()}).flatten()},getOutgoingNodes:function(a){return a.getOutgoingShapes().collect(function(b){return b.getOutgoingShapes()}).flatten()},getEnabledTransitions:function(){return this.getTransitions().select(function(a){return this.getIncomingNodes(a).all(function(b){return parseInt(b.properties["oryx-numberoftokens"])>0})}.bind(this))},undo:function(){this.undoLastFiredTransition();this.showEnabledTransition()}});ORYX.Plugins.StepThroughPlugin=ORYX.Plugins.AbstractStepThroughPlugin.extend({construct:function(a){this.el=undefined;this.callback=undefined;this.executionTrace="";this.rdf=undefined;arguments.callee.$.construct.apply(this,arguments)},prepareInitialMarking:function(){this.startNodes=[];Ext.each(this.facade.getCanvas().getChildShapes(true),function(a){if(this.isStartNode(a)){this.startNodes.push(a);a.initialMarkingFired=false;this.showPlayOnShape(a);if(a.getOutgoingShapes().size()==1){this.showOverlayOnShape(a.getOutgoingShapes()[0],{stroke:"green"});a.getOutgoingShapes()[0].initialMarking=true}}}.createDelegate(this))},isStartNode:function(a){return(a.getStencil().id().search(/#Event$/)>-1)&&a.getIncomingShapes().length==0&&a.getOutgoingShapes().length==1},isStartArc:function(a){return this.isStartNode(a.getIncomingShapes()[0])},isStartArcOrNode:function(a){return this.isStartNode(a)||this.isStartArc(a)},generateRDF:function(){try{var b=this.getRDFFromDOM();b=!b.startsWith("<?xml")?'<?xml version="1.0" encoding="UTF-8"?>'+b:b}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a)}this.rdf=b},getRDF:function(){if(this.rdf==undefined){this.generateRDF()}return this.rdf},startAndCheckSyntax:function(){this.postExecutionTrace({checkSyntax:true,onlyChangedObjects:false,onSuccess:function(a){if(a.responseText.startsWith("{")){var b=Ext.decode(a.responseText).syntaxErrors;this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.SHOW_ERRORS_EVENT,errors:b})}else{this.showObjectStates(a.responseText)}}.bind(this)})},fireObject:function(a){this.executionTrace+=a+";";if(this.isOrSplit(this.el)){this.executionTrace=this.executionTrace.substring(0,this.executionTrace.length-1);this.executionTrace+="#";var c=new Ext.util.MixedCollection();c.addAll(this.el.getOutgoingShapes());var b=[];c.filter("selectedForOrSplit","true").each(function(d){b.push(d.resourceId)}.createDelegate(this));c.each(function(d){d.selectedForOrSplit=false;this.hideOverlayOnShape(d)}.createDelegate(this));this.executionTrace+=b.join(",")+";"}this.postExecutionTrace({checkSyntax:false,onlyChangedObjects:true,onSuccess:function(d){if(d.responseText!=""){this.showObjectStates(d.responseText)}else{this.removeLastFiredObject()}}.bind(this)})},doMouseUp:function(d,a){if(a instanceof ORYX.Core.Shape){if(a instanceof ORYX.Core.Edge&&this.isOrSplit(a.getIncomingShapes()[0])){this.doMouseUpOnEdgeComingFromOrSplit(a)}else{if(a instanceof ORYX.Core.Edge&&this.getDiagramType()==="epc"&&this.isStartNode(a.getIncomingShapes()[0])){this.doMouseUpOnEdgeComingFromStartNode(a)}else{if(this.getDiagramType()==="epc"&&this.isStartNode(a)){a.initialMarkingFired=true;var c=a.getOutgoingShapes()[0];this.hideOverlayOnShape(c);if(c.initialMarking){this.showUsed(a,"1");this.initialMarking.push(a.resourceId)}else{this.hideOverlayOnShape(a)}var b=true;Ext.each(this.startNodes,function(e){if(!e.initialMarkingFired){b=false}});if(b){this.startAndCheckSyntax()}}else{this.el=a;this.fireObject(this.el.resourceId)}}}}},showObjectStates:function(d){var a=d.split(";");for(i=0;i<a.size();i++){var b=a[i].split(",");if(b.size()<3){continue}var c=this.facade.getCanvas().getChildShapeByResourceId(b[0]);if(b[2]=="t"){this.showEnabled(c,b[1])}else{if(b[1]!="0"){this.showUsed(c,b[1])}else{this.hideOverlayOnShape(c)}}}},doMouseUpOnEdgeComingFromOrSplit:function(b){var a=b.getIncomingShapes()[0];if(b.selectedForOrSplit){this.showOverlayOnShape(b,{stroke:"orange"});var c=new Ext.util.MixedCollection();c.addAll(a.getOutgoingShapes());if(c.filter("selectedForOrSplit","true").length<=1){this.hideOverlayOnShape(a)}}else{this.showOverlayOnShape(b,{stroke:"green"});this.showPlayOnShape(a)}b.selectedForOrSplit=!b.selectedForOrSplit},doMouseUpOnEdgeComingFromStartNode:function(a){a.initialMarking=!a.initialMarking;if(a.initialMarking){this.showOverlayOnShape(a,{stroke:"green"})}else{this.showOverlayOnShape(a,{stroke:"orange"})}},isOrSplit:function(a){return(a.getStencil().id().search(/#(OR_Gateway|OrConnector)$/)>-1)&&(a.getOutgoingShapes().length>1)},showEnabledOrSplit:function(a){Ext.each(a.getOutgoingShapes(),function(b){Ext.apply(b,{selectedForOrSplit:false});this.showOverlayOnShape(b,{stroke:"orange"})}.createDelegate(this))},removeLastFiredObject:function(){this.executionTrace=this.executionTrace.replace(/[^;]*;$/,"")},undo:function(){if(!this.active()){return}if(this.executionTrace!==""){this.removeLastFiredObject();this.postExecutionTrace({checkSyntax:false,onlyChangedObjects:false,onSuccess:function(a){this.hideOverlays(true);this.showObjectStates(a.responseText)}.bind(this)})}else{if(this.getDiagramType()==="epc"){this.hideOverlays();this.prepareInitialMarking()}}},postExecutionTrace:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.StepThroughPlugin.executing});new Ajax.Request(ORYX.CONFIG.STEP_THROUGH,{method:"POST",asynchronous:false,parameters:{rdf:this.getRDF(),checkSyntax:a.checkSyntax,fire:this.executionTrace,onlyChangedObjects:a.onlyChangedObjects,initialMarking:this.initialMarking.join(";")},onSuccess:function(b){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});a.onSuccess(b)}.createDelegate(this),onFailure:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}.createDelegate(this)})}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.XFormsExport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.XFormsSerialization.exportXForms,functionality:this.exportXForms.bind(this),group:ORYX.I18N.XFormsSerialization.group,icon:ORYX.PATH+"images/xforms_export.png",description:ORYX.I18N.XFormsSerialization.exportXFormsDesc,index:2,minShape:0,maxShape:0})},exportXForms:function(){this._showCssDialog()},exportIt:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE});window.setTimeout((function(){this.exportSynchronously(a);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}).bind(this),10);return true},exportSynchronously:function(b){var d=location.href;try{var c=this.getRDFFromDOM();c=c.startsWith("<?xml")?c:'<?xml version="1.0" encoding="UTF-8"?>'+c;new Ajax.Request(ORYX.CONFIG.XFORMS_EXPORT_URL,{method:"POST",asynchronous:false,parameters:{resource:d,data:c,css:b},onSuccess:function(e){var f=window.open("data:text/xml,"+e.responseText,"_blank","resizable=yes,width=640,height=480,toolbar=0,scrollbars=yes")}})}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a)}},checkClientXFormsSupport:function(){if(!clientSupportsXForms){var a=ORYX.I18N.XFormsSerialization.noClientXFormsSupportDesc;var b=new Ext.Window({width:320,height:240,resizable:false,minimizable:false,modal:true,autoScroll:true,title:ORYX.I18N.XFormsSerialization.noClientXFormsSupport,html:a,buttons:[{text:ORYX.I18N.XFormsSerialization.ok,handler:function(){b.hide()}}]});b.show()}},_showCssDialog:function(a){var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.XFormsSerialization.selectCss,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -30"}]});var b=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.XFormsSerialization.expTitle,height:150,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[c],buttons:[{text:ORYX.I18N.XFormsSerialization.ok,handler:function(){this.exportIt(c.items.items[1].getValue());b.hide()}.bind(this)},{text:ORYX.I18N.XFormsSerialization.close,handler:function(){b.hide()}.bind(this)}]});b.on("hide",function(){b.destroy(true);delete b});b.show()}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.XFormsExportOrbeon=ORYX.Plugins.AbstractPlugin.extend({CSS_URL:ORYX.PATH+"/css/xforms_default.css",facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:"Run XForm with Orbeon",functionality:this.exportIt.bind(this),group:ORYX.I18N.XFormsSerialization.group,icon:ORYX.PATH+"images/xforms_orbeon_export.png",description:"XForms export for Orbeon",index:1,minShape:0,maxShape:0})},exportIt:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE});window.setTimeout((function(){this.exportSynchronously();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}).bind(this),10);return true},exportSynchronously:function(){var c=location.href;try{var b=this.getRDFFromDOM();b=b.startsWith("<?xml")?b:'<?xml version="1.0" encoding="UTF-8"?>'+b;new Ajax.Request(ORYX.CONFIG.XFORMS_EXPORT_ORBEON_URL,{method:"POST",asynchronous:false,parameters:{resource:c,data:b,css:this.CSS_URL},onSuccess:function(d){var e=window.open("");e.document.write(d.responseText)},onFailure:function(d){var e=window.open("");e.document.write(d.responseText)}})}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a)}},checkClientXFormsSupport:function(){if(!clientSupportsXForms){var a=ORYX.I18N.XFormsSerialization.noClientXFormsSupportDesc;var b=new Ext.Window({width:320,height:240,resizable:false,minimizable:false,modal:true,autoScroll:true,title:ORYX.I18N.XFormsSerialization.noClientXFormsSupport,html:a,buttons:[{text:ORYX.I18N.XFormsSerialization.ok,handler:function(){b.hide()}}]});b.show()}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.XFormsImport=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.XFormsSerialization.importXForms,functionality:this.importXForms.bind(this),group:ORYX.I18N.XFormsSerialization.group,icon:ORYX.PATH+"images/xforms_import.png",description:ORYX.I18N.XFormsSerialization.importXFormsDesc,index:3,minShape:0,maxShape:0})},importXForms:function(){this._showImportDialog()},sendRequest:function(b,d,e,a){var c=false;new Ajax.Request(b,{method:"POST",asynchronous:false,parameters:d,onSuccess:function(f){c=true;if(e){e(f)}}.bind(this),onFailure:function(f){if(a){a()}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.XFormsSerialization.impFailed);ORYX.log.warn("Import XForms failed: "+transport.responseText)}}.bind(this)});return c},throwWarning:function(a){Ext.MessageBox.show({title:ORYX.I18N.Oryx.title,msg:a,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})},_showImportDialog:function(a){var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.XFormsSerialization.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.XFormsSerialization.file,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var b=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.XFormsSerialization.impTitle,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[c],buttons:[{text:ORYX.I18N.XFormsSerialization.impButton,handler:function(){var d=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.XFormsSerialization.impProgress});d.show();window.setTimeout(function(){var f=c.items.items[2].getValue();var e={resource:location.href,data:f};this.sendRequest(ORYX.CONFIG.XFORMS_IMPORT_URL,e,function(g){this.facade.importJSON(g.responseText);d.hide();b.hide()}.bind(this))}.bind(this),100)}.bind(this)},{text:ORYX.I18N.XFormsSerialization.close,handler:function(){b.hide()}.bind(this)}]});b.on("hide",function(){b.destroy(true);delete b});b.show();c.items.items[1].getEl().dom.addEventListener("change",function(d){var e=d.target.files[0].getAsBinary();c.items.items[2].setValue(e)},true)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.RowLayouting={construct:function(a){this.facade=a;this.currentShapes=[];this.toMoveShapes=[];this.dragBounds=undefined;this.offSetPosition={x:0,y:0};this.evCoord={x:0,y:0};this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LAYOUT_ROWS,this.handleLayoutRows.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this))},onSelectionChanged:function(a){var c=a.elements;if(!c||c.length==0){this.currentShapes=[];this.toMoveShapes=[];this.dragBounds=undefined}else{this.currentShapes=c;this.toMoveShapes=this.facade.getCanvas().getShapesWithSharedParent(c);this.toMoveShapes=this.toMoveShapes.findAll(function(d){return d instanceof ORYX.Core.Node&&(d.dockers.length===0||!c.member(d.dockers.first().getDockedShape()))});var b=undefined;c.each(function(d){if(!b){b=d.absoluteBounds()}else{b.include(d.absoluteBounds())}});this.dragBounds=b}return},handleMouseDown:function(c,b){if(!this.dragBounds||!this.toMoveShapes.member(b)){return}var d=this.facade.eventCoordinates(c);var a=this.dragBounds.upperLeft();this.offSetPosition={x:d.x-a.x,y:d.y-a.y};return},handleLayoutRows:function(p){var b=p.shape;var k=this.offSetPosition;var o=p.marginLeft;var d=p.marginTop;var r=p.spacingX;var q=p.spacingY;var l=p.shape.getChildShapes(false);var n=this.toMoveShapes;n.each(function(u){if(l.include(u)){u.bounds.moveBy(k)}});if(p.exclude){l=l.filter(function(u){return !p.exclude.some(function(v){return u.getStencil().id()==v})})}var c=d;var s=d-q;if(p.horizontalLayout){l.each(function(v){var u=v.bounds.upperLeft();v.bounds.moveTo(u.x,c)})}else{if(p.verticalLayout){l.each(function(v){var u=v.bounds.upperLeft();v.bounds.moveTo(o,u.y)})}}l=l.sortBy(function(u){return u.bounds.upperLeft().y});var e=0;var f=0;var m=false;l.each(function(y){var x=y.bounds.upperLeft();var u=y.bounds.lowerRight();var w=x.x;var v=x.y;var A=u.x;var z=u.y;if(n.include(y)){x.y-=f;if((x.y>s)||((y==l.first())&&x.y<d)){m=false;c=s+q;if(x.y<c){m=true}}}else{x.y+=e;x.y-=f;if(x.y>c){m=false;c=s+q}}x.y=c;u.y=x.y+y.bounds.height();if(u.y>s){if(m){e+=u.y-s}else{if(n.include(y)){e+=u.y-s}}s=u.y}if((x.x!=w)||(x.y!=v)||(u.x!=A)||(u.y!=z)){if(!n.include(y)){if((v-x.y)>f){f=v-x.y}}y.bounds.set(x.x,x.y,u.x,u.y)}});l=l.sortBy(function(u){return u.bounds.upperLeft().y*10000+u.bounds.upperLeft().x});c=d;var a=o-r;var t=a;var h=0;l.each(function(y){var x=y.bounds.upperLeft();var u=y.bounds.lowerRight();var w=x.x;var v=x.y;var A=u.x;var z=u.y;if(x.y>c){c=x.y;a=o-r}x.x=a+r;u.x=x.x+y.bounds.width();a=u.x;if(a>t){t=a}if(u.y>h){h=u.y}if((x.x!=w)||(x.y!=v)||(u.x!=A)||(u.y!=z)){y.bounds.set(x.x,x.y,u.x,u.y)}});if(p.shape!=this.facade.getCanvas()){var g=p.shape.bounds.upperLeft();if(t>o){p.shape.bounds.set(g.x,g.y,g.x+t+o,g.y+s+d)}}else{if(t>this.facade.getCanvas().bounds.width()){this.facade.getCanvas().setSize({width:(t+o),height:this.facade.getCanvas().bounds.height()})}if(h>this.facade.getCanvas().bounds.height()){this.facade.getCanvas().setSize({width:this.facade.getCanvas().bounds.width(),height:(s+d)})}}return}};ORYX.Plugins.RowLayouting=Clazz.extend(ORYX.Plugins.RowLayouting);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.XForms={construct:function(a){this.facade=a;this.facade.registerOnEvent("layout.xforms.label",this.handleLayoutLabel.bind(this));this.facade.registerOnEvent("layout.xforms.label.button",this.handleLayoutLabelButton.bind(this));this.facade.registerOnEvent("layout.xforms.label.item",this.handleLayoutLabelItem.bind(this));this.facade.registerOnEvent("layout.xforms.item",this.handleLayoutItem.bind(this));this.facade.registerOnEvent("layout.xforms.case",this.handleLayoutCase.bind(this));this.facade.registerOnEvent("layout.xforms.action",this.handleLayoutAction.bind(this))},handleLayoutLabel:function(d){var a=d.shape;var c=d.moveX;var b=d.moveY;var e=a.getChildNodes(false).findAll(function(f){return(f.getStencil().id()==="http://b3mn.org/stencilset/xforms#Label")});if(e.length>0){e.each(function(g){var h=g.bounds.upperLeft();var f=g.bounds.lowerRight();h.y=-g.bounds.height()+b;f.y=b;h.x=c;f.x=g.bounds.width()+c;g.bounds.set(h,f)})}},handleLayoutLabelButton:function(b){var a=b.shape;var c=a.getChildNodes(false).findAll(function(d){return(d.getStencil().id()==="http://b3mn.org/stencilset/xforms#Label")});if(c.length>0){c.each(function(e){var g=e.bounds.upperLeft();var d=e.bounds.lowerRight();g.y=2;d.y=2+e.bounds.height();if((a.bounds.width()-4)<e.bounds.width()){var h=a.bounds.upperLeft();var f=a.bounds.lowerRight();f.x=h.x+e.bounds.width()+4;a.bounds.set(h,f)}g.x=(a.bounds.width()-4-e.bounds.width())*0.5;d.x=g.x+e.bounds.width();e.bounds.set(g,d)})}},handleLayoutItem:function(e){var b=e.shape;var a=b.getChildNodes(false).findAll(function(h){return((h.getStencil().id()==="http://b3mn.org/stencilset/xforms#Item")||(h.getStencil().id()==="http://b3mn.org/stencilset/xforms#Choices")||(h.getStencil().id()==="http://b3mn.org/stencilset/xforms#Itemset"))});if(a.length>0){a=a.sortBy(function(h){return h.bounds.upperLeft().y});var d=b.bounds.width();var c=0;a.each(function(l){var k=l.bounds.upperLeft();var h=l.bounds.lowerRight();if(l.getStencil().id()==="http://b3mn.org/stencilset/xforms#Choices"){k.y=c+25;c+=25}else{k.y=c+5;c+=5}h.y=k.y+l.bounds.height();c+=l.bounds.height();k.x=30;h.x=d;l.bounds.set(k,h)});var g=b.bounds.upperLeft();b.bounds.set(g.x,g.y,b.bounds.lowerRight().x,g.y+c+5)}var f=b.getChildNodes(false).findAll(function(h){return(h.getStencil().id()==="http://b3mn.org/stencilset/xforms#Label")});if(f.length>0){f.each(function(k){var l=k.bounds.upperLeft();var h=k.bounds.lowerRight();l.y=-k.bounds.height()-1;h.y=-1;l.x=0;h.x=k.bounds.width();k.bounds.set(l,h)})}},handleLayoutCase:function(e){var a=e.shape;var d=a.getChildNodes(false);var c=0;d.each(function(g){if(g.bounds.width()>c){c=g.bounds.width()}});if(d.length>0){d=d.sortBy(function(g){return g.bounds.upperLeft().y});var b=5;d.each(function(k){var h=k.bounds.upperLeft();var g=k.bounds.lowerRight();h.y=b;g.y=h.y+k.bounds.height();b+=k.bounds.height()+5;h.x=0;g.x=c;k.bounds.set(h,g)});var f=a.bounds.upperLeft();a.bounds.set(f.x,f.y,f.x+c,f.y+b+20)}},handleLayoutLabelItem:function(b){var a=b.shape;var c=a.getChildNodes(false).findAll(function(d){return(d.getStencil().id()==="http://b3mn.org/stencilset/xforms#Label")});if(c.length>0){c.each(function(e){var f=e.bounds.upperLeft();var d=e.bounds.lowerRight();f.y=2;f.x=2;d.y=2+e.bounds.height();d.x=2+e.bounds.width();e.bounds.set(f,d)})}},handleLayoutAction:function(d){var a=d.shape;var e=a.getChildNodes(false);if(e.length>0){e=e.sortBy(function(g){return g.bounds.upperLeft().y});var c=5;e.each(function(k){var h=k.bounds.upperLeft();var g=k.bounds.lowerRight();h.y=c;g.y=h.y+k.bounds.height();c+=k.bounds.height()+5;h.x=2;g.x=2+k.bounds.width();k.bounds.set(h,g)});var f=a.bounds.upperLeft();var b=a.bounds.lowerRight();a.bounds.set(f.x,f.y,b.x,f.y+c+15)}}};ORYX.Plugins.XForms=Clazz.extend(ORYX.Plugins.XForms);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPMN11={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED,this.handleDockerDocked.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent("layout.bpmn11.pool",this.handleLayoutPool.bind(this));this.facade.registerOnEvent("layout.bpmn11.subprocess",this.handleSubProcess.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.afterLoad.bind(this))},afterLoad:function(){this.facade.getCanvas().getChildNodes().each(function(a){if(a.getStencil().id().endsWith("Pool")){this.handleLayoutPool({shape:a})}}.bind(this))},onSelectionChanged:function(c){if(c.elements&&c.elements.length===1){var a=c.elements[0];if(a.getStencil().idWithoutNs()==="Pool"){if(a.getChildNodes().length===0){var b={type:"http://b3mn.org/stencilset/bpmn1.1#Lane",position:{x:0,y:0},namespace:a.getStencil().namespace(),parent:a};this.facade.createShape(b);this.facade.getCanvas().update()}}}},hashedSubProcesses:{},handleSubProcess:function(b){var a=b.shape;if(!this.hashedSubProcesses[a.resourceId]){this.hashedSubProcesses[a.resourceId]=a.bounds.clone();return}var c=a.bounds.upperLeft();c.x-=this.hashedSubProcesses[a.resourceId].upperLeft().x;c.y-=this.hashedSubProcesses[a.resourceId].upperLeft().y;this.hashedSubProcesses[a.resourceId]=a.bounds.clone();this.moveChildDockers(a,c)},moveChildDockers:function(a,b){if(!b.x&&!b.y){return}a.getChildNodes(true).map(function(c){return[].concat(c.getIncomingShapes()).concat(c.getOutgoingShapes())}).flatten().uniq().map(function(c){return c.dockers.length>2?c.dockers.slice(1,c.dockers.length-1):[]}).flatten().each(function(c){if(c.isChanged){return}c.bounds.moveBy(b)})},handleDockerDocked:function(c){var d=c.parent;var b=c.target;if(d.getStencil().id()==="http://b3mn.org/stencilset/bpmn1.1#SequenceFlow"){var a=b.getStencil().groups().find(function(e){if(e=="Gateways"){return e}});if(!a&&(d.properties["oryx-conditiontype"]=="Expression")){d.setProperty("oryx-showdiamondmarker",true)}else{d.setProperty("oryx-showdiamondmarker",false)}this.facade.getCanvas().update()}},handlePropertyChanged:function(c){var b=c.elements;var d=c.key;var a=c.value;var e=false;b.each(function(g){if((g.getStencil().id()==="http://b3mn.org/stencilset/bpmn1.1#SequenceFlow")&&(d==="oryx-conditiontype")){if(a!="Expression"){g.setProperty("oryx-showdiamondmarker",false)}else{var h=g.getIncomingShapes();if(!h){g.setProperty("oryx-showdiamondmarker",true)}var f=h.find(function(k){var l=k.getStencil().groups().find(function(m){if(m=="Gateways"){return m}});if(l){return l}});if(!f){g.setProperty("oryx-showdiamondmarker",true)}else{g.setProperty("oryx-showdiamondmarker",false)}}e=true}});if(e){this.facade.getCanvas().update()}},hashedPoolPositions:{},hashedLaneDepth:{},hashedBounds:{},handleLayoutPool:function(b){var k=b.shape;var m=this.facade.getSelection();var l=m.first();if(l instanceof ORYX.Core.UIObject){l=l.isParent(k)?l:k}else{l=k}if(!(l.getStencil().id().endsWith("Pool")||l.getStencil().id().endsWith("Lane"))){return}if(!this.hashedBounds[k.resourceId]){this.hashedBounds[k.resourceId]={}}this.currentPool=k;var d=this.getLanes(k);if(d.length<=0){return}if(d.length===1&&this.getLanes(d.first()).length<=0){d.first().setProperty("oryx-showcaption",d.first().properties["oryx-name"].trim().length>0)}else{d.invoke("setProperty","oryx-showcaption",true)}var c=this.getLanes(k,true);var g=[];var h=[];var f=-1;while(++f<c.length){if(!this.hashedBounds[k.resourceId][c[f].resourceId]){h.push(c[f])}}if(h.length>0){l=h.first()}var a=$H(this.hashedBounds[k.resourceId]).keys();var f=-1;while(++f<a.length){if(!c.any(function(o){return o.resourceId==a[f]})){g.push(this.hashedBounds[k.resourceId][a[f]]);m=m.without(function(o){return o.resourceId==a[f]})}}var n,e;if(g.length>0||h.length>0){n=this.updateHeight(k);e=this.adjustWidth(d,k.bounds.width());k.update()}else{if(k==l){n=this.adjustHeight(d,undefined,k.bounds.height());e=this.adjustWidth(d,k.bounds.width())}else{n=this.adjustHeight(d,l);e=this.adjustWidth(d,l.bounds.width()+(this.getDepth(l,k)*30))}}this.setDimensions(k,e,n);this.updateDockers(c,k);this.hashedBounds[k.resourceId]={};var f=-1;while(++f<c.length){this.hashedBounds[k.resourceId][c[f].resourceId]=c[f].absoluteBounds();this.hashedLaneDepth[c[f].resourceId]=this.getDepth(c[f],k);this.forceToUpdateLane(c[f])}this.hashedPoolPositions[k.resourceId]=k.bounds.clone()},forceToUpdateLane:function(a){if(a.bounds.height()!==a._svgShapes[0].height){a.isChanged=true;a.isResized=true;a._update()}},getDepth:function(c,b){var a=0;while(c&&c.parent&&c!==b){c=c.parent;++a}return a},updateDepth:function(b,a,c){var d=(a-c)*30;b.getChildNodes().each(function(e){e.bounds.moveBy(d,0);[].concat(children[j].getIncomingShapes()).concat(children[j].getOutgoingShapes())})},setDimensions:function(c,d,a){var b=c.getStencil().id().endsWith("Lane");c.bounds.set(b?30:c.bounds.a.x,c.bounds.a.y,d?c.bounds.a.x+d-(b?30:0):c.bounds.b.x,a?c.bounds.a.y+a:c.bounds.b.y)},setLanePosition:function(a,b){a.bounds.moveTo(30,b)},adjustWidth:function(a,b){(a||[]).each(function(c){this.setDimensions(c,b);this.adjustWidth(this.getLanes(c),b-30)}.bind(this));return b},adjustHeight:function(d,f,b){var g=0;if(!f&&b){var e=-1;while(++e<d.length){g+=d[e].bounds.height()}}var e=-1;var a=0;while(++e<d.length){if(d[e]===f){this.adjustHeight(this.getLanes(d[e]),undefined,d[e].bounds.height());d[e].bounds.set({x:30,y:a},{x:d[e].bounds.width()+30,y:d[e].bounds.height()+a})}else{if(!f&&b){var c=(d[e].bounds.height()*b)/g;this.adjustHeight(this.getLanes(d[e]),undefined,c);this.setDimensions(d[e],null,c);this.setLanePosition(d[e],a)}else{var c=this.adjustHeight(this.getLanes(d[e]),f,b);if(!c){c=d[e].bounds.height()}this.setDimensions(d[e],null,c);this.setLanePosition(d[e],a)}}a+=d[e].bounds.height()}return a},updateHeight:function(b){var c=this.getLanes(b);if(c.length==0){return b.bounds.height()}var a=0;var d=-1;while(++d<c.length){this.setLanePosition(c[d],a);a+=this.updateHeight(c[d])}this.setDimensions(b,null,a);return a},getOffset:function(a,c,b){var e={x:0,y:0};var e=a.absoluteXY();var d=this.hashedBounds[b.resourceId][a.resourceId]||(c===true?this.hashedPoolPositions[a.resourceId]:undefined);if(d){e.x-=d.upperLeft().x;e.y-=d.upperLeft().y}else{return{x:0,y:0}}return e},getNextLane:function(a){while(a&&!a.getStencil().id().endsWith("Lane")){if(a instanceof ORYX.Core.Canvas){return null}a=a.parent}return a},getParentPool:function(a){while(a&&!a.getStencil().id().endsWith("Pool")){if(a instanceof ORYX.Core.Canvas){return null}a=a.parent}return a},updateDockers:function(x,r){var o=r.absoluteBounds();var q=(this.hashedPoolPositions[r.resourceId]||o).clone();var w=-1,v=-1,u=-1,t=-1,s;var y={};while(++w<x.length){if(!this.hashedBounds[r.resourceId][x[w].resourceId]){continue}var f=x[w].getChildNodes();var m=x[w].absoluteBounds();var c=(this.hashedBounds[r.resourceId][x[w].resourceId]||m);var g=this.getOffset(x[w],true,r);var d=0;var z=this.getDepth(x[w],r);if(this.hashedLaneDepth[x[w].resourceId]!==undefined&&this.hashedLaneDepth[x[w].resourceId]!==z){d=(this.hashedLaneDepth[x[w].resourceId]-z)*30;g.x+=d}v=-1;while(++v<f.length){if(d){f[v].bounds.moveBy(d,0)}if(f[v].getStencil().id().endsWith("Subprocess")){this.moveChildDockers(f[v],g)}var b=[].concat(f[v].getIncomingShapes()).concat(f[v].getOutgoingShapes()).findAll(function(k){return k instanceof ORYX.Core.Edge});u=-1;while(++u<b.length){if(b[u].getStencil().id().endsWith("MessageFlow")){this.layoutEdges(f[v],[b[u]],g);continue}t=-1;while(++t<b[u].dockers.length){s=b[u].dockers[t];if(s.getDockedShape()||s.isChanged){continue}pos=s.bounds.center();var a=c.isIncluded(pos);var n=!q.isIncluded(pos);var e=t==0?a:c.isIncluded(b[u].dockers[t-1].bounds.center());var h=t==b[u].dockers.length-1?a:c.isIncluded(b[u].dockers[t+1].bounds.center());if(a){y[s.id]={docker:s,offset:g}}}}}}w=-1;var p=$H(y).keys();while(++w<p.length){y[p[w]].docker.bounds.moveBy(y[p[w]].offset)}},moveBy:function(b,a){b.x+=a.x;b.y+=a.y;return b},getHashedBounds:function(a){return this.currentPool&&this.hashedBounds[this.currentPool.resourceId][a.resourceId]?this.hashedBounds[this.currentPool.resourceId][a.resourceId]:a.bounds.clone()},getLanes:function(a,c){var b=a.getChildNodes(c||false).findAll(function(d){return(d.getStencil().id()==="http://b3mn.org/stencilset/bpmn1.1#Lane")});b=b.sort(function(e,d){var f=Math.round(e.bounds.upperLeft().y);var g=Math.round(d.bounds.upperLeft().y);if(f==g){f=Math.round(this.getHashedBounds(e).upperLeft().y);g=Math.round(this.getHashedBounds(d).upperLeft().y)}return f<g?-1:(f>g?1:0)}.bind(this));return b},handleLayoutPool_deprecated:function(c){var l=c.shape;var d=l.getChildNodes(false).findAll(function(t){return(t.getStencil().id()==="http://b3mn.org/stencilset/bpmn1.1#Lane")});if(d.length>0){if(d.length==1){var r=d.first().getChildNodes(false).findAll(function(t){return(t.getStencil().id()==="http://b3mn.org/stencilset/bpmn1.1#Lane")});if(r.length>0){d.first().setProperty("oryx-showcaption",true)}else{if(d.first().properties["oryx-name"].trim().length>0){d.first().setProperty("oryx-showcaption",true)}else{d.first().setProperty("oryx-showcaption",false)}var o=d.first();var g=o.bounds.upperLeft();g.x=30;g.y=0;var s=o.bounds.lowerRight();s.x=l.bounds.width();s.y=l.bounds.height();return}}else{d.each(function(t){t.setProperty("oryx-showcaption",true)})}d=d.sortBy(function(t){return t.bounds.upperLeft().y});var h=l.bounds.width();d.each(function(t){if(t.isChanged){h=t.bounds.width()+30}});var k=d.clone();var m=1;do{var b=new Array();var q=d.findAll(function(t){var u=t.getChildNodes(false).findAll(function(v){return(v.getStencil().id()==="http://b3mn.org/stencilset/bpmn1.1#Lane")});if(u.length>0){b=b.concat(u);return true}});var a=l.bounds.upperLeft();b.each(function(t){var u=t.bounds.upperLeft();var v=t.bounds.lowerRight();v.x=h-30*m;t.bounds.set(u,v)});d=b.clone();m++}while(q.length>0);var f=0;var p=0;var e=[];k.each(function(t){var v=t.bounds.upperLeft();var u=t.bounds.lowerRight();v.y=f;u.y=v.y+t.bounds.height();f+=t.bounds.height();v.x=30;u.x=h;e.push({x:v.x-t.bounds.upperLeft().x,y:v.y-t.bounds.upperLeft().y});t.bounds.set(v,u)}.bind(this));this.handleDockers(k,e);var n=l.bounds.upperLeft();l.bounds.set(n.x,n.y,n.x+h,n.y+f)}},handleLayoutLane:function(f){var a=f.shape;var b=a.getChildNodes(false).findAll(function(h){return(h.getStencil().id()==="http://b3mn.org/stencilset/bpmn1.1#Lane")});if(b.length>0){b=b.sortBy(function(h){return h.bounds.upperLeft().y});var e=a.bounds.width();b.each(function(h){if(h.isChanged){e=h.bounds.width()+30}});var c=0;var d=0;b.each(function(h){var l=h.bounds.upperLeft();var k=h.bounds.lowerRight();l.y=c;k.y=l.y+h.bounds.height();c+=h.bounds.height();l.x=30;k.x=e;var m={x:l.x-h.bounds.upperLeft().x,y:l.y-h.bounds.upperLeft().y};this.handleChildNodes(h.getChildNodes(true),m);h.bounds.set(l,k)}.bind(this));var g=a.bounds.upperLeft();a.bounds.set(g.x,g.y,g.x+e,g.y+c)}},handleDockers:function(a,c){var m=-1,h=-1,e=-1,d=-1,g;while(++m<a.length){var b=a[m].getChildNodes(true);h=-1;while(++h<b.length){var f=[].concat(b[h].getIncomingShapes()).concat(b[h].getOutgoingShapes()).findAll(function(k){return k instanceof ORYX.Core.Edge});e=-1;while(++e<f.length){d=-1;while(++d<f[e].dockers.length){g=f[e].dockers[d];pos=g.bounds.center();pos.x+=c[m].x;pos.y+=c[m].y;if(!a.any(function(k){return k!=a[m]&&k.absoluteBounds().isIncluded(pos)})){g.bounds.moveBy({x:0,y:-c[m].y})}}}}}},handleChildNodes:function(c,h){return;var e=-1,d=-1,b=-1,g;var f=[];while(++e<c.length){var a=[].concat(c[e].getIncomingShapes()).concat(c[e].getOutgoingShapes()).findAll(function(k){return k instanceof ORYX.Core.Edge&&!f.include(k)});if(a.length<=0){continue}f=f.concat(a);this.layoutEdges(c[e],a,h);if(h.x!==0){d=-1;while(++d<f.length){b=-1;while(++b<f[d].dockers.length){g=f[d].dockers[b];if(g.getDockedShape()){continue}g.bounds.moveBy({x:-h.x,y:-h.y})}}}}}};ORYX.Plugins.BPMN11=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN11);if(!ORYX){ORYX=new Object()}if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BpmnLayouter=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:"Layout-BPMN",description:"Layout BPMN Model",functionality:this.layout.bind(this),group:"Layout",icon:ORYX.PATH+"images/auto_layout.png",index:1,minShape:0,maxShape:0})},layout:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Layouting.doing});new Ajax.Request(ORYX.CONFIG.BPMN_LAYOUTER,{method:"POST",asynchronous:false,parameters:{data:this.facade.getSerializedJSON(),output:"coordinatesonly"},onFailure:function(a){Ext.Msg.alert("Layouting Error","Error while layouting:!\n"+a.responseText);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})},onSuccess:function(b){var a=ORYX.Core.Command.extend({construct:function(f,e){this.layoutArray=f;this.plugin=e;this.oldLayoutArray=[]},execute:function(){this.layoutArray.each(function(h){var e=this.plugin.facade.getCanvas().getChildShapeByResourceId(h.id);var g={id:h.id,bounds:e.bounds.clone()};this.oldLayoutArray.push(g);var f=h.bounds.split(" ");e.bounds.set(f[0],f[1],f[2],f[3]);if(h.dockers!=null){this.plugin.setDockersBad(e,h.dockers)}e.update()}.bind(this));this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()},rollback:function(){this.oldLayoutArray.each(function(f){var e=this.plugin.facade.getCanvas().getChildShapeByResourceId(f.id);e.bounds.set(f.bounds);e.update()}.bind(this));this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()}});var d=b.responseText.evalJSON();if(d instanceof Array&&d.size()>0){var c=new a(d,this);this.facade.executeCommands([c])}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}.bind(this)})},setDockersBad:function(c,a){var b="";a.each(function(d){b+=d.x+" "+d.y+" "});b+=" # ";c.deserialize([{prefix:"oryx",name:"dockers",value:b}])},setDockersGood:function(c,a){if(elem.dockers.length==1){}else{var a=c.getDockers().slice(1,-1);a.each(function(f){c.removeDocker(f)});var e=c.getDockers()[0];if(e.getDockedShape()){e.setReferencePoint(elem.dockers[0])}else{e.bounds.moveTo(elem.dockers[0].x,elem.dockers[0].y)}e.refresh();var d=c.getDockers()[1];if(d.getDockedShape()){d.setReferencePoint(elem.dockers[elem.dockers.length-1])}else{d.bounds.moveTo(elem.dockers[elem.dockers.length-1].x,elem.dockers[elem.dockers.length-1].y)}d.refresh();var b=elem.dockers.slice(1,-1);b.each(function(g){var f=c.createDocker(undefined,g);f.parent=c;f.bounds.centerMoveTo(g.x,g.y);f.update()})}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPMN2_0={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED,this.handleDockerDocked.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent("layout.bpmn2_0.pool",this.handleLayoutPool.bind(this));this.facade.registerOnEvent("layout.bpmn2_0.subprocess",this.handleSubProcess.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.afterLoad.bind(this))},afterLoad:function(){this.facade.getCanvas().getChildNodes().each(function(a){if(a.getStencil().id().endsWith("Pool")){this.handleLayoutPool({shape:a})}}.bind(this))},onSelectionChanged:function(c){if(c.elements&&c.elements.length===1){var a=c.elements[0];if(a.getStencil().idWithoutNs()==="Pool"){if(a.getChildNodes().length===0){var b={type:"http://b3mn.org/stencilset/bpmn2.0#Lane",position:{x:0,y:0},namespace:a.getStencil().namespace(),parent:a};this.facade.createShape(b);this.facade.getCanvas().update()}}}},hashedSubProcesses:{},handleSubProcess:function(b){var a=b.shape;if(!this.hashedSubProcesses[a.resourceId]){this.hashedSubProcesses[a.resourceId]=a.bounds.clone();return}var c=a.bounds.upperLeft();c.x-=this.hashedSubProcesses[a.resourceId].upperLeft().x;c.y-=this.hashedSubProcesses[a.resourceId].upperLeft().y;this.hashedSubProcesses[a.resourceId]=a.bounds.clone();this.moveChildDockers(a,c)},moveChildDockers:function(a,b){if(!b.x&&!b.y){return}a.getChildNodes(true).map(function(c){return[].concat(c.getIncomingShapes()).concat(c.getOutgoingShapes())}).flatten().uniq().map(function(c){return c.dockers.length>2?c.dockers.slice(1,c.dockers.length-1):[]}).flatten().each(function(c){if(c.isChanged){return}c.bounds.moveBy(b)})},handleDockerDocked:function(c){var d=c.parent;var b=c.target;if(d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#SequenceFlow"){var a=b.getStencil().groups().find(function(e){if(e=="Gateways"){return e}});if(!a&&(d.properties["oryx-conditiontype"]=="Expression")){d.setProperty("oryx-showdiamondmarker",true)}else{d.setProperty("oryx-showdiamondmarker",false)}this.facade.getCanvas().update()}},handlePropertyChanged:function(c){var b=c.elements;var d=c.key;var a=c.value;var e=false;b.each(function(g){if((g.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#SequenceFlow")&&(d==="oryx-conditiontype")){if(a!="Expression"){g.setProperty("oryx-showdiamondmarker",false)}else{var h=g.getIncomingShapes();if(!h){g.setProperty("oryx-showdiamondmarker",true)}var f=h.find(function(k){var l=k.getStencil().groups().find(function(m){if(m=="Gateways"){return m}});if(l){return l}});if(!f){g.setProperty("oryx-showdiamondmarker",true)}else{g.setProperty("oryx-showdiamondmarker",false)}}e=true}});if(e){this.facade.getCanvas().update()}},hashedPoolPositions:{},hashedLaneDepth:{},hashedBounds:{},handleLayoutPool:function(b){var k=b.shape;var n=this.facade.getSelection();var l=n.first();l=l||k;this.currentPool=k;if(!(l.getStencil().id().endsWith("Pool")||l.getStencil().id().endsWith("Lane"))){return}if(!this.hashedBounds[k.resourceId]){this.hashedBounds[k.resourceId]={}}var d=this.getLanes(k);if(d.length<=0){return}if(d.length===1&&this.getLanes(d.first()).length<=0){d.first().setProperty("oryx-showcaption",d.first().properties["oryx-name"].trim().length>0);var m=d.first().node.getElementsByTagName("rect");m[0].setAttributeNS(null,"display","none")}else{d.invoke("setProperty","oryx-showcaption",true);d.each(function(p){var q=p.node.getElementsByTagName("rect");q[0].removeAttributeNS(null,"display")})}var c=this.getLanes(k,true);var h=[];var g=[];var f=-1;while(++f<c.length){if(!this.hashedBounds[k.resourceId][c[f].resourceId]){g.push(c[f])}}if(g.length>0){l=g.first()}var a=$H(this.hashedBounds[k.resourceId]).keys();var f=-1;while(++f<a.length){if(!c.any(function(p){return p.resourceId==a[f]})){h.push(this.hashedBounds[k.resourceId][a[f]]);n=n.without(function(p){return p.resourceId==a[f]})}}var o,e;if(h.length>0||g.length>0){o=this.updateHeight(k);e=this.adjustWidth(d,k.bounds.width());k.update()}else{if(k==l){o=this.adjustHeight(d,undefined,k.bounds.height());e=this.adjustWidth(d,k.bounds.width())}else{o=this.adjustHeight(d,l);e=this.adjustWidth(d,l.bounds.width()+(this.getDepth(l,k)*30))}}this.setDimensions(k,e,o);this.updateDockers(c,k);this.hashedBounds[k.resourceId]={};var f=-1;while(++f<c.length){this.hashedBounds[k.resourceId][c[f].resourceId]=c[f].absoluteBounds();this.hashedLaneDepth[c[f].resourceId]=this.getDepth(c[f],k);this.forceToUpdateLane(c[f])}this.hashedPoolPositions[k.resourceId]=k.bounds.clone()},forceToUpdateLane:function(a){if(a.bounds.height()!==a._svgShapes[0].height){a.isChanged=true;a.isResized=true;a._update()}},getDepth:function(c,b){var a=0;while(c&&c.parent&&c!==b){c=c.parent;++a}return a},updateDepth:function(b,a,c){var d=(a-c)*30;b.getChildNodes().each(function(e){e.bounds.moveBy(d,0);[].concat(children[j].getIncomingShapes()).concat(children[j].getOutgoingShapes())})},setDimensions:function(c,d,a){var b=c.getStencil().id().endsWith("Lane");c.bounds.set(b?30:c.bounds.a.x,c.bounds.a.y,d?c.bounds.a.x+d-(b?30:0):c.bounds.b.x,a?c.bounds.a.y+a:c.bounds.b.y)},setLanePosition:function(a,b){a.bounds.moveTo(30,b)},adjustWidth:function(a,b){(a||[]).each(function(c){this.setDimensions(c,b);this.adjustWidth(this.getLanes(c),b-30)}.bind(this));return b},adjustHeight:function(d,f,b){var g=0;if(!f&&b){var e=-1;while(++e<d.length){g+=d[e].bounds.height()}}var e=-1;var a=0;while(++e<d.length){if(d[e]===f){this.adjustHeight(this.getLanes(d[e]),undefined,d[e].bounds.height());d[e].bounds.set({x:30,y:a},{x:d[e].bounds.width()+30,y:d[e].bounds.height()+a})}else{if(!f&&b){var c=(d[e].bounds.height()*b)/g;this.adjustHeight(this.getLanes(d[e]),undefined,c);this.setDimensions(d[e],null,c);this.setLanePosition(d[e],a)}else{var c=this.adjustHeight(this.getLanes(d[e]),f,b);if(!c){c=d[e].bounds.height()}this.setDimensions(d[e],null,c);this.setLanePosition(d[e],a)}}a+=d[e].bounds.height()}return a},updateHeight:function(b){var c=this.getLanes(b);if(c.length==0){return b.bounds.height()}var a=0;var d=-1;while(++d<c.length){this.setLanePosition(c[d],a);a+=this.updateHeight(c[d])}this.setDimensions(b,null,a);return a},getOffset:function(a,c,b){var e={x:0,y:0};var e=a.absoluteXY();var d=this.hashedBounds[b.resourceId][a.resourceId]||(c===true?this.hashedPoolPositions[a.resourceId]:undefined);if(d){e.x-=d.upperLeft().x;e.y-=d.upperLeft().y}else{return{x:0,y:0}}return e},getNextLane:function(a){while(a&&!a.getStencil().id().endsWith("Lane")){if(a instanceof ORYX.Core.Canvas){return null}a=a.parent}return a},getParentPool:function(a){while(a&&!a.getStencil().id().endsWith("Pool")){if(a instanceof ORYX.Core.Canvas){return null}a=a.parent}return a},updateDockers:function(x,r){var o=r.absoluteBounds();var q=(this.hashedPoolPositions[r.resourceId]||o).clone();var w=-1,v=-1,u=-1,t=-1,s;var y={};while(++w<x.length){if(!this.hashedBounds[r.resourceId][x[w].resourceId]){continue}var f=x[w].getChildNodes();var m=x[w].absoluteBounds();var c=(this.hashedBounds[r.resourceId][x[w].resourceId]||m);var g=this.getOffset(x[w],true,r);var d=0;var z=this.getDepth(x[w],r);if(this.hashedLaneDepth[x[w].resourceId]!==undefined&&this.hashedLaneDepth[x[w].resourceId]!==z){d=(this.hashedLaneDepth[x[w].resourceId]-z)*30;g.x+=d}v=-1;while(++v<f.length){if(d){f[v].bounds.moveBy(d,0)}if(f[v].getStencil().id().endsWith("Subprocess")){this.moveChildDockers(f[v],g)}var b=[].concat(f[v].getIncomingShapes()).concat(f[v].getOutgoingShapes()).findAll(function(k){return k instanceof ORYX.Core.Edge});u=-1;while(++u<b.length){if(b[u].getStencil().id().endsWith("MessageFlow")){this.layoutEdges(f[v],[b[u]],g);continue}t=-1;while(++t<b[u].dockers.length){s=b[u].dockers[t];if(s.getDockedShape()||s.isChanged){continue}pos=s.bounds.center();var a=c.isIncluded(pos);var n=!q.isIncluded(pos);var e=t==0?a:c.isIncluded(b[u].dockers[t-1].bounds.center());var h=t==b[u].dockers.length-1?a:c.isIncluded(b[u].dockers[t+1].bounds.center());if(a){y[s.id]={docker:s,offset:g}}}}}}w=-1;var p=$H(y).keys();while(++w<p.length){y[p[w]].docker.bounds.moveBy(y[p[w]].offset)}},moveBy:function(b,a){b.x+=a.x;b.y+=a.y;return b},getHashedBounds:function(a){return this.currentPool&&this.hashedBounds[this.currentPool.resourceId][a.resourceId]?this.hashedBounds[this.currentPool.resourceId][a.resourceId]:a.bounds.clone()},getLanes:function(a,c){var b=a.getChildNodes(c||false).findAll(function(d){return(d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#Lane")});b=b.sort(function(e,d){var f=Math.round(e.bounds.upperLeft().y);var g=Math.round(d.bounds.upperLeft().y);if(f==g){f=Math.round(this.getHashedBounds(e).upperLeft().y);g=Math.round(this.getHashedBounds(d).upperLeft().y)}return f<g?-1:(f>g?1:0)}.bind(this));return b}};ORYX.Plugins.BPMN2_0=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN2_0);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPMN2CONVERSATION={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DRAGDOCKER_DOCKED,this.handleDockerDocked.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SHAPE_MENU_CLOSE,this.handleDragDrop.bind(this))},checkForMultiInstance:function(b){var c=b.getIncomingShapes();var d=b.getOutgoingShapes();var a=b.properties["oryx-multiinstance"];if(c){c.find(function(e){if(e.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#ConversationLink"){if(a){e.setProperty("oryx-showforkend",true)}else{e.setProperty("oryx-showforkend",false)}}})}if(d){d.find(function(e){if(e.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#ConversationLink"){if(a){e.setProperty("oryx-showforkstart",true)}else{e.setProperty("oryx-showforkstart",false)}}})}},handleDockerDocked:function(b){var c=b.parent;var a=b.target;if(c.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#ConversationLink"){if(a.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(a);this.facade.getCanvas().update()}}},handlePropertyChanged:function(b){var a=b.elements;var c=false;a.each(function(d){if(d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(d);c=true}}.bind(this));if(c){this.facade.getCanvas().update()}},handleDragDrop:function(b){var c=b.source;var a=b.destination;var d=false;c.each(function(e){if(e.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(e);d=true}}.bind(this));a.each(function(e){if(e.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Communication"){var f=e.getOutgoingShapes();if(f){f.each(function(g){var h=g.getTarget();if(h){if(h.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(h);d=true}}}.bind(this))}}if(e.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0conversation#Participant"){this.checkForMultiInstance(e);d=true}}.bind(this));if(d){this.facade.getCanvas().update()}}};ORYX.Plugins.BPMN2CONVERSATION=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN2CONVERSATION);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Bpmn2_0Choreography={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_STENCIL_SET_LOADED,this.handleStencilSetLoaded.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,function(){if(!this._eventsRegistered){this.handleStencilSetLoaded({});this.afterLoad()}}.bind(this));this.participantSize=20;this.extensionSizeForMarker=10;this.choreographyTasksMeta=new Hash();this._isLayoutEnabled=false},handleStencilSetLoaded:function(a){if(a.lazyLoaded){this._isLayoutEnabled=true}if(this.isStencilSetExtensionLoaded("http://oryx-editor.org/stencilsets/extensions/bpmn2.0choreography#")){this.registerPluginOnEvents()}else{this.unregisterPluginOnEvents()}},registerPluginOnEvents:function(){this._eventsRegistered=true;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this.addParticipantsOnCreation.bind(this));this.facade.registerOnEvent("layout.bpmn2_0.choreography.task",this.handleLayoutChoreographyTask.bind(this));this.facade.registerOnEvent("layout.bpmn2_0.choreography.subprocess.expanded",this.handleLayoutChoreographySubprocessExpanded.bind(this));this.facade.registerOnEvent("layout.bpmn2_0.choreography.subprocess.collapsed",this.handleLayoutChoreographySubprocessCollapsed.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.afterLoad.bind(this))},unregisterPluginOnEvents:function(){this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_LOADED,this.afterLoad.bind(this))},afterLoad:function(a){this._isLayoutEnabled=true;this.facade.getCanvas().getChildNodes(true).each(function(d){if(!(d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#ChoreographyTask"||d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#ChoreographySubprocessCollapsed"||d.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#ChoreographySubprocessExpanded")){return}var h=new Array();var g=new Array();var k=this.addOrGetChoreographyTaskMeta(d);var f=d.getChildNodes(false).findAll(function(l){return l.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#ChoreographyParticipant"});f=f.sort(function(m,l){var n=Math.round(m.absoluteBounds().upperLeft().y);var o=Math.round(l.absoluteBounds().upperLeft().y);return n<o?-1:(n>o?1:0)});var c=0;var e=0;var b=0;f.each(function(m){m.isResizable=false;var l=(m.properties["oryx-multiple_instance"]===""?false:m.properties["oryx-multiple_instance"]);if(m.bounds.upperLeft().y==c){h.push(m);c=m.bounds.lowerRight().y;if(l){e++}}else{g.push(m);if(l){b++}}});k.numOfParticipantsOnTop=h.length;k.numOfParticipantsOnBottom=g.length;k.numOfParticipantsExtendedOnBottom=b;k.numOfParticipantsExtendedOnTop=e;k.bottomYStartValue=(g.first()?g.first().bounds.upperLeft().y:d.bounds.height());k.topYEndValue=(h.last()?h.last().bounds.lowerRight().y:0);k.center=k.topYEndValue+(k.bottomYStartValue-k.topYEndValue)/2;k.oldHeight=d.bounds.height();k.oldBounds=d.bounds.clone();k.topParticipants=h;k.bottomParticipants=g;d.isChanged=true}.bind(this));this.facade.getCanvas().update()},handleLayoutChoreographySubprocessExpanded:function(b){if(!this._isLayoutEnabled){return}var e=b.shape;var f=this.addOrGetChoreographyTaskMeta(e);var d=e.bounds.height()/e._oldBounds.height();var a=e._labels[e.getId()+"text_name"];if(a){var c=f.topYEndValue+5;if(e.isResized&&d){a.y=c/d}else{a.y=c}}},handleLayoutChoreographySubprocessCollapsed:function(b){if(!this._isLayoutEnabled){return}var d=b.shape;var e=this.addOrGetChoreographyTaskMeta(d);var a=d._svgShapes.find(function(f){return f.element.id==d.getId()+"plus_marker"});var c=d._svgShapes.find(function(f){return f.element.id==d.getId()+"plus_marker_border"});if(a&&c){a._isYLocked=true;a.y=e.bottomYStartValue-12;c._isYLocked=true;c.y=e.bottomYStartValue-14}},addParticipantsOnCreation:function(f){if(!this._isLayoutEnabled){return}var b=f.elements[0];if(b&&f.elements.length===1&&b._stencil&&!b.initialParticipantsAdded&&(b.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#ChoreographyTask"||b.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#ChoreographySubprocessCollapsed"||b.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#ChoreographySubprocessExpanded")){var e=b.getChildNodes().find(function(h){return(h.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#ChoreographyParticipant")});if(e){return}var d={type:"http://b3mn.org/stencilset/bpmn2.0#ChoreographyParticipant",position:{x:0,y:0},namespace:b.getStencil().namespace(),parent:b};var c=this.facade.createShape(d);c.setProperty("oryx-initiating",true);var g={elements:[c],key:"oryx-initiating",value:true};this.handlePropertyChanged(g);var a={type:"http://b3mn.org/stencilset/bpmn2.0#ChoreographyParticipant",position:{x:0,y:b.bounds.lowerRight().y},namespace:b.getStencil().namespace(),parent:b};this.facade.createShape(a);this.facade.getCanvas().update();this.facade.setSelection([b]);b.initialParticipantsAdded=true}},addOrGetChoreographyTaskMeta:function(a){if(!this.choreographyTasksMeta[a.getId()]){this.choreographyTasksMeta[a.getId()]=new Object();this.choreographyTasksMeta[a.getId()].numOfParticipantsOnTop=0;this.choreographyTasksMeta[a.getId()].numOfParticipantsOnBottom=0;this.choreographyTasksMeta[a.getId()].numOfParticipantsExtendedOnBottom=0;this.choreographyTasksMeta[a.getId()].numOfParticipantsExtendedOnTop=0;this.choreographyTasksMeta[a.getId()].bottomYStartValue=a.bounds.height();this.choreographyTasksMeta[a.getId()].topYEndValue=0;this.choreographyTasksMeta[a.getId()].center=a.bounds.height()/2;this.choreographyTasksMeta[a.getId()].oldHeight=a.bounds.height();this.choreographyTasksMeta[a.getId()].oldBounds=a.bounds.clone();this.choreographyTasksMeta[a.getId()].topParticipants=new Array();this.choreographyTasksMeta[a.getId()].bottomParticipants=new Array()}return this.choreographyTasksMeta[a.getId()]},handleResizingOfChoreographyTask:function(g,h){if(g.bounds.height()==h.oldHeight){return}var c=h.numOfParticipantsOnTop*this.participantSize+h.numOfParticipantsExtendedOnTop*this.extensionSizeForMarker+h.numOfParticipantsOnBottom*this.participantSize+h.numOfParticipantsExtendedOnBottom*this.extensionSizeForMarker+40;if(c>g.bounds.height()){var e=g.bounds.upperLeft();var d=h.oldBounds.upperLeft();var b=g.bounds.lowerRight();var a=h.oldBounds.lowerRight();if(e.y!=d.y){g.bounds.set(e.x,b.y-c,b.x,b.y)}else{if(b.y!=a.y){g.bounds.set(e.x,e.y,b.x,e.y+c)}}}var f=h.oldHeight-g.bounds.height();h.bottomYStartValue-=f;return true},handleLayoutChoreographyTask:function(event){if(!this._isLayoutEnabled){return}var choreographyTask=event.shape;var isNew=!this.choreographyTasksMeta[choreographyTask.getId()];var choreographyTaskMeta=this.addOrGetChoreographyTaskMeta(choreographyTask);var isResized=this.handleResizingOfChoreographyTask(choreographyTask,choreographyTaskMeta);var oldCountTop=choreographyTaskMeta.numOfParticipantsOnTop;var oldCountBottom=choreographyTaskMeta.numOfParticipantsOnBottom;if(isResized){var participants=choreographyTaskMeta.topParticipants}else{var participants=this.getParticipants(choreographyTask,true,false);if(!participants){return}this.ensureParticipantsParent(choreographyTask,participants)}var numOfParticipantsExtended=0;participants.each(function(participant,i){participant.isResizable=false;participant.setProperty("oryx-corners","None");var isExtended=this.setBoundsOfParticipantDependOnProperties(participant,i,numOfParticipantsExtended,choreographyTask.bounds.width(),0);if(isExtended){numOfParticipantsExtended++}if(i==0){participant.setProperty("oryx-corners","Top")}this.adjustTopBackground(participant)}.bind(this));var resizeFactor=participants.length-choreographyTaskMeta.numOfParticipantsOnTop;var resizeFactorExtended=numOfParticipantsExtended-choreographyTaskMeta.numOfParticipantsExtendedOnTop;var bounds=choreographyTask.bounds;var ul=bounds.upperLeft();var lr=bounds.lowerRight();if(!isNew){bounds.set(ul.x,ul.y-resizeFactor*this.participantSize-resizeFactorExtended*this.extensionSizeForMarker,lr.x,lr.y)}choreographyTaskMeta.topYEndValue=participants.length*this.participantSize+numOfParticipantsExtended*this.extensionSizeForMarker;choreographyTaskMeta.numOfParticipantsExtendedOnTop=numOfParticipantsExtended;choreographyTaskMeta.numOfParticipantsOnTop=participants.length;choreographyTaskMeta.topParticipants=participants;if(isResized){var participants=choreographyTaskMeta.bottomParticipants}else{var participants=this.getParticipants(choreographyTask,false,true);if(!participants){return}this.ensureParticipantsParent(choreographyTask,participants)}if(isNew){choreographyTaskMeta.bottomYStartValue=(bounds.height()-(participants.length!=0?eval(participants.map(function(p){return this.participantSize+(this.isExtended(p)?this.extensionSizeForMarker:0)}.bind(this)).join("+")):0))}else{choreographyTaskMeta.bottomYStartValue+=resizeFactor*this.participantSize+resizeFactorExtended*this.extensionSizeForMarker}var bottomStartYValue=choreographyTaskMeta.bottomYStartValue;var numOfParticipantsExtended=0;participants.each(function(participant,i){participant.isResizable=false;participant.setProperty("oryx-corners","None");var isExtendedParticipant=this.setBoundsOfParticipantDependOnProperties(participant,i,numOfParticipantsExtended,choreographyTask.bounds.width(),bottomStartYValue);if(isExtendedParticipant){numOfParticipantsExtended++}if(i==participants.length-1){participant.setProperty("oryx-corners","Bottom")}this.adjustTopBackground(participant)}.bind(this));var resizeFactor=participants.length-choreographyTaskMeta.numOfParticipantsOnBottom;var resizeFactorExtended=numOfParticipantsExtended-choreographyTaskMeta.numOfParticipantsExtendedOnBottom;var bounds=choreographyTask.bounds;var ul=bounds.upperLeft();var lr=bounds.lowerRight();if(!isNew){bounds.set(ul.x,ul.y,lr.x,lr.y+resizeFactor*this.participantSize+resizeFactorExtended*this.extensionSizeForMarker)}choreographyTaskMeta.numOfParticipantsExtendedOnBottom=numOfParticipantsExtended;choreographyTaskMeta.numOfParticipantsOnBottom=participants.length;choreographyTaskMeta.bottomParticipants=participants;var participantsHasChanged=oldCountTop!==choreographyTaskMeta.numOfParticipantsOnTop||oldCountBottom!==choreographyTaskMeta.numOfParticipantsOnBottom;this.ensureCenterPositionOfMagnets(choreographyTask,isResized,participantsHasChanged);this.adjustTextFieldAndMarkerPosition(choreographyTask);choreographyTaskMeta.oldHeight=bounds.height();choreographyTaskMeta.oldBounds=bounds.clone()},isExtended:function(a){return(!a||a.properties["oryx-multiple_instance"]===""?false:!!a.properties["oryx-multiple_instance"])},setBoundsOfParticipantDependOnProperties:function(b,d,g,e,f){var a=this.isExtended(b);var h=f+d*this.participantSize+g*this.extensionSizeForMarker;var c=f+this.participantSize+d*this.participantSize+(a?(g+1)*this.extensionSizeForMarker:g*this.extensionSizeForMarker);b.bounds.set(0,h,e,c);return a},adjustTextFieldAndMarkerPosition:function(f){var g=this.addOrGetChoreographyTaskMeta(f);var e=f.bounds.height()/f._oldBounds.height();var d=f._labels[f.getId()+"text_name"];if(d){var a=g.topYEndValue+(g.bottomYStartValue-g.topYEndValue)/2;if(f.isResized&&e){d.y=a/e}else{d.y=a}}var c=f._svgShapes.find(function(h){return h.element.id==f.getId()+"loop_path"});if(c){c._isYLocked=true;c.y=g.bottomYStartValue-7}var b=f._svgShapes.find(function(h){return h.element.id==f.getId()+"mi_path"});if(b){b._isYLocked=true;b.y=g.bottomYStartValue-11}},ensureCenterPositionOfMagnets:function(d,l,c){var f=this.addOrGetChoreographyTaskMeta(d);var a=f.topYEndValue+(f.bottomYStartValue-f.topYEndValue)/2;var b=a-f.center;var g=d.bounds.height()/f.oldBounds.height();if(!b&&!g){return}var h=d.magnets.findAll(function(n){return(!n.anchorTop&&!n.anchorBottom)});h.each(function(o){var n=o.bounds.center().x;var p=(o.bounds.center().y+b)/g;o.bounds.centerMoveTo(n,p)});var e=d.absoluteBounds().upperLeft().y+f.topYEndValue;var k=d.absoluteBounds().upperLeft().y+f.bottomYStartValue;var m=new Array();d.incoming.each(function(n){if(!(n instanceof ORYX.Core.Edge)){return}var o=n.dockers.last();if(e<=o.bounds.center().y&&o.bounds.center().y<=k){m.push(o)}});d.outgoing.each(function(n){if(!(n instanceof ORYX.Core.Edge)){return}var o=n.dockers.first();if(e<=o.bounds.center().y&&o.bounds.center().y<=k){m.push(o)}});if(c&&d.initialParticipantsAdded){m.each(function(n){var o=n.referencePoint;n.setReferencePoint({x:o.x,y:(o.y+b)/g})})}f.center=a},ensureParticipantsParent:function(a,b){if(!a||!b){return}b.each(function(c){if(c.parent.getId()==a.getId()){return}c.parent.remove(c);a.add(c)})},getParticipants:function(b,h,e){if(b.getStencil().id()!=="http://b3mn.org/stencilset/bpmn2.0#ChoreographyTask"&&b.getStencil().id()!=="http://b3mn.org/stencilset/bpmn2.0#ChoreographySubprocessCollapsed"&&b.getStencil().id()!=="http://b3mn.org/stencilset/bpmn2.0#ChoreographySubprocessExpanded"){return null}var g=this.addOrGetChoreographyTaskMeta(b);var a=b.absoluteBounds().upperLeft().y+g.topYEndValue+(g.bottomYStartValue-g.topYEndValue)/2;var f=b.getChildNodes(true).findAll(function(k){return(h&&k.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#ChoreographyParticipant"&&k.absoluteBounds().center().y<=a&&this.isParticipantOfShape(b,k))}.bind(this));var d=b.getChildNodes(true).findAll(function(k){return(e&&k.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#ChoreographyParticipant"&&k.absoluteBounds().center().y>a&&this.isParticipantOfShape(b,k))}.bind(this));var c=f.concat(d);c=c.sort(function(l,k){var m=Math.round(l.absoluteBounds().upperLeft().y);var n=Math.round(k.absoluteBounds().upperLeft().y);return m<n?-1:(m>n?1:0)});return c},isParticipantOfShape:function(b,a){var c=a.parent;while(c.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#ChoreographyParticipant"){c=c.parent}return c.getId()===b.getId()},adjustTopBackground:function(a){var d=a.properties["oryx-corners"];var b=$(a.getId()+"roundedBgRect");if(!b){return}if(d==="Top"){b.setAttributeNS(null,"fill","url(#"+a.getId()+"background_top) white")}else{var c=a.properties["oryx-color"];b.setAttributeNS(null,"fill",c)}},handlePropertyChanged:function(c){var b=c.elements;var d=c.key||c.name;var a=c.value;var e=false;b.each(function(f){if(f.getStencil().id()==="http://b3mn.org/stencilset/bpmn2.0#ChoreographyParticipant"&&d==="oryx-initiating"){if(!a){f.setProperty("oryx-color","#acacac")}else{f.setProperty("oryx-color","#ffffff")}e=true}});if(e){this.facade.getCanvas().update()}}};ORYX.Plugins.Bpmn2_0Choreography=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.Bpmn2_0Choreography);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPMN2_0Serialization={bpmnSerializationHandlerUrl:ORYX.CONFIG.ROOT_PATH+"bpmn2_0serialization",bpmnDeserializationHandlerUrl:ORYX.CONFIG.ROOT_PATH+"bpmn2_0deserialization",bpmn2XpdlSerializationHandlerUrl:ORYX.CONFIG.ROOT_PATH+"bpmn2xpdlserialization",construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.Bpmn2_0Serialization.show,functionality:this.showBpmnXml.bind(this),group:"Export",dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/source.png",description:ORYX.I18N.Bpmn2_0Serialization.showDesc,index:0,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.Bpmn2_0Serialization.download,functionality:this.downloadBpmnXml.bind(this),group:"Export",dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/source.png",description:ORYX.I18N.Bpmn2_0Serialization.downloadDesc,index:0,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.Bpmn2_0Serialization.xpdlShow,functionality:this.showXpdl.bind(this),group:"Export",dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/source.png",description:ORYX.I18N.Bpmn2_0Serialization.xpdlShowDesc,index:0,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.Bpmn2_0Serialization.xpdlDownload,functionality:this.downloadXpdl.bind(this),group:"Export",dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/source.png",description:ORYX.I18N.Bpmn2_0Serialization.xpdlDownloadDesc,index:0,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.Bpmn2_0Serialization["import"],functionality:this.showImportDialog.bind(this),group:"Export",dropDownGroupIcon:ORYX.PATH+"images/import.png",icon:ORYX.PATH+"images/source.png",description:ORYX.I18N.Bpmn2_0Serialization.importDesc,index:0,minShape:0,maxShape:0})},showBpmnXml:function(){this.generateBpmnXml(function(a){var b=a.evalJSON();this.showSchemaValidationEvent(b.validationEvents);this.openXMLWindow(b.xml)}.bind(this),this.bpmnSerializationHandlerUrl)},downloadBpmnXml:function(){this.generateBpmnXml(function(a){var b=a.evalJSON();this.showSchemaValidationEvent(b.validationEvents);this.openDownloadWindow("model.bpmn",b.xml)}.bind(this),this.bpmnSerializationHandlerUrl)},showSchemaValidationEvent:function(a){if(a&&ORYX.CONFIG.BPMN20_SCHEMA_VALIDATION_ON){this._showErrorMessageBox("Validation",a)}},showXpdl:function(){this.generateBpmnXml(function(a){this.openXMLWindow(a)}.bind(this),this.bpmn2XpdlSerializationHandlerUrl)},downloadXpdl:function(){this.generateBpmnXml(function(a){this.openDownloadWindow("model.xpdl",a)}.bind(this),this.bpmn2XpdlSerializationHandlerUrl)},generateBpmnXml:function(c,d){var b=new Ext.LoadMask(Ext.getBody(),{msg:"Serialization of BPMN 2.0 model"});b.show();var a=this.facade.getSerializedJSON();this._sendRequest(d,"POST",{data:a},function(e){c(e);b.hide()}.bind(this),function(e){b.hide();this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.Bpmn2_0Serialization.serialFailed);ORYX.log.warn("Serialization of BPMN 2.0 model failed: "+e.responseText)}.bind(this))},showImportDialog:function(a){var c=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.Bpmn2_0Serialization.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.Bpmn2_0Serialization.file,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var b=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.Bpmn2_0Serialization.name,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[c],buttons:[{text:ORYX.I18N.Bpmn2_0Serialization.btnImp,handler:function(){var d=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.Bpmn2_0Serialization.progress});d.show();window.setTimeout(function(){var f=c.items.items[2].getValue();try{this._sendRequest(this.bpmnDeserializationHandlerUrl,"POST",{data:f},function(g){this.facade.importJSON(g,true);b.close()}.bind(this),function(g){d.hide();this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.Bpmn2_0Serialization.serialFailed);ORYX.log.warn("Serialization of BPMN 2.0 model failed: "+g.responseText)}.bind(this))}catch(e){Ext.Msg.alert(ORYX.I18N.Bpmn2_0Serialization.error,e.message)}finally{d.hide()}}.bind(this),100)}.bind(this)},{text:ORYX.I18N.Bpmn2_0Serialization.btnClose,handler:function(){b.close()}.bind(this)}]});b.show();c.items.items[1].getEl().dom.addEventListener("change",function(d){var e=d.target.files[0].getAsText("UTF-8");c.items.items[2].setValue(e)},true)},_sendRequest:function(b,f,d,e,a){var c=false;new Ajax.Request(b,{method:f,asynchronous:false,parameters:d,onSuccess:function(g){c=true;if(e){e(g.responseText)}}.bind(this),onFailure:function(g){if(a){a(g)}else{Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Bpmn2Bpel.transfFailed);ORYX.log.warn("Serialization of BPMN 2.0 model failed: "+g.responseText)}}.bind(this)});return c},_showErrorMessageBox:function(b,a){Ext.MessageBox.show({title:b,msg:a,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}};ORYX.Plugins.BPMN2_0Serialization=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN2_0Serialization);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.TBPMSupport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,canvasId:"ext-gen56",construct:function(b,a){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:ORYX.I18N.TBPMSupport.imp.name,functionality:this.showImportDialog.bind(this),group:ORYX.I18N.TBPMSupport.imp.group,icon:ORYX.PATH+"images/page_white_picture.png",description:ORYX.I18N.TBPMSupport.imp.desc,index:3,minShape:0,maxShape:0});a.properties.each(function(c){if(c.name=="tbpm_recognition_service"){this.tbpmImportServletURL=c.value}}.bind(this))},showImportDialog:function(a){this.form=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",fileUpload:true,enctype:"multipart/form-data",items:[{text:ORYX.I18N.TBPMSupport.imp.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.TBPMSupport.imp.file,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;width:95%",itemCls:"ext_specific_window_overflow"}]});this.dialog=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.TBPMSupport.imp.name,height:150,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[this.form],buttons:[{text:ORYX.I18N.TBPMSupport.imp.btnImp,handler:this.uploadImage.bind(this)},{text:ORYX.I18N.TBPMSupport.imp.btnClose,handler:function(){this.dialog.close()}.bind(this)}]});this.dialog.on("hide",function(){this.dialog.destroy(true);delete this.dialog}.bind(this));this.dialog.show()},uploadImage:function(a,b){this.form.form.submit({url:this.tbpmImportServletURL,clientValidation:true,waitMsg:"Processing picture...",method:"POST",success:function(c,d){this.dialog.hide();this.showConfirmDialog(d.response.responseText)}.bind(this),failure:function(c,d){this.dialog.hide();this.showConfirmDialog(d.response.responseText)}.bind(this)})},showConfirmDialog:function(a){var c=Ext.util.JSON.decode(a);imgUri=c.uri;var b=new Ext.Window({autoCreate:true,layout:"fit",width:600,height:500,bodyStyle:"padding:5px;",autoScroll:true,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,title:ORYX.I18N.TBPMSupport.imp.confirm,html:'<div style="width:100%;"><img src="'+imgUri+'" style="width:550px;"></img></div>',buttons:[{text:ORYX.I18N.TBPMSupport.imp.btnImp,handler:function(){b.close();this.processImport(imgUri,c.model,c.width,c.height)}.bind(this)},{text:ORYX.I18N.TBPMSupport.imp.btnClose,handler:function(){b.close()}.bind(this)}]});b.show()},processImport:function(b,d,e,a){var c=this.facade.getCanvas();this.addImageLayer(b);this.importShapes(d);if(c.bounds.width()<e){c.setSize({width:e+50,height:c.bounds.height()})}if(c.bounds.height()<a){c.setSize({height:a+50,width:c.bounds.width()})}c.update()},addImageLayer:function(a){this.facade.getCanvas().properties["oryx-photo"]=a;$(this.canvasId).style.background="url("+a+") no-repeat scroll 0% 0%"},importShapes:function(a){this.facade.importJSON(a,true);$A($$("rect")).each(function(b){if(b.id.endsWith("bg_frame")){b.setAttributeNS(null,"fill","None");b.setAttributeNS(null,"stroke-width","4")}}.bind(this));this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_TBPM_BACKGROUND_UPDATE})}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.TBPMShapeConnector=Clazz.extend({construct:function(a){this.facade=a;this.active=false;this.sourceNode=null;this.facade.offer({name:ORYX.I18N.TBPMShapeconnctor.name,functionality:this.enableConnector.bind(this),group:ORYX.I18N.TBPMShapeconnctor.group,icon:ORYX.PATH+"images/pencil_go.png",description:ORYX.I18N.TBPMShapeconnctor.desc,index:1,toggle:true,minShape:0,maxShape:0});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this))},enableConnector:function(a,b){this.connectButton=a;if(!b){this.active=false;this.sourceNode=null}else{this.active=true;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.TBPMShapeconnctor.usage})}},handleMouseDown:function(b,a){if(this.active&&a instanceof ORYX.Core.Node){if(this.sourceNode){if(!this.createEdge(this.sourceNode,a)){return}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}this.sourceNode=a}else{if(this.active){if(this.connectButton){this.connectButton.toggle()}}}},createEdge:function(c,e){var a=this.facade.getStencilSets().keys()[0];var b=ORYX.Core.StencilSet.stencil(a+"SequenceFlow");var d=this.facade.getRules().canConnect({sourceShape:c,edgeStencil:b,targetShape:e});var f=new ORYX.Plugins.TBPMShapeConnector.CreateEdge(c,e,b,this.facade);this.facade.executeCommands([f]);return f.edge},});ORYX.Plugins.TBPMShapeConnector.CreateEdge=ORYX.Core.Command.extend({construct:function(c,d,b,a){this.source=c;this.target=d;this.stencil=b;this.facade=a},execute:function(){console.log("execute");var a=new ORYX.Core.Edge({eventHandlerCallback:this.facade.raiseEvent},this.stencil);a.dockers.first().setDockedShape(this.source);a.dockers.first().setReferencePoint({x:this.source.bounds.width()/2,y:this.source.bounds.height()/2});a.dockers.last().setDockedShape(this.target);a.dockers.last().setReferencePoint({x:this.target.bounds.width()/2,y:this.target.bounds.height()/2});this.facade.getCanvas().add(a);this.facade.getCanvas().update();this.edge=a},rollback:function(){this.facade.deleteShape(this.edge);this.facade.getCanvas().update();this.facade.updateSelection()}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.TBPMCanvasMode=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,canvasId:"ext-gen56",fill:"#ffffcc",edited:"RGBA(255,255,255,0.8)",shapeTransform:false,construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:ORYX.I18N.TBPMCanvasMode.name,functionality:this.enableToggle.bind(this),group:ORYX.I18N.TBPMCanvasMode.group,icon:ORYX.PATH+"images/shape_move_backwards.png",description:ORYX.I18N.TBPMCanvasMode.desc,index:1,toggle:true,minShape:0,maxShape:0});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_TBPM_BACKGROUND_UPDATE,this.enableShapeTransform.bind(this))},enableShapeTransform:function(){if(!this.shapeTransform){this.shapeTransform=true;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPERTY_CHANGED,this.updateShapeSVG.bind(this))}},updateShapeSVG:function(b){if(this.shapeTransform){var a=b.elements[0];if(a&&b.name=="oryx-name"&&!a.isEdited){a._svgShapes.each(function(c){if(c.element.id&&c.element.id.endsWith("bg_frame")){c.element.isEdited=true;a.isEdited=true;c.element.setAttributeNS(null,"fill",this.edited)}}.bind(this))}a.refresh();this.facade.getCanvas().update()}},enableToggle:function(a,b){if(b&&$(this.canvasId).getStyle("backgroundImage")){$(this.canvasId).style.background="";$A($$("rect")).each(function(c){if(c.id.endsWith("bg_frame")){c.setAttributeNS(null,"fill",this.fill);c.setAttributeNS(null,"stroke-width","1")}}.bind(this));this.shapeTransform=false}else{if(!b&&this.facade.getCanvas().properties["oryx-photo"]){$(this.canvasId).style.background="url("+this.facade.getCanvas().properties["oryx-photo"]+") no-repeat scroll 0% 0%";$A($$("rect")).each(function(c){if(c.id.endsWith("bg_frame")){if(c.isEdited){c.setAttributeNS(null,"fill",this.edited)}else{c.setAttributeNS(null,"fill","None")}c.setAttributeNS(null,"stroke-width","4")}}.bind(this));this.shapeTransform=true}}}});if(!ORYX.Plugins){ORYX.Plugins={}}if(!ORYX.Plugins.Layouter){ORYX.Plugins.Layouter={}}new function(){ORYX.Plugins.Layouter.EdgeLayouter=ORYX.Plugins.AbstractLayouter.extend({layouted:["http://b3mn.org/stencilset/bpmn1.1#SequenceFlow","http://b3mn.org/stencilset/bpmn1.1#MessageFlow","http://b3mn.org/stencilset/bpmn2.0#MessageFlow","http://b3mn.org/stencilset/bpmn2.0#SequenceFlow","http://b3mn.org/stencilset/bpmn2.0conversation#ConversationLink","http://b3mn.org/stencilset/epc#ControlFlow","http://www.signavio.com/stencilsets/processmap#ProcessLink","http://www.signavio.com/stencilsets/organigram#connection"],layout:function(a){a.each(function(b){this.doLayout(b)}.bind(this))},doLayout:function(b){var d=b.getIncomingNodes()[0];var c=b.getOutgoingNodes()[0];if(!d||!c){return}var a=this.getPositions(d,c,b);if(a.length>0){this.setDockers(b,a[0].a,a[0].b)}},getPositions:function(r,s,e){var u=r.absoluteBounds();var n=s.absoluteBounds();var q=u.center();var o=n.center();var l=u.midPoint();var d=n.midPoint();var k=Object.clone(e.dockers.first().referencePoint);var t=Object.clone(e.dockers.last().referencePoint);var c=e.dockers.first().getAbsoluteReferencePoint();var p=e.dockers.last().getAbsoluteReferencePoint();if(Math.abs(c.x-p.x)<1||Math.abs(c.y-p.y)<1){return[]}var g={};g.x=q.x<o.x?(((o.x-n.width()/2)-(q.x+u.width()/2))/2)+(q.x+u.width()/2):(((q.x-u.width()/2)-(o.x+n.width()/2))/2)+(o.x+n.width()/2);g.y=q.y<o.y?(((o.y-n.height()/2)-(q.y+u.height()/2))/2)+(q.y+u.height()/2):(((q.y-u.height()/2)-(o.y+n.height()/2))/2)+(o.y+n.height()/2);u.widen(5);n.widen(20);var h=[];var f=this.getOffset.bind(this);if(!u.isIncluded(o.x,q.y)&&!n.isIncluded(o.x,q.y)){h.push({a:{x:o.x+f(t,d,"x"),y:q.y+f(k,l,"y")},z:this.getWeight(r,q.x<o.x?"r":"l",s,q.y<o.y?"t":"b",e)})}if(!u.isIncluded(q.x,o.y)&&!n.isIncluded(q.x,o.y)){h.push({a:{x:q.x+f(k,l,"x"),y:o.y+f(t,d,"y")},z:this.getWeight(r,q.y<o.y?"b":"t",s,q.x<o.x?"l":"r",e)})}if(!u.isIncluded(g.x,q.y)&&!n.isIncluded(g.x,o.y)){h.push({a:{x:g.x,y:q.y+f(k,l,"y")},b:{x:g.x,y:o.y+f(t,d,"y")},z:this.getWeight(r,"r",s,"l",e,q.x>o.x)})}if(!u.isIncluded(q.x,g.y)&&!n.isIncluded(o.x,g.y)){h.push({a:{x:q.x+f(k,l,"x"),y:g.y},b:{x:o.x+f(t,d,"x"),y:g.y},z:this.getWeight(r,"b",s,"t",e,q.y>o.y)})}return h.sort(function(v,m){return v.z<m.z?1:(v.z==m.z?-1:-1)})},getOffset:function(c,b,a){return c[a]-b[a]},getWeight:function(m,b,n,a,d,g){b=(b||"").toLowerCase();a=(a||"").toLowerCase();if(!["t","r","b","l"].include(b)){b="r"}if(!["t","r","b","l"].include(a)){b="l"}if(g){b=b=="t"?"b":(b=="r"?"l":(b=="b"?"t":(b=="l"?"r":"r")));a=a=="t"?"b":(a=="r"?"l":(a=="b"?"t":(a=="l"?"r":"r")))}var f=0;var p=this.facade.getRules().getLayoutingRules(m,d)["out"];var o=this.facade.getRules().getLayoutingRules(n,d)["in"];var e=p[b];var c=o[a];var l=function(s,r,q){switch(s){case"t":return Math.abs(r.x-q.x)<2&&r.y<q.y;case"r":return r.x>q.x&&Math.abs(r.y-q.y)<2;case"b":return Math.abs(r.x-q.x)<2&&r.y>q.y;case"l":return r.x<q.x&&Math.abs(r.y-q.y)<2;default:return false}};var k=m.getIncomingShapes().findAll(function(q){return q instanceof ORYX.Core.Edge}).any(function(q){return l(b,q.dockers[q.dockers.length-2].bounds.center(),q.dockers.last().bounds.center())});var h=n.getOutgoingShapes().findAll(function(q){return q instanceof ORYX.Core.Edge}).any(function(q){return l(a,q.dockers[1].bounds.center(),q.dockers.first().bounds.center())});return(k||h?0:e+c)},setDockers:function(e,d,c){if(!e){return}e.dockers.each(function(a){e.removeDocker(a)});[d,c].compact().each(function(b){var a=e.createDocker(undefined,b);a.bounds.centerMoveTo(b)});e.dockers.each(function(a){a.update()});e._update(true)}})}();if(!ORYX){ORYX=new Object()}if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.EPCLayouter=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:"Layout-EPC",description:"Layout EPC Model",functionality:this.layout.bind(this),group:"Layout",icon:ORYX.PATH+"images/auto_layout.png",index:1,minShape:0,maxShape:0})},layout:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Layouting.doing});new Ajax.Request(ORYX.CONFIG.EPC_LAYOUTER,{method:"POST",asynchronous:false,parameters:{data:this.facade.getSerializedJSON()},onFailure:function(a){Ext.Msg.alert("Layouting Error","Error while layouting:!\n"+a.responseText);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})},onSuccess:function(b){var a=ORYX.Core.Command.extend({construct:function(f,e){this.layoutArray=f;this.plugin=e;this.oldLayoutArray=[]},execute:function(){this.layoutArray.each(function(h){var e=this.plugin.facade.getCanvas().getChildShapeByResourceId(h.id);var g={id:h.id,bounds:e.bounds.clone()};this.oldLayoutArray.push(g);var f=h.bounds.split(" ");e.bounds.set(f[0],f[1],f[2],f[3]);if(h.dockers!=null){this.plugin.setDockersBad(e,h.dockers)}e.update()}.bind(this));this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()},rollback:function(){this.oldLayoutArray.each(function(f){var e=this.plugin.facade.getCanvas().getChildShapeByResourceId(f.id);e.bounds.set(f.bounds);e.update()}.bind(this));this.plugin.facade.getCanvas().update();this.plugin.facade.updateSelection()}});var d=b.responseText.evalJSON();if(d instanceof Array&&d.size()>0){var c=new a(d,this);this.facade.executeCommands([c])}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}.bind(this)})},setDockersBad:function(c,a){var b="";a.each(function(d){b+=d.x+" "+d.y+" "});b+=" # ";c.deserialize([{prefix:"oryx",name:"dockers",value:b}])},setDockersGood:function(c,a){if(elem.dockers.length==1){}else{var a=c.getDockers().slice(1,-1);a.each(function(f){c.removeDocker(f)});var e=c.getDockers()[0];if(e.getDockedShape()){e.setReferencePoint(elem.dockers[0])}else{e.bounds.moveTo(elem.dockers[0].x,elem.dockers[0].y)}e.refresh();var d=c.getDockers()[1];if(d.getDockedShape()){d.setReferencePoint(elem.dockers[elem.dockers.length-1])}else{d.bounds.moveTo(elem.dockers[elem.dockers.length-1].x,elem.dockers[elem.dockers.length-1].y)}d.refresh();var b=elem.dockers.slice(1,-1);b.each(function(g){var f=c.createDocker();f.parent=c;f.bounds.centerMoveTo(g.x,g.y);f.update()})}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.TransformationDownloadDialog={construct:function(){},openMessageDialog:function(c,b){var a=new Ext.Window({autoCreate:true,title:c,modal:true,height:120,width:400,collapsible:false,fixedcenter:true,shadow:true,resizable:true,proxyDrag:true,autoScroll:true,buttonAlign:"center",bodyStyle:"padding:10px",html:'<span class="ext-mb-text">'+b+"</span>"});a.addButton("OK",a.hide,a);a.on("hide",function(){a.destroy(true);delete a});a.show()},openErrorDialog:function(b){var c=new Ext.form.TextArea({id:"error-field",fieldLabel:ORYX.I18N.TransformationDownloadDialog.error,name:"desc",height:405,width:633,preventScrollbars:true,value:b,readOnly:true});var a=new Ext.Window({autoCreate:true,title:ORYX.I18N.TransformationDownloadDialog.errorParsing,modal:true,height:450,width:650,collapsible:false,fixedcenter:true,shadow:true,resizable:false,proxyDrag:true,autoScroll:false});a.on("hide",function(){a.destroy(true);c.destroy(true);delete a;delete c});c.render(a.body);a.show()},openResultDialog:function(g){var f=new Ext.data.Store({proxy:new Ext.data.MemoryProxy(g),reader:new Ext.data.ArrayReader({},[{name:"file",type:"string"},{name:"result",type:"string"},{name:"info",type:"string"}])});f.load();var b=function(h){if(h=="success"){return'<span style="color:green;">'+h+"</span>"}else{if(h=="error"){return'<span style="color:red;">'+h+"</span>"}}return h};var a=new Ext.grid.ColumnModel([{id:"file",header:"File",width:200,sortable:false,dataIndex:"file",resizable:false},{header:"Info",width:75,sortable:false,dataIndex:"info",renderer:b,resizable:false}]);var d=new Ext.grid.GridPanel({store:f,cm:a,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),autoWidth:true});var e=new Ext.Toolbar();var c=new Ext.Window({autoCreate:true,title:ORYX.I18N.TransformationDownloadDialog.transResult,autoHeight:true,width:297,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,resizable:false,items:[e,d]});c.on("hide",function(){c.destroy(true);d.destroy(true);delete c;delete d});c.show();e.add({icon:"images/view.png",cls:"x-btn-icon",tooltip:ORYX.I18N.TransformationDownloadDialog.showFile,handler:function(){var l=d.getStore();var k=d.getSelectionModel().getSelected();if(k==undefined){return}var h=k.get("result");if(k.get("info")=="success"){this.openXMLWindow(h)}else{this.openErrorWindow(h)}}.bind(this)});e.add({icon:"images/disk.png",cls:"x-btn-icon",tooltip:ORYX.I18N.TransformationDownloadDialog.downloadFile,handler:function(){var k=d.getStore();var h=d.getSelectionModel().getSelected();if(h==undefined){return}this.openDownloadWindow(h,false)}.bind(this)});e.add({icon:"images/disk_multi.png",cls:"x-btn-icon",tooltip:ORYX.I18N.TransformationDownloadDialog.downloadAll,handler:function(){var h=d.getStore();this.openDownloadWindow(h.getRange(0,h.getCount()),true)}.bind(this)});d.getSelectionModel().selectFirstRow()},openXMLWindow:function(a){var b=window.open("data:application/xml,"+encodeURIComponent([a].join("\r\n")),"_blank","resizable=yes,width=600,height=600,toolbar=0,scrollbars=yes")},openErrorWindow:function(a){var b=window.open("data:text/html,"+encodeURIComponent(["<html><body><pre>"+a+"</pre></body></html>"].join("\r\n")),"_blank","resizable=yes,width=800,height=300,toolbar=0,scrollbars=yes")},createHiddenElement:function(a,b){var c=document.createElement("input");c.name=a;c.type="hidden";c.value=b;return c},addFileExtension:function(a){if((a.toLowerCase()=="topology")||(a=="XPDL4Chor")){return a+".xml"}else{return a+".bpel"}},openDownloadWindow:function(e,d){var f=window.open("");if(f!=null){f.document.open();f.document.write("<html><body>");var a=f.document.createElement("form");f.document.body.appendChild(a);if(d){for(var c=0;c<e.length;c++){var b=this.addFileExtension(e[c].get("file"));a.appendChild(this.createHiddenElement("download_"+c,e[c].get("result")));a.appendChild(this.createHiddenElement("file_"+c,b))}}else{var b=this.addFileExtension(e.get("file"));a.appendChild(this.createHiddenElement("download",e.get("result")));a.appendChild(this.createHiddenElement("file",b))}a.method="POST";f.document.write("</body></html>");f.document.close();a.action="download";a.submit()}},getResultInfo:function(a){if(!a){return"error"}else{if(a.substr(0,5)=="<?xml"){return"success"}}return"error"},getProcessName:function(c){var d=new DOMParser();var b=d.parseFromString(c,"text/xml");var a=b.documentElement.getAttribute("name");return a}};ORYX.Plugins.TransformationDownloadDialog=Clazz.extend(ORYX.Plugins.TransformationDownloadDialog);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.TransformationDownloadDialogForBPEL4Chor={construct:function(){arguments.callee.$.construct.apply(this,arguments)},openResultDialog:function(g){var f=new Ext.data.Store({proxy:new Ext.data.MemoryProxy(g),reader:new Ext.data.ArrayReader({},[{name:"file",type:"string"},{name:"result",type:"string"},{name:"info",type:"string"}])});f.load();var b=function(h){if(h=="success"){return'<span style="color:green;">'+h+"</span>"}else{if(h=="error"){return'<span style="color:red;">'+h+"</span>"}}return h};var a=new Ext.grid.ColumnModel([{id:"file",header:"File",width:200,sortable:false,dataIndex:"file",resizable:false},{header:"Info",width:75,sortable:false,dataIndex:"info",renderer:b,resizable:false}]);var d=new Ext.grid.GridPanel({store:f,cm:a,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),autoWidth:true});var e=new Ext.Toolbar();var c=new Ext.Window({autoCreate:true,title:ORYX.I18N.TransformationDownloadDialog.transResult,autoHeight:true,width:297,modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,resizable:false,items:[e,d]});c.on("hide",function(){c.destroy(true);d.destroy(true);delete c;delete d});c.show();e.add({icon:"images/view.png",cls:"x-btn-icon",tooltip:ORYX.I18N.TransformationDownloadDialog.showFile,handler:function(){var l=d.getStore();var k=d.getSelectionModel().getSelected();if(k==undefined){return}var h=k.get("result");if(k.get("info")=="success"){this.openXMLWindow(h)}else{this.openErrorWindow(h)}}.bind(this)});e.add({icon:"images/disk.png",cls:"x-btn-icon",tooltip:ORYX.I18N.TransformationDownloadDialog.downloadFile,handler:function(){var k=d.getStore();var h=d.getSelectionModel().getSelected();if(h==undefined){return}this.openDownloadWindow(h,false)}.bind(this)});e.add({icon:"images/disk_multi.png",cls:"x-btn-icon",tooltip:ORYX.I18N.TransformationDownloadDialog.downloadAll,handler:function(){var h=d.getStore();this.openDownloadWindow(h.getRange(0,h.getCount()),true)}.bind(this)});d.getSelectionModel().selectFirstRow()},openDownloadWindow:function(f,e){var g=window.open("");if(g!=null){g.document.open();g.document.write("<html><body>");var a=g.document.createElement("form");g.document.body.appendChild(a);try{if(e){for(var d=0;d<f.length;d++){var c=this.addFileExtension(f[d].get("file"));if(c.include("-wsdl")){c=c.replace("-wsdl","")}a.appendChild(this.createHiddenElement("download_"+d,f[d].get("result")));a.appendChild(this.createHiddenElement("file_"+d,c))}}else{var c=this.addFileExtension(f.get("file"));if(c.include("-wsdl")){c=c.replace("-wsdl","")}a.appendChild(this.createHiddenElement("download",f.get("result")));a.appendChild(this.createHiddenElement("file",c))}}catch(b){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,b)}a.method="POST";g.document.write("</body></html>");g.document.close();a.action="download";a.submit()}},addFileExtension:function(a){if(a.include("wsdl")){return a+".wsdl"}else{return a+".bpel"}},getResultInfo:function(a){if(!a){return"error"}else{if(a.substr(0,5)=="<?xml"){return"success"}}return"error"},getBPELName:function(a){var d=new DOMParser();var c=d.parseFromString(a,"text/xml");var b=c.documentElement.getAttribute("name");return b}};ORYX.Plugins.TransformationDownloadDialogForBPEL4Chor=ORYX.Plugins.TransformationDownloadDialog.extend(ORYX.Plugins.TransformationDownloadDialogForBPEL4Chor);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Bpel4ChorTransformation=ORYX.Plugins.AbstractPlugin.extend({dialogSupport:undefined,construct:function(){arguments.callee.$.construct.apply(this,arguments);this.dialogSupport=new ORYX.Plugins.TransformationDownloadDialog();this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.Bpel4ChorTransformation.exportBPEL,functionality:this.transformBPEL4Chor.bind(this),group:ORYX.I18N.Bpel4ChorTransformation.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/export_multi.png",description:ORYX.I18N.Bpel4ChorTransformation.exportBPELDesc,index:1,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.Bpel4ChorTransformation.exportXPDL,functionality:this.transformXPDL4Chor.bind(this),group:ORYX.I18N.Bpel4ChorTransformation.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/export.png",description:ORYX.I18N.Bpel4ChorTransformation.exportXPDLDesc,index:0,minShape:0,maxShape:0});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.propertyChanged.bind(this))},propertyChanged:function(b){var a=b.elements;a.each(function(d){var k=d.getStencil();if(b.propId=="oryx-name"){if((k.id()==k.namespace()+"ReceiveTask")||(k.id()==k.namespace()+"IntermediateMessageEvent")||(k.id()==k.namespace()+"StartMessageEvent")){var h=new Hash();d.getIncomingShapes().each(function(n){if(n.getStencil().id()==n.getStencil().namespace()+"MessageFlow"){var m=n.getIncomingShapes();m.each(function(o){o.getOutgoingShapes().each(function(p){if(p.getStencil().id()==p.getStencil().namespace()+"MessageFlow"){var q=h[o.resourceId];if(q==undefined){q=new Array()}q=q.concat(p.getOutgoingShapes());h[o.resourceId]=q}})})}});var f=null;var c=h.values();for(var g=0;g<c.length;g++){var l=c[g];for(var e=0;e<l.length;e++){var d=l[e];if(f==undefined){f=l[e].properties["oryx-name"]}else{if(f!=l[e].properties["oryx-name"]){this.dialogSupport.openMessageDialog(ORYX.I18N.Bpel4ChorTransformation.warning,ORYX.I18N.Bpel4ChorTransformation.wrongValue.replace(/1/,f));return}}}}}}else{if(b.propId=="oryx-looptype"){if(k.id()==k.namespace()+"ReceiveTask"){d.getIncomingShapes().each(function(n){if(n.getStencil().id()==n.getStencil().namespace()+"SequenceFlow"){var m=n.getIncomingShapes();m.each(function(o){if(o.getStencil().id()==k.namespace()+"Exclusive_Eventbased_Gateway"){if(d.properties["oryx-looptype"]!="None"){this.dialogSupport.openMessageDialog(ORYX.I18N.Bpel4ChorTransformation.warning,ORYX.I18N.Bpel4ChorTransformation.loopNone);return}}})}})}}}})},validate:function(){var a=this.facade.getCanvas().getChildEdges();var e=true;for(var c=0;c<a.size();c++){var d=a[c];var b=d.getStencil().title();var f=d.id;if(d.getIncomingShapes().size()==0){this.showOverlay(d,ORYX.I18N.Bpel4ChorTransformation.noSource.replace(/1/,b).replace(/2/,f));e=false}else{if(d.getOutgoingShapes().size()==0){this.showOverlay(d,ORYX.I18N.Bpel4ChorTransformation.noTarget.replace(/1/,b).replace(/2/,f));e=false}}}return e},addCanvasProperties:function(o){var d=this.facade.getCanvas();var m=o.createAttribute("chor:TargetNamespace");m.value=d.properties["oryx-targetNamespace"];o.documentElement.setAttributeNode(m);var a=o.createAttribute("Name");a.value=d.properties["oryx-name"];o.documentElement.setAttributeNode(a);var g=o.createAttribute("Id");var b=d.properties["oryx-id"];if(b==""){b=DataManager.__provideId()}g.value=b;o.documentElement.setAttributeNode(g);var e=o.createElement("xpdl:Created");var l=document.createTextNode(d.properties["oryx-creationdate"]);e.appendChild(l);var n=o.documentElement.firstChild;n.appendChild(e);var p=d.properties["oryx-expressionlanguage"];var k=d.properties["oryx-querylanguage"];var f=o.createElement("xpdl:RedefinableHeader");if(k!=""){var c=o.createAttribute("chor:QueryLanguage");c.value=k;f.setAttributeNode(c)}if(p!=""){var h=o.createAttribute("chor:ExpressionLanguage");h.value=p;f.setAttributeNode(h)}o.documentElement.insertBefore(f,o.documentElement.firstChild.nextSibling)},buildXPDL4ChorData:function(a){var b=[["XPDL4Chor",a,this.dialogSupport.getResultInfo(a)]];return b},buildDisplayData:function(e){var g={data:[[]],errors:[[]]};var a=0;for(var d=0;d<e.length;d++){var b;if(e[d].type=="PROCESS"){b=e[d].name}else{b=e[d].type.toLowerCase()}var k;var f;if(e[d].success){k="success";f=e[d].document}else{k="error";f="";for(var c=0;c<e[d].errors.length;c++){var h=e[d].errors[c];f=f+h.message;if(h.id){f=f+" ("+h.id+")"}f=f+"\n";g.errors[a]=h;a++}}g.data[d]=[b,f,k]}if(a==0){g.errors=[]}return g},displayResult:function(result){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});var resultString="("+result+")";var resultObject;try{resultObject=eval(resultString)}catch(e1){Ext.Msg.alert("Error during evaluation of result: "+e1+"\r\n"+resultString)}var version=resultObject.version;if(version!="1.0"){Ext.Msg.alert("Wrong version "+version+". Converting nevertheless.")}if((!resultObject.res)||(resultObject.res.length==0)){this.dialogSupport.openMessageDialog(ORYX.I18N.TransformationDownloadDialog.error,ORYX.I18N.TransformationDownloadDialog.noResult)}else{var displayData=this.buildDisplayData(resultObject.res);displayData.errors.each(function(error){if(error.id=="undefined"){return}sh=this.facade.getCanvas().getChildShapeByResourceId(error.id);if(!sh){sh=this.facade.getCanvas().getChildShapes(true).find(function(shape){processId=shape.properties["oryx-processid"];if(processId==""){return(shape.resourceId+"_process"==error.id)}else{return(processId==error.id)}})}if(sh){this.showOverlay(sh,error.message)}}.bind(this));this.dialogSupport.openResultDialog(displayData.data)}},transform:function(c){this.hideOverlays();var a=this.validate();if(!a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert("Transformation","input not valid");return null}var g="";source=ORYX.PATH+"xslt/BPMNplus2XPDL4Chor.xslt";new Ajax.Request(source,{asynchronous:false,method:"get",onSuccess:function(e){g=e.responseText}.bind(this),onFailure:(function(e){ORYX.Log.error("XSL load failed"+e)}).bind(this)});var l=new XSLTProcessor();var d=this.facade.getERDF();var b=new DOMParser();var k=b.parseFromString(g,"text/xml");l.importStylesheet(k);var q=b.parseFromString(d,"text/xml");try{var p=l.transformToDocument(q,document)}catch(o){this.dialogSupport.openMessageDialog(ORYX.I18N.Bpel4ChorTransformation.error,ORYX.I18N.Bpel4ChorTransformation.noGen.replace(/1/,o.name).replace(/2/,o.message));this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});return null}this.addCanvasProperties(p);var f=(new XMLSerializer()).serializeToString(p);f=f.startsWith("<?xml")?f:'<?xml version="1.0" encoding="UTF-8"?>'+f;if(c){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});var h=this.buildXPDL4ChorData(f);this.dialogSupport.openResultDialog(h)}else{var n="http://"+location.host+ORYX.CONFIG.XPDL4CHOR2BPEL4CHOR_TRANSFORMATION_URL;try{Ext.Ajax.request({method:"POST",url:n,params:{data:f},success:function(e,r){this.displayResult(e.responseText)}.bind(this)})}catch(m){Ext.Msg.alert("Error during call of transformation: "+m)}}},transformXPDL4Chor:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Bpel4ChorTransformation.loadingXPDL4ChorExport});this.transform(true)},transformBPEL4Chor:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Bpel4ChorTransformation.loadingBPEL4ChorExport});this.transform(false)},showOverlay:function(a,b){var d="syntaxchecker."+this.raisedEventIds.length;var c=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{title:b,"stroke-width":5,stroke:"red",d:"M20,-5 L5,-20 M5,-5 L20,-20","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:d,shapes:[a],node:c,nodePosition:a instanceof ORYX.Core.Edge?"START":"NW"});this.raisedEventIds.push(d)},hideOverlays:function(){this.raisedEventIds.each(function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a})}.bind(this));this.raisedEventIds=[]},});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPMNPlusLayout={construct:function(a){this.facade=a;this.facade.registerOnEvent("layout.bpmnplus.pool",this.handleLayoutPool.bind(this));this.facade.registerOnEvent("layout.bpmnplus.poolset",this.handleLayoutPoolSet.bind(this))},handleLayoutPool:function(e){var a=e.shape;var b=a.getChildNodes(false).findAll(function(g){return(g.getStencil().id()==="http://b3mn.org/stencilset/bpmnplus#Lane")});if(b.length>0){b=b.sortBy(function(g){return g.bounds.upperLeft().y});var d=a.bounds.width();var c=0;b.each(function(g){var k=g.bounds.upperLeft();var h=g.bounds.lowerRight();k.y=c;h.y=k.y+g.bounds.height();c+=g.bounds.height();k.x=30;h.x=d;g.bounds.set(k,h)});var f=a.bounds.upperLeft();a.bounds.set(f.x,f.y,a.bounds.lowerRight().x,f.y+c);a.getLabels().each(function(g){g.y=c/2;g.x=12})}},handleLayoutPoolSet:function(a){var g=a.shape;var c=g.getChildNodes(false).findAll(function(m){return(m.getStencil().id()==="http://b3mn.org/stencilset/bpmnplus#Lane")});if(c.length>0){c=c.sortBy(function(m){return m.bounds.upperLeft().y});var f=g.bounds.width();var l=f*500/515;var d=0;c.each(function(m){d+=m.bounds.height()});var b=d*315/300;var k=b-d;var e=k;c.each(function(m){var o=m.bounds.upperLeft();var n=m.bounds.lowerRight();o.y=e;n.y=o.y+m.bounds.height();e+=m.bounds.height();o.x=30;n.x=l;m.bounds.set(o,n)});var h=g.bounds.upperLeft();g.bounds.set(h.x,h.y,g.bounds.lowerRight().x,h.y+e);g.getLabels().each(function(m){m.y=e/2;m.x=12})}}};ORYX.Plugins.BPMNPlusLayout=Clazz.extend(ORYX.Plugins.BPMNPlusLayout);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPMNPlusSerialization={construct:function(a){this.facade=a;this.facade.registerOnEvent("serialize.bpmnplus.pool",this.handleSerializePool.bind(this));this.facade.registerOnEvent("serialize.bpmnplus.variable",this.handleSerializeVariable.bind(this));this.facade.registerOnEvent("serialize.bpmnplus.dataobject",this.handleSerializeDataObject.bind(this));this.facade.registerOnEvent("serialize.bpmnplus.attachedevent",this.handleSerializeAttachedEvent.bind(this));this.facade.registerOnEvent("serialize.bpmnplus.unidirectedassociation",this.handleSerializeUnidirectedAssociation.bind(this));this.facade.registerOnEvent("serialize.bpmnplus.directedassociation",this.handleSerializeDirectedAssociation.bind(this));this.facade.registerOnEvent("serialize.bpmnplus.messageflow",this.handleSerializeMessageFlow.bind(this))},handleSerializePool:function(d){var b=d.shape;var e=d.data;var a=b.resourceId;var g=b.properties["oryx-processid"];if(g==""){g=a+"_process";var f;for(var c=0;c<e.length;c++){if(e[c].name=="processid"){f=e[c];break}}f.value=g}d.result=e},handleSerializeVariable:function(b){var h=b.shape;var f=b.data;var k=h.getParentShape();var e=false;while(k.getParentShape!=undefined){if((k.getStencil().id()=="http://b3mn.org/stencilset/bpmnplus#Scope")||(k.getStencil().id()=="http://b3mn.org/stencilset/bpmnplus#FaultHandler")||(k.getStencil().id()=="http://b3mn.org/stencilset/bpmnplus#CompensationHandler")||(k.getStencil().id()=="http://b3mn.org/stencilset/bpmnplus#TerminationHandler")||(k.getStencil().id()=="http://b3mn.org/stencilset/bpmnplus#MessageHandler")||(k.getStencil().id()=="http://b3mn.org/stencilset/bpmnplus#TimerHandler")){var d=k.resourceId;if(d==""){d=k.resourceId;if(d==undefined){d=""}}if(!e){f.push({name:"subprocess",prefix:"oryx",value:d,type:"literal"});e=true}k=k.getParentShape()}else{if((k.getStencil().id()=="http://b3mn.org/stencilset/bpmnplus#Pool")||(k.getStencil().id()=="http://b3mn.org/stencilset/bpmnplus#PoolSet")){var c;if(k.getStencil().id()=="http://b3mn.org/stencilset/bpmnplus#Pool"){c="pool"}else{c="poolset"}var g=k.resourceId;if(g==""){g=k.resourceId;if(g==undefined){g=""}}f.push({name:c,prefix:"oryx",value:g,type:"literal"});if(!e){var a=k.properties["oryx-processid"];if(a==""){a=g+"_process"}f.push({name:"process",prefix:"oryx",value:a,type:"literal"})}break}else{k=k.getParentShape()}}}b.result=f},handleSerializeDataObject:function(e){var b=e.shape;var f=e.data;var d=b.getParentShape();while(d.getParentShape!=undefined){if((d.getStencil().id()=="http://b3mn.org/stencilset/bpmnplus#Pool")||(d.getStencil().id()=="http://b3mn.org/stencilset/bpmnplus#PoolSet")){var c;if(d.getStencil().id()=="http://b3mn.org/stencilset/bpmnplus#Pool"){c="pool"}else{c="poolset"}var a=d.resourceId;if(a==""){a=d.resourceId;if(a==undefined){a=""}}f.push({name:c,prefix:"oryx",value:a,type:"literal"});break}else{d=d.getParentShape()}}e.result=f},handleSerializeAttachedEvent:function(e){var b=e.shape;var f=e.data;var c;var d=b.getIncomingShapes();d.each(function(k){var h=k.getStencil().roles();for(var g=0;g<h.length;g++){if(h[g]==k.getStencil().namespace()+"attachmentAllowed"){c=k;break}}});if(c!=undefined){var a=c.resourceId;if(a==""){a=c.resourceId}if(a!=undefined){f.push({name:"target",prefix:"oryx",value:a,type:"literal"})}}e.result=f},handleSerializeUnidirectedAssociation:function(d){var l=d.shape;var g=d.data;var b=l.getIncomingShapes();var f=false;if(b.length>0){var a=b[0];var m=a.getStencil().id();var e=a.resourceId;var c;if(m=="http://b3mn.org/stencilset/bpmnplus#StandardVariableDataObject"||m=="http://b3mn.org/stencilset/bpmnplus#FaultVariableDataObject"||m=="http://b3mn.org/stencilset/bpmnplus#MessageVariableDataObject"||m=="http://b3mn.org/stencilset/bpmnplus#CounterVariableDataObject"||m=="http://b3mn.org/stencilset/bpmnplus#ParticipantReferenceDataObject"||m=="http://b3mn.org/stencilset/bpmnplus#ParticipantSetDataObject"){c="target";f=true}else{c="source"}g.push({name:"direction",prefix:"oryx",value:"None",type:"literal",});if(e!=undefined){g.push({name:c,prefix:"oryx",value:e,type:"literal"})}}var h=l.getOutgoingShapes();if(h.length>0){var k=h[0];var e=k.resourceId;var c;if(f){c="source"}else{c="target"}if(e!=undefined){g.push({name:c,prefix:"oryx",value:e,type:"literal"})}}d.result=g},handleSerializeDirectedAssociation:function(d){var l=d.shape;var g=d.data;var b=l.getIncomingShapes();var f=false;if(b.length>0){var a=b[0];var m=a.getStencil().id();var e=a.resourceId;var c;if(m=="http://b3mn.org/stencilset/bpmnplus#StandardVariableDataObject"||m=="http://b3mn.org/stencilset/bpmnplus#FaultVariableDataObject"||m=="http://b3mn.org/stencilset/bpmnplus#MessageVariableDataObject"||m=="http://b3mn.org/stencilset/bpmnplus#CounterVariableDataObject"||m=="http://b3mn.org/stencilset/bpmnplus#ParticipantReferenceDataObject"||m=="http://b3mn.org/stencilset/bpmnplus#ParticipantSetDataObject"){g.push({name:"direction",prefix:"oryx",value:"To",type:"literal"});c="target";f=true}else{g.push({name:"direction",prefix:"oryx",value:"From",type:"literal"});c="source"}if(e!=undefined){g.push({name:c,prefix:"oryx",value:e,type:"literal"})}}var h=l.getOutgoingShapes();if(h.length>0){var k=h[0];var e=k.resourceId;if(e==""){e=k.resourceId}var c;if(f){c="source"}else{c="target"}if(e!=undefined){g.push({name:c,prefix:"oryx",value:e,type:"literal"})}}d.result=g},handleSerializeMessageFlow:function(d){var b=d.shape;var f=d.data;var c=b.getIncomingShapes();if(c.length>0){var e=c[0];var h=e.resourceId;if(h!=undefined){f.push({name:"source",prefix:"oryx",value:h,type:"literal"})}}var a=b.getOutgoingShapes();if(a.length>0){var g=a[0];var h=g.resourceId;if(h!=undefined){f.push({name:"target",prefix:"oryx",value:h,type:"literal"})}}d.result=f}};ORYX.Plugins.BPMNPlusSerialization=Clazz.extend(ORYX.Plugins.BPMNPlusSerialization);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPELSupport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,dialogSupport:undefined,construct:function(a){this.facade=a;this.dialogSupport=new ORYX.Plugins.TransformationDownloadDialog();this.facade.offer({name:ORYX.I18N.BPELSupport.exp,functionality:this.exportProcess.bind(this),group:ORYX.I18N.BPELSupport.group,icon:ORYX.PATH+"images/bpel_export_icon.png",description:ORYX.I18N.BPELSupport.expDesc,index:0,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.BPELSupport.imp,functionality:this.importProcess.bind(this),group:ORYX.I18N.BPELSupport.group,icon:ORYX.PATH+"images/bpel_import_icon.png",description:ORYX.I18N.BPELSupport.impDesc,index:1,minShape:0,maxShape:0})},exportProcess:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE});window.setTimeout((function(){this.exportSynchronously();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}).bind(this),10);return true},exportSynchronously:function(){var c=location.href;try{var b=this.getRDFFromDOM();if(!b.startsWith("<?xml")){b='<?xml version="1.0" encoding="UTF-8"?>'+b}new Ajax.Request(ORYX.CONFIG.BPEL_EXPORT_URL,{method:"POST",asynchronous:false,parameters:{resource:c,data:b},onSuccess:function(d){this.displayResult(d.responseText)}.bind(this)})}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a)}},displayResult:function(result){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});var resultString="("+result+")";var resultObject;try{resultObject=eval(resultString)}catch(e1){alert("Error during evaluation of result: "+e1+"\r\n"+resultString)}if((!resultObject.res)||(resultObject.res.length==0)){this.dialogSupport.openMessageDialog(ORYX.I18N.TransformationDownloadDialog.error,ORYX.I18N.TransformationDownloadDialog.noResult)}else{if(resultObject.res[0].success=="false"){this.dialogSupport.openErrorDialog(resultObject.res[0].content)}else{var processes=new Array();for(var i=0;i<resultObject.res.length;i++){processes[i]=resultObject.res[i].content}var data=this.buildTransData(processes);this.dialogSupport.openResultDialog(data)}}},buildTransData:function(c){var d=[];for(var b=0;b<c.length;b++){var a=this.dialogSupport.getProcessName(c[b]);if(a==undefined){a="Process "+(b+1)}d[b]=[a,c[b],this.dialogSupport.getResultInfo(c[b])]}return d},importProcess:function(){this.openUploadDialog()},openUploadDialog:function(){var b=new Ext.form.FormPanel({frame:true,bodyStyle:"padding:5px;",defaultType:"textfield",labelAlign:"left",buttonAlign:"right",fileUpload:true,enctype:"multipart/form-data",items:[{text:ORYX.I18N.BPELSupport.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",xtype:"label"},{fieldLabel:ORYX.I18N.BPELSupport.file,inputType:"file",labelStyle:"width:50px;",itemCls:"ext_specific_window_overflow"}]});var c=new Ext.form.FormPanel({frame:true,bodyStyle:"padding:5px;",defaultType:"textfield",labelAlign:"left",buttonAlign:"right",fileUpload:true,enctype:"multipart/form-data",items:[{text:ORYX.I18N.BPELSupport.content,style:"font-size:12px;margin-bottom:10px;display:block;",xtype:"label"},{xtype:"textarea",width:"160",height:"350",hideLabel:true,anchor:"100% -63"}]});var a=new Ext.Window({autoCreate:true,title:ORYX.I18N.BPELSupport.impPanel,height:"auto",width:"auto",modal:true,collapsible:false,fixedcenter:true,shadow:true,proxyDrag:true,resizable:false,items:[b,c],buttons:[{text:ORYX.I18N.BPELSupport.impBtn,handler:function(){var d=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.BPELSupport.progressImp});d.show();b.form.submit({headers:{accept:"application/json, text/plain, text/html"},url:ORYX.PATH+"/bpelimporter",timeout:6,success:function(h,e){a.hide();var g=e.result;this.facade.importJSON(g.content,true);this.facade.getCanvas().update();d.hide()}.bind(this),failure:function(g,e){a.hide();d.hide();Ext.MessageBox.show({title:ORYX.I18N.BPELSupport.error,msg:ORYX.I18N.BPELSupport.impFailed+e.response.responseText.substring(e.response.responseText.indexOf("content:'")+9,e.response.responseText.indexOf("'}")),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}.bind(this)})}.bind(this)},{text:ORYX.I18N.BPELSupport.close,handler:function(){a.hide()}.bind(this)}]});a.on("hide",function(){a.destroy(true);delete a});a.show();b.items.items[1].getEl().dom.addEventListener("change",function(d){var e=d.target.files[0].getAsBinary();c.items.items[1].setValue(e)},true)},loadERDF:function(a){var c=new DOMParser();var b=c.parseFromString(a,"text/xml");this.facade.importERDF(b)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPEL4ChorSupport=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.dialogSupport=new ORYX.Plugins.TransformationDownloadDialog();this.facade.offer({name:ORYX.I18N.BPEL4ChorSupport.exp,functionality:this.exportProcess.bind(this),group:ORYX.I18N.JSONSupport.exp.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/bpel4chor_export_icon.png",description:ORYX.I18N.BPEL4ChorSupport.expDesc,index:0,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.BPEL4ChorSupport.imp,functionality:this.importProcess.bind(this),group:ORYX.I18N.JSONSupport.imp.group,dropDownGroupIcon:ORYX.PATH+"images/import.png",icon:ORYX.PATH+"images/bpel4chor_import_icon.png",description:ORYX.I18N.BPEL4ChorSupport.impDesc,index:1,minShape:0,maxShape:0,isEnabled:function(){return false}})},exportProcess:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE});window.setTimeout((function(){this.exportSynchronously();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}).bind(this),10);return true},exportSynchronously:function(){var c=location.href;try{var b=this.getRDFFromDOM();if(!b.startsWith("<?xml")){b='<?xml version="1.0" encoding="UTF-8"?>'+b}new Ajax.Request(ORYX.CONFIG.BPEL4CHOR_EXPORT_URL,{method:"POST",asynchronous:false,parameters:{resource:c,data:b},onSuccess:function(d){this.displayResult(d.responseText)}.bind(this)})}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a)}},buildTransData:function(g,f,d){var e=[["topology",g,this.dialogSupport.getResultInfo(g)]];var a=1;if(f.indexOf("grounding")>0){e[1]=["grounding",f,this.dialogSupport.getResultInfo(f)];a++}for(var c=0;c<d.length;c++){var b=this.dialogSupport.getProcessName(d[c]);if(b==undefined){b="Process "+(c+1)}e[c+a]=[b,d[c],this.dialogSupport.getResultInfo(d[c])]}return e},displayResult:function(result){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});var resultString="("+result+")";var resultObject;try{resultObject=eval(resultString)}catch(e1){alert("Error during evaluation of result: "+e1+"\r\n"+resultString)}if((!resultObject.res)||(resultObject.res.length==0)){this.dialogSupport.openMessageDialog(ORYX.I18N.TransformationDownloadDialog.error,ORYX.I18N.TransformationDownloadDialog.noResult)}else{if(resultObject.res[0].content.indexOf("Parser Error")>0){this.dialogSupport.openErrorDialog(resultObject.res[0].content)}else{var topology=resultObject.res[0].content;var grounding=resultObject.res[1].content;var processes=new Array();for(var i=2;i<resultObject.res.length;i++){processes[i-2]=resultObject.res[i].content}var data=this.buildTransData(topology,grounding,processes);this.dialogSupport.openResultDialog(data)}}},importProcess:function(){this.openUploadDialog()},openUploadDialog:function(){},loadERDF:function(a){var c=new DOMParser();var b=c.parseFromString(a,"text/xml");alert(a);this.facade.importERDF(b)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPEL4Chor2BPELSupport=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.dialog2BPELSupport=new ORYX.Plugins.TransformationDownloadDialogForBPEL4Chor();this.facade.offer({name:ORYX.I18N.BPEL4Chor2BPELSupport.exp,functionality:this.exportProcess.bind(this),group:ORYX.I18N.JSONSupport.exp.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/bpel4chor2bpel_export_icon.png",description:ORYX.I18N.BPEL4Chor2BPELSupport.expDesc,index:0,minShape:0,maxShape:0})},exportProcess:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE});window.setTimeout((function(){this.exportSynchronously();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})}).bind(this),10);return true},exportSynchronously:function(){var c=location.href;try{var b=this.getRDFFromDOM();if(!b.startsWith("<?xml")){b='<?xml version="1.0" encoding="UTF-8"?>'+b}new Ajax.Request(ORYX.CONFIG.BPEL4CHOR2BPEL_EXPORT_URL,{method:"POST",asynchronous:false,parameters:{resource:c,data:b},onSuccess:function(d){this.displayResult(d.responseText)}.bind(this)})}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a)}},buildTransData:function(e,a){var d=new Array();for(var c=0;c<e.length;c++){var b=this.dialog2BPELSupport.getBPELName(e[c]);if(b==undefined){b="Process "+(c+1)}d[c]=[b,e[c],this.dialog2BPELSupport.getResultInfo(e[c])]}for(var c=0;c<a.length;c++){var b=this.dialog2BPELSupport.getBPELName(e[c]);b=b+"-wsdl";if(b==undefined){b="WSDL "+(c+1)}d[c+e.length]=[b,a[c],this.dialog2BPELSupport.getResultInfo(a[c])]}return d},displayResult:function(result){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});var resultString="("+result+")";var resultObject;try{resultObject=eval(resultString)}catch(e1){alert("Error during evaluation of result: "+e1+"\r\n"+resultString)}if((!resultObject.res)||(resultObject.res.length==0)){this.dialog2BPELSupport.openMessageDialog(ORYX.I18N.TransformationDownloadDialog.error,ORYX.I18N.TransformationDownloadDialog.noResult)}else{if(resultObject.res[0].contentBPEL.indexOf("Parser Error")>0){this.dialog2BPELSupport.openErrorDialog(resultObject.res[0].contentBPEL)}else{var bpelArray=new Array();var wsdlArray=new Array();for(var i=0;i<resultObject.res.length;i++){bpelArray[i]=resultObject.res[i].contentBPEL;wsdlArray[i]=resultObject.res[i].contentWSDL}var data=this.buildTransData(bpelArray,wsdlArray);this.dialog2BPELSupport.openResultDialog(data)}}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPELLayouting=Clazz.extend({facade:undefined,isEnabled:undefined,construct:function(a){this.facade=a;this.isEnabled=true;this.facade.offer({name:ORYX.I18N.BPELSupport.enable,functionality:this.enableBpelLayout.bind(this),group:ORYX.I18N.BPELLayout.group,icon:ORYX.PATH+"images/bpel_layout_enable.png",description:ORYX.I18N.BPELLayout.enDesc,index:0,minShape:0,maxShape:0,isEnabled:function(){return !(this.isEnabled)}.bind(this)});this.facade.offer({name:ORYX.I18N.BPELSupport.disable,functionality:this.disableBpelLayout.bind(this),group:ORYX.I18N.BPELLayout.group,icon:ORYX.PATH+"images/bpel_layout_disable.png",description:ORYX.I18N.BPELLayout.disDesc,index:1,minShape:0,maxShape:0,isEnabled:function(){return this.isEnabled}.bind(this)});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LAYOUT_BPEL,this.handleLayoutEvent.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LAYOUT_BPEL_VERTICAL,this.handleLayoutVerticalEvent.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LAYOUT_BPEL_HORIZONTAL,this.handleLayoutHorizontalEvent.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LAYOUT_BPEL_SINGLECHILD,this.handleSingleChildLayoutEvent.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LAYOUT_BPEL_AUTORESIZE,this.handleAutoResizeLayoutEvent.bind(this))},disableBpelLayout:function(){this.isEnabled=false},enableBpelLayout:function(){this.isEnabled=true;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:"Auto Layouting..."});nodes=this.facade.getCanvas().getChildNodes();for(var a=0;a<nodes.size();a++){node=nodes[a];if(node.getStencil().id()==node.getStencil().namespace()+"process"){this._adjust_node(node)}}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE})},_adjust_node:function(c){var a=c.getChildNodes();for(var b=0;b<a.size();b++){this._adjust_node(a[b])}this._handleLayoutEventAdapter(c)},_handleLayoutEventAdapter:function(a){if(a.getStencil().id()==a.getStencil().namespace()+"process"||a.getStencil().id()==a.getStencil().namespace()+"invoke"||a.getStencil().id()==a.getStencil().namespace()+"scope"){this._handleLayoutEvent(a)}else{if(a.getStencil().id()==a.getStencil().namespace()+"assign"||a.getStencil().id()==a.getStencil().namespace()+"eventHandlers"||a.getStencil().id()==a.getStencil().namespace()+"faultHandlers"||a.getStencil().id()==a.getStencil().namespace()+"compensationHandler"||a.getStencil().id()==a.getStencil().namespace()+"terminationHandler"){this._handleLayoutVerticalEvent(a)}else{if(a.getStencil().id()==a.getStencil().namespace()+"if"||a.getStencil().id()==a.getStencil().namespace()+"sequence"||a.getStencil().id()==a.getStencil().namespace()+"pick"){this._handleLayoutHorizontalEvent(a)}else{if(a.getStencil().id()==a.getStencil().namespace()+"onMessage"||a.getStencil().id()==a.getStencil().namespace()+"if_branch"||a.getStencil().id()==a.getStencil().namespace()+"else_branch"||a.getStencil().id()==a.getStencil().namespace()+"while"||a.getStencil().id()==a.getStencil().namespace()+"repeatUntil"||a.getStencil().id()==a.getStencil().namespace()+"forEach"||a.getStencil().id()==a.getStencil().namespace()+"onAlarm"||a.getStencil().id()==a.getStencil().namespace()+"onEvent"||a.getStencil().id()==a.getStencil().namespace()+"catch"||a.getStencil().id()==a.getStencil().namespace()+"catchAll"){this._handleSingleChildLayoutEvent(a)}else{if(a.getStencil().id()==a.getStencil().namespace()+"flow"){this._handleAutoResizeLayoutEvent(a)}else{return}}}}}},handleLayoutEvent:function(a){this._handleLayoutEvent(a.shape)},handleLayoutVerticalEvent:function(a){this._handleLayoutVerticalEvent(a.shape)},handleLayoutHorizontalEvent:function(a){this._handleLayoutHorizontalEvent(a.shape)},handleSingleChildLayoutEvent:function(a){this._handleSingleChildLayoutEvent(a.shape)},handleAutoResizeLayoutEvent:function(a){this._handleAutoResizeLayoutEvent(a.shape)},_handleLayoutEvent:function(o){if(this.isEnabled==false){return}var b=o.getChildShapes(false);if(!this._requiredAutoLayout(o)){return}if(!b||b.length==0){this._resetBounds(o);this._update(o);return}var d=b.find(function(s){return(s.getStencil().id()==s.getStencil().namespace()+"eventHandlers")});var q=b.find(function(s){return(s.getStencil().id()==s.getStencil().namespace()+"faultHandlers")});var k=b.find(function(s){return(s.getStencil().id()==s.getStencil().namespace()+"compensationHandler")});var n=b.find(function(s){return(s.getStencil().id()==s.getStencil().namespace()+"terminationHandler")});var g=b.findAll(function(s){return(s!==d&&s!==q&&s!==k&&s!==n)});var e=30;var a=30;if(g){g=g.sortBy(function(s){return s.bounds.upperLeft().y});if(this._moveSomeElementToLastPosition(g)){g=g.sortBy(function(s){return s.bounds.upperLeft().y})}var c=0;var p;var m=0;g.each(function(u){var t=u.bounds.upperLeft();var s=t.y;t.y=c+30;c=t.y+u.bounds.height();if(t.y!=s){u.bounds.moveTo(30,t.y)}p=u.bounds.width();if(p>m){m=p}});e=30+m+30}var f;var r=0;if(d){d.bounds.moveTo(e,a);a=d.bounds.lowerRight().y+10;f=this._getRightestBoundOfAllChildren(d)+30;if(f>r){r=f}}if(q){q.bounds.moveTo(e,a);a=q.bounds.lowerRight().y+10;f=this._getRightestBoundOfAllChildren(q)+30;if(f>r){r=f}}if(k){k.bounds.moveTo(e,a);a=k.bounds.lowerRight().y+10;f=this._getRightestBoundOfAllChildren(k)+30;if(f>r){r=f}}if(n){n.bounds.moveTo(e,a);f=this._getRightestBoundOfAllChildren(n)+30;if(f>r){r=f}}if(f>0){var l;var h;if(d){f=d.bounds.width();if(f!==r){l=d.bounds.upperLeft();h=d.bounds.lowerRight();d.bounds.set(l.x,l.y,l.x+r,h.y)}}if(q){f=q.bounds.width();if(f!==r){l=q.bounds.upperLeft();h=q.bounds.lowerRight();q.bounds.set(l.x,l.y,l.x+r,h.y)}}if(k){f=k.bounds.width();if(f!==r){l=k.bounds.upperLeft();h=k.bounds.lowerRight();k.bounds.set(l.x,l.y,l.x+r,h.y)}}if(n){f=n.bounds.width();if(f!==r){l=n.bounds.upperLeft();h=n.bounds.lowerRight();n.bounds.set(l.x,l.y,l.x+r,h.y)}}}this._autoResizeLayout(o);this._update(o);return},_getRightestBoundOfAllChildren:function(a){var b=a.getChildShapes(false);if(!b||b.length==0){return 130}b=b.sortBy(function(c){return c.bounds.lowerRight().x});return b.last().bounds.lowerRight().x},_handleLayoutVerticalEvent:function(a){if(this.isEnabled==false){return}var c=a.getChildShapes(false);if(!this._requiredAutoLayout(a)){return}if(!c||c.length==0){this._resetBounds(a);return}c=c.sortBy(function(d){return d.bounds.upperLeft().y});if(this._moveSomeElementToLastPosition(c)){c=c.sortBy(function(d){return d.bounds.upperLeft().y})}var b=0;c.each(function(f){var e=f.bounds.upperLeft();var d=e.y;e.y=b+30;b=e.y+f.bounds.height();if((e.y!=d)){f.bounds.moveTo(30,e.y)}});this._autoResizeLayout(a);return},_handleLayoutHorizontalEvent:function(a){if(this.isEnabled==false){return}var b=a.getChildShapes(false);if(!this._requiredAutoLayout(a)){return}if(!b||b.length==0){this._resetBounds(a);return}b=b.sortBy(function(d){return d.bounds.upperLeft().x});if(this._moveSomeElementToLastPosition(b)){b=b.sortBy(function(d){return d.bounds.upperLeft().x})}var c=0;b.each(function(f){var e=f.bounds.upperLeft();var d=e.x;e.x=c+30;c=e.x+f.bounds.width();if((e.x!=d)){f.bounds.moveTo(e.x,30)}});this._autoResizeLayout(a);return},_handleSingleChildLayoutEvent:function(a){if(this.isEnabled==false){return}var b=a.getChildShapes(false);if(!this._requiredAutoLayout(a)){return}if(!b||b.length==0){this._resetBounds(a);return}b.first().bounds.moveTo(30,30);this._autoResizeLayout(a);return},_handleAutoResizeLayoutEvent:function(a){if(this.isEnabled==false){return}var b=a.getChildShapes(false);if(!this._requiredAutoLayout(a)){return}b.each(function(d){var c=d.bounds.upperLeft();if((c.x<30)){d.bounds.moveTo(30,c.y);c=d.bounds.upperLeft()}if((c.y<30)){d.bounds.moveTo(c.x,30)}});this._autoResizeLayout(a)},_autoResizeLayout:function(b){var d=b.getChildShapes(false);if(d.length>0){d=d.sortBy(function(g){return g.bounds.lowerRight().x});var f=d.last().bounds.lowerRight().x;d=d.sortBy(function(g){return g.bounds.lowerRight().y});var e=d.last().bounds.lowerRight().y;var c=b.bounds.upperLeft();var a=b.bounds.lowerRight();if(b.getStencil().id()==b.getStencil().namespace()+"flow"){if(a.x<c.x+f+30){b.bounds.set(c.x,c.y,c.x+f+30,a.y);a.x=c.x+f+30}if(a.y<c.y+e+30){b.bounds.set(c.x,c.y,a.x,c.y+e+30)}}else{if(a.x!=c.x+f+30||a.y!=c.y+e+30){b.bounds.set(c.x,c.y,c.x+f+30,c.y+e+30)}}}return},_resetBounds:function(b){var c=b.bounds.upperLeft();var a=b.bounds.lowerRight();if(b.getStencil().id()==b.getStencil().namespace()+"process"){if(b.getStencil().namespace()=="http://b3mn.org/stencilset/bpel#"){if(a.x!=c.x+600||a.y!=c.y+500){b.bounds.set(c.x,c.y,c.x+600,c.y+500)}}else{if(b.getStencil().namespace()=="http://b3mn.org/stencilset/bpel4chor#"){if(a.x!=c.x+690||a.y!=c.y+200){b.bounds.set(c.x,c.y,c.x+690,c.y+200)}}else{return}}}else{if(b.getStencil().id()==b.getStencil().namespace()+"flow"){if(a.x!=c.x+290||a.y!=c.y+250){b.bounds.set(c.x,c.y,c.x+290,c.y+250)}}else{if(this._isHandlers(b)){if(a.x!=c.x+160||a.y!=c.y+80){b.bounds.set(c.x,c.y,c.x+160,c.y+80)}}else{if(a.x!=c.x+100||a.y!=c.y+80){b.bounds.set(c.x,c.y,c.x+100,c.y+80)}}}}},_isHandlers:function(a){if(a.getStencil().id()==a.getStencil().namespace()+"eventHandlers"){return true}if(a.getStencil().id()==a.getStencil().namespace()+"faultHandlers"){return true}if(a.getStencil().id()==a.getStencil().namespace()+"compensationHandler"){return true}if(a.getStencil().id()==a.getStencil().namespace()+"terminationHandler"){return true}return false},_requiredAutoLayout:function(b){var c="oryx-autolayout";var a=b.properties[c];if(a==null){return true}if(a){return true}return false},_moveSomeElementToLastPosition:function(b){var a=b.find(function(c){return(Array.indexOf(c.getStencil().roles(),c.getStencil().namespace()+"lastChild")>=0)});if(!a||a==b.last()){return false}ulOfCurrentLastChild=b.last().bounds.upperLeft();a.bounds.moveTo(ulOfCurrentLastChild.x+1,ulOfCurrentLastChild.y+1);return true},_update:function(a){if(a.getStencil().id()==a.getStencil().namespace()+"process"&&a.isChanged){}}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.Workflownets={construct:function(a){this.facade=a;this.facade.registerOnEvent("Workflownets.Activity.serialize",this.handleSerialize.bind(this))},handleSerialize:function(c){var b=c.shape;var d=c.data;var a=b.getOutgoingShapes().length;d.push({name:"numOfOutgoings",prefix:"oryx",value:a,type:"literal"});c.result=d},};ORYX.Plugins.Workflownets=Clazz.extend(ORYX.Plugins.Workflownets);Ext.ns("Oryx.Plugins");ORYX.Plugins.BPMNImport=Clazz.extend({converterUrl:ORYX.CONFIG.ROOT_PATH+"bpmn2pn",construct:function(a){this.facade=a;this.importBpmn()},getParamFromUrl:function(b){b=b.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a="[\\?&]"+b+"=([^&#]*)";var d=new RegExp(a);var c=d.exec(window.location.href);if(c==null){return null}else{return c[1]}},bpmnToPn:function(a){Ext.Msg.updateProgress(0.66,ORYX.I18N.BPMN2PNConverter.progress.convertingModel);Ext.Ajax.request({url:this.converterUrl,method:"POST",success:function(b){try{var f=new DOMParser();Ext.Msg.updateProgress(1,ORYX.I18N.BPMN2PNConverter.progress.renderingModel);var d=f.parseFromString(b.responseText,"text/xml");this.facade.importERDF(d)}catch(c){Ext.Msg.alert("Rendering Failed :\n"+c)}Ext.Msg.hide()}.createDelegate(this),failure:function(){Ext.Msg.alert(ORYX.I18N.BPMN2PNConverter.error,ORYX.I18N.BPMN2PNConverter.errors.server)},params:{rdf:a}})},importBpmn:function(){var a=this.getParamFromUrl("importBPMN");if(!a){return}Ext.Msg.progress(ORYX.I18N.BPMN2PNConverter.progress.status,ORYX.I18N.BPMN2PNConverter.progress.importingModel);Ext.Msg.updateProgress(0.33,ORYX.I18N.BPMN2PNConverter.progress.fetchingModel);Ext.Ajax.request({url:this.getRdfUrl(a),success:function(b){var c=b.responseText;this.bpmnToPn(c)}.createDelegate(this),failure:function(b){Ext.Msg.alert(ORYX.I18N.BPMN2PNConverter.error,ORYX.I18N.BPMN2PNConverter.errors.noRights)},method:"GET"})},getRdfUrl:function(a){return a.replace(/\/self(\/)?$/,"/rdf")}});ORYX.Plugins.PNExport=Clazz.extend({construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.BPMN2PNConverter.name,functionality:this.exportIt.bind(this),group:ORYX.I18N.BPMN2PNConverter.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/page_white_convert.png",description:ORYX.I18N.BPMN2PNConverter.desc,index:3,minShape:0,maxShape:0})},exportIt:function(){var a="";if(!location.hash.slice(1)){Ext.Msg.alert(ORYX.I18N.BPMN2PNConverter.error,ORYX.I18N.BPMN2PNConverter.errors.notSaved);return}else{a="/backend/poem/"+(location.hash.slice(1).replace(/^\/?/,"").replace(/\/?$/,""))+"/rdf"}this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT});this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,context:"bpmn2pn",onNoErrors:function(){this.openPetriNetEditor(a)}.bind(this)})},openPetriNetEditor:function(a){window.open("/backend/poem/new?stencilset=/stencilsets/petrinets/petrinet.json&importBPMN="+a)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPMN2YAWLMapper=ORYX.Plugins.AbstractPlugin.extend({stencilSetExtensionNamespace:"http://oryx-editor.org/stencilsets/extensions/bpmn4yawlSubset#",construct:function(){arguments.callee.$.construct.apply(this,arguments);this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.BPMN2YAWLMapper.name,functionality:this.perform.bind(this),group:ORYX.I18N.BPMN2YAWLMapper.group,icon:ORYX.PATH+"images/door.png",description:ORYX.I18N.BPMN2YAWLMapper.desc,dropDownGroupIcon:ORYX.PATH+"images/export2.png",index:1,minShape:0,maxShape:0,isEnabled:this._isStencilSetExtensionLoaded.bind(this)});this.facade.registerOnEvent(ORYX.Plugins.BPMN2YAWLMapper.RESET_ERRORS_EVENT,this.resetErrors.bind(this));this.facade.registerOnEvent(ORYX.Plugins.BPMN2YAWLMapper.SHOW_ERRORS_EVENT,this.doShowErrors.bind(this))},_isStencilSetExtensionLoaded:function(){return this.isStencilSetExtensionLoaded(this.stencilSetExtensionNamespace)},perform:function(a,b){this.resetErrors();this.checkSyntaxAndMapBPMNtoYAWL({onMappingSucceeded:function(){this.setActivated(false);Ext.Msg.alert("The BPMN to YAWL mapper succeeded and has created an YAWL file in your Eclipse directory")},onErrors:function(){},onFailure:function(){this.setActivated(false);Ext.Msg.alert("The connection to the server failed")}})},setActivated:function(a){if(a===undefined){this.active=!this.active}else{this.active=a}},checkSyntaxAndMapBPMNtoYAWL:function(a){Ext.applyIf(a||{},{showErrors:true,ononMappingSucceeded:Ext.emptyFn,onErrors:Ext.emptyFn,onFailure:Ext.emptyFn});var b=this.getRDFFromDOM();this.openDownload(ORYX.CONFIG.BPMN2YAWL_URL,b)},doShowErrors:function(b,a){this.showErrors(b.errors)},showErrors:function(a){if(!(a instanceof Hash)){a=new Hash(a)}a.keys().each(function(c){var b=this.facade.getCanvas().getChildShapeByResourceId(c);if(b){this.raiseOverlay(b,a[c])}}.bind(this))},resetErrors:function(){this.raisedEventIds.each(function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a})}.bind(this));this.raisedEventIds=[];this.active=false},raiseOverlay:function(a,b){var e="syntaxchecker."+this.raisedEventIds.length;var c=ORYX.Editor.provideId();var d=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{id:c,title:b,"stroke-width":5,stroke:"red",d:"M20,-5 L5,-20 M5,-5 L20,-20","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:e,shapes:[a],node:d,nodePosition:a instanceof ORYX.Core.Edge?"START":"NW"});this.raisedEventIds.push(e);return d},openDownload:function(b,c){var d=window.open("");if(d!=null){d.document.open();d.document.write("<html><body>");var a=d.document.createElement("form");d.document.body.appendChild(a);var e=function(f,g){var h=document.createElement("input");h.name=f;h.type="hidden";h.value=g;return h};a.appendChild(e("data",c));a.method="POST";d.document.write("</body></html>");d.document.close();a.action=b;a.submit();window.setTimeout(function(){d.close()}.bind(this),1000)}}});ORYX.Plugins.BPMN2YAWLMapper.RESET_ERRORS_EVENT="resetErrors";ORYX.Plugins.BPMN2YAWLMapper.SHOW_ERRORS_EVENT="showErrors";Ext.ns("Oryx.Plugins");ORYX.Plugins.PetriNetSoundnessChecker=ORYX.Plugins.AbstractPlugin.extend({hideOverlays:function(){if(!this.overlayIds){return}Ext.each(this.overlayIds,function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a})}.bind(this))},getChildShapesByResourceIds:function(b){var a=[];Ext.each(b,function(c){a.push(this.facade.getCanvas().getChildShapeByResourceId(c))}.bind(this));return a},showOverlay:function(a,b,e,c){if(!this.overlayIds){this.overlayIds=[]}if(!(a instanceof Array)){a=[a]}a=a.map(function(f){var g=f;if(typeof f=="string"){g=this.facade.getCanvas().getChildShapeByResourceId(f);g=g||this.facade.getCanvas().getChildById(f,true)}return g}.bind(this)).compact();var d=this.type+ORYX.Editor.provideId();this.overlayIds.push(d);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:d,shapes:a,attributes:b,node:e,nodePosition:c||"NW"})},construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:"Check soundness",functionality:this.showCheckerWindow.bind(this),group:"Verification",icon:ORYX.PATH+"images/checker_validation.png",description:"Checks current Petri net for different soundness criteria.",index:3,minShape:0,maxShape:0})},showCheckerWindow:function(){var d=this;var b=Ext.extend(Ext.tree.TreeNode,{constructor:function(g){if(!g.icon&&!this.icon){g.icon=b.UNKNOWN_STATUS}b.superclass.constructor.apply(this,arguments);Ext.apply(this,g);if(this.clickHandler){this.on("click",this.clickHandler.bind(this))}},setIcon:function(g){this.ui.getIconEl().src=g},getIcon:function(g){return this.ui.getIconEl().src},reset:function(){d.hideOverlays();this.hideMarking();d.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT})},hideMarking:function(){if(!d.marking){return}for(place in d.marking){var g=d.facade.getCanvas().getChildShapeByResourceId(place);if(g){g.setProperty("oryx-numberoftokens",0)}}d.facade.getCanvas().update();d.marking=undefined},showMarking:function(h){d.marking=h;for(place in h){var g=d.facade.getCanvas().getChildShapeByResourceId(place);g.setProperty("oryx-numberoftokens",h[place])}d.facade.getCanvas().update()},showErrors:function(g){Ext.each(this.childNodes,function(h){if(h&&h.itemCls==="error"){h.remove()}});Ext.each(this.childNodes,function(h){if(h.getIcon().search(b.LOADING_STATUS)>-1){h.setIcon(b.UNKNOWN_STATUS)}});Ext.each(g,function(h){this.insertBefore(new b({icon:b.ERROR_STATUS,text:h,itemCls:"error"}),this.childNodes[0])}.bind(this))},showOverlayWithStep:function(g){Ext.each(g,function(k,h){d.showOverlay(d.facade.getCanvas().getChildShapeByResourceId(k),{fill:"#FB7E02"},ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{style:"font-size: 16px; font-weight: bold;"},(h+1)+"."]),"SE")})},showOverlay:function(g){if(g.length===0){return}if(!g[0] instanceof ORYX.Core.Node){g=d.getChildShapesByResourceIds(g)}d.showOverlay(g,{fill:"#FB7E02"})}});b.UNKNOWN_STATUS=ORYX.PATH+"images/soundness_checker/asterisk_yellow.png";b.ERROR_STATUS=ORYX.PATH+"images/soundness_checker/exclamation.png";b.OK_STATUS=ORYX.PATH+"images/soundness_checker/accept.png";b.LOADING_STATUS=ORYX.PATH+"images/soundness_checker/loading.gif";var c=Ext.extend(b,{constructor:function(g){g.qtip="<b>Termination Criteria</b>: Makes sure that any process instance that starts in the initial state will eventually reach the final state. If any dead locks are detected, click to show one counter example.";c.superclass.constructor.apply(this,arguments)},clickHandler:function(h){h.reset();if(this.deadLocks.length==0){return}var g=h.deadLocks[0];this.showOverlayWithStep(g.path);this.showMarking(g.marking)},update:function(g){this.deadLocks=g;this.setIcon(this.deadLocks.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There is "+(this.deadLocks.length==0?"no":"a")+" path that leads to a deadlock.")}});var f=Ext.extend(b,{constructor:function(g){g.qtip="<b>Proper Termination Criteria</b>: The final state is the only state reachable from the initial state in which there is a token in the final place. If any improper terminating states are detected, click to show one counter example.";f.superclass.constructor.apply(this,arguments)},clickHandler:function(h){h.reset();if(h.improperTerminatings.length==0){return}var g=h.improperTerminatings[0];this.showOverlayWithStep(g.path);this.showMarking(g.marking)},update:function(g){this.improperTerminatings=g;this.setIcon(this.improperTerminatings.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.improperTerminatings.length+" markings covering the final marking.")}});var a=Ext.extend(b,{constructor:function(g){g.qtip="<b>No Dead Transitions Criteria</b>: Each transition can contribute to at least one process instance. Click to see all dead transitions.";a.superclass.constructor.apply(this,arguments)},clickHandler:function(g){g.reset();this.showOverlay(this.deadTransitions)},update:function(g){this.deadTransitions=g;this.setIcon(this.deadTransitions.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.deadTransitions.length+" dead transitions.")}});var e=Ext.extend(b,{constructor:function(g){g.qtip="<b>Transition Participation Criteria</b>: Each transition participates in at least one process instance that starts in the initial state and reaches the final state. Click to see all transitions not participating in any process instance.";e.superclass.constructor.apply(this,arguments)},clickHandler:function(g){g.reset();this.showOverlay(this.notParticipatingTransitions)},update:function(g){this.notParticipatingTransitions=g;this.setIcon(this.notParticipatingTransitions.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.notParticipatingTransitions.length+" transitions that cannot participate in a properly terminating firing sequence.")}});this.checkerWindow=new Ext.Window({title:"Soundness Checker",autoScroll:true,width:"500",tbar:[{text:"Check",handler:function(){this.checkerWindow.check()}.bind(this)},{text:"Hide Errors",handler:function(){this.checkerWindow.getTree().getRootNode().reset()}.bind(this)},"->",{text:"Close",handler:function(){this.checkerWindow.close()}.bind(this)}],getTree:function(){return this.items.get(0)},check:function(g){this.prepareCheck(g);this.checkSyntax(this.checkSoundness.bind(this))},prepareCheck:function(h){var g=this.getTree().getRootNode();g.reset();Ext.each(g.childNodes,function(k){if(h){k.expand(true)}k.collapse(true);k.setIcon(b.LOADING_STATUS)})},checkSyntax:function(g){d.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,onErrors:function(){Ext.Msg.alert("Syntax Check","Some syntax errors have been found, please correct them!");this.turnLoadingIntoUnknownStatus()}.bind(this),onNoErrors:function(){g()}})},turnLoadingIntoUnknownStatus:function(){Ext.each(this.getTree().getRootNode().childNodes,function(g){if(g.getIcon().search(b.LOADING_STATUS)>-1){g.setIcon(b.UNKNOWN_STATUS)}})},checkSoundness:function(){var g=this.getTree().getRootNode();if(!g.findChild("id","structuralSound").check()){this.turnLoadingIntoUnknownStatus();return}Ext.Ajax.request({url:ORYX.CONFIG.ROOT_PATH+"checksoundness",method:"POST",success:function(k){var h=Ext.decode(k.responseText);g.showErrors(h.errors);if(h.errors.length===0){g.findChild("id","sound").check(h);g.findChild("id","weakSound").check(h);g.findChild("id","relaxedSound").check(h)}},failure:function(){},params:{data:d.getSerializedDOM()}})},items:[new Ext.tree.TreePanel({useArrows:true,autoScroll:true,rootVisible:false,animate:true,containerScroll:true,root:new b({text:"Checks",id:"source",expanded:true}),listeners:{render:function(l){var h=new b({text:"Structural Sound (Workflow Net)",id:"structuralSound",check:function(){this.checkInitialNode.update();this.checkFinalNode.update();this.checkConnectedNode.update(this.checkInitialNode.initialNodes,this.checkFinalNode.finalNodes);if(this.checkInitialNode.hasErrors()||this.checkFinalNode.hasErrors()||this.checkConnectedNode.hasErrors()){this.setIcon(b.ERROR_STATUS);this.expand();return false}else{this.setIcon(b.OK_STATUS);return true}},checkInitialNode:new b({qtip:"There must be exactly one initial place, which is the only place without any incoming edges.",update:function(){this.initialNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(n){if(n.getIncomingShapes().length==0&&n.getStencil().id().search(/Place/)>-1){this.initialNodes.push(n)}}.bind(this));this.setText(this.initialNodes.length+" initial places found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS)},clickHandler:function(n){n.reset();this.showOverlay(this.initialNodes)},hasErrors:function(){return this.initialNodes.length!==1}}),checkFinalNode:new b({qtip:"There must be exactly one final place, which is the only place without any outgoing edges.",update:function(){this.finalNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(n){if(n.getOutgoingShapes().length==0&&n.getStencil().id().search(/Place/)>-1){this.finalNodes.push(n)}}.bind(this));this.setText(this.finalNodes.length+" final places found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS)},clickHandler:function(n){n.reset();this.showOverlay(this.finalNodes)},hasErrors:function(){return this.finalNodes.length!==1}}),checkConnectedNode:new b({qtip:"Each node in the process model is on the path from the initial node to the final node.",update:function(o,n){if(o.length!==1||n.length!==1){this.setText("There must be exactly one initial and final place to perform further checks!");this.setIcon(b.UNKNOWN_STATUS);return}this.notParticipatingNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(p){if(p instanceof ORYX.Core.Node){this.notParticipatingNodes.push(p)}}.bind(this));this.passedNodes=[];this.findNotParticipatingNodes(o[0]);this.setText(this.notParticipatingNodes.length+" nodes that aren't on any path from beginning to end found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS)},clickHandler:function(n){n.reset();this.showOverlay(this.notParticipatingNodes)},findNotParticipatingNodes:function(n){this.passedNodes.push(n);this.notParticipatingNodes.remove(n);Ext.each(n.getOutgoingShapes(),function(o){if(!this.passedNodes.include(o)){this.findNotParticipatingNodes(o)}}.bind(this))},hasErrors:function(){return this.notParticipatingNodes.length!==0}})});h.appendChild([h.checkInitialNode,h.checkFinalNode,h.checkConnectedNode]);var g=new b({text:"Sound",id:"sound",check:function(n){if(n.isSound){this.setIcon(b.OK_STATUS)}else{this.setIcon(b.ERROR_STATUS);this.expand()}this.deadTransitionsNode.update(n.deadTransitions);this.improperTerminatingsNode.update(n.improperTerminatings);this.deadLocksNode.update(n.deadLocks)},deadTransitionsNode:new a({}),improperTerminatingsNode:new f({}),deadLocksNode:new c({})});g.appendChild([g.deadTransitionsNode,g.improperTerminatingsNode,g.deadLocksNode]);var m=new b({text:"Weak Sound",id:"weakSound",check:function(n){if(n.isWeakSound){this.setIcon(b.OK_STATUS)}else{this.setIcon(b.ERROR_STATUS);this.expand()}this.improperTerminatingsNode.update(n.improperTerminatings);this.deadLocksNode.update(n.deadLocks)},deadTransitionsNode:new a({}),improperTerminatingsNode:new f({}),deadLocksNode:new c({})});m.appendChild([m.improperTerminatingsNode,m.deadLocksNode]);var k=new b({text:"Relaxed Sound",id:"relaxedSound",check:function(n){if(n.isRelaxedSound){this.setIcon(b.OK_STATUS)}else{this.setIcon(b.ERROR_STATUS);this.expand()}this.notParticipatingTransitionsNode.update(n.notParticipatingTransitions)},notParticipatingTransitionsNode:new e({})});k.appendChild([k.notParticipatingTransitionsNode]);l.getRootNode().appendChild([h,g,m,k])}}})],listeners:{close:function(g){this.checkerWindow.getTree().getRootNode().reset()}.bind(this)}});this.checkerWindow.show();this.checkerWindow.check(true)}});Ext.ns("Oryx.Plugins");ORYX.Plugins.LolaPetriNetSoundnessChecker=ORYX.Plugins.AbstractPlugin.extend({hideOverlays:function(){if(!this.overlayIds){return}Ext.each(this.overlayIds,function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a})}.bind(this))},getChildShapesByResourceIds:function(b){var a=[];Ext.each(b,function(c){a.push(this.facade.getCanvas().getChildShapeByResourceId(c))}.bind(this));return a},showOverlay:function(a,b,e,c){if(!this.overlayIds){this.overlayIds=[]}if(!(a instanceof Array)){a=[a]}a=a.map(function(f){var g=f;if(typeof f=="string"){g=this.facade.getCanvas().getChildShapeByResourceId(f);g=g||this.facade.getCanvas().getChildById(f,true)}return g}.bind(this)).compact();var d=this.type+ORYX.Editor.provideId();this.overlayIds.push(d);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:d,shapes:a,attributes:b,node:e,nodePosition:c||"NW"})},construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:"Check soundness",functionality:this.showCheckerWindow.bind(this),group:"Verification",icon:ORYX.PATH+"images/soundness_checker/accept.png",description:"Checks current Petri net for different soundness criteria with LoLA.",index:3,minShape:0,maxShape:0})},showCheckerWindow:function(){var d=this;var b=Ext.extend(Ext.tree.TreeNode,{constructor:function(h){if(!h.icon&&!this.icon){h.icon=b.UNKNOWN_STATUS}b.superclass.constructor.apply(this,arguments);Ext.apply(this,h);if(this.clickHandler){this.on("click",this.clickHandler.bind(this))}},setIcon:function(h){this.ui.getIconEl().src=h},getIcon:function(h){return this.ui.getIconEl().src},reset:function(){d.hideOverlays();this.hideMarking();d.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT})},hideMarking:function(){if(!d.marking){return}for(place in d.marking){var h=d.facade.getCanvas().getChildShapeByResourceId(place);if(h){h.setProperty("oryx-numberoftokens",0)}}d.facade.getCanvas().update();d.marking=undefined},showMarking:function(k){d.marking=k;for(place in k){var h=d.facade.getCanvas().getChildShapeByResourceId(place);h.setProperty("oryx-numberoftokens",k[place])}d.facade.getCanvas().update()},showErrors:function(h){Ext.each(this.childNodes,function(k){if(k&&k.itemCls==="error"){k.remove()}});Ext.each(this.childNodes,function(k){if(k.getIcon().search(b.LOADING_STATUS)>-1){k.setIcon(b.UNKNOWN_STATUS)}});Ext.each(h,function(k){this.insertBefore(new b({icon:b.ERROR_STATUS,text:k,itemCls:"error"}),this.childNodes[0])}.bind(this))},showOverlayWithStep:function(h){Ext.each(h,function(l,k){d.showOverlay(d.facade.getCanvas().getChildShapeByResourceId(l),{fill:"#FB7E02"},ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{style:"font-size: 16px; font-weight: bold;"},(k+1)+"."]),"SE")})},showOverlayMarking:function(h){Ext.each(h,function(m,k){var l=m.split(":");d.showOverlay(d.facade.getCanvas().getChildShapeByResourceId(l[0].trim()),{fill:"#FB7E02"},ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{style:"font-size: 16px; font-weight: bold;"},(l[1])]),"SE")})},showOverlay:function(h){if(h.length===0){return}if(!h[0] instanceof ORYX.Core.Node){h=d.getChildShapesByResourceIds(h)}d.showOverlay(h,{fill:"#FB7E02"})}});b.UNKNOWN_STATUS=ORYX.PATH+"images/soundness_checker/asterisk_yellow.png";b.ERROR_STATUS=ORYX.PATH+"images/soundness_checker/exclamation.png";b.OK_STATUS=ORYX.PATH+"images/soundness_checker/accept.png";b.LOADING_STATUS=ORYX.PATH+"images/soundness_checker/loading.gif";var f=Ext.extend(b,{constructor:function(h){h.qtip="<b>Weak Termination</b>: Makes sure that from any state, reachable from the initial state, the final state well eventually be reached.";f.superclass.constructor.apply(this,arguments)},clickHandler:function(h){h.reset();this.showOverlayMarking(this.marking)},update:function(h){this.marking=h.counter?h.counter.split(","):[];this.setIcon(h.liveness?b.OK_STATUS:b.ERROR_STATUS);this.setText("There is "+(h.liveness?"no":"a")+" marking from which one cannot reach the final state.")}});var g=Ext.extend(b,{constructor:function(h){h.qtip="<b>Boundedness Criteria</b>: There are not unbounded places in the net. If any unbounded places are detected, click to show one counter example.";g.superclass.constructor.apply(this,arguments)},clickHandler:function(h){h.reset();this.showOverlay(this.unboundedplaces)},update:function(h){this.unboundedplaces=h.unboundedplaces;if(h.boundedness){this.unboundedplaces=[]}this.setIcon(h.boundedness?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.unboundedplaces.length+" unbounded places.")}});var a=Ext.extend(b,{constructor:function(h){h.qtip="<b>No Dead Transitions Criteria</b>: Each transition can contribute to at least one process instance. Click to see all dead transitions.";a.superclass.constructor.apply(this,arguments)},clickHandler:function(h){h.reset();this.showOverlay(this.deadTransitions)},update:function(h){this.deadTransitions=h.deadtransitions;if(h.quasiliveness){this.deadTransitions=[]}this.setIcon(this.deadTransitions.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.deadTransitions.length+" dead transitions.")}});var e=Ext.extend(b,{constructor:function(h){h.qtip="<b>Transition Participation Criteria</b>: Each transition participates in at least one process instance that starts in the initial state and reaches the final state. Click to see all transitions not participating in any process instance.";e.superclass.constructor.apply(this,arguments)},clickHandler:function(h){h.reset();this.showOverlay(this.notParticipatingTransitions)},update:function(h){this.notParticipatingTransitions=h.uncoveredtransitions;this.setIcon(this.notParticipatingTransitions.length==0?b.OK_STATUS:b.ERROR_STATUS);this.setText("There are "+this.notParticipatingTransitions.length+" transitions that cannot participate in a properly terminating firing sequence.")}});var c=new Object;c.html='<a href="http://www.service-technology.org/"><img src="images/service_tech_site_banner.png" width="400" style="position: relative; left: 35px;"/></a>';this.checkerWindow=new Ext.Window({title:"Soundness Checker powered by service-technology.org",autoScroll:true,width:"500",tbar:[{text:"Check",handler:function(){this.checkerWindow.check()}.bind(this)},{text:"Hide Errors",handler:function(){this.checkerWindow.getTree().getRootNode().reset()}.bind(this)},"->",{text:"Close",handler:function(){this.checkerWindow.close()}.bind(this)}],getTree:function(){return this.items.get(0)},check:function(h){this.prepareCheck(h);this.checkSyntax(this.checkSoundness.bind(this),this.reRender.bind(this))},reRender:function(){window.setTimeout(function(){this.getResizeEl().beforeAction();this.getResizeEl().sync(true)}.bind(this),70)},prepareCheck:function(k){var h=this.getTree().getRootNode();h.reset();Ext.each(h.childNodes,function(l){if(k){l.expand(true)}l.collapse(true);l.setIcon(b.LOADING_STATUS)})},checkSyntax:function(k,h){d.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,onErrors:function(){Ext.Msg.alert("Syntax Check","Some syntax errors have been found, please correct them!");this.turnLoadingIntoUnknownStatus();h()}.bind(this),onNoErrors:function(){k();h()}})},turnLoadingIntoUnknownStatus:function(){Ext.each(this.getTree().getRootNode().childNodes,function(h){if(h.getIcon().search(b.LOADING_STATUS)>-1){h.setIcon(b.UNKNOWN_STATUS)}})},checkSoundness:function(){var h=this.getTree().getRootNode();if(!h.findChild("id","structuralSound").check()){this.turnLoadingIntoUnknownStatus();return}var k=d.getRDFFromDOM();if(!k.startsWith("<?xml")){k='<?xml version="1.0" encoding="UTF-8"?>'+k}Ext.Ajax.request({url:ORYX.CONFIG.ROOT_PATH+"lola",method:"POST",success:function(m){var l=Ext.decode(m.responseText);h.showErrors(l.errors);if(l.errors.length===0){h.findChild("id","sound").check(l);h.findChild("id","weakSound").check(l);h.findChild("id","relaxedSound").check(l)}}.bind(this),failure:function(){}.bind(this),params:{data:k}})},items:[new Ext.tree.TreePanel({useArrows:true,autoScroll:true,rootVisible:false,animate:true,containerScroll:true,root:new b({text:"Checks",id:"source",expanded:true}),listeners:{render:function(m){var k=new b({text:"Structural Sound (Workflow Net)",id:"structuralSound",check:function(){this.checkInitialNode.update();this.checkFinalNode.update();this.checkConnectedNode.update(this.checkInitialNode.initialNodes,this.checkFinalNode.finalNodes);if(this.checkInitialNode.hasErrors()||this.checkFinalNode.hasErrors()||this.checkConnectedNode.hasErrors()){this.setIcon(b.ERROR_STATUS);this.expand();return false}else{this.setIcon(b.OK_STATUS);return true}},checkInitialNode:new b({qtip:"There must be exactly one initial place, which is the only place without any incoming edges.",update:function(){this.initialNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(o){if(o.getIncomingShapes().length==0&&o.getStencil().id().search(/Place/)>-1){this.initialNodes.push(o)}}.bind(this));this.setText(this.initialNodes.length+" initial places found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS)},clickHandler:function(o){o.reset();this.showOverlay(this.initialNodes)},hasErrors:function(){return this.initialNodes.length!==1}}),checkFinalNode:new b({qtip:"There must be exactly one final place, which is the only place without any outgoing edges.",update:function(){this.finalNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(o){if(o.getOutgoingShapes().length==0&&o.getStencil().id().search(/Place/)>-1){this.finalNodes.push(o)}}.bind(this));this.setText(this.finalNodes.length+" final places found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS)},clickHandler:function(o){o.reset();this.showOverlay(this.finalNodes)},hasErrors:function(){return this.finalNodes.length!==1}}),checkConnectedNode:new b({qtip:"Each node in the process model is on the path from the initial node to the final node.",update:function(p,o){if(p.length!==1||o.length!==1){this.setText("There must be exactly one initial and final place to perform further checks!");this.setIcon(b.UNKNOWN_STATUS);return}this.notParticipatingNodes=[];Ext.each(d.facade.getCanvas().getChildShapes(),function(q){if(q instanceof ORYX.Core.Node){this.notParticipatingNodes.push(q)}}.bind(this));this.passedNodes=[];this.findNotParticipatingNodes(p[0]);this.setText(this.notParticipatingNodes.length+" nodes that aren't on any path from beginning to end found.");this.setIcon(!this.hasErrors()?b.OK_STATUS:b.ERROR_STATUS)},clickHandler:function(o){o.reset();this.showOverlay(this.notParticipatingNodes)},findNotParticipatingNodes:function(o){this.passedNodes.push(o);this.notParticipatingNodes.remove(o);Ext.each(o.getOutgoingShapes(),function(p){if(!this.passedNodes.include(p)){this.findNotParticipatingNodes(p)}}.bind(this))},hasErrors:function(){return this.notParticipatingNodes.length!==0}})});k.appendChild([k.checkInitialNode,k.checkFinalNode,k.checkConnectedNode]);var h=new b({text:"Sound",id:"sound",check:function(o){if(o.soundness){this.setIcon(b.OK_STATUS)}else{this.setIcon(b.ERROR_STATUS);this.expand()}this.deadTransitionsNode.update(o);this.boundednessNode.update(o);this.livenessNode.update(o)},deadTransitionsNode:new a({}),boundednessNode:new g({}),livenessNode:new f({}),});h.appendChild([h.deadTransitionsNode,h.boundednessNode,h.livenessNode]);var n=new b({text:"Weak Sound",id:"weakSound",check:function(o){if(o.weaksoundness){this.setIcon(b.OK_STATUS)}else{this.setIcon(b.ERROR_STATUS);this.expand()}this.boundednessNode.update(o);this.livenessNode.update(o)},boundednessNode:new g({}),livenessNode:new f({}),});n.appendChild([n.boundednessNode,n.livenessNode]);var l=new b({text:"Relaxed Sound",id:"relaxedSound",check:function(o){if(o.relaxedsoundness){this.setIcon(b.OK_STATUS)}else{this.setIcon(b.ERROR_STATUS);this.expand()}this.deadTransitionsNode.update(o);this.notParticipatingTransitionsNode.update(o)},deadTransitionsNode:new a({}),notParticipatingTransitionsNode:new e({})});l.appendChild([l.notParticipatingTransitionsNode,l.deadTransitionsNode]);m.getRootNode().appendChild([k,h,n,l])}}}),c],listeners:{close:function(h){this.checkerWindow.getTree().getRootNode().reset()}.bind(this)}});this.checkerWindow.show();this.checkerWindow.check(true)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.PetriNet={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this))},handlePropertyChanged:function(c){var b=c.elements;var d=c.key;var a=c.value;var e=false;b.each(function(f){if((f.getStencil().id()==="http://b3mn.org/stencilset/petrinet#Place")&&(d==="oryx-numberoftokens")){if(a==0){f.setProperty("oryx-numberoftokens_text","");f.setProperty("oryx-numberoftokens_drawing","0")}else{if(a==1){f.setProperty("oryx-numberoftokens_text","");f.setProperty("oryx-numberoftokens_drawing","1")}else{if(a==2){f.setProperty("oryx-numberoftokens_text","");f.setProperty("oryx-numberoftokens_drawing","2")}else{if(a==3){f.setProperty("oryx-numberoftokens_text","");f.setProperty("oryx-numberoftokens_drawing","3")}else{if(a==4){f.setProperty("oryx-numberoftokens_text","");f.setProperty("oryx-numberoftokens_drawing","4")}else{var g=parseInt(a,10);if(g&&g>0){f.setProperty("oryx-numberoftokens_text",""+g);f.setProperty("oryx-numberoftokens_drawing","0")}else{f.setProperty("oryx-numberoftokens_text","");f.setProperty("oryx-numberoftokens_drawing","0")}}}}}}e=true}});if(e){this.facade.getCanvas().update()}}};ORYX.Plugins.PetriNet=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.PetriNet);Ext.ns("Oryx.Plugins");ORYX.Plugins.BPMNImport=Clazz.extend({converterUrl:ORYX.CONFIG.ROOT_PATH+"bpmn2pn",construct:function(a){this.facade=a;this.importBpmn()},getParamFromUrl:function(b){b=b.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a="[\\?&]"+b+"=([^&#]*)";var d=new RegExp(a);var c=d.exec(window.location.href);if(c==null){return null}else{return c[1]}},bpmnToPn:function(a){Ext.Msg.updateProgress(0.66,ORYX.I18N.BPMN2PNConverter.progress.convertingModel);Ext.Ajax.request({url:this.converterUrl,method:"POST",success:function(b){try{var f=new DOMParser();Ext.Msg.updateProgress(1,ORYX.I18N.BPMN2PNConverter.progress.renderingModel);var d=f.parseFromString(b.responseText,"text/xml");this.facade.importERDF(d)}catch(c){Ext.Msg.alert("Rendering Failed :\n"+c)}Ext.Msg.hide()}.createDelegate(this),failure:function(){Ext.Msg.alert(ORYX.I18N.BPMN2PNConverter.error,ORYX.I18N.BPMN2PNConverter.errors.server)},params:{rdf:a}})},importBpmn:function(){var a=this.getParamFromUrl("importBPMN");if(!a){return}Ext.Msg.progress(ORYX.I18N.BPMN2PNConverter.progress.status,ORYX.I18N.BPMN2PNConverter.progress.importingModel);Ext.Msg.updateProgress(0.33,ORYX.I18N.BPMN2PNConverter.progress.fetchingModel);Ext.Ajax.request({url:this.getRdfUrl(a),success:function(b){var c=b.responseText;this.bpmnToPn(c)}.createDelegate(this),failure:function(b){Ext.Msg.alert(ORYX.I18N.BPMN2PNConverter.error,ORYX.I18N.BPMN2PNConverter.errors.noRights)},method:"GET"})},getRdfUrl:function(a){return a.replace(/\/self(\/)?$/,"/rdf")}});ORYX.Plugins.PNExport=Clazz.extend({construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.BPMN2PNConverter.name,functionality:this.exportIt.bind(this),group:ORYX.I18N.BPMN2PNConverter.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/page_white_convert.png",description:ORYX.I18N.BPMN2PNConverter.desc,index:3,minShape:0,maxShape:0})},exportIt:function(){var a="";if(!location.hash.slice(1)){Ext.Msg.alert(ORYX.I18N.BPMN2PNConverter.error,ORYX.I18N.BPMN2PNConverter.errors.notSaved);return}else{a="/backend/poem/"+(location.hash.slice(1).replace(/^\/?/,"").replace(/\/?$/,""))+"/rdf"}this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.RESET_ERRORS_EVENT});this.facade.raiseEvent({type:ORYX.Plugins.SyntaxChecker.CHECK_FOR_ERRORS_EVENT,context:"bpmn2pn",onNoErrors:function(){this.openPetriNetEditor(a)}.bind(this)})},openPetriNetEditor:function(a){window.open("/backend/poem/new?stencilset=/stencilsets/petrinets/petrinet.json&importBPMN="+a)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPEL2BPMN=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.offer({name:"Transform BPEL into BPMN",functionality:this.transform.bind(this),group:"Export",dropDownGroupIcon:ORYX.PATH+"images/import.png",description:"Transform a BPEL process into its BPMN representation",index:1,minShape:0,maxShape:0})},transform:function(){this.openUploadDialog()},openUploadDialog:function(){var c=new Ext.form.FormPanel({frame:false,defaultType:"textfield",waitMsgTarget:true,labelAlign:"left",buttonAlign:"right",fileUpload:true,enctype:"multipart/form-data",style:"font-size:12px;",items:[{fieldLabel:"File",inputType:"file",style:"font-size:12px;",allowBlank:false}]});var b=new Ext.Panel({style:"font-size:12px;",autoScroll:true});var a;a=new Ext.Window({autoCreate:true,title:"Upload BPEL File",height:240,width:400,modal:true,collapsible:false,fixedcenter:true,shadow:true,style:"font-size:12px;",proxyDrag:true,resizable:true,items:[new Ext.form.Label({text:"Select a BPEL (.bpel) file and transform it to BPMN.",style:"font-size:12px;"}),c,b],buttons:[{text:"Submit",handler:function(){c.form.submit({clientValidation:false,url:ORYX.PATH+"/bpel2bpmn",waitMsg:"Transforming...",success:function(k,e){var g=e.response.responseText.replace(/&lt;/g,"<").replace(/&gt;/g,">");if(g){var m=g.evalJSON();var h=m.content;var d=m.successValidation;var l=m.validationError;if(d){a.hide()}else{b.body.dom.innerHTML='<p style="background-color: transparent;">Your BPEL file does not comply with the XML schema definition. <br /> <br />Error message: '+l+"</p>"}h='<?xml version="1.0" encoding="utf-8"?><html xmlns="http://www.w3.org/1999/xhtml" xmlns:b3mn="http://b3mn.org/2007/b3mn" xmlns:ext="http://b3mn.org/2007/ext" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:atom="http://b3mn.org/2007/atom+xhtml"><head profile="http://purl.org/NET/erdf/profile"><link rel="schema.dc" href="http://purl.org/dc/elements/1.1/" /><link rel="schema.dcTerms" href="http://purl.org/dc/terms/ " /><link rel="schema.b3mn" href="http://b3mn.org" /><link rel="schema.oryx" href="http://oryx-editor.org/" /><link rel="schema.raziel" href="http://raziel.org/" /><base href="http://localhost:8080/backend/poem/new" /></head><body>'+h+"</body></html>";var n=new DOMParser();this.facade.importERDF(n.parseFromString(h,"text/xml"))}else{Ext.MessageBox.show({title:"Error",msg:"The BPEL file could not be imported.",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}}.bind(this),failure:function(e,d){a.hide();Ext.MessageBox.show({title:"Error",msg:d.response.responseText.substring(d.response.responseText.indexOf("content:'")+9,d.response.responseText.indexOf("'}")),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}.bind(this)})}.bind(this)}]});a.on("hide",function(){a.destroy(true);delete a});a.show()},});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPMN2XHTML=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:ORYX.I18N.BPMN2XHTML.XHTMLExport,functionality:this.transform.bind(this),group:ORYX.I18N.BPMN2XHTML.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/page_white_world.png",description:ORYX.I18N.BPMN2XHTML.XHTMLExport,index:99998,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.BPMN2XHTML.XHTMLExport,functionality:this.showXHTML.bind(this),group:ORYX.I18N.BPMN2XHTML.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/report.png",description:ORYX.I18N.BPMN2XHTML.XHTMLExport,index:99999,minShape:0,maxShape:0})},showXHTML:function(){window.open(ORYX.PATH+"/testcase-BPMN2XHTML-extended.xhtml","_blank","resizable=yes,width=640,height=480,toolbar=0,scrollbars=yes")},generateXHTML:function(c){var a=new Ext.LoadMask(Ext.getBody(),{msg:"Transforming BPMN to XHTML"});a.show();var b=this.getRDFFromDOM();this._sendRequest(ORYX.PATH+"/bpmn2xhtml","POST",{data:b},function(d){c(d);a.hide()}.bind(this),function(){a.hide();this._showErrorMessageBox("Oryx",ORYX.I18N.Bpmn2Bpel.transfFailed);ORYX.log.warn("Transformation to XHTML failed: "+transport.responseText)}.bind(this))},_sendRequest:function(b,f,d,e,a){var c=false;new Ajax.Request(b,{method:f,asynchronous:false,parameters:d,onSuccess:function(g){c=true;if(e){e(g.responseText)}}.bind(this),onFailure:function(g){if(a){a()}else{Ext.Msg.alert("Oryx",ORYX.I18N.Bpmn2Bpel.transfFailed);ORYX.log.warn("Transformation to XHTML failed: "+g.responseText)}}.bind(this)});return c},_showErrorMessageBox:function(b,a){Ext.MessageBox.show({title:b,msg:a,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})},transform:function(){var b=ORYX.PATH+"xslt/BPMN2XHTML.xslt";var a=this.doTransform(this.getRDFFromDOM(),b);var c=window.open("data:application/xhtml+xml,"+a,"_blank","resizable=yes,width=640,height=480,toolbar=0,scrollbars=yes")}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPMN2DTRPXMI=ORYX.Plugins.AbstractPlugin.extend({stencilSetExtensionSuffix:"/bpmn-design-thinking-subset#",construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:ORYX.I18N.BPMN2DTRPXMI.DTRPXMIExport,functionality:this.transform.bind(this),group:ORYX.I18N.BPMN2DTRPXMI.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/page_white_code_red.png",description:ORYX.I18N.BPMN2DTRPXMI.DTRPXMIExportDescription,index:1,minShape:0,maxShape:0,isEnabled:this.isStencilSetExtensionLoaded.bind(this)})},isStencilSetExtensionLoaded:function(){return this.facade.getStencilSets().values().any(function(a){return a.extensions().keys().any(function(b){return b.endsWith(this.stencilSetExtensionSuffix)}.bind(this))}.bind(this))},transform:function(){var b=ORYX.PATH+"xslt/BPMN2DTRP-XMI.xslt";var a=this.doTransform(this.getRDFFromDOM(),b);this.openDownloadWindow(window.document.title+".xmi",a)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.QueryEvaluator=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.QueryEvaluator.name,functionality:this.showOverlay.bind(this),group:ORYX.I18N.QueryEvaluator.group,icon:ORYX.PATH+"images/xforms_export.png",description:ORYX.I18N.QueryEvaluator.desc,index:0,toggle:true,minShape:0,maxShape:0})},showOverlay:function(c,f){if(!f){this.raisedEventIds=[];this.active=!this.active;return}var b={command:"undef"};var e=new Ext.Window({layout:"fit",width:500,height:350,closable:true,plain:true,modal:true,id:"optionsPopup",buttons:[{text:"Submit",handler:function(){b=a.getForm().getValues(false);e.close();this.issueQuery(b)}.bind(this)},{text:"Abort",handler:function(){e.close()}.bind(this)}]});var g=new Ext.form.TextField({fieldLabel:"Model ID",name:"modelID",grow:true,});g.hide();var d=function(o,l){if(!this.fieldStates){this.fieldStates=[]}var n=false;var k=false;var h,m;for(h=0;h<this.fieldStates.length;h++){m=this.fieldStates[h];if(m.field===o){n=true;m.checked=l}k=k||m.checked}if(!n){this.fieldStates.push({field:o,checked:l});k=true}if(k){g.show()}else{g.hide()}};var a=new Ext.form.FormPanel({frame:true,title:"Query options",bodyStyle:"padding:0 10px 0;",items:[{xtype:"fieldset",autoHeight:true,columns:1,allowBlank:false,defaultType:"radio",items:[{boxLabel:"Process query",fieldLabel:"Query Type",name:"command",inputValue:"processQuery",checked:true},{boxLabel:"Process Compliance Query",labelSeparator:"",name:"command",inputValue:"processComplianceQuery",},{boxLabel:"Run query against specific model",labelSeparator:"",name:"command",inputValue:"runQueryAgainstModel",listeners:{check:d.bind(this)}},{boxLabel:"Run compliance query against specific model",labelSeparator:"",name:"command",inputValue:"runComplianceQueryAgainstModel",listeners:{check:d.bind(this)}},{xtype:"checkbox",fieldLabel:"Stop after first match in a model was found",name:"stopAtFirstMatch",checked:true,}]}]});a.add(g);e.add(a);e.show();c.toggle()},issueQuery:function(b){try{var c=this.getRDFFromDOM();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:"Processing query"});new Ajax.Request(ORYX.CONFIG.QUERYEVAL_URL,{method:"POST",asynchronous:true,parameters:{resource:location.href,command:b.command,modelID:b.modelID,stopAtFirstMatch:b.stopAtFirstMatch,data:c},onSuccess:function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});var f=d.responseXML;var k=f.firstChild;var m=new Array();var l,n;var h=k.getElementsByTagName("ProcessGraph");for(l=0;l<h.length;l++){n=h.item(l);var e=n.getAttributeNode("modelID").nodeValue;m.push({id:e,elements:this.processResultGraph(n),metadata:"",description:this.processMatchDescription(n)})}try{this.processProcessList(m)}catch(g){Ext.Msg.alert(ORYX.I18N.Oryx.title,g)}}.bind(this),onFailure:function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,"Server encountered an error ("+d.statusText+").\n"+d.responseText)}.bind(this)})}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a)}},processResultGraph:function(b){var d=new Array();for(var a=0;a<b.childNodes.length;a++){var c=b.childNodes.item(a);if(!(c instanceof Text)){if(c.hasAttribute("id")){d.push({nodeType:c.nodeName,nodeId:c.getAttributeNode("id").nodeValue})}else{if((c.hasAttribute("from"))&&c.hasAttribute("to")){d.push({edgeType:c.nodeName,from:c.getAttributeNode("from").nodeValue,to:c.getAttributeNode("to").nodeValue})}}}}return d},processMatchDescription:function(c){var b=new Array();for(var a=0;a<c.childNodes.length;a++){var d=c.childNodes.item(a);if((d.nodeName==="diagnosis")){b.push({diagnosis:d.textContent})}else{if((d.nodeName==="match")){b.push({match:d.textContent})}}}return b},processProcessList:function(e){if(e.length==0){Ext.Msg.alert(ORYX.I18N.Oryx.title,"Found no matching processes!");return}this.isRendering=true;e.each(this.getModelMetaData.bind(this));var c=[];e.each(function(f){c.push([f.id,f.metadata.thumbnailUri+"?"+Math.random(),unescape(f.metadata.title),f.metadata.type,f.metadata.author,f.elements,f.description])}.bind(this));var a=new Ext.Window({layout:"fit",width:500,height:300,closable:true,plain:true,modal:true,autoScroll:true,title:"Query Result",id:"procResPopup",buttons:[{text:"Close",handler:function(){a.close()}.bind(this)}]});var d=new Ext.data.SimpleStore({fields:[{name:"id"},{name:"icon"},{name:"title"},{name:"type"},{name:"author"},{name:"elements"},{name:"description"},],data:c});var b=new Ext.Panel({border:false,autoScroll:true,items:new this.dataGridPanel({store:d,listeners:{dblclick:this._onDblClick.bind(this)}})});this.setPanelStyle();a.add(b);this.isRendering=false;a.show()},getModelMetaData:function(b){var a=b.id.replace(/\/rdf$/,"/meta");new Ajax.Request(a,{method:"get",asynchronous:false,onSuccess:function(c){b.metadata=c.responseText.evalJSON()}.bind(this),onFailure:function(){Ext.MessageBox.alert(ORYX.I18N.Oryx.title,"Error loading model meta data.")}.bind(this)})},_onDblClick:function(a,m,c,n){a.selectRange(m,m);var p=a.getRecord(c).data.id;var d=a.getRecord(c).data.elements;var q=a.getRecord(c).data.description;var k=Ext.encode(d);var h=Ext.encode(q);var g=encodeURIComponent(k);var o=encodeURIComponent(h);var f=p.lastIndexOf("/");var b=p.substr(0,f)+"/self?matches="+g+"&description="+o;var l=window.open(b);window.setTimeout(function(){if(!l||!l.opener||l.closed){Ext.MessageBox.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Oryx.editorOpenTimeout).setIcon(Ext.MessageBox.QUESTION)}},5000)},dataGridPanel:Ext.extend(Ext.DataView,{multiSelect:true,cls:"iconview",itemSelector:"dd",overClass:"over",selectedClass:"selected",tpl:new Ext.XTemplate("<div>",'<dl class="repository_iconview">','<tpl for=".">',"<dd >",'<div class="image">','<img src="{icon}" title="{title}" /></div>','<div><span class="title" title="{[ values.title.length + (values.type.length*0.8) > 30 ? values.title : "" ]}" >{[ values.title.truncate(30 - (values.type.length*0.8)) ]}</span><span class="author" unselectable="on">({type})</span></div>','<div><span class="type">{author}</span></div>',"</dd>","</tpl>","</dl>","</div>")}),setPanelStyle:function(){var a=".repository_iconview dd{	width		: 200px;	height		: 105px;	padding		: 10px;	border		: 1px solid #EEEEEE;	font-family	: tahoma,arial,sans-serif;	font-size	: 9px;	display		: block;	margin		: 5px;	text-align	: left;	float		: left;}.repository_iconview dl {	width		: 100%;	max-width	: 1000px;}.repository_iconview dd.over{	background-color	: #fff5e1;}.repository_iconview dd.selected{	border-color: #FC8B03;}.repository_iconview dd img{	max-width	: 190px;	max-height	: 70px;}.repository_iconview dd .image{	width	: 200px;	height	: 80px;	padding-bottom	: 10px;	text-align		: center;	vertical-align	: middle;	display	:table-cell;}.repository_iconview dd .title{	font-weight	: bold;	font-size	: 11px;	color		: #555555;}.repository_iconview dd .author{	margin-left	: 5px;}";Ext.util.CSS.createStyleSheet(a,"queryResultStyle")},});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.QueryVariant=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.QueryVariant.name,functionality:this.showOverlay.bind(this),group:ORYX.I18N.QueryVariant.group,icon:ORYX.PATH+"stencilsets/bpmnqvar/bpmnqvar.png",description:ORYX.I18N.QueryVariant.tooltip,index:0,toggle:false,minShape:0,maxShape:0})},showOverlay:function(b,c){if(!c){this.raisedEventIds=[];this.active=!this.active;return}var a={command:"undef"};this.issueQuery(a)},issueQuery:function(b){try{var c=this.getRDFFromDOM();this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:"Processing partial process model"});new Ajax.Request(ORYX.CONFIG.QUERYVARIANTEVAL_URL,{method:"POST",asynchronous:true,parameters:{resource:location.href,command:b.command,modelID:b.modelID,stopAtFirstMatch:b.stopAtFirstMatch,data:location.href},onSuccess:function(e){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});var f=e.responseXML;var d=f.firstChild;var k=d.getElementsByTagName("ProcessGraph");var h=location.href.substring(0,location.href.substring(8).indexOf("/")+8);var g=h+"/backend/poem/new?stencilset=/stencilsets/bpmn1.1/bpmn1.1.json";editor=window.open(g);editor.oryxCreator1283772618640=self;editor.oryxCreator1283772618640.variant=f}.bind(this),onFailure:function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,"Server encountered an error ("+d.statusText+").\n"+d.responseText)}.bind(this)})}catch(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,a)}},processResultGraph:function(b){var d=new Array();for(var a=0;a<b.childNodes.length;a++){var c=b.childNodes.item(a);if(!(c instanceof Text)){if(c.hasAttribute("id")){Ext.Msg.alert(c.getAttributeNode("id").nodeValue);d.push({nodeType:c.getAttributeNode("type").nodeValue,nodeId:c.getAttributeNode("id").nodeValue,nodeLabel:c.getAttributeNode("label").nodeValue,nodeType2:c.getAttributeNode("type2").nodeValue})}else{if((c.hasAttribute("from"))&&c.hasAttribute("to")){d.push({edgeType:c.getAttributeNode("type").nodeValue,from:c.getAttributeNode("from").nodeValue.substring(3),to:c.getAttributeNode("to").nodeValue.substring(3)})}}}}return d},processMatchDescription:function(c){var b=new Array();for(var a=0;a<c.childNodes.length;a++){var d=c.childNodes.item(a);if((d.nodeName==="diagnosis")){b.push({diagnosis:d.textContent})}else{if((d.nodeName==="match")){b.push({match:d.textContent})}}}return b},processProcessList:function(e){if(e.length==0){Ext.Msg.alert(ORYX.I18N.Oryx.title,"Found no matching processes!");return}this.isRendering=true;e.each(this.getModelMetaData.bind(this));var c=[];e.each(function(f){c.push([f.id,f.metadata.thumbnailUri+"?"+Math.random(),unescape(f.metadata.title),f.metadata.type,f.metadata.author,f.elements,f.description])}.bind(this));var a=new Ext.Window({layout:"fit",width:500,height:300,closable:true,plain:true,modal:true,autoScroll:true,title:"Query Result",id:"procResPopup",buttons:[{text:"Close",handler:function(){a.close()}.bind(this)}]});var d=new Ext.data.SimpleStore({fields:[{name:"id"},{name:"icon"},{name:"title"},{name:"type"},{name:"author"},{name:"elements"},{name:"description"},],data:c});var b=new Ext.Panel({border:false,autoScroll:true,items:new this.dataGridPanel({store:d,listeners:{dblclick:this._onDblClick.bind(this)}})});this.setPanelStyle();a.add(b);this.isRendering=false;a.show()},getModelMetaData:function(b){var a=b.id.replace(/\/rdf$/,"/meta");new Ajax.Request(a,{method:"get",asynchronous:false,onSuccess:function(c){b.metadata=c.responseText.evalJSON()}.bind(this),onFailure:function(){Ext.MessageBox.alert(ORYX.I18N.Oryx.title,"Error loading model meta data.")}.bind(this)})},_onDblClick:function(a,m,c,n){a.selectRange(m,m);var p=a.getRecord(c).data.id;var d=a.getRecord(c).data.elements;var q=a.getRecord(c).data.description;var k=Ext.encode(d);var h=Ext.encode(q);var g=encodeURIComponent(k);var o=encodeURIComponent(h);var f=p.lastIndexOf("/");var b=p.substr(0,f)+"/self?matches="+g+"&description="+o;var l=window.open(b);window.setTimeout(function(){if(!l||!l.opener||l.closed){Ext.MessageBox.alert(ORYX.I18N.Oryx.title,ORYX.I18N.Oryx.editorOpenTimeout).setIcon(Ext.MessageBox.QUESTION)}},5000)},dataGridPanel:Ext.extend(Ext.DataView,{multiSelect:true,cls:"iconview",itemSelector:"dd",overClass:"over",selectedClass:"selected",tpl:new Ext.XTemplate("<div>",'<dl class="repository_iconview">','<tpl for=".">',"<dd >",'<div class="image">','<img src="{icon}" title="{title}" /></div>','<div><span class="title" title="{[ values.title.length + (values.type.length*0.8) > 30 ? values.title : "" ]}" >{[ values.title.truncate(30 - (values.type.length*0.8)) ]}</span><span class="author" unselectable="on">({type})</span></div>','<div><span class="type">{author}</span></div>',"</dd>","</tpl>","</dl>","</div>")}),setPanelStyle:function(){var a=".repository_iconview dd{	width		: 200px;	height		: 105px;	padding		: 10px;	border		: 1px solid #EEEEEE;	font-family	: tahoma,arial,sans-serif;	font-size	: 9px;	display		: block;	margin		: 5px;	text-align	: left;	float		: left;}.repository_iconview dl {	width		: 100%;	max-width	: 1000px;}.repository_iconview dd.over{	background-color	: #fff5e1;}.repository_iconview dd.selected{	border-color: #FC8B03;}.repository_iconview dd img{	max-width	: 190px;	max-height	: 70px;}.repository_iconview dd .image{	width	: 200px;	height	: 80px;	padding-bottom	: 10px;	text-align		: center;	vertical-align	: middle;	display	:table-cell;}.repository_iconview dd .title{	font-weight	: bold;	font-size	: 11px;	color		: #555555;}.repository_iconview dd .author{	margin-left	: 5px;}";Ext.util.CSS.createStyleSheet(a,"queryResultStyle")},});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.CreateProcessVariant=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.createModel()},createModel:function(){if(oryxCreator1283772618640){var k=oryxCreator1283772618640.variant;var m=k.firstChild;var g=m.getElementsByTagName("ProcessGraph");var b=g.item(0).childNodes;var l=-30;var f=new Array();var n=new Array();for(var d=0;d<b.length;d++){var a=b[d];if(a.nodeName=="Activity"||a.nodeName=="Gateway"||a.nodeName=="Event"){l=l+150;var h=this.drawNode(a,l);f.push(a);n.push(h)}if(a.nodeName=="SequenceFlow"){var c=this.getSequenceFlowFrom(a);var p=this.getShapeById(c,f,n);var e=this.getSequenceFlowTo(a);var o=this.getShapeById(e,f,n);h=this.drawSequenceFlow(p,o);f.push(a);n.push(h)}}}},drawNode:function(f,a){var e=this.facade.getCanvas();var m;var g={};g.x=a;g.y=0;var c=this.facade.getStencilSets().keys()[0];var l;if(f.nodeName=="Activity"){l=ORYX.Core.StencilSet.stencil(c+"Task");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l);var h=f.getAttributeNode("label").nodeValue;m.setProperty("oryx-name",h);this.facade.getCanvas().add(m)}if(f.nodeName=="Event"){var d=f.getAttributeNode("type2").nodeValue;var k=d[d.length-1];var b=d.substring(0,d.length-1);if(k==1){if(b=="MessageEvent"){l=ORYX.Core.StencilSet.stencil(c+"StartMessageEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="TimerEvent"){l=ORYX.Core.StencilSet.stencil(c+"StartTimerEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="ConditionalEvent"){l=ORYX.Core.StencilSet.stencil(c+"StartConditionalEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="SignalEvent"){l=ORYX.Core.StencilSet.stencil(c+"StartSignalEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="MultipleEvent"){l=ORYX.Core.StencilSet.stencil(c+"StartMultipleEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{l=ORYX.Core.StencilSet.stencil(c+"StartEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}}}}}}if(k==2){if(b=="MessageEventCatching"){l=ORYX.Core.StencilSet.stencil(c+"IntermediateMessageEventCatching");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="MessageEventThrowing"){l=ORYX.Core.StencilSet.stencil(c+"IntermediateMessageEventThrowing");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="TimerEvent"){l=ORYX.Core.StencilSet.stencil(c+"IntermediateTimerEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="ErrorEvent"){l=ORYX.Core.StencilSet.stencil(c+"IntermediateErrorEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="CancelEvent"){l=ORYX.Core.StencilSet.stencil(c+"IntermediateCancelEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="CompensationEventCatching"){l=ORYX.Core.StencilSet.stencil(c+"IntermediateCompensationEventCatching");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="CompensationEventThrowing"){l=ORYX.Core.StencilSet.stencil(c+"IntermediateCompensationEventThrowing");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="ConditionalEvent"){l=ORYX.Core.StencilSet.stencil(c+"IntermediateConditionalEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="SignalEventCatching"){l=ORYX.Core.StencilSet.stencil(c+"IntermediateSignalEventCatching");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="SignalEventThrowing"){l=ORYX.Core.StencilSet.stencil(c+"IntermediateSignalEventThrowing");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="MultipleEventCatching"){l=ORYX.Core.StencilSet.stencil(c+"IntermediateMultipleEventCatching");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="MultipleEventThrowing"){l=ORYX.Core.StencilSet.stencil(c+"IntermediateMultipleEventThrowing");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="LinkEventCatching"){l=ORYX.Core.StencilSet.stencil(c+"IntermediateLinkEventCatching");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="LinkEventThrowing"){l=ORYX.Core.StencilSet.stencil(c+"IntermediateLinkEventThrowing");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{l=ORYX.Core.StencilSet.stencil(c+"IntermediateEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}}}}}}}}}}}}}}}if(k==3){if(b=="MessageEvent"){l=ORYX.Core.StencilSet.stencil(c+"EndMessageEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="ErrorEvent"){l=ORYX.Core.StencilSet.stencil(c+"EndErrorEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="CancelEvent"){l=ORYX.Core.StencilSet.stencil(c+"EndCancelEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="CompensationEvent"){l=ORYX.Core.StencilSet.stencil(c+"EndCompensationEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="SignalEvent"){l=ORYX.Core.StencilSet.stencil(c+"EndSignalEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="MultipleEvent"){l=ORYX.Core.StencilSet.stencil(c+"EndMultipleEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{if(b=="Terminate"){l=ORYX.Core.StencilSet.stencil(c+"EndTerminateEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}else{l=ORYX.Core.StencilSet.stencil(c+"EndEvent");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}}}}}}}}this.facade.getCanvas().add(m)}if(f.nodeName=="Gateway"){var d=f.getAttributeNode("type2").nodeValue;if(d.indexOf("XOR")>=0){l=ORYX.Core.StencilSet.stencil(c+"Exclusive_Databased_Gateway");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}if(d.indexOf("OR")>=0&&d.indexOf("XOR")==-1){l=ORYX.Core.StencilSet.stencil(c+"OR_Gateway");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}if(d.indexOf("AND")>=0){l=ORYX.Core.StencilSet.stencil(c+"AND_Gateway");m=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},l)}this.facade.getCanvas().add(m)}return m},getSequenceFlowFrom:function(c){var a=c.getAttributeNode("from").nodeValue;var f=a.indexOf("#");var b=a.substring(0,f);var e=a.substring(f,a.length);var d={};d.type=b;d.shapeId=e;return e},getSequenceFlowTo:function(c){var a=c.getAttributeNode("to").nodeValue;var f=a.indexOf("#");var b=a.substring(0,f);var e=a.substring(f,a.length);var d={};d.type=b;d.shapeId=e;return e},getShapeById:function(h,c,a){var g=-1;for(var b=0;b<c.length;b++){var f=c[b];var e=false;var d=f.getAttributeNode("id").nodeValue;if(d==h){g=b;e=true}if(e){break}}return a[g]},drawSequenceFlow:function(f,e){var c;var b=this.facade.getCanvas();var a=this.facade.getStencilSets().keys()[0];var d=ORYX.Core.StencilSet.stencil(a+"SequenceFlow");c=new ORYX.Core.Edge({eventHandlerCallback:this.facade.raiseEvent},d);c.dockers.first().setDockedShape(f);c.dockers.first().setReferencePoint({x:f.bounds.width()/2,y:f.bounds.height()/2});c.dockers.last().setDockedShape(e);c.dockers.last().setReferencePoint({x:e.bounds.width()/2,y:e.bounds.height()/2});this.facade.getCanvas().add(c);return c}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.QueryResultHighlighter=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,isHighlighted:false,construct:function(a){this.facade=a;this.raisedEventIds=[];this.raisedHighlightEventIds=[];this.facade.offer({name:"Query result highlighter",functionality:this.buttonClick.bind(this),group:ORYX.I18N.QueryEvaluator.group,icon:ORYX.PATH+"images/xforms_export.png",description:"This plugin highlights model parts which were matched by a query.",index:1,toggle:true,minShape:0,maxShape:0,isEnabled:this._isQueryResultThere.bind(this)});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.highlightMatches.bind(this))},_isQueryResultThere:function(){var c=window.location.search;var b="matches=";var a=c.indexOf(b)+b.length;return(a>b.length)},highlightMatches:function(){var g=this.deserializeMatches();if(!g){return}var b=null;var d=null;var f=this.deserializeDescription();if(f){f.each(function(e){if(e.match){b=e.match}if(e.diagnosis){d=e.diagnosis}})}else{b="pattern";d=""}var c="orange";var a="#FFFF00";if(d==="complies"){c="green";a="#00FF00"}else{if(d==="violation scenario"){c="red";a="#FF0000"}else{c="orange";a="#FF6600"}}try{g.each(function(k){if(k.nodeType!=null&&k.nodeId!=null){var e=this.getShapeById(k.nodeId)}else{if(k.edgeType!=null){var e=this.getEdgeByFromAndTo(k.from,k.to)}else{return}}if(!e){return}if(e instanceof ORYX.Core.Node){e.setProperty("oryx-bgcolor",a);e.refresh()}}.bind(this))}catch(h){Ext.MessageBox.alert(ORYX.I18N.Oryx.title,"Something went wrong while applying highlighting to shapes: "+h)}this.isHighlighted=true},raiseOverlay:function(c,b,a,d){var f="queryhighlighter."+this.raisedEventIds.length;if(c instanceof ORYX.Core.Node){c.setProperty("oryx-bgcolor",a);c.refresh()}var e=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{title:d,"stroke-width":5,stroke:b,d:"M20,-5 L5,-20 M5,-5 L20,-20","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:f,shapes:[c],node:e,nodePosition:c instanceof ORYX.Core.Edge?"START":"NW"});this.raisedEventIds.push(f);return e},removeHighlighting:function(a,b){this.raisedEventIds.each(function(c){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:c})}.bind(this));this.raisedEventIds=[];this.raisedHighlightEventIds.each(function(c){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,id:c})}.bind(this));this.raisedHighlightEventIds=[]},highlightSelectedTask:function(a){if(!(a instanceof ORYX.Core.Shape)){return}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:a.id,elements:[a],color:"#FF0000"});this.raisedHighlightEventIds.push(task.id)},buttonClick:function(a,b){if(this.isHighlighted){this.removeHighlighting();this.isHighlighted=false}else{this.highlightMatches();this.isHighlighted=true}if(this.isHighlighted&&!b){a.toggle()}},deserializeMatches:function(){var f=window.location.search;var b="matches=";var a=f.indexOf(b)+b.length;if(a<b.length){return null}var k=f.indexOf("&",a);var d=f.substring(a,(k>a?k:f.length));try{var c=decodeURIComponent(d);var h=Ext.decode(c)}catch(g){Ext.MessageBox.alert(ORYX.I18N.Oryx.title,"I found highlighting information from BPMN-Q, but they could not be understood: "+g);return null}return h},deserializeDescription:function(){var f=window.location.search;var b="description=";var a=f.indexOf(b)+b.length;if(a<b.length){return null}var h=f.indexOf("&",a);var c=f.substring(a,(h>a?h:f.length));try{var k=decodeURIComponent(c);var d=Ext.decode(k)}catch(g){Ext.MessageBox.alert(ORYX.I18N.Oryx.title,"I found description information from BPMN-Q, but they could not be understood: "+g);return null}return d},getShapeById:function(b){var a=this.facade.getCanvas().getChildShapeByResourceId(b);return a},getEdgeByFromAndTo:function(d,a){d=d.replace(/^.*#/,"");a=a.replace(/^.*#/,"");var c=this.facade.getCanvas().getChildEdges(true);var b=c.find(function(e){return e.incoming!=null&&e.incoming[0]!=null&&e.incoming[0].resourceId==d&&e.outgoing!=null&&e.outgoing[0]!=null&&e.outgoing[0].resourceId==a}.bind(this));return b}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ResourcesSoDAdd=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.ResourcesSoDAdd.name,functionality:this.defineSoD.bind(this),group:ORYX.I18N.ResourcesSoDAdd.group,dropDownGroupIcon:ORYX.PATH+"images/sod.png",icon:ORYX.PATH+"images/sod+.png",description:ORYX.I18N.ResourcesSoDAdd.desc,index:1,toggle:false,minShape:2,maxShape:0})},defineSoD:function(){var d=this.facade.getSelection();var k=[];var a;var e=0;var g=d.length;for(var f=0;f<g;f++){var l=d[f];if(l.properties["oryx-activitytype"]=="Task"){k[e]=l;if(k[e].properties["oryx-id"]==""){k[e].setProperty("oryx-id",k[e].id)}if(e==0){a=k[e].properties["oryx-id"]}else{a=a+"; "+k[e].properties["oryx-id"]}e++}}if(k.length>1){for(var h=0;h<k.length;h++){var b=[];var c=false;if(k[h].properties["oryx-separationofduties"]!=""){b=this.separationsCheck(k[h],a);if(b[3]==true){break}}else{b[1]=0;b[2]=0}if(k[h].properties["oryx-bindingsofduties"]!=("")){c=this.bindingsCheck(k[h],a);if(c==true){break}}this.writeEntry(b,a,k[h])}}else{alert("Please select at least two tasks to define constraints for.")}},separationsCheck:function(d,q){var E=[];var a=[];var b=[];var D=0;var f=1;var C=0;var A=0;var u=0;var B=d.properties["oryx-separationofduties"];B=B.toString();var t=B.substring(0,B.indexOf("]"));while(B.indexOf(",")>-1){if(C%2==1){a[A]=parseInt(B.substring((B.indexOf('"'))+1));A++;B=B.substring((B.indexOf(","))+1)}else{if(C==0){D=parseInt(B.substring((B.indexOf(":"))+1));B=B.substring((B.indexOf(","))+1)}else{B=B.substring((B.indexOf('"'))+1);b[u]=B.substring(0,B.indexOf('"'));u++;B=B.substring((B.indexOf(","))+1)}}C++}if(B.indexOf('"')>-1){b[u]=B.substring((B.indexOf('"'))+1)}else{b[u]=B}b[u]=b[u].substring(0,b[u].indexOf('"'));var v=q;var c=[];var r=[];var h=0;var s=false;while(v.indexOf(";")>-1){c[h]=v.substring(0,v.indexOf(";"));v=v.substring((v.indexOf(";"))+2);h++}c[h]=v;for(var e=0;e<b.length;e++){var g=0;var l=0;while(b[e].indexOf(";")>-1){r[g]=b[e].substring(0,b[e].indexOf(";"));b[e]=b[e].substring((b[e].indexOf(";"))+2);g++}r[g]=b[e];g++;if(c.length==r.length){for(var k=0;k<r.length;k++){for(var p=0;p<c.length;p++){if(c[p]==r[k]){s=true;break}s=false}if(s==false){break}}}else{if(c.length>r.length){for(var k=0;k<r.length;k++){for(var p=0;p<c.length;p++){if(c[p]==r[k]){l++;break}}if(l==r.length){var o=this.deleteSeparationEntry(d,(e+1));t=o[0];D=o[1];l=0;break}}s=false}else{for(var k=0;k<c.length;k++){for(var p=0;p<r.length;p++){if(r[p]==c[k]){s=true;break}s=false}if(s==false){break}}}}r.splice(0,r.length);if(s==true){break}}for(var e=0;e<a.length;e++){if(a[e]>f){f=a[e]}}E[0]=t;E[1]=D;E[2]=f;E[3]=s;return E},bindingsCheck:function(c,k){var y;var p=[];var r=0;var o=0;var z=c.properties["oryx-bindingsofduties"];z=z.toString();while(z.indexOf(",")>-1){if(r%2==1){z=z.substring((z.indexOf(","))+1)}else{if(r==0){z=z.substring((z.indexOf(","))+1)}else{z=z.substring((z.indexOf('"'))+1);p[o]=z.substring(0,z.indexOf('"'));o++;z=z.substring((z.indexOf(","))+1)}}r++}if(z.indexOf('"')>-1){p[o]=z.substring((z.indexOf('"'))+1)}else{p[o]=z}p[o]=p[o].substring(0,p[o].indexOf('"'));var u=k;var e=[];var b=[];var n=0;var m=0;var a=false;while(u.indexOf(";")>-1){e[n]=u.substring(0,u.indexOf(";"));u=u.substring((u.indexOf(";"))+2);n++}e[n]=u;for(var d=0;d<p.length;d++){while(p[d].indexOf(";")>-1){b[m]=p[d].substring(0,p[d].indexOf(";"));p[d]=p[d].substring((p[d].indexOf(";"))+2);m++}b[m]=p[d];var v=0;if(e.length>=b.length){for(var g=0;g<b.length;g++){for(var h=0;h<e.length;h++){if(e[h]==b[g]){v++;if(v==2){a=true}break}a=false}if(a==true){break}}}else{for(var g=0;g<e.length;g++){for(var h=0;h<b.length;h++){if(b[h]==e[g]){v++;if(v==2){a=true}break}a=false}if(a==true){break}}}if(a==true){var f=confirm("Do you want to delete the existing contradicting binding for allowing this separation constraint to be entered? Otherwise, this separation constraint will be discarded.");if(f==true){this.findBindingEntry(k);a=false}break}}y=a;return y},writeEntry:function(a,c,b){if(a[1]>0){a[1]++;a[2]++;a[0]=a[0].substring((a[0].indexOf(":"))+2);a[0]="{'totalCount':"+a[1]+a[0]+', {sodId:"'+a[2]+'", SeparatedTasks:"'+c+'"}]}'}else{a[1]=1;a[2]++;a[0]="{'totalCount':"+a[1]+", 'items':[{sodId:\""+a[2]+'", SeparatedTasks:"'+c+'"}]}'}b.setProperty("oryx-separationofduties",a[0])},deleteSeparationEntry:function(h,c){var f=[];var e=h.properties["oryx-separationofduties"];var d;var b;var a=parseInt(e.substring((e.indexOf(":"))+1));a=a-1;if(a>0){e=e.substring(e.indexOf("["));d=e.substring(0,e.indexOf("{"));e=e.substring(e.indexOf("{"));b=e.substring(0,(e.indexOf('"'))+1);e=e.substring((e.indexOf('"'))+1);while(parseInt(e)!=c){d=d+b+e.substring(0,(e.indexOf("{"))-2);e=e.substring((e.indexOf("{"))-2);b=e.substring(0,((e.indexOf('"'))+1));e=e.substring((e.indexOf('"'))+1)}e=e.substring((e.indexOf("}"))+3);var g="{'totalCount':"+a+", 'items':"+d+e+"]}";h.setProperty("oryx-separationofduties",g);g=g.toString();g=g.substring(0,g.indexOf("]"))}else{var g="";h.setProperty("oryx-separationofduties",g)}f[0]=g;f[1]=a;return f},findBindingEntry:function(b){var a=b;var u=[];var l=0;while(a.indexOf(";")>-1){u[l]=a.substring(0,a.indexOf(";"));a=a.substring((a.indexOf(";"))+2);l++}u[l]=a;a=b+";";for(var o=0;o<u.length;o++){var c=this.getTaskById(u[o]);var w=c.properties["oryx-bindingsofduties"];var n=[];var r=0;var q=0;var p=0;while(w.indexOf(",")>-1){if(q%2==1){w=w.substring((w.indexOf(","))+1)}else{if(q==0){r=parseInt(w.substring((w.indexOf(":"))+1));w=w.substring((w.indexOf(","))+1)}else{w=w.substring((w.indexOf('"'))+1);n[p]=w.substring(0,w.indexOf('"'));p++;w=w.substring((w.indexOf(","))+1)}}q++}if(w.indexOf('"')>-1){n[p]=w.substring((w.indexOf('"'))+1)}else{n[p]=w}n[p]=n[p].substring(0,n[p].indexOf('"'));var d=[];for(var e=0;e<n.length;e++){var v=n[e];var k=0;while(v.indexOf(";")>-1){d[k]=v.substring(0,v.indexOf(";"));v=v.substring((v.indexOf(";"))+2);k++}d[k]=v;if(u.length>=d.length){var h=0;for(var g=0;g<d.length;g++){for(var f=0;f<u.length;f++){if(d[g]==u[f]){h++;break}}if(h==d.length){this.deleteBindingEntry(c,(e+1));break}}}d.splice(0,d.length)}}},deleteBindingEntry:function(e,c){var g=e.properties["oryx-bindingsofduties"];var f;var b;var a=parseInt(g.substring((g.indexOf(":"))+1));a=a-1;if(a>0){g=g.substring(g.indexOf("["));f=g.substring(0,g.indexOf("{"));g=g.substring(g.indexOf("{"));b=g.substring(0,(g.indexOf('"'))+1);g=g.substring((g.indexOf('"'))+1);while(parseInt(g)!=c){f=f+b+g.substring(0,(g.indexOf("{"))-2);g=g.substring((g.indexOf("{"))-2);b=g.substring(0,((g.indexOf('"'))+1));g=g.substring((g.indexOf('"'))+1)}g=g.substring((g.indexOf("}"))+3);var d="{'totalCount':"+a+", 'items':"+f+g+"]}";e.setProperty("oryx-bindingsofduties",d);d=d.toString();d=d.substring(0,d.indexOf("]"))}else{var d="";e.setProperty("oryx-bindingsofduties",d)}},getTaskById:function(d){var a=this.facade.getCanvas().getChildShapes(true);var b;for(var c=0;c<a.length;c++){if(a[c].properties["oryx-activitytype"]=="Task"){if(a[c].properties["oryx-id"]==d){b=a[c];break}}}return b}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ResourcesSoDShow=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedOverlayEventIds=[];this.raisedHighlightEventIds=[];this.facade.offer({name:ORYX.I18N.ResourcesSoDShow.name,functionality:this.showSoD.bind(this),group:ORYX.I18N.ResourcesSoDShow.group,dropDownGroupIcon:ORYX.PATH+"images/sod.png",icon:ORYX.PATH+"images/sod_view.png",description:ORYX.I18N.ResourcesSoDShow.desc,index:2,toggle:true,minShape:1,maxShape:1})},showSoD:function(){this.removeHighlightsAndOverlays();var a=this.facade.getSelection();if(a[0].properties["oryx-activitytype"]=="Task"){this.highlightSelectedTask(a[0]);this.prepareOverlays(a[0])}else{alert("Please select a task to show the related Separation of Duties constraints.")}},highlightSelectedTask:function(a){if(!(a instanceof ORYX.Core.Shape)){return}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:a.properties["oryx-id"],elements:[a],color:"#FF0000"});this.raisedHighlightEventIds.push(a.properties["oryx-id"])},showOverlaysForSeparations:function(c,g){if(!(c instanceof ORYX.Core.Shape)){return}var h={fill:"#FF0000",stroke:"white","stroke-width":1};this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:c.properties["oryx-id"],shapes:[c],attributes:h});var d=0;var b;var l;var k;var f;var e;for(index=0;index<this.raisedOverlayEventIds.length;index++){if(c.properties["oryx-id"]==this.raisedOverlayEventIds[index]){d++}}switch(d){case 0:b="NW";l=9;k=17;f=13;e=13;break;case 1:b="NE";l=-17;k=17;f=-13;e=13;break;case 2:b="SW";l=9;k=-9;f=13;e=-13;break;case 3:b="SE";l=-17;k=-9;f=-13;e=-13;break;case 4:b="N";l=-4;k=17;f=0;e=13;break;case 5:b="S";l=-4;k=-9;f=0;e=-13;break;case 6:b="W";l=9;k=4;f=13;e=0;break;case 7:b="E";l=-17;k=4;f=-13;e=0;break;case 8:alert("There exist more Separation of Duties constraints for task "+c.properties["oryx-id"]+", but they will not be illustrated by a number in that task's rectangle.");break;default:break}if(g>=10){l=l-4}if(d<8){var a=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["circle",{cx:f,cy:e,r:"10",stroke:"white",fill:"white","stroke-width":"2"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:c.properties["oryx-id"],shapes:[c],node:a,nodePosition:b});var m=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{x:l,y:k,style:"font-size: 12px;"},g]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:c.properties["oryx-id"],shapes:[c],node:m,nodePosition:b})}this.raisedOverlayEventIds.push(c.properties["oryx-id"])},prepareOverlays:function(c){if(c.properties["oryx-separationofduties"]!=""){var e=c.properties["oryx-separationofduties"].evalJSON();var b=e.items.toArray();var a;for(var d=0;d<b.length;d++){var f=b[d].SeparatedTasks;while(f.indexOf(";")>-1){a=this.getTaskById(f.substring(0,f.indexOf(";")));f=f.substring((f.indexOf(";"))+2);this.showOverlaysForSeparations(a,d+1)}a=this.getTaskById(f);this.showOverlaysForSeparations(a,d+1)}}else{alert("No Separation of Duties Constraints are defined for this task")}},removeHighlightsAndOverlays:function(){var d=this.facade.getCanvas().getChildShapes(true);var c=[];var b=0;for(var a=0;a<d.length;a++){if(d[a].properties["oryx-activitytype"]=="Task"){c[b]=d[a].properties["oryx-id"];b++}}c.each(function(e){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:e})}.bind(this));this.raisedHighlightEventIds=[];c.each(function(e){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:e})}.bind(this));this.raisedOverlayEventIds=[]},getTaskById:function(d){var a=this.facade.getCanvas().getChildShapes(true);var b;for(var c=0;c<a.length;c++){if(a[c].properties["oryx-activitytype"]=="Task"){if(a[c].properties["oryx-id"]==d){b=a[c];break}}}return b}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ResourcesBoDAdd=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.ResourcesBoDAdd.name,functionality:this.defineBoD.bind(this),group:ORYX.I18N.ResourcesBoDAdd.group,dropDownGroupIcon:ORYX.PATH+"images/bod.png",icon:ORYX.PATH+"images/bod+.png",description:ORYX.I18N.ResourcesBoDAdd.desc,index:3,toggle:false,minShape:2,maxShape:0})},defineBoD:function(){var d=this.facade.getSelection();var k=[];var a;var e=0;var g=d.length;for(var f=0;f<g;f++){var l=d[f];if(l.properties["oryx-activitytype"]=="Task"){k[e]=l;if(k[e].properties["oryx-id"]==""){k[e].setProperty("oryx-id",k[e].id)}if(e==0){a=k[e].properties["oryx-id"]}else{a=a+"; "+k[e].properties["oryx-id"]}e++}}if(k.length>1){for(var h=0;h<k.length;h++){var c=[];var b=false;if(k[h].properties["oryx-bindingsofduties"]!=""){c=this.bindingsCheck(k[h],a);if(c[3]==true){break}}else{c[1]=0;c[2]=0}if(k[h].properties["oryx-separationofduties"]!=("")){b=this.separationsCheck(k[h],a);if(b==true){break}}this.writeEntry(c,a,k[h])}}else{alert("Please select at least two tasks to define constraints for.")}},bindingsCheck:function(c,r){var D=[];var a=[];var b=[];var B=0;var f=1;var A=0;var v=0;var u=0;var E=c.properties["oryx-bindingsofduties"];E=E.toString();var s=E.substring(0,E.indexOf("]"));while(E.indexOf(",")>-1){if(A%2==1){a[v]=parseInt(E.substring((E.indexOf('"'))+1));v++;E=E.substring((E.indexOf(","))+1)}else{if(A==0){B=parseInt(E.substring((E.indexOf(":"))+1));E=E.substring((E.indexOf(","))+1)}else{E=E.substring((E.indexOf('"'))+1);b[u]=E.substring(0,E.indexOf('"'));u++;E=E.substring((E.indexOf(","))+1)}}A++}if(E.indexOf('"')>-1){b[u]=E.substring((E.indexOf('"'))+1)}else{b[u]=E}b[u]=b[u].substring(0,b[u].indexOf('"'));var C=r;var e=[];var o=[];var h=0;var t=false;while(C.indexOf(";")>-1){e[h]=C.substring(0,C.indexOf(";"));C=C.substring((C.indexOf(";"))+2);h++}e[h]=C;for(var d=0;d<b.length;d++){var g=0;var l=0;while(b[d].indexOf(";")>-1){o[g]=b[d].substring(0,b[d].indexOf(";"));b[d]=b[d].substring((b[d].indexOf(";"))+2);g++}o[g]=b[d];g++;if(e.length==o.length){for(var k=0;k<o.length;k++){for(var q=0;q<e.length;q++){if(e[q]==o[k]){t=true;break}t=false}if(t==false){break}}}else{if(e.length>o.length){for(var k=0;k<o.length;k++){for(var q=0;q<e.length;q++){if(e[q]==o[k]){l++;break}}if(l==o.length){var p=this.deleteBindingEntry(c,(d+1));s=p[0];B=p[1];l=0;break}}t=false}else{for(var k=0;k<e.length;k++){for(var q=0;q<o.length;q++){if(o[q]==e[k]){t=true;break}t=false}if(t==false){break}}}}o.splice(0,o.length);if(t==true){break}}for(var d=0;d<a.length;d++){if(a[d]>f){f=a[d]}}D[0]=s;D[1]=B;D[2]=f;D[3]=t;return D},separationsCheck:function(c,h){var z;var p=[];var u=0;var o=0;var v=c.properties["oryx-separationofduties"];v=v.toString();while(v.indexOf(",")>-1){if(u%2==1){v=v.substring((v.indexOf(","))+1)}else{if(u==0){v=v.substring((v.indexOf(","))+1)}else{v=v.substring((v.indexOf('"'))+1);p[o]=v.substring(0,v.indexOf('"'));o++;v=v.substring((v.indexOf(","))+1)}}u++}if(v.indexOf('"')>-1){p[o]=v.substring((v.indexOf('"'))+1)}else{p[o]=v}p[o]=p[o].substring(0,p[o].indexOf('"'));var r=h;var b=[];var n=[];var m=0;var k=0;var a=false;while(r.indexOf(";")>-1){b[m]=r.substring(0,r.indexOf(";"));r=r.substring((r.indexOf(";"))+2);m++}b[m]=r;for(var d=0;d<p.length;d++){while(p[d].indexOf(";")>-1){n[k]=p[d].substring(0,p[d].indexOf(";"));p[d]=p[d].substring((p[d].indexOf(";"))+2);k++}n[k]=p[d];var y=0;if(b.length>=n.length){for(var f=0;f<n.length;f++){for(var g=0;g<b.length;g++){if(b[g]==n[f]){y++;if(y==2){a=true}break}a=false}if(a==true){break}}}else{for(var f=0;f<b.length;f++){for(var g=0;g<n.length;g++){if(n[g]==b[f]){y++;if(y==2){a=true}break}a=false}if(a==true){break}}}if(a==true){var e=confirm("Do you want to delete the existing contradicting separation for allowing this binding constraint to be entered? Otherwise, this binding constraint will be discarded.");if(e==true){this.findSeparationEntry(h);a=false}break}}z=a;return z},writeEntry:function(a,c,b){if(a[1]>0){a[1]++;a[2]++;a[0]=a[0].substring((a[0].indexOf(":"))+2);a[0]="{'totalCount':"+a[1]+a[0]+', {bodId:"'+a[2]+'", BoundTasks:"'+c+'"}]}'}else{a[1]=1;a[2]++;a[0]="{'totalCount':"+a[1]+", 'items':[{bodId:\""+a[2]+'", BoundTasks:"'+c+'"}]}'}b.setProperty("oryx-bindingsofduties",a[0])},deleteBindingEntry:function(f,c){var d=[];var h=f.properties["oryx-bindingsofduties"];var g;var b;var a=parseInt(h.substring((h.indexOf(":"))+1));a=a-1;if(a>0){h=h.substring(h.indexOf("["));g=h.substring(0,h.indexOf("{"));h=h.substring(h.indexOf("{"));b=h.substring(0,(h.indexOf('"'))+1);h=h.substring((h.indexOf('"'))+1);while(parseInt(h)!=c){g=g+b+h.substring(0,(h.indexOf("{"))-2);h=h.substring((h.indexOf("{"))-2);b=h.substring(0,((h.indexOf('"'))+1));h=h.substring((h.indexOf('"'))+1)}h=h.substring((h.indexOf("}"))+3);var e="{'totalCount':"+a+", 'items':"+g+h+"]}";f.setProperty("oryx-bindingsofduties",e);e=e.toString();e=e.substring(0,e.indexOf("]"))}else{var e="";f.setProperty("oryx-bindingsofduties",e)}d[0]=e;d[1]=a;return d},findSeparationEntry:function(b){var a=b;var v=[];var k=0;while(a.indexOf(";")>-1){v[k]=a.substring(0,a.indexOf(";"));a=a.substring((a.indexOf(";"))+2);k++}v[k]=a;a=b+";";for(var o=0;o<v.length;o++){var c=this.getTaskById(v[o]);var p=c.properties["oryx-separationofduties"];var l=[];var u=0;var r=0;var q=0;while(p.indexOf(",")>-1){if(r%2==1){p=p.substring((p.indexOf(","))+1)}else{if(r==0){u=parseInt(p.substring((p.indexOf(":"))+1));p=p.substring((p.indexOf(","))+1)}else{p=p.substring((p.indexOf('"'))+1);l[q]=p.substring(0,p.indexOf('"'));q++;p=p.substring((p.indexOf(","))+1)}}r++}if(p.indexOf('"')>-1){l[q]=p.substring((p.indexOf('"'))+1)}else{l[q]=p}l[q]=l[q].substring(0,l[q].indexOf('"'));var w=[];for(var d=0;d<l.length;d++){var n=l[d];var h=0;while(n.indexOf(";")>-1){w[h]=n.substring(0,n.indexOf(";"));n=n.substring((n.indexOf(";"))+2);h++}w[h]=n;if(v.length>=w.length){var g=0;for(var f=0;f<w.length;f++){for(var e=0;e<v.length;e++){if(w[f]==v[e]){g++;break}}if(g==w.length){this.deleteSeparationEntry(c,(d+1));break}}}w.splice(0,w.length)}}},deleteSeparationEntry:function(g,c){var e=g.properties["oryx-separationofduties"];var d;var b;var a=parseInt(e.substring((e.indexOf(":"))+1));a=a-1;if(a>0){e=e.substring(e.indexOf("["));d=e.substring(0,e.indexOf("{"));e=e.substring(e.indexOf("{"));b=e.substring(0,(e.indexOf('"'))+1);e=e.substring((e.indexOf('"'))+1);while(parseInt(e)!=c){d=d+b+e.substring(0,(e.indexOf("{"))-2);e=e.substring((e.indexOf("{"))-2);b=e.substring(0,((e.indexOf('"'))+1));e=e.substring((e.indexOf('"'))+1)}e=e.substring((e.indexOf("}"))+3);var f="{'totalCount':"+a+", 'items':"+d+e+"]}";g.setProperty("oryx-separationofduties",f);f=f.toString();f=f.substring(0,f.indexOf("]"))}else{var f="";g.setProperty("oryx-separationofduties",f)}},getTaskById:function(d){var a=this.facade.getCanvas().getChildShapes(true);var b;for(var c=0;c<a.length;c++){if(a[c].properties["oryx-activitytype"]=="Task"){if(a[c].properties["oryx-id"]==d){b=a[c];break}}}return b}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ResourcesBoDShow=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedOverlayEventIds=[];this.raisedHighlightEventIds=[];this.facade.offer({name:ORYX.I18N.ResourcesBoDShow.name,functionality:this.showBoD.bind(this),group:ORYX.I18N.ResourcesBoDShow.group,dropDownGroupIcon:ORYX.PATH+"images/bod.png",icon:ORYX.PATH+"images/bod_view.png",description:ORYX.I18N.ResourcesBoDShow.desc,index:4,toggle:true,minShape:1,maxShape:1})},showBoD:function(){this.removeHighlightsAndOverlays();var a=this.facade.getSelection();if(a[0].properties["oryx-activitytype"]=="Task"){this.highlightSelectedTask(a[0]);this.prepareOverlays(a[0])}else{alert("Please select a task to show the related Binding of Duties constraints.")}},highlightSelectedTask:function(a){if(!(a instanceof ORYX.Core.Shape)){return}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_SHOW,highlightId:a.properties["oryx-id"],elements:[a],color:"#28BB25"});this.raisedHighlightEventIds.push(a.id)},showOverlaysForSeparations:function(c,g){if(!(c instanceof ORYX.Core.Shape)){return}var h={fill:"#28BB25",stroke:"white","stroke-width":1};this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:c.properties["oryx-id"],shapes:[c],attributes:h});var d=0;var b;var l;var k;var f;var e;for(index=0;index<this.raisedOverlayEventIds.length;index++){if(c.properties["oryx-id"]==this.raisedOverlayEventIds[index]){d++}}switch(d){case 0:b="NW";l=9;k=17;f=13;e=13;break;case 1:b="NE";l=-17;k=17;f=-13;e=13;break;case 2:b="SW";l=9;k=-9;f=13;e=-13;break;case 3:b="SE";l=-17;k=-9;f=-13;e=-13;break;case 4:b="N";l=-4;k=17;f=0;e=13;break;case 5:b="S";l=-4;k=-9;f=0;e=-13;break;case 6:b="W";l=9;k=4;f=13;e=0;break;case 7:b="E";l=-17;k=4;f=-13;e=0;break;case 8:alert("There exist more Binding of Duties constraints for task "+c.properties["oryx-id"]+", but they will not be illustrated by a number in that task's rectangle.");break;default:break}if(g>=10){l=l-4}if(d<8){var a=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["circle",{cx:f,cy:e,r:"10",stroke:"white",fill:"white","stroke-width":"2"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:c.properties["oryx-id"],shapes:[c],node:a,nodePosition:b});var m=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["text",{x:l,y:k,style:"font-size: 12px;"},g]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:c.properties["oryx-id"],shapes:[c],node:m,nodePosition:b})}this.raisedOverlayEventIds.push(c.properties["oryx-id"])},prepareOverlays:function(c){if(c.properties["oryx-bindingsofduties"]!=""){var e=c.properties["oryx-bindingsofduties"].evalJSON();var b=e.items.toArray();var a;for(var d=0;d<b.length;d++){var f=b[d].BoundTasks;while(f.indexOf(";")>-1){a=this.getTaskById(f.substring(0,f.indexOf(";")));f=f.substring((f.indexOf(";"))+2);this.showOverlaysForSeparations(a,d+1)}a=this.getTaskById(f);this.showOverlaysForSeparations(a,d+1)}}else{alert("No Binding of Duties Constraints are defined for this task")}},removeHighlightsAndOverlays:function(){var d=this.facade.getCanvas().getChildShapes(true);var c=[];var b=0;for(var a=0;a<d.length;a++){if(d[a].properties["oryx-activitytype"]=="Task"){c[b]=d[a].properties["oryx-id"];b++}}c.each(function(e){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:e})}.bind(this));this.raisedHighlightEventIds=[];c.each(function(e){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:e})}.bind(this));this.raisedOverlayEventIds=[]},getTaskById:function(d){var a=this.facade.getCanvas().getChildShapes(true);var b;for(var c=0;c<a.length;c++){if(a[c].properties["oryx-activitytype"]=="Task"){if(a[c].properties["oryx-id"]==d){b=a[c];break}}}return b}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ResourceAssignment=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.ResourceAssignment.name,functionality:this.assignResource.bind(this),group:ORYX.I18N.ResourceAssignment.group,icon:ORYX.PATH+"images/hr.png",description:ORYX.I18N.ResourceAssignment.desc,index:0,toggle:false,minShape:1,maxShape:0})},assignResource:function(){var c=this.facade.getSelection();var m=[];var g=[];var d=0;var h=c.length;for(var f=0;f<h;f++){var o=c[f];if(o.properties["oryx-activitytype"]=="Task"){m[d]=o;if(m[d].properties["oryx-id"]==""){m[d].setProperty("oryx-id",m[d].id)}d++}}var b=this.handleAllocationTypeData(m[0].properties["oryx-id"]);if(b[0]!=null){var n=b[0];var k=b[1];if(n!="--automatic execution--"){var a=new Ext.Window({frame:true,title:"Please choose resources for assignment",width:600,modal:true,closable:false,plain:true,items:{xtype:"checkbox",boxLabel:n.resource[0].resource,name:"checkbox0"},buttons:[{text:"Select",handler:function(){a.close();g=this.getCheckedValues(a);this.writeAssignments(g,m,k)}.bind(this)},{text:"Close",handler:function(){a.close()}.bind(this)}]});var e;var l;for(var f=1;f<n.resource.length;f++){l="checkbox"+f;e=new Ext.form.Checkbox({boxLabel:n.resource[f].resource,name:l});a.add(e)}a.show()}else{g[0]=n;this.writeAssignments(g,m,k)}}},getResourceData:function(a){var b;new Ajax.Request(ORYX.CONFIG.ROOT_PATH+"resourceList",{method:"POST",asynchronous:false,parameters:{allocation:a},onSuccess:function(c){b=c.responseText.evalJSON();returnValue=b}.bind(this)});return b},getCheckedValues:function(b){var a=[];var d=0;for(var c=0;c<b.items.items.length;c++){if(b.items.items[c].checked==true){a[d]=b.items.items[c].boxLabel;d++}}return a},writeAssignments:function(b,p,h){for(var o=0;o<p.length;o++){var f;var a=p[o];if(a.properties["oryx-resourceassignments"]!=""){var k=a.properties["oryx-resourceassignments"].evalJSON();var q=parseInt(k.totalCount)+b.length;var g=k.items.toArray();for(var e=0;e<b.length;e++){for(var d=0;d<g.length;d++){if(g[d].assignmentName==b[e]){if(g[d].assignmentType==h){b.splice(e,1);q--;e--;break}}}}f="{'totalCount':"+q+", 'items':[{assignmentType:\""+g[0].assignmentType+'", assignmentName:"'+g[0].assignmentName+'"}';for(var l=1;l<g.length;l++){f=f+', {assignmentType:"'+g[l].assignmentType+'", assignmentName:"'+g[l].assignmentName+'"}'}for(var l=0;l<b.length;l++){f=f+', {assignmentType:"'+h+'", assignmentName:"'+b[l]+'"}'}f=f+"]}"}else{f="{'totalCount':"+b.length+", 'items':[{assignmentType:\""+h+'", assignmentName:"'+b[0]+'"}';for(var l=1;l<b.length;l++){f=f+', {assignmentType:"'+h+'", assignmentName:"'+b[l]+'"}'}f=f+"]}"}a.setProperty("oryx-resourceassignments",f)}},handleAllocationTypeData:function(a){var b=[];var d;var c=prompt("for task "+a+"\n1: direct, \n2: role, \n3: org, \n4: auto");if(c!="1"&&c!="2"&&c!="3"&&c!="4"&&c!=null){alert("wrong entry, please try again");b=this.handleAllocationTypeData(a)}else{if(c=="1"){d=this.getResourceData("direct");c="Single User"}else{if(c=="2"){d=this.getResourceData("functional");c="Functional Role"}else{if(c=="3"){d=this.getResourceData("organisational");c="Organisational Role"}else{if(c=="4"){d="--automatic execution--";c="Automatic Execution"}else{if(c==null){d=null}}}}}b[0]=d;b[1]=c}return b},getSavedAssignmentsData:function(c){var b=[];var f=[];var l=0;var h=1;var e=0;var d=0;var a=c.properties["oryx-resourceassignments"];a=a.toString();var k=a.substring(0,a.indexOf("]"));while(a.indexOf(",")>-1){if(e%2==1){f[d]=parseInt(a.substring((a.indexOf('"'))+1));d++;a=a.substring((a.indexOf(","))+1)}else{if(e==0){l=parseInt(a.substring((a.indexOf(":"))+1));a=a.substring((a.indexOf(","))+1)}else{a=a.substring((a.indexOf(","))+1)}}e++}for(var g=0;g<f.length;g++){if(f[g]>h){h=f[g]}}b[0]=k;b[1]=l;b[2]=h;return b}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.ClearSodBodHighlights=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.ClearSodBodHighlights.name,functionality:this.removeHighlightsAndOverlays.bind(this),group:ORYX.I18N.ClearSodBodHighlights.group,icon:ORYX.PATH+"images/sod_bod_view_clear.png",description:ORYX.I18N.ClearSodBodHighlights.desc,index:5,toggle:false,minShape:0,maxShape:0})},removeHighlightsAndOverlays:function(){var d=this.facade.getCanvas().getChildShapes(true);var c=[];var b=0;for(var a=0;a<d.length;a++){if(d[a].properties["oryx-activitytype"]=="Task"){if(d[a].properties["oryx-id"]!=""){c[b]=d[a].properties["oryx-id"];b++}}}c.each(function(e){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_HIGHLIGHT_HIDE,highlightId:e})}.bind(this));c.each(function(e){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:e})}.bind(this))}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.EPC2BPMN=Clazz.extend({facade:undefined,EPC_NAMESPACE:"http://b3mn.org/stencilset/epc#",BPMN1_0_NAMESPACE:"http://b3mn.org/stencilset/bpmn#",BPMN1_1_NAMESPACE:"http://b3mn.org/stencilset/bpmn1.1#",construct:function(a){this.facade=a;Facade=a;this.isBPMN1_0=this.facade.getStencilSets().keys().include(this.BPMN1_0_NAMESPACE);this.isBPMN1_1=this.facade.getStencilSets().keys().include(this.BPMN1_1_NAMESPACE);if(!this.isBPMN1_0&&!this.isBPMN1_1){return}this.facade.offer({name:"EPC to BPMN transform",functionality:this.startTransform.bind(this),group:"epc",icon:ORYX.PATH+"images/epc_export.png",description:"Import from EPC",index:1,minShape:0,maxShape:0})},startTransform:function(){this.showPanel(this.sendRequest.bind(this))},sendRequest:function(c){var a=new Ext.Window({id:"oryx-loading-panel_epc2bpmn",bodyStyle:"padding: 8px",title:"Oryx",width:230,height:55,modal:true,resizable:false,closable:false,frame:true,html:'<span style="font-size:11px;">Please wait while importing...</span>'});a.show();if(!c||!c.url){return}var b="./engineproxy?url="+c.url;new Ajax.Request(b,{method:"GET",onSuccess:function(d){window.setTimeout((function(){try{this.doTransform(d.responseText,c)}catch(f){Ext.Msg.alert(ORYX.I18N.Oryx.title,"An Error is occured while importing!")}Ext.getCmp("oryx-loading-panel_epc2bpmn").close();if(c.autolayout){window.setTimeout((function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_AUTOLAYOUT_LAYOUT})}).bind(this),100)}}).bind(this),100)}.bind(this),onFailure:function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,"Request to server failed!")}.bind(this)})},doTransform:function(p,f){var s=this.parseToObject(p);var w=[];if(!s){return}var r=function(H){return s.find(function(I){return I.id==H})};var y=function(I){var H=w.find(function(J){return J.epc==I});if(H){H.shape.parent.remove(H.shape);w=w.without(H)}};var v=f&&f.events_throw?f.events_throw.split(";").compact().without("").without(" ").collect(function(H){return H.toLowerCase()}):[];var q=f&&f.events_catch?f.events_catch.split(";").compact().without("").without(" ").collect(function(H){return H.toLowerCase()}):[];var o=function(H){return v.any(function(I){return I.split(" ").all(function(J){return H.toLowerCase().include(J)})})};var k=function(H){return q.any(function(I){return I.split(" ").all(function(J){return H.toLowerCase().include(J)})})};var u=s.findAll(function(H){return H.type.endsWith("Function")});u.each(function(I){var H=this.createElement("Task",I,true);H.setProperty("oryx-name",I.title);H.setProperty("oryx-documentation",I.description);w.push({shape:H,epc:I})}.bind(this));var b=s.findAll(function(H){return H.type.endsWith("Event")});var x=b.findAll(function(H){return !s.any(function(I){return I.outgoing&&I.outgoing.any(function(J){return J.slice(1)==H.id})})});x.each(function(I){var J=k(I.title)?"StartMessageEvent":"StartEvent";var H=this.createElement(J,I,true);if(J=="StartMessageEvent"){H.setProperty("oryx-message",I.title)}else{H.setProperty("oryx-documentation",I.title+" - "+I.description)}w.push({shape:H,epc:I})}.bind(this));var e=b.findAll(function(H){return !H.outgoing});e.each(function(I){var J=this.isBPMN1_1&&o(I.title)?"MessageEndEvent":"EndEvent";var H=this.createElement(J,I,true);if(J=="MessageEndEvent"){H.setProperty("oryx-message",I.title)}else{H.setProperty("oryx-documentation",I.title+" - "+I.description)}if(this.isBPMN1_0&&o(I.title)){H.setProperty("oryx-result","Message");H.setProperty("oryx-message",I.title)}w.push({shape:H,epc:I})}.bind(this));var C=[].without.apply(b,x.concat(e));intermediateEventsCatch=C.findAll(function(H){return k(H.title)});intermediateEventsCatch.each(function(J){var I=this.isBPMN1_1?"IntermediateMessageEventCatching":"IntermediateMessageEvent";var H=this.createElement(I,J,true);H.setProperty("oryx-message",J.title);w.push({shape:H,epc:J})}.bind(this));intermediateFunctionsThrow=u.findAll(function(H){return o(H.title)});intermediateFunctionsThrow.each(function(K){y(K);var J=this.isBPMN1_1?"IntermediateMessageEventThrowing":"IntermediateMessageEvent";var L=K.outgoing?r(K.outgoing[0].slice(1)):null;if(L&&L.outgoing){var H=r(L.outgoing[0].slice(1));if(H&&H.type.endsWith("Event")&&!H.outgoing&&o(H.title)){y(H);J=this.isBPMN1_1?"MessageEndEvent":"EndEvent"}}var I=this.createElement(J,K,true);I.setProperty("oryx-message",K.title);if(this.isBPMN1_0&&J=="EndEvent"){I.setProperty("oryx-result","Message")}w.push({shape:I,epc:K})}.bind(this));var z=s.findAll(function(H){return H.type.endsWith("Connector")});z.each(function(J){var I="Exclusive_Databased_Gateway";if(J.type.endsWith("AndConnector")){I="AND_Gateway"}else{if(J.type.endsWith("OrConnector")){I="OR_Gateway"}}if(I=="Exclusive_Databased_Gateway"&&J.outgoing&&J.outgoing.all(function(K){return intermediateEventsCatch.include(r(r(K.slice(1)).outgoing[0].slice(1)))})){I="Exclusive_Eventbased_Gateway"}var H=this.createElement(I,J,true);w.push({shape:H,epc:J})}.bind(this));z.each(function(H){if(H.outgoing&&H.outgoing.length>1&&!H.type.endsWith("AndConnector")){H.outgoing.each(function(I){var J=r(I.slice(1));if(J.type.endsWith("ControlFlow")&&J.outgoing){J.outgoing.each(function(L){var K=r(L.slice(1));if(K.type.endsWith("Event")){J.expression=K.title}})}})}}.bind(this));var E=s.findAll(function(H){return H.type.endsWith("Data")});E.each(function(I){var H=this.createElement("DataObject",I,true);H.setProperty("oryx-name",I.title);H.setProperty("oryx-documentation",I.description);w.push({shape:H,epc:I})}.bind(this));var g=s.findAll(function(H){return H.type.endsWith("System")});g.each(function(I){var H=this.createElement("TextAnnotation",I,true);H.setProperty("oryx-text","Used System: "+I.title);w.push({shape:H,epc:I})}.bind(this));var n=s.findAll(function(H){return H.type.endsWith("ProcessInterface")});n.each(function(J){var I=this.isBPMN1_1?"collapsedSubprocess":"Subprocess";var H=this.createElement(I,J,true);H.setProperty("oryx-name",J.title);H.setProperty("oryx-documentation",J.description);H.setProperty("raziel-entry",J.refuri);w.push({shape:H,epc:J})}.bind(this));var d=f.organization?s.findAll(function(H){return H.type.endsWith("Organization")||H.type.endsWith("Position")}):[];var G=d.collect(function(H){return H.title}).uniq().sort();d=G.collect(function(H){return d.findAll(function(I){return I.title==H})});if(d.length>0){var t=this.createElement("Pool");var D=[];var m=[];d.each(function(I){var H=this.createElement("Lane");H.setProperty("oryx-name",I[0].title);t.add(H);D.push({shape:H,epc:I[0]});I.each(function(L){var K=L.outgoing?L.outgoing.collect(function(M){return r(M.slice(1)).outgoing[0].slice(1)}):[];var J=w.findAll(function(M){return M.epc.type.endsWith("Function")||M.epc.type.endsWith("ProcessInterface")});J=J.findAll(function(M){return K.include(M.epc.id)||(M.epc.outgoing&&M.epc.outgoing.any(function(N){return r(N.slice(1)).outgoing.first().slice(1)==L.id}))});J.each(function(M){H.add(M.shape);m.push(M)})})}.bind(this));var h=[].without.apply(w,m);var A=h.findAll(function(H){return H.epc.type.endsWith("Function")||H.epc.type.endsWith("ProcessInterface")});if(A.length>0){var F=this.createElement("Lane");t.add(F);A.each(function(H){F.add(H.shape);m.push(H)})}var h=[].without.apply(w,m);var a=function(I){if(!I){return[]}var H=[];I.each(function(J){var K=w.find(function(L){return L.epc.id==J.slice(1)});if(K){if(m.indexOf(K)>=0){throw $break}if(h.indexOf(K)>=0){H.push(K)}H=H.concat(a(K.epc.outgoing))}else{H=H.concat(a(r(J.slice(1)).outgoing))}});return H};m.each(function(H){var I=a(H.epc.outgoing);I.each(function(J){H.shape.parent.add(J.shape);h=h.without(J)})});var l=function(I){if(!I){return[]}var H;I.each(function(J){var K=w.find(function(L){return L.epc.id==J.slice(1)});if(K){if(m.indexOf(K)>=0){H=K;throw $break}H=l(K.epc.outgoing)}else{H=l(r(J.slice(1)).outgoing)}});return H};h.each(function(H){var I=l(H.epc.outgoing);if(I){I.shape.parent.add(H.shape);m.push(H)}})}var B=function(I){if(!I||!I.outgoing){return null}var H=I;var J;while(!J){H=s.find(function(K){return H.outgoing&&H.outgoing.any(function(L){return L.slice(1)==K.id})});J=w.find(function(K){return K.epc===H});if(!H||!H.outgoing){break}}return J};var c=[];w.each(function(H){if(H.epc.outgoing){H.epc.outgoing.each(function(I){var K=s.find(function(L){return(L.type.endsWith("ControlFlow")||L.type.endsWith("Relation"))&&L.id==I.slice(1)});var J=B(K);if(K&&J){c.push({from:H,edge:K,to:J})}})}});c.each(function(I){var H;if(I.edge.type.endsWith("Relation")){if(I.edge.informationflow.toLowerCase()=="true"){H=this.createElement("Association_Unidirectional",I.edge)}else{H=this.createElement("Association_Undirected",I.edge)}}else{H=this.createElement("SequenceFlow",I.edge)}var K=I.from.shape;var J=I.to.shape;H.dockers.first().setDockedShape(K);H.dockers.first().setReferencePoint({x:K.bounds.width()/2,y:K.bounds.height()/2});H.dockers.last().setDockedShape(J);H.dockers.last().setReferencePoint({x:J.bounds.width()/2,y:J.bounds.height()/2});if(I.edge.expression){H.setProperty("oryx-conditionexpression",I.edge.expression)}w.push({shape:H,epc:I.edge})}.bind(this));this.facade.getCanvas().update()},createElement:function(g,b,f,e){var a=this.facade.getStencilSets().keys()[0];var d=ORYX.Core.StencilSet.stencil(a+g);if(!d&&e){d=ORYX.Core.StencilSet.stencil(a+e)}if(!d){return null}var c=(d.type()=="node")?new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d):new ORYX.Core.Edge({eventHandlerCallback:this.facade.raiseEvent},d);this.facade.getCanvas().add(c);if(b&&b.bounds&&f){c.bounds.centerMoveTo(b.bounds.center)}return c},parseToObject:function(d){var h=new DOMParser();var f=h.parseFromString(d,"text/xml");var c=function(k){return $A(f.getElementsByTagName("div")).find(function(l){return l.getAttribute("id")==k})};var a=c("oryxcanvas");a=a?a:c("oryx-canvas123");var e=a?$A(a.childNodes).any(function(k){return k.nodeName.toLowerCase()=="a"&&k.getAttribute("rel")=="oryx-stencilset"&&k.getAttribute("href").endsWith("epc/epc.json")}):null;if(!e){this.throwErrorMessage("Imported model is not an EPC model!");return null}var b=$A(a.childNodes).collect(function(k){return k.nodeName.toLowerCase()=="a"&&k.getAttribute("rel")=="oryx-render"?k.getAttribute("href").slice(1):null}).compact();b=b.collect(function(k){return c(k)});var g=function(l){var k={};if(l.getAttribute("id")){k.id=l.getAttribute("id")}$A(l.childNodes).each(function(n){if(n.nodeName.toLowerCase()=="span"&&n.getAttribute("class")){var m=n.getAttribute("class").slice(5);k[m]=n.firstChild?n.firstChild.nodeValue:"";if(m=="bounds"){var o=$A(k[m].split(",")).collect(function(p){return Number(p)});k[m]={a:{x:o[0],y:o[1]},b:{x:o[2],y:o[3]},center:{x:o[0]+((o[2]-o[0])/2),y:o[1]+((o[3]-o[1])/2)}}}}else{if(n.nodeName.toLowerCase()=="a"&&n.getAttribute("rel")){var m=n.getAttribute("rel").split("-")[1];if(!k[m]){k[m]=[]}k[m].push(n.getAttribute("href"))}}});return k};return b.collect(function(k){return g(k)})},throwErrorMessage:function(a){Ext.Msg.alert(ORYX.I18N.Oryx.title,a)},showPanel:function(e){Ext.QuickTips.init();var b=new Ext.form.FormPanel({id:"transform-epc-bpmn-id-main",labelWidth:40,defaultType:"textfield",bodyStyle:"padding:5px",defaults:{width:300,msgTarget:"side"},items:[{text:"For the import and transformation from EPC to BPMN please set the URL to the EPC model.",xtype:"label",style:"padding-bottom:10px;display:block",width:"100%"},{fieldLabel:"URL",name:"last",allowBlank:false}]});var d=new Ext.form.FormPanel({id:"transform-epc-bpmn-id-advance",collapsed:true,labelWidth:30,defaultType:"textfield",bodyStyle:"padding:15px",defaults:{width:300,msgTarget:"side",labelSeparator:""},items:[{text:"Event-Mapping",xtype:"label",cls:"transform-epc-bpmn-title"},{text:"If u like to transform indivual event from EPC to event in BPMN, please give keyword regarding to these (separated with a ';').",xtype:"label",width:"100%",style:"margin-bottom:10px;display:block;"},{labelStyle:"background:transparent url(stencilsets/bpmn/icons/intermediate-message.png) no-repeat scroll 0px -1px;width:30px;height:20px",name:"events_catch"},{labelStyle:!this.isBPMN1_0?"background:transparent url(stencilsets/bpmn/icons/intermediate-message.png) no-repeat scroll 0px -30px;width:30px;height:20px":"display:none",name:"events_throw",style:this.isBPMN1_0?"display:none;":""},{text:"Organization",xtype:"label",style:"margin-top:10px;display:block;",cls:"transform-epc-bpmn-title"},{text:"Should the organizational units and roles maped to a pool/lane? (Required Auto-Layout)",xtype:"label",width:"100%",style:"margin-bottom:10px;display:block;"},{boxLabel:"Organization",name:"autolayout",id:"transform-epc-bpmn-id-organization",xtype:"checkbox",labelStyle:"width:30px;height:20px"},{text:"Auto-Layout",xtype:"label",style:"margin-top:10px;display:block;",cls:"transform-epc-bpmn-title"},{text:"By enable the autolayout, the model will be auto layouted afterwards with the AutoLayout Plugin. (Needs a while)",xtype:"label",width:"100%",style:"margin-bottom:10px;display:block;"},{boxLabel:"Auto-Layout",name:"autolayout",id:"transform-epc-bpmn-id-autolayout",xtype:"checkbox",labelStyle:"width:30px;height:20px"}]});Ext.getCmp("transform-epc-bpmn-id-organization").on("check",function(g,f){if(f){Ext.getCmp("transform-epc-bpmn-id-autolayout").setValue(true);Ext.getCmp("transform-epc-bpmn-id-autolayout").disable()}else{Ext.getCmp("transform-epc-bpmn-id-autolayout").enable()}});var c={text:"Advanced Settings",xtype:"button",enableToggle:true,cls:"transform-epc-bpmn-group-button",handler:function(f){var f=Ext.getCmp("transform-epc-bpmn-id-advance");if(f.collapsed){f.expand()}else{f.collapse()}}};var a=new Ext.Window({title:ORYX.I18N.Oryx.title+" - Transform EPC to BPMN",width:400,id:"transform-epc-bpmn-id-panel",cls:"transform-epc-bpmn-window",items:new Ext.Panel({frame:true,autoHeight:true,items:[b,c,d]}),floating:true,shim:true,modal:true,resizable:false,autoHeight:true,buttons:[{text:"Import",handler:function(){var f={};var g=Ext.getCmp("transform-epc-bpmn-id-main").findByType("textfield")[0];if(g.validate()){f.url=g.getValue()}if(!Ext.getCmp("transform-epc-bpmn-id-advance").collapsed){f.events_catch=Ext.getCmp("transform-epc-bpmn-id-advance").findByType("textfield")[0].getValue();if(this.isBPMN1_1){f.events_throw=Ext.getCmp("transform-epc-bpmn-id-advance").findByType("textfield")[1].getValue()}f.organization=Ext.getCmp("transform-epc-bpmn-id-advance").findByType("checkbox")[0].getValue();f.autolayout=Ext.getCmp("transform-epc-bpmn-id-advance").findByType("checkbox")[1].getValue()}Ext.getCmp("transform-epc-bpmn-id-panel").close();e(f)}.bind(this)},{text:"Cancel",handler:function(){Ext.getCmp("transform-epc-bpmn-id-panel").close()}}]});a.show()}});var Facade=undefined;if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.UML={construct:function(a){this.facade=a;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this));this.facade.registerOnEvent("layout.uml.class",this.handleLayoutClass.bind(this));this.facade.registerOnEvent("layout.uml.list",this.handleLayoutList.bind(this));this.facade.registerOnEvent("layout.uml.association",this.handleLayoutAssociation.bind(this));this.facade.registerOnEvent("layout.uml.qualified_association",this.handleLayoutQualifiedAssociation.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.addReadingDirectionOnLoad.bind(this))},addReadingDirectionOnLoad:function(a){this.facade.getCanvas().edges.each(function(b){if(b.properties["oryx-direction"]=="left"||b.properties["oryx-direction"]=="right"){this.addReadingDirection(b)}}.bind(this))},calculateLabelHeight:function(a,b){var d=a.getFontSize();var c=1;b.scan("\n",function(){c+=1});return c*d+0.75},handlePropertyChanged:function(a){if(a.key=="oryx-name"){this.addReadingDirection(a.elements[0])}},handleLayoutClass:function(b){var h=b.shape;if(h.propertiesChanged["oryx-abstract"]==true){var k=b.shape.getLabels().find(function(p){return p.id==(b.shape.id+"className")});if(h.properties["oryx-abstract"]==true){k.node.setAttribute("font-style","italic")}else{k.node.setAttribute("font-style","normal")}}if(h.propertiesChanged["oryx-attributes"]==true||h.propertiesChanged["oryx-methods"]){var l=b.shape.properties["oryx-attributes"];var n=b.shape.properties["oryx-methods"];var d=b.shape.getLabels().find(function(p){return p.id==(b.shape.id+"attributes")});var c=b.shape.getLabels().find(function(p){return p.id==(b.shape.id+"methods")});var g=b.shape._svgShapes.find(function(p){return p.element.id==(b.shape.id+"separator")}).element;var o=this.calculateLabelHeight(d,l);var f=this.calculateLabelHeight(c,n);var m=24+o+2;var a=m+f+2;g.setAttribute("y1",m);g.setAttribute("y2",m);c.y=m+3;c.node.setAttribute("y",m+3);for(var e=0;e<c.node.childElementCount;e++){c.node.childNodes[e].setAttribute("y",m+2)}h.bounds.set(h.bounds.a.x,h.bounds.a.y,h.bounds.b.x,h.bounds.a.y+a+5)}},handleLayoutList:function(e){var c=e.shape;if(c.propertiesChanged["oryx-items"]==true){var a=c.properties["oryx-items"];var b=c.getLabels().find(function(g){return g.id==(e.shape.id+"items")});var f=this.calculateLabelHeight(b,a);var d=32+f+2;c.bounds.set(c.bounds.a.x,c.bounds.a.y,c.bounds.b.x,c.bounds.a.y+d+5)}},handleLayoutAssociation:function(a){this.addReadingDirection(a.shape)},addReadingDirection:function(a){var b=a.getLabels().find(function(c){return c.id==(a.id+"name")});if(a.properties["oryx-direction"]=="left"){b.text("◀ "+a.properties["oryx-name"])}else{if(a.properties["oryx-direction"]=="right"){b.text(a.properties["oryx-name"]+" ▶")}else{b.text(a.properties["oryx-name"])}}b.update()},handleLayoutQualifiedAssociation:function(d){var a=d.shape;var c=a.getLabels().find(function(e){return e.id==(d.shape.id+"qualifier")});var b=c._estimateTextWidth(a.properties["oryx-qualifier"],12);if(b<40){b=40}a._markers.values()[0].element.lastElementChild.setAttribute("width",b+5);a._markers.values()[0].element.setAttributeNS(null,"markerWidth",b+5)},};ORYX.Plugins.UML=Clazz.extend(ORYX.Plugins.UML);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.UMLUseCase={construct:function(a){this.facade=a;this.facade.registerOnEvent("layout.uml.useCaseExtended",this.handleUseCaseExtendedLayout.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_LOADED,this.handleDiagramOnLoad.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_PROPWINDOW_PROP_CHANGED,this.handlePropertyChanged.bind(this))},handleDiagramOnLoad:function(a){this.layoutAllSystems(this.facade.getCanvas())},layoutAllSystems:function(b){this.layoutAllUseCaseExtended(b);var a=b.getChildNodes().findAll(function(c){if(this.isSystemNode(c)){return c}}.bind(this));a.each(function(c){this.layoutStereotype(c);this.layoutAllSystems(c)}.bind(this))},layoutAllUseCaseExtended:function(a){var b=a.getChildNodes().findAll(function(c){if(this.isUseCaseExtendedNode(c)){return c}}.bind(this));b.each(function(c){this.layoutUseCaseExtended(c)}.bind(this))},handleUseCaseExtendedLayout:function(b){var a=b.shape;if(a.isResized){this.SelectionEventFunction=this.handleUseCaseExtendedSelection.bind(this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this.SelectionEventFunction)}},handleUseCaseExtendedSelection:function(b){var a=b.elements.first();if(!this.isUseCaseExtendedNode(a)){return}this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_SELECTION_CHANGED,this.SelectionEventFunction);this.layoutUseCaseExtended(a)},layoutUseCaseExtended:function(e){var d=e._svgShapes.find(function(f){return f.element.id==(e.id+"extension_point_text_frame")}).element;var c=e.getLabels().find(function(f){return f.id==(e.id+"extensions")});var b=e.getLabels().find(function(f){return f.id==(e.id+"extensionpoint")});var a=d.y.baseVal.value-b.y-16;d.y.baseVal.value=b.y+16;c.y=b.y+16;d.height.baseVal.value+=a},handlePropertyChanged:function(b){var a=b.elements.first();if(!this.isSystemNode(a)){return}if(!(this.isStereotypeKeyEvent(b)||this.isNameKeyEvent(b))){return}this.layoutStereotype(a)},layoutStereotype:function(c){var a=c.getLabels().find(function(d){return d.id==(c.id+"stereotype")});var b=c.getLabels().find(function(d){return d.id==(c.id+"text")});if(a.text().empty()){b.y=a.y;a.hide()}else{b.y=a.y+14;a.show();a.text("≪"+c.properties["oryx-stereotype"]+"≫")}b.update();a.update()},isUseCaseExtendedNode:function(a){return"http://b3mn.org/stencilset/umlusecase#usecaseextended"==a.getStencil().id().toLowerCase()},isUseCaseNode:function(a){return"http://b3mn.org/stencilset/umlusecase#usecase"==a.getStencil().id().toLowerCase()},isSystemNode:function(a){return"http://b3mn.org/stencilset/umlusecase#system"==a.getStencil().id().toLowerCase()},isIncludeEdge:function(a){return"http://b3mn.org/stencilset/umlusecase#include"==a.getStencil().id().toLowerCase()},isExtendEdge:function(a){return"http://b3mn.org/stencilset/umlusecase#extend"==a.getStencil().id().toLowerCase()},isStereotypeKeyEvent:function(a){return a.key=="oryx-stereotype"},isNameKeyEvent:function(a){return a.key=="oryx-name"}};ORYX.Plugins.UMLUseCase=Clazz.extend(ORYX.Plugins.UMLUseCase);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.UMLActivity={construct:function(a){this.facade=a;this.facade.registerOnEvent("layout.uml.activityPartition",this.handleLayoutActivityPartition.bind(this))},hashedBounds:{},handleLayoutActivityPartition:function(e){var g=e.shape;var b=this.getChildActivityPartitions(g,false);var a=this.facade.getSelection().first();a=a||g;if(this.isActivityPartitionNode(g.parent)){return}if(!this.isActivityPartitionNode(g)){return}if(!this.isActivityPartitionNode(a)){return}if(b.length<=0){return}this.currentRootPartition=g;if(!this.hashedBounds[g.resourceId]){this.hashedBounds[g.resourceId]={}}var f=this.getChildActivityPartitions(g,true);var d=this.getAllAddedPartitions(f);var c=this.getAllDeletedPartitions(f);if(d.length>0){a=d.first()}if(c.length>0||d.length>0){this.resizeAfterAddorDeleteOfPartition(g,b)}else{if(g==a){this.resizeAfterRootPartitionChangend(g,b)}else{this.resizeAfterChildPartitionChanged(g,b,a)}}this.cachePositions(g,f)},cachePositions:function(b,a){this.hashedBounds[b.resourceId]={};a.each(function(c){this.hashedBounds[b.resourceId][c.resourceId]=c.absoluteBounds();this.forceToUpdateActivityPartition(c)}.bind(this))},resizeAfterAddorDeleteOfPartition:function(d,b){var c,a;c=this.updateActivityPartitionWidth(d);a=this.adjustActivityPartitionHeight(b,d.bounds.height());d.update();this.setActivityPartitionDimensions(d,c,a)},resizeAfterRootPartitionChangend:function(d,b){var c,a;c=this.adjustActivityPartitionWidth(b,undefined,d.bounds.width());a=this.adjustActivityPartitionHeight(b,d.bounds.height());this.setActivityPartitionDimensions(d,c,a)},resizeAfterChildPartitionChanged:function(e,c,b){var d,a;d=this.adjustActivityPartitionWidth(c,b);a=this.adjustActivityPartitionHeight(c,b.bounds.height()+(this.getDepth(b,e)*30));this.setActivityPartitionDimensions(e,d,a)},getAllAddedPartitions:function(a){return a.findAll(function(b){if(!this.hashedBounds[this.currentRootPartition.resourceId][b.resourceId]){return b}}.bind(this))},getAllDeletedPartitions:function(d){var c=$H(this.hashedBounds[this.currentRootPartition.resourceId]).keys();var b=c.reject(function(e){return d.any(function(f){return f.resourceId==e})});var a=b.findAll(function(e){return this.hashedBounds[this.currentRootPartition.resourceId][e]}.bind(this));return a},forceToUpdateActivityPartition:function(a){if(a.bounds.width()!==a._svgShapes[0].width){a.isChanged=true;a.isResized=true;a._update()}},getDepth:function(c,b){var a=0;while(c&&c.parent&&c!==b){c=c.parent;++a}return a},setActivityPartitionDimensions:function(b,d,a){var c=this.isActivityPartitionNode(b);c=(c&&this.isActivityPartitionNode(b.parent));b.bounds.set(b.bounds.a.x,c?30:b.bounds.a.y,d?b.bounds.a.x+d:b.bounds.b.x,a?b.bounds.a.y+a-(c?30:0):b.bounds.b.y)},setActivityPartitionPosition:function(b,a){b.bounds.moveTo(a,30)},adjustActivityPartitionHeight:function(b,a){(b||[]).each(function(c){this.setActivityPartitionDimensions(c,null,a);this.adjustActivityPartitionHeight(this.getChildActivityPartitions(c),a-30)}.bind(this));return a},adjustActivityPartitionWidth:function(c,b,e){var a=0;if(!b&&e){a=c.inject(0,function(f,g){return f+g.bounds.width()})}var d=c.inject(0,function(f,g){if(g===b){this.propagateWidthToChildren(g,f)}else{if(!b&&e){this.setChildWidthProportionallyToTheOldWidth(g,f,e,a)}else{this.getWidthFromChildPartitions(g,f,e,b)}}return f+g.bounds.width()}.bind(this));return d},propagateWidthToChildren:function(b,a){this.adjustActivityPartitionWidth(this.getChildActivityPartitions(b),undefined,b.bounds.width());b.bounds.set({y:30,x:a},{y:b.bounds.height()+30,x:b.bounds.width()+a})},setChildWidthProportionallyToTheOldWidth:function(b,e,d,a){var c=(b.bounds.width()*d)/a;this.adjustActivityPartitionWidth(this.getChildActivityPartitions(b),undefined,c);this.setActivityPartitionDimensions(b,c,null);this.setActivityPartitionPosition(b,e)},getWidthFromChildPartitions:function(a,e,d,b){var c=this.adjustActivityPartitionWidth(this.getChildActivityPartitions(a),b,d);if(!c){c=a.bounds.width()}this.setActivityPartitionDimensions(a,c,null);this.setActivityPartitionPosition(a,e)},updateActivityPartitionWidth:function(c){var a=this.getChildActivityPartitions(c);if(a.length===0){return c.bounds.width()}var b=a.inject(0,function(d,e){this.setActivityPartitionPosition(e,d);return d+this.updateActivityPartitionWidth(e)}.bind(this));this.setActivityPartitionDimensions(c,b,null);return b},getHashedBounds:function(a){return this.currentRootPartition&&this.hashedBounds[this.currentRootPartition.resourceId][a.resourceId]?this.hashedBounds[this.currentRootPartition.resourceId][a.resourceId]:a.bounds.clone()},isActivityPartitionNode:function(a){return"http://b3mn.org/stencilset/umlactivity#activitypartition"==a.getStencil().id().toLowerCase()},getChildActivityPartitions:function(b,a){var c=b.getChildNodes(a||false).findAll(function(d){if(this.isActivityPartitionNode(d)){return d}}.bind(this));c=c.sort(function(e,d){var f=Math.round(e.bounds.upperLeft().x);var g=Math.round(d.bounds.upperLeft().x);if(f==g){f=Math.round(this.getHashedBounds(e).upperLeft().x);g=Math.round(this.getHashedBounds(d).upperLeft().x)}return f<g?-1:(f>g?1:0)}.bind(this));return c}};ORYX.Plugins.UMLActivity=Clazz.extend(ORYX.Plugins.UMLActivity);if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.OverlayExample=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.el=undefined;this.callback=undefined;this.facade.offer({name:"Overlay Test",functionality:this.testing.bind(this),group:"Overlay",icon:ORYX.PATH+"images/disk.png",description:"Overlay Test",index:1,minShape:0,maxShape:0})},testing:function(){if(this.active){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"overlaytest.test"})}else{var a=this.facade.getCanvas().getChildShapes(true);this.el=a[0];this.showOverlay(this.el)}this.active=!this.active;if(this.active){this.callback=this.doMouseUp.bind(this);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEUP,this.callback)}else{this.facade.unregisterOnEvent(ORYX.CONFIG.EVENT_MOUSEUP,this.callback);this.callback=undefined}},doMouseUp:function(b,a){if(a instanceof ORYX.Core.Shape&&a!=this.el){this.el=a;this.showOverlay(this.el)}},showOverlay:function(a){var b=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"stroke-width":5,stroke:"red",d:"M0,0 L-15,-15 M-15,0 L0,-15","line-captions":"round"}]);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"overlaytest.test",shapes:[a],attributes:{fill:"red",stroke:"green","stroke-width":4},node:b,nodePosition:a instanceof ORYX.Core.Edge?"START":"NE"})}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.PluginLoader=Clazz.extend({facade:undefined,mask:undefined,processURI:undefined,construct:function(a){this.facade=a;if(!(ORYX.CONFIG.IS_TEMPLATE)){this.facade.offer({name:ORYX.I18N.PluginLoad.AddPluginButtonName,functionality:this.showManageDialog.bind(this),group:ORYX.I18N.SSExtensionLoader.group,icon:ORYX.PATH+"images/labs/script_add.png",description:ORYX.I18N.PluginLoad.AddPluginButtonDesc,index:8,minShape:0,maxShape:0})}},showManageDialog:function(){this.mask=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.Oryx.pleaseWait});this.mask.show();var f=[];var c=[];var e=this.facade.getStencilSets().keys();this.facade.getAvailablePlugins().each(function(h){if((!h.requires||!h.requires.namespaces||h.requires.namespaces.any(function(k){return e.indexOf(k)>=0}))&&(!h.notUsesIn||!h.notUsesIn.namespaces||!h.notUsesIn.namespaces.any(function(k){return e.indexOf(k)>=0}))){c.push(h)}});c.each(function(h){f.push([h.name,h.engaged===true])});if(f.length==0){return}var b=new Ext.data.ArrayReader({},[{name:"name"},{name:"engaged"}]);var g=new Ext.grid.CheckboxSelectionModel({listeners:{beforerowselect:function(m,h,k,l){this.mask=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.Oryx.pleaseWait});this.mask.show();this.facade.activatePluginByName(l.data.name,function(n,o){this.mask.hide();if(!!n){m.suspendEvents();m.selectRow(h,true);m.resumeEvents()}else{Ext.Msg.show({title:ORYX.I18N.PluginLoad.loadErrorTitle,msg:ORYX.I18N.PluginLoad.loadErrorDesc+ORYX.I18N.PluginLoad[o],buttons:Ext.MessageBox.OK})}}.bind(this));return false}.bind(this),rowdeselect:function(l,h,k){l.suspendEvents();l.selectRow(h,true);l.resumeEvents()}}});var d=new Ext.grid.GridPanel({store:new Ext.data.Store({reader:b,data:f}),cm:new Ext.grid.ColumnModel([{id:"name",width:390,sortable:true,dataIndex:"name"},g]),sm:g,width:450,height:250,frame:true,hideHeaders:true,iconCls:"icon-grid",listeners:{render:function(){var h=[];this.grid.getStore().each(function(k){if(k.data.engaged){h.push(k)}}.bind(this));this.suspendEvents();this.selectRecords(h);this.resumeEvents()}.bind(g)}});var a=new Ext.Window({title:ORYX.I18N.PluginLoad.WindowTitle,width:"auto",height:"auto",modal:true});a.add(d);a.show();this.mask.hide()}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPMN={construct:function(a){this.facade=a;this.facade.registerOnEvent("layout.bpmn.pool",this.handleLayoutBPMNPool.bind(this))},handleLayoutBPMNPool:function(f){var a=f.shape;var b=a.getChildNodes(false).findAll(function(h){return(h.getStencil().id()==="http://b3mn.org/stencilset/bpmn#Lane")});if(b.length>0){b=b.sortBy(function(h){return h.bounds.upperLeft().y});var e=a.bounds.width();var c=0;var d=0;b.each(function(h){var l=h.bounds.upperLeft();var k=h.bounds.lowerRight();l.y=c;k.y=l.y+h.bounds.height();c+=h.bounds.height();l.x=30;k.x=e;h.bounds.set(l,k)});var g=a.bounds.upperLeft();a.bounds.set(g.x,g.y,a.bounds.lowerRight().x,g.y+c)}}};ORYX.Plugins.BPMN=ORYX.Plugins.AbstractPlugin.extend(ORYX.Plugins.BPMN);if(!ORYX.Plugins){ORYX.Plugins={}}if(!ORYX.Config){ORYX.Config={}}ORYX.Config.Feedback={VISIBLE_STATE:"visible",HIDDEN_STATE:"hidden",INFO:"Lorem ipsum dolor sit amet, consectetur adipiscing elit, set eiusmod tempor incidunt et labore et dolore magna aliquam. Ut enim ad minim veniam, quis nostrud exerc. Irure dolor in reprehend incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse molestaie cillum. Tia non ob ea soluad incommod quae egen ium improb fugiend. Officia",CSS_FILE:ORYX.PATH+"/css/feedback.css"};ORYX.Plugins.Feedback=ORYX.Plugins.AbstractPlugin.extend({construct:function(a,b){this.facade=a;((b&&b.properties)||[]).each(function(d){if(d.cssfile){ORYX.Config.Feedback.CSS_FILE=d.css_file}}.bind(this));var c=document.createElement("link");c.setAttribute("rel","stylesheet");c.setAttribute("type","text/css");c.setAttribute("href",ORYX.Config.Feedback.CSS_FILE);document.getElementsByTagName("head")[0].appendChild(c);this.elements={container:null,tab:null,dialog:null,form:null,info:null};this.createFeedbackTab()},createFeedbackTab:function(){this.elements.tab=document.createElement("div");this.elements.tab.setAttribute("class","tab");this.elements.tab.innerHTML=(ORYX.I18N.Feedback.name+" &#8226;");this.elements.container=document.createElement("div");this.elements.container.setAttribute("id","feedback");this.elements.container.appendChild(this.elements.tab);document.body.appendChild(this.elements.container);Event.observe(this.elements.tab,"click",this.toggleDialog.bindAsEventListener(this))},toggleDialog:function(b){if(b){Event.stop(b)}var a=this.elements.dialog||this.createDialog();if(ORYX.Config.Feedback.VISIBLE_STATE==a.state){this.elements.tab.innerHTML=(ORYX.I18N.Feedback.name+" &#8226;");Element.hide(a);a.state=ORYX.Config.Feedback.HIDDEN_STATE}else{this.elements.tab.innerHTML=(ORYX.I18N.Feedback.name+" &#215;");Element.show(a);a.state=ORYX.Config.Feedback.VISIBLE_STATE}},createDialog:function(){if(this.elements.dialog){return this.elements.dialog}var n=function(){[o,m,d].each(function(q){q.value=q._defaultText||"";q.className="low"})};var f=function(q){var r=Event.element(q);if(r._defaultText&&r.value.strip()==r._defaultText.strip()){r.value="";r.className="high"}};var b=function(q){var r=Event.element(q);if(r._defaultText&&r.value.strip()==""){r.value=r._defaultText;r.className="low"}};this.elements.form=document.createElement("form");this.elements.form.action=ORYX.CONFIG.ROOT_PATH+"feedback";this.elements.form.method="POST";this.elements.form.onsubmit=function(){try{var q=function(){Ext.Msg.alert(ORYX.I18N.Feedback.failure,ORYX.I18N.Feedback.failureMsg);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});this.toggleDialog()};var t=function(u){if(u.status<200||u.status>=400){return q(u)}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.Feedback.success});n()};this.elements.form.model.value=this.facade.getSerializedJSON();this.elements.form.environment.value=this.getEnv();var s={};$A(this.elements.form.elements).each(function(u){s[u.name]=u.value});s.name=ORYX.Editor.Cookie.getParams().identifier;s.subject=("["+s.subject+"] "+s.title);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.Feedback.sending});new Ajax.Request(ORYX.CONFIG.ROOT_PATH+"feedback",{method:"POST",parameters:s,onSuccess:t.bind(this),onFailure:q.bind(this)});this.toggleDialog()}catch(r){q();ORYX.Log.warn(r)}return false}.bind(this);var p=document.createElement("div");p.className="fieldset";var k=document.createElement("input");k.type="hidden";k.name="subject";k.style.display="none";var o=document.createElement("textarea");o._defaultText=ORYX.I18N.Feedback.descriptionDesc;o.name="description";Event.observe(o,"focus",f.bindAsEventListener());Event.observe(o,"blur",b.bindAsEventListener());var m=document.createElement("input");m._defaultText=ORYX.I18N.Feedback.titleDesc;m.type="text";m.name="title";Event.observe(m,"focus",f.bindAsEventListener());Event.observe(m,"blur",b.bindAsEventListener());var d=document.createElement("input");d._defaultText=ORYX.I18N.Feedback.emailDesc;d.type="text";d.name="email";Event.observe(d,"focus",f.bindAsEventListener());Event.observe(d,"blur",b.bindAsEventListener());var h=document.createElement("input");h.type="button";h.className="submit";h.onclick=this.elements.form.onsubmit;if(ORYX.I18N.Feedback.submit){h.value=ORYX.I18N.Feedback.submit}var c=document.createElement("input");c.name="environment";c.type="hidden";c.style.display="none";var e=document.createElement("input");e.name="model";e.type="hidden";e.style.display="none";p.appendChild(k);p.appendChild(o);p.appendChild(m);p.appendChild(d);p.appendChild(c);p.appendChild(e);p.appendChild(h);n();var g=document.createElement("ul");g.setAttribute("class","subjects");var a=[];$A(ORYX.I18N.Feedback.subjects).each(function(r,q){try{var t=document.createElement("li");t._subject=r.id;t.className=r.id;t.innerHTML=r.name;t.style.width=parseInt(100/$A(ORYX.I18N.Feedback.subjects).length)+"%";a.push(t);g.appendChild(t);var s=function(){a.each(function(v){if(v.className.match(r.id)){v.className=v._subject+" active";k.value=r.name;if(o.value==o._defaultText){o.value=r.description}o._defaultText=r.description;if(r.info&&(""+r.info).strip().length>0){this.elements.info.innerHTML=r.info}else{this.elements.info.innerHTML=ORYX.I18N.Feedback.info||""}}else{v.className=v._subject}}.bind(this))}.bind(this);Event.observe(t,"click",s);if(q==(ORYX.I18N.Feedback.subjects.length-1)){o.value="";o._defaultText="";s()}}catch(u){ORYX.Log.warn("Incomplete I10N for ORYX.I18N.Feedback.subjects",r,ORYX.I18N.Feedback.subjects)}}.bind(this));this.elements.form.appendChild(g);this.elements.form.appendChild(p);this.elements.info=document.createElement("div");this.elements.info.setAttribute("class","info");this.elements.info.innerHTML=ORYX.I18N.Feedback.info||"";var l=document.createElement("div");l.setAttribute("class","head");this.elements.dialog=document.createElement("div");this.elements.dialog.setAttribute("class","dialog");this.elements.dialog.appendChild(l);this.elements.dialog.appendChild(this.elements.info);this.elements.dialog.appendChild(this.elements.form);this.elements.container.appendChild(this.elements.dialog);return this.elements.dialog},getEnv:function(){var b="";b+="Browser: "+navigator.userAgent;b+="\n\nBrowser Plugins: ";if(navigator.plugins){for(var a=0;a<navigator.plugins.length;a++){var c=navigator.plugins[a];b+=c.name+", "}}if((typeof(screen.width)!="undefined")&&(screen.width&&screen.height)){b+="\n\nScreen Resolution: "+screen.width+"x"+screen.height}return b}});if(!ORYX.Plugins){ORYX.Plugins={}}if(!ORYX.Config){ORYX.Config={}}ORYX.Config.SignavioFileRepositoryModelHandler="/signavio/p/model/";ORYX.Plugins.FileRepositorySave=Clazz.extend({facade:undefined,modelUri:window.location.hash.substring(1).strip()||undefined,construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.Save.save,functionality:this.save.bind(this,false),group:ORYX.I18N.Save.group,icon:ORYX.PATH+"images/disk.png",description:ORYX.I18N.Save.saveDesc,index:1,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.Save.saveAs,functionality:this.save.bind(this,true),group:ORYX.I18N.Save.group,icon:ORYX.PATH+"images/disk_multi.png",description:ORYX.I18N.Save.saveAsDesc,index:2,minShape:0,maxShape:0});this.changeDifference=0;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_EXECUTE,function(){this.changeDifference++});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_EXECUTE_COMMANDS,function(){this.changeDifference++});this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_ROLLBACK,function(){this.changeDifference--});window.onbeforeunload=function(){if(this.changeDifference>0){return ORYX.I18N.Save.unsavedData}}.bind(this)},saveAs:function(){return this.save(true)},save:function(h){h=h||!this.modelUri;var a=DataManager.serialize(this.facade.getCanvas().getSVGRepresentation(true));var f=Ext.encode(this.facade.getJSON());var k={name:"New Process",description:"",comment:"",namespace:this.facade.getStencilSets().values()[0].namespace(),json_xml:f,parent:undefined,svg_xml:a,type:this.facade.getStencilSets().values()[0].namespace()};if(this.modelUri){var c=new Ajax.Request(ORYX.Config.SignavioFileRepositoryModelHandler+this.modelUri.replace(/^\/?/,"")+"/info",{method:"GET",asynchronous:false});if(!c.transport||!c.transport.status==200){Ext.Msg.show({title:"Unable to load model data",msg:"The model does not seem to exist anymore or the model storage is unavailable. Remove the model-id (everything behind #) and try again.",buttons:Ext.MessageBox.OK});return false}var d=c.transport.responseText.evalJSON();["name","description","comment","parent","type"].each(function(l){k[l]=d[l]||k[l]})}else{var g=Ext.urlDecode(location.search.substring(1))["directory"];if(!g){Ext.Msg.show({title:"Parent Directory Missing",msg:"The model does not semm to be saved yet, however I can't find a parent diractory. Thus the model cannot be saved at all. My bad. :( \n PS: Your best shot is to try to export the model, create a new one, import andh hope for the best.",buttons:Ext.MessageBox.OK});return false}k.parent=g}if(!h){this.submit(k,false);return true}var b=new Ext.XTemplate('<form class="oryx_repository_edit_model" action="#" id="edit_model" onsubmit="return false;">',"<fieldset>",'<p class="description">'+ORYX.I18N.Save.dialogDesciption+"</p>",'<input type="hidden" name="namespace" value="{namespace}" />','<p><label for="edit_model_title">'+ORYX.I18N.Save.dialogLabelTitle+'</label><input type="text" class="text" name="title" value="{name}" id="edit_model_title" onfocus="this.className = \'text activated\'" onblur="this.className = \'text\'"/></p>','<p><label for="edit_model_summary">'+ORYX.I18N.Save.dialogLabelDesc+'</label><textarea rows="5" name="summary" id="edit_model_summary" onfocus="this.className = \'activated\'" onblur="this.className = \'\'">{description}</textarea></p>','<p><label for="edit_model_type">'+ORYX.I18N.Save.dialogLabelType+'</label><input type="text" name="type" class="text disabled" value="{type}" disabled="disabled" id="edit_model_type" /></p>',"</fieldset>","</form>");var e=new Ext.Window({width:"auto",height:"auto",title:(h?ORYX.I18N.Save.saveAsTitle:ORYX.I18N.Save.save),modal:true,bodyStyle:"background:#FFFFFF",html:b.apply(k),buttons:[{text:ORYX.I18N.Save.saveBtn,handler:function(){k.name=$("edit_model_title").value.strip();k.description=$("edit_model_summary").value.strip();this.submit(k,true);e.close()}.bind(this)},{text:ORYX.I18N.Save.close,handler:function(){e.close()}}],listeners:{close:function(){e.close()}}});e.show();return true},submit:function(e,c){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.Save.saving});if(c){new Ajax.Request(ORYX.Config.SignavioFileRepositoryModelHandler,{method:"POST",parameters:e,asynchronous:true,onSuccess:function d(f){this.modelUri=f.responseText.evalJSON()["href"].replace(/^\/?(model)?\/?/,"");location.hash=this.modelUri;this.changeDifference=0;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.Save.saved})}.bind(this),onFailure:function b(){alert("fail")}.bind(this),on403:function a(){alert("403")}.bind(this)})}else{new Ajax.Request(ORYX.Config.SignavioFileRepositoryModelHandler+this.modelUri,{method:"PUT",parameters:e,asynchronous:true,onSuccess:function d(f){this.changeDifference=0;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_STATUS,text:ORYX.I18N.Save.saved})}.bind(this),onFailure:function b(){alert("fail")}.bind(this),on403:function a(){alert("403")}.bind(this)})}}});onOryxResourcesLoaded=function(){if(location.hash.slice(1).length==0||location.hash.slice(1).indexOf("new")!=-1){var a=ORYX.Utils.getParamFromUrl("stencilset")?ORYX.Utils.getParamFromUrl("stencilset"):ORYX.CONFIG.SSET;new ORYX.Editor({id:"oryx-canvas123",stencilset:{url:ORYX.PATH+"/"+a}})}else{ORYX.Editor.createByUrl(ORYX.Config.SignavioFileRepositoryModelHandler+location.hash.slice(1).replace(/^\/?/,"")+"/json",{id:"oryx-canvas123"})}};if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.DockerCreation=Clazz.extend({construct:function(a){this.facade=a;this.active=false;this.circle=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["g",{"pointer-events":"none"},["circle",{cx:"8",cy:"8",r:"3",fill:"yellow"}]]);this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOVER,this.handleMouseOver.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOUT,this.handleMouseOut.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEMOVE,this.handleMouseMove.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_DBLCLICK,function(){window.clearTimeout(this.timer)}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEUP,function(){window.clearTimeout(this.timer)}.bind(this))},handleMouseOut:function(b,a){if(this.active){this.hideOverlay();this.active=false}},handleMouseOver:function(b,a){if(a instanceof ORYX.Core.Edge&&this.isEdgeDocked(a)){this.showOverlay(a,this.facade.eventCoordinates(b))}this.active=true},handleMouseDown:function(b,a){if(b.which==1&&a instanceof ORYX.Core.Edge&&this.isEdgeDocked(a)){window.clearTimeout(this.timer);this.timer=window.setTimeout(function(){this.addDockerCommand({edge:a,event:b,position:this.facade.eventCoordinates(b)})}.bind(this),200);this.hideOverlay()}},handleMouseMove:function(b,a){if(a instanceof ORYX.Core.Edge&&this.isEdgeDocked(a)){if(this.active){this.hideOverlay();this.showOverlay(a,this.facade.eventCoordinates(b))}else{this.showOverlay(a,this.facade.eventCoordinates(b))}}},isEdgeDocked:function(a){return !!(a.incoming.length||a.outgoing.length)},addDockerCommand:function(b){if(!b.edge){return}var a=ORYX.Core.Command.extend({construct:function(f,g,h,e,d){this.edge=f;this.docker=g;this.pos=h;this.facade=e;this.options=d},execute:function(){this.docker=this.edge.addDocker(this.pos,this.docker);this.index=this.edge.dockers.indexOf(this.docker);this.facade.getCanvas().update();this.facade.updateSelection();this.options.docker=this.docker},rollback:function(){if(this.docker instanceof ORYX.Core.Controls.Docker){this.edge.removeDocker(this.docker)}this.facade.getCanvas().update();this.facade.updateSelection()}});var c=new a(b.edge,b.docker,b.position,this.facade,b);this.facade.executeCommands([c]);this.facade.raiseEvent({uiEvent:b.event,type:ORYX.CONFIG.EVENT_DOCKERDRAG},b.docker)},showOverlay:function(a,k){var e=k;var f=[0,1];var b=Infinity;for(var g=0,d=a.dockers.length;g<d-1;g++){var c=ORYX.Core.Math.getPointOfIntersectionPointLine(a.dockers[g].bounds.center(),a.dockers[g+1].bounds.center(),k,true);if(!c){continue}var h=ORYX.Core.Math.getDistancePointToPoint(k,c);if(b>h){b=h;e=c}}this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"ghostpoint",shapes:[a],node:this.circle,ghostPoint:e,dontCloneNode:true})},hideOverlay:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"ghostpoint"})}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.LabelLayout=Clazz.extend({construct:function(a){this.facade=a;this.myLabel=undefined;this.labelSelected=false;this.labelLength=undefined;this.rotationPointCoordinates={x:0,y:0};this.mouseCoordinates={x:0,y:0};this.labelCoordinates={x:0,y:0};this.myEdge=undefined;this.rotate=false;this.State=0;this.prevState=0;this.canvasLabel=undefined;this.canvas=false;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEDOWN,this.handleMouseDown.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEOVER,this.handleMouseOver.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MOUSEMOVE,this.handleMouseMove.bind(this));this.rotationPoint=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"stroke-width":2,stroke:"black",d:"M4,4 L0,6 M0,6 L-4,4 M-4,4 L-6,0 M-6,0 L-4,-4 M-4,-4 L0,-6 M0,-6 L4,-4 M4,-4 L6,2 M6,2 L2,0 M6,2 L8,0","line-captions":"round"}]);this.line=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"stroke-width":1,stroke:"silver",fill:"none","pointer-events":"none"}]);this.startMovingCross=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"stroke-width":1,stroke:"black",d:"M0,0 L-10,0 M-10,0 L-6,-4 M-10,0 L-6,4 M0,0 L10,0 M10,0 L6,4 M10,0 L6,-4 M0,0 L0,10 M0,10 L4,6 M0,10 L-4,6 M0,0 L0,-10 M0,-10 L4,-6 M0,-10 L-4,-6","line-captions":"round"}]);this.endMovingCross=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"stroke-width":1,stroke:"black",d:"M-2,0 L-10,0 M2,0 L10,0 M0,2 L0,10 M0,-2 L0,-10 M-2,0 L-6,4 M-2,0 L-6,-4 M2,0 L6,4 M2,0 L6,-4 M0,-2 L4,-6 M0,-2 L-4,-6 M0,2 L4,6 M0,2 L-4,6","line-captions":"round"}]);this.moveLeftRight=ORYX.Editor.graft("http://www.w3.org/2000/svg",null,["path",{"stroke-width":2,stroke:"black",d:"M0,0 L-15,0 M-15,0 L-11,-4 M-15,0 L-11,4 M0,0 L15,0 M15,0 L11,4 M15,0 L11,-4","line-captions":"round"}])},handleMouseOver:function(b,a){if(this.canvas==false){if(a instanceof ORYX.Core.Canvas){this.canvasLabel=a;canvas=true}}},handleMouseDown:function(d,c){if(this.myLabel&&this.myLabel._text!=""){var b=this.facade.eventCoordinates(d).x;var a=this.facade.eventCoordinates(d).y;this.calculateLabelCoordinates();this.calculateRotationPointCoordinates();if(this.labelSelected==true){if(this.myLabel._rotate==270||this.myLabel._rotate==315||this.myLabel._rotate==360||this.myLabel._rotate==45){this.myLabel.x=this.facade.eventCoordinates(d).x+5;this.myLabel.y=this.facade.eventCoordinates(d).y-5}else{if(this.myLabel._rotate==90||this.myLabel._rotate==135||this.myLabel._rotate==180||this.myLabel._rotate==225){this.myLabel.x=this.facade.eventCoordinates(d).x-5;this.myLabel.y=this.facade.eventCoordinates(d).y+5}else{this.myLabel.x=this.facade.eventCoordinates(d).x+10;this.myLabel.y=this.facade.eventCoordinates(d).y-5}}if(this.myLabel._rotationPoint){this.myLabel._rotationPoint.x=b;this.myLabel._rotationPoint.y=a}this.myLabel.edgePosition="freeMoved";this.myLabel.update();this.calculateLabelCoordinates();this.calculateRotationPointCoordinates();this.showOverlay("RotationPoint",this.myEdge,this.rotationPointCoordinates,this.rotationPoint);this.hideOverlay("SettingArrows");this.mouseCoordinates={x:this.labelCoordinates.x,y:this.labelCoordinates.y};this.showOverlay("MovingArrows",this.myEdge,this.mouseCoordinates,this.startMovingCross);this.showLine()}else{this.hideLine();this.hideOverlay("RotationPoint");this.hideOverlay("MovingArrows");this.hideOverlay("SettingArrows")}if(this.labelSelected==false&&b>=this.labelCoordinates.x-20&&b<=this.labelCoordinates.x+20&&a<=this.labelCoordinates.y+20&&a>=this.labelCoordinates.y-20){this.labelSelected=true;this.calculateRotationPointCoordinates();this.showOverlay("RotationPoint",this.myEdge,this.rotationPointCoordinates,this.rotationPoint)}else{this.labelSelected=false}if(this.rotate==false&&b>=this.rotationPointCoordinates.x-20&&b<=this.rotationPointCoordinates.x+20&&a>=this.rotationPointCoordinates.y-20&&a<=this.rotationPointCoordinates.y+20){this.rotate=true;this.State=0;this.showOverlay("RotationPointActive",this.myEdge,this.rotationPointCoordinates,this.moveLeftRight)}else{this.rotate=false;this.hideOverlay("RotationPointActive")}}if(c instanceof ORYX.Core.Edge){if(c._labels[c.id+"condition"]){this.myLabel=c._labels[c.id+"condition"]}else{if(c._labels[c.id+"name"]){this.myLabel=c._labels[c.id+"name"]}else{this.myLabel=c._labels[c.id+"text"]}}this.myEdge=c;if(this.myLabel&&this.myLabel._text!=""){this.calculateLabelCoordinates();this.calculateRotationPointCoordinates();this.showLine();this.mouseCoordinates={x:this.labelCoordinates.x,y:this.labelCoordinates.y};this.showOverlay("MovingArrows",this.myEdge,this.mouseCoordinates,this.startMovingCross);this.showOverlay("RotationPoint",this.myEdge,this.rotationPointCoordinates,this.rotationPoint)}}},handleMouseMove:function(d,c){if(this.labelSelected==true){if(this.myLabel){if(this.myLabel._rotate==270||this.myLabel._rotate==315||this.myLabel._rotate==360||this.myLabel._rotate==45){this.myLabel.x=this.facade.eventCoordinates(d).x+5;this.myLabel.y=this.facade.eventCoordinates(d).y-5;this.myLabel._rotationPoint.x=this.facade.eventCoordinates(d).x+10;this.myLabel._rotationPoint.y=this.facade.eventCoordinates(d).y-10}else{if(this.myLabel._rotate==90||this.myLabel._rotate==135||this.myLabel._rotate==180||this.myLabel._rotate==225){this.myLabel.x=this.facade.eventCoordinates(d).x-5;this.myLabel.y=this.facade.eventCoordinates(d).y+5;this.myLabel._rotationPoint.x=this.facade.eventCoordinates(d).x-10;this.myLabel._rotationPoint.y=this.facade.eventCoordinates(d).y+10}else{this.myLabel.x=this.facade.eventCoordinates(d).x+10;this.myLabel.y=this.facade.eventCoordinates(d).y-5;this.myLabel._rotationPoint.x=this.facade.eventCoordinates(d).x+10;this.myLabel._rotationPoint.y=this.facade.eventCoordinates(d).y-10}}this.myLabel.update();this.calculateLabelCoordinates();this.calculateRotationPointCoordinates();this.hideOverlay("RotationPoint");this.hideOverlay("MovingArrows");this.hideOverlay("SettingArrows");if(this.myLabel._rotate==270||this.myLabel._rotate==315||this.myLabel._rotate==360||this.myLabel._rotate==45){this.mouseCoordinates={x:this.facade.eventCoordinates(d).x,y:this.facade.eventCoordinates(d).y};this.showOverlay("SettingArrows",this.myEdge,this.mouseCoordinates,this.endMovingCross)}else{this.mouseCoordinates={x:this.facade.eventCoordinates(d).x,y:this.facade.eventCoordinates(d).y};this.showOverlay("SettingArrows",this.myEdge,this.mouseCoordinates,this.endMovingCross)}this.hideLine();this.showLine()}}if(this.rotate==true){var b=this.facade.eventCoordinates(d).x;var a=this.facade.eventCoordinates(d).y;this.calculateLabelCoordinates();this.calculateRotationPointCoordinates();if(b<this.rotationPointCoordinates.x-150){this.State=-8}else{if(b<this.rotationPointCoordinates.x-130&&b>=this.rotationPointCoordinates.x-150){this.State=-7}else{if(b<this.rotationPointCoordinates.x-110&&b>=this.rotationPointCoordinates.x-130){this.State=-6}else{if(b<this.rotationPointCoordinates.x-90&&b>=this.rotationPointCoordinates.x-110){this.State=-5}else{if(b<this.rotationPointCoordinates.x-70&&b>=this.rotationPointCoordinates.x-90){this.State=-4}else{if(b<this.rotationPointCoordinates.x-50&&b>=this.rotationPointCoordinates.x-70){this.State=-3}else{if(b<this.rotationPointCoordinates.x-30&&b>=this.rotationPointCoordinates.x-50){this.State=-2}else{if(b<this.rotationPointCoordinates.x-10&&b>=this.rotationPointCoordinates.x-30){this.State=-1}else{if(b<this.rotationPointCoordinates.x+10&&b>=this.rotationPointCoordinates.x-10){this.State=0}else{if(b<this.rotationPointCoordinates.x+30&&b>=this.rotationPointCoordinates.x+10){this.State=1}else{if(b<this.rotationPointCoordinates.x+50&&b>=this.rotationPointCoordinates.x+30){this.State=2}else{if(b<this.rotationPointCoordinates.x+70&&b>=this.rotationPointCoordinates.x+50){this.State=3}else{if(b<this.rotationPointCoordinates.x+90&&b>=this.rotationPointCoordinates.x+70){this.State=4}else{if(b<this.rotationPointCoordinates.x+110&&b>=this.rotationPointCoordinates.x+90){this.State=5}else{if(b<this.rotationPointCoordinates.x+130&&b>=this.rotationPointCoordinates.x+110){this.State=6}else{if(b<this.rotationPointCoordinates.x+150&&b>=this.rotationPointCoordinates.x+130){this.State7}else{if(b>=this.rotationPointCoordinates.x+150){this.State=8}}}}}}}}}}}}}}}}}if(this.State>this.prevState){this.rotate_right();this.prevState=this.State}else{if(this.State<this.prevState){this.rotate_left();this.prevState=this.State}}}},rotate_right:function(){var b={x:this.labelCoordinates.x,y:this.labelCoordinates.y};var a=this.myLabel._rotate;if(a==0||a<45&&a>0||a==360){this.myLabel.rotate(45,b)}else{if(a==45||a<90&&a>45){this.myLabel.rotate(90,b)}else{if(a==315||a>315&&a<360){this.myLabel.rotate(360,b)}else{if(a==270||a>270&&a<315){this.myLabel.rotate(315,b)}else{if(a==90||a<135&&a>90){this.myLabel.rotate(135,b)}else{if(a==135||a<180&&a>135){this.myLabel.rotate(180,b)}else{if(a==180||a<225&&a>180){this.myLabel.rotate(225,b)}else{if(a==225||a<270&&a>225){this.myLabel.rotate(270,b)}}}}}}}}this.myLabel.update()},rotate_left:function(){var b={x:this.labelCoordinates.x,y:this.labelCoordinates.y};var a=this.myLabel._rotate;if(a==0||a<360&&a>315||a==360){this.myLabel.rotate(315,b)}else{if(a==315||a<315&&a>270){this.myLabel.rotate(270,b)}else{if(a==45||a<45&&a>0){this.myLabel.rotate(360,b)}else{if(a==90||a<90&&a>45){this.myLabel.rotate(45,b)}else{if(a==135||a<135&&a>90){this.myLabel.rotate(90,b)}else{if(a==180||a<180&&a>135){this.myLabel.rotate(135,b)}else{if(a==225||a<225&&a>180){this.myLabel.rotate(180,b)}else{if(a==270||a<270&&a>225){this.myLabel.rotate(225,b)}}}}}}}}this.myLabel.update()},calculateRotationPointCoordinates:function(){if(this.rotate==false){this.labelLength=this.myLabel._estimateTextWidth(this.myLabel._text,14);if(this.myLabel._rotate==360){this.rotationPointCoordinates.x=this.labelCoordinates.x-8+this.labelLength/3;this.rotationPointCoordinates.y=this.labelCoordinates.y-35}else{if(this.myLabel._rotate==90){this.rotationPointCoordinates.x=this.labelCoordinates.x+35;this.rotationPointCoordinates.y=this.labelCoordinates.y-8+this.labelLength/3}else{if(this.myLabel._rotate==180){this.rotationPointCoordinates.x=this.labelCoordinates.x-this.labelLength/2;this.rotationPointCoordinates.y=this.labelCoordinates.y+35}else{if(this.myLabel._rotate==270){this.rotationPointCoordinates.x=this.labelCoordinates.x-35;this.rotationPointCoordinates.y=this.labelCoordinates.y+8-this.labelLength/2}else{if(this.myLabel._rotate==45){this.rotationPointCoordinates.x=this.labelCoordinates.x+40;this.rotationPointCoordinates.y=this.labelCoordinates.y}else{if(this.myLabel._rotate==135){this.rotationPointCoordinates.x=this.labelCoordinates.x;this.rotationPointCoordinates.y=this.labelCoordinates.y+40}else{if(this.myLabel._rotate==225){this.rotationPointCoordinates.x=this.labelCoordinates.x-40;this.rotationPointCoordinates.y=this.labelCoordinates.y}else{if(this.myLabel._rotate==315){this.rotationPointCoordinates.x=this.labelCoordinates.x;this.rotationPointCoordinates.y=this.labelCoordinates.y-40}else{this.rotationPointCoordinates.x=this.labelCoordinates.x-8+this.labelLength/3;this.rotationPointCoordinates.y=this.labelCoordinates.y-35}}}}}}}}}},calculateLabelCoordinates:function(){this.labelCoordinates.x=this.myLabel.x;this.labelCoordinates.y=this.myLabel.y},showOverlay:function(d,b,a,c){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:d,shapes:[b],node:c,labelPoint:a,dontCloneNode:true})},hideOverlay:function(a){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:a})},showLine:function(){var a=this.myEdge.dockers[0].bounds.b.x-8;var b=this.myEdge.dockers[0].bounds.b.y-8;this.line.setAttributeNS(null,"d","M"+a+" "+b+" L "+this.labelCoordinates.x+" "+this.labelCoordinates.y);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_SHOW,id:"line",shapes:[this.canvasLabel],node:this.line,position:"northeast",dontCloneNode:true})},hideLine:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_OVERLAY_HIDE,id:"line"})}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BPMN2XPDL20=ORYX.Plugins.AbstractPlugin.extend({construct:function(){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:ORYX.I18N.BPMN2XPDL.xpdlExport,functionality:this.transform.bind(this),group:ORYX.I18N.BPMN2XPDL.group,dropDownGroupIcon:ORYX.PATH+"images/export2.png",icon:ORYX.PATH+"images/page_white_gear.png",description:ORYX.I18N.BPMN2XPDL.xpdlExport,index:1,minShape:0,maxShape:0});this.facade.offer({name:ORYX.I18N.BPMN2XPDL.xpdlImport,functionality:this.importXPDL.bind(this),group:ORYX.I18N.BPMN2XPDL.group,dropDownGroupIcon:ORYX.PATH+"images/import.png",icon:ORYX.PATH+"images/page_white_gear.png",description:ORYX.I18N.BPMN2XPDL.xpdlImport,index:1,minShape:0,maxShape:0})},transform:function(){var a=ORYX.CONFIG.BPMN2XPDLPATH;var b=this.facade.getSerializedJSON();Ext.Ajax.request({url:a,method:"POST",success:function(c){this.openDownloadWindow(window.document.title+".xml",c.responseText)}.bind(this),failure:function(){Ext.Msg.alert("Conversion failed")},params:{data:b,action:"Export"}})},importXPDL:function(a){var b=ORYX.CONFIG.BPMN2XPDLPATH;var d=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:50,defaultType:"textfield",items:[{text:ORYX.I18N.BPMN2XPDL.selectFile,style:"font-size:12px;margin-bottom:10px;display:block;",anchor:"100%",xtype:"label"},{fieldLabel:ORYX.I18N.BPMN2XPDL.file,name:"subject",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{xtype:"textarea",hideLabel:true,name:"msg",anchor:"100% -63"}]});var c=new Ext.Window({autoCreate:true,layout:"fit",plain:true,bodyStyle:"padding:5px;",title:ORYX.I18N.BPMN2XPDL.impXPDL,height:350,width:500,modal:true,fixedcenter:true,shadow:true,proxyDrag:true,resizable:true,items:[d],buttons:[{text:ORYX.I18N.BPMN2XPDL.impBtn,handler:function(){var e=new Ext.LoadMask(Ext.getBody(),{msg:ORYX.I18N.BPMN2XPDL.impProgress});e.show();window.setTimeout(function(){var f=d.items.items[2].getValue();Ext.Ajax.request({url:b,method:"POST",success:function(g){this.facade.importJSON(g.responseText);e.hide();c.hide()}.bind(this),failure:function(){e.hide();Ext.Msg.alert("Import failed")},params:{data:f,action:"Import"}})}.bind(this),100)}.bind(this)},{text:ORYX.I18N.BPMN2XPDL.close,handler:function(){c.hide()}.bind(this)}]});c.on("hide",function(){c.destroy(true);delete c});c.show();d.items.items[1].getEl().dom.addEventListener("change",function(e){var f=e.target.files[0].getAsText("UTF-8");d.items.items[2].setValue(f)},true)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}if(!ORYX.Config){ORYX.Config=new Object()}ORYX.Config.WaveThisGadgetUri="http://ddj0ahgq8zch6.cloudfront.net/gadget/oryx_stable.xml";ORYX.Plugins.WaveThis=Clazz.extend({construct:function(a){this.facade=a;this.facade.offer({name:ORYX.I18N.WaveThis.name,functionality:this.waveThis.bind(this),group:ORYX.I18N.WaveThis.group,icon:ORYX.PATH+"images/waveThis.png",description:ORYX.I18N.WaveThis.desc,dropDownGroupIcon:ORYX.PATH+"images/export2.png",});this.changeDifference=0;this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_EXECUTE,function(){this.changeDifference++}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_EXECUTE_COMMANDS,function(){this.changeDifference++}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_UNDO_ROLLBACK,function(){this.changeDifference--}.bind(this));this.facade.registerOnEvent(ORYX.CONFIG.EVENT_MODEL_SAVED,function(){this.changeDifference=0}.bind(this))},waveThis:function(){var a;if(!location.hash.slice(1)){Ext.Msg.alert(ORYX.I18N.WaveThis.name,ORYX.I18N.WaveThis.failUnsaved);return}else{a=ORYX.CONFIG.WEB_URL+"/backend/poem/"+(location.hash.slice(1).replace(/^\/?/,"").replace(/\/?$/,""))+"/json"}if(this.changeDifference!=0){Ext.Msg.confirm(ORYX.I18N.WaveThis.name,"You have unsaved changes in your model. Proceed?",function(b){if(b=="yes"){this._openWave(a)}},this)}else{this._openWave(a)}},_openWave:function(b){var c=window.open("");if(c!=null){c.document.open();c.document.write("<html><body>");var a=c.document.createElement("form");c.document.body.appendChild(a);var d=function(e,f){var g=document.createElement("input");g.name=e;g.type="hidden";g.value=f;return g};a.appendChild(d("u",b));a.appendChild(d("g",ORYX.Config.WaveThisGadgetUri));a.method="POST";c.document.write("</body></html>");c.document.close();a.action="https://wave.google.com/wave/wavethis?t=Oryx%20Model%20Export";a.submit()}}});if(!ORYX.Plugins){ORYX.Plugins={}}if(!ORYX.Config){ORYX.Config={}}ORYX.Config.Timeline={LAYOUT_ERROR_NO_DATE:"ORYX.Config.Timeline.LAYOUT_ERROR_NO_DATE"};ORYX.Plugins.Timeline=ORYX.Plugins.AbstractPlugin.extend({construct:function(a,b){ORYX_LOGLEVEL=4;ORYX.Log.warn("Set ORYX_LOGLEVEL to "+ORYX_LOGLEVEL);if("undefined"!=typeof(b)&&"undefined"!=typeof(b.properties)){this.facade=a;this.bibliography=[];this.facade.offer({name:"Layout",functionality:function(){try{this.layout()}catch(c){if(ORYX.Config.Timeline.LAYOUT_ERROR_NO_DATE==c){Ext.Msg.alert("Layout","Layouting aborted, due to invalid dates in the diagram")}else{Ext.Msg.alert("Layout","Layouting aborted, due to internal error");ORYX.Log.error(c)}}}.bind(this),group:"Alignment",icon:ORYX.PATH+"images/auto_layout.png",description:"Automagic layouting. Orders events from left to right, according to their date, to form a tree, based on causal relations.",index:0,minShape:0,maxShape:0})}},isEventNode:function(a){return"http://matthias-kunze.info/oryx/stencilsets/timeline#event"==a.getStencil().id().toLowerCase()},isCauseEdge:function(a){return"http://matthias-kunze.info/oryx/stencilsets/timeline#cause"==a.getStencil().id().toLowerCase()},getParentEvent:function(a){var b=null;a.getIncomingShapes(function(c){if(this.isCauseEdge(c)){c.getIncomingShapes(function(d){if(this.isEventNode(d)){b=d}}.bind(this))}}.bind(this));return b},getChildEvents:function(a){var b=[];a.getOutgoingShapes(function(c){if(this.isCauseEdge(c)){c.getOutgoingShapes(function(d){if(this.isEventNode(d)){b.push(d)}}.bind(this))}}.bind(this));return b},dateFromString:function(a){if(a.length==0||isNaN(Date.parse(a))){throw ORYX.Config.Timeline.LAYOUT_ERROR_NO_DATE}return Date.parse(a)},layout:function(){var d={};this.facade.getCanvas().getChildShapes().each(function(p){if(this.isEventNode(p)){if(this.getChildEvents(p).length==0){d[p.id]={w:1,leaf:true,date:this.dateFromString(p.properties["oryx-date"]),center:p.bounds.center(),shape:p,id:p.id};var o=p;var q=this.getParentEvent(p);while(q){d[q.id]=d[q.id]||{w:0,date:this.dateFromString(q.properties["oryx-date"]),center:q.bounds.center(),shape:q,id:q.id};d[q.id].w++;o=q;q=this.getParentEvent(q)}d[o.id].root=true}}}.bind(this));var c=Infinity;var m=-Infinity;var k=Infinity;var a=-Infinity;var h=Infinity;for(f in d){c=Math.min(c,parseInt(d[f].date));m=Math.max(m,parseInt(d[f].date));k=Math.min(k,d[f].center.x);a=Math.max(a,d[f].center.x);h=Math.min(h,d[f].center.y)}function e(p){if(0==m-c){return k}var o=parseInt(d[p].date-c)*(a-k)/(m-c)+k;return o}function g(p,o){if(p.center.y<o.center.y){return -1}if(p.center.y>o.center.y){return 1}return 0}var b=[];var l=[];for(var f in d){if("undefined"!=d[f].root&&d[f].root){l.push(d[f])}}(function n(p,o){p.sort(g);p.each(function(q){var s=[];this.getChildEvents(q.shape).each(function(t){s.push(d[t.id])});if(s.length>0){n.apply(this,[s,o])}var r={x:e(q.id),y:o+70*(q.w-1)/2};o=o+70*(q.w);b.push(new ORYX.Core.Command.Move([q.shape],{x:r.x-d[q.id].center.x,y:r.y-d[q.id].center.y},null,null,this))}.bind(this))}.bind(this))(l,h);this.facade.executeCommands(b)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.GlobalPresencePattern=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.GlobalPresencePattern.name,functionality:this.showOverlay.bind(this),group:ORYX.I18N.GlobalPresencePattern.group,dropDownGroupIcon:ORYX.PATH+"images/controlFlow.png",icon:ORYX.PATH+"images/GlobalPresencePattern.png",description:ORYX.I18N.GlobalPresencePattern.desc,index:0,toggle:true,minShape:0,maxShape:0})},showOverlay:function(b,c){if(!c){this.raisedEventIds=[];this.active=!this.active;return true}var a={command:"undef"};this.createGlobalPresencePattern(a);b.toggle()},createGlobalPresencePattern:function(c){try{var a=-30;var e=this.drawStartEvent(a);a=a+150;var d=this.drawActivity(a);this.drawPath(e,d)}catch(b){Ext.Msg.alert(ORYX.I18N.Oryx.title,b)}},drawStartEvent:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"StartEvent");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);this.facade.getCanvas().add(c);return c},drawActivity:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"Task");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);c.setProperty("oryx-name","A");this.facade.getCanvas().add(c);return c},drawPath:function(f,e){var c;var b=this.facade.getCanvas();var a=this.facade.getStencilSets().keys()[0];var d=ORYX.Core.StencilSet.stencil(a+"Path");c=new ORYX.Core.Edge({eventHandlerCallback:this.facade.raiseEvent},d);c.dockers.first().setDockedShape(f);c.dockers.first().setReferencePoint({x:f.bounds.width()/2,y:f.bounds.height()/2});c.dockers.last().setDockedShape(e);c.dockers.last().setReferencePoint({x:e.bounds.width()/2,y:e.bounds.height()/2});c.setProperty("oryx-temporalproperty","Leads to");this.facade.getCanvas().add(c);return c}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.GlobalAbsencePattern=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.GlobalAbsencePattern.name,functionality:this.showOverlay.bind(this),group:ORYX.I18N.GlobalAbsencePattern.group,dropDownGroupIcon:ORYX.PATH+"images/controlFlow.png",icon:ORYX.PATH+"images/GlobalAbsencePattern.png",description:ORYX.I18N.GlobalAbsencePattern.desc,index:0,toggle:true,minShape:0,maxShape:0})},showOverlay:function(b,c){if(!c){this.raisedEventIds=[];this.active=!this.active;return true}var a={command:"undef"};this.createGlobalAbsencePattern(a);b.toggle()},createGlobalAbsencePattern:function(c){try{var a=-30;var e=this.drawStartEvent(a);a=a+150;var d=this.drawEndEvent(a);this.drawPath(e,d)}catch(b){Ext.Msg.alert(ORYX.I18N.Oryx.title,b)}},drawStartEvent:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"StartEvent");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);this.facade.getCanvas().add(c);return c},drawEndEvent:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"EndEvent");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);this.facade.getCanvas().add(c);return c},drawPath:function(f,e){var c;var b=this.facade.getCanvas();var a=this.facade.getStencilSets().keys()[0];var d=ORYX.Core.StencilSet.stencil(a+"Path");c=new ORYX.Core.Edge({eventHandlerCallback:this.facade.raiseEvent},d);c.dockers.first().setDockedShape(f);c.dockers.first().setReferencePoint({x:f.bounds.width()/2,y:f.bounds.height()/2});c.dockers.last().setDockedShape(e);c.dockers.last().setReferencePoint({x:e.bounds.width()/2,y:e.bounds.height()/2});c.setProperty("oryx-temporalproperty","Leads to");c.setProperty("oryx-exclude","Some Activity");this.facade.getCanvas().add(c);return c}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BeforePresencePattern=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.BeforePresencePattern.name,functionality:this.showOverlay.bind(this),group:ORYX.I18N.BeforePresencePattern.group,dropDownGroupIcon:ORYX.PATH+"images/controlFlow.png",icon:ORYX.PATH+"images/PrecedencePattern.png",description:ORYX.I18N.BeforePresencePattern.desc,index:0,toggle:true,minShape:0,maxShape:0})},showOverlay:function(b,c){if(!c){this.raisedEventIds=[];this.active=!this.active;return}var a={command:"undef"};this.createPrecedencePattern(a)},createPrecedencePattern:function(b){var a=-30;var d=this.drawStartActivity(a);a=a+150;var c=this.drawEndActivity(a);this.drawPath(d,c)},drawStartActivity:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"Task");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);c.setProperty("oryx-name","A");this.facade.getCanvas().add(c);return c},drawEndActivity:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"Task");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);c.setProperty("oryx-name","B");this.facade.getCanvas().add(c);return c},drawPath:function(f,e){var c;var b=this.facade.getCanvas();var a=this.facade.getStencilSets().keys()[0];var d=ORYX.Core.StencilSet.stencil(a+"Path");c=new ORYX.Core.Edge({eventHandlerCallback:this.facade.raiseEvent},d);c.dockers.first().setDockedShape(f);c.dockers.first().setReferencePoint({x:f.bounds.width()/2,y:f.bounds.height()/2});c.dockers.last().setDockedShape(e);c.dockers.last().setReferencePoint({x:e.bounds.width()/2,y:e.bounds.height()/2});c.setProperty("oryx-temporalproperty","Precedes");this.facade.getCanvas().add(c);return c}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BeforeAbsencePattern=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.BeforeAbsencePattern.name,functionality:this.showOverlay.bind(this),group:ORYX.I18N.BeforeAbsencePattern.group,dropDownGroupIcon:ORYX.PATH+"images/controlFlow.png",icon:ORYX.PATH+"images/BeforeAbsencePattern.png",description:ORYX.I18N.BeforeAbsencePattern.desc,index:0,toggle:true,minShape:0,maxShape:0})},showOverlay:function(b,c){if(!c){this.raisedEventIds=[];this.active=!this.active;return}var a={command:"undef"};this.createBeforeAbsencePattern(a)},createBeforeAbsencePattern:function(b){var a=-30;var d=this.drawStartEvent(a);a=a+150;var c=this.drawEndActivity(a);this.drawPath(d,c)},drawStartEvent:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"StartEvent");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);this.facade.getCanvas().add(c);return c},drawEndActivity:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"Task");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);c.setProperty("oryx-name","A");this.facade.getCanvas().add(c);return c},drawPath:function(f,e){var c;var b=this.facade.getCanvas();var a=this.facade.getStencilSets().keys()[0];var d=ORYX.Core.StencilSet.stencil(a+"Path");c=new ORYX.Core.Edge({eventHandlerCallback:this.facade.raiseEvent},d);c.dockers.first().setDockedShape(f);c.dockers.first().setReferencePoint({x:f.bounds.width()/2,y:f.bounds.height()/2});c.dockers.last().setDockedShape(e);c.dockers.last().setReferencePoint({x:e.bounds.width()/2,y:e.bounds.height()/2});c.setProperty("oryx-temporalproperty","Precedes");c.setProperty("oryx-exclude","Some Activity");this.facade.getCanvas().add(c);return c}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.AfterPresencePattern=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.AfterPresencePattern.name,functionality:this.showOverlay.bind(this),group:ORYX.I18N.AfterPresencePattern.group,dropDownGroupIcon:ORYX.PATH+"images/controlFlow.png",icon:ORYX.PATH+"images/ResponsePattern.png",description:ORYX.I18N.AfterPresencePattern.desc,index:0,toggle:true,minShape:0,maxShape:0})},showOverlay:function(b,c){if(!c){this.raisedEventIds=[];this.active=!this.active;return}var a={command:"undef"};this.createResponsePattern(a)},createResponsePattern:function(b){var a=-30;var d=this.drawStartActivity(a);a=a+150;var c=this.drawEndActivity(a);this.drawPath(d,c)},drawStartActivity:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"Task");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);c.setProperty("oryx-name","A");this.facade.getCanvas().add(c);return c},drawEndActivity:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"Task");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);c.setProperty("oryx-name","B");this.facade.getCanvas().add(c);return c},drawPath:function(f,e){var c;var b=this.facade.getCanvas();var a=this.facade.getStencilSets().keys()[0];var d=ORYX.Core.StencilSet.stencil(a+"Path");c=new ORYX.Core.Edge({eventHandlerCallback:this.facade.raiseEvent},d);c.dockers.first().setDockedShape(f);c.dockers.first().setReferencePoint({x:f.bounds.width()/2,y:f.bounds.height()/2});c.dockers.last().setDockedShape(e);c.dockers.last().setReferencePoint({x:e.bounds.width()/2,y:e.bounds.height()/2});c.setProperty("oryx-temporalproperty","Leads to");this.facade.getCanvas().add(c);return c}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.AfterAbsencePattern=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.AfterAbsencePattern.name,functionality:this.showOverlay.bind(this),group:ORYX.I18N.AfterAbsencePattern.group,dropDownGroupIcon:ORYX.PATH+"images/controlFlow.png",icon:ORYX.PATH+"images/AfterAbsencePattern.png",description:ORYX.I18N.AfterAbsencePattern.desc,index:0,toggle:true,minShape:0,maxShape:0})},showOverlay:function(b,c){if(!c){this.raisedEventIds=[];this.active=!this.active;return}var a={command:"undef"};this.createAfterAbsencePattern(a)},createAfterAbsencePattern:function(b){var a=-30;var d=this.drawStartActivity(a);a=a+150;var c=this.drawEndEvent(a);this.drawPath(d,c)},drawStartActivity:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"Task");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);c.setProperty("oryx-name","A");this.facade.getCanvas().add(c);return c},drawEndEvent:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"EndEvent");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);this.facade.getCanvas().add(c);return c},drawPath:function(f,e){var c;var b=this.facade.getCanvas();var a=this.facade.getStencilSets().keys()[0];var d=ORYX.Core.StencilSet.stencil(a+"Path");c=new ORYX.Core.Edge({eventHandlerCallback:this.facade.raiseEvent},d);c.dockers.first().setDockedShape(f);c.dockers.first().setReferencePoint({x:f.bounds.width()/2,y:f.bounds.height()/2});c.dockers.last().setDockedShape(e);c.dockers.last().setReferencePoint({x:e.bounds.width()/2,y:e.bounds.height()/2});c.setProperty("oryx-temporalproperty","Leads to");c.setProperty("oryx-exclude","Some Activity");this.facade.getCanvas().add(c);return c}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BetweenAbsenceTypeIPattern=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.BetweenAbsenceTypeIPattern.name,functionality:this.showOverlay.bind(this),group:ORYX.I18N.BetweenAbsenceTypeIPattern.group,dropDownGroupIcon:ORYX.PATH+"images/controlFlow.png",icon:ORYX.PATH+"images/BetweenAbsenceTypeIPattern.png",description:ORYX.I18N.BetweenAbsenceTypeIPattern.desc,index:0,toggle:true,minShape:0,maxShape:0})},showOverlay:function(b,c){if(!c){this.raisedEventIds=[];this.active=!this.active;return}var a={command:"undef"};this.createBetweenAbsenceTypeIPattern(a)},createBetweenAbsenceTypeIPattern:function(b){var a=-30;var d=this.drawStartActivity(a);a=a+150;var c=this.drawEndActivity(a);this.drawPath(d,c)},drawStartActivity:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"Task");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);c.setProperty("oryx-name","A");this.facade.getCanvas().add(c);return c},drawEndActivity:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"Task");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);c.setProperty("oryx-name","B");this.facade.getCanvas().add(c);return c},drawPath:function(f,e){var c;var b=this.facade.getCanvas();var a=this.facade.getStencilSets().keys()[0];var d=ORYX.Core.StencilSet.stencil(a+"Path");c=new ORYX.Core.Edge({eventHandlerCallback:this.facade.raiseEvent},d);c.dockers.first().setDockedShape(f);c.dockers.first().setReferencePoint({x:f.bounds.width()/2,y:f.bounds.height()/2});c.dockers.last().setDockedShape(e);c.dockers.last().setReferencePoint({x:e.bounds.width()/2,y:e.bounds.height()/2});c.setProperty("oryx-temporalproperty","Leads to");c.setProperty("oryx-exclude","Some Activity");this.facade.getCanvas().add(c);return c}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.BetweenAbsenceTypeIIPattern=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){this.facade=a;this.active=false;this.raisedEventIds=[];this.facade.offer({name:ORYX.I18N.BetweenAbsenceTypeIIPattern.name,functionality:this.showOverlay.bind(this),group:ORYX.I18N.BetweenAbsenceTypeIIPattern.group,dropDownGroupIcon:ORYX.PATH+"images/controlFlow.png",icon:ORYX.PATH+"images/BetweenAbsenceTypeIIPattern.png",description:ORYX.I18N.BetweenAbsenceTypeIIPattern.desc,index:0,toggle:true,minShape:0,maxShape:0})},showOverlay:function(b,c){if(!c){this.raisedEventIds=[];this.active=!this.active;return}var a={command:"undef"};this.createBetweenAbsenceTypeIIPattern(a)},createBetweenAbsenceTypeIIPattern:function(b){var a=-30;var d=this.drawStartActivity(a);a=a+150;var c=this.drawEndActivity(a);this.drawPath(d,c)},drawStartActivity:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"Task");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);c.setProperty("oryx-name","A");this.facade.getCanvas().add(c);return c},drawEndActivity:function(f){var b=this.facade.getCanvas();var c;var e={};e.x=f;e.y=0;var a=this.facade.getStencilSets().keys()[0];var d;d=ORYX.Core.StencilSet.stencil(a+"Task");c=new ORYX.Core.Node({eventHandlerCallback:this.facade.raiseEvent},d);c.setProperty("oryx-name","B");this.facade.getCanvas().add(c);return c},drawPath:function(f,e){var c;var b=this.facade.getCanvas();var a=this.facade.getStencilSets().keys()[0];var d=ORYX.Core.StencilSet.stencil(a+"Path");c=new ORYX.Core.Edge({eventHandlerCallback:this.facade.raiseEvent},d);c.dockers.first().setDockedShape(f);c.dockers.first().setReferencePoint({x:f.bounds.width()/2,y:f.bounds.height()/2});c.dockers.last().setDockedShape(e);c.dockers.last().setReferencePoint({x:e.bounds.width()/2,y:e.bounds.height()/2});c.setProperty("oryx-temporalproperty","Precedes");c.setProperty("oryx-exclude","Some Activity");this.facade.getCanvas().add(c);return c}});if(!ORYX.Plugins){ORYX.Plugins={}}ORYX.Plugins.ProcessLogGenerator=ORYX.Plugins.AbstractPlugin.extend({processLogGeneratorHandleURL:ORYX.PATH+"processloggenerator",construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.facade.offer({name:ORYX.I18N.ProcessLogGenerator.generate,functionality:this.perform.bind(this),description:ORYX.I18N.ProcessLogGenerator.generateDescription,icon:ORYX.PATH+"images/processLogGeneratorIcon.png",index:0,minShape:0,maxShape:0})},perform:function(){this.confirmed_petrinettimeandprobability_extension_missing=this.confirmed_petrinettimeandprobability_extension_missing||false;if(!this.confirmed_petrinettimeandprobability_extension_missing){this.confirmed_petrinettimeandprobability_extension_missing=true;var a=true;this.facade.getStencilSets().values().each(function(b){b.extensions().values().each(function(c){if(c.namespace.match(/petrinettimeandpropability/)){a=false}})});if(a){Ext.MessageBox.show({title:"Time and Probability Extension",msg:'<p>An exension for petrinets allows you to configure execution time and probability of transitions and thus further control the generated log for this model.<br/> To use this feature load the <strong>"Time and Probability Extension"</strong> from the stencil set extensions menu.</p><br/>Do you want to proceed anyways?',buttons:Ext.MessageBox.YESNO,fn:function(b){if("yes"==b){this.checkTokens()}}.bind(this),animEl:"mb4",icon:Ext.MessageBox.QUESTION})}else{this.checkTokens()}}else{this.checkTokens()}},checkTokens:function(){var a=this.getPlaces().any(function(b){var c=parseInt(b.properties["oryx-numberoftokens"]);return !(isNaN(c)||c==0)});if(!a){Ext.MessageBox.show({title:"No Tokens",msg:"The net has no tokens, and thus cannot be executed. Generated logs will be empty.<br/>Do you want to proceed?",buttons:Ext.MessageBox.YESNO,fn:function(b){if("yes"==b){this.showDialog()}}.bind(this),animEl:"mb4",icon:Ext.MessageBox.QUESTION})}else{this.showDialog()}},showDialog:function(){var a=this.createCompletenessSelector(),d=this.createNoiseField(),c=this.createTraceCountField(),b=this.createDialog();this.addFormPanelToWindow(a,d,c,b);b.show()},getPlaces:function(){return this.facade.getCanvas().getChildShapes().select(function(a){return a.getStencil().id().search(/Place/)>-1})},createCompletenessSelector:function(){var b=[["None"],["Trace"],["Ordering"]],a=new Ext.data.SimpleStore({fields:["value"],data:b});return new Ext.form.ComboBox({fieldLabel:ORYX.I18N.ProcessLogGenerator.completenessSelect,store:a,displayField:"value",valueField:"value",typeAhead:true,mode:"local",triggerAction:"all",selectOnFocus:true,forceSelection:true,value:this.completeness||"Trace",emptyText:ORYX.I18N.ProcessLogGenerator.pleaseSelect})},createNoiseField:function(){return new Ext.form.NumberField({fieldLabel:ORYX.I18N.ProcessLogGenerator.degreeOfNoise,allowBlank:false,allowDecimals:false,value:this.noise||5,minValue:0,maxValue:100})},createTraceCountField:function(){return new Ext.form.NumberField({fieldLabel:ORYX.I18N.ProcessLogGenerator.numberOfTraces,allowBlank:false,allowDecimals:false,value:this.tracecount||10,minValue:1,maxValue:10000})},createDialog:function(){var a=new Ext.Window({autoCreate:true,title:ORYX.I18N.ProcessLogGenerator.preferencesWindowTitle,height:240,width:400,modal:true,collapsible:false,fixedcenter:true,shadow:true,style:"font-size:12px;",proxyDrag:true,resizable:true,items:[new Ext.form.Label({text:ORYX.I18N.ProcessLogGenerator.dialogDescription,style:"font-size:12px;"})]});a.on("hide",function(){a.destroy(true)});return a},addFormPanelToWindow:function(b,d,c,e){var a=new Ext.form.FormPanel({frame:false,defaultType:"textfield",waitMsgTarget:true,labelAlign:"left",buttonAlign:"right",enctype:"multipart/form-data",style:"font-size:12px;",monitorValid:true,items:[b,d,c],buttons:[{text:"Submit",formBind:true,handler:function(){this.completeness=b.getValue();this.noise=d.getValue();this.tracecount=c.getValue();this.generateLog({completeness:this.completeness,noise:this.noise,traceCount:this.tracecount});e.hide()}.bind(this)}]});e.add(a)},generateLog:function(a){var c=this.getRDFFromDOM(),b=JSON.stringify(a);this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_ENABLE,text:ORYX.I18N.ProcessLogGenerator.shortWaitText});new Ajax.Request(this.processLogGeneratorHandleURL,{method:"POST",parameters:{options:b,model:c},onSuccess:function(d){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});this.openDownloadWindow("generated_log.mxml",d.responseText)}.bind(this),onFailure:function(){this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_LOADING_DISABLE});Ext.Msg.alert(ORYX.I18N.Oryx.title,ORYX.I18N.ProcessLogGenerator.failed)}.bind(this)})}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.VisioBPMNImport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.facade=a;this.facade.offer({name:ORYX.I18N.VisioImport.BPMNName,functionality:this.importVDX.bind(this),group:"Export",dropDownGroupIcon:ORYX.PATH+"images/import.png",icon:ORYX.PATH+"images/visio_icon.png",description:ORYX.I18N.VisioImport.desc,index:1,minShape:0,maxShape:0})},importVDX:function(){this._showImportDialog()},_showImportDialog:function(a){var c=new Ext.form.FormPanel({defaultType:"textfield",layout:"anchor",border:false,fileUpload:true,reader:{read:function(d){return d.responseText.replace(/\s*<(pre|\/pre)>\s*/gi,"")}},items:[{text:ORYX.I18N.VisioImport.PleaseSelect,style:"font-size:12px;margin-bottom:10px;display:block;",xtype:"label"},{name:"vdxFile",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{name:"stencil",inputType:"hidden",value:"bpmn"}]});c.getForm().errorReader={read:function(d){return{success:d.responseText.replace(/\s*<(pre|\/pre)>\s*/gi,"").startsWith("{"),records:[]}}};var b=new Ext.Window({autoCreate:true,cls:"x-window-security-center",bodyStyle:"padding:5px;background:white;",title:ORYX.I18N.VisioImport.Label,width:400,modal:true,resizable:false,items:[c],buttons:[{text:ORYX.I18N.VisioImport.UploadButton,handler:function(){if(c.items.items[1].el.dom.value){c.getForm().submit({url:ORYX.CONFIG.VISIOIMPORT,waitMsg:ORYX.I18N.VisioImport.ImportWait,method:"POST",success:function(d,e){b.close();this.facade.importJSON(e.response.responseText.replace(/\s*<(pre|\/pre)>\s*/gi,""))}.bind(this),failure:function(d,e){b.close();Ext.Msg.alert(ORYX.I18N.VisioImport.ImportFailure,ORYX.I18N.VisioImport.ImportFailureDescription).setIcon(Ext.MessageBox.INFO)}})}else{b.close()}}.bind(this)},{text:Ext.MessageBox.buttonText.cancel,handler:function(){b.close()}.bind(this)}]});b.show()}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.VisioEPCImport=ORYX.Plugins.AbstractPlugin.extend({facade:undefined,construct:function(a){arguments.callee.$.construct.apply(this,arguments);this.facade=a;this.facade.offer({name:ORYX.I18N.VisioImport.EPCName,functionality:this.importVDX.bind(this),group:"Export",dropDownGroupIcon:ORYX.PATH+"images/import.png",icon:ORYX.PATH+"images/visio_icon.png",description:ORYX.I18N.VisioImport.desc,index:2,minShape:0,maxShape:0})},importVDX:function(){this._showImportDialog()},_sendRequest:function(b,f,d,e,a){var c=false;new Ajax.Request(b,{method:f,asynchronous:false,parameters:d,onSuccess:function(g){c=true;if(e){e(g.responseText)}}.bind(this),onFailure:function(g){if(a){a()}else{this._showErrorMessageBox(ORYX.I18N.Oryx.title,ORYX.I18N.VisioImport.connectionError);ORYX.log.warn("Communication failed: "+g.responseText)}}.bind(this)});return c},_showImportDialog:function(a){var c=new Ext.form.FormPanel({defaultType:"textfield",layout:"anchor",border:false,fileUpload:true,reader:{read:function(d){return d.responseText.replace(/\s*<(pre|\/pre)>\s*/gi,"")}},items:[{text:ORYX.I18N.VisioImport.PleaseSelect,style:"font-size:12px;margin-bottom:10px;display:block;",xtype:"label"},{name:"vdxFile",inputType:"file",style:"margin-bottom:10px;display:block;",itemCls:"ext_specific_window_overflow"},{name:"stencil",inputType:"hidden",value:"epc"}]});c.getForm().errorReader={read:function(d){return{success:d.responseText.replace(/\s*<(pre|\/pre)>\s*/gi,"").startsWith("{"),records:[]}}};var b=new Ext.Window({autoCreate:true,cls:"x-window-security-center",bodyStyle:"padding:5px;background:white;",title:ORYX.I18N.VisioImport.Label,width:400,modal:true,resizable:false,items:[c],buttons:[{text:ORYX.I18N.VisioImport.UploadButton,handler:function(){if(c.items.items[1].el.dom.value){c.getForm().submit({url:ORYX.CONFIG.VISIOIMPORT,waitMsg:ORYX.I18N.VisioImport.ImportWait,method:"POST",success:function(d,e){b.close();this.facade.importJSON(e.response.responseText.replace(/\s*<(pre|\/pre)>\s*/gi,""))}.bind(this),failure:function(d,e){b.close();Ext.Msg.alert(ORYX.I18N.VisioImport.ImportFailure,ORYX.I18N.VisioImport.ImportFailureDescription).setIcon(Ext.MessageBox.INFO)}})}else{b.close()}}.bind(this)},{text:Ext.MessageBox.buttonText.cancel,handler:function(){b.close()}.bind(this)}]});b.show()}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.UMLState=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.raiseEvent({type:ORYX.CONFIG.EVENT_REGISTER_LABEL_TEMPLATE,edit_template:this.templatizeValue.bind(this),render_template:this.untemplatizeValue.bind(this)});this.facade.registerOnEvent("layout.uml.state.seperator",this.centerSeperatorOnParent.bind(this))},templatizeValue:function templatizeValue(d,c,b){var a=b._stencil.id();if(a==="http://b3mn.org/stencilset/umlstate#controlFlow"){return this.templatizeEdgeValue(d)}else{if((a==="http://b3mn.org/stencilset/umlstate#stateWithActions")&&(c.indexOf("actions")!==-1)){return this.templatizeStateWithActionsValue(d)}else{return d}}},templatizeEdgeValue:function templatizeEdgeValue(a){var d=a.indexOf("[");var c=a.indexOf("/");if(a===""){return"Event [Guard] /Action"}if((d===-1)&&(c===-1)){return a+" [Guard] /Action"}if((d===0)&&(c===-1)){return"Event "+a+" /Action"}if(c===0){return"Event [Guard] "+a}if((d!==-1)&&(c===-1)){return a+" /Action"}if((d===-1)&&(c>0)){var b=a.split("/");return b[0]+"[Guard] /"+b[1]}if((d===0)&&(c!==-1)){return"Event "+a}if((d>0)&&(c>0)){return a}return a},templatizeStateWithActionsValue:function templatizeStateWithActionsValue(a){var d=a.indexOf("entry /");var b=a.indexOf("do /");var c=a.indexOf("exit /");if(a.charAt(a.length-1)!=="\n"){a=a+"\n"}if(a==="\n"){return"entry / action\ndo / action\nexit / action"}if((d===0)&&(b===-1)&&(c===-1)){return a+"do / action\nexit / action"}if((d===-1)&&(b===0)&&(c===-1)){return"entry / action\n"+a+"exit / action"}if((d===-1)&&(b===-1)&&(c===0)){return"entry / action\ndo / action\n"+a}if((d===0)&&(b!==-1)&&(c===-1)){return a+"exit / action"}if((d===0)&&(b===-1)&&(c!==-1)){return a.slice(0,c)+"do / action\n"+a.slice(c)}if((d===-1)&&(b===0)&&(c!==-1)){return"entry / action\n"+a}if((d===0)&&(b!==-1)&&(c!==-1)){return a}return a},untemplatizeValue:function untemplatizeValue(d,c,b){var a=b._stencil.id();if(a==="http://b3mn.org/stencilset/umlstate#controlFlow"){return this.untemplatizeEdgeValue(d)}else{if((a==="http://b3mn.org/stencilset/umlstate#stateWithActions")&&(c.indexOf("actions")!==-1)){return this.untemplatizeStateWithActionsValue(d)}else{return d}}},untemplatizeEdgeValue:function untemplatizeEdgeValue(a){var b=a.replace("Event ","").replace("[Guard]","").replace(" /Action","");return b},untemplatizeStateWithActionsValue:function untemplatizeStateWithActionsValue(a){var b=a.replace("entry / action\n","").replace("do / action\n","").replace("exit / action","");return b},centerSeperatorOnParent:function centerOnParent(c){var a=c.shape;var b=a.getParentShape();var d=b.absoluteCenterXY().x-a.absoluteCenterXY().x;a.bounds.moveBy(d,0)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}ORYX.Plugins.UMLSequence=Clazz.extend({facade:undefined,construct:function(a){this.facade=a;this.facade.registerOnEvent("layout.uml.sequence.combinedFragment",this.sendToBack.bind(this));this.facade.registerOnEvent("layout.uml.sequence.onLifeline",this.centerOnLifeline.bind(this));this.facade.registerOnEvent("layout.uml.sequence.terminator",this.centerTerminatorOnLifeline.bind(this))},sendToBack:function sendToBack(b){var a=b.shape;a.node.parentNode.insertBefore(a.node,a.node.parentNode.firstChild)},centerOnLifeline:function centerOnLifeline(c){var a=c.shape;var b=a.getParentShape();var d=b.absoluteCenterXY().x-a.absoluteCenterXY().x;a.bounds.moveBy(d,0)},centerTerminatorOnLifeline:function centerTerminatorOnLifeline(e){var b=e.shape;var d=b.getParentShape();var c=d.absoluteCenterXY().x-b.absoluteCenterXY().x;var a=d.bounds.lowerRight().y-b.absoluteCenterXY().y;b.bounds.moveBy(c,a)}});if(!ORYX.Plugins){ORYX.Plugins=new Object()}if(!ORYX.Plugins.ETL){ORYX.Plugins.ETL=new Object()}if(!ORYX.Plugins.ETL.Metadata){ORYX.Plugins.ETL.Metadata=new Object()}ORYX.Plugins.ETL.Metadata.DBConnectionWizard={facade:undefined,selectDBTypeFormPanel:undefined,setJDBCSettingsFormPanel:undefined,setUsernameAndPasswordFormPanel:undefined,construct:function(a){this.facade=a;this.init()},init:function(){var a=new Ext.ux.Wiz({title:"New DB Connection Wizard",headerConfig:{title:"New DB Connection Wizard"},cardPanelConfig:{defaults:{baseCls:"x-small-editor",bodyStyle:"padding:40px 15px 5px 120px;background-color:#F6F6F6;",border:false}},cards:[new Ext.ux.Wiz.Card({title:"Select database name and type",items:[{border:false,bodyStyle:"background:none;",items:this.selectDBTypeFormPanel}]}),new Ext.ux.Wiz.Card({title:"Set JDBC settings",items:[{border:false,bodyStyle:"background:none;",items:this.setJDBCSettingsFormPanel}]}),new Ext.ux.Wiz.Card({title:"Set the username and password",items:[{border:false,bodyStyle:"background:none;",items:this.setUsernameAndPasswordFormPanel}]})]});a.show();region=this.facade.addToRegion("centerSouth",new Ext.Panel({autoHeight:true,layout:"fit",border:false,title:"Properties",items:[this.grid]}),ORYX.I18N.PropertyWindow.title);this.grid.on("beforeedit",this.beforeEdit,this,true);this.grid.on("afteredit",this.afterEdit,this,true);this.grid.view.on("refresh",this.hideMoreAttrs,this,true);this.grid.enableColumnMove=false}};ORYX.Plugins.ETL.Metadata.DBConnectionWizard=Clazz.extend(ORYX.Plugins.ETL.Metadata.DBConnectionWizard);